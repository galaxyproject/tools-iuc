<tool id="Tax2Tree" name="Build phylogenetic tree" version="1.0">
  <description>from Galaxy taxonomy representation</description>
    <requirements>
        <requirement type="package" version="8d245994d7">gb_taxonomy</requirement>
        <requirement type="package" version="9.10">ghostscript</requirement>
    </requirements>
    <stdio>
      <exit_code description="Tool exception" level="fatal" range="1:" />
    </stdio>
  <command>
<![CDATA[

  ## Generate newick tree
  taxonomy2tree "${tax_input}" "${tax_depth}" newick_tree "${summary_file}" "${empty_nodes}" &&

  ## Create a PostScript representation of the tree
  tree2ps newick_tree tree.ps "${tax_depth}" "${font_size}" "${nmax_leaves}" "${count_dups}" &&

  ## Output tree in newick format
  mv newick_tree "${tree_out}" &&

  ## Convert PostScript top PDF
  ps2pdf tree.ps "${tree_pdf}"

]]>
  </command>
  <inputs>
    <param name="tax_input" format="taxonomy" type="data" label="Choose dataset to convert"/>
    <param name="empty_nodes" type="boolean" checked="False" truevalue="1" falsevalue="0" label="Include empty nodes?" help="Include phylogenetic ranks even if they do not correspond to any sequences in the dataset. default=No"/>

    <param name="tax_depth" label="Show ranks from root to" type="select" help="Choosing to show entire tree may produce very large PDF file disabling your viewer">
        <option value="0">Show entire tree</option>
        <option value="1">Superkingdom</option>
        <option value="2">Kingdom</option>
        <option value="3">Subkingdom</option>
        <option value="4">Superphylum</option>
        <option value="5">Phylum</option>
        <option value="6">Subphylum</option>
        <option value="7">Superclass</option>
        <option value="8" selected="True">Class</option> 
        <option value="9">Subclass</option>
        <option value="10">Superorder</option>
        <option value="11">Order</option>
        <option value="12">Suborder</option>
        <option value="13">Superfamily</option>
        <option value="14">Family</option>
        <option value="15">Subfamily</option>
        <option value="16">Tribe</option>
        <option value="17">Subtribe</option>
        <option value="18">Genus</option>
        <option value="19">Subgenus</option>
        <option value="20">Species</option>
        <option value="21">Subspecies</option>
    </param>
    <param name="font_size" type="integer" value="8" min="2" max="255" label="Font size" help="Set font size within PDF output"/>
    <param name="nmax_leaves" type="integer" value="0" min="0" label="Maximum number of leaves to show" help="Automatically adjusts tree depth to show up to this number of leafs (OTUs)"/>
    <param name="count_dups" type="boolean" checked="False" truevalue="1" falsevalue="0" label="Count duplicates?" help="Count duplicate phylogenetic categories?"/>
  </inputs>
  <outputs>
    <data format="txt" name="tree_out" />
    <data format="tabular" name="summary_file" />
    <data format="pdf" name="tree_pdf" />
  </outputs>
  <tests>
    <test>
      <param ftype="taxonomy" name="tax_input" value="tax2tree-test1.txt"/>
      <param name="tax_depth" value="0" />
      <param name="empty_nodes" value="false" />
      <param name="font_size" value="8" />
      <param name="nmax_leaves" value="0" />
      <param name="count_dups" value="false" />
      <output name="tree_file" file="tax2tree-test1-output.txt"/>
    </test>
  </tests>
  <help>


**What it does**

This tools takes Galaxy Taxonomy dataset as an input, computes taxonomic summary and build a phylogenetic in both newick and PDF formats. It is based on `gb_taxonomy_tools` developed by https://github.com/spond.

-------

**Galaxy taxonomy format**

Galaxy taxonomy format is shown below (you may need to scroll sideways to see the entire line)::

  1      2    3    4         5       6 7 8        9        10            11       12 13               14       15         16          17        18  19  20 21  22  23           24
  Read_1 9606 root Eukaryota Metazoa n n Chordata Craniata Gnathostomata Mammalia n  Euarchontoglires Primates Haplorrhini Hominoidea Hominidae n   n   n  Homo n  Homo sapiens n

It contains *Read name*, *NCBI Taxonomy ID field*, and appended 22 columns containing taxonomic ranks from Superkingdom to Subspecies. Below is a formal definition of the output columns::

    Column Definition
   ------- -------------------------------------------------
         1 Name (specified by 'Read name' dropdown)
         2 taxID   (specified by 'Taxonomy ID field' dropdown)
         3 root
         4 superkingdom
         5 kingdom
         6 subkingdom
         7 superphylum
         8 phylum
         9 subphylum
        10 superclass
        11 class
        12 subclass
        13 superorder
        14 order
        15 suborder
        16 superfamily
        17 family
        18 subfamily
        19 tribe
        20 subtribe
        21 genus
        22 subgenus
        23 species
        24 subspecies

------

.. class:: warningmark

**Why do I have these "n" things?** 

Be aware that the NCBI taxonomy (ftp://ftp.ncbi.nih.gov/pub/taxonomy/) this tool relies upon is incomplete.  This means that for many species one or more ranks are absent and represented as "**n**". In the above example *subkingdom*, *superphylum* etc. are missing.

------

**Example 1: Fake data**

Suppose you have the following dataset::

    Species_1 1 root superkingdom1 kingdom1 subkingdom1 superphylum1 phylum1 subphylum1 superclass1 class1 subclass1 superorder1 order1 suborder1 superfamily1 family1 subfamily1 tribe1 subtribe1 genus1 subgenus1 species1 subspecies1
    Species_2 2 root superkingdom1 kingdom1 subkingdom1 superphylum1 phylum1 subphylum1 superclass1 class1 subclass1 superorder1 order1 suborder1 superfamily1 family1 subfamily1 tribe1 subtribe1 genus2 subgenus2 species2 subspecies2
    Species_3 3 root superkingdom1 kingdom1 subkingdom1 superphylum1 phylum3 subphylum3 superclass3 class3 subclass3 superorder3 order3 suborder3 superfamily3 family3 subfamily3 tribe3 subtribe3 genus3 subgenus3 species3 subspecies3
    Species_4 4 root superkingdom1 kingdom1 subkingdom1 superphylum1 phylum4 subphylum4 superclass4 class4 subclass4 superorder4 order4 suborder4 superfamily4 family4 subfamily4 tribe4 subtribe4 genus4 subgenus4 species4 subspecies4

Drawing the tree with default parameters (without changing anything in the interface) will produce this tree:

.. image:: https://galaxyproject.org/tool_images/taxonomy/t2ps_ideal.png 
   :width: 500

(for explanation of colors and numbers on the tree scroll to the bottom of this help section)

Here *Class* rank represent terminal nodes (leaves) of the tree because it is the default setting of the "*Show ranks from root to*" drop-down.  Changing the drop-down to "*Subspecies*" will produce this:

.. image:: https://galaxyproject.org/tool_images/taxonomy/t2ps_ideal_ssp.png 
   :width: 1000

--------

**Example 2: Fake data with missing nodes**

Real taxonomic datasets almost always contain empty nodes.  These are represented with "**n**" as shown below::

    Species_1 1 root superkingdom1 kingdom1 subkingdom1 superphylum1 phylum1 subphylum1 superclass1 class1 subclass1 superorder1 order1 suborder1 superfamily1 family1 subfamily1 tribe1 subtribe1 genus1 subgenus1 species1 subspecies1
    Species_2 2 root superkingdom1 kingdom1 subkingdom1 superphylum1 phylum1 subphylum1 superclass1 class1 subclass1 superorder1 order1 suborder1 superfamily1 family1 subfamily1 tribe1 subtribe1 genus2 n         species2 subspecies2
    Species_3 3 root superkingdom1 kingdom1 subkingdom1 superphylum1 n       subphylum3 superclass3 class3 subclass3 superorder3 order3 suborder3 superfamily3 family3 subfamily3 tribe3 subtribe3 genus3 subgenus3 species3 subspecies3
    Species_4 4 root superkingdom1 kingdom1 subkingdom1 superphylum1 phylum4 subphylum4 superclass4 class4 subclass4 superorder4 order4 suborder4 superfamily4 family4 subfamily4 tribe4 subtribe4 genus4 subgenus4 species4 subspecies4
    
(here *phylum* for Species_3 and *subgenus* for Species_2 are unassigned)

A full tree for this dataset will look like this:

.. image:: https://galaxyproject.org/tool_images/taxonomy/t2ps_missing_nodes.png 
   :width: 1000

Missing nodes are simply omitted from the tree (there are no gray boxes corresponding to "n") but the branch length is maintained so that taxa belonging to the same taxonomic rank are always aligned with each other

--------

**Autoscaling the tree**

You can use the "*Maximum number of leaves to show*" to restrict the tree to a specified number of leaves (external nodes).  
will produce this tree:

.. image:: https://galaxyproject.org/tool_images/taxonomy/t2ps_autoscale_tree.png 
   :width: 1000

Here the tree is automatically trimmed at a taxonomic rank that will only have 3 outer nodes.  This is very useful for initial evaluation of very large trees where you want to only see, say, 1,000 outer nodes at once.

-------

**Explanation of phylogenetic tree markup** 

Branches of the tree are colored according to the heatmap below.  The "bluer" the branch the lesser the number of leaves it leads to and vice versa. 

.. image:: https://galaxyproject.org/tool_images/taxonomy/t2ps_heatmap.png 

Each node is labeled with taxonomic name and the number of tree leaves belonging to this taxonomic group:

.. image:: https://galaxyproject.org/tool_images/taxonomy/t2ps_node_label.png 

--------

**Taxonomic summary**

In addition to tree this tool also generates summary of taxonomic representation. Suppose one has the following taxonomy representation::

    9916 2      root Eukaryota Metazoa n n Chordata Craniata Gnathostomata Mammalia n Laurasiatheria   n        Ruminantia  n           Bovidae  Bovinae n n Bos  n Bos taurus   n
    9606 12585  root Eukaryota Metazoa n n Chordata Craniata Gnathostomata Mammalia n Euarchontoglires Primates Haplorrhini Hominoidea Hominidae n       n n Homo n Homo sapiens n

Running this tool will generate the following output::
    
    Rank         Rank Name          Count
    -------------------------------------
    root         root               2
    superkingdom Eukaryota          2
    kingdom      Metazoa            2
    phylum       Chordata           2
    subphylum    Craniata           2
    superclass   Gnathostomata      2
    class        Mammalia           2
    superorder   Euarchontoglires   1
    superorder   Laurasiatheria     1
    order        Primates           1
    suborder     Haplorrhini        1
    suborder     Ruminantia         1
    superfamily  Hominoidea         1
    family       Bovidae            1
    family       Hominidae          1
    subfamily    Bovinae            1
    genus        Bos                1
    genus        Homo               1
    species      Bos taurus         1
    species      Homo sapiens       1
    
The output is sorted on Rank and then on Rank Name.  

.. class:: warningmark

**Note** that this tool omits "**n**" corresponding to ranks missing from NCBI taxonomy. In the above example *Home sapiens* contains the order name (Primates) while *Bos taurus* does not.

  </help>
  <citations>
    <citation type="doi">10.1186/gb-2014-15-3-r46</citation>
    <citation type="doi"> 10.1101/gr.094508.109</citation>
  </citations>
</tool>


