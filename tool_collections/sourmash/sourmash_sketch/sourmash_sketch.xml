<tool id="sourmash_sketch" name="sourmash sketch" version="0.1.0+galaxy0" python_template_version="3.5" profile="21.05">
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        ## TODO:decompress or compress zip

        sourmash sketch $mode 
        
        ## build settings string

        #if $advanced_settings.abund:
            #set settings = "abund"
        #else 
            #set settings = "noabund"
        #end if
        
        #for $i, $x in enumerate($advanced_settings.k_size_repeat):
            #set settings += ',k=%s' % (str($x.k_size))
        #end for

        #if $advanced_settings.resolution_cond.resolution_param == "scaled":
            #set settings += ',scaled=%s' % str($advanced_settings.resolution_cond.scaled)
        #end if

        #if $advanced_settings.resolution_cond.resolution_param == "num":
            #set settings += ',num=%s' % str($advanced_settings.resolution_cond.num)
        #end if
        
        #set settings += ',seed=%s' % (str($advanced_settings.seed))

        -p "${settings}"
        $input
        -o $out_file1
    ]]></command>
    <inputs>
        <param name="input" type="data" format="fasta,fastq" label="Input file"/>
        <param name="mode" type="select" label="Sketch Mode" help="Select the Sketch mdoe that suits your input">
            <option value="dna" selected="true">dna - reads in DNA sequences and outputs DNA sketches</option>
            <option value="protein">protein - reads in protein sequences and outputs protein sketches</option>
            <option value="translate">translate - reads in DNA sequences, translates them in all six frames, and outputs protein sketches</option>
            <option value="fromfile">fromfile - takes in a CSV file containing the locations of genomes and proteomes, and outputs all of the requested sketches.</option>
        </param>
        <section name="advanced_settings" title="Advanced Settings" expanded="no">
            <repeat name="k_size_repeat" title="k-mer sizes" min="0" help="create a sketch at this k-mer size; can provide more than one">
                <param name="k_size" type="integer" min="4" max="100" label=""/>
            </repeat>
            <!-- Control Hash size (added condiotion because params are incompatable with each other) -->
            <conditional name="resolution_cond" label="Signatures resoltion">
                <param name="resolution_param" type="select" label="Choose signature resolution method" help="sourmash supports two ways of choosing the resolution or size of your signatures: using num to specify the maximum number of hashes, or scaled to specify the compression ratio.">
                    <option value="scaled">Scaled</option>
                    <option value="num">Number</option>
                    <option value="default" selected="true">Use Defaults</option>
                </param>
                <when value="scaled">
                    <param name="scaled" type="integer" min="1" optional="true" label="Compression ratio" help="sets the sampling rate for k-mers in the scaled MinHash sketch."/>
                </when>
                <when value="num">
                    <param name="num" type="integer" min="1" optional="true" label="Minhash size" help="create a standard MinHash with no more than [value] k-mers kept"/>
                </when>
                <when value="default">
                </when>
            </conditional>
            <param name="abund" type="boolean" value="false" label="Create abundance-weighted" help="by default, sourmash tracks k-mer presence, not their abundance. However, it is possible to take into account abundance information by selecting this option."/>
            <param name="seed" type="integer" value="42" min="0" label="Seed" help="set the random number seed used for k-mer hashing"/>
        </section>
    </inputs>
    <outputs>
        <data name="out_file1" format="fasta"/>
    </outputs>
        <tests>
        <!-- 1) test moode dna-->
        <test expect_num_outputs="1">
            <param name="input" value="GCF_000005845.2_ASM584v2_genomic.fna.gz" />
            <param name="mode" value="dna"/>
            <output name="out_file1">
                <assert_contents>
                    <has_text text="sourmash_signature"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- 2) test k-mer size-->
        <test expect_num_outputs="1">
            <param name="input" value="GCF_000005845.2_ASM584v2_genomic.fna.gz" />
            <param name="mode" value="dna"/>
            <section name="advanced_settings">
                <param name="k_size_repeat_0|k_size" value="10"/> 
            </section>
            <output name="out_file1">
                <assert_contents>
                    <has_text text="sourmash_signature"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- 3) test scale -->
        <test expect_num_outputs="1">
            <param name="input" value="GCF_000005845.2_ASM584v2_genomic.fna.gz" />
            <param name="mode" value="dna"/>
            <section name="advanced_settings">
                <conditional name="resolution_cond">
                    <param name="resolution_param" value="scaled"/>
                    <param name="scaled" value="500"/>          
                </conditional>
            </section>
            <output name="out_file1">
                <assert_contents>
                    <has_text text="sourmash_signature"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- 4) test number -->
        <test expect_num_outputs="1">
            <param name="input" value="GCF_000005845.2_ASM584v2_genomic.fna.gz" />
            <param name="mode" value="dna"/>
            <section name="advanced_settings">
                <conditional name="resolution_cond">
                    <param name="resolution_param" value="num"/>
                    <param name="num" value="1000"/>            
                </conditional>
            </section>
            <output name="out_file1">
                <assert_contents>
                    <has_text text="sourmash_signature"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- 5) abund -->
        <test expect_num_outputs="1">
            <param name="input" value="GCF_000005845.2_ASM584v2_genomic.fna.gz" />
            <param name="mode" value="dna"/>
            <section name="advanced_settings">
                <param name="abund" value="true"/>
            </section>
            <output name="out_file1">
                <assert_contents>
                    <has_text text="sourmash_signature"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- 6) seed -->
        <test expect_num_outputs="1">
            <param name="input" value="GCF_000005845.2_ASM584v2_genomic.fna.gz" />
            <param name="mode" value="dna"/>
            <section name="advanced_settings">
                <param name="seed" value="30"/>
            </section>
            <output name="out_file1">
                <assert_contents>
                    <has_text text="sourmash_signature"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
        This tool generates MinHash sketches from sequence data. MinHash sketches are compact representations of sequences that enable fast comparisons and similarity searches.

        **Input**

        Accepts FASTA or FASTQ files containing DNA or protein sequences.

        **Modes**

        - dna: Processes DNA sequences and outputs DNA sketches.
        - protein: Processes protein sequences and outputs protein sketches.
        - translate: Translates DNA sequences in all six frames and outputs protein sketches.
        - fromfile: Reads a CSV file listing genome and proteome locations, producing sketches for all specified entries.

        **Advanced Settings**

        - k-mer sizes: Specify one or more k-mer sizes to create sketches at multiple resolutions.
        - Compression ratio (scaled): Use scaled MinHash to deterministically sample k-mers at a given ratio, reducing sketch size.
        - MinHash size (number): Limit the number of k-mers retained in a standard MinHash sketch.
    ]]></help>
    <expand macro="citations"/>
    <creator>
        <organization name="Galaxy Europe"/>
        <person givenName="Ahmad" familyName="Mahagna" url="https://github.com/Smkingsize"/>
        <person givenName="Saim" familyName="Momin" url="https://github.com/SaimMomin12"/>
    </creator>
</tool>
