<tool id="samtools_collate" name="Samtools collate" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>shuffle and group reads together by their names</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
        @ADDTHREADS@
        samtools collate

        ## options
        $advanced_options.add_pg
        -n $advanced_options.tmp_files
        #if $advanced_options.fast_mode_cond.fast_mode_param == "-f":
            $advanced_options.fast_mode_param
            -r $advanced_options.num_reads
        #end if

        ## I/O files
        $input    
        -o $output_file
    ]]></command>
    <inputs>
        <param name="input" type="data" format="sam,bam,cram" label="Input File"/>
        <section name="advanced_options" title="Advanced Options" expanded="no">
            <param name="add_pg" type="boolean" label="Add @PG in Header" checked="true" truevalue="" falsevalue="--no-PG" help="Add a @PG line to the header of the output file. "/>
            <param name="tmp_files" type="integer" label="Number of temporary files" value="64" min="0" help="Number of temporary files to use. "/>
            <conditional name="fast_mode_cond">
                <param name="fast_mode_param" type="select" label="Fast Mode" help="Fast mode will output only primary alignments that have either the READ1 or READ2 flags set (but not both). Any other alignment records will be filtered out. The collation will only work correctly if there are no more than two reads for any given QNAME after filtering. ">
                    <option value="no" selected="true">No</option>
                    <option value="-f">Yes</option>
                </param>
                <when value="no"></when>
                <when value="-f">
                    <param name="num_reads" type="integer" label="Number of Stored Reads" min="0" value="10000" help="Number of reads to store in memory (for use in fast mode)"/>
                </when>
            </conditional>
        </section>
    </inputs>
    <outputs>
        <data name="output_file" format_source="input"/>
    </outputs>
    <tests>
        <!-- 1) basic settings-->
        <test expect_num_outputs="1">
            <param name="input" value="fast_collate.sam" ftype="sam"/>
            <output name="output_file" ftype="sam">
                <assert_contents>
                    <has_text text="@PG"/>
                    <has_n_lines n="28"/>
                </assert_contents>
            </output>
        </test>
        <!-- 2) advanced options-->
        <test expect_num_outputs="1">
            <param name="input" value="fast_collate.sam" ftype="sam"/>
            <section name="advanced_options">
                <param name="add_pg" value="false"/>
                <param name="tmp_files" value="10"/>
            </section>
            <output name="output_file" ftype="sam">
                <assert_contents>
                    <not_has_text text="@PG"/>
                    <has_n_lines n="27"/>
                </assert_contents>
            </output>
        </test>
        <!-- 3) fast mode-->
        <test expect_num_outputs="1">
            <param name="input" value="fast_collate.sam" ftype="sam"/>
            <section name="advanced_options">
                <param name="add_pg" value="false"/>
                <param name="tmp_files" value="10"/>
                <conditional name="fast_mode_cond">
                    <param name="fast_mode_param" value="-f"/>
                    <param name="num_reads" value="2"/>
                </conditional>
            </section>
            <output name="output_file" ftype="sam">
                <assert_contents>
                    <not_has_text text="@PG"/>
                    <has_n_lines n="23"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**
  
samtools collate shuffles and groups reads together by their names.

Note: The tools makes no guarantees about the order of read names between groups.

**Fast Mode**

Fast mode keeps a buffer of alignments in memory so that it can write out most pairs as soon as they are found instead of storing them in temporary files. This allows collate to avoid some work and so finish more quickly compared to the standard mode. The number of alignments held can be changed using *Number of Stored Reads* parameter, storing more alignments uses more memory but increases the number of pairs that can be written early.

    ]]></help>
    <expand macro="citations"/>
    <creator>
        <organization name="Galaxy Europe"/>
        <person givenName="Ahmad" familyName="Mahagna" url="https://github.com/Smkingsize"/>
        <person givenName="Saim" familyName="Momin" url="https://github.com/SaimMomin12"/>
    </creator>
</tool>