<tool id="samtools_depth" name="Samtools depth" version="2.0.1">
    <description>compute the depth at each position or region</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command><![CDATA[
        ## create symlinks to bams and index files (0.bam,..., n-1.bam + 0.bam.[bai|crai],...,n-1.bam.[bai|crai] )
        @PREPIDX_MULTIPLE@

	samtools depth 
	$all
	#if $cond_region.select_region == 'bed':
            -b '$cond_region.input_bed'
        #else if $cond_region.select_region == 'text':
            -r $cond_region.region
        #end if
	#if str($minlength) != '':
	    -l $minlength
	#end if
	#if str($maxdepth) != '':
	    -m $maxdepth
	#end if
	#if str($basequality) != '':
	    -q $basequality
	#end if
	#if str($mapquality) != '':
	    -Q $mapquality
	#end if
	
        #for $i in range(len( $input_bams )):
            '${i}.bam'
        #end for

	> '${output}'
    ]]></command>
    <inputs>
	<param name="input_bams" type="data" format="bam" multiple="true" label="BAM file(s)" />
        <conditional name="cond_region">
            <param name="select_region" type="select" label="Filter by regions">
                <option value="no" selected="True">No</option>
                <option value="text">Manualy specify a region</option>
                <option value="bed">Regions from BED file</option>
            </param>
            <when value="no"/>
            <when value="text">
                <param name="region" type="text" optional="false" argument="-r" label="Only report depth in specified region (CHR:FROM-TO)"/>
            </when>
            <when value="bed">
	        <param name="input_bed" type="data" format="bed" argument="-b" label="Genomic intervals (in BED format)" help="Compute depth at list of positions or regions in specified BED FILE." />
            </when>
        </conditional>

        <param name="all" type="select" argument="-a/-aa" label="Output all positions" help="Note that if the all option (-a) is used in conjunction with a BED file it may sometimes operate as if -aa was specified if the reference sequence has coverage outside of the region specified in the BED file.">
            <option value="" selected="True">Default</option>
            <option value="-a">Output all positions (including those with zero depth) (-a)</option>
            <option value="-aa">Output absolutely all positions, including unused reference sequences. (-aa)</option>
        </param>
	<param name="minlength" type="integer" argument="-l" min="0" optional="true" label="Ignore reads shorter than" />
	<param name="maxdepth" type="integer" argument="-m" min="0" optional="true" label="Truncate reported depth at a maximum of INT reads. (default = 8000)" />

        <param name="basequality" type="integer" argument="-q" min="0" optional="true" label="Only count reads with base quality greater than" />
        <param name="mapquality" type="integer" argument="-Q" min="0" optional="true" label="Only count reads with mapping quality greater than" />
    </inputs>
    <outputs>
        <data name="output" format="tabular" label="${tool.name} on ${on_string}" />
    </outputs>
    <tests>
        <test>
            <conditional name="cond_region">
                <param name="select_region" value="bed"/>
                <param name="input_bed" value="eboVir3.1.bed" ftype="bed" />
            </conditional>
            <param name="input_bams" value="eboVir3.bam" ftype="bam" />
            <output name="output" file="samtools_depth_out1.tab" />
        </test>
        <test>
            <conditional name="cond_region">
                <param name="select_region" value="text"/>
                <param name="region" value="eboVir3:500-1500" />
            </conditional>
            <param name="input_bams" value="eboVir3.bam" ftype="bam" />
            <output name="output" file="samtools_depth_out2.tab" />
        </test>
        <test>
            <param name="input_bams" value="eboVir3.bam,eboVir3.2.bam" ftype="bam" />
            <param name="all" value="-a"/>
            <output name="output" file="samtools_depth_out3.tab" />
        </test>
        <test>
            <param name="input_bams" value="eboVir3.bam,eboVir3.2.bam" ftype="bam" />
	    <param name="minlength" value="10" />
	    <!-- TODO odd thing: I did not expect values > 4 in the output, but there are ... ?-->
	    <param name="maxdepth" value="4" />

            <param name="basequality" value="11"  />
            <param name="mapquality" value="12" />
            <output name="output" file="samtools_depth_out4.tab" />
        </test>
    </tests>
    <help>
**What it does**

Calculates read depth for regions listed in a BED dataset using ``samtools bedcov`` command::

 samtools bedcov [INPUT BED] [INPUT BAM1] ... [INPUT BAMn] > [OUTPUT]
    </help>
    <expand macro="citations"/>
</tool>
