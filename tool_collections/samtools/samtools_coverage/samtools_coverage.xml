<tool id="samtools_stats" name="Samtools coverage" version="2.0.2+galaxy2">
    <description>computes the depth at each position or region.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command><![CDATA[
        @ADDTHREADS@
        @PREPARE_IDX@
        samtools coverage

            #if str($condition_input.input_pooling) == "Yes":
                #for FILE in $condition_input.input
                #do
                    echo $FILE >> bam_list.txt
                #done
                -b bam_list.txt
            #else
                '$condition_input.input'
            #end if

            #if $additional_options.min_read_length != 0:
                -l str($additional_options.min_read_length)
            #end if

            #if $additional_options.min_mq != 0:
                -l str($additional_options.min_mq)
            #end if

            #if $additional_options.min_bq != 0:
                -l str($additional_options.min_bq)
            #end if

            #if str($additional_options.required_flags) != 'None':
                #set $filter = str($additional_options.required_flags)
                @FLAGS@
                #set $std_filters = $std_filters + " -rf %s" % str($flags)
            #end if

            #if str($additional_options.skipped_flags) != 'None':
                #set $filter = str($additional_options.skipped_flags)
                @FLAGS@
                #set $std_filters = $std_filters + " -ff %s" % str($flags)
            #end if

            $output_options.condition_histogram.histogram

            #if str($output_options.condition_histogram.histogram) == "-m":
                -w $output_options.condition_histogram.n_bins
                #if $output_options.condition_histogram.region != "":
                    -r str($output_options.condition_histogram.region)
                #end if
            #end if

            -@ \$addthreads
            infile
            @REGIONS_MANUAL@
            -o '$output'

            #if $split_output_cond.split_output_selector == "yes":
                #set outputs_to_split = str($split_output_cond.generate_tables).split(',')
                && mkdir split
                #for s in str($split_output_cond.generate_tables).split(','):
                    && name=`cat '$output' | grep '\^$s' | cut -d'.' -f 1 | sed 's/^# //'`
                    && awk '/\^/{out=0} /\^$s/{out=1} {if(out==1){print $0}}' '$output' | sed 's/Use `grep .*` to extract this part.//' | sed 's/$s\t//' > "split/\$name.tab"
                #end for
            #end if
    ]]></command>
    <inputs>
        <conditional name="condition_input">
            <param name="input_pooling" type="select" label="Are you pooling bam files?" help="Calculate the coverage for multiple bam files" >
                <option value="No" selected="True">No</option>
                <option value="Yes">Yes</option>
            </param>
            <when value="No" >
                <param name="input" argument="" type="data" format="bam" label="BAM file"/>
            </when>
            <when value="Yes">
                <param name="input" argument="-b" type="data" format="bam" multiple="true" label="BAM Files."/>
            </when>
        </conditional>

        <section name="additional_options" title="Additional Options">
            <param name="min_read_length" argument="-l" type="integer" min="0" value="0" label="Minimum read length" help="Ignore reads shorter than INT base pairs (Default = 0)" />
            <param name="min_mq" argument="-q" type="integer" min="0" value="0" label="Minimum mapping quality" help="Minimum mapping quality for an alignment to be used (Default = 0)" />
            <param name="min_bq" argument="-Q" type="integer" min="0" value="0" label="Minimum base quality" help="Minimum base quality for a base to be considered (Default = 0)" />

            <param name="required_flags" argument="--rf" type="select" multiple="True" label="Require that these flags are set">
                <expand macro="flag_options" />
            </param>

            <param name="skipped_flags" argument="--ff" type="select" multiple="True" label="Exclude reads with any of the following flags set">
                <expand macro="flag_options" />
            </param>
        </section>

        <section name="output_options" title="Output Options">
            <conditional name="condition_histogram">
                <param name="histogram" argument="-m" type="boolean" checked="false" truevalue="-m" falsevalue="" label="Histogram" help="Show histogram instead of tabular output" />
                <when value="-m">
                    <param name="n_bins" argument="-w" type="integer" min="1" value="40" label="Number of bins in histogram" help="Number of bins in histogram (Default = 40)" />
                    <param name="region" argument="-r" type="string" value="" label="Show specified region" help="Show specified region. Format: chr:start-end." />
                </when>
            </conditional>
        </section>

    <tests>
        <!-- https://github.com/samtools/samtools/blob/9ce8c64493f7ea3fa69bc5c1ac980b1a8e3dcf1f/test/test.pl#L2402 -->
        <test>
            <param name="input" value="1_map_cigar.sam" ftype="sam" />
            <conditional name="addref_cond">
                <param name="addref_select" value="history" />
                <param name="ref" value="test.fa" ftype="fasta" />
            </conditional>
            <output name="output" file="1.stats.expected" ftype="tabular" lines_diff="3" />
        </test>
    </tests>
    <help><![CDATA[
**What it does**

This tool runs the ``samtools coverage`` command.

Computes the depth at each position or region and draws an ASCII-art histogram or tabulated text.

The tabulated form uses the following headings.

rname	Reference name / chromosome
startpos	Start position
endpos	End position (or sequence length)
numreads	Number reads aligned to the region (after filtering)
covbases	Number of covered bases with depth >= 1
coverage	Proportion of covered bases [0..1]
meandepth	Mean depth of coverage
meanbaseq	Mean baseQ in covered region
meanmapq	Mean mapQ of selected reads

    ]]></help>
    <expand macro="citations"/>
</tool>
