<tool id="samtools_sort" name="Sort" version="2.0.1">
    <description>order of storing aligned sequences</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command><![CDATA[
        samtools sort
            $sort_by_name
            -@ \${GALAXY_SLOTS:-1}
            -m \${GALAXY_MEMORY_MB:-768}M
            #if str(compression):
                -l '$compression'
            #end if
            #if str(sort_by_tag) != '':
                -t '$sort_by_tag'
            #end if
            -O bam
            -T sorttmp
            '${input1}'
             > '${output1}'
    ]]></command>
    <inputs>
        <param name="input1" type="data" format="sam,bam,cram" label="BAM File" />
        <param name="sort_by_name" type="boolean" argument="-n" truevalue="-n" falsevalue=""  checked="true" label="Sort by read name"/>
        <param name="sort_by_tag" type="text" argument="-t" label="Sort by alignment tag"/>
        <param name="compression" type="integer" argument="-l" optional="True" min="0" max="9" label="compression level" help="0 (uncompressed) to 9 (best)"/>
    </inputs>
    <outputs>
       <!-- TODO do we want sam/cram output -->
       <!-- TODO are there sorted/unsorted sam? is there tag sorted sam/bam in galaxy? -->
       <!-- TODO The logic behind changing the formats seems to complex to implement this way, are <filters> a better option? i.e. multiple outputs for $output1 with different filters? -->
       <data name="output1" format="bam">
            <change_format>
                <when input="sort_by_name" value="" format="bam" />
                <when input="sort_by_name" value="-n" format="qname_sorted.bam" />
                <when input="sort_by_name_tag" value="bam" format="bam" />
            </change_format>

        </data>
    </outputs>
    <tests>
        <test>
            <param name="input1" value="1.bam" ftype="bam" />
            <output name="output1" file="1_sort.bam" ftype="bam" sort="True"/>
        </test>
        <test>
            <param name="input1" value="1.bam" ftype="bam" />
            <param name="sort_mode" value="-n"/>
            <output name="output1" file="1_sort_read_names.bam" ftype="bam" sort="True"/>
        </test>
    </tests>
    <help>
**What it does**

Sort alignments by leftmost coordinates, or by read name when -n is used. 
An appropriate @HD-SO sort order header tag will be added or an existing 
one updated if necessary. 

**Ordering Rules**

The following rules are used for ordering records.

If option -t is in use, records are first sorted by the value of the given
alignment tag, and then by position or name (if using -n). For example, “-t RG”
will make read group the primary sort key. The rules for ordering by tag are:

- Records that do not have the tag are sorted before ones that do.
- If the types of the tags are different, they will be sorted so that single
  character tags (type A) come before array tags (type B), then string tags
  (types H and Z), then numeric tags (types f and i).
- Numeric tags (types f and i) are compared by value. Note that comparisons of
  floating-point values are subject to issues of rounding and precision.
- String tags (types H and Z) are compared based on the binary contents of the
  tag using the C strcmp(3) function.
- Character tags (type A) are compared by binary character value.
- No attempt is made to compare tags of other types — notably type B array values will not be compared. 

When the -n option is present, records are sorted by name. Names are compared so as to give a “natural” ordering — i.e. sections consisting of digits are compared numerically while all other sections are compared based on their binary representation. This means “a1” will come before “b1” and “a9” will come before “a10”. Records with the same name will be ordered according to the values of the READ1 and READ2 flags (see flags).

When the -n option is not present, reads are sorted by reference (according to the order of the @SQ header records), then by position in the reference, and then by the REVERSE flag.

This has now been removed. The previous out.prefix argument (and -f option, if any) should be changed to an appropriate combination of -T PREFIX and -o FILE. The previous -o option should be removed, as output defaults to standard output. 

    </help>
    <expand macro="citations"/>
</tool>
