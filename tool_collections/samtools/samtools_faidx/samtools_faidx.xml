<tool id="samtools_faidx" name="Samtools faidx" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Index a FASTA file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command><![CDATA[
    samtools faidx
    #if "fastq" in $input.ext:
        --fastq
    #end if
    $input
    --fai-idx '$output'
    #if $input.ext.endswith(".gz")
    || (
        #if "fastq" in $input.ext:
            #set ext = "fastq"
        #else
            #set ext = "fasta"
        #end if
        echo "Failed to index compressed reference. Trying decompressed ..." 1>&2 &&
        gzip -dc '$input' > input.$ext &&
        samtools faidx
        #if "fastq" in $input.ext:
            --fastq
        #end if
        input.$ext
        --fai-idx '$output'
    )
    #end if
    ]]></command>
    <inputs>
        <param name="input"
               type="data"
               format="fasta,fasta.gz,fastqsanger,fastqsanger.gz,fastqillumina,fastqillumina.gz"
               label="Dataset with sequences (FASTA or FASTQ; auto-detected)" />
    </inputs>
    <outputs>
        <data name="output" format="tabular"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input" value="samtools_fastx-out1-2.fasta" />
            <output name="output" file="out_fasta.tabular" />
        </test>
        <test expect_num_outputs="1">
            <param name="input" value="samtools_fastx-out1-2.fasta.gz" />
            <output name="output" file="out_fasta.tabular" />
        </test>
        <test expect_num_outputs="1">
            <param name="input" value="samtools_fastx-out1-2.fasta.bgz" />
            <output name="output" file="out_fasta.tabular" />
        </test>
        <test expect_num_outputs="1">
            <param name="input" value="samtools_fastx-out1-2.fastq" />
            <output name="output" file="out_fastq.tabular" />
        </test>
        <test expect_num_outputs="1">
            <param name="input" value="samtools_fastx-out1-2.fastq.gz" />
            <output name="output" file="out_fastq.tabular" />
        </test>
        <test expect_num_outputs="1">
            <param name="input" value="samtools_fastx-out1-2.fastq.bgz" />
            <output name="output" file="out_fastq.tabular" />
        </test>
    </tests>
    <help><![CDATA[
**What it does**

Runs the ``samtools faidx`` command to index reference sequence in the FASTA format reference sequence.

If the input file is of ``fastq`` type, passes the --fastq flag to accomodate the ``samtools faidx`` command line tool.

**Notes on compression**
- ``samtools faidx`` supports **BGZF-compressed** FASTA files (e.g. ``.fa.bgz`` / ``.fasta.bgz``).
- Plain ``.fasta.gz`` may need to be decompressed first, depending on how it was created.

Full `documentation <https://www.htslib.org/doc/samtools-faidx.html>`_ for the faidx command.
    ]]></help>
    <expand macro="citations"/>
</tool>
