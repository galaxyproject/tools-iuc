<tool id="data_manager_celltypist_models" name="CellTypist model downloader" version="0.0.1" tool_type="manage_data" profile="25.0">
    <description>Download or register CellTypist models</description>

    <requirements>
        <requirement type="package" version="3.10">python</requirement>
        <requirement type="package" version="2.32.5">requests</requirement>
    </requirements>

    <command detect_errors="exit_code">
        <![CDATA[
        python3 $__tool_directory__/celltypist_model_downloader.py --out '${out_file}' --model '${model}' --version '${version}'
        ]]>
    </command>

    <inputs>
        <param name="model" type="text" label="Model name (e.g., 'Immune_All_Low', or leave empty for all)" value="" />
        <param name="version" type="text" label="(Optional) Version (e.g., 'v1', 'v2'). Leave empty for latest." value="" />
    </inputs>

    <outputs>
        <data name="out_file" format="data_manager_json" label="Data manager JSON" />
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <param name="model" value="Immune_All_Low"/>
            <param name="version" value="v1"/>
            <output name="out_file">
                    <assert_contents>
                        <has_text text="Immune_All_Low_v1"/>
                        <has_text text="2022-07-16 00:20:42.927778"/>
                        <has_text text="immune sub-populations combined from 20 tissues of 18 studies"/>
                    </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="model" value=""/>
            <output name="out_file">
                    <assert_contents>
                        <has_text text="Immune_All_Low_v2"/>
                        <has_text text="Immune_All_High_v2"/>
                        <has_text text="Adult_COVID19_PBMC_v1"/>
                        <has_text text="Adult_CynomolgusMacaque_Hippocampus_v1"/>
                        <has_text text="Adult_Human_MTG_v1"/>
                        <has_text text="Adult_Human_PancreaticIslet_v1"/>
                        <has_text text="Adult_Human_PrefrontalCortex_v1"/>
                        <has_text text="Adult_Human_Skin_v1"/>
                        <has_text text="Adult_Human_Vascular_v1"/>
                        <has_text text="Adult_Mouse_Gut_v2"/>
                        <has_text text="Adult_Mouse_OlfactoryBulb_v1"/>
                        <has_text text="Adult_Pig_Hippocampus_v1"/>
                        <has_text text="Adult_RhesusMacaque_Hippocampus_v1"/>
                        <has_text text="Adult_cHSPCs_Illumina_v1"/>
                        <has_text text="Adult_cHSPCs_Ultima_v1"/>
                        <has_text text="Autopsy_COVID19_Lung_v1"/>
                        <has_text text="COVID19_HumanChallenge_Blood_v1"/>
                        <has_text text="COVID19_Immune_Landscape_v1"/>
                        <has_text text="Cells_Adult_Breast_v1"/>
                        <has_text text="Cells_Fetal_Lung_v2"/>
                        <has_text text="Cells_Human_Tonsil_v1"/>
                        <has_text text="Cells_Intestinal_Tract_v1"/>
                        <has_text text="Cells_Lung_Airway_v4"/>
                        <has_text text="Developing_Human_Brain_v1"/>
                        <has_text text="Developing_Human_Gonads_v1"/>
                        <has_text text="Developing_Human_Hippocampus_v1"/>
                        <has_text text="Developing_Human_Organs_v1"/>
                        <has_text text="Developing_Human_Thymus_v1"/>
                        <has_text text="Developing_Mouse_Brain_v1"/>
                        <has_text text="Developing_Mouse_Hippocampus_v1"/>
                        <has_text text="Fetal_Human_AdrenalGlands_v1"/>
                        <has_text text="Fetal_Human_Pancreas_v1"/>
                        <has_text text="Fetal_Human_Pituitary_v1"/>
                        <has_text text="Fetal_Human_Retina_v1"/>
                        <has_text text="Fetal_Human_Skin_v1"/>
                        <has_text text="Healthy_Adult_Heart_v1"/>
                        <has_text text="Healthy_COVID19_PBMC_v1"/>
                        <has_text text="Healthy_Human_Liver_v1"/>
                        <has_text text="Healthy_Mouse_Liver_v1"/>
                        <has_text text="Human_AdultAged_Hippocampus_v1"/>
                        <has_text text="Human_Colorectal_Cancer_v1"/>
                        <has_text text="Human_Developmental_Retina_v1"/>
                        <has_text text="Human_Embryonic_YolkSac_v1"/>
                        <has_text text="Human_Endometrium_Atlas_v1"/>
                        <has_text text="Human_IPF_Lung_v1"/>
                        <has_text text="Human_Longitudinal_Hippocampus_v1"/>
                        <has_text text="Human_Lung_Atlas_v2"/>
                        <has_text text="Human_PF_Lung_v1"/>
                        <has_text text="Human_Placenta_Decidua_v1"/>
                        <has_text text="Lethal_COVID19_Lung_v1"/>
                        <has_text text="Mouse_Dendritic_Subtypes_v1"/>
                        <has_text text="Mouse_Dentate_Gyrus_v1"/>
                        <has_text text="Mouse_Isocortex_Hippocampus_v1"/>
                        <has_text text="Mouse_Postnatal_DentateGyrus_v1"/>
                        <has_text text="Mouse_Whole_Brain_v1"/>
                        <has_text text="Nuclei_Human_InnerEar_v1"/>
                        <has_text text="Nuclei_Lung_Airway_v4"/>
                        <has_text text="PaediatricAdult_COVID19_Airway_v1"/>
                        <has_text text="PaediatricAdult_COVID19_PBMC_v1"/>
                        <has_text text="Pan_Fetal_Human_v2"/>
                    </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="0">
            <param name="model" value="Immune_All_Low"/>
            <param name="version" value="v42"/>
            <assert_stderr>
                <has_text text="Error: Failed to download Immune_All_Low.pkl(v42)"/>
            </assert_stderr>
        </test>
    </tests>
    <help>
        Downloads CellTypist models from the official repository (https://celltypist.cog.sanger.ac.uk/models/models.json) and registers them as Galaxy data tables.
    </help>
    <citations>
        <citation type="doi">10.1126/science.abl5197</citation>
    </citations>
</tool>
