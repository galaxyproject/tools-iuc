<tool id="data_manager_build_coreprofiler" name="Download and build CoreProfiler scheme" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" tool_type="manage_data" profile="@PROFILE@">
    <description></description>
    <macros>
        <token name="@TOOL_VERSION@">2.0.0</token>
        <token name="@VERSION_SUFFIX@">4</token>
        <token name="@PROFILE@">22.05</token>
        <xml name="version_command">
            <version_command><![CDATA[$ coreprofiler --version]]></version_command>
        </xml>
        <xml name="biotools">
            <xrefs>
                <xref type="bio.tools">coreprofiler</xref>
                <xref type="bio.tools">blast</xref>
            </xrefs>
        </xml>
        <xml name="element_assert" token_name="" token_text="">
            <element name="@NAME@">
                <assert_contents>
                    <has_text text="@TEXT@"/>
                    <yield/>
                </assert_contents>
            </element>
        </xml>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">coreprofiler</requirement>
        <requirement type="package" version="2.16.0">blast</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
#from datetime import date

#set $scheme_name = str($select_db.coreprofiler_scheme_select).split('-')[0]
#set $scheme_db = str($select_db.coreprofiler_scheme_select).split('-')[3]
#set $today = date.today().strftime('%Y-%m-%d')

#if $scheme_db == "pubmlst"
    #set $db_version = str($select_db.db_version)
#elif $scheme_db == "bigsdb"
    #set $db_version = str($select_db.db_version)
#elif $scheme_db == "enterobase"
    #set $db_version = "no_token"
#elif $scheme_db == "cgmlstorg"
    #set $db_version = "no_token"
#end if

mkdir -p '$out_file.extra_files_path' &&
mkdir -p 'coreprofiler_${scheme_name}_${scheme_db}_${db_version}_${today}/scheme_$scheme_name/' &&
#if $db_version == "token"
        #if $scheme_db == "pubmlst"
            source "\$PUBMLST_COREPROFILER_SECRETS_PATH" &&
        #elif $scheme_db == "bigsdb"
            source "\$BIGSDB_COREPROFILER_SECRETS_PATH" &&
        #end if
        if [[ -z "\$COREPROFILER_CONSUMER_TOKEN" || -z "\$COREPROFILER_CONSUMER_SECRET" || -z "\$COREPROFILER_ACCESS_TOKEN" || -z "\$COREPROFILER_ACCESS_SECRET" ]]; then
            echo "Error: Missing required bash variables for CoreProfiler authentication." >&2 ;
            echo "Please set the following variables before running this tool:" >&2 ;
            echo "  COREPROFILER_CONSUMER_TOKEN" >&2 ;
            echo "  COREPROFILER_CONSUMER_SECRET" >&2 ;
            echo "  COREPROFILER_ACCESS_TOKEN" >&2 ;
            echo "  COREPROFILER_ACCESS_SECRET" >&2 ;
            echo "Please refer to the data manager help section for more information on how to generate these tokens." >&2 ;
        fi ;
#end if

    coreprofiler db download 
        -s '$scheme_name'
        -o 'coreprofiler_${scheme_name}_${scheme_db}_${db_version}_${today}/scheme_$scheme_name'
        ## Used only for test 
        #if $hide_test
            -t
        #end if
        ##
#if $db_version == "token"
        -k "\$COREPROFILER_CONSUMER_TOKEN"
        -ks "\$COREPROFILER_CONSUMER_SECRET"
        -a "\$COREPROFILER_ACCESS_TOKEN"
        -as "\$COREPROFILER_ACCESS_SECRET"
#end if
&&
coreprofiler db makeblastdb
    -s 'coreprofiler_${scheme_name}_${scheme_db}_${db_version}_${today}/scheme_$scheme_name'
    -n '$scheme_name'
    -p 'coreprofiler_${scheme_name}_${scheme_db}_${db_version}_${today}/db_$scheme_name' &&

mv 'coreprofiler_${scheme_name}_${scheme_db}_${db_version}_${today}' '$out_file.extra_files_path' &&

cp '$dmjson' '$out_file'
    ]]></command>
    <configfiles>
        <configfile name="dmjson"><![CDATA[
#from datetime import date

#set $scheme_name = str($select_db.coreprofiler_scheme_select).split('-')[0]
#set $scheme_desc = str($select_db.coreprofiler_scheme_select).split('-')[1]
#set $scheme_loci = str($select_db.coreprofiler_scheme_select).split('-')[2]
#set $scheme_db = str($select_db.coreprofiler_scheme_select).split('-')[3]
#set $today = date.today().strftime('%Y-%m-%d')

#if $scheme_db == "pubmlst"
    #set $db_version = str($select_db.db_version)
    #if $db_version == "no_token"
        #set $db_date_version = "version before 2025"
    #else
        #set $db_date_version = "downloaded on " + $today
    #end if
#elif $scheme_db == "bigsdb"
        #set $db_version = str($select_db.db_version)
    #if $db_version == "no_token"
        #set $db_date_version = "version before 2025"
    #else
        #set $db_date_version = "downloaded on " + $today
    #end if
#elif $scheme_db == "enterobase"
    #set $db_version = "no_token"
    #set $db_date_version = "downloaded on " + $today
#elif $scheme_db == "cgmlstorg"
    #set $db_version = "no_token"
    #set $db_date_version = "downloaded on " + $today
#end if

{
    "data_tables":{
    "coreprofiler_versioned_scheme":[
    {
        "value": "coreprofiler_downloaded_${today}-${scheme_name}-${scheme_desc}-${scheme_loci}-${scheme_db}-${db_version}",
        "name": "${scheme_name}: ${scheme_desc} [${scheme_loci} loci] (${scheme_db} - ${db_date_version})",
        "tool_version": "@TOOL_VERSION@",
        "database": "${scheme_db}",
        "path": "coreprofiler_${scheme_name}_${scheme_db}_${db_version}_${today}",
        "db_path": "db_${scheme_name}/${scheme_name}.fasta",
        "scheme_path": "scheme_${scheme_name}"
    }
    ]
}
        }]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="select_db">
            <param name="db_list" type="select" label="Available database to download a schema">
                <option value="pubmlst">pubMLST</option>
                <option value="bigsdb">BIGSdb</option>
                <option value="enterobase">Enterobase</option>
                <option value="cgmlstorg">cgMLST.org</option>
            </param>
            <when value="pubmlst">
                <param name="db_version" type="select" label="Database version" >
                    <option value="token" selected="true">Latest version (bash variables for tokens and secrets will have to be set as described in the documentation)</option>
                    <option value="no_token">Version before January 2025 (no tokens and secrets needed)</option>
                </param>
                <param name="coreprofiler_scheme_select" type="select" label="PubMLST schema supported by CoreProfiler">                   
                    <option value="abaumannii_3-cgMLST_v1-2133-pubmlst">abaumannii_3: cgMLST v1 [2133 loci] (pubmlst)</option>
                    <option value="bcc_2-cgMLST-1925-pubmlst">bcc_2: cgMLST [1925 loci] (pubmlst)</option>
                    <option value="bcereus_2-B._anthracis_cgMLST-3803-pubmlst">bcereus_2: B. anthracis cgMLST [3803 loci] (pubmlst)</option>
                    <option value="bcereus_5-B._cereus_cgMLST-1568-pubmlst">bcereus_5: B. cereus cgMLST [1568 loci] (pubmlst)</option>
                    <option value="borrelia_3-cgMLST-639-pubmlst">borrelia_3: cgMLST [639 loci] (pubmlst)</option>
                    <option value="brucella_3-cgMLST-1764-pubmlst">brucella_3: cgMLST [1764 loci] (pubmlst)</option>
                    <option value="bmallei_1-cgMLST-3311-pubmlst">bmallei_1: cgMLST [3311 loci] (pubmlst)</option>
                    <option value="bpseudomallei_2-cgMLST-4090-pubmlst">bpseudomallei_2: cgMLST [4090 loci] (pubmlst)</option>
                    <option value="campylobacter_4-C._jejuni_/_C._coli_cgMLST_v1-1343-pubmlst">campylobacter_4: C. jejuni / C. coli cgMLST v1 [1343 loci] (pubmlst)</option>
                    <option value="campylobacter_8-C._jejuni_/_C._coli_cgMLST_v2-1142-pubmlst">campylobacter_8: C. jejuni / C. coli cgMLST v2 [1142 loci] (pubmlst)</option>
                    <option value="chlamydiales_44-C._abortus_cgMLST_v1.0-959-pubmlst">chlamydiales_44: C. abortus cgMLST v1.0 [959 loci] (pubmlst)</option>
                    <option value="chlamydiales_42-C._trachomatis_cgMLST_v1.0-817-pubmlst">chlamydiales_42: C. trachomatis cgMLST v1.0 [817 loci] (pubmlst)</option>
                    <option value="cchauvoei_1-cgMLST-2223-pubmlst">cchauvoei_1: cgMLST [2223 loci] (pubmlst)</option>
                    <option value="cperfringens_2-cgMLST-1431-pubmlst">cperfringens_2: cgMLST [1431 loci] (pubmlst)</option>
                    <option value="dnodosus_3-cgMLST-714-pubmlst">dnodosus_3: cgMLST [714 loci] (pubmlst)</option>
                    <option value="hinfluenzae_56-cgMLST_v1-1037-pubmlst">hinfluenzae_56: cgMLST v1 [1037 loci] (pubmlst)</option>
                    <option value="hinfluenzae_59-H._parainfluenzae_cgMLST_v1-1062-pubmlst">hinfluenzae_59: H. parainfluenzae cgMLST v1 [1062 loci] (pubmlst)</option>
                    <option value="leptospira_4-cgMLST-1565-pubmlst">leptospira_4: cgMLST [1565 loci] (pubmlst)</option>
                    <option value="mabscessus_2-cgMLST-2904-pubmlst">mabscessus_2: cgMLST [2904 loci] (pubmlst)</option>
                    <option value="mycobacteria_3-MTBC_cgMLST-1561-pubmlst">mycobacteria_3: MTBC cgMLST [1561 loci] (pubmlst)</option>
                    <option value="neisseria_72-Human_restricted_Neisseria_cgMLST-v1.0-1441-pubmlst">neisseria_72: Human-restricted Neisseria cgMLST v1.0 [1441 loci] (pubmlst)</option>
                    <option value="neisseria_45-L3_cgMLST-1742-pubmlst">neisseria_45: L3 cgMLST [1742 loci] (pubmlst)</option>
                    <option value="neisseria_68-L44_cgMLST-1699-pubmlst">neisseria_68: L44 cgMLST [1699 loci] (pubmlst)</option>
                    <option value="neisseria_62-N._gonorrhoeae_cgMLST_v1.0-1649-pubmlst">neisseria_62: N. gonorrhoeae cgMLST v1.0 [1649 loci] (pubmlst)</option>
                    <option value="neisseria_89-N._gonorrhoeae_cgMLST_v2-1430-pubmlst">neisseria_89: N. gonorrhoeae cgMLST v2 [1430 loci] (pubmlst)</option>
                    <option value="neisseria_47-N._meningitidis_cgMLST_v1-1605-pubmlst">neisseria_47: N. meningitidis cgMLST v1 [1605 loci] (pubmlst)</option>
                    <option value="neisseria_85-N._meningitidis_cgMLST_v2-1422-pubmlst">neisseria_85: N. meningitidis cgMLST v2 [1422 loci] (pubmlst)</option>
                    <option value="neisseria_88-N._meningitidis_cgMLST_v3-1329-pubmlst">neisseria_88: N. meningitidis cgMLST v3 [1329 loci] (pubmlst)</option>
                    <option value="pmultocida_3-cgMLST_draft_1233-pubmlst">pmultocida_3: cgMLST (draft) [1233 loci] (pubmlst)</option>
                    <option value="salmonella_3-SalmcgMLST_v1.0-2750-pubmlst">salmonella_3: SalmcgMLST v1.0 [2750 loci] (pubmlst)</option>
                    <option value="serratia_2-cgMLST-2692-pubmlst">serratia_2: cgMLST [2692 loci] (pubmlst)</option>
                    <option value="saureus_20-cgMLST-1716-pubmlst">saureus_20: cgMLST [1716 loci] (pubmlst)</option>
                    <option value="sagalactiae_38-h_S.agalactiae_cgMLST_v1.0-1405-pubmlst">sagalactiae_38: h_S.agalactiae cgMLST v1.0 [1405 loci] (pubmlst)</option>
                    <option value="spneumoniae_2-cgMLST-1222-pubmlst">spneumoniae_2: cgMLST [1222 loci] (pubmlst)</option>
                    <option value="spyogenes_11-cgMLST-1198-pubmlst">spyogenes_11: cgMLST [1198 loci] (pubmlst)</option>
                    <option value="suberis_8-cgMLST-1447-pubmlst">suberis_8: cgMLST [1447 loci] (pubmlst)</option>
                    <option value="vcholerae_3-cgMLST-2443-pubmlst">vcholerae_3: cgMLST [2443 loci] (pubmlst)</option>
                    <option value="vparahaemolyticus_3-cgMLST-2254-pubmlst">vparahaemolyticus_3: cgMLST [2254 loci] (pubmlst)</option>
                    <option value="xcitri_1-cgMLST-1618-pubmlst">xcitri_1: cgMLST [1618 loci] (pubmlst)</option>
                </param>
            </when>
            <when value="bigsdb">
                <param name="db_version" type="select" label="Database version" >
                    <option value="token" selected="true">Latest version (bash variables for tokens and secrets will have to be set as described in the documentation)</option>
                    <option value="no_token">Version before January 2025 (no tokens and secrets needed)</option>
                </param>
                <param name="coreprofiler_scheme_select" type="select" label="BIGSdb schema supported by CoreProfiler">                   
                    <option value="bordetella_1-cgMLST_genus-1415-bigsdb">bordetella_1: cgMLST_genus [1415 loci] (bigsdb)</option>
                    <option value="bordetella_4-cgMLST_pertussis-2038-bigsdb">bordetella_4: cgMLST_pertussis [2038 loci] (bigsdb)</option>
                    <option value="diphtheria_1-cgMLST-1305-bigsdb">diphtheria_1: cgMLST [1305 loci] (bigsdb)</option>
                    <option value="diphtheria_5-cgMLST_ulcerans-1628-bigsdb">diphtheria_5: cgMLST_ulcerans [1628 loci] (bigsdb)</option>
                    <option value="klebsiella_15-cgMLST_KpI-2537-bigsdb">klebsiella_15: cgMLST_KpI [2537 loci] (bigsdb)</option>
                    <option value="klebsiella_10-cgMLST_ST258_ST512_ST1199-1371-bigsdb">klebsiella_10: cgMLST_ST258_ST512_ST1199 [1371 loci] (bigsdb)</option>
                    <option value="klebsiella_18-scgMLST629_S-629-bigsdb">klebsiella_18: scgMLST629_S [629 loci] (bigsdb)</option>
                    <option value="klebsiella_19-Kpn_cgMLST-2752-bigsdb">klebsiella_19: Kpn_cgMLST [2752 loci] (BIGSdb)</option>
                    <option value="klebsiella_26-SL147_cgMLST-852-bigsdb">klebsiella_26: SL147_cgMLST [852 loci] (BIGSdb)</option>
                    <option value="klebsiella_27-cgMLST1748_v2-947-bigsdb">klebsiella_27: cgMLST1748_v2 [947 loci] (BIGSdb)</option>
                    <option value="klebsiella_3-scgMLST634-632-bigsdb">klebsiella_3: scgMLST634 [632 loci] (bigsdb)</option>
                    <option value="leptospira_3-capture_cgMLST-545-bigsdb">leptospira_3: capture_cgMLST [545 loci] (bigsdb)</option>
                    <option value="leptospira_1-cgMLST-545-bigsdb">leptospira_1: cgMLST [545 loci] (bigsdb)</option>
                    <option value="listeria_15-cgMLST-1748-bigsdb">listeria_15: cgMLST [1748 loci] (BIGSdb)</option>
                    <option value="listeria_3-cgMLST1748-1748-bigsdb">listeria_3: cgMLST1748 [1748 loci] (bigsdb)</option>
                    <option value="yersinia_2-Y.enterocolitica_cgMLST-1727-bigsdb">yersinia_2: Y.enterocolitica cgMLST [1727 loci] (bigsdb)</option>
                    <option value="yersinia_1-Yersinia_cgMLST-500-bigsdb">yersinia_1: Yersinia cgMLST [500 loci] (bigsdb)</option>
                    <option value="yersinia_3-Y.pseudotuberculosis_cgMLST-1921-bigsdb">yersinia_3: Y.pseudotuberculosis cgMLST [1921 loci] (bigsdb)</option>
                </param>
            </when>
            <when value="enterobase">
                <param name="coreprofiler_scheme_select" type="select" label="Enterobase schema supported by CoreProfiler">                   
                    <option value="escherichia_v1-cgMLST-2513-enterobase">escherichia_v1: cgMLST v1 [2513 loci] (enterobase)</option>
                    <option value="salmonella_v2-cgMLST-3002-enterobase">salmonella_v2: cgMLST v2 [3002 loci] (enterobase)</option>
                </param>
            </when>
            <when value="cgmlstorg">
                <param name="coreprofiler_scheme_select" type="select" label="cgMLST.org schema supported by CoreProfiler">                   
                    <option value="abaumannii-Acinetobacter_baumannii-2390-cgmlstorg">abaumannii: Acinetobacter baumannii [2390 loci] (cgmlstorg)</option>
                    <option value="banthracis-Bacillus_anthracis-3803-cgmlstorg">banthracis: Bacillus anthracis [3803 loci] (cgmlstorg)</option>
                    <option value="bmallei_fli-Burkholderia_mallei_(FLI)-2838-cgmlstorg">bmallei_fli: Burkholderia mallei (FLI) [2838 loci] (cgmlstorg)</option>
                    <option value="bmallei_rki-Burkholderia_mallei_(RKI)-3328-cgmlstorg">bmallei_rki: Burkholderia mallei (RKI) [3328 loci] (cgmlstorg)</option>
                    <option value="bmelitensis-Brucella_melitensis-2704-cgmlstorg">bmelitensis: Brucella melitensis [2704 loci] (cgmlstorg)</option>
                    <option value="bpertussis-Bordetella_pertussis-2983-cgmlstorg">bpertussis: Bordetella pertussis [2983 loci] (cgmlstorg)</option>
                    <option value="bpseudomallei-Burkholderia_pseudomallei-4221-cgmlstorg">bpseudomallei: Burkholderia pseudomallei [4221 loci] (cgmlstorg)</option>
                    <option value="cdifficile-Clostridioides_difficile-2147-cgmlstorg">cdifficile: Clostridioides difficile [2147 loci] (cgmlstorg)</option>
                    <option value="cdiphtheriae-Corynebacterium_diphtheriae-1553-cgmlstorg">cdiphtheriae: Corynebacterium diphtheriae [1553 loci] (cgmlstorg)</option>
                    <option value="cfreundii-Citrobacter_freundii-3250-cgmlstorg">cfreundii: Citrobacter freundii [3250 loci] (cgmlstorg)</option>
                    <option value="cfreundii2-Citrobacter_freundii/portucalensis/braakii/europaeus-2307-cgmlstorg">cfreundii2: Citrobacter freundii/portucalensis/braakii/europaeus [2307 loci] (cgmlstorg)</option>
                    <option value="cjejuni-Campylobacter_jejunicol-637-cgmlstorg">cjejuni: Campylobacter jejuni/coli [637 loci] (cgmlstorg)</option>
                    <option value="cpseudotuberculosis-Corynebacterium_pseudotuberculosis-1577-cgmlstorg">cpseudotuberculosis: Corynebacterium pseudotuberculosis [1577 loci] (cgmlstorg)</option>
                    <option value="csakazakii-Cronobacter_sakazakii/malonaticus-2831-cgmlstorg">csakazakii: Cronobacter sakazakii/malonaticus [2831 loci] (cgmlstorg)</option>
                    <option value="efaecalis-Enterococcus_faecalis-1972-cgmlstorg">efaecalis: Enterococcus faecalis [1972 loci] (cgmlstorg)</option>
                    <option value="efaecium-Enterococcus_faecium-1423-cgmlstorg">efaecium: Enterococcus faecium [1423 loci] (cgmlstorg)</option>
                    <option value="ehormaechei-Enterobacter_hormaechei-2178-cgmlstorg">ehormaechei: Enterobacter hormaechei [2178 loci] (cgmlstorg)</option>
                    <option value="ftularensis-Francisella_tularensis-1147-cgmlstorg">ftularensis: Francisella tularensis [1147 loci] (cgmlstorg)</option>
                    <option value="koxytoca-Klebsiella_oxytoca/grimontii/michiganensis/pasteurii-2536-cgmlstorg">koxytoca: Klebsiella oxytoca/grimontii/michiganensis/pasteurii [2536 loci] (cgmlstorg)</option>
                    <option value="kpneumoniae-Klebsiella_pneumoniae/variicola/quasipneumoniae-2358-cgmlstorg">kpneumoniae: Klebsiella pneumoniae/variicola/quasipneumoniae [2358 loci] (cgmlstorg)</option>
                    <option value="lmonocytogenes-Listeria_monocytogenes-1701-cgmlstorg">lmonocytogenes: Listeria monocytogenes [1701 loci] (cgmlstorg)</option>
                    <option value="lpneumophila-Legionella_pneumophila-1521-cgmlstorg">lpneumophila: Legionella pneumophila [1521 loci] (cgmlstorg)</option>
                    <option value="mgallisepticum-Mycoplasma_gallisepticum-425-cgmlstorg">mgallisepticum: Mycoplasma gallisepticum [425 loci] (cgmlstorg)</option>
                    <option value="mmorganii-Morganella_morganii-2462-cgmlstorg">mmorganii: Morganella morganii [2462 loci] (cgmlstorg)</option>
                    <option value="mtuberculosis-Mycobacterium_tuberculosis/bovis/africanum/canettii-2891-cgmlstorg">mtuberculosis: Mycobacterium tuberculosis/bovis/africanum/canettii [2891 loci] (cgmlstorg)</option>
                    <option value="paeruginosa-Pseudomonas_aeruginosa-3867-cgmlstorg">paeruginosa: Pseudomonas aeruginosa [3867 loci] (cgmlstorg)</option>
                    <option value="plarvae-Paenibacillus_larvae-2419-cgmlstorg">plarvae: Paenibacillus larvae [2419 loci] (cgmlstorg)</option>
                    <option value="pmirabilis-Proteus_mirabilis-2574-cgmlstorg">pmirabilis: Proteus mirabilis [2574 loci] (cgmlstorg)</option>
                    <option value="pstuartii-Providencia_stuartii-3079-cgmlstorg">pstuartii: Providencia stuartii [3079 loci] (cgmlstorg)</option>
                    <option value="sargenteus-Staphylococcus_argenteus-2168-cgmlstorg">sargenteus: Staphylococcus argenteus [2168 loci] (cgmlstorg)</option>
                    <option value="saureus-Staphylococcus_aureus-1861-cgmlstorg">saureus: Staphylococcus aureus [1861 loci] (cgmlstorg)</option>
                    <option value="scapitis-Staphylococcus_capitis-1492-cgmlstorg">scapitis: Staphylococcus capitis [1492 loci] (cgmlstorg)</option>
                    <option value="smarcescens-Serratia_marcescens-2692-cgmlstorg">smarcescens: Serratia marcescens [2692 loci] (cgmlstorg)</option>
                    <option value="spyogenes-Streptococcus_pyogenes-1095-cgmlstorg">spyogenes: Streptococcus pyogenes [1095 loci] (cgmlstorg)</option>
                    <option value="yenterocolitica-Yersinia_enterocolitica-2582-cgmlstorg">yenterocolitica: Yersinia enterocolitica [2582 loci] (cgmlstorg)</option>
                </param>
            </when>
        </conditional>
        <!-- used only for tests, limit download scheme to 50 locus -->
        <param name="hide_test" type="hidden" value=""/>
        <!-- -->
    </inputs>
    <outputs>
        <data name="out_file" format="data_manager_json" label="${tool.name}"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="hide_test" value="true"/>
            <conditional name="select_db">
                <param name="db_list" value="pubmlst"/>
                <param name="db_version" value="no_token"/>
                <param name="coreprofiler_scheme_select" value="borrelia_3-cgMLST-639-pubmlst" />
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text='"coreprofiler_versioned_scheme":'/>
                    <has_text_matching expression='"value": "coreprofiler_downloaded_[0-9-]{10}-borrelia_3-cgMLST-639-pubmlst-no_token"'/>
                    <has_text text='"name": "borrelia_3: cgMLST [639 loci] (pubmlst - version before 2025)"'/>
                    <has_text_matching expression='"tool_version": "[0-9.]+"'/>
                    <has_text_matching expression='"database": "pubmlst"'/>
                    <has_text_matching expression='"path": "coreprofiler_borrelia_3_pubmlst_no_token_[0-9-]{10}"'/>
                    <has_text text='"db_path": "db_borrelia_3/borrelia_3.fasta"'/>
                    <has_text text='"scheme_path": "scheme_borrelia_3"'/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="hide_test" value="true"/>
            <conditional name="select_db">
                <param name="db_list" value="bigsdb"/>
                <param name="db_version" value="no_token"/>
                <param name="coreprofiler_scheme_select" value="yersinia_1-Yersinia_cgMLST-500-bigsdb" />
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text='"coreprofiler_versioned_scheme":'/>
                    <has_text_matching expression='"value": "coreprofiler_downloaded_[0-9-]{10}-yersinia_1-Yersinia_cgMLST-500-bigsdb-no_token"'/>
                    <has_text text='"name": "yersinia_1: Yersinia_cgMLST [500 loci] (bigsdb - version before 2025)"'/>
                    <has_text_matching expression='"tool_version": "[0-9.]+"'/>
                    <has_text_matching expression='"database": "bigsdb"'/>
                    <has_text_matching expression='"path": "coreprofiler_yersinia_1_bigsdb_no_token_[0-9-]{10}"'/>
                    <has_text text='"db_path": "db_yersinia_1/yersinia_1.fasta"'/>
                    <has_text text='"scheme_path": "scheme_yersinia_1"'/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="hide_test" value="true"/>
            <conditional name="select_db">
                <param name="db_list" value="enterobase"/>
                <param name="coreprofiler_scheme_select" value="escherichia_v1-cgMLST-2513-enterobase" />
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text='"coreprofiler_versioned_scheme":'/>
                    <has_text_matching expression='"value": "coreprofiler_downloaded_[0-9-]{10}-escherichia_v1-cgMLST-2513-enterobase-no_token"'/>
                    <has_text_matching expression='"name": "escherichia_v1: cgMLST \[2513 loci\] \(enterobase - downloaded on [0-9-]{10}\)"'/>
                    <has_text_matching expression='"tool_version": "[0-9.]+"'/>
                    <has_text_matching expression='"database": "enterobase"'/>
                    <has_text_matching expression='"path": "coreprofiler_escherichia_v1_enterobase_no_token_[0-9-]{10}"'/>
                    <has_text text='"db_path": "db_escherichia_v1/escherichia_v1.fasta"'/>
                    <has_text text='"scheme_path": "scheme_escherichia_v1"'/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="hide_test" value="true"/>
            <conditional name="select_db">
                <param name="db_list" value="cgmlstorg"/>
                <param name="coreprofiler_scheme_select" value="mgallisepticum-Mycoplasma_gallisepticum-425-cgmlstorg" />
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text='"coreprofiler_versioned_scheme":'/>
                    <has_text_matching expression='"value": "coreprofiler_downloaded_[0-9-]{10}-mgallisepticum-Mycoplasma_gallisepticum-425-cgmlstorg-no_token"'/>
                    <has_text_matching expression='"name": "mgallisepticum: Mycoplasma_gallisepticum \[425 loci\] \(cgmlstorg - downloaded on [0-9-]{10}\)"'/>
                    <has_text_matching expression='"tool_version": "[0-9.]+"'/>
                    <has_text_matching expression='"database": "cgmlstorg"'/>
                    <has_text_matching expression='"path": "coreprofiler_mgallisepticum_cgmlstorg_no_token_[0-9-]{10}"'/>
                    <has_text text='"db_path": "db_mgallisepticum/mgallisepticum.fasta"'/>
                    <has_text text='"scheme_path": "scheme_mgallisepticum"'/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
This tool downloads and installs **CoreProfiler** schemes into Galaxy using the Data Manager framework.

Overview
--------

CoreProfiler supports several reference platforms:

- **pubMLST**
- **BIGSdb**
- **EnteroBase**
- **cgMLST.org**

The list of available schemes is maintained in the `CoreProfiler documentation <https://gitlab.com/ifb-elixirfr/abromics/coreprofiler/-/blob/main/README.md#basic-usage>`_.

Please refer to this page for details on how to use the tool and which schema options are available.

You simply need to choose:
1. A reference platform  
2. A scheme available on that platform  
3. Whether authentication is required (pubMLST / BIGSdb only)

Galaxy will download the database, build the scheme, and register it automatically.

---

Authentication requirements
---------------------------

Authentication is **not needed** for:

- **EnteroBase**
- **cgMLST.org**


Authentication **is recommended** for:

- **pubMLST**
- **BIGSdb**


Why?
````

BIGSdb and pubMLST platforms require **OAuth1** authentication and restrict access to the most up-to-date data.  
While authentication is not strictly mandatory, skipping it may result in downloading **outdated** schemes.


This authentication involves two types of tokens:

 * Consumer tokens : permanent tokens used to initiate the authentication flow.

 * Access tokens : tokens required to download a scheme.

---

Procedure to obtain pubMLST and BIGSdb schemes
----------------------------------------------

Example
```````
- **pubMLST**: borrelia_3-cgMLST-639-pubmlst
- **BIGSdb**: bordetella_1-cgMLST_genus-1415-BIGSdb

1. Create an account on the `pubMLST <https://pubmlst.org/bigsdb>`_ or `BigsDB <https://bigsdb.pasteur.fr/cgi-bin/bigsdb/bigsdb.pl?page=registration>`_ website.
2. Generate a **consumer token** and **consumer secret** 
   * **pubMLST**: From your account settings (My account > API keys > Enter key name > Submit).
   * **BIGSdb**: By sending a mail to bigsdb@pasteur.fr (object "API client key").
3. On your account page, go to **Database registrations**, check all databases and register.
4. Download and install `coreprofiler <https://gitlab.com/ifb-elixirfr/abromics/coreprofiler>`_ locally and run the following command to **obtain your access token and secret**

Replace the placeholders with your scheme of interest (example : *borrelia_3* or *bordetella_1*) your actual consumer token and secret :

::

    coreprofiler db get_request_tokens --scheme <SCHEME_NAME> --consumer_key <YOUR_CONSUMER_TOKEN> --consumer_secret <YOUR_CONSUMER_SECRET>


This command will provide you with a URL to visit in order to **authorize client software** to access your account. 
After authorizing, it will give you a **verification code** that you need to enter in the command line prompt.
It will then return **your access token and secret**.

5. Provide the **consumer token**, **consumer secret**, **access token**, and **access secret** in the data manager tool by setting this bash variables in a txt file : 

::

    export COREPROFILER_CONSUMER_TOKEN="<YOUR_CONSUMER_TOKEN>"
    export COREPROFILER_CONSUMER_SECRET="<YOUR_CONSUMER_SECRET>"
    export COREPROFILER_ACCESS_TOKEN="<YOUR_ACCESS_TOKEN>"
    export COREPROFILER_ACCESS_SECRET="<YOUR_ACCESS_SECRET>"


6. Set the **path** to this txt file in your environment by making an environment variable 
   * **pubMLST** example:

::

    export PUBMLST_COREPROFILER_SECRETS_PATH="/path/to/your/secret_file_pubmlst.txt"

   * **BIGSdb** example:

::

    export BIGSDB_COREPROFILER_SECRETS_PATH="/path/to/your/secret_file_bigsdb.txt"


]]></help>
    <citations>
        <citation type="doi">10.3390/microorganisms10020292</citation>
    </citations>
</tool>
