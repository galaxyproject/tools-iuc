<tool id="data_manager_build_coreprofiler" name="Download and build CoreProfiler scheme" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" tool_type="manage_data" profile="@PROFILE@">
    <description></description>
    <macros>
        <token name="@TOOL_VERSION@">1.1.8</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <token name="@PROFILE@">22.05</token>
        <xml name="version_command">
            <version_command><![CDATA[$ coreprofiler --version]]></version_command>
        </xml>
        <xml name="biotools">
            <xrefs>
                <xref type="bio.tools">coreprofiler</xref>
                <xref type="bio.tools">blast</xref>
            </xrefs>
        </xml>
        <xml name="element_assert" token_name="" token_text="">
            <element name="@NAME@">
                <assert_contents>
                    <has_text text="@TEXT@"/>
                    <yield/>
                </assert_contents>
            </element>
        </xml>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">coreprofiler</requirement>
        <requirement type="package" version="2.16.0">blast</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
#set $scheme_name = str($select_db.coreprofiler_scheme_select).split('-')[0]
#set $scheme_db = str($select_db.coreprofiler_scheme_select).split('-')[3]

#if hasattr($select_db, "db_version")
    #set $db_version = str($select_db.db_version)
#else
    #set $db_version = "no_token"
#end if

mkdir -p '$out_file.extra_files_path' &&
mkdir -p coreprofiler_${scheme_name}_${db_version}/scheme_$scheme_name/ &&
#if $db_version == "token_version"
        source "$COREPROFILER_SECRETS_PATH" &&
        if [[ -z "$COREPROFILER_CONSUMER_TOKEN" || -z "$COREPROFILER_CONSUMER_SECRET" || -z "$COREPROFILER_ACCESS_TOKEN" || -z "$COREPROFILER_ACCESS_SECRET" ]]; then
            echo "Error: Missing required bash variables for CoreProfiler authentication." >&2
            echo "Please set the following variables before running this tool:" >&2
            echo "  COREPROFILER_CONSUMER_TOKEN" >&2
            echo "  COREPROFILER_CONSUMER_SECRET" >&2
            echo "  COREPROFILER_ACCESS_TOKEN" >&2
            echo "  COREPROFILER_ACCESS_SECRET" >&2
            echo "Please refer to the data manager help section for more information on how to generate these tokens." >&2
        fi &&
#end if

    coreprofiler db download 
        -s $scheme_name
        -o coreprofiler_${scheme_name}_${db_version}/scheme_$scheme_name
        ## Used only for test 
        #if str($hide_test) == 'true':
            -t
        #end if
        ##
#if $db_version == "token_version"
        -k "$COREPROFILER_CONSUMER_TOKEN"
        -ks "$COREPROFILER_CONSUMER_SECRET"
        -a "$COREPROFILER_ACCESS_TOKEN"
        -as "$COREPROFILER_ACCESS_SECRET"
#end if
&&
coreprofiler db makeblastdb
    -s coreprofiler_${scheme_name}_${db_version}/scheme_$scheme_name 
    -n $scheme_name 
    -p coreprofiler_${scheme_name}_${db_version}/db_$scheme_name &&

mv coreprofiler_${scheme_name}_${db_version} '$out_file.extra_files_path' &&

cp '$dmjson' '$out_file'
    ]]></command>
    <configfiles>
        <configfile name="dmjson"><![CDATA[
#from datetime import date

#set $scheme_name = str($select_db.coreprofiler_scheme_select).split('-')[0]
#set $scheme_desc = str($select_db.coreprofiler_scheme_select).split('-')[1]
#set $scheme_loci = str($select_db.coreprofiler_scheme_select).split('-')[2]
#set $scheme_db = str($select_db.coreprofiler_scheme_select).split('-')[3]


#if hasattr($select_db, "db_version")
    #set $db_version = str($select_db.db_version)
#else
    #set $db_version = "no_token"
#end if

{
    "data_tables":{
    "coreprofiler_scheme":[
    {
        "value": "coreprofiler_downloaded_#echo date.today().strftime('%d%m%Y')#-${scheme_name}-${scheme_desc}-${scheme_loci}-${scheme_db}-${db_version}",
        "name": "${scheme_name}: ${scheme_desc} [${scheme_loci} loci] (${scheme_db}-${db_version})",
        "path": "coreprofiler_${scheme_name}_${db_version}",
        "database": "coreprofiler_${scheme_name}_${db_version}/db_${scheme_name}/${scheme_name}.fasta",
        "scheme": "coreprofiler_${scheme_name}_${db_version}/scheme_${scheme_name}"
    }
    ]
}
        }]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="select_db">
            <param name="db_list" type="select" label="Available database to download a schema">
                <option value="pubmlst">pubMLST</option>
                <option value="bigsdb">BigsDB</option>
                <option value="enterobase">Enterobase</option>
                <option value="cgmlstorg">cgMLST.org</option>
            </param>
            <when value="pubmlst">
                <param name="db_version" type="select" label="Select if you want latest version using tokens" help="If you choose latest, you will have to provide tokens and secrets to access the database following the procedure describe in the documentation." >
                    <option value="token" selected="true">Latest version, you will need to set bash variables for tokens and secrets as described in the documentation.</option>
                    <option value="no_token">No need of tokens but it will download the previous version (before January 2025), not the latest version</option>
                </param>
                <param name="coreprofiler_scheme_select" type="select" label="CoreProfiler available scheme" help="Choose a schema from a reference platform supported in CoreProfiler">                   
                    <option value="abaumannii_3-cgMLST_v1-2133-pubmlst">abaumannii_3: cgMLST v1 [2133 loci] (pubmlst)</option>
                    <option value="bcereus_2-B._anthracis_cgMLST-3803-pubmlst">bcereus_2: B. anthracis cgMLST [3803 loci] (pubmlst)</option>
                    <option value="bcereus_5-B._cereus_cgMLST-1568-pubmlst">bcereus_5: B. cereus cgMLST [1568 loci] (pubmlst)</option>
                    <option value="borrelia_3-cgMLST-639-pubmlst">borrelia_3: cgMLST [639 loci] (pubmlst)</option>
                    <option value="brucella_3-cgMLST-1764-pubmlst">brucella_3: cgMLST [1764 loci] (pubmlst)</option>
                    <option value="bmallei_1-cgMLST-3311-pubmlst">bmallei_1: cgMLST [3311 loci] (pubmlst)</option>
                    <option value="bpseudomallei_2-cgMLST-4090-pubmlst">bpseudomallei_2: cgMLST [4090 loci] (pubmlst)</option>
                    <option value="campylobacter_4-C._jejuni_/_C._coli_cgMLST_v1-1343-pubmlst">campylobacter_4: C. jejuni / C. coli cgMLST v1 [1343 loci] (pubmlst)</option>
                    <option value="campylobacter_8-C._jejuni_/_C._coli_cgMLST_v2-1142-pubmlst">campylobacter_8: C. jejuni / C. coli cgMLST v2 [1142 loci] (pubmlst)</option>
                    <option value="chlamydiales_44-C._abortus_cgMLST_v1.0-959-pubmlst">chlamydiales_44: C. abortus cgMLST v1.0 [959 loci] (pubmlst)</option>
                    <option value="chlamydiales_42-C._trachomatis_cgMLST_v1.0-817-pubmlst">chlamydiales_42: C. trachomatis cgMLST v1.0 [817 loci] (pubmlst)</option>
                    <option value="cchauvoei_1-cgMLST-2223-pubmlst">cchauvoei_1: cgMLST [2223 loci] (pubmlst)</option>
                    <option value="cperfringens_2-cgMLST-1431-pubmlst">cperfringens_2: cgMLST [1431 loci] (pubmlst)</option>
                    <option value="dnodosus_3-cgMLST-714-pubmlst">dnodosus_3: cgMLST [714 loci] (pubmlst)</option>
                    <option value="hinfluenzae_56-cgMLST_v1-1037-pubmlst">hinfluenzae_56: cgMLST v1 [1037 loci] (pubmlst)</option>
                    <option value="leptospira_4-cgMLST-1565-pubmlst">leptospira_4: cgMLST [1565 loci] (pubmlst)</option>
                    <option value="mabscessus_2-cgMLST-2904-pubmlst">mabscessus_2: cgMLST [2904 loci] (pubmlst)</option>
                    <option value="neisseria_72-Human_restricted_Neisseria_cgMLST-v1.0-1441-pubmlst">neisseria_72: Human-restricted Neisseria cgMLST v1.0 [1441 loci] (pubmlst)</option>
                    <option value="neisseria_45-L3_cgMLST-1742-pubmlst">neisseria_45: L3 cgMLST [1742 loci] (pubmlst)</option>
                    <option value="neisseria_68-L44_cgMLST-1699-pubmlst">neisseria_68: L44 cgMLST [1699 loci] (pubmlst)</option>
                    <option value="neisseria_62-N._gonorrhoeae_cgMLST_v1.0-1649-pubmlst">neisseria_62: N. gonorrhoeae cgMLST v1.0 [1649 loci] (pubmlst)</option>
                    <option value="neisseria_89-N._gonorrhoeae_cgMLST_v2-1430-pubmlst">neisseria_89: N. gonorrhoeae cgMLST v2 [1430 loci] (pubmlst)</option>
                    <option value="neisseria_47-N._meningitidis_cgMLST_v1-1605-pubmlst">neisseria_47: N. meningitidis cgMLST v1 [1605 loci] (pubmlst)</option>
                    <option value="neisseria_85-N._meningitidis_cgMLST_v2-1422-pubmlst">neisseria_85: N. meningitidis cgMLST v2 [1422 loci] (pubmlst)</option>
                    <option value="neisseria_88-N._meningitidis_cgMLST_v3-1329-pubmlst">neisseria_88: N. meningitidis cgMLST v3 [1329 loci] (pubmlst)</option>
                    <option value="pmultocida_3-cgMLST_draft_1233-pubmlst">pmultocida_3: cgMLST (draft) [1233 loci] (pubmlst)</option>
                    <option value="salmonella_3-SalmcgMLST_v1.0-2750-pubmlst">salmonella_3: SalmcgMLST v1.0 [2750 loci] (pubmlst)</option>
                    <option value="serratia_2-cgMLST-2692-pubmlst">serratia_2: cgMLST [2692 loci] (pubmlst)</option>
                    <option value="saureus_20-cgMLST-1716-pubmlst">saureus_20: cgMLST [1716 loci] (pubmlst)</option>
                    <option value="sagalactiae_38-h_S.agalactiae_cgMLST_v1.0-1405-pubmlst">sagalactiae_38: h_S.agalactiae cgMLST v1.0 [1405 loci] (pubmlst)</option>
                    <option value="spneumoniae_2-cgMLST-1222-pubmlst">spneumoniae_2: cgMLST [1222 loci] (pubmlst)</option>
                    <option value="suberis_8-cgMLST-1447-pubmlst">suberis_8: cgMLST [1447 loci] (pubmlst)</option>
                    <option value="vcholerae_3-cgMLST-2443-pubmlst">vcholerae_3: cgMLST [2443 loci] (pubmlst)</option>
                    <option value="vparahaemolyticus_3-cgMLST-2254-pubmlst">vparahaemolyticus_3: cgMLST [2254 loci] (pubmlst)</option>
                    <option value="xcitri_1-cgMLST-1618-pubmlst">xcitri_1: cgMLST [1618 loci] (pubmlst)</option>
                </param>
            </when>
            <when value="bigsdb">
                <param name="db_version" type="select" label="Select if you want latest version using tokens" help="If you choose latest, you will have to provide tokens and secrets to access the database following the procedure describe in the documentation." >
                    <option value="token" selected="true">Latest version, you will need to set bash variables for tokens and secrets as described in the documentation.</option>
                    <option value="no_token">No need of tokens but it will download the previous version (before January 2025), not the latest version</option>
                </param>
                <param name="coreprofiler_scheme_select" type="select" label="CoreProfiler available scheme" help="Choose a schema from a reference platform supported in CoreProfiler">                   
                    <option value="bordetella_1-cgMLST_genus-1415-BIGSdb">bordetella_1: cgMLST_genus [1415 loci] (BIGSdb)</option>
                    <option value="bordetella_4-cgMLST_pertussis-2038-BIGSdb">bordetella_4: cgMLST_pertussis [2038 loci] (BIGSdb)</option>
                    <option value="diphtheria_1-cgMLST-1305-BIGSdb">diphtheria_1: cgMLST [1305 loci] (BIGSdb)</option>
                    <option value="diphtheria_5-cgMLST_ulcerans-1628-BIGSdb">diphtheria_5: cgMLST_ulcerans [1628 loci] (BIGSdb)</option>
                    <option value="klebsiella_15-cgMLST_KpI-2537-BIGSdb">klebsiella_15: cgMLST_KpI [2537 loci] (BIGSdb)</option>
                    <option value="klebsiella_10-cgMLST_ST258_ST512_ST1199-1371-BIGSdb">klebsiella_10: cgMLST_ST258_ST512_ST1199 [1371 loci] (BIGSdb)</option>
                    <option value="klebsiella_18-scgMLST629_S-629-BIGSdb">klebsiella_18: scgMLST629_S [629 loci] (BIGSdb)</option>
                    <option value="klebsiella_3-scgMLST634-632-BIGSdb">klebsiella_3: scgMLST634 [632 loci] (BIGSdb)</option>
                    <option value="leptospira_3-capture_cgMLST-545-BIGSdb">leptospira_3: capture_cgMLST [545 loci] (BIGSdb)</option>
                    <option value="leptospira_1-cgMLST-545-BIGSdb">leptospira_1: cgMLST [545 loci] (BIGSdb)</option>
                    <option value="listeria_3-cgMLST1748-1748-BIGSdb">listeria_3: cgMLST1748 [1748 loci] (BIGSdb)</option>
                    <option value="yersinia_2-Y.enterocolitica_cgMLST-1727-BIGSdb">yersinia_2: Y.enterocolitica cgMLST [1727 loci] (BIGSdb)</option>
                    <option value="yersinia_1-Yersinia_cgMLST-500-BIGSdb">yersinia_1: Yersinia cgMLST [500 loci] (BIGSdb)</option>
                    <option value="yersinia_3-Y.pseudotuberculosis_cgMLST-1921-BIGSdb">yersinia_3: Y.pseudotuberculosis cgMLST [1921 loci] (BIGSdb)</option>
                </param>
            </when>
            <when value="enterobase">
                <param name="coreprofiler_scheme_select" type="select" label="CoreProfiler available scheme" help="Choose a schema from a reference platform supported in CoreProfiler">                   
                    <option value="escherichia_v1-cgMLST-2513-enterobase">escherichia_v1: cgMLST v1 [2513 loci] (enterobase)</option>
                    <option value="salmonella_v2-cgMLST-3002-enterobase">salmonella_v2: cgMLST v2 [3002 loci] (enterobase)</option>
                </param>
            </when>
            <when value="cgmlstorg">
                <param name="coreprofiler_scheme_select" type="select" label="CoreProfiler available scheme" help="Choose a schema from a reference platform supported in CoreProfiler">                   
                    <option value="abaumannii1379-Acinetobacter_baumannii-2390-cgmlstorg">abaumannii1379: Acinetobacter baumannii [2390 loci] (cgmlstorg)</option>
                    <option value="banthracis1377-Bacillus_anthracis-3803-cgmlstorg">banthracis1377: Bacillus anthracis [3803 loci] (cgmlstorg)</option>
                    <option value="bmallei_fli1407-Burkholderia_mallei_(FLI)-2838-cgmlstorg">bmallei_fli1407: Burkholderia mallei (FLI) [2838 loci] (cgmlstorg)</option>
                    <option value="bmallei_rki1382-Burkholderia_mallei_(RKI)-3328-cgmlstorg">bmallei_rki1382: Burkholderia mallei (RKI) [3328 loci] (cgmlstorg)</option>
                    <option value="bmelitensis1379-Brucella_melitensis-2704-cgmlstorg">bmelitensis1379: Brucella melitensis [2704 loci] (cgmlstorg)</option>
                    <option value="bpertussis1383-Bordetella_pertussis-2983-cgmlstorg">bpertussis1383: Bordetella pertussis [2983 loci] (cgmlstorg)</option>
                    <option value="bpseudomallei1379-Burkholderia_pseudomallei-4221-cgmlstorg">bpseudomallei1379: Burkholderia pseudomallei [4221 loci] (cgmlstorg)</option>
                    <option value="cdifficile1373-Clostridioides_difficile-2147-cgmlstorg">cdifficile1373: Clostridioides difficile [2147 loci] (cgmlstorg)</option>
                    <option value="cdiphtheriae1376-Corynebacterium_diphtheriae-1553-cgmlstorg">cdiphtheriae1376: Corynebacterium diphtheriae [1553 loci] (cgmlstorg)</option>
                    <option value="cfreundii2556-Citrobacter_freundii-3250-cgmlstorg">cfreundii2556: Citrobacter freundii [3250 loci] (cgmlstorg)</option>
                    <option value="cfreundii2557-Citrobacter_freundii/portucalensis/braakii/europaeus-2307-cgmlstorg">cfreundii2557: Citrobacter freundii/portucalensis/braakii/europaeus [2307 loci] (cgmlstorg)</option>
                    <option value="cjejuni1410-Campylobacter_jejunicol-637-cgmlstorg">cjejuni1410: Campylobacter jejuni/coli [637 loci] (cgmlstorg)</option>
                    <option value="cpseudotuberculosis1371-Corynebacterium_pseudotuberculosis-1577-cgmlstorg">cpseudotuberculosis1371: Corynebacterium pseudotuberculosis [1577 loci] (cgmlstorg)</option>
                    <option value="csakazakii1396-Cronobacter_sakazakii/malonaticus-2831-cgmlstorg">csakazakii1396: Cronobacter sakazakii/malonaticus [2831 loci] (cgmlstorg)</option>
                    <option value="efaecalis1383-Enterococcus_faecalis-1972-cgmlstorg">efaecalis1383: Enterococcus faecalis [1972 loci] (cgmlstorg)</option>
                    <option value="efaecium1373-Enterococcus_faecium-1423-cgmlstorg">efaecium1373: Enterococcus faecium [1423 loci] (cgmlstorg)</option>
                    <option value="ehormaechei1373-Enterobacter_hormaechei-2178-cgmlstorg">ehormaechei1373: Enterobacter hormaechei [2178 loci] (cgmlstorg)</option>
                    <option value="ftularensis1410-Francisella_tularensis-1147-cgmlstorg">ftularensis1410: Francisella tularensis [1147 loci] (cgmlstorg)</option>
                    <option value="koxytoca1397-Klebsiella_oxytoca/grimontii/michiganensis/pasteurii-2536-cgmlstorg">koxytoca1397: Klebsiella oxytoca/grimontii/michiganensis/pasteurii [2536 loci] (cgmlstorg)</option>
                    <option value="kpneumoniae1412-Klebsiella_pneumoniae/variicola/quasipneumoniae-2358-cgmlstorg">kpneumoniae1412: Klebsiella pneumoniae/variicola/quasipneumoniae [2358 loci] (cgmlstorg)</option>
                    <option value="lmonocytogenes1369-Listeria_monocytogenes-1701-cgmlstorg">lmonocytogenes1369: Listeria monocytogenes [1701 loci] (cgmlstorg)</option>
                    <option value="lpneumophila1376-Legionella_pneumophila-1521-cgmlstorg">lpneumophila1376: Legionella pneumophila [1521 loci] (cgmlstorg)</option>
                    <option value="mgallisepticum1387-Mycoplasma_gallisepticum-425-cgmlstorg">mgallisepticum1387: Mycoplasma gallisepticum [425 loci] (cgmlstorg)</option>
                    <option value="mmorganii1375-Morganella_morganii-2462-cgmlstorg">mmorganii1375: Morganella morganii [2462 loci] (cgmlstorg)</option>
                    <option value="mtuberculosis1380-Mycobacterium_tuberculosis/bovis/africanum/canettii-2891-cgmlstorg">mtuberculosis1380: Mycobacterium tuberculosis/bovis/africanum/canettii [2891 loci] (cgmlstorg)</option>
                    <option value="paeruginosa1414-Pseudomonas_aeruginosa-3867-cgmlstorg">paeruginosa1414: Pseudomonas aeruginosa [3867 loci] (cgmlstorg)</option>
                    <option value="plarvae1373-Paenibacillus_larvae-2419-cgmlstorg">plarvae1373: Paenibacillus larvae [2419 loci] (cgmlstorg)</option>
                    <option value="pmirabilis1409-Proteus_mirabilis-2574-cgmlstorg">pmirabilis1409: Proteus mirabilis [2574 loci] (cgmlstorg)</option>
                    <option value="pstuartii1393-Providencia_stuartii-3079-cgmlstorg">pstuartii1393: Providencia stuartii [3079 loci] (cgmlstorg)</option>
                    <option value="sargenteus1376-Staphylococcus_argenteus-2168-cgmlstorg">sargenteus1376: Staphylococcus argenteus [2168 loci] (cgmlstorg)</option>
                    <option value="saureus1414-Staphylococcus_aureus-1861-cgmlstorg">saureus1414: Staphylococcus aureus [1861 loci] (cgmlstorg)</option>
                    <option value="scapitis1381-Staphylococcus_capitis-1492-cgmlstorg">scapitis1381: Staphylococcus capitis [1492 loci] (cgmlstorg)</option>
                    <option value="smarcescens1387-Serratia_marcescens-2692-cgmlstorg">smarcescens1387: Serratia marcescens [2692 loci] (cgmlstorg)</option>
                    <option value="spyogenes1370-Streptococcus_pyogenes-1095-cgmlstorg">spyogenes1370: Streptococcus pyogenes [1095 loci] (cgmlstorg)</option>
                    <option value="yenterocolitica1404-Yersinia_enterocolitica-2582-cgmlstorg">yenterocolitica1404: Yersinia enterocolitica [2582 loci] (cgmlstorg)</option>
                </param>
            </when>
        </conditional>
        <!-- used only for tests, limit download scheme to 50 locus -->
        <param name="hide_test" type="hidden" value=""/>
        <!-- -->
    </inputs>
    <outputs>
        <data name="out_file" format="data_manager_json" label="${tool.name}"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="hide_test" value="true"/>
            <conditional name="select_db">
                <param name="db_list" value="pubmlst"/>
                <param name="db_version" value="no_token"/>
                <param name="coreprofiler_scheme_select" value="borrelia_3-cgMLST-639-pubmlst" />
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text='"coreprofiler_scheme":'/>
                    <has_text_matching expression='"value": "coreprofiler_downloaded_[0-9]{8}-borrelia_3-cgMLST-639-pubmlst-no_token"'/>
                    <has_text text='"name": "borrelia_3: cgMLST [639 loci] (pubmlst-no_token)"'/>
                    <has_text text='"path": "coreprofiler_borrelia_3_no_token"'/>
                    <has_text text='"database": "coreprofiler_borrelia_3_no_token/db_borrelia_3/borrelia_3.fasta"'/>
                    <has_text text='"scheme": "coreprofiler_borrelia_3_no_token/scheme_borrelia_3"'/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="hide_test" value="true"/>
            <conditional name="select_db">
                <param name="db_list" value="bigsdb"/>
                <param name="db_version" value="no_token"/>
                <param name="coreprofiler_scheme_select" value="yersinia_1-Yersinia_cgMLST-500-BIGSdb" />
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text='"coreprofiler_scheme":'/>
                    <has_text_matching expression='"value": "coreprofiler_downloaded_[0-9]{8}-yersinia_1-Yersinia_cgMLST-500-BIGSdb-no_token"'/>
                    <has_text text='"name": "yersinia_1: Yersinia_cgMLST [500 loci] (BIGSdb-no_token)"'/>
                    <has_text text='"path": "coreprofiler_yersinia_1_no_token"'/>
                    <has_text text='"database": "coreprofiler_yersinia_1_no_token/db_yersinia_1/yersinia_1.fasta"'/>
                    <has_text text='"scheme": "coreprofiler_yersinia_1_no_token/scheme_yersinia_1"'/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="hide_test" value="true"/>
            <conditional name="select_db">
                <param name="db_list" value="enterobase"/>
                <param name="coreprofiler_scheme_select" value="escherichia_v1-cgMLST-2513-enterobase" />
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text='"coreprofiler_scheme":'/>
                    <has_text_matching expression='"value": "coreprofiler_downloaded_[0-9]{8}-escherichia_v1-cgMLST-2513-enterobase-no_token"'/>
                    <has_text text='"name": "escherichia_v1: cgMLST [2513 loci] (enterobase-no_token)"'/>
                    <has_text text='"path": "coreprofiler_escherichia_v1_no_token"'/>
                    <has_text text='"database": "coreprofiler_escherichia_v1_no_token/db_escherichia_v1/escherichia_v1.fasta"'/>
                    <has_text text='"scheme": "coreprofiler_escherichia_v1_no_token/scheme_escherichia_v1"'/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="hide_test" value="true"/>
                <conditional name="select_db">
                <param name="db_list" value="cgmlstorg"/>
                <param name="coreprofiler_scheme_select" value="mgallisepticum1387-Mycoplasma_gallisepticum-425-cgmlstorg" />
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text='"coreprofiler_scheme":'/>
                    <has_text_matching expression='"value": "coreprofiler_downloaded_[0-9]{8}-mgallisepticum1387-Mycoplasma_gallisepticum-425-cgmlstorg-no_token"'/>
                    <has_text text='"name": "mgallisepticum1387: Mycoplasma_gallisepticum [425 loci] (cgmlstorg-no_token)"'/>
                    <has_text text='"path": "coreprofiler_mgallisepticum1387_no_token"'/>
                    <has_text text='"database": "coreprofiler_mgallisepticum1387_no_token/db_mgallisepticum1387/mgallisepticum1387.fasta"'/>
                    <has_text text='"scheme": "coreprofiler_mgallisepticum1387_no_token/scheme_mgallisepticum1387"'/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
This tool downloads and installs **CoreProfiler** schemes into Galaxy using the Data Manager framework.

Overview
--------

CoreProfiler supports several reference platforms:

- **pubMLST**
- **BIGSdb**
- **EnteroBase**
- **cgMLST.org**

The list of available schemes is maintained in the `CoreProfiler documentation <https://gitlab.com/ifb-elixirfr/abromics/coreprofiler/-/blob/main/README.md#basic-usage>`_.

Please refer to this page for details on how to use the tool and which schema options are available.

You simply need to choose:
1. A reference platform  
2. A scheme available on that platform  
3. Whether authentication is required (pubMLST / BIGSdb only)

Galaxy will download the database, build the scheme, and register it automatically.

---

Authentication requirements
---------------------------

Authentication is **not needed** for:

- **EnteroBase**  
- **cgMLST.org**


Authentication **is recommended** for:

- **pubMLST**
- **BIGSdb**


Why?
````

BIGSdb and pubMLST platforms require **OAuth1** authentication and restrict access to the most up-to-date data.  
While authentication is not strictly mandatory, skipping it may result in downloading **outdated** schemes.


This authentication involves two types of tokens:

 * Consumer tokens : permanent tokens used to initiate the authentication flow.

 * Access tokens : tokens required to download a scheme.

---

Procedure to obtain pubMLST and BIGSdb schemes
----------------------------------------------

Example
```````
- **pubMLST**: borrelia_3-cgMLST-639-pubmlst
- **BIGSdb**: bordetella_1-cgMLST_genus-1415-BIGSdb

1. Create an account on the `pubMLST <https://pubmlst.org/bigsdb>`_ or `BigsDB <https://bigsdb.pasteur.fr/cgi-bin/bigsdb/bigsdb.pl?page=registration>`_ website.
2. Generate a **consumer token** and **consumer secret** 
   * **pubMLST**: From your account settings (My account > API keys > Enter key name > Submit).
   * **BIGSdb**: By sending a mail to bigsdb@pasteur.fr (object "API client key").
3. On your account page, go to **Database registrations**, check all databases and register.
4. Download and install `coreprofiler <https://gitlab.com/ifb-elixirfr/abromics/coreprofiler>`_ locally and run the following command to **obtain your access token and secret**

Replace the placeholders with your scheme of interest (example : borrelia_3 or bordetella_1) your actual consumer token and secret :

"""
coreprofiler db get_request_tokens --scheme <SCHEME_NAME> --consumer_key <YOUR_CONSUMER_TOKEN> --consumer_secret <YOUR_CONSUMER_SECRET>
"""

This command will provide you with a URL to visit in order to **authorize client software** to access your account. 
After authorizing, it will give you a **verification code** that you need to enter in the command line prompt.
It will then return **your access token and secret**.

5. Provide the **consumer token**, **consumer secret**, **access token**, and **access secret** in the data manager tool by setting this bash variables in a txt file : 

"""
export COREPROFILER_CONSUMER_TOKEN="<YOUR_CONSUMER_TOKEN>"
export COREPROFILER_CONSUMER_SECRET="<YOUR_CONSUMER_SECRET>"
export COREPROFILER_ACCESS_TOKEN="<YOUR_ACCESS_TOKEN>"
export COREPROFILER_ACCESS_SECRET="<YOUR_ACCESS_SECRET>"
"""

6. Set the **path** to this txt file in your environment by making an environment variable (example : export COREPROFILER_SECRETS_PATH="/path/to/your/secret_file.txt").

]]></help>
    <citations>
        <citation type="doi">10.3390/microorganisms10020292</citation>
    </citations>
</tool>
