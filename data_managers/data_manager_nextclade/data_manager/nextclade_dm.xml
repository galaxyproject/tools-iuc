<tool id="data_manager_nextclade" name="nextclade data manager" version="2.11.0+galaxy0" tool_type="manage_data" profile="20.01">

    <requirements>
        <requirement type="package" version="3.11">python</requirement>
        <requirement type="package" version="2.11.0">nextclade</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    #set $data_table = $__app__.tool_data_tables.get('nextclade2')
    #if $data_table is not None and len($data_table.get_fields()) != 0
        #set $known_revisions = '--known_revisions=' + ','.join([row[0] for row in $data_table.get_fields()])
    #else
        #set $known_revisions = ''
    #end if
    #if str($additional_datasets).strip() != ''
        #if str($datasets) != ''
            #set $dataset_list = $datasets + ',' + str($additional_datasets).strip()
        #else
            #set $dataset_list = str($additional_datasets)
        #end if
    #else
        #set $dataset_list = str($datasets)
    #end if
    python '$__tool_directory__/nextclade_dm.py'
        $known_revisions
        #if str($release_restrictions.start_date).strip() != ""
            --start_date '$release_restrictions.start_date'
        #end if
        #if str($release_restrictions.end_date).strip() != ""
            --end_date '$release_restrictions.end_date'
        #end if
        $release_restrictions.latest
        --datasets '$dataset_list'        
        nextclade2
        '${output_file}'
    ]]></command>
    <inputs>
        <param name="datasets" type="select" label="Select nextclade datasets by name" multiple="true">
            <option value="sars-cov-2" selected="true">SARS-CoV-2</option>
            <option value="sars-cov-2-21L">SARS-CoV-2 relative to BA.2</option>
            <option value="sars-cov-2-no-recomb">SARS-CoV-2 without recombinants</option>
            <option value="MPXV">Monkeypox (All Clades)</option>
            <option value="hMPXV">Human Monkeypox (hMPXV)</option>
            <option value="hMPXV_B1">Human Monkeypox Clade B.1</option>
            <option value="rsv_a">RSV-A</option>
            <option value="rsv_b">RSV-B</option>
            <option value="flu_h1n1pdm_ha">Influenza A H1N1pdm HA</option>
            <option value="flu_h1n1pdm_na">Influenza A H1N1pdm NA (Neuraminidase)</option>
            <option value="flu_h3n2_ha">Influenza A H3N2 HA</option>
            <option value="flu_h3n2_na">Influenza A H3N2 NA (Neuraminidase)</option>
            <option value="flu_vic_ha">Influenza B Victoria HA</option>
            <option value="flu_vic_na">Influenza B Victoria NA (Neuraminidase)</option>
            <option value="flu_yam_ha">Influenza B Yamagata HA</option>
        </param>
        <param name="additional_datasets" type="text" label="Additional nextclade dataset names" help="If you want to download datasets that are not in the list above, enter their names here, separated by commas">
            <validator type="regex" message="Dataset names consist of letters, numbers, underscore and hyphens, with multiple names separated by ,">^[-A-Za-z0-9_]?[-A-Za-z0-9_,]*$</validator>
        </param>
        <section name="release_restrictions" title="Restrict releases of named dataset to download" expanded="true">
            <param name="start_date" type="text" label="Start date (YYYY-MM-DD)" help="Don't download releases older than this date" optional="true">
                <validator type="regex" message="Dates are in YYYY-MM-DD format">\d{4}-\d{2}-\d{2}$</validator>
            </param>
            <param name="end_date" type="text" label="End date (YYYY-MM-DD)" help="Don't download releases newer than this date" optional="true">
                <validator type="regex" message="Dates are in YYYY-MM-DD format">\d{4}-\d{2}-\d{2}$</validator>
            </param>
            <param name="latest" type="boolean" truevalue="--latest" falsevalue="" label="Only download the latest releases within the time window" />
        </section>
    </inputs>
    <outputs>
        <data name="output_file" format="data_manager_json"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <section name="release_restrictions">
                <param name="start_date" value="2022-03-01" />
                <param name="end_date" value="2022-04-01" />
            </section>
            <output name="output_file">
                <assert_contents>
                    <has_text text="&quot;dataset_name%quot;: &quot;sars-cov-2&quot;" />
                    <has_text text="&quot;value&quot;: &quot;sars-cov-2_MN908947_2022-03-31T12-00-00Z&quot;" />
                    <has_text text="&quot;value&quot;: &quot;sars-cov-2_MN908947_2022-03-24T12-00-00Z&quot;" />
                    <has_text text="&quot;value&quot;: &quot;sars-cov-2_MN908947_2022-03-14T12-00-00Z&quot;" />
                    <has_text text="&quot;min_nextclade_version&quot;: &quot;1.10.0&quot;" />
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="datasets" value="MPXV,hMPXV" />
            <section name="release_restrictions">
                <param name="latest" value="true" />
            </section>
            <output name="output_file">
                <assert_contents>
                    <has_text text="&quot;dataset_name%quot;: &quot;MPXV&quot;" />
                    <has_text text="&quot;dataset_name%quot;: &quot;hMPXV&quot;" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
This data manager fetches databases for the nextclade_ viral genome typing tool and
updates the nextclade2 datatable.

The data manager has a built-in list of databases that can be fetched and users can specify ones by name if they want something that is not on the list.

The data manager will read the existing data tables and not re-download or replace databases that are already present in those data tables.

.. _nextclade: https://clades.nextstrain.org/
    ]]></help>
    <citations>
        <citation type="doi">10.21105/joss.03773</citation>
    </citations>
</tool>
