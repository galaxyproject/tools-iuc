<tool id="data_manager_snpsift_dbnsfp" name="SnpSift dbNSFP" version="4.1.0" tool_type="manage_data">
    <description>Install a dbNSFP variant annotation database</description>
    <requirements>
        <requirement type="package" version="3.7">python</requirement>
        <requirement type="package" version="0.8.3">pysam</requirement>
    </requirements>
    <stdio>
        <exit_code range=":-1"  level="fatal"   description="Error: Cannot open file" />
        <exit_code range="1:"  level="fatal"   description="Error" />
    </stdio>
    <command interpreter="python">
        #import re
        data_manager_snpsift_dbnsfp.py
        #if $db.src == 'softgenetics':
            --softgenetics "$db.softgenetics_name"
        #elif $db.src == 'history':
            #if $db.snpsiftdbnsfp.is_of_type('snpsiftdbnsfp'):
                #import os.path
                --snpsiftdbnsfp "$os.path.join($db.snpsiftdbnsfp.extra_files_path, $db.snpsiftdbnsfp.metadata.bgzip)"
            #else
                --dbnsfp_tabular "$db.snpsiftdbnsfp"
            #end if
            --db_name "$db.db_name"
            #if str($db.dbkey).strip() != '':
                --dbkey "$db.dbkey"
            #elif str($db.snpsiftdbnsfp.metadata.dbkey) != '?':
                --dbkey "$db.snpsiftdbnsfp.metadata.dbkey"
            #end if
        #end if
        "$out_file"
        </command>
    <inputs>
        <conditional name="db">
            <param name="src" type="select" label="Source for dbNSFP file">
                <option value="softgenetics">Jpopgen dbNSFP from softgenetics</option>
                <option value="history">from your history</option>
            </param>
            <when value="softgenetics">
                <param name="softgenetics_name" type="text" value="" label="dbNSFP file name at softgenetics ftp site">
                  <help>Download From:  ftp://dbnsfp.softgenetics.com/
                        Enter the name of the database, e.g.:  dbNSFPv3.0c.zip
                  </help>
                  <validator type="regex"  message="A dbNSFP or dbscSNV .zip">(dbNSFP|dbscSNV).*[.]zip</validator>
                </param>
            </when>
            <when value="history">
                <param name="snpsiftdbnsfp" type="data" format="snpsiftdbnsfp,dbnsfp.tabular" label="A snpsift dbnsfp from your history"
                 help="This can can be generated by converting a tabular file set to type: dbnsfp.tabular"/>
                <param name="db_name" type="text" value="" label="The unique name to give this dbnsfp database">
                  <validator type="length" min="3" max="20" message="Must have between 3 and 20 chracters"/>
                  <validator type="regex" message="No whitespace allowed">^\S*$</validator>
                </param>
                <param name="dbkey" type="text" value="hg19" optional="true" label="DBKEY to assign to data to this dbNSFP database" />
            </when>
        </conditional>
    </inputs>

    <outputs>
           <data name="out_file" format="data_manager_json" label="${tool.name}"/>
    </outputs>
    <tests>
        <test>
            <param name="src" value="history"/>
            <param name="snpsiftdbnsfp" value="test_nsfp.tsv" ftype="dbnsfp.tabular"/>
            <param name="dbkey" value="hg19"/>
            <param name="db_name" value="test_nsfp_tsv" />
            <output name="out_file" file="test_nsfp.data_manager_json"/>
        </test>
    </tests>
    <help>

This tool installs dbNSFP_ databases to annotate VCF files using SnpSift_dbNSFP_
It populates data table: snpsift_dbnsfps

.. _dbNSFP: https://sites.google.com/site/jpopgen/dbNSFP
.. _SnpSift_dbNSFP: http://snpefIf.sourceforge.net/SnpSift.html#dbNSFP

Please refer to https://sites.google.com/site/jpopgen/dbNSFP for which citations to use with specific dbNSFP database versions.

    </help>
    <citations>
        <citation type="doi">DOI: 10.1002/humu.21517</citation>
        <citation type="doi">DOI: 10.1002/humu.22376</citation>
        <citation type="doi">DOI: 10.1002/humu.22932</citation>
        <citation type="doi">doi: 10.1093/hmg/ddu733</citation>
        <citation type="doi">doi: 10.1093/nar/gku1206</citation>
        <citation type="doi">doi: 10.3389/fgene.2012.00035</citation>
    </citations>
</tool>

