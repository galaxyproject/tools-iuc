<tool id="data_manager_pangolin_data" name="pangolin-data data manager" version="0.0.3+galaxy2" tool_type="manage_data" profile="20.01">
    <requirements>
        <requirement type="package" version="3.8">python</requirement>
        <requirement type="package" version="2.24.0">requests</requirement>
        <requirement type="package" version="21.3">packaging</requirement>
        <requirement type="package" version="2.35.3">git</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    #set $data_table = $__app__.tool_data_tables.get("pangolin_data")
    #if $data_table is not None
        #set $known_revisions = '--known_revisions=' + ','.join([row[0] for row in $data_table.get_fields()])
    #else
        #set $known_revisions = ''
    #end if    
    python '$__tool_directory__/pangolin_data_dm.py'
        $known_revisions
        #if $release.which == "latest"
            --latest
        #else if $release.which == "version_range"
            #if str($release.start_version) != ""
                --start_version=$release.start_version
            #end if
            #if str($release.end_version) != ""
                --end_version=$release.end_version
            #end if
        #else if $release.which == "date_range"
            #if str($release.start_date).strip() != ""
                --start_date '$release.start_date'
            #end if
            #if str($release.end_date).strip() != ""
                --end_date '$release.end_date'
            #end if
        #end if
        'pangolin_data'
        '${output_file}'
    ]]></command>
    <inputs>
        <conditional name="release">
            <param name="which" type="select" label="Select pangolin-data release">
                <option value="latest" selected="true">Latest</option>
                <option value="version_range">Version range</option>
                <option value="date_range">Date range</option>
                <!-- <option value="history">From history</option> -->
            </param>
            <when value="latest">
            </when>
            <when value="version_range">
                <param name="start_version" type="text" label="Start version (vX.Y)">
                    <validator type="regex">v?\d+(\.\d+)?$</validator>
                </param>
                <param name="end_version" type="text" label="End version (vX.Y)">
                    <validator type="regex">v?\d+(\.\d+)?$</validator>
                </param>
            </when>
            <when value="date_range">
                <param name="start_date" type="text" label="Start date (YYYY-MM-DD)" help="Don't download models older than this date" optional="true">
                    <validator type="regex">\d{4}-\d{2}-\d{2}$</validator>
                </param>
                <param name="end_date" type="text" label="End date (YYYY-MM-DD)" help="Don't download models newer than this date" optional="true">
                    <validator type="regex">\d{4}-\d{2}-\d{2}$</validator>
                </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="output_file" format="data_manager_json"/>
    </outputs>
    <tests>
        <test>
            <conditional name="release">
                <param name="which" value="date_range" />
                <param name="start_date" value="2022-04-01" />
                <param name="end_date" value="2022-04-10" />
            </conditional>
            <output name="output_file">
                <assert_contents>
                    <has_text text="pangolin-data v1.2.133"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <conditional name="release">
                <param name="which" value="version_range" />
                <param name="start_version" value="v1.6" />
                <param name="end_version" value="v1.9" />
            </conditional>
            <output name="output_file">
                <assert_contents>
                    <has_text text='"value": "v1.6"'/>
                    <has_text text='"value": "v1.8"'/>
                    <has_text text='"value": "v1.9"'/>
                    <has_text text='"min_pangolin_version": "4"'/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
        This data managers fetches models (from the pangolin-data_ repository) for the pangolin_
        SARS-CoV-2 lineage typing tool and updates the pangolin-data data table.

        .. _pangolin-data: https://github.com/cov-lineages/pangolin-data
        .. _pangolin: https://github.com/cov-lineages/pangolin
    ]]></help>
    <citations>
        <citation type="doi">10.1093/ve/veab064</citation>
    </citations>
</tool>
