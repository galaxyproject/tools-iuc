<tool id="data_manager_mmseqs2_download" name="Download MMseqs2 databases" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" tool_type="manage_data" profile="22.05">
    <description></description>
    <macros>
        <token name="@TOOL_VERSION@">15</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <token name="@COMMIT@">6f452</token>
        <token name="@FULL_TOOL_VERSION@">@TOOL_VERSION@.@COMMIT@</token>
    </macros>
    <requirements>
        <requirement type="package" version="@FULL_TOOL_VERSION@">mmseqs2</requirement>
    </requirements>
    <stdio>
        <exit_code range=":-1" level="fatal" description="Error: Cannot open file"/>
        <exit_code range="1:" level="fatal" description="Error"/>
    </stdio>
    <command><![CDATA[
#set $database_name = str($database).split('/')[-1] if '/' in str($database) else str($database)
mkdir -p '$database_name' &&
mkdir -p '$out_file.extra_files_path' &&
mmseqs databases 
        '$database' '$database_name'/database
        '$data_table'
        --threads "\${GALAXY_SLOTS:-1}" &&
mv ${database_name} '$out_file.extra_files_path' &&
cp '$dmjson' '$out_file'
    ]]></command>
     <configfiles>
        <configfile name="dmjson"><![CDATA[
#from datetime import date
#set $database_name = str($database).split('/')[-1] if '/' in str($database) else str($database)
{
  "data_tables":{
    "$data_table":[
      {
        "value": "${database}-@FULL_TOOL_VERSION@-#echo date.today().strftime('%d%m%Y')#",
        "name": "${database} #echo date.today().strftime('%d%m%Y')#",
        "path": "$database_name",
        "version": "@FULL_TOOL_VERSION@"
      }
    ]
  }
}]]>
        </configfile>
    </configfiles>
    <inputs>
        <conditional name="db_name">
            <param argument="type" type="select" label="Type of Databases">
                <option value="aminoacid" selected="true">Aminoacid databases</option>
                <option value="aminoacid_taxonomy">Aminoacid databases that can be used for taxonomy</option>
                <option value="nucleotide">Nucleotide databases</option>
                <option value="nucleotide_taxonomy">Nucleotide databases that can be used for taxonomy</option>
                <option value="profile">Profile databases</option>
            </param>
            <when value="aminoacid">
                <param name="database" type="select" label="MMseqs2 aminoacid databases">
                    <option value="UniRef100" selected="true">UniRef100</option>
                    <option value="UniRef90">UniRef90</option>
                    <option value="UniRef50">UniRef50</option>
                    <option value="UniProtKB">UniProtKB</option>
                    <option value="UniProtKB/TrEMBL">TrEMBL (UniProtKB)</option>
                    <option value="UniProtKB/Swiss-Prot">Swiss-Prot (UniProtKB)</option>
                    <option value="NR">NR (Non-redundant protein sequences from GenPept, Swissprot, PIR, PDF, PDB, and NCBI RefSeq)</option>
                    <option value="GTDB">GTDB (Genome Taxonomy Database)</option>
                    <option value="PDB">PDB (The Protein Data Bank)</option>            
                </param>
                <param name="data_table" type="select" label="Select datatable">
                    <option value="mmseqs2_aminoacid_databases" selected="true">Aminoacid Databases</option>            
                </param>
            </when>
            <when value="aminoacid_taxonomy">
                <param name="database" type="select" label="MMseqs2 aminoacid databases that can be used for taxonomy">
                    <option value="UniRef100" selected="true">UniRef100</option>
                    <option value="UniRef90">UniRef90</option>
                    <option value="UniRef50">UniRef50</option>
                    <option value="UniProtKB">UniProtKB</option>
                    <option value="UniProtKB/TrEMBL">TrEMBL (UniProtKB)</option>
                    <option value="UniProtKB/Swiss-Prot">Swiss-Prot (UniProtKB)</option>
                    <option value="NR">NR (Non-redundant protein sequences from GenPept, Swissprot, PIR, PDF, PDB, and NCBI RefSeq)</option>
                    <option value="GTDB">GTDB (Genome Taxonomy Database)</option>
                </param>
                <param name="data_table" type="select" label="Select datatable">
                    <option value="mmseqs2_aminoacid_taxonomy_databases" selected="true">Aminoacid Databases that can be used for taxonomy</option>            
                </param>
            </when>
            <when value="nucleotide">
                <param name="database" type="select" label="MMseqs2 nucleotide databases">
                    <option value="SILVA">SILVA</option>
                    <option value="Kalamari">Kalamari</option>
                    <option value="NT">NT (Partially non-redundant nucleotide sequences from all traditional divisions of GenBank, EMBL, and DDBJ excluding GSS, STS, PAT, EST, HTG, and WGS)</option>
                    <option value="Resfinder">Resfinder</option>
                </param>
                <param name="data_table" type="select" label="Select datatable">
                    <option value="mmseqs2_nucleotide_databases" selected="true">Nucleotide Databases</option>            
                </param>
            </when>
            <when value="nucleotide_taxonomy">
                <param name="database" type="select" label="MMseqs2 nucleotide databases that can be used for taxonomy">
                    <option value="SILVA">SILVA</option>
                    <option value="Kalamari">Kalamari</option>
                </param>
                <param name="data_table" type="select" label="Select datatable">
                    <option value="mmseqs2_nucleotide_taxonomy_databases" selected="true">Nucleotide Databases that can be used for taxonomy</option>            
                </param>
            </when>
            <when value="profile">
                <param name="database" type="select" label="MMseqs2 profile databases">
                    <option value="PDB70">PDB70 (PDB clustered to 70% sequence identity)</option>
                    <option value="Pfam-A.full">Pfam-A.full</option>
                    <option value="Pfam-A.seed">Pfam-A.seed</option>
                    <option value="Pfam-B">Pfam-B</option>
                    <option value="CDD">CDD (Conserved Domain Database)</option>
                    <option value="VOGDB">VOGDB (Virus Orthologous Groups)</option>
                    <option value="dbCAN2">dbCAN2 (database of carbohydrate-active enzymes)</option>
                </param>
                <param name="data_table" type="select" label="Select datatable">
                    <option value="mmseqs2_profile_databases" selected="true">Profile Databases</option>            
                </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="out_file" format="data_manager_json" label="${tool.name}"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <conditional name="db_name">
                <param name="type" value="nucleotide_taxonomy" />
                <param name="database" value="SILVA" />
                <param name="data_table" value="mmseqs2_nucleotide_taxonomy_databases" />
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text='"mmseqs2_nucleotide_taxonomy_databases":'/>
                    <has_text text='"version": "15.6f452"'/>
                    <has_text_matching expression='"value": "SILVA-15.6f452-[0-9]{8}"'/>
                    <has_text_matching expression='"name": "SILVA [0-9]{8}"'/>
                    <has_text text='"path": "SILVA"'/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <conditional name="db_name">
                <param name="type" value="aminoacid_taxonomy" />
                <param name="database" value="UniProtKB/Swiss-Prot" />
                <param name="data_table" value="mmseqs2_aminoacid_taxonomy_databases" />
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text='"mmseqs2_aminoacid_taxonomy_databases":'/>
                    <has_text text='"version": "15.6f452"'/>
                    <has_text_matching expression='"value": "UniProtKB/Swiss-Prot-15.6f452-[0-9]{8}"'/>
                    <has_text_matching expression='"name": "UniProtKB/Swiss-Prot [0-9]{8}"'/>
                    <has_text text='"path": "Swiss-Prot"'/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
This tool downloads databases that can be used with MMseqs2.
    ]]></help>
    <citations>
        <citation type="doi">10.1038/nbt.3988</citation>
    </citations>
</tool>