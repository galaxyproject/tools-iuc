<tool id="qualimap_bamqc" name="QualiMap BamQC" version="0.1.0" python_template_version="3.5">
    <requirements>
        <requirement type="package" version="2.2.2c">qualimap</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        export JAVA_OPTS="-Djava.awt.headless=true" &&

        qualimap bamqc -bam '$input1' -c -outdir results &&
        
        mv results/genome_results.txt '${output1}'

    ]]>    </command>
    <inputs>
        <param type="data" name="input1" format="bam" />
    </inputs>
    <outputs>
        <data name="output1" format="txt" from_work_dir="genome_results.txt" />
    </outputs>
    <tests>
        <test>
            <param name="input1" value="test_qc.bam"/>
            <output name="output1">
                <assert_contents>
                    <has_line line=">>>>>>> Mapping quality" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[

BAM QC
======

BAM QC reports information for the evaluation of the quality of the provided alignment data (a BAM file). In short, the basic statistics of the alignment (number of reads,
coverage, GC-content, etc.) are summarized and a number of useful graphs are produced. This analysis can be performed with any kind of sequencing data, 
e.g. whole-genome sequencing, exome sequencing, RNA-seq, ChIP-seq, etc. In addition, 
it is possible to provide an annotation file so the results are computed for the reads mapping inside (and optionally outside) of the corresponding genomic regions,
which can be especially useful for evaluating target-enrichment sequencing studies.

Examples
--------
    - Whole-genome sequencing: HG00096.chrom20.bam. HTML report for sample alignment file from 1000 Genomes project.
    - Whole-genome sequencing: ERRR089819.bam. PDF report created using the whole-genome sequencing data of Caenorhabditis elegans from the following study.
    - See the Sample data section for more details about the data used in the examples.

Input Parameters
----------------
*BAM file*
    Path to the sequence alignment file in BAM format. Note, that the BAM file has to be sorted by chromosomal coordinates. Sorting can be performed with samtools sort.

*Analyze regions*
    Activating this option allows the analysis of the alignment data for the regions of interest.

*Regions file(GFF/BED file)*
    The path to the annotation file that defines the regions of interest. The file must be tab-separated and have GFF/GTF or BED format.

***Note***

A typical problem when working with human genome annotations is the inconsistency between chromosome names due to “chr” prefix. 
For example, Ensemble annotations do not include this prefix, while UCSC annotations do. This can become a problem when asscociating regions file with the BAM alignment.
Qualimap handles this problem: if the reference sequence of a region has “chr” prefix, it tries to search for sequence name with prefix and without prefix.

*Library strand specificity*
    The sequencing protocol strand specificity: non-strand-specific, forward-stranded or reverse-stranded. 
    This information is required to calculate the number of correct strand reads.

*Analyze outside regions*
    If checked, the information about the reads that are mapped outside of the regions of interest will be also computed and shown in a separate section.

*Chromosome limits*
    If selected, vertical dotted lines will be placed at the beginning of each chromosome according to the information found in the header of the BAM file.

*Compare GC content distribution with*
    This allows to compare the GC distribution of the sample with the selected pre-calculated genome GC distribution. 
    Currently two genome distributions are available: human (hg19) and mouse (mm9). More species will be included in future releases.

*Detect overlapping paired-end reads*
    In case of small insert size the paired-end read alignmetns might overlap in high proportion. Using this option detection of overlapping pairs can be activated. 
    Additionally, adapted mean coverage is calcualted based on extraction of pair overlap-region.

*Skip duplicates*
    This option allows to skip duplicate alignments from analysis. There are three modes of this option. 
    By default, the duplicates are skipped only if they are flagged in BAM file and remaining alignments are futher analyzed by Qualimap. 
    Additionally it is possible to skip only the duplicates detected by Qualimap method (based on duplication rate estimation) or aplly both approaches. 
    Number of skipped duplicates will be shown in the report.

Advanced parameters
-------------------
*Number of windows*
    Number of ***windows*** used to ***split*** the reference genome. This value is used for computing the graphs that plot information across the reference. 
    Basically, reads falling in the same window are aggregated in the same bin. 
    The higher the number, the bigger the resolution of the plots but also longer time will be used to process the data. By default 400 windows are used.

*Homopolymer size*
    Only homopolymers of this size or larger will be considered when estimating homopolymer indels count.

*Number of threads*
    In order to speed up the computation, the BAM QC analysis computation can be performed in parallel on a multicore system using the given number of threads. More information on the parallelization of qualimap can be found in FAQ. The default number of threads equals number of available processors.

*Size of the chunk*
    In order to reduce the load of I/O, reads are analyzed in chunks. Each chunk contains the selected number of reads which will be loaded into memory and analyzed by a single thread. Smaller numbers may result in lower performance, but also the memory consumption will be reduced. The default value is 1000 reads.

Output
------

*Summary*
    
    ***Basic information*** and statistics for the alignment data. The following sections are available:

        *Globals*

        This section contains information about the total number of reads, number of mapped reads, paired-end mapping performance, read length distribution, 
        number of clipped reads and duplication rate (estimated from the start positions of read alignments).

        *ACGT Content*

        Nucleotide content and GC percentage in the mapped reads.

        *Coverage*

        Mean and standard deviation of the coverage depth.

        *Mapping quality*

        Mean mapping quality of the mapped reads.

        *Insert size*

        Mean, standard deviation and percentiles of the insert size distribution if applicable. The features are computed based on the TLEN field of the SAM file.

        *Mismatches and indels*

        The section reports general alignment error rate (computed as a ratio of total collected edit distance to the number of mapped bases), total number of mismatches and total number of indels (computed from the CIGAR values). Additionally fraction of the homopolymer indels among total indels is provided. Note, the error rate and mismatches metrics are based on optional fields of a SAM record (NM for edit distance, MD for mismatches). The features are not reported if these fields are missing in the SAM file.

        *Chromosome stats*

        Number of mapped bases, mean and standard deviation of the coverage depth for each chromosome as defined by the header of the SAM file.

    For region-based analysis the information is given inside of regions, including some additional information like, for example, number of correct strand reads.

*Input*

    Here one can check the input data and the parameters used for the analysis.

*Coverage Across Reference*

    This plot consists of two figures. The upper figure provides the coverage distribution (red line) and coverage deviation across the reference sequence. 
    The coverage is measured in X [1]. The lower figure shows GC content across reference (black line) together with its average value (red dotted line).

*Coverage Histogram*

    Histogram of the number of genomic locations having a given coverage rate. The bins of the x-axis are conveniently scaled by aggregating some coverage 
    values in order to produce a representative histogram also in presence of the usual NGS peaks of coverage.

*Coverage Histogram (0-50X)*

    Histogram of the number of genomic locations having a given coverage rate. In this graph genome locations with a coverage greater than 50X are grouped into the last bin. 
    By doing so a higher resolution of the most common values for the coverage rate is obtained.

*Genome Fraction Coverage*

    Provides a visual way of knowing how much reference has been sequenced with at least a given coverage rate. This graph should be interpreted as in this example:
    If one aims a coverage rate of at least 25X (x-axis), how much of reference (y-axis) will be considered? 
    The answer to this question in the case of the whole-genome sequencing provided example is ~83%.

*Duplication Rate Histogram*

    This plot shows the distribution of duplicated read starts. Due to several factors (e.g. amount of starting material, sample preparation, etc) 
    it is possible that the same fragments are sequenced several times. For some experiments where enrichment is used (e.g. ChIP-seq ) this is expected at some low rate. 
    If most of the reads share the exact same genomic positions there is very likely an associated bias.

*Mapped Reads Nucleotide Content*

    This plot shows the nucleotide content per position of the mapped reads.

*Mapped Reads GC Content Distribution*

    This graph shows the distribution of GC content per mapped read. If compared with a precomputed genome distribution, 
    this plot allows to check if there is a shift in the GC content.

*Mapped Reads Clipping Profile*

    Represents the percentage of clipped bases across the reads. The clipping is detected via SAM format CIGAR codes ‘H’ (hard clipping) and ‘S’ (soft clipping). 
    In addition, the total number of clipped reads can be found in the report Summary. The plot is not shown if there are no clipped-reads are found. 
    Total number of clipped reads can be found in Summary. Example.

*Homopolymer Indels*

    This bar plot shows separately the number of indels that are within a homopolymer of A’s, C’s, G’s or T’s together with the number of indels that are not within a 
    homopolymer. Large numbers of homopolymer indels may indicate a problem in a sequencing process. 
    An indel is considered homopolymeric if it is found within a homopolymer (defined as at least 5 equal consecutive bases). 
    Owing to the fact that Qualimap works directly from BAM files (and not from reference genomes), we make use of the CIGAR code from the corresponding read for this task. 
    Indel statistics cam be found in a dedicated section of the Summary report.

    This chart is not shown if the sample doesn’t contain any indels.

*Mapping Quality Across Reference*

    This plot provides the mapping quality distribution across the reference. To construct the plot mean mapping quality is computed for each window.

*Mapping Quality Histogram*

    Histogram of the number of genomic locations having a given mapping quality. To construct the histogram mean mapping quality is computed at each genome position
    with non-zero coverage and collected. According to Specification of the SAM format the range for the mapping quality is [0-255].

*Insert Size Across Reference*

    This plot provides the insert size distribution across the reference. Insert size is collected from the SAM alignment field TLEN. Only positive values are taken into account. 
    To construct the plot mean insert size is computed for each window.

*Insert Size Histogram*

    Histogram of insert size distribution. To construct the histogram all collected insert size values are applied.
    ]]>    </help>
    <citations>
        <citation type="bibtex">
@misc{renameTODO,
  author = {LastTODO, FirstTODO},
  year = {TODO},
  title = {TODO},
  url = {https://bitbucket.org/kokonech/qualimap/src/master/},
}</citation>
    </citations>
</tool>
