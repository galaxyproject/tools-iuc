<macros>
    <token name="@TOOL_VERSION@">3.3.8</token>
    <token name="@VERSION_SUFFIX@">0</token>
    <token name="@PROFILE@">23.0</token>
    
    <token name="@PREPARE_ENV@"><![CDATA[
        export MFA_TEMP_DIR="\$_GALAXY_JOB_TMP_DIR" &&
    ]]></token>

    <token name="@PREPARE_CORPUS@"><![CDATA[
        mkdir -p corpus_dir &&
        #if $corpus_source.ext == 'mfa_corpus_model.zip':
            unzip -q '$corpus_source' -d corpus_dir &&
        #else:
            tar -xf '$corpus_source' -C corpus_dir &&
        #end if
    ]]></token>

    <token name="@PREPARE_DICTIONARY@"><![CDATA[
        #if $dictionary_type.source == 'history':
            ln -s '$dictionary_type.dictionary_file' input_dictionary.txt &&
            #set $dict_arg = 'input_dictionary.txt'
        #else:
            #set $dict_arg = $dictionary_type.builtin_dictionary.fields.path
        #end if
    ]]></token>

    <token name="@PREPARE_ACOUSTIC@"><![CDATA[
        #if $acoustic_type.source == 'history':
            cp '$acoustic_type.acoustic_file' input_acoustic.zip &&
            #set $ac_arg = 'input_acoustic.zip'
        #else:
            #set $ac_arg = $acoustic_type.builtin_acoustic.fields.path
        #end if
    ]]></token>

    <token name="@PREPARE_G2P@"><![CDATA[
        #if $g2p_model_type.source == 'history':
            cp '$g2p_model_type.g2p_file' input_g2p.zip &&
            #set $g2p_arg = 'input_g2p.zip'
        #else:
            #set $g2p_arg = $g2p_model_type.builtin_g2p.fields.path
        #end if
    ]]></token>

    <token name="@PREPARE_LM@"><![CDATA[
        #if $language_model_type.source == 'history':
            cp '$language_model_type.lm_file' input_lm.zip &&
            #set $lm_arg = 'input_lm.zip'
        #else:
            #set $lm_arg = $language_model_type.builtin_lm.fields.path
        #end if
    ]]></token>

    <token name="@ZIP_OUTPUT@"><![CDATA[
        &&
        cd output_dir &&
        zip -r -q output.zip . &&
        mv output.zip '$output_archive'
    ]]></token>

    <xml name="input_corpus">
        <param name="corpus_source" type="data" format="mfa_corpus_model.zip,mfa_corpus_tar" label="Corpus Archive" help="Archive containing audio and transcripts." />
    </xml>

    <xml name="input_dictionary">
        <conditional name="dictionary_type">
            <param name="source" type="select" label="Dictionary Source">
                <option value="builtin" selected="true">Use a built-in MFA Dictionary</option>
                <option value="history">Upload from History</option>
            </param>
            <when value="builtin">
                <param name="builtin_dictionary" type="select" label="Select Dictionary">
                    <options from_data_table="mfa_dictionary">
                        <column name="value" index="0"/>
                        <column name="dbkey" index="1"/>
                        <column name="name" index="2"/>
                        <column name="path" index="3"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param name="dictionary_file" type="data" format="mfa_dictionary.dict" label="Dictionary File" />
            </when>
        </conditional>
    </xml>

    <xml name="input_acoustic">
        <conditional name="acoustic_type">
            <param name="source" type="select" label="Acoustic Model Source">
                <option value="builtin" selected="true">Use a built-in MFA Model</option>
                <option value="history">Upload from History</option>
            </param>
            <when value="builtin">
                <param name="builtin_acoustic" type="select" label="Select Acoustic Model">
                    <options from_data_table="mfa_acoustic">
                        <column name="value" index="0"/>
                        <column name="dbkey" index="1"/>
                        <column name="name" index="2"/>
                        <column name="path" index="3"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param name="acoustic_file" type="data" format="mfa_acoustic_model.zip" label="Acoustic Model File" />
            </when>
        </conditional>
    </xml>

    <xml name="input_g2p">
        <conditional name="g2p_model_type">
            <param name="source" type="select" label="G2P Model Source">
                <option value="builtin" selected="true">Use a built-in MFA Model</option>
                <option value="history">Upload from History</option>
            </param>
            <when value="builtin">
                <param name="builtin_g2p" type="select" label="Select G2P Model">
                    <options from_data_table="mfa_g2p">
                        <column name="value" index="0"/>
                        <column name="dbkey" index="1"/>
                        <column name="name" index="2"/>
                        <column name="path" index="3"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param name="g2p_file" type="data" format="mfa_g2p_model.zip" label="G2P Model File" />
            </when>
        </conditional>
    </xml>

    <xml name="input_lm">
        <conditional name="language_model_type">
            <param name="source" type="select" label="Language Model Source">
                <option value="builtin" selected="true">Use a built-in MFA Model</option>
                <option value="history">Upload from History</option>
            </param>
            <when value="builtin">
                <param name="builtin_lm" type="select" label="Select Language Model">
                    <options from_data_table="mfa_language_model">
                        <column name="value" index="0"/>
                        <column name="dbkey" index="1"/>
                        <column name="name" index="2"/>
                        <column name="path" index="3"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param name="lm_file" type="data" format="mfa_language_model.zip" label="Language Model File" />
            </when>
        </conditional>
    </xml>

    <xml name="common_inputs">
        <param name="speaker_characters" type="integer" value="0" min="0" label="Speaker Characters" help="Number of characters at the start of filenames to use as speaker ID (0 = use directory structure)." />
    </xml>

    <xml name="requirements">
        <requirements>
            <requirement type="package" version="@TOOL_VERSION@">montreal-forced-aligner</requirement>
            <requirement type="package" version="3.13">python</requirement>
            <requirement type="package" version="3.0">zip</requirement>
        </requirements>
    </xml>
    <xml name="version_command">
        <version_command>mfa version</version_command>
    </xml>
    <xml name="citations">
        <citations>
            <citation type="doi">10.21437/Interspeech.2017-1386</citation>
        </citations>
    </xml>
    <xml name="creators">
        <creator>
            <person givenName="Armin" familyName="Dadras" url="https://github.com/dadrasarmin" />
        </creator>
    </xml>
</macros>
