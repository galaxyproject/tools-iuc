<tool id="mfa_adapt" name="MFA Adapt" version="@TOOL_VERSION@+@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>adapt a pretrained acoustic model to a new dataset</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        @PREPARE_ENV@
        @PREPARE_CORPUS@
        @PREPARE_DICTIONARY@
        @PREPARE_ACOUSTIC@

        ## 4. Run Adaptation
        ## Syntax: mfa adapt [OPTIONS] CORPUS_DIRECTORY DICTIONARY_PATH ACOUSTIC_MODEL_PATH OUTPUT_MODEL_PATH
        mfa adapt
            corpus_dir
            $dict_arg
            $ac_arg
            '$output_model'
            --job_name 'mfa_adapt_job'
            #if $speaker_characters:
                --speaker_characters '$speaker_characters'
            #end if
    ]]></command>

    <inputs>
        <expand macro="input_corpus" />
        <expand macro="input_dictionary" />
        <expand macro="input_acoustic" />
        <expand macro="common_inputs" />
    </inputs>

    <outputs>
        <data name="output_model" format="mfa_acoustic_model.zip" label="${tool.name} on ${on_string}: Adapted Acoustic Model" />
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <param name="corpus_source" value="test_corpus.zip" ftype="mfa_corpus_model.zip" />
            
            <conditional name="dictionary_type">
                <param name="source" value="history" />
                <param name="dictionary_file" location="https://github.com/MontrealCorpusTools/mfa-models/releases/download/dictionary-english_us_arpa-v3.0.0/english_us_arpa.dict" ftype="mfa_dictionary.dict" />
            </conditional>
            
            <conditional name="acoustic_type">
                <param name="source" value="history" />
                <param name="acoustic_file" location="https://github.com/MontrealCorpusTools/mfa-models/releases/download/acoustic-english_us_arpa-v3.0.0/english_us_arpa.zip" ftype="mfa_acoustic_model.zip" />
            </conditional>
            
            <output name="output_model">
                <assert_contents>
                    <has_size value="500" delta="500" />
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**Montreal Forced Aligner: Adapt**

This tool fine-tunes a pre-trained acoustic model using a specific dataset. 

**Why use this?**

Standard models (like "English US") are trained on generic data (e.g., LibriSpeech). If your audio contains:

* Strong accents
* Children's speech
* Noisy environments
* Elderly speech

Running `Adapt` will create a **new** acoustic model specifically tailored to your data. You can then use this new model in the **MFA Align** tool (by selecting "Upload from History").

**Inputs**

1.  **Corpus:** Zip/Tar archive of Audio + Transcripts.
2.  **Dictionary:** Standard pronunciation dictionary.
3.  **Acoustic Model:** The "Starting point" model you want to improve.

**Outputs**

* **Adapted Acoustic Model:** A `.zip` file containing the new model.

    ]]></help>
    <expand macro="creators" />
    <expand macro="citations" />
</tool>