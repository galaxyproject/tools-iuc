<tool id="mfa_remap_alignments" name="MFA Remap Alignments" version="@TOOL_VERSION@+@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>convert TextGrid transcriptions to a new phone set</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        @PREPARE_ENV@
        @PREPARE_CORPUS@
        @PREPARE_DICTIONARY@

        ## 3. Prepare Mapping File
        ln -s '$mapping_file' mapping_rules.yaml &&

        ## 4. Run Remap
        ## Syntax: mfa remap alignments [OPTIONS] CORPUS_DIRECTORY MAPPING_PATH OUTPUT_DIRECTORY
        mfa remap alignments
            corpus_dir
            mapping_rules.yaml
            output_dir
            --dictionary_path $dict_arg
            --job_name 'mfa_remap_align_job'

        @ZIP_OUTPUT@
    ]]></command>

    <inputs>
        <expand macro="input_corpus" />
        <expand macro="input_dictionary" />
        <param name="mapping_file" type="data" format="yaml,json,txt" label="Mapping File" help="A file defining how to map old phones to new phones (e.g., Arpabet to IPA)." />
    </inputs>

    <outputs>
        <data name="output_archive" format="zip" label="${tool.name} on ${on_string}: Remapped TextGrids" />
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <param name="corpus_source" value="test_corpus_aligned.zip" ftype="zip" />
            <conditional name="dictionary_type">
                <param name="source" value="history" />
                <param name="dictionary_file" value="test_dict.txt" ftype="txt" />
            </conditional>
            <param name="mapping_file" value="arpabet_to_ipa.yaml" ftype="yaml" />
            <output name="output_archive">
                <assert_contents>
                    <has_size value="700" delta="400" />
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**Montreal Forced Aligner: Remap Alignments**

This tool updates the phone labels in your TextGrid files based on a mapping configuration.

**Use Case**

You have aligned a corpus using a standard dictionary (e.g., Arpabet), but you want the final TextGrids to use a different notation (e.g., IPA) without re-running the computationally expensive alignment process.

**Inputs**

1. **Corpus:** Zip archive containing audio and TextGrids.
2. **Dictionary:** The dictionary matching the *current* TextGrids.
3. **Mapping File:** A YAML/JSON file (e.g., `AA: É‘`).

Refer to the documentation at the Montreal Forced Aligner site for an example of valid remap alignment input: https://montreal-forced-aligner.readthedocs.io/en/latest/user_guide/workflows/remap.html#remap-alignments.

    ]]></help>
    <expand macro="creators" />
    <expand macro="citations" />
</tool>