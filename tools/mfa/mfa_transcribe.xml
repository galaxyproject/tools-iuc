<tool id="mfa_transcribe" name="MFA Transcribe" version="@TOOL_VERSION@+@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>transcribe audio using an acoustic and language model</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        @PREPARE_ENV@
        @PREPARE_CORPUS@
        @PREPARE_DICTIONARY@
        @PREPARE_ACOUSTIC@
        @PREPARE_LM@

        ## 5. Prepare Config (Optional)
        #if $config_file:
            ln -s '$config_file' config.yaml &&
        #end if

        ## 6. Run Transcription
        ## Syntax: mfa transcribe [OPTIONS] CORPUS_DIRECTORY DICTIONARY_PATH ACOUSTIC_MODEL_PATH LANGUAGE_MODEL_PATH OUTPUT_DIRECTORY
        mfa transcribe
            corpus_dir
            $dict_arg
            $ac_arg
            $lm_arg
            output_dir
            --job_name 'mfa_transcribe_job'
            #if $config_file:
                --config_path config.yaml
            #end if
            #if $speaker_characters:
                --speaker_characters '$speaker_characters'
            #end if

        @ZIP_OUTPUT@
    ]]></command>

    <inputs>
        <expand macro="input_corpus" />
        <expand macro="input_dictionary" />
        <expand macro="input_acoustic" />
        <expand macro="input_lm" />

        <param name="config_file" type="data" format="yaml" optional="true" label="Configuration File" help="Optional. Customize transcription parameters (e.g., beam width, lattice options)." />
        
        <expand macro="common_inputs" />
    </inputs>

    <outputs>
        <data name="output_archive" format="zip" label="${tool.name} on ${on_string}: Transcriptions" />
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <param name="corpus_source" value="test_corpus_audio.zip" ftype="zip" />
            
            <conditional name="dictionary_type">
                <param name="source" value="history" />
                <param name="dictionary_file" location="https://github.com/MontrealCorpusTools/mfa-models/releases/download/dictionary-english_mfa-v3.0.0/english_mfa.dict" ftype="txt" />
            </conditional>
            
            <conditional name="acoustic_type">
                <param name="source" value="history" />
                <param name="acoustic_file" location="https://github.com/MontrealCorpusTools/mfa-models/releases/download/acoustic-english_mfa-v3.1.0/english_mfa.zip" ftype="zip" />
            </conditional>
            
            <conditional name="language_model_type">
                <param name="source" value="history" />
                <param name="lm_file" location="https://github.com/MontrealCorpusTools/mfa-models/releases/download/language_model-english_mfa_lm-v2.0.0a/english_mfa_lm.zip" ftype="zip" />
            </conditional>
            
            <output name="output_archive">
                <assert_contents>
                    <has_size value="3800" delta="800" />
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**Montreal Forced Aligner: Transcribe**

This tool performs **Automatic Speech Recognition (ASR)** to convert audio into text.

**How it works**

It combines three components to guess what is being said:

1.  **Acoustic Model:** Recognizes the sounds (phonemes).
2.  **Dictionary:** Maps phonemes to words.
3.  **Language Model:** Guesses the most likely sequence of words (grammar/context).

**Inputs**

* **Corpus:** Audio files (wav).
* **Models:** You must select matching models for the language (e.g., English Acoustic + English Dictionary + English LM).

**Output**

* A Zip archive containing the resulting TextGrids or text files with the transcription.

    ]]></help>
    <expand macro="creators" />
    <expand macro="citations" />
</tool>