<tool id="mfa_transcribe" name="MFA Transcribe" version="@TOOL_VERSION@+@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>transcribe audio using an acoustic and language model</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        @PREPARE_ENV@

        ## 1. Prepare Corpus
        mkdir -p corpus_dir &&
        #if $corpus_source.ext == 'zip':
            unzip -q '$corpus_source' -d corpus_dir &&
        #else:
            tar -xf '$corpus_source' -C corpus_dir &&
        #end if

        ## 2. Prepare Dictionary
        #if $dictionary_type.source == 'history':
            ln -s '$dictionary_type.dictionary_file' input_dictionary.txt &&
            #set $dict_arg = 'input_dictionary.txt'
        #else:
            #set $dict_arg = $dictionary_type.builtin_dictionary.fields.path
        #end if

        ## 3. Prepare Acoustic Model
        #if $acoustic_type.source == 'history':
            ln -s '$acoustic_type.acoustic_file' input_acoustic.zip &&
            #set $ac_arg = 'input_acoustic.zip'
        #else:
            #set $ac_arg = $acoustic_type.builtin_acoustic.fields.path
        #end if

        ## 4. Prepare Language Model
        #if $language_model_type.source == 'history':
            ln -s '$language_model_type.lm_file' input_lm.zip &&
            #set $lm_arg = 'input_lm.zip'
        #else:
            #set $lm_arg = $language_model_type.builtin_lm.fields.path
        #end if

        ## 5. Prepare Config (Optional)
        #if $config_file:
            ln -s '$config_file' config.yaml &&
        #end if

        ## 6. Run Transcription
        ## Syntax: mfa transcribe [OPTIONS] CORPUS_DIRECTORY DICTIONARY_PATH ACOUSTIC_MODEL_PATH LANGUAGE_MODEL_PATH OUTPUT_DIRECTORY
        mfa transcribe
            corpus_dir
            $dict_arg
            $ac_arg
            $lm_arg
            output_dir
            --job_name 'mfa_transcribe_job'
            #if $config_file:
                --config_path config.yaml
            #end if
            #if $evaluate:
                --evaluate
            #end if
            #if $speaker_characters:
                --speaker_characters '$speaker_characters'
            #end if

        ## 7. Package Output
        &&
        cd output_dir &&
        zip -r -q output.zip . &&
        mv output.zip '$output_archive'
    ]]></command>

    <inputs>
        <param name="corpus_source" type="data" format="zip,tar,tar.gz" label="Corpus Archive" help="Archive containing audio files (wav) to transcribe." />

        <conditional name="dictionary_type">
            <param name="source" type="select" label="Dictionary Source">
                <option value="builtin" selected="true">Use a built-in MFA Dictionary</option>
                <option value="history">Upload from History</option>
            </param>
            <when value="builtin">
                <param name="builtin_dictionary" type="select" label="Select Dictionary">
                    <options from_data_table="mfa_dictionary">
                        <column name="value" index="0"/>
                        <column name="dbkey" index="1"/>
                        <column name="name" index="2"/>
                        <column name="path" index="3"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param name="dictionary_file" type="data" format="txt" label="Dictionary File" />
            </when>
        </conditional>

        <conditional name="acoustic_type">
            <param name="source" type="select" label="Acoustic Model Source">
                <option value="builtin" selected="true">Use a built-in MFA Model</option>
                <option value="history">Upload from History</option>
            </param>
            <when value="builtin">
                <param name="builtin_acoustic" type="select" label="Select Acoustic Model to Adapt">
                    <options from_data_table="mfa_acoustic">
                        <column name="value" index="0"/>
                        <column name="dbkey" index="1"/>
                        <column name="name" index="2"/>
                        <column name="path" index="3"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param name="acoustic_file" type="data" format="zip" label="Acoustic Model File" />
            </when>
        </conditional>

        <conditional name="language_model_type">
            <param name="source" type="select" label="Language Model Source">
                <option value="builtin" selected="true">Use a built-in MFA Model</option>
                <option value="history">Upload from History</option>
            </param>
            <when value="builtin">
                <param name="builtin_lm" type="select" label="Select Language Model">
                    <options from_data_table="mfa_language_model">
                        <column name="value" index="0"/>
                        <column name="dbkey" index="1"/>
                        <column name="name" index="2"/>
                        <column name="path" index="3"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param name="lm_file" type="data" format="zip" label="Language Model File" />
            </when>
        </conditional>

        <param name="evaluate" type="boolean" truevalue="--evaluate" falsevalue="" checked="false" label="Evaluate" help="If your corpus already contains reference text files, checking this will calculate Word Error Rate (WER)." />
        <param name="speaker_characters" type="integer" value="0" min="0" label="Speaker Characters" help="Number of characters at the start of filenames to use as speaker ID." />
        <param name="config_file" type="data" format="yaml" optional="true" label="Configuration File" help="Optional. Customize decoding parameters (beam width, lattice beam, etc.)." />

    </inputs>

    <outputs>
        <data name="output_archive" format="zip" label="${tool.name} on ${on_string}: Transcriptions" />
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <param name="corpus_source" value="test_corpus_audio.zip" ftype="zip" />
            <conditional name="dictionary_type">
                <param name="source" value="builtin" />
                <param name="builtin_dictionary" value="english_mfa" />
            </conditional>
            <conditional name="acoustic_type">
                <param name="source" value="builtin" />
                <param name="builtin_acoustic" value="english_mfa" />
            </conditional>
            <conditional name="language_model_type">
                <param name="source" value="builtin" />
                <param name="builtin_lm" value="english_mfa_lm" />
            </conditional>
            <output name="output_archive" file="transcriptions.zip" compare="sim_size" delta="5000" />
        </test>
    </tests>

    <help><![CDATA[
**Montreal Forced Aligner: Transcribe**

This tool performs **Automatic Speech Recognition (ASR)** to convert audio into text.

**How it works**

It combines three components to guess what is being said:

1.  **Acoustic Model:** Recognizes the sounds (phonemes).
2.  **Dictionary:** Maps phonemes to words.
3.  **Language Model:** Guesses the most likely sequence of words (grammar/context).

**Inputs**

* **Corpus:** Audio files (wav).
* **Models:** You must select matching models for the language (e.g., English Acoustic + English Dictionary + English LM).

**Output**

* A Zip archive containing the resulting TextGrids or text files with the transcription.

    ]]></help>
    <expand macro="creators" />
    <expand macro="citations" />
</tool>