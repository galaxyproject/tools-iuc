<tool id="mfa_g2p" name="MFA G2P" version="@TOOL_VERSION@+@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>generate a pronunciation dictionary from a word list or corpus</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        @PREPARE_ENV@

        ## 1. Prepare Input (Word List or Corpus)
        ## This logic is specific to this tool, so we keep it here instead of a macro.
        #if $input_type.source_type == 'corpus':
            mkdir -p input_dir &&
            #if $input_type.corpus_source.ext == 'zip':
                unzip -q '$input_type.corpus_source' -d input_dir &&
            #else:
                tar -xf '$input_type.corpus_source' -C input_dir &&
            #end if
            #set $input_arg = 'input_dir'
        #else:
            ln -s '$input_type.word_list' input_words.txt &&
            #set $input_arg = 'input_words.txt'
        #end if

        @PREPARE_G2P@

        ## 3. Run G2P
        ## Syntax: mfa g2p [OPTIONS] INPUT_PATH G2P_MODEL_PATH OUTPUT_PATH
        mfa g2p
            $input_arg
            $g2p_arg
            '$output_dictionary'
            --job_name 'mfa_g2p_job'
            --num_pronunciations $num_pronunciations
            #if $include_bracketed:
                --include_bracketed
            #end if

    ]]></command>

    <inputs>
        <conditional name="input_type">
            <param name="source_type" type="select" label="Input Mode" help="You can generate pronunciations for a simple list of words (e.g., from 'Find OOVs') or for every word in a full corpus.">
                <option value="word_list" selected="true">Word List (Text File)</option>
                <option value="corpus">Corpus Archive (Zip/Tar)</option>
            </param>
            <when value="word_list">
                <param name="word_list" type="data" format="txt,tabular" label="Word List" help="A text file with one word per line (e.g., the 'oovs_found.txt' from MFA Find OOVs)." />
            </when>
            <when value="corpus">
                <param name="corpus_source" type="data" format="zip,tar,tar.gz" label="Corpus Archive" />
            </when>
        </conditional>

        <expand macro="input_g2p" />

        <param name="num_pronunciations" type="integer" value="1" min="1" max="10" label="Number of Pronunciations" help="How many variants to generate per word (e.g., 2 might generate 'tomato' as both /t ə m eɪ t oʊ/ and /t ə m ɑ t oʊ/)." />
        
        <param name="include_bracketed" type="boolean" truevalue="--include_bracketed" falsevalue="" checked="false" label="Include Bracketed Words" help="If checked, generate pronunciations for words like [applause] or {cough}. Usually, you want to keep this unchecked." />

    </inputs>

    <outputs>
        <data name="output_dictionary" format="txt" label="${tool.name} on ${on_string}: Generated Dictionary" />
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <conditional name="input_type">
                <param name="source_type" value="word_list" />
                <param name="word_list" value="test_words.txt" ftype="txt" />
            </conditional>
            <conditional name="g2p_model_type">
                <param name="source" value="history" />
                <param name="g2p_file" location="https://github.com/MontrealCorpusTools/mfa-models/releases/download/g2p-english_us_arpa-v2.0.0a/english_us_arpa.zip" ftype="zip" />
            </conditional>
            <output name="output_dictionary">
                <assert_contents>
                    <has_text text="test" />
                    <has_text_matching expression="test\s+[A-Z]+" /> 
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**Montreal Forced Aligner: G2P (Generate to Phonemes)**

This tool uses a machine learning model to guess the pronunciation of words.

**Common Use Case**

1. Run **MFA Find OOVs** to get a list of missing words (`oovs_found.txt`).
2. Feed that text file into this tool (**MFA G2P**).
3. Select a language model (e.g., `English US ARPA`).
4. Result: A **Dictionary** file containing your missing words and their generated phonemes.
5. Merge this with your original dictionary (using standard Galaxy text tools like 'Concatenate') to fix your alignment errors.

**Input**

* **Word List:** A simple text file with one word per line.
* **Corpus:** Alternatively, you can feed in a whole Zip archive, and it will generate a dictionary for *every* word found in the audio transcripts.

**Output**

* A Dictionary file (Text format: `Word  PH ON E M ES`).

    ]]></help>
    <expand macro="creators" />
    <expand macro="citations" />
</tool>