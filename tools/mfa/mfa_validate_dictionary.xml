<tool id="mfa_validate_dictionary" name="MFA Validate Dictionary" version="@TOOL_VERSION@+@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>check a pronunciation dictionary for formatting errors</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        @PREPARE_ENV@

        ## 1. Prepare Dictionary
        #if $dictionary_type.source == 'history':
            ln -s '$dictionary_type.dictionary_file' input_dictionary.txt &&
            #set $dict_arg = 'input_dictionary.txt'
        #else:
            #set $dict_arg = $dictionary_type.builtin_dictionary.fields.path
        #end if

        ## 2. Run Validation
        ## Syntax: mfa validate_dictionary [OPTIONS] DICTIONARY_PATH
        ## We capture both stdout and stderr to the output file so the user sees the report.
        mfa validate_dictionary
            $dict_arg
            --job_name 'mfa_validate_dict_job'
            --clean
            --num_jobs "\${GALAXY_SLOTS:-4}"
            > '$output_log' 2>&1

    ]]></command>

    <inputs>
        <conditional name="dictionary_type">
            <param name="source" type="select" label="Input Dictionary" help="The dictionary to validate.">
                <option value="history" selected="true">Upload from History</option>
                <option value="builtin">Use a built-in MFA Dictionary</option>
            </param>
            <when value="history">
                <param name="dictionary_file" type="data" format="txt" label="Dictionary File" />
            </when>
            <when value="builtin">
                <param name="builtin_dictionary" type="select" label="Select Dictionary">
                    <options from_data_table="mfa_dictionary">
                        <column name="value" index="0"/>
                        <column name="dbkey" index="1"/>
                        <column name="name" index="2"/>
                        <column name="path" index="3"/>
                    </options>
                </param>
            </when>
        </conditional>

    </inputs>

    <outputs>
        <data name="output_log" format="txt" label="${tool.name} on ${on_string}: Validation Report" />
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <conditional name="dictionary_type">
                <param name="source" value="history" />
                <param name="dictionary_file" value="test_dict.txt" />
            </conditional>
            <output name="output_log">
                <assert_contents>
                    <has_text text="INFO" />
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**Montreal Forced Aligner: Validate Dictionary**

This tool checks a dictionary file for common errors.

**What it checks:**

* **Formatting:** Ensures the file follows the standard `WORD  PHONE PHONE` format.
* **Duplicates:** Checks for identical entries.
* **Consistency:** Verifies that the phone set is consistent.

**Output**

* A text report containing the validation logs. If the dictionary is valid, it will confirm this; if not, it will list the specific lines causing errors.

    ]]></help>
    <expand macro="creators" />
    <expand macro="citations" />
</tool>