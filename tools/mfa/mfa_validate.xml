<tool id="mfa_validate" name="MFA Validate" version="@TOOL_VERSION@+@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>validate a corpus and dictionary for alignment</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        @PREPARE_ENV@

        ## 1. Prepare Corpus
        mkdir -p corpus_dir &&
        #if $corpus_source.ext == 'zip':
            unzip -q '$corpus_source' -d corpus_dir &&
        #else:
            tar -xf '$corpus_source' -C corpus_dir &&
        #end if

        ## 2. Prepare Dictionary
        #if $dictionary_type.source == 'history':
            ln -s '$dictionary_type.dictionary_file' input_dictionary.txt &&
            #set $dict_arg = 'input_dictionary.txt'
        #else:
            #set $dict_arg = $dictionary_type.builtin_dictionary.fields.path
        #end if

        ## 3. Prepare Acoustic Model (Optional)
        #set $ac_arg = ''
        #if $acoustic_type.use_acoustic == 'yes':
            #if $acoustic_type.acoustic_source.source == 'history':
                ln -s '$acoustic_type.acoustic_source.acoustic_file' input_acoustic.zip &&
                #set $ac_arg = 'input_acoustic.zip'
            #else:
                #set $ac_arg = $acoustic_type.acoustic_source.builtin_acoustic.fields.path
            #end if
        #end if

        ## 4. Run MFA Validate
        ## FIX: We capture stdout/stderr to '$log' so the user sees the report
        mfa validate
            corpus_dir
            $dict_arg
            $ac_arg
            --job_name 'mfa_validate_job'
            --output_directory '$validation_output_dir.files_path'
            --num_jobs "\${GALAXY_SLOTS:-4}"
            $ignore_acoustics
            #if $test_transcriptions:
                --test_transcriptions
            #end if
            --single_speaker $single_speaker
            > '$log' 2>&1

    ]]></command>

    <inputs>
        <param name="corpus_source" type="data" format="zip,tar,tar.gz" label="Corpus Archive" help="A Zip or Tar archive containing audio and textgrid/lab files sorted by speaker/chapter." />

        <conditional name="dictionary_type">
            <param name="source" type="select" label="Dictionary Source">
                <option value="builtin" selected="true">Use a built-in MFA Dictionary</option>
                <option value="history">Upload a Dictionary from History</option>
            </param>
            <when value="builtin">
                <param name="builtin_dictionary" type="select" label="Select Dictionary">
                    <options from_data_table="mfa_dictionary">
                        <column name="value" index="0"/>
                        <column name="dbkey" index="1"/>
                        <column name="name" index="2"/>
                        <column name="path" index="3"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param name="dictionary_file" type="data" format="txt" label="Dictionary File" />
            </when>
        </conditional>

        <conditional name="acoustic_type">
            <param name="use_acoustic" type="select" label="Validate with Acoustic Model?" help="If yes, MFA will align the data to check for convergence issues.">
                <option value="no" selected="true">No, validate corpus/dictionary only</option>
                <option value="yes">Yes, validate with an Acoustic Model</option>
            </param>
            <when value="no">
            </when>
            <when value="yes">
                <conditional name="acoustic_source">
                    <param name="source" type="select" label="Acoustic Model Source">
                        <option value="builtin" selected="true">Use a built-in MFA Model</option>
                        <option value="history">Upload a Model from History</option>
                    </param>
                    <when value="builtin">
                        <param name="builtin_acoustic" type="select" label="Select Acoustic Model">
                            <options from_data_table="mfa_acoustic">
                                <column name="value" index="0"/>
                                <column name="dbkey" index="1"/>
                                <column name="name" index="2"/>
                                <column name="path" index="3"/>
                            </options>
                        </param>
                    </when>
                    <when value="history">
                        <param name="acoustic_file" type="data" format="zip" label="Acoustic Model File" />
                    </when>
                </conditional>
            </when>
        </conditional>

        <param argument="--ignore_acoustics" type="boolean" truevalue="--ignore_acoustics" falsevalue="" checked="false" label="Ignore Acoustics" help="Skip acoustic feature generation check." />
        <param argument="--test_transcriptions" type="boolean" truevalue="--test_transcriptions" falsevalue="" checked="false" label="Test Transcriptions" help="Run a test transcription." />
        <param argument="--single_speaker" type="boolean" truevalue="--single_speaker" falsevalue="" checked="false" label="Single Speaker" help="Assume single speaker per file if no speaker info is present." />
        
    </inputs>

    <outputs>
        <data name="validation_output_dir" format="directory" label="${tool.name} on ${on_string}: Output Directory" />
        <data name="log" format="txt" label="${tool.name} on ${on_string}: Log" />
    </outputs>

    <tests>
        <test expect_num_outputs="2">
            <param name="corpus_source" value="test_corpus.zip" ftype="zip" />
            <conditional name="dictionary_type">
                <param name="source" value="history" />
                <param name="dictionary_file" value="test_dict.txt" />
            </conditional>
            <output name="log">
                <assert_contents>
                    <has_text text="Setting up corpus information" />
                    <has_text text="Corpus" />
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**Montreal Forced Aligner: Validate**

This tool performs validation on a corpus and a dictionary (and optionally an acoustic model). It checks for:

* Missing words in the dictionary.
* File format issues.
* Transcription consistency.
* OOV (Out of Vocabulary) rates.

**Output**

* **Output Directory:** Contains raw validation data.
* **Log:** The readable validation report confirming if the corpus is valid.

    ]]></help>
    <expand macro="creators" />
    <expand macro="citations" />
</tool>