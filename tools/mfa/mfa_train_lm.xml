<tool id="mfa_train_lm" name="MFA Train LM" version="@TOOL_VERSION@+@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>train a language model (N-gram) from a text corpus</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        @PREPARE_ENV@
        @PREPARE_CORPUS@

        ## 2. Prepare Dictionary (Optional but recommended)
        #if $dictionary_type.use_dictionary == 'yes':
            #if $dictionary_type.dict_source.source == 'history':
                ln -s '$dictionary_type.dict_source.dictionary_file' input_dictionary.txt &&
                #set $dict_arg = 'input_dictionary.txt'
            #else:
                #set $dict_arg = $dictionary_type.dict_source.builtin_dictionary.fields.path
            #end if
        #end if

        ## 3. Prepare Config (Optional)
        #if $config_file:
            ln -s '$config_file' config.yaml &&
        #end if

        ## 4. Run Training
        ## Syntax: mfa train_lm [OPTIONS] SOURCE_DIRECTORY OUTPUT_MODEL_PATH
        mfa train_lm
            corpus_dir
            '$output_model'
            --job_name 'mfa_train_lm_job'
            #if $config_file:
                --config_path config.yaml
            #end if
            #if $dictionary_type.use_dictionary == 'yes':
                --dictionary_path $dict_arg
            #end if
            --order $order

    ]]></command>

    <inputs>
        <expand macro="input_corpus" />

        <conditional name="dictionary_type">
            <param name="use_dictionary" type="select" label="Use a Dictionary?" help="If provided, the LM will be restricted to words found in this dictionary.">
                <option value="yes" selected="true">Yes, filter with dictionary</option>
                <option value="no">No, learn from text only</option>
            </param>
            <when value="yes">
                <conditional name="dict_source">
                    <param name="source" type="select" label="Dictionary Source">
                        <option value="builtin" selected="true">Use a built-in MFA Dictionary</option>
                        <option value="history">Upload from History</option>
                    </param>
                    <when value="builtin">
                        <param name="builtin_dictionary" type="select" label="Select Dictionary">
                            <options from_data_table="mfa_dictionary">
                                <column name="value" index="0"/>
                                <column name="dbkey" index="1"/>
                                <column name="name" index="2"/>
                                <column name="path" index="3"/>
                            </options>
                        </param>
                    </when>
                    <when value="history">
                        <param name="dictionary_file" type="data" format="txt" label="Dictionary File" />
                    </when>
                </conditional>
            </when>
            <when value="no"/>
        </conditional>

        <param name="order" type="integer" value="3" min="1" max="5" label="N-gram Order" help="The 'N' in N-gram. 3 (Trigram) is standard. Higher numbers require larger text corpora." />
        
        <param name="config_file" type="data" format="yaml" optional="true" label="Configuration File" help="Optional. Customize pruning parameters and methods." />

    </inputs>

    <outputs>
        <data name="output_model" format="zip" label="${tool.name} on ${on_string}: Language Model" />
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <param name="corpus_source" value="test_corpus.zip" ftype="zip" />
            <conditional name="dictionary_type">
                <param name="use_dictionary" value="yes" />
                <conditional name="dict_source">
                    <param name="source" value="history" />
                    <param name="dictionary_file" value="test_dict.txt" ftype="txt" />
                </conditional>
            </conditional>
            <param name="order" value="2" />
            <output name="output_model">
                <assert_contents>
                    <has_size value="200" delta="200" />
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**Montreal Forced Aligner: Train Language Model**

This tool trains an **N-gram Language Model** from a text corpus.

**Use Case**

This is required if you want to use the **MFA Transcribe** tool. The transcriber needs to know not just what words sound like (Acoustic Model), but which word sequences make grammatical sense (Language Model).

**Inputs**

* **Corpus:** Text files containing sentences in the target language.
* **Dictionary (Recommended):** Limits the LM to known words.
* **Order:** Usually 3 or 4.

**Output**

* A `.zip` file containing the trained Language Model (ARPA format inside).

    ]]></help>
    <expand macro="creators" />
    <expand macro="citations" />
</tool>