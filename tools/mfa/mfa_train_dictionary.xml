<tool id="mfa_train_dictionary" name="MFA Train Dictionary" version="@TOOL_VERSION@+@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>calculate pronunciation probabilities for a dictionary</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        @PREPARE_ENV@
        @PREPARE_CORPUS@
        @PREPARE_DICTIONARY@
        @PREPARE_ACOUSTIC@

        ## 4. Run Train Dictionary
        ## Syntax: mfa train_dictionary [OPTIONS] CORPUS_DIRECTORY DICTIONARY_PATH ACOUSTIC_MODEL_PATH OUTPUT_DIRECTORY
        mfa train_dictionary
            corpus_dir
            $dict_arg
            $ac_arg
            output_dir
            --job_name 'mfa_train_dict_job'
            #if $silence_probabilities:
                --silence_probabilities
            #end if

        ## 5. Move Result
        ## The new dictionary (with probabilities) is saved in the output_dir. 
        ## The filename usually matches the input dictionary name or is standardized.
        ## We look for any file ending in .dict or .txt in the output.
        &&
        find output_dir -name "*.dict" -o -name "*.txt" | head -n 1 | xargs -I {} mv {} '$output_dictionary'

    ]]></command>

    <inputs>
        <expand macro="input_corpus" />
        <expand macro="input_dictionary" />
        <expand macro="input_acoustic" />

        <param name="silence_probabilities" type="boolean" truevalue="--silence_probabilities" falsevalue="" checked="true" label="Calculate Silence Probabilities" help="If checked, MFA will also calculate how likely silence is to occur around specific words." />
    </inputs>

    <outputs>
        <data name="output_dictionary" format="txt" label="${tool.name} on ${on_string}: Probabilistic Dictionary" />
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <param name="corpus_source" value="test_corpus.zip" ftype="zip" />
            <conditional name="dictionary_type">
                <param name="source" value="history" />
                <param name="dictionary_file" location="https://github.com/MontrealCorpusTools/mfa-models/releases/download/dictionary-english_us_arpa-v3.0.0/english_us_arpa.dict" ftype="txt" />
            </conditional>
            <conditional name="acoustic_type">
                <param name="source" value="history" />
                <param name="acoustic_file" location="https://github.com/MontrealCorpusTools/mfa-models/releases/download/acoustic-english_us_arpa-v3.0.0/english_us_arpa.zip" ftype="zip" />
            </conditional>
            <output name="output_dictionary">
                <assert_contents>
                    <has_text_matching expression="\s0\.\d+" />
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**Montreal Forced Aligner: Train Dictionary**

This tool upgrades a standard pronunciation dictionary into a **Probabilistic Dictionary**.

**How it works**

It runs an alignment on your corpus using the provided acoustic model. It then counts how often each pronunciation variant is used. 
For example, if the word "data" appears 100 times:

* 80 times it was pronounced /d ey t ax/
* 20 times it was pronounced /d ae t ax/

The output dictionary will record these probabilities (0.8 and 0.2).

**Benefit**

Using a probabilistic dictionary in **MFA Align** usually results in higher accuracy because the aligner knows which pronunciations are more likely.

**Inputs**

1. **Corpus:** Audio and Transcripts.
2. **Dictionary:** The starting dictionary.
3. **Acoustic Model:** Needed to perform the alignment check.

**Output**

* A new `.dict` or `.txt` file containing the dictionary with probability columns added.

    ]]></help>
    <expand macro="creators" />
    <expand macro="citations" />
</tool>