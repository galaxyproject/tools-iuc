<tool id="minfi_geo" name="Minfi GEO">
    <description>reading Illumina methylation array data from Gene Expression Omnibus</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code">
    <![CDATA[
     Rscript '$minfi_geo_script'
    ]]>
    </command>
    <configfiles>
    <configfile name="minfi_geo_script"><![CDATA[
require("minfi", quietly = TRUE)
require(GEOquery, quietly = TRUE)
require(IlluminaHumanMethylation450kanno.ilmn12.hg19, quietly = TRUE)

options(warn = -1)
gset <- getGEO('$input1')

 if(length(gset)==0) stop("Empty list retrieved from GEO.")
    if(length(gset)>1){
        warning("More than one ExpressionSet found:\n",names(gset),"\nUsing entry ",'$input2')
        gset <- gset[['$input2']]
    } else gset <- gset[[1]]

platform <- annotation(gset)

gr <-  getLocations(IlluminaHumanMethylation450kanno.ilmn12.hg19,orderByLocation = TRUE)

locusNames <- names(gr)

sampleNames(gset) <- gset\$title

common <- intersect(locusNames, featureNames(gset))
if(length(common)==0)
  stop("No rowname matches. 'rownames' need to match IlluminaHumanMethylation450k probe names.")

ind1 <- match(common,fData(gset)\$Name)
ind2 <- match(common,locusNames)

preprocessing <- c(rg.norm=paste0('See GEO ','$input1',' for details'))

what <-'$input3'
if(what=="Beta"){
out <- GenomicRatioSet(gr=gr[ind2,],
                       Beta=gset[ind1,,drop=FALSE],
                       annotation=c(array = "IlluminaHumanMethylation450k"),
                       preprocessMethod=preprocessing)
} else {
  
out <- GenomicRatioSet(gr=gr[ind2,],
                         M=mat[ind1,,drop=FALSE],
                       annotation=c(array = "IlluminaHumanMethylation450k"),
                       preprocessMethod=preprocessing)
}
save(out, file = '$output1')
     ]]> 
    </configfile>
    </configfiles>  
<inputs>
        <param type="text" name="input1" value="GSE42752" label="Enter GEO accession" />
        <param type="text" name="input2" value="1" label="Number of ExpressionSets" help="applicable if more than one ExpressionSet found"/>
<param name="input3" type="select" label="Select value with associated genomic coordinates" help="This class holds M or Beta values (or both) together with associated genomic coordinates.">
                        <option value="Beta">Beta</option>
                        <option value="M">M</option>
                    </param>
    </inputs>
    <outputs>
        <data name="output1" format="rdata" />
    </outputs>
    <tests>
        <test>
            <param name="input1" value="GSE42752"/>
            <param name="input2" value="1"/>
            <param name="input3" value="Beta"/>
            <output name="output1" file="GRSet.rdata"/>
        </test>
    </tests>
    <help><![CDATA[
        This tool downloads data from GEO using getGEO from the GEOquery package and then returns a GenomicRatioSet object
    ]]></help>
    <expand macro="citations" />
</tool>
