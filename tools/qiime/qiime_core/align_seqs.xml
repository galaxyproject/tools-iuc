<tool id="qiime_align_seqs" name="Align sequences" version="@WRAPPER_VERSION@.0">

    <description>using a variety of alignment methods</description>

    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements">
        <requirement type="package" version="1.1.2">infernal</requirement>
        <requirement type="package" version="2.1">clustalw</requirement>
        <requirement type="package" version="3.8.1551">muscle</requirement>
        <requirement type="package" version="7.305">mafft</requirement>
        <requirement type="package" version="2.6">blast-legacy</requirement>
    </expand>

    <version_command>align_seqs.py --version</version_command>

    <command detect_errors="aggressive"><![CDATA[
        align_seqs.py
            --input_fasta_fp '$input_fasta_fp'
            -o output
            --alignment_method '$alignment.alignment_method'
            #if $alignment.alignment_method == 'pynast':
                --pairwise_alignment_method '$alignment.pairwise_alignment_method'
            #end if
            #if str($template_fp) != 'None':
                --template_fp '$template_fp'
            #end if
            #if $min_length:
                --min_length '$min_length'
            #end if
            --min_percent_id '$min_percent_id'
    ]]></command>

    <inputs>
        <param argument="--input_fasta_fp" type="data" format="fasta" label="Input fasta file"/>

        <conditional name="alignment">
            <param argument="--alignment_method" type="select" label="Method for aligning sequences">
                <option value="pynast" selected="True">pynast</option>
                <option value="infernal">infernal</option>
                <option value="clustalw">clustalw</option>
                <option value="muscle">muscle</option>
                <option value="mafft">mafft</option>
            </param>
            <when value="pynast">
                <param argument="--pairwise_alignment_method" type="select" label="Method for performing pairwise alignment in PyNAST">
                    <option value="muscle">muscle</option>
                    <option value="pair_hmm">pair_hmm</option>
                    <option value="clustal">clustal</option>
                    <option value="blast">blast</option>
                    <option value="uclust" selected="True">uclust</option>
                    <option value="mafft">mafft</option>
                </param>
            </when>
            <when value="infernal"/>
            <when value="clustalw"/>
            <when value="muscle"/>
            <when value="mafft"/>
        </conditional>

        <param argument="--template_fp" type="data" format="fasta" optional="True" label="Fasta file for template alignment"/>

        <param argument="--min_length" type="integer" optional="True" label="Minimum sequence length to include in alignment" help="By default, 75% of the median input sequence length"/>

        <param argument="--min_percent_id" type="float" value="0.75" label="Minimum percent sequence identity to closest blast hit to include sequence in alignment"/>
    </inputs>

    <outputs>
        <data name="aligned_sequences" format="fasta" from_work_dir="output/*_aligned.fasta" label="${tool.name} on ${on_string}: Aligned sequences"/>
        <data name="failures_sequences" format="fasta" from_work_dir="output/*_failures.fasta" label="${tool.name} on ${on_string}: Failure sequences">
            <filter>alignment['alignment_method'] == 'pynast'</filter>
        </data>
        <data name="log" format="txt" from_work_dir="output/*_log.txt" label="${tool.name} on ${on_string}: Log"/>
    </outputs>

    <tests>
        <test><!-- test with defaults -->
            <param name="input_fasta_fp" value="split_fastq_libraries_sequences.fasta"/>
            <output name="aligned_sequences" md5="de0c21613873bb014fe1ad193f942cb7"/>
            <output name="failures_sequences" md5="d41d8cd98f00b204e9800998ecf8427e"/>
            <output name="log" md5="925202a3a5c73f06ccc4a7b24abf8136"/>
        </test>

        <!-- TODO: test with all other alignment methods (dependencies to them need to be added)-->
    </tests>

    <help><![CDATA[
**What it does**

This tool aligns the sequences in a FASTA file to each other or to a template sequence alignment, depending on the method chosen.

More information about this tool is available on
`QIIME documentation <http://qiime.org/scripts/align_seqs.html>`_.
    ]]></help>

    <citations>
        <expand macro="citations"/>
        <citation type="doi">10.1093/bioinformatics/btp636</citation>
        <citation type="doi">10.1093/nar/gkh340</citation>
        <citation type="doi">10.1093/bioinformatics/btp157</citation>
    </citations>
</tool>
