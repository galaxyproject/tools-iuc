<tool id="spades_plasmidspades" name="plasmidSPAdes" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>genome assembler for plasmid data sets</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[ 

@PREPROCESS_INPUT_FILES@
@PREPROCESS_NANOPORE_PACBIO_FILES@
@PREPROCESS_SANGER_FILES@
@PREPROCESS_CONTIGS_FILES@

## run
plasmidspades.py
    $operation_mode
    -o 'output'
    @RESOURCES@
    @INPUT_READS@
    ## reads
    @NANOPORE_PACBIO@
    @SANGER@
    @CONTIGS@
    ## parameter
    --cov-cutoff $cov_cond.cov_cutoff
    @KMER@
    @PIPELINE_OPTIONS@
    @PHREDOFFSET@
## postprocessing
@STATS@
@CORRECTED@
    ]]></command>
    <inputs>
        <expand macro="operation_mode"/>
        <expand macro="input_files" format="fastq, fastq.gz,fastqsanger.gz,fasta,fasta.gz">
            <option value="single" selected="true">Single-end</option>
        </expand>
        <section name="arf" title="Additional read files">
            <expand macro="nanopore_pacbio"/>
            <expand macro="sanger"/>
            <expand macro="contigs"/>
        </section>
        <expand macro="pipeline_options">
            <option value="--careful">Careful: ties to reduce the number of mismatches and short indels. Only recommended for small genomes (--careful)</option>
            <option value="--iontorrent">Iontorrent: although coronaSPAdes supports IonTorrent reads, it was not sufficiently tested on such kind of data (--iontorrent)</option>
        </expand>
        <expand macro="covcutoff"/>
        <expand macro="kmer"/>
        <expand macro="phred"/>
        <expand macro="optional_output"/>
    </inputs>
    <outputs>
        <expand macro="out_ag"/>
        <expand macro="out_ags"/>
        <expand macro="out_cn"/>
        <expand macro="out_cp"/>
        <expand macro="out_cr"/>
        <expand macro="out_cs"/>
        <expand macro="out_l"/>
        <expand macro="out_sc"/>
        <expand macro="out_sp"/>
        <expand macro="out_ss"/>
   </outputs>
    <tests>
        <!--
        used in a test:
            single library: 12, 1, 2
            multiple libraries: s, pe#-12, pe#-1, pe#-2, pe#-<or>
            k, phred-offset, disablerr, iontorrent, careful, only-assembler, only-error-correction

        not used in a test:
            single library: merged, s
            multiple libraries: pe#-m, pe#-s, mp#-12, mp#-1, mp#-2, mp#-<or>, mp#-s, hqmp#-12, hqmp#-1, hqmp#-2, hqmp#-s, hqmp#-<or>, nxmate#-1, nxmate-#2
            pacbio, nanopore, sanger, trusted-contigs, untrusted-contigs, tslr
        -->

        <!-- #1 single, separate, fastq.gz, default parameters -->
         <test expect_num_outputs="4">
            <repeat name="file_rep">
                <conditional name="readtype_cond">
                    <param name="readtype_sel" value="pe"/>
                    <conditional name="filetype_cond">
                        <param name="filetype_sel" value="separate"/>
                        <param name="fwd_reads" value="pl1.fq.gz"/>
                        <param name="rev_reads" value="pl2.fq.gz"/>
                    </conditional>
                </conditional>
            </repeat>
            <output name="out_ag">
                <assert_contents>
                    <has_n_lines n="326"/>
                    <has_text_matching expression=">EDGE_22_length_9689_cov_4.668331:EDGE_22_length_9689_cov_4.668331"/>
                </assert_contents>
            </output>
            <output name="out_ags">
                <assert_contents>
                    <has_n_lines n="3"/>
                    <has_text_matching expression="S.+"/>
                </assert_contents>
            </output>
            <output name="out_cn">
                <assert_contents>
                    <has_n_lines n="163"/>
                    <has_text_matching expression=">NODE\_1\_length\_9689\_cov\_.+"/>
                </assert_contents>
            </output>
            <output name="out_sc">
                <assert_contents>
                    <has_n_lines n="163"/>
                    <has_text_matching expression=">NODE\_1\_length\_9689.+"/>
                </assert_contents>
            </output>
        </test>
        <!-- #2 single, separate, fastq, all outputs and custom parameters -->
        <test expect_num_outputs="10">
            <repeat name="file_rep">
                <conditional name="readtype_cond">  
                    <param name="readtype_sel" value="pe"/>
                    <conditional name="filetype_cond">
                        <param name="filetype_sel" value="separate"/>
                        <param name="fwd_reads" value="pl1.fq.gz"/>
                        <param name="rev_reads" value="pl2.fq.gz"/>
                    </conditional>
                </conditional>
            </repeat>
            <conditional name="cov_cond">
                <param name="cov_sel" value="auto"/>
            </conditional>
            <param name="phred_offset" value="33"/>
            <param name="optional_output" value="ag,ags,cn,cp,cr,cs,l,sc,sp,ss"/>
            <output name="out_ag">
                <assert_contents>
                    <has_n_lines n="326"/>
                    <has_text_matching expression=">EDGE_.+"/>
                </assert_contents>
            </output>
            <output name="out_ags">
                <assert_contents>
                    <has_n_lines n="3"/>
                    <has_text_matching expression="S.+"/>
                </assert_contents>
            </output>
            <output name="out_cn">
                <assert_contents>
                    <has_n_lines n="163"/>
                    <has_text_matching expression=">NODE.+"/>
                </assert_contents>
            </output>
            <output name="out_cp">
                <assert_contents>
                    <has_n_lines n="4"/>
                </assert_contents>
            </output>
            <output name="out_cs">
                <assert_contents>
                    <has_n_lines n="2"/>
                    <has_text_matching expression="#name&#009;length&#009;coverage"/>
                    <has_text_matching expression="NODE_.+"/>
                </assert_contents>
            </output>
            <output_collection name="out_cr" type="list" count="3">
                <element name="pe1-1-1.fastq.00.0_0.cor">
                    <assert_contents>
                        <has_size value="72173" delta="1000"/>
                    </assert_contents>
                </element>
                <element name="pe1-2-1.fastq.00.0_0.cor">
                    <assert_contents>
                        <has_size value="72173" delta="1000"/>
                    </assert_contents>
                </element>
                <element name="pe1-_unpaired.00.0_0.cor">
                    <assert_contents>
                        <has_size value="392" delta="100"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output name="out_l">
                <assert_contents>
                    <has_text_matching expression="Thank you for using SPAdes!"/>
                </assert_contents>
            </output>
            <output name="out_sc">
                <assert_contents>
                    <has_n_lines n="163"/>
                </assert_contents>
            </output>
            <output name="out_sp">
                <assert_contents>
                    <has_n_lines n="4"/>
                </assert_contents>
            </output>
            <output name="out_ss">
                <assert_contents>
                    <has_n_lines n="2"/>
                </assert_contents>
            </output>
        </test>
        <!-- #3 multiple, single & paired-end, test dataset not valid -->
        <test expect_num_outputs="1">
            <param name="operation_mode" value="--only-assembler"/>
            <repeat name="file_rep">
                <conditional name="readtype_cond">
                    <param name="readtype_sel" value="pe"/>
                    <conditional name="filetype_cond">
                        <param name="filetype_sel" value="interlaced"/>
                        <param name="reads" value="ecoli_1K.fastq.gz"/>
                    </conditional>
                </conditional>
            </repeat>
            <repeat name="file_rep">
                <conditional name="readtype_cond">
                    <param name="readtype_sel" value="pe"/>
                    <conditional name="filetype_cond">
                        <param name="filetype_sel" value="separate"/>
                        <param name="fwd_reads" value="pl1.fq.gz"/>
                        <param name="rev_reads" value="pl2.fq.gz"/>
                    </conditional>
                </conditional>
            </repeat>
            <param name="mode_sel" value="--careful"/>
            <param name="optional_output" value="l"/>
            <output name="out_l">
                <assert_contents>
                    <has_text_matching expression="Thank you for using SPAdes!"/>
                </assert_contents>
            </output>
        </test>
        <!-- #4 test dataset not valid-->
        <test expect_num_outputs="1">
            <repeat name="file_rep">
                <conditional name="readtype_cond">
                    <param name="readtype_sel" value="pe"/>
                    <conditional name="filetype_cond">
                        <param name="filetype_sel" value="separate"/>
                        <param name="fwd_reads" value="pl1.fq.gz"/>
                        <param name="rev_reads" value="pl2.fq.gz"/>
                    </conditional>
                </conditional>
            </repeat>
            <param name="mode_sel" value="--careful"/>
            <param name="optional_output" value="l"/>
            <output name="out_l">
                <assert_contents>
                    <has_text_matching expression="Thank you for using SPAdes!"/>
                </assert_contents>
            </output>
        </test>
        <!-- #5 only corrected reads are created as an output -->
        <test expect_num_outputs="2">
            <param name="operation_mode" value="--only-error-correction"/>
            <repeat name="file_rep">
                <conditional name="readtype_cond">
                    <param name="readtype_sel" value="pe"/>
                    <conditional name="filetype_cond">
                        <param name="filetype_sel" value="separate"/>
                        <param name="fwd_reads" value="pl1.fq.gz"/>
                        <param name="rev_reads" value="pl2.fq.gz"/>
                    </conditional>
                </conditional>
            </repeat>
            <param name="optional_output" value="cr,l"/>
            <output_collection name="out_cr" type="list" count="3">
                <element name="pe1-1-1.fastq.00.0_0.cor">
                    <assert_contents>
                        <has_size value="71743" delta="1000"/>
                    </assert_contents>
                </element>
                <element name="pe1-2-1.fastq.00.0_0.cor">
                    <assert_contents>
                        <has_size value="71743" delta="1000"/>
                    </assert_contents>
                </element>
                <element name="pe1-_unpaired.00.0_0.cor">
                    <assert_contents>
                        <has_size value="392" delta="10"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output name="out_l">
                <assert_contents>
                    <has_text_matching expression="Thank you for using SPAdes!"/>
                </assert_contents>
            </output>
        </test>
        <!-- #6 only corrected reads are created as an output -->
        <test expect_num_outputs="2">
            <param name="operation_mode" value="--only-error-correction"/>
            <repeat name="file_rep">
                <conditional name="readtype_cond">
                    <param name="readtype_sel" value="pe"/>
                    <conditional name="filetype_cond">
                        <param name="filetype_sel" value="separate"/>
                        <param name="fwd_reads" value="pl1.fq.gz"/>
                        <param name="rev_reads" value="pl2.fq.gz"/>
                    </conditional>
                </conditional>
            </repeat>
            <param name="optional_output" value="cr,l"/>
            <output_collection name="out_cr" type="list" count="3">
                <element name="pe1-1-1.fastq.00.0_0.cor">
                    <assert_contents>
                        <has_size value="71743" delta="1000"/>
                    </assert_contents>
                </element>
                <element name="pe1-2-1.fastq.00.0_0.cor">
                    <assert_contents>
                        <has_size value="71743" delta="1000"/>
                    </assert_contents>
                </element>
                <element name="pe1-_unpaired.00.0_0.cor">
                    <assert_contents>
                        <has_size value="392" delta="10"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output name="out_l">
                <assert_contents>
                    <has_text_matching expression="Thank you for using SPAdes!"/>
                </assert_contents>
            </output>
        </test>
        <!-- #7 only corrected reads are created as an output -->
        <test expect_num_outputs="2">
            <repeat name="file_rep">
                <conditional name="readtype_cond">
                    <param name="readtype_sel" value="pe"/>
                    <conditional name="filetype_cond">
                        <param name="filetype_sel" value="separate"/>
                        <param name="fwd_reads" value="pl1.fq.gz"/>
                        <param name="rev_reads" value="pl2.fq.gz"/>
                    </conditional>
                </conditional>
            </repeat>
            <param name="mode_sel" value="--careful"/>
            <param name="optional_output" value="cr,l"/>
            <output_collection name="out_cr" type="list" count="3">
                <element name="pe1-1-1.fastq.00.0_0.cor">
                    <assert_contents>
                        <has_size value="71743" delta="1000"/>
                    </assert_contents>
                </element>
                <element name="pe1-2-1.fastq.00.0_0.cor">
                    <assert_contents>
                        <has_size value="71743" delta="1000"/>
                    </assert_contents>
                </element>
                <element name="pe1-_unpaired.00.0_0.cor">
                    <assert_contents>
                        <has_size value="392" delta="10"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output name="out_l">
                <assert_contents>
                    <has_text_matching expression="Thank you for using SPAdes!"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

@HELP_WID@

plasmidSPAdes is a subtool for assembling plasmid data sets.

**Input**

@HELP_IN@

**Output**

@HELP_OUT_AG@
@HELP_OUT_AGS@
@HELP_OUT_C@
@HELP_OUT_CP@
@HELP_OUT_CR@
@HELP_OUT_CS@
@HELP_OUT_L@
@HELP_OUT_S@
@HELP_OUT_SP@
@HELP_OUT_SS@

**References**

More information can be found on `github <https://github.com/ablab/spades>`_  and on the `project website <http://cab.spbu.ru/software/plasmid-spades>`_.
    ]]></help>
    <expand macro="citations">
        <citation type="doi">10.1093/bioinformatics/btw493</citation>
    </expand>
</tool>
