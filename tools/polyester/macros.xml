<?xml version="1.0"?>
<macros>
    <xml name="requirements">
        <requirements>
            <requirement type="package" version="@TOOL_VERSION@">bioconductor-polyester</requirement>
            <yield />
        </requirements>
    </xml>

    <xml name="citations">
        <citations>
            <citation type="bibtex">@online{polyester,
              author = {Alyssa Frazee},
              title = {polyester},
              year = 2015,
              url = {https://github.com/alyssafrazee/polyester},
              urldate = {2021-04-06}
            }</citation>
        </citations>
    </xml>
    <token name="@TOOL_VERSION@">1.26.0</token>

    <token name="@SPLIT_FASTA@">
<![CDATA[
with open('genome.fa', 'r') as infile:
    file_handle = None
    for i, line in enumerate(infile):
        if line[0] == '>':
            if file_handle is not None:
                file_handle.close()
            file_handle = open('reference_fastas/' + \
                line.strip().lstrip('>').split()[0] + '.fa', 'w')
            file_handle.write(line)
        else:
            if file_handle is None:
                raise Exception("Misformed FASTA in split_fasta at line %d of FASTA" % (i))
            else:
                file_handle.write(line)
]]>
</token>

    <token name="@R_INIT@"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(), file=stderr()); q("no",1,F)})
## Unify locale settings
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")
]]></token>

<token name="@WID@"><![CDATA[
**What it does**

Polyester is an R package designed to simulate RNA sequencing experiments with differential transcript expression.

Given a set of annotated transcripts, Polyester will simulate the steps of an RNA-seq experiment (fragmentation, reverse-complementing, and sequencing) and produce files containing simulated RNA-seq reads. Simulated reads can be analyzed using your choice of downstream analysis tools.

Users are able to set the levels of differential expression at transcripts of their choosing. This means they know which transcripts are differentially expressed in the simulated dataset, so accuracy of statistical methods for differential expression detection can be analyzed.

Polyester offers several unique features:

- Built-in functionality to simulate differential expression at the transcript level
- Ability to explicitly set differential expression signal strength
- Simulation of small datasets, since large RNA-seq datasets can require lots of time and computing resources to analyze
- Generation of raw RNA-seq reads, as opposed to alignments or transcript-level abundance estimates
- Transparency/open-source code
]]></token>

<token name="@REFERENCES@"><![CDATA[
More information are available on the `GitHub <https://github.com/alyssafrazee/polyester>`_ .
]]></token>

<token name="@GENOME_FASTA@"><![CDATA[
    #if $annotation_type.reference_source.reference_source_selector == 'history':
        ln -f -s '$annotation_type.reference_source.input_reference' genome.fa &&
    #else:
        ln -f -s '$annotation_type.reference_source.input_reference.fields.path' genome.fa &&
    #end if
]]></token>

<token name="@TRANSCRIPTOME_FASTA@"><![CDATA[
    #if $annotation_type.reference_transcriptome.reference_transcriptome_source == 'history':
        ln -f -s '$annotation_type.reference_transcriptome.input_fasta' txome.fa &&
    #else:
        ln -f -s '$annotation_type.reference_transcriptome.input_fasta.fields.path' txome.fa &&
    #end if
]]></token>

<xml name="reference_genome">
    <conditional name="reference_source">
        <param name="reference_source_selector" type="select" label="Choose the source for the reference genome">
            <option value="cached">Use a built-in genome</option>
            <option value="history">Use a genome from history</option>
        </param>
        <when value="cached">
            <param name="input_reference" type="select" label="Using reference genome" help="Select genome from the list">
                <options from_data_table="all_fasta">
                    <filter type="sort_by" column="2"/>
                </options>
                <validator type="no_options" message="A built-in reference genome is not available for the build associated with the selected input file"/>
            </param>
        </when>
        <when value="history">
            <param name="input_reference" type="data" format="fasta" label="FASTA file containing the sequences for the chromosomes in GTF"/>
        </when>
    </conditional>
</xml>

<xml name="reference_transcriptome">
    <conditional name="reference_transcriptome">
        <param name="reference_transcriptome_source" type="select" label="Reference transcriptome for simulation">
            <option value="cached" selected="true">Use a built-in transcriptome</option>
            <option value="history">Use a transcriptome from history</option>
        </param>
        <when value="cached">
            <param name="input_fasta" type="select" label="Select a reference transcriptome" help="If your transcriptome of interest is not listed, contact your Galaxy administrator">
                <options from_data_table="all_txome_fasta">
                    <filter type="sort_by" column="2" />
                    <validator type="no_options" message="No transcriptomes are available for the selected input dataset" />
                </options>
            </param>
        </when>
        <when value="history">
            <param name="input_fasta" type="data" format="fasta" label="FASTA file containing transcripts from which to simulate reads"
                    help="Note that every transcript in the file must have a unique sequence, or the function will fail"/>
        </when>
    </conditional>
</xml>
</macros>
