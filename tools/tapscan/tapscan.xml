<tool id="tapscan_classify" name="TAPScan Classify" version="74+galaxy0">
    <description>Detect Transcription Associated Proteins (TAPs)</description>
    <requirements>
        <requirement type="package" version="3.3.2">hmmer</requirement>
        <requirement type="package" version="5.26">perl</requirement>
    </requirements>
    <command detect_errors="aggressive"><![CDATA[

hmmsearch
  --domtblout domtblout.txt
  --cut_ga
  '${__tool_directory__}/tapscan_domains_v12.txt'
  '$fasta_in'

&&

perl '${__tool_directory__}/tapscan_script_v74_edit.txt'
  domtblout.txt
  '${__tool_directory__}/tapscan_rules_v81.txt'
  '$output1'
  '$output2'
  '$output3'
  '${__tool_directory__}/tapscan_coverage_values_v10.txt'

&&
## make the outputs tab-separated for Galaxy compatibility
sed -i -e 's/;/\t/' -e 's/;/\t/' -e 's/;/\t/' -e "1d" '$output1' &&
sed -i -e 's/;/\t/g' -e "1d" '$output2' &&
sed -i -e 's/;/\t/4' -e 's/;/\t/' -e 's/;/\t/' -e 's/;/\t/' -e "1d" '$output3' &&

## add header lines for convenience
sed -i '1s/^/sequence ID\tTAP family\tnumber of classifications\tdomains\n/' $output1 &&
sed -i '1s/^/TAP family\tnumber of detected proteins\n/' $output2 &&
sed -i '1s/^/sequence ID\tTAP family\tSubfamily\tnumber of classifications\tdomains\n/' $output3



    ]]></command>
    <inputs>
        <param name="fasta_in" type="data" format="fasta" optional="false" label="Proteins in FASTA format" help=""/>
    </inputs>
    <outputs>
        <data name="output1" format="tabular" label="${tool.name} on ${on_string}: detected domains and assigned TAP family
for each gene ID"/>
        <data name="output2" format="tabular" label="${tool.name} on ${on_string}: summary of the number of
members for each TAP family"/>
        <data name="output3" format="tabular" label="${tool.name} on ${on_string}: detected domains and assigned TAP family
for each gene ID - with subfamily information"/>
    </outputs>
    <tests>
        <test>
            <param name="fasta_in" value="PUBLIC_Ectocarpus-sp7_proteins_head.fa" ftype="fasta"/>
            <output name="output1" file="output.1.tsv" ftype="tabular" lines_diff="2" />
            <output name="output2" file="output.2.tsv" ftype="tabular" lines_diff="2" />
            <output name="output3" file="output.3.tsv" ftype="tabular" lines_diff="2" />
        </test>
    </tests>
    <help><![CDATA[
TAPscan is a comprehensive tool for annotating TAPs with a special focus on species
belonging to the Archaeplastida. In general, the detection of TAPs is based on the detection
of highly conserved protein domains.

During the first step, each sequence out of a species protein set is scanned for protein domains
(stored as profile Hidden Markov Models) using hmmsearch. The domains file (domains_v12.txt)
consists of 154 profile HMMs and functions as the domain reference during the hmmsearch command.

Afterwards, by applying the TAPscan script_v74_edit.txt, specialized rules are applied to finally
assign the protein sequences to TAP families based on the detected domains in the previous step.
With the latest TAPscan v4, a protein set can be scanned for 137 different TAP families with high
accuracy through applying GA-thresholds and coverage values.

TAPscan provides the user with three different output files. Each output file is
semicolon-separated. Output 1 contains the detected domains and finally assigned TAP family
for each gene ID. If domains are assigned to a sequence but not all rules are fulfilled, the
sequence is assigned to “0_no_family_found”. Output 2 is a summary of the number of
members for each TAP family. Output 3 is similar to Output 1 but contains additional
information about subfamilies.

    ]]></help>
    <citations>
        <!-- TODO: add citation for TAPscan v4 paper when published -->
        <citation type="doi">10.3390/genes12071055</citation>
    </citations>
</tool>
