<tool id="seurat_plot" name="Plot seurat data" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
@CMD@
    ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@
library(ggplot2)

#if $method.method == 'VlnPlot'
plot<-VlnPlot(
    seurat_obj,
    features = c('$method.features'),
    #if $method.idents != ''
    idents = '$method.idents',
    #end if
    sort = $method.sort,
    #if $method.assay != ''
    assay = '$method.assay',
    #end if
    #if $method.layer != ''
    layer = '$method.layer',
    #end if
    combine = TRUE
)

#else if $method.method == 'FeatureScatter'
plot<-FeatureScatter(
    seurat_obj,
    feature1 = '$method.feature1',
    feature2 = '$method.feature2'
)

#else if $method.method == 'VariableFeaturePlot'
plot<-VariableFeaturePlot(
    seurat_obj,
    #if $method.assay != ''
    assay = '$method.assay',
    #end if
    cols = c('$method.cols_1', '$method.cols_2'),
    pt.size = $method.pt_size,
)

#else if $method.method == 'VizDimLoadings'
plot<-VizDimLoadings(
    seurat_obj,
    dims = $method.dims,
    nfeatures = $method.nfeatures,
    reduction = '$method.reduction',
    col = '$method.col',
    projected = $method.projected,
    balanced = $method.balanced,
    ncol = $method.ncol,
    combine = TRUE
)

#else if $method.method == 'DimPlot'
plot<-DimPlot(
    seurat_obj,
    dims = c($method.dims),
    reduction = '$method.reduction'
)

#else if $method.method == 'DimHeatmap'
plot<-DimHeatmap(
    seurat_obj,
    dims = $method.dims,
    nfeatures = $method.nfeatures,
    #if $method.cells != ''
    cells = $method.cells,
    #end if
    reduction = '$method.reduction',
    #if $method.disp_min != ''
    disp.min = $method.disp_min,
    #end if
    #if $method.disp_max != ''
    disp.max = $method.disp_max,
    #end if
    projected = $method.projected,
    balanced = $method.balanced,
    ncol = $method.ncol,
    raster = $method.raster,
    slot = '$method.slot',
    #if $method.assays != ''
    assays = '$method.assays',
    #end if
    fast = FALSE,
    combine = TRUE
)

#else if $method.method == 'ElbowPlot'
plot<-ElbowPlot(
    seurat_obj,
    ndims = $method.ndims,
    reduction = '$method.reduction'
)

#else if $method.method == 'FeaturePlot'
plot<-FeaturePlot(
    seurat_obj,
    features = c('$method.features'),
    dims = c($method.dims),
    reduction = '$method.reduction',
    combine = TRUE
)

#else if $method.method == 'DoHeatmap'
plot<-DoHeatmap(
    seurat_obj,
    #if $method.features != ''
    features = '$method.features',
    #end if
    #if $method.cells != ''
    cells = '$method.cells',
    #end if
    #if $method.group_by != ''
    group.by = '$method.group_by',
    #end if
    group.bar = $method.group_bar,
    #if $method.group_colors != ''
    group.colors = '$method.group_colors',
    #end if
    #if $method.disp_min != ''
    disp.min = $method.disp_min,
    #end if
    #if $method.disp_max != ''
    disp.max = $method.disp_max,
    #end if
    slot = '$method.slot',
    #if $method.assay != ''
    assay = '$method.assay',
    #end if
    label = $method.label,
    size = $method.size,
    hjust = $method.hjust,
    vjust = $method.vjust,
    angle = $method.angle,
    raster = $method.raster,
    draw.lines = $method.draw_lines,
    #if $method.lines_width != ''
    lines.width = $method.lines_width,
    #end if
    group.bar.height = $method.group_bar_height,
    combine = TRUE
)

#end if

#if $plot_format == 'png'
ggsave('plot.png')
#else if $plot_format == 'pdf'
ggsave('plot.pdf')
#else if $plot_format == 'svg'
ggsave('plot.svg')
#else if $plot_format == 'jpeg'
ggsave('plot.jpeg')
#else if $plot_format == 'tex'
ggsave('plot.tex')
#else if $plot_format == 'tiff'
ggsave('plot.tiff')
#else if $plot_format == 'eps'
ggsave('plot.eps')
#end if

]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="input_rds"/>
        <expand macro="plot_parameters"/>
        <conditional name="method">
            <param name="method" type="select" label="Method used">
                <option value="VlnPlot">Violin Plot with 'VlnPlot'</option>
                <option value="FeatureScatter">Scatter Plot with 'FeatureScatter'</option>
                <option value="VariableFeaturePlot">Plot Variable Genes with 'VariableFeaturePlot'</option>
                <option value="VizDimLoadings">Visualise PCA Results with 'VizDimLoadings'</option>
                <option value="DimPlot">Visualise Dimensional Reduction with 'DimPlot'</option>
                <option value="DimHeatmap">Visualise PCA Results with 'DimHeatmap'</option>
                <option value="ElbowPlot">Determine dimensionality with 'ElbowPlot'</option>
                <option value="FeaturePlot">Visualise expression with 'FeaturePlot'</option>
                <option value="DoHeatmap">Visualise expression with 'DoHeatmap'</option>
            </param>
            <when value="VlnPlot">
                <param name="features" type="text" value="" label="Features to plot"/>
                <param name="idents" type="text" optional="true" value="" label="Classes to include in plot"/>
                <param name="sort" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Sort identity classes by average expression"/>
                <param name="assay" type="text" optional="true" value="" label="Assay to use"/>
                <param name="layer" type="text" optional="true" value="" label="Layer to use"/>
            </when>
            <when value="FeatureScatter">
                <param name="feature1" type="text" value="" label="First feature to plot"/>
                <param name="feature2" type="text" value="" label="Second feature to plot"/>
            </when>
            <when value="VariableFeaturePlot">
                <param name="assay" type="text" optional="true" value="" label="Assay to pull variable features from"/>
                <param name="cols_1" type="text" value="black" label="Colour for non-variable genes"/>
                <param name="cols_2" type="text" value="red" label="Colour for variable genes"/>
                <param name="pt_size" type="integer" value="1" label="Size of points on plot"/>
                <param name="log" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Plot the x-axis in log scale"/>
                <param name="raster" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Convert points to raster format"/>
                <param name="raster_dpi" type="text" optional="true" value="512, 512" label="Pixel resolution for rasterized plots"/>
            </when>
            <when value="VizDimLoadings">
                <param name="dims" type="text" value="1:10" label="Number of dimensions to display"/>
                <param name="nfeatures" type="integer" value="30" label="Number of genes to display"/>
                <param name="reduction" type="text" value="pca" label="Reduction to visualise results for"/>
                <param name="col" type="text" value="blue" label="Colour of points to use"/>
                <param name="projected" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Use reduction values for full dataset (i.e. projected dimensional reduction values)"/>
                <param name="balanced" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Return an equal number of genes with + and - scores (default returns top absolute scores)"/>
                <param name="ncol" type="integer" optional="true" value="" label="Number of columns to display"/>
            </when>
            <when value="DimPlot">
                <param name="dims" type="text" value="1, 2" label="Dimensions to plot (comma separated pair e.g. 1, 2 for x and y axes)"/>
                <param name="reduction" type="text" value="pca" label="Which dimensionality reduction to use"/>
            </when>
            <when value="DimHeatmap">
                <param name="dims" type="text" value="1" label="Dimensions to plot"/>
                <param name="nfeatures" type="integer" value="30" label="Number of genes to plot"/>
                <param name="cells" type="integer" optional="true" value="" label="Number of top cells to plot (could also be a list of cells?)"/>
                <param name="reduction" type="text" value="pca" label="Which dimensional reduction to use"/>
                <param name="disp_min" type="float" optional="true" value="-2.5" label="Minimum display value (all values below are clipped)"/>
                <param name="disp_max" type="float" optional="true" value="" label="Maximum display value (all values above are clipped). Defaults to 2.5 if slot is scale.data, otherwise defaults to 6"/>
                <param name="projected" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Use reduction values for full dataset (i.e. projected dimensional reduction values)"/>
                <param name="balanced" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Return an equal number of genes with + and - scores (default returns top absolute scores)"/>
                <param name="ncol" type="integer" optional="true" value="" label="Number of columns to display"/>
                <param name="raster" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Convert points to raster format"/>
                <param name="slot" type="text" value="scale.data" label="Data slot to use (e.g. raw.data, data, or scale.data)"/>
                <param name="assays" type="text" optional="true" value="" label="Vector of assays to pull data from"/>
            </when>
            <when value="ElbowPlot">
                <param name="ndims" type="integer" value="30" label="Number of dimensions to plot standard deviation for"/>
                <param name="reduction" type="text" value="pca" label="Reduction technique to plot standard deviation for"/>
            </when>
            <when value="FeaturePlot">
                <param name="features" type="text" value="" label="Features to plot"/>
                <param name="dims" type="text" value="1, 2" label="Dimensions to plot (comma separated pair e.g. 1, 2 for x and y axes)"/>
                <param name="reduction" type="text" value="pca" label="Reduction technique to plot standard deviation for"/>
            </when>
            <when value="DoHeatmap">
                <param name="features" type="text" optional="true" value="" label="Features to plot, defaults to VariableFeatures"/>
                <param name="cells" type="text" optional="true" value="" label="Cells to plot"/>
                <param name="group_by" type="text" optional="true" value="ident" label="Vector of variables to group cells by, use ident to group by cluster"/>
                <param name="group_bar" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true" label="Add colour bar showing group status for cells"/>
                <param name="group_colors" type="text" optional="true" value="" label="Colours to use for colour bar"/>
                <param name="disp_min" type="float" optional="true" value="-2.5" label="Minimum display value (all values below are clipped)"/>
                <param name="disp_max" type="float" optional="true" value="" label="Maximum display value (all values above are clipped). Defaults to 2.5 if slot is scale.data, otherwise defaults to 6"/>
                <param name="slot" type="text" value="scale.data" label="Data slot to use"/>
                <param name="assay" type="text" optional="true" value="" label="Assay to pull from"/>
                <param name="label" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true" label="Label cell identities above the colour bar"/>
                <param name="size" type="float" value="5.5" label="Size of text above colour bar"/>
                <param name="hjust" type="float" value="0" label="Horizontal justification of text above colour bar"/>
                <param name="vjust" type="float" value="0" label="Vertical justification of text above colour bar"/>
                <param name="angle" type="integer" value="45" label="Angle of text above colour bar"/>
                <param name="raster" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Convert points to raster format"/>
                <param name="draw_lines" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true" label="Inlude white lines to separate the groups"/>
                <param name="lines_width" type="integer" optional="true" value="" label="Integer number to adjust width of separating lines, corresponds to the number of 'cells' between groups"/>
                <param name="group_bar_height" type="float" value="0.02" label="Scale the height of the colour bar"/>
            </when>
        </conditional>
        <expand macro="inputs_common_advanced"/>
    </inputs>
    <outputs>
        <expand macro="plot_out"/>
        <expand macro="outputs_common_advanced"/>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <!-- test1: VlnPlot PNG -->
            <param name="seurat_rds" location="https://zenodo.org/records/11484502/files/filtered.rds"/>
            <param name="plot_format" value="png"/>
            <conditional name="method">
                <param name="method" value="VlnPlot"/>
                <param name="features" value="nFeature_RNA"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="VlnPlot"/>
                </assert_contents>
            </output>
            <output name="plot_out_png" location="https://zenodo.org/records/11484502/files/VlnPlot.png" ftype="png"/>
        </test>
        <test expect_num_outputs="2">
            <!-- test2: FeatureScatter PDF -->
            <param name="seurat_rds" location="https://zenodo.org/records/11484502/files/filtered.rds"/>
            <param name="plot_format" value="pdf"/>
            <conditional name="method">
                <param name="method" value="FeatureScatter"/>
                <param name="feature1" value="nCount_RNA"/>
                <param name="feature2" value="nFeature_RNA"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="FeatureScatter"/>
                </assert_contents>
            </output>
            <output name="plot_out_pdf" location="https://zenodo.org/records/11484502/files/FeatureScatter.pdf" ftype="pdf"/>
        </test>
        <test expect_num_outputs="2">
            <!-- test3: VariableFeaturePlot SVG -->
            <param name="seurat_rds" location="https://zenodo.org/records/11484502/files/variablefeatures.rds"/>
            <param name="plot_format" value="svg"/>
            <conditional name="method">
                <param name="method" value="VariableFeaturePlot"/>
                <param name="cols_1" value="black"/>
                <param name="cols_2" value="red"/>
                <param name="pt_size" value="1"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="VariableFeaturePlot"/>
                </assert_contents>
            </output>
            <output name="plot_out_svg" ftype="svg">
                <assert_contents>
                    <has_size size="90.5K"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="2">
            <!-- test4: VizDimLoadings JPEG -->
            <param name="seurat_rds" location="https://zenodo.org/records/11484502/files/pca.rds"/>
            <param name="plot_format" value="jpeg"/>
            <conditional name="method">
                <param name="method" value="VizDimLoadings"/>
                <param name="dims" value="1:5"/>
                <param name="nfeatures" value="10"/>
                <param name="reduction" value="pca"/>
                <param name="col" value="blue"/>
                <param name="projected" value="FALSE"/>
                <param name="balanced" value="TRUE"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="VizDimLoadings"/>
                </assert_contents>
            </output>
            <output name="plot_out_jpeg" location="https://zenodo.org/records/11484502/files/VizDimLoadings.jpeg" ftype="jpeg"/>
        </test>
        <test expect_num_outputs="2">
            <!-- test5: DimPlot TEX -->
            <param name="seurat_rds" location="https://zenodo.org/records/11484502/files/umap.rds"/>
            <param name="plot_format" value="tex"/>
            <conditional name="method">
                <param name="method" value="DimPlot"/>
                <param name="dims" value="1, 2"/>
                <param name="reduction" value="umap"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="DimPlot"/>
                </assert_contents>
            </output>
            <output name="plot_out_tex" location="https://zenodo.org/records/11484502/files/DimPlot.tex" ftype="tex"/>
        </test>
        <test expect_num_outputs="2">
            <!-- test6: DimHeatmap TIFF -->
            <param name="seurat_rds" location="https://zenodo.org/records/11484502/files/pca.rds"/>
            <param name="plot_format" value="tiff"/>
            <conditional name="method">
                <param name="method" value="DimHeatmap"/>
                <param name="dims" value="1:3"/>
                <param name="nfeatures" value="30"/>
                <param name="cells" value="50"/>
                <param name="reduction" value="pca"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="DimHeatmap"/>
                </assert_contents>
            </output>
            <output name="plot_out_tiff" location="https://zenodo.org/records/11484502/files/DimHeatmap.tiff" ftype="tiff"/>
        </test>
        <test expect_num_outputs="2">
            <!-- test7: ElbowPlot EPS -->
            <param name="seurat_rds" location="https://zenodo.org/records/11484502/files/pca.rds"/>
            <param name="plot_format" value="eps"/>
            <conditional name="method">
                <param name="method" value="ElbowPlot"/>
                <param name="ndims" value="30"/>
                <param name="reduction" value="pca"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="ElbowPlot"/>
                </assert_contents>
            </output>
            <output name="plot_out_eps" location="https://zenodo.org/records/11484502/files/ElbowPlot.eps" ftype="eps"/>
        </test>
        <test expect_num_outputs="2">
            <!-- test8: FeaturePlot PNG -->
            <param name="seurat_rds" location="https://zenodo.org/records/11484502/files/umap.rds"/>
            <param name="plot_format" value="png"/>
            <conditional name="method">
                <param name="method" value="FeaturePlot"/>
                <param name="features" value="Obox6"/>
                <param name="dims" value="1, 2"/>
                <param name="reduction" value="umap"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="FeaturePlot"/>
                </assert_contents>
            </output>
            <output name="plot_out_png" location="https://zenodo.org/records/11484502/files/FeaturePlot.png" ftype="png"/>
        </test>
        <test expect_num_outputs="2">
            <!-- test9: DoHeatmap PNG -->
            <param name="seurat_rds" location="https://zenodo.org/records/11484502/files/clusters.rds"/>
            <param name="plot_format" value="png"/>
            <conditional name="method">
                <param name="method" value="DoHeatmap"/>
                <param name="group_by" value="ident"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="DoHeatmap"/>
                </assert_contents>
            </output>
            <output name="plot_out_png" location="https://zenodo.org/records/11484502/files/DoHeatmap.png" ftype="png"/>
        </test>
    </tests>
    <help><![CDATA[
Seurat
======

Seurat is an R package designed for QC, analysis, and exploration of single-cell RNA-seq data. 

Seurat aims to enable users to identify and interpret sources of heterogeneity from single-cell transcriptomic measurements, and to integrate diverse types of single-cell data.

VlnPlot
=======

Draw a violin plot of single cell data (gene expression, metrics, PC scores, etc.)

More details on the `seurat documentation
<https://satijalab.org/seurat/reference/vlnplot>`__


FeatureScatter
==============

Create a scatter plot of two features (typically feature expression), across a set of single cells. Cells are colored by their identity class. 
Pearson correlation between the two features is displayed above the plot.

More details on the `seurat documentation
<https://satijalab.org/seurat/reference/featurescatter>`__

VariableFeaturePlot
===================

View selected variable features on a plot of variances.

More details on the `seurat documentation
<https://satijalab.org/seurat/reference/variablefeatureplot>`__

VizDimLoadings
==============

Visualize top genes associated with reduction components.

More details on the `seurat documentation
<https://satijalab.org/seurat/reference/vizdimloadings>`__

DimPlot
=======

Graph the output of a dimensional reduction technique on a 2D scatter plot where each point is a cell and it's positioned based on the cell embeddings determined by the reduction technique. 
By default, cells are colored by their identity class (can be changed with the group.by parameter).

More details on the `seurat documentation
<https://satijalab.org/seurat/reference/dimplot>`__

DimHeatmap
==========

Draw a heatmap focusing on a principal component. Both cells and genes are sorted by their principal component scores. 
Allows for nice visualization of sources of heterogeneity in the dataset.

More details on the `seurat documentation
<https://satijalab.org/seurat/reference/dimheatmap>`__

ElbowPlot
=========

Plot the standard deviations of the principal components for easy identification of an elbow in the graph. 

More details on the `seurat documentation
<https://satijalab.org/seurat/reference/elbowplot>`__

FeaturePlot
===========

Color single cells on a dimensional reduction plot according to a 'feature' (i.e. gene expression, PC scores, number of genes detected, etc.)

More details on the `seurat documentation
<https://satijalab.org/seurat/reference/featureplot>`__

DoHeatmap
=========

Draw a heatmap of single cell feature expression.

More details on the `seurat documentation
<https://satijalab.org/seurat/reference/doheatmap>`__


    ]]></help>
    <expand macro="citations"/>
</tool>