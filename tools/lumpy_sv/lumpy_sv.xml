<tool id="lumpy_sv" name="LUMPY" version="@WRAPPER_VERSION@">
    <description>discovers structural variants</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">lumpy-sv</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[

    ln '$input_sample_file' ./sample.input.bam &&
    samtools collate -O --output-fmt sam ./sample.input.bam | samblaster --excludeDups --addMateTags --maxSplitCount 2 --minNonOverlap 20 | samtools view -h -S -b - > ./sample.bam &&

    samtools view -b -F 1294 ./sample.bam > ./sample.discordants.unsorted.bam &&
    samtools view -h ./sample.bam | extractSplitReads_BwaMem -i stdin | samtools view -Sb - > ./sample.splitters.unsorted.bam &&

    samtools sort ./sample.discordants.unsorted.bam > ./sample.discordants.bam &&
    samtools sort ./sample.splitters.unsorted.bam > ./sample.splitters.bam &&

    pe_var=\$(samtools view -r id1 ./sample.bam | tail -n+'$stat_tail_n' | python \$CONDA_PREFIX/share/lumpy-sv-*/scripts/pairend_distro.py -r '$read_length' -X 4 -N 10000 -o sample.lib1.histo | tr '\t' ',') &&

    lumpy
        -mw '$mw'
        -tt '$tt'
        #if $e:
        -e
        #end if
        -pe id:sample1,bam_file:sample.discordants.bam,histo_file:sample.lib1.histo,\${pe_var},read_length:'$read_length',min_non_overlap:'$min_non_overlap',discordant_z:'$discordant_z',back_distance:'$back_distance',weight:'$weight',min_mapping_threshold:'$min_mapping_threshold'
        -sr id:sample1,bam_file:sample.splitters.bam,back_distance:'$sr_back_distance',weight:'$sr_weight',min_mapping_threshold:'$sr_min_mapping_threshold'
        > ./sample.vcf
    ]]></command>
    <inputs>
        <param name="input_sample_file" type="data" format="bam" multiple="false" label="Sample file" help="Sample file in .BAM format." />
        <!--<param name="input_bedpe_file" type="data" format="bed" multiple="false" label="BEDPE file" help="Position sorted bedpe file containing the breakpoint intervals for this sample." />-->
            <!-- General options -->
            <section name="general" title="General options" expanded="false">
                <!--<param name="g" type="data" label="Genome file (-g)" help="Defines chromosome order" />-->
                <param name="e" type="boolean" checked="true" label="Show evidence for each call (-e)" help="" />
                <!--<param name="w" type="integer" value="1000000" label="File read windows size (-w)" help="Default 1000000" />-->
                <param name="mw" type="integer" value="4" label="Minimum weight across all samples for a call (-mw)" help="" />
                <!--<param name="msw" type="integer" value="1" label="Minimum per-sample weight for a call (-msw)" help="" />-->
                <param name="tt" type="integer" value="0" label="Trim threshold (-tt)" help="" />
                <!--<param name="x" type="boolean" checked="true" label="Exclude bed file (-x)" help="" />-->
                <!--<param name="t" type="text" value="" label="Temp file prefix, must be to a writeable directory (-t)" help="" />-->
                <!--<param name="P" type="boolean" checked="false" label="Output probability curve for each variant (-P)" help="" />-->
                <!--<param name="b" type="boolean" checked="false" label="output as BEDPE instead of VCF (-b)" help="" />-->
                <param name="stat_tail_n" type="integer" value="100000" label="stat_tail_n" help="" />
            </section>
            <!-- PE options -->
            <section name="pe" title="Paired-end options (-pe)" expanded="false">
                <param name="read_length" type="integer" value="101" label="Length of sequenced reads" help="" />
                <param name="min_non_overlap" type="integer" value="101" label="Number of base pair positions that must be unique to each end of a read pair" help="Some library preps are created with large reads and small library sizes such that read overlap, in all over cases overlapping reads tends to be a sign of an error. We typically set this to read length (pairs cannot overlap)." />
                <param name="discordant_z" type="integer" value="5" label="Number of standard deviations away from the mean to be considered as a normal library size" help="" />
                <param name="back_distance" type="integer" value="10" label="Distance into the read to add to the breakpoint interval" help="" />
                <param name="min_mapping_threshold" type="integer" value="20" label="Minimum mapping quality (reported from the aligner) that a read must have to be considered" help="A quality of 1 will filter all reads with two or more equally good mappings." />
                <param name="weight" type="integer" value="1" label="Weight of each piece of evidence from this sample" help="" />
            </section>
            <!-- SR options -->
            <section name="sr" title="Split-read options (-sr)" expanded="false">
                <param name="sr_back_distance" type="integer" value="10" label="Distance around the +/- of the split to include in the breakpoint interval" help="A distance of 20 will created a breakpoint interval of size 40 centered at the split." />
                <param name="sr_min_mapping_threshold" type="integer" value="20" label="Minimum mapping quality (reported from the aligner) that a read must have to be considered" help="A quality of 1 will filter all reads with two or more equally good mappings." />
                <param name="sr_weight" type="integer" value="1" label="Weight of each piece of evidence from this sample" help="" />
            </section>
            <!-- BEDPE options -->
            <!--<section name="bedpe" title="BEDPE options (-bedpe)" expanded="false">-->
                <!--<param name="bedpe_back_distance" type="integer" value="10" label="Distance into the read to add to the breakpoint interval" help="" />-->
                <!--<param name="bedpe_weight" type="integer" value="1" label="Weight of each piece of evidence from this sample" help="" />-->
            <!--</section>-->
    </inputs>
    <outputs>
        <data name="out_sample" format="vcf" label="${tool.name} on ${on_string}: sample" from_work_dir="sample.vcf" />
    </outputs>
    <tests>
    </tests>
    <help><![CDATA[
LUMPY
=============

A probabilistic framework for structural variant discovery.

For more information see the LUMPY documentation_.

.. _documentation: https://github.com/arq5x/lumpy-sv

    ]]></help>
     <citations>
         <citation type="doi">10.1186/gb-2014-15-6-r84</citation>
    </citations>
</tool>
