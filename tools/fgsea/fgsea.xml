<tool id="fgsea" name="fgsea" version="1.4.0.0">
    <description>fast preranked gene set enrichment analysis</description>
    <requirements>
        <requirement type="package" version="1.4.0">bioconductor-fgsea</requirement>
        <requirement type="package" version="1.4.4">r-optparse</requirement>
    </requirements>
    <version_command><![CDATA[
echo $(R --version | grep version | grep -v GNU)", fgsea version" $(R --vanilla --slave -e "library(fgsea); cat(sessionInfo()\$otherPkgs\$fgsea\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", optparse version" $(R --vanilla --slave -e "library(optparse); cat(sessionInfo()\$otherPkgs\$optparse\$Version)" 2> /dev/null | grep -v -i "WARNING: ")
    ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[

ln -s '$gmt_file.fields.path' gmt_file &&

Rscript '$__tool_directory__/fgsea.r' 
--rnk_file '$rnk_file'
--gmt_file gmt_file
--min_size $min_size
--max_size $max_size
--n_perm $n_perm
--out_tab '$out_tab'
--plotOpt $plotOpt
--rdaOpt $rdaOpt
    ]]></command>
    <inputs>
        <param name="rnk_file" type="data" format="tabular" label="Ranked Genes" help="A tabular file with gene symbols in the first column, and a ranked statistic (e.g. t-statistic or log fold-change) in the second column"/>
        <param name="gmt_file" type="select" label="MSigDB Gene Sets" help="">
            <options from_data_table="all_gmt">
                <filter type="sort_by" column="1"/>
            </options>
        </param>
        <param name="min_size" type="integer" min="0" value="1" label="Minimum Size of Gene Set" help="Minimal size of a gene set to test. All pathways below the threshold are excluded. Default: 1" />
        <param name="max_size" type="integer"  value="500" label="Maximal Size of Gene Set" help="Maximal size of a gene set to test. All pathways above the threshold are excluded. Default: 500" /> 
        <param name="n_perm" type="integer" min="0" value="1000" label="Number of Permutations" help="Number of permutations to do. Minimial possible nominal p-value is about 1/nperm. Default: 1000" />
        <param name="plotOpt" type="boolean" truevalue="True" falsevalue="False" checked="False" label="Output Table plot" help="Default: No"/>
        <param name="rdaOpt" type="boolean" truevalue="True" falsevalue="False" checked="False" label="Output RData file?" help="Output all the data used by R in the fgsea analysis, can be loaded into R. Default: No" />
    </inputs>

    <outputs>
        <data name="out_tab" format="tabular" label="${tool.name} on ${on_string}: Ranked category list" />
        <data name="out_pdf" format="pdf" from_work_dir="GseaTable.pdf" label="${tool.name} on ${on_string}: Table plot">
            <filter>plotOpt is True</filter>
        </data>
        <data name="out_rdata" format="rdata" from_work_dir="fgsea_analysis.RData" label="${tool.name} on ${on_string}: RData file">
            <filter>rdaOpt is True</filter>
        </data>
    </outputs>


    <tests>
        <test>
            <param name="rnk_file" ftype="tabular" value="t47d_Treatment_DEA_Prog-vs-Control_all_for_GSEA.rnk" />
            <param name="gmt_file" ftype="tabular" value="msig.h.sym"/>
            <param name="out_plot" value="True"/>
            <output name="out_tab" value="out_t47d.tab"/>
            <output name="out_pdf" value="out_t47d.pdf" compare="sim_size"/>
        </test>
    </tests>

    <help><![CDATA[
fgsea_ is a Bioconductor package for fast preranked gene set enrichment analysis (GSEA). The performance is achieved by using an algorithm for cumulative GSEA-statistic calculation. This allows to reuse samples between different gene set sizes. See the preprint_ for algorithmic details.

-----

**Inputs**

**Ranked Genes**

A two-column file containing a ranked list of genes. The first column must contain the gene identifiers and the second column the statistic used to rank. Gene identifiers can be Entrez Gene ID or Gene Symbol and must be unique (not repeated) within the file.

Example:

    =========  ============
    Symbol     Ranked Stat
    =========  ============
    VDR        67.198
    IL20RA     65.963
    MPHOSPH10  51.353
    RCAN1      50.269
    HILPDA     50.015
    TSC22D3    47.496
    FAM107B    45.926
    =========  ============

-----

**Outputs**

-----

Wrapper released under MIT License. Copyright (c) 2017 Mark Dunning

.. _fgsea: https://bioconductor.org/packages/release/bioc/html/fgsea.html
.. _preprint: http://biorxiv.org/content/early/2016/06/20/060012

    ]]></help>
    <citations>
        <citation type="doi">10.1101/060012</citation>
    </citations>
</tool>
