<tool id="frequency_reference_per_base" name="Get frequency of (mis)matches and indels per base" version="@TOOL_VERSION@+galaxy0" profile="@PROFILE@">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
## initialize
@REF_FASTA@
## link doesn't work
ln -s '${bam_in}' alignment.bam &&
ln -s '${bam_in.metadata.bam_index}' alignment.bam.bai &&

python '$__tool_directory__/frequency_reference_per_base.py' --bam alignment.bam --reference reference.fa --prefix get_percent_reference --depth '$max_depth' &&

mv get_percent_reference_match.bw '$out_matches' &&
mv get_percent_reference_mismatch.bw '$out_mismatches' &&
mv get_percent_reference_deletion.bw '$out_deletions' &&
mv get_percent_reference_insertion.bw '$out_insertions'
    ]]></command>
    <inputs>
        <param name="bam_in" type="data" format="bam" label="Select input reads"/>
        <expand macro="reference"/>
        <param name="max_depth" type="integer" label="Maximum read depth to consider in pileup step" value="800"/>
        <param name="output_matches_bool" type="boolean" label="Output matches bigWig file?" checked="true"/>
        <param name="output_mismatches_bool" type="boolean" label="Output mismatches bigWig file?" checked="true"/>
        <param name="output_deletions_bool" type="boolean" label="Output deletions bigWig file?" checked="true"/>
        <param name="output_insertions_bool" type="boolean" label="Output insertions bigWig file?" checked="true"/>
    </inputs>
    <outputs>
        <data name="out_matches" format="bigwig" label="${tool.name} on ${on_string}: Matches frequency">
            <filter>output_matches_bool</filter>
        </data>
        <data name="out_mismatches" format="bigwig" label="${tool.name} on ${on_string}: Mismatches frequency">
            <filter>output_mismatches_bool</filter>
        </data>
        <data name="out_deletions" format="bigwig" label="${tool.name} on ${on_string}: Deletions frequency">
            <filter>output_deletions_bool</filter>
        </data>
        <data name="out_insertions" format="bigwig" label="${tool.name} on ${on_string}: Insertions frequency">
            <filter>output_insertions_bool</filter>
        </data>
    </outputs>
    <tests>
        <!-- #1 default -->
        <test>
            <param name="bam_in" value="alignment.bam"/>
            <conditional name="reference_source">
                <param name="reference_source_selector" value="history"/>
                <param name="ref_file" value="ref.fasta"/>
            </conditional>
            <output name="out_matches">
                <assert_contents>
                    <has_size value="44703" delta="50"/>
                </assert_contents>
            </output>
            <output name="out_mismatches">
                <assert_contents>
                    <has_size value="44676" delta="50"/>
                </assert_contents>
            </output>
            <output name="out_deletions">
                <assert_contents>
                    <has_size value="44267" delta="50"/>
                </assert_contents>
            </output>
            <output name="out_insertions">
                <assert_contents>
                    <has_size value="44449" delta="50"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

@WID@

**Input**

- reads aligned to reference (BAM), should be aligned to the reference against which to calculate matches, mismatches, insertions, and deletions
- reference (FASTA)

    ]]></help>
    <expand macro="citations"/>
</tool>