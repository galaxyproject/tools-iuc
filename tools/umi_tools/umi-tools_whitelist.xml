<tool id="umi_tools_whitelist" name="UMI-tools whitelist" version="@VERSION@.0">
    <description>Extract cell barcodes from fastq files</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        #set $gz = False
        #if $input_type.type == 'single':
            #if $input_type.input_single.is_of_type("fastq.gz", "fastqsanger.gz"):
                ln -s '$input_type.input_single' input_single.gz &&
                #set $gz = True
            #end if
        #else
            #if $input_type.input_read1.is_of_type("fastq.gz", "fastqsanger.gz"):
                ln -s '$input_type.input_read1' input_read1.gz &&
                ln -s '$input_type.input_read2' input_read2.gz &&
                #set $gz = True
            #end if
        #end if
        umi_tools whitelist
            --bc-pattern='$bc_pattern'
            --subset-reads='$subset_reads'
            #if $input_type.type == 'single':
                #if $gz:
                    --stdin=input_single.gz
                #else
                    --stdin='$input_type.input_single'
                #end if
            #else:
                #if $gz:
                    --stdin=input_read1.gz
                    --read2-in=input_read2.gz
                #else:
                    --stdin='$input_type.input_read1'
                    --read2-in='$input_type.input_read2'
                #end if
                #if $input_type.barcode.split == "1":
                    --split-barcode
                    --bc-pattern2='$input_type.barcode.bc_pattern2'
                #end if
            #end if
            #if $celloptions.use_cell_opts == "Yes":
                #if $celloptions.set_cell_number != "-1":
                   --set-cell-number=$celloptions.set_cell_number
                #end if
                #if $celloptions.expect_cells != "-1":
                   --expect-cells=$celloptions.expect_cells
                #end if
            #end if
            --method=$method
            --plot-prefix=OUT
            #if $error_correct_thresh != "-1":
                --error-correct-threshold=$error_correct_thresh
            #end if
            
            #if not $prime3:
                --3prime
            #end if
            #if $print_log == "1":
                --log='$out_log'
            #else
                --supress-stats
            #end if
            > '$out_whitelist'
            mv OUT_cell_barcode_count_density.png $out_png_countdensity
            mv OUT_cell_barcode_knee.png $out_png_knee
            mv OUT_cell_barcode_counts.png $out_png_counts
            mv OUT_cell_thresholds.tsv $out_thresh
    ]]></command>
    <inputs>
        <conditional name="input_type">
            <param name="type" type="select" label="Library type">
                <option value="single">Single-end</option>
                <option value="paired">Paired-end</option>
            </param>
            <when value="single">
                <param name="input_single" type="data" format="fastq,fastq.gz" label="Reads in FASTQ format" />
            </when>
            <when value="paired">
                <param name="input_read1" type="data" format="fastq,fastq.gz" label="Reads in FASTQ format" />
                <param name="input_read2" type="data" format="fastq,fastq.gz" label="Reads in FASTQ format" />
                <conditional name="barcode">
                    <param name="split" argument="--split-barcode" type="select" label="Barcode on both reads?">
                        <option value="0">Barcode on first read only</option>
                        <option value="1">Barcode on both reads</option>
                    </param>
                    <when value="0">
                    </when>
                    <when value="1">
                        <param name="bc_pattern2" argument="--bc-pattern2" type="text" value="" label="Barcode pattern for second read"
                            help="Use this option to specify the format of the UMI/barcode for
                                  the second read pair if required.">
                        </param>
                    </when>
                </conditional>
            </when>
        </conditional>
        <param name="bc_pattern" argument="--bc-pattern" type="text" label="Barcode pattern for first read"
            help="Use this option to specify the format of the UMI/barcode. Use Ns to
                    represent the random positions and Xs to indicate the bc positions.
                    Bases with Ns will be extracted and added to the read name. Remaining
                    bases, marked with an X will be reattached to the read.">
        </param>
        <param name="method" argument="--method" type="select" label="Count reads or UMIs"
               help="Many published protocols rank CBs by the number of reads the CBs appear in. However you could also use the number of unique UMIs a CB is associated with. Note that this is still and approximation to the number of transcripts captured because the same UMI could be associated with two different transcripts and be counted as independent." >
            <option value="reads" selected="true" />
            <option value="umis" />
        </param>
        
        <param name="prime3" argument="--3prime" type="boolean" label="Is the barcode at the 5' end?"
            truevalue="1" falsevalue="0" checked="true"
            help="By default the barcode is assumed to be on the 5' end of the read, but
                use this option to specify that it is on the 3' end instead." />
        <param name="print_log" argument="-L" type="boolean" label="Output log?"
            truevalue="1" falsevalue="0" checked="true"
            help="Choose if you want to generate a text file containing logging information." />
        <param name="subset_reads" argument="--subset-reads" type="integer" min="0" value="0" label="Use the first N reads to automatically identify the true cell barcodes." />
        <conditional name="celloptions" >
            <param name="use_cell_opts" type="select" label="Manually set cell sizes" >
                <option value="Yes" />
                <option value="No" />
            </param>
            <when value="No" />
            <when value="Yes">
                <param name="set_cell_number" type="integer" value="-1" label="Specify the number of cell barcodes to accept" />
                <param name="expect_cells" type="integer" value="-1" label="Prior expectation on the upper limit on the number of cells sequenced" />
            </when>
        </conditional>
        <param name="error_correct_thresh"  type="integer" value="-1" label="Hamming distance for correction of barcodes to whilelist barcodes" />                
    </inputs>
    <outputs>
        <data name="out_whitelist" format="tabular" />
        <data name="out_log" format="txt">
            <filter>print_log == True</filter>
        </data>
        <data name="out_png_countdensity" format="png" />
        <data name="out_png_counts" format="png" />
        <data name="out_png_knee" format="png" />
        <data name="out_thresh" format="tabular" />
    </outputs>
    <tests>
        <test>
            <param name="type" value="single" />
            <param name="input_single" value="t_R2.fastq.gz" ftype="fastq" />
            <param name="bc_pattern" value="CCCCCCCCNNNNNNNN" />
            <param name="prime3" value="0" />
            <output name="out_whitelist" file="out_wl_single.txt" />
            <output name="out_log" file="out_wl_single.log" lines_diff="32" />
        </test>
    </tests>
    <help><![CDATA[


UMI-tools extract.py - Extract UMI from fastq
=============================================

Purpose
-------

Extract UMI barcode from a read and add it to the read name, leaving
any sample barcode in place. Can deal with paired end reads and UMIs
split across the paired ends

Options
-------

--split-barcode
       By default the UMI is assumed to be on the first read. Use this
       option if the UMI is contained on both reads and specify the
       pattern of the barcode/UMI on the second read using the option
       ``--bc-pattern2``

--bc-pattern
       Use this option to specify the format of the UMI/barcode. Use Ns to
       represent the random positions and Xs to indicate the bc positions.
       Bases with Ns will be extracted and added to the read name. Remaining
       bases, marked with an X will be reattached to the read.

       E.g. If the pattern is NNXXNN,
       Then the read:

       @HISEQ:87:00000000 read1
       AAGGTTGCTGATTGGATGGGCTAG
       DA1AEBFGGCG01DFH00B1FF0B
       +

       will become:
       @HISEQ:87:00000000_AATT read1
       GGGCTGATTGGATGGGCTAG
       1AFGGCG01DFH00B1FF0B
       +

--bc-pattern2
       Use this option to specify the format of the UMI/barcode for
       the second read pair if required. If --bc-pattern2 is not
       supplied, this defaults to the same pattern as --bc-pattern

--3prime
       By default the barcode is assumed to be on the 5' end of the read, but
       use this option to sepecify that it is on the 3' end instead

-L
       Specify a log file to retain logging information and final statistics

--split-barcode
       barcode is split across read pair

--quality-filter-threshold=QUALITY_FILTER_THRESHOLD
       Remove reads where any UMI base quality score falls
       below this threshold
--quality-encoding=QUALITY_ENCODING
       Quality score encoding. Choose from phred33[33-77]
       phred64 [64-106] or solexa [59-106]

Usage:
------

For single ended reads:
        umi_tools extract --bc-pattern=[PATTERN] -L extract.log [OPTIONS]

reads from stdin and outputs to stdout.

For paired end reads:
        umi_tools extract --bc-pattern=[PATTERN] --read2-in=[FASTQIN] --read2-out=[FASTQOUT] -L extract.log [OPTIONS]

reads end one from stdin and end two from FASTQIN and outputs end one to stdin
and end two to FASTQOUT.

    ]]></help>
    <expand macro="citations" />
</tool>
