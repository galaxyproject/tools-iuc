<tool id="icescreen" name="ICEscreen" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" python_template_version="3.7">
    <description>detects and annotates ICEs (Integrative and Conjugative Elements) and IMEs (Integrative and Mobilizable Elements) in Firmicutes genomes.</description>
    <macros>
        <token name="@TOOL_VERSION@">1.0.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">icescreen</requirement>
    </requirements>
    <version_command><![CDATA[
        icescreen --version
        ]]>
    </version_command>
    <command detect_errors="exit_code"><![CDATA[
        #from tempfile import mkdtemp
        #import os
        #set $gbname = os.path.splitext($genome.element_identifier)[0]
        #set $tmpfolder = mkdtemp()
        mkdir '${tmpfolder}'/source_genbank &&
        ln -s '${genome}' '${tmpfolder}'/source_genbank/'${gbname}'.gb &&
        icescreen --galaxy --gbdir '${tmpfolder}'/source_genbank --outdir '${tmpfolder}' --mode '${advanced.mode}' --jobs "\${GALAXY_SLOTS:-4}" > '${log}' 2>&1 &&
        cat '${tmpfolder}'/ICEscreen_results/results/'${gbname}'/detection_ME/'${gbname}'_detected_ME.summary > '${summary}' &&
        cat '${tmpfolder}'/ICEscreen_results/results/'${gbname}'/detection_ME/'${gbname}'_detected_SP_withMEIds.tsv > '${detected_sp}' &&
        cat '${tmpfolder}'/ICEscreen_results/results/'${gbname}'/detection_ME/'${gbname}'_detected_ME.tsv > '${detected_me}' &&
        cat '${tmpfolder}'/ICEscreen_results/results/'${gbname}'/visualization_files/'${gbname}'_icescreen.gb > '${gbout}' &&
        cat '${tmpfolder}'/ICEscreen_results/results/'${gbname}'/visualization_files/'${gbname}'_icescreen.gff > '${gffout}' &&
        cat '${tmpfolder}'/ICEscreen_results/results/'${gbname}'/visualization_files/'${gbname}'_icescreen.embl > '${emblout}' &&
        cp '${tmpfolder}'/ICEscreen_results/faa/'${gbname}'.faa '${tmpfolder}'/ICEscreen_results/results/'${gbname}'/'${gbname}'.faa &&
        cd '${tmpfolder}'/ICEscreen_results/results/'${gbname}' && zip -r - -- . > '${outzip}'
        ]]>
    </command>
    <inputs>
        <param name="genome" type="data" format="genbank" label="Input genomes to analyze in Genbank format" help=""/>
        <section name="advanced" title="(BETA) Advanced parameters" expanded="False">
            <param name="mode" type="boolean" checked="false" truevalue="streptomyces" falsevalue="firmicutes" label="(NOT RECOMMANDED - EXPERIMENTAL) Search ICEs and IMEs in Streptomyces genomes" help="Run ICEscreen with parameters adapted to search ICEs and IMEs in streptomyces genomes. However this feature is still work in progress and the accuracy of the results is not guaranteed."/>
        </section>
    </inputs>
    <outputs>
        <data format="txt" name="log" label="${tool.name} on ${on_string}: log file" />
        <data format="txt" name="summary" label="${tool.name} on ${on_string}: results summary" />
        <data format="tabular" name="detected_sp" label="${tool.name} on ${on_string}: detected Signature Proteins table" />
        <data format="tabular" name="detected_me" label="${tool.name} on ${on_string}: detected ICEs/IMEs table" />
        <data format="genbank" name="gbout" label="${tool.name} on ${on_string}: annotated genbank file" />
        <data format="gff3" name="gffout" label="${tool.name} on ${on_string}: annotated GFF3 file" />
        <data format="embl" name="emblout" label="${tool.name} on ${on_string}: annotated EMBL file" />
        <data format="zip" name="outzip" label="${tool.name} on ${on_string}: all results zipped"/>
    </outputs>
    <tests>
        <!-- Check a standard Firmicutes genome -->
        <test expect_num_outputs="8">
            <param name="genome" value="genbank/NC_004668_region_1961337-2265535.gb" ftype="genbank" />
            <output name="summary" file="NC_004668_region_1961337-2265535_detected_ME.summary" ftype="txt" />
            <output name="detected_sp" file="NC_004668_region_1961337-2265535_detected_SP_withMEIds.tsv" ftype="tabular" />
            <output name="detected_me" file="NC_004668_region_1961337-2265535_detected_ME.tsv" ftype="tabular" />
            <output name="emblout" file="NC_004668_region_1961337-2265535_icescreen.embl" ftype="embl" />
        </test>
    </tests>
    <help><![CDATA[
        .. class:: warningmark

        This tool requires *genbank* format.

-----

        **What it does**

        ICEscreen is a bioinformatic pipeline for the detection and annotation of ICEs (Integrative and Conjugative Elements) and IMEs (Integrative and Mobilizable Elements) in Firmicutes genomes. The full documentation is available at https://icescreen.migale.inrae.fr. The forge of the project is accessible at https://forgemia.inra.fr/ices_imes_analysis/icescreen.

        **Main features of ICEscreen**

        - Detection of signature proteins (SPs) of ICEs/IMEs by using blastP on a curated resource.	BlastP allows for an accurate assignment of hits to a given ICE/IME superfamily or family. The curated resource was derived from an analysis of over 120 ICEs and IMEs in Streptococcus genomes by the DINAMIC lab.
        - Detection of distant homologs of SPs by using HMM profiles of ICEs/IMEs protein families. The HMM profiles have been either imported from trusted resources or created and curated when needed.
        - Detection of the ICE/IME structures: ICEScreen groups together SPs that belong to the same ICE/IME structures to the best of its ability.
        - Delimitation of the elements at the gene or nucleotide level is not yet implemented and still needs manual curation.

        **Output files**

        There are 3 main output results files generated by ICEscreen:

        - Detected Signature Proteins table (`*_detected_SP_withMEIds.csv`): list of the signature proteins detected by the tool and their possible assignment to an ICE or IME element. It is a comma separated table of 48 columns with a one line header. Each line represents a signature protein detected by ICEscreen.
        - Detected ICEs/IMEs table (`*_detected_ME.tsv`): list of the ICEs and IMEs elements detected by the tool, including information about the signature proteins they contain. It is a tab separated table of 21 columns, the header is at line #3. Information in this file is similar to the output file _withICEIMEIds.csv (option -m) but centered around a list of ICE / IME structures instead of a list of SPs.
        - Results summary (`*_detected_ME.summary`): this file summarizes the main parameters and statistics regarding the ICE / IME structures and the SPs.

        Other files generated by ICEscreen:

        - Log file (`*_detected_ME.log`): this file contains the detailed internal details used by ICEscreen to generate the results and logs of each step of the ICEscreen tool pipeline.
        - Annotated Genbank, EMBL, and GFF3 files: tose files contains the annotations of the original Genbank file in addition to annotations added by ICEscreen such as ICEscreen signature proteins and mobile elements.
        - All results zipped file: You can download this file locally and unzip it to have the complete output folder generated by the tool, including intermediate processing files. See https://icescreen.migale.inrae.fr for details.


    ]]>

    </help>
    <citations>
        <citation type="bibtex">@UNPUBLISHED{Kim07aninterior-point,
                                             author = {Julie Lao and Thomas Lacroix and Gérard Guédon and Charles Coluzzi and Nathalie Leblond-Bourget and Hélène Chiapello},
                                             title = {"See our latest publication at https://icescreen.migale.inrae.fr."}}
        </citation>
    </citations>
</tool>
