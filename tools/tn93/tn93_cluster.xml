<tool id="tn93_cluster" name="TN93 Cluster" version="@VERSION@">
    <description>sequences that lie within a specific distance of each other</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="@VERSION@">tn93</requirement>
    </requirements>
    <version_command><![CDATA[tn93 --version]]></version_command>
    <command detect_errors="exit_code"><![CDATA[
    python '$__tool_directory__/cluster_wrapper.py' --input '$input_fasta' --output '$tn93_clusters'
    #if str($options.advanced) == 'advanced':
        --threshold $options.threshold
        --ambigs $options.ambigs
        --cluster-type $options.cluster_type
        --overlap $options.overlap
        --fraction $options.fraction
        $compress
    #end if
    ]]></command>
    <inputs>
        <param name="input_fasta" type="data" format="fasta" label="Input in FASTA format" />
        <param name="compress" type="boolean" truevalue="--compress" falsevalue="" label="Output additional fasta dataset with compressed clusters" />
        <conditional name="options">
            <param label="Additional options" name="advanced" type="select">
                <option value="defaults">Use defaults</option>
                <option value="advanced">Specify additional parameters</option>
            </param>
            <when value="defaults" />
            <when value="advanced">
                <param name="cluster_count" type="integer" value="1" label="Only retain this many clusters" />
                <param name="threshold" type="float" min="0" value="0.015" label="Distance threshold" help="Sequences which lie within this distance will be clustered" />
                <param name="ambigs" argument="-a" type="select" label="Strategy for ambiguous nucleotides">
                    <option value="handle">handle</option>
                    <option value="resolve">resolve</option>
                    <option value="average">average</option>
                    <option value="skip">skip</option>
                    <option value="gapmm">gapmm</option>
                </param>
                <param name="cluster_type" argument="-c" type="select" label="Clustering rules" help="&quot;all&quot;: Each sequence within the cluster must be within the specified distance of every other sequence in the cluster. &quot;any&quot; Each sequence within the cluster must be within the specified distance of at least one other sequence.">
                    <option value="all">All</option>
                    <option value="any">Any</option>
                </param>
                <param name="overlap" argument="-l" type="integer" value="100"
                    label="Only process pairs that overlap by at least N bases" />
                <param name="fraction" argument="-g" type="float" value="1.0"
                    label="Maximum tolerated fraction of ambiguous characters" />
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format="json" name="tn93_clusters" />
        <data format="fasta" name="tn93_compressed_clusters">
            <filter>compress</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="input_fasta" value="tn93-in1.fa" />
            <param name="advanced" value="advanced" />
            <param name="threshold" value="0.35" />
            <output file="tn93-out1.json" ftype="csv" name="tn93_clusters" sort="True" />
        </test>
        <test>
            <param name="input_fasta" value="tn93-in2-alpha.fa" />
            <param name="second_fasta" value="tn93-in2-beta.fa" />
            <param name="advanced" value="advanced" />
            <param name="threshold" value="0.35" />
            <output file="tn93-out2.csv" ftype="csv" name="tn93_clusters" sort="True" />
        </test>
    </tests>
    <help><![CDATA[
TN93
----

Cluster sequences that lie within a minimum distance of each other using the 
[Tamura Nei 93 distance](http://www.ncbi.nlm.nih.gov/pubmed/8336541) calculation.

]]></help>
    <expand macro="citations">
        <citation type="doi">10.1093/oxfordjournals.molbev.a040023</citation>
    </expand>
</tool>
