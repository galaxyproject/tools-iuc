<tool id="tb_profiler_collate" name="TB-Profiler Collate" version="@TOOL_VERSION@+galaxy1" profile="21.05">
  <description>Combines multiple TB-Profiler JSON reports into summary and variants reports</description>

  <macros>
    <import>macros.xml</import>
  </macros>

  <requirements>
    <requirement type="package" version="@TOOL_VERSION@">tb-profiler</requirement>
  </requirements>

  <expand macro="version_command"/>

  <command detect_errors="exit_code"><![CDATA[
    #for $dataset in $input_files
        python '$__tool_directory__/replace_id_field_with_element_id.py' '$dataset' '$dataset.element_identifier' &&
    #end for

    tb-profiler collate --dir .
  ]]></command>

  <inputs>
    <param type="data_collection" name="input_files" label="TB-Profiler JSON Reports" collection_type="list" format="json" help="Enter a list of TB-Profiler JSON reports to collate."/>
  </inputs>

  <outputs>  
    <data name="output_tabular" format="tabular" label="${tool.name} on ${on_string}: Summary Report (tabular)" from_work_dir="tbprofiler.txt">
        <actions>
            <action name="column_names" type="metadata" default="sample,main_lineage,sub_lineage,spoligotype,drtype,target_median_depth,pct_reads_mapped,num_reads_mapped,num_dr_variants,num_other_variants,rifampicin,isoniazid,ethambutol,pyrazinamide,moxifloxacin,levofloxacin,bedaquiline,delamanid,pretomanid,linezolid,streptomycin,amikacin,kanamycin,capreomycin,clofazimine,ethionamide,para-aminosalicylic_acid,cycloserine"/>
            <action type="metadata" name="detect_metadata"/>
        </actions>
    </data>
    <data name="output_csv" format="csv" label="${tool.name} on ${on_string}: Variants Report (CSV)" from_work_dir="tbprofiler.variants.csv"/>
    <data name="output_variants" format="txt" label="${tool.name} on ${on_string}: Variants Report (TXT)" from_work_dir="tbprofiler.variants.txt"/>
  </outputs>

  <tests>
      <test expect_num_outputs="3">
          <param name="input_files">
              <collection type="list">
                  <element name="ERR2510682" value="ERR2510682.results.json" ftype="json"/>
              </collection>
          </param>

          <output name="output_tabular" file="tbprofiler_test_1_sample.txt" ftype="tabular"/>
          <output name="output_csv" file="tbprofiler_test_1_sample.variants.csv"/>
          <output name="output_variants" file="tbprofiler_test_1_sample.variants.txt"/>
      </test>
  </tests>

  <help><![CDATA[
  TB-Profiler Collate Tool

  This tool combines multiple TB-Profiler JSON reports into consolidated outputs, summarizing lineage, antimicrobial resistance (AMR) profiles, and variants across samples.

  Inputs
  - A collection of TB-Profiler JSON reports generated from individual samples.

  Outputs
  1. Summary Report (tbprofiler.txt): Overview of sample lineages and AMR predictions.
  2. Variants CSV (tbprofiler.variants.csv): Table of identified variants across all samples.
  3. Variants Text (tbprofiler.variants.txt): Text file of variant details for quick inspection.

  Usage Notes
  - Ensure all input JSON files are valid TB-Profiler outputs.

  ]]></help>

  <citations>
      <citation type="doi">10.1186/s13073-019-0676-5</citation>
  </citations>

</tool>
