<tool id="create_archive" name="Create File Archive" version="0.1">
    <description>stores files in an archive for download or use</description>
    <command>
<![CDATA[
## Prepare folder
mkdir build;
#for $p in $path:
    ## Create path from cwd/build/...
    #set current_path = 'build/' +  '/'.join([ str($x.component) for $x in list($p.internal_path)])
    mkdir -p $current_path;

    ## Symlink files in
    #for $pf in $p.input_file:
        ## TODO: name conflicts cause failure to link. Names must be unique per directory
        ln $pf "$current_path/${pf.name}.${pf.ext}";
    #end for
#end for

## Create archive

#if str($format) == "tar":
    tar zcf $outfile -C build/ .;
#elif str($format) == "tgz":
    tar cf $outfile -C build/ .;
#elif str($format) == "zip":
    cd build/ && zip -r ${outfile}.zip * && mv ${outfile}.zip ${outfile};
#end if
]]>
    </command>
    <stdio>
        <exit_code range="1:" />
        <exit_code range=":-1" />
        <regex match="Error:" />
        <regex match="Exception:" />
    </stdio>
    <inputs>
        <repeat name="path" title="File Group" min="1">
            <param name="input_file" type="data" label="Files" multiple="True" />
            <repeat name="internal_path" type="text" title="Subdirectory inside the archive">
                <param name="component" type="text" label="Path name" />
            </repeat>
        </repeat>
        <param name="format" type="select" label="Archive Format">
            <option value="tgz" selected="True">Gzipped TAR</option>
            <option value="tar">TAR</option>
            <option value="zip">ZIP</option>
        </param>
    </inputs>
    <outputs>
        <data name="outfile" format="data" />
    </outputs>
    <tests>
        <test>
            <param name="input_file" value="input.txt" />
            <param name="component" value="etc" />
            <param name="format" value="zip" />
            <output name="outfile" file="test.zip" />
        </test>
        <test>
            <param name="input_file" value="input.txt" />
            <param name="component" value="etc" />
            <param name="format" value="tgz" />
            <output name="outfile" file="test.zip" />
        </test>
        <test>
            <param name="input_file" value="input.txt" />
            <param name="component" value="etc" />
            <param name="format" value="tar" />
            <output name="outfile" file="test.zip" />
        </test>
    </tests>
    <help>
**What it does**

Creates an archive of files. This can be useful as an end-of-workflow step
where you wish to prepare data in an achive for download.

**How to use it**

The tool is arranged such that you add files belonging in a single folder in a
batch together. Select a group of files, and then add the components of that
path in the repeat block. For example, adding a file from history named
"circos.conf" to the path conf/etc/circos.conf, would require that you select
that file, and add the path components "conf" and "etc".
    </help>
</tool>
