<macros>
    <xml name="requirements">
        <requirements>
            <requirement type="package">coverm</requirement>
        </requirements>
    </xml>
    <xml name="genome_opt">
        <conditional name="genome">
            <param name="ref_or_genome" type="select" label="Select if you want to specify genome file(s) or a FASTA reference file or both. NOTE: If genomic FASTA files are specified, then reference is not needed as a reference FASTA file can be derived by concatenating input genomes. However, while not necessary, reference can be specified if an alternate reference sequence set is desired.">
                <option value="genomic" selected="true">genome file(s)</option>
                <option value="reference">reference fasta file(s)</option>
                <option value="none">None (Only when BAM files are provided.)</option>
            </param>
            <when value="none">
            </when>
            <when value="genomic">
                <conditional name="genomic">
                    <param type="select" label="Reference genome source" name="source">
                        <option value="history" selected="true">History</option>
                        <option value="builtin">Built-in</option>
                    </param>
                    <when value="history">
                        <param type="data" name="fasta_history" multiple="true" label="FASTA files of each genome" format="fasta" />
                    </when>
                    <when value="builtin">
                        <param type="select" name="fasta_builtin" multiple="true" label="Reference genome(s)">
                            <options from_data_table="all_fasta" />
                        </param>
                    </when>
                </conditional>
            </when>
            <when value="reference">
                <conditional name="ref_genome">
                    <param type="select" label="Reference genome source" name="ref_source" help="FASTA file of contigs e.g. concatenated genomes or metagenome assembly, or minimap2 index (with --minimap2-reference-is-index),
                    or BWA index stem (with -p bwa-mem). If multiple references FASTA files are provided and 'sharded' is specified, then reads will be mapped to references separately as sharded BAMs.">
                        <option value="history" selected="true">History</option>
                        <option value="builtin">Built-in</option>
                    </param>
                    <when value="history">
                        <param type="data" name="ref_fasta_history" multiple="true" label="FASTA file(s) of contigs" format="fasta" />
                    </when>
                    <when value="builtin">
                        <param type="select" name="ref_fasta_builtin" multiple="true" label="FASTA file(s) of contigs">
                            <options from_data_table="all_fasta" />
                        </param>
                    </when>
                </conditional>
                <param type="boolean" name="ref_as_index" truevalue="--minimap2-reference-is-index" falsevalue="" optional="true" label="Treat reference as a minimap2 database, not as a FASTA file." />
                <param type="text" name="separator" optional="true" label="Character, that separates genome names from contig names in the reference file." >
                    <sanitizer>
                        <valid initial="string.punctuation">
                        </valid>
                    </sanitizer>
                </param>
                <param type="boolean" name="single_genome" truevalue="--single-genome" falsevalue="" optional="true" label="Treat the reference file as single genome" />
                <param type="data" name="genome_definition" format="tsv" optional="true" label="File containing newline-separated list of genome_name and contig, separated by tab, to define the genome of each contig." />
                <conditional name="add_genome">
                    <param name="add_genome" type="boolean" label="Add additional Genome Files"/>
                    <when value="true">
                        <conditional name="add_genomic">
                            <param type="select" label="Reference genome source" name="source">
                                <option value="history" selected="true">History</option>
                                <option value="builtin">Built-in</option>
                            </param>
                            <when value="history">
                                <param type="data" name="fasta_history" multiple="true" label="Single FASTA file of contigs" format="fasta" />
                            </when>
                            <when value="builtin">
                                <param type="select" name="fasta_builtin" multiple="true" label="Reference genome">
                                    <options from_data_table="all_fasta" />
                                </param>
                            </when>
                        </conditional>                           
                    </when>
                    <when value="false">
                    </when>
                </conditional>
            </when>
        </conditional>
    </xml>
    <xml name="genome">
        <conditional name="genome">
            <param name="ref_or_genome" type="select" label="Select if you want to specify genome file(s) or a FASTA reference file or both. NOTE: If genomic FASTA files are specified, then reference is not needed as a reference FASTA file can be derived by concatenating input genomes. However, while not necessary, reference can be specified if an alternate reference sequence set is desired.">
                <option value="genomic" selected="true">genome file(s)</option>
                <option value="reference">reference fasta file(s)</option>
            </param>
            <when value="genomic">
                <conditional name="genomic">
                    <param type="select" label="Reference genome source" name="source">
                        <option value="history" selected="true">History</option>
                        <option value="builtin">Built-in</option>
                    </param>
                    <when value="history">
                        <param type="data" name="fasta_history" multiple="true" label="FASTA files of each genome" format="fasta" />
                    </when>
                    <when value="builtin">
                        <param type="select" name="fasta_builtin" multiple="true" label="Reference genome(s)">
                            <options from_data_table="all_fasta" />
                        </param>
                    </when>
                </conditional>
            </when>
            <when value="reference">
                <conditional name="ref_genome">
                    <param type="select" label="Reference genome source" name="ref_source" help="FASTA file of contigs e.g. concatenated genomes or metagenome assembly, or minimap2 index (with --minimap2-reference-is-index),
                    or BWA index stem (with -p bwa-mem). If multiple references FASTA files are provided and 'sharded' is specified, then reads will be mapped to references separately as sharded BAMs.">
                        <option value="history" selected="true">History</option>
                        <option value="builtin">Built-in</option>
                    </param>
                    <when value="history">
                        <param type="data" name="ref_fasta_history" multiple="true" label="FASTA file(s) of contigs" format="fasta" />
                    </when>
                    <when value="builtin">
                        <param type="select" name="ref_fasta_builtin" multiple="true" label="FASTA file(s) of contigs">
                            <options from_data_table="all_fasta" />
                        </param>
                    </when>
                </conditional>
                <param type="boolean" name="ref_as_index" truevalue="--minimap2-reference-is-index" falsevalue="" optional="true" label="Treat reference as a minimap2 database, not as a FASTA file." />
                <param type="text" name="separator" optional="true" label="Character, that separates genome names from contig names in the reference file." >
                    <sanitizer>
                        <valid initial="string.punctuation">
                        </valid>
                    </sanitizer>
                </param>
                <param type="boolean" name="single_genome" truevalue="--single-genome" falsevalue="" optional="true" label="Treat the reference file as single genome" />
                <param type="data" name="genome_definition" format="tsv" optional="true" label="File containing newline-separated list of genome_name and contig, separated by tab, to define the genome of each contig." />
                <conditional name="add_genome">
                    <param name="add_genome" type="boolean" label="Add additional Genome Files"/>
                    <when value="true">
                        <conditional name="add_genomic">
                            <param type="select" label="Reference genome source" name="source">
                                <option value="history" selected="true">History</option>
                                <option value="builtin">Built-in</option>
                            </param>
                            <when value="history">
                                <param type="data" name="fasta_history" multiple="true" label="Single FASTA file of contigs" format="fasta" />
                            </when>
                            <when value="builtin">
                                <param type="select" name="fasta_builtin" multiple="true" label="Reference genome">
                                    <options from_data_table="all_fasta" />
                                </param>
                            </when>
                        </conditional>                           
                    </when>
                    <when value="false">
                    </when>
                </conditional>
            </when>
        </conditional>
    </xml>
    <xml name="reads">
        <conditional name="reads">
            <param type="select" label="Read type" name="read_type">
                <option value="paired">Paired end</option>
                <option value="paired_collection" selected="true">Paired collection</option>
                <option value="single">Single ended</option>
                <option value="interleaved">Interleaved</option>
                <option value="bam">BAM file(s)</option>
            </param>
            <when value="paired">
                <param type="data" format="@INPUT_FORMATS@" name="read1" multiple="true" label="Read1" />
                <param type="data" format="@INPUT_FORMATS@" name="read2" multiple="true" label="Read2" />
                <expand macro="genome"/>
            </when>
            <when value="paired_collection">
                <param type="data_collection" collection_type="list:paired" format="@INPUT_FORMATS@" name="paired_reads" label="One or more pairs of forward and reverse possibly gzipped FASTA/Q files for mapping in order" />
                <expand macro="genome"/>
            </when>
            <when value="single">
                <param type="data" format="@INPUT_FORMATS@" name="single" label="Single Read" />
                <expand macro="genome"/>
            </when>
            <when value="interleaved">
                <param type="data" format="@INPUT_FORMATS@" multiple="true" name="single" label="Interleaved" />
                <expand macro="genome"/>
            </when>
            <when value="bam">
                <param type="data" format="bam" name="bam" multiple="true" label="BAM file(s)" help="BAM file(s). These must be reference sorted (e.g. with samtools sort) unless sharded is specified, in which case they must be read name sorted (e.g. with samtools sort -n). When specified, no read mapping algorithm is undertaken."/>
                <expand macro="genome_opt"/>
            </when>
        </conditional>
    </xml>
    <xml name="add_reads">
        <section name="add_reads" title="Add an additional read">
            <conditional name="extra_read">
                <param type="select" label="Read type" optional="true" name="read_type">
                    <option value="none" selected="true">None</option>
                    <option value="paired">Paired end</option>
                    <option value="paired_collection">Paired collection</option>
                    <option value="single">Single ended</option>
                    <option value="interleaved">Interleaved</option>
                    <option value="bam">BAM file(s)</option>
                </param>
                <when value="none">
                </when>
                <when value="paired">
                    <param type="data" format="@INPUT_FORMATS@" name="read1" multiple="true" label="Read1" />
                    <param type="data" format="@INPUT_FORMATS@" name="read2" multiple="true" label="Read2" />
                </when>
                <when value="paired_collection">
                    <param type="data_collection" collection_type="list:paired" format="@INPUT_FORMATS@" name="paired_reads" label="One or more pairs of forward and reverse possibly gzipped FASTA/Q files for mapping in order" />
                </when>
                <when value="single">
                    <param type="data" format="@INPUT_FORMATS@" name="single" label="Read1" />
                </when>
                <when value="interleaved">
                    <param type="data" format="@INPUT_FORMATS@" multiple="true" name="single" label="Interleaved" />
                </when>
                <when value="bam">
                    <param type="data" format="bam" name="bam" multiple="true" label="BAM file(s)" />
                </when>
            </conditional>
        </section>
    </xml>
    <xml name="mapping">
        <section name="mapping" title="Mapping" expanded="false">
            <param name="mapper" type="select" optional="true" label="Underlying mapping software used [default: minimap2-sr]." >
                <option value="minimap2-sr">minimap2 with '-x sr' option</option>
                <option value="minimap2-ont">minimap2 with '-x map-ont' option</option>
                <option value="minimap2-pb">minimap2 with '-x map-pb' option</option>
                <option value="minimap2-no-preset">minimap2 with no '-x' option</option>
                <option value="bwa-mem">bwa mem using default parameters</option>
            </param>
            <param name="minimap2_reference_is_index" type="boolean" truevalue="--minimap2-reference-is-index" falsevalue="" label="Treat reference as a minimap2 database, not as a FASTA file."/>
        </section>
    </xml>
    <xml name="al_thresh">
        <section name="al_thresh" title="Alignment Thresholding" expanded="false">
            <param name="min_read_aligned_length" type="integer" min="0" optional="true" label="Exclude reads with smaller numbers of aligned bases. default: 0" />
            <param name="min_read_percent_identity" type="float" min="0" max="100" optional="true" label="Exclude reads by overall percent identity e.g. 95 for 95%. default: 0" />
            <param name="min_read_aligned_percent" type="float" min="0" max="100" optional="true" label="Exclude reads by percent aligned bases e.g. 95 means 95% of the read's bases must be aligned. default: 0" />
            <param name="min_read_aligned_length_pair" type="integer" min="0" optional="true" label="Exclude pairs with smaller numbers of aligned bases. Implies --proper-pairs-only. default: 0" />
            <param name="min_read_percent_identity_pair" type="float" min="0" max="100" optional="true" label="Exclude pairs by overall percent identity e.g. 95 for 95%. Implies --proper-pairs-only. default: 0" />
            <param name="min_read_aligned_percent_pair" type="float" min="0" max="100" optional="true" label="Exclude reads by percent aligned bases e.g. 95 means 95% of the read's bases must be aligned. Implies --proper-pairs-only. default: 0" />
            <param name="proper_pairs_only" type="boolean" truevalue="--proper-pairs-only" falsevalue="" optional="true" label="Require reads to be mapped as proper pairs." />
            <param name="exclude_supplementary" type="boolean" truevalue="--exclude-supplementary" falsevalue="" optional="true" label="Exclude supplementary alignments." />
        </section>
    </xml>
    <xml name="coverage">
        <section name="cov" title="Coverage Calculation Options" expanded="false">
            <param name="methods" type="select" multiple="true" label="Method(s) for calculating coverage [default: mean]. A more thorough description of the different methods is available at https://github.com/wwood/CoverM\#calculation-methods but briefly">
                <option value="relative_abundance">(default) Percentage relative abundance of each genome, and the unmapped read percentage</option>
                <option value="mean">(default) Average number of aligned reads overlapping each position on the contig</option>
                <option value="trimmed_mean">Average number of aligned reads overlapping each position after removing the most deeply and shallow-ly covered positions. See --trim-min/--trim-max to adjust.</option>
                <option value="coverage_histogram">Histogram of coverage depths</option>
                <option value="covered_bases">Number of bases covered by 1 or more reads</option>
                <option value="variance">Variance of coverage depths</option>
                <option value="length">Length of each contig in base pairs</option>
                <option value="count">Number of reads aligned toq each contig. Note that a single read may be aligned to multiple contigs with supplementary alignments</option>
                <option value="metabat">("MetaBAT adjusted coverage") Coverage as defined in Kang et al 2015 https://doi.org/10.7717/peerj.1165</option>
                <option value="reads_per_base">Number of reads aligned divided by the length of the contig</option>
                <option value="rpkm"> 	Reads mapped per kilobase of contig, per million mapped reads</option>
                <option value="tpm">Transcripts Per Million as described in Li et al 2010 https://doi.org/10.1093/bioinformatics/btp692</option>
            </param>
            <param name="min_covered_fraction" type="integer" min="0" optional="true" label="Genomes with less coverage than this reported as having zero coverage. default: 10"/>
            <param name="contig_end_exclusion" type="integer" min="0" optional="true" label="Exclude bases at the ends of reference sequences from calculation default: 75"/>
            <param name="trim_min" type="integer" min="0" optional="true" label="Remove this smallest fraction of positions when calculating trimmed_mean default: 5"/>
            <param name="trim_max" type="integer" min="0" optional="true" label="Maximum fraction for trimmed_mean calculations default: 95"/>
        </section>
    </xml>
    <xml name="out">
        <section name="out" title="Output Options" expanded="false">
            <param name="output_format" type="select" optional="true" label="Shape of output: 'sparse' for long format, 'dense' for species-by-site. [default: dense]">
                <option value="dense">dense</option>
                <option value="sparse">sparse</option>
            </param>
            <param name="no_zeros" type="boolean" truevalue="--no_zeros" falsevalue="" optional="true" label="Omit printing of genomes that have zero coverage." />
        </section>
    </xml>
    <xml name="citations">
        <citations>
            <yield />
        </citations>
    </xml>
</macros>