<tool id="coverm-genome" name="CoverM-GENOME" version="@TOOL_VERSION@" python_template_version="3.5">
    <macros>
        <import>macros.xml</import>
        <token name="@INPUT_FORMATS@">fa,fna,fasta,fastq,fastq.gz,fasta.gz,fna.gz,fa.gz</token>
        <token name="@TOOL_VERSION@">0.2.1</token>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[

        coverm genome
            #if $reads.read_type == "paired":
                -1 "${" ".join(map(str, $reads.read1))}"
                -2 "${" ".join(map(str, $reads.read2))}"
            #end if
            #if $reads.read_type == "paired_collection":
                -c "{" ".join(map(str, $reads.paired_reads))}"
            #end if
            #if $reads.read_type == "single":
                --single $reads.read1
            #end if
            #if $reads.read_type == "interleaved":
                --interleaved "{" ".join(map(str, $reads.interleaved))}"
            #end if
            #if $reads.read_type == "bam":
                -b "{" ".join(map(str, $reads.bam))}"
            #end if
            #if $genome.source == "history":
                -f
                #for $input in $genome.ref_fasta_history:
                    $input
                #end for
            #end if
            #if $genome.source == "builtin":
                -f $genome.ref_fasta_builtin.fields.path
            #end if
            $ref_as_index
            #if $separator:
                -s $separator
            #end if
            $single_genome
            #if $genome_definition
                --genome-definition $genome_definition
            #end if

            $derep.dereplicate
            #if $derep.checkm-tab-table:
                --checkm-tab-table $derep.checkm-tab-table
            #end if
            #if $derep.genome-info:
                --genome-info $derep.genome-info
            #end if
            #if $derep.min-completeness:
                --min-completeness $derep.min-completeness
            #end if
            #if $derep.max-contamination:
                --max-contamination $derep.max-contamination
            #end if
            #if $derep.dereplication-ani:
                --dereplication-ani $derep.dereplication-ani
            #end if
            #if $derep.dereplication-aligned-fraction:
                --dereplication-aligned-fraction $derep.dereplication-aligned-fraction
            #end if
            #if $derep.dereplication-fragment-length:
                --dereplication-fragment-length $derep.dereplication-fragment-length
            #end if
            #if $derep.dereplication-prethreshold-ani:
                --dereplication-prethreshold-ani $derep.dereplication-prethreshold-ani
            #end if
            #if $derep.dereplication-quality-formula:
                --dereplication-quality-formula $derep.dereplication-quality-formula
            #end if
            #if $derep.dereplication-precluster-method:
                --dereplication-precluster-method $derep.dereplication-precluster-method
            #end if
            #if $derep.dereplication-output-cluster-definition:
                --dereplication-output-cluster-definition .
            #end if
            #if $derep.dereplication-output-representative-fasta-directory-copy:
                --dereplication-output-representative-fasta-directory-copy .
            #end if
            -o output.tsv

    ]]></command>
    <inputs>
        <expand macro="reads"/>
        <conditional name="genome">
            <param type="select" label="Reference genome source" name="source">
                <option value="history" selected="true">History</option>
                <option value="builtin">Built-in</option>
            </param>
            <when value="history">
                <param type="data" name="ref_fasta_history" multiple="true" label="Single FASTA file of contigs" format="fasta" />
            </when>
            <when value="builtin">
                <param type="select" name="ref_fasta_builtin" multiple="true" label="Reference genome">
                    <options from_data_table="all_fasta" />
                </param>
            </when>
        </conditional>
        <param type="boolean" name="ref_as_index" truevalue="--minimap2-reference-is-index" falsevalue="" optional="true" label="Treat reference as a minimap2 database, not as a FASTA file." />
        <param type="text" name="separator" optional="true" label="Character, that separates genome names from contig names in the reference file." >
            <option value=" ">Space</option>
            <option value=",">Comma</option>
            <option value=";">Semicolon</option>
            <option value="-">Hyphen</option>
        </param>
        <param type="boolean" name="single_genome" truevalue="--single-genome" falsevalue="" optional="true" label="Treat the reference file as single genome" />
        <param type="data" name="genome_definition" format="tsv" optional="true" label="File containing newline-separated list of genome_name and contig, separated by tab, to define the genome of each contig." />
        <section name="derep" title="Dereplication" expanded="false">
            <param name="dereplicate" label="Do genome dereplication via average nucleotide identity (ANI) - choose a genome to represent all within a small distance, using Dashing for preclustering and FastANI for final ANI calculation. When this flag is used, dereplication occurs transparently through the Galah method (https://github.com/wwood/galah)" type="boolean" truevalue="--dereplication" falsevalue="" optional="true" />
            <param name="checkm-tab-table" type="data" format="tsv" optional="true" label="CheckM tab table (i.e. the output of checkm .. --tab_table -f PATH ..) for defining genome quality, which is used both for filtering and to rank genomes during clustering." />
            <param name="genome-info" type="data" format="tsv" optional="true" label="dRep style genome info table for defining quality." />
            <param name="min-completeness" type="float" optional="true" min="0" max="1" label="Ignore genomes with less completeness than this percentage." />
            <param name="max-contamination" type="float" optional="true" min="0" max="1" label="Ignore genomes with more contamination than this percentage." />
            <param name="dereplication-ani" type="float" optional="true" min="0" label="Overall ANI level to dereplicate at with FastANI. default: 99" />
            <param name="dereplication-aligned-fraction" type="float" optional="true" min="0" label="Min aligned fraction of two genomes for clustering. default: 50" />
            <param name="dereplication-fragment-length" type="float" optional="true" min="0" label="Length of fragment used in FastANI calculation (i.e. --fragLen). default: 3000" />
            <param name="dereplication-prethreshold-ani" type="float" optional="true" min="0" label="Require at least this dashing-derived ANI for preclustering and to avoid FastANI on distant lineages within preclusters. default: 95" />
            <param type="text" name="dereplication-quality-formula" optional="true" label="Scoring function for genome quality [default: Parks2020_reduced]. One of:">
                <option value="Parks2020_reduced">(default) A quality formula described in Parks et. al. 2020 https://doi.org/10.1038/s41587-020-0501-8 (Supplementary Table 19) but only including those scoring criteria that can be calculated from the sequence without homology searching: completeness-5*contamination-5*num_contigs/100-5*num_ambiguous_bases/100000</option>
                <option value="completeness-4contamination">completeness-4*contamination</option>
                <option value="completeness-5contamination">completeness-5*contamination</option>
                <option value="dRep">completeness-5*contamination+contamination*(strain_heterogeneity/100)+0.5*log10(N50)</option>
            </param>
            <param type="text" name="dereplication-precluster-method" optional="true" label="method of calculating rough ANI for dereplication. 'dashing' for HyperLogLog, 'finch' for finch MinHash. default: dashing">
                <option value="dashing">HyperLogLog</option>
                <option value="finch">finch MinHash</option>
            </param>
            <param name="dereplication-output-cluster-definition" type="boolean" optional="true" label="Output a file of representative TAB member lines." />
            <param name="dereplication-output-representative-fasta-directory-copy" type="boolean" optional="true" label="Output representative genomes" />
        </section>
    </inputs>
    <outputs>
        <data name="output1" format="tsv" from_work_dir="./output.tsv"/>
    </outputs>
    <tests>
        <test>
            <param name="read_type" value="paired"/>
            <param name="read1" value="test1.fastq.gz"/>
            <param name="read2" value="test2.fastq.gz"/>
            <conditional name="genome">
                    <param name="source" value="history"/>
                    <param name="ref_fasta_history" value="reference1.fasta,reference2.fasta"/>
                    <param name="separator" value=" "/>
                    <param name="single_genome" value="true"/>
            </conditional>
            <output name="output1" ftype="tsv">
                <assert_contents>
                    <has_text text="unmapped"/>
                    <has_text text="100"/>
                    <has_n_lines n="4"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
</tool>