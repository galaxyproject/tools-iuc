<tool id="lemur" name="LEMUR" version="1.0.1+galaxy0" profile="25.0" license="MIT">
    <description>Multi-condition single-cell latent modeling analysis</description>

    <requirements>
        <requirement type="package" version="1.4.0">bioconductor-lemur</requirement>
        <requirement type="package" version="1.7.5">r-optparse</requirement>
        <requirement type="package" version="2.0.0">r-tidyverse</requirement>
        <requirement type="package" version="1.28.0">bioconductor-singlecellexperiment</requirement>
        <requirement type="package" version="0.2.3">r-uwot</requirement>
        <requirement type="package" version="3.5.2">r-ggplot2</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
Rscript '$__tool_directory__/lemur.R'
  --input_rds '$sce'
  --meta_table '$meta_table'
  --cell_id_column '$cell_id_column'
  --condition_column '$condition_column'
  #if str($batch_column):
  --batch_column '$batch_column'
  #end if
  --contrast_condition '$contrast_condition'
  --reference_condition '$reference_condition'
  --n_embedding '$n_embedding'
  --test_fraction '$test_fraction'
  --output_umap 'umap.$plot_format'
  --output_volcano 'volcano.$plot_format'
  --output_de 'de_results.tsv'
  #if str($sel_gene):
  --sel_gene '$sel_gene'
  --output_gene_umap 'gene_umap.$plot_format'
  --output_gene_hist 'gene_hist.$plot_format'
  --output_chr_scatter 'chr_scatter.$plot_format'
  --output_tumor_umap 'tumor_umap.$plot_format'
  --output_tumor_neigh 'tumor_neigh.tsv'
  --use_harmony '$use_harmony'
  --plot_format '$plot_format'
  --plot_width '$plot_width'
  --plot_height '$plot_height'
  --tumor_annotation_column '$tumor_annotation_column'
    ]]></command>

<inputs>
    <param name="sce" type="data" format="rds" label="SingleCellExperiment object (RDS)" />
    <param name="meta_table" type="data" format="tabular" label="Sample metadata table (TSV)" help="TSV file with one row per sample/cell. Must contain columns for condition and optionally for batch." />

    <param name="cell_id_column" type="data_column" data_ref="meta_table" label="Cell ID column" help="Column in metadata that contains the cell IDs matching colnames of SCE" />
    <param name="condition_column" type="data_column" data_ref="meta_table" label="Condition column" help="Select the condition column (e.g., treatment vs control). Only appears after loading metadata." />
    <param name="batch_column" type="data_column" data_ref="meta_table" optional="true" label="Batch column (optional)" help="Optional batch variable (e.g., patient ID). Only appears after loading metadata." />

    <param name="contrast_condition" type="text" value="panobinostat" label="Condition for contrast (e.g. treatment)" />
    <param name="reference_condition" type="text" value="ctrl" label="Reference condition (e.g. control)" />

    <param name="n_embedding" type="integer" min="1" value="15" label="Number of latent dimensions (embedding)" />
    <param name="test_fraction" type="float" value="0.5" min="0.01" max="0.99" label="Fraction of genes used for training" />

    <param name="use_harmony" type="boolean" truevalue="yes" falsevalue="no" checked="true" label="Apply Harmony alignment?" />
    <param name="sel_gene" type="text" optional="true" label="Gene ID for gene-specific plots (optional)" />

    <param name="plot_format" type="select" label="Plot format">
        <option value="pdf" selected="true">PDF</option>
        <option value="png">PNG</option>
        <option value="jpg">JPG</option>
    </param>

    <param name="plot_width" type="float" value="6" label="Plot width (in inches)" optional="true"/>
    <param name="plot_height" type="float" value="5" label="Plot height (in inches)" optional="true"/>

    <param name="tumor_annotation_column" type="text" value="chromosome"
           label="Tumor annotation column in rowData"
           help="Used for tumor classification. Default is 'chromosome'. Override if your SCE uses a different annotation column." />
</inputs>

<outputs>
    <data name="umap_plot" format="pdf" from_work_dir="umap.$plot_format" label="UMAP plot">
        <change_format>
            <when input="plot_format" value="png" format="png"/>
            <when input="plot_format" value="jpg" format="jpg"/>
        </change_format>
    </data>
    <data name="volcano_plot" format="pdf" from_work_dir="volcano.$plot_format" label="Volcano plot">
        <change_format>
            <when input="plot_format" value="png" format="png"/>
            <when input="plot_format" value="jpg" format="jpg"/>
        </change_format>
    </data>
    <data name="de_results" format="tabular" from_work_dir="de_results.tsv" label="LEMUR DE results" />
    <data name="gene_umap" format="pdf" from_work_dir="gene_umap.$plot_format" label="Gene UMAP plot">
        <change_format>
            <when input="plot_format" value="png" format="png"/>
            <when input="plot_format" value="jpg" format="jpg"/>
        </change_format>
    </data>
    <data name="gene_hist" format="pdf" from_work_dir="gene_hist.$plot_format" label="Gene histogram plot">
        <change_format>
            <when input="plot_format" value="png" format="png"/>
            <when input="plot_format" value="jpg" format="jpg"/>
        </change_format>
    </data>
    <data name="chr_scatter" format="pdf" from_work_dir="chr_scatter.$plot_format" label="Chromosome scatter plot">
        <change_format>
            <when input="plot_format" value="png" format="png"/>
            <when input="plot_format" value="jpg" format="jpg"/>
        </change_format>
    </data>
    <data name="tumor_umap" format="pdf" from_work_dir="tumor_umap.$plot_format" label="Tumor UMAP plot">
        <change_format>
            <when input="plot_format" value="png" format="png"/>
            <when input="plot_format" value="jpg" format="jpg"/>
        </change_format>
    </data>
    <data name="tumor_neigh" format="tabular" from_work_dir="tumor_neigh.tsv" label="Tumor neighborhood DE results" />
</outputs>

<tests>
    <!-- Test 1: PDF -->
    <test>
        <param name="sce" location="https://zenodo.org/record/16575009/files/glioblastoma_example_data.rds"/>
        <param name="meta_table" value="metadata.tsv"/>
        <param name="cell_id_column" value="11"/>
        <param name="condition_column" value="8"/>
        <param name="batch_column" value="1"/>
        <param name="contrast_condition" value="panobinostat"/>
        <param name="reference_condition" value="ctrl"/>
        <param name="n_embedding" value="15"/>
        <param name="test_fraction" value="0.5"/>
        <param name="sel_gene" value="ENSG00000210082"/>
        <param name="plot_format" value="pdf"/>
        <param name="plot_width" value="6"/>
        <param name="plot_height" value="5"/>
        <param name="tumor_annotation_column" value="chromosome"/>

        <output name="de_results" file="https://zenodo.org/record/16575009/files/de_results.tsv">
            <assert_contents>
                <has_line_matching expression="^name\tn_cells\t.*did_lfc$"/>
                <has_text text="ENSG00000210082"/>
            </assert_contents>
        </output>

        <output name="tumor_neigh" location="https://zenodo.org/record/16575009/files/tumor_neigh.tsv">
            <assert_contents>
                <has_line_matching expression="^name\tneighborhood\t.*did_lfc$"/>
                <has_text text="ENSG00000210082"/>
            </assert_contents>
        </output>

        <output name="umap_plot" location="https://zenodo.org/record/16575009/files/umap.pdf" compare="sim_size"/>
        <output name="volcano_plot" location="https://zenodo.org/record/16575009/files/volcano.pdf" compare="sim_size"/>
        <output name="gene_umap" location="https://zenodo.org/record/16575009/files/gene_umap.pdf" compare="sim_size"/>
        <output name="gene_hist" location="https://zenodo.org/record/16575009/files/gene_hist.pdf" compare="sim_size"/>
        <output name="chr_scatter" location="https://zenodo.org/record/16575009/files/chr_scatter.pdf" compare="sim_size"/>
        <output name="tumor_umap" location="https://zenodo.org/record/16575009/files/tumor_umap.pdf" compare="sim_size"/>
    </test>

    <!-- Test 2: PNG -->
    <!-- <test>
        <param name="sce" location="https://zenodo.org/record/16575009/files/glioblastoma_example_data.rds"/>
        <param name="meta_table" value="metadata.tsv"/>
        <param name="cell_id_column" value="11"/>
        <param name="condition_column" value="8"/>
        <param name="batch_column" value="1"/>
        <param name="contrast_condition" value="panobinostat"/>
        <param name="reference_condition" value="ctrl"/>
        <param name="n_embedding" value="15"/>
        <param name="test_fraction" value="0.5"/>
        <param name="sel_gene" value="ENSG00000210082"/>
        <param name="plot_format" value="png"/>
        <param name="plot_width" value="6"/>
        <param name="plot_height" value="5"/>
        <param name="tumor_annotation_column" value="chromosome"/>

        <output name="umap_plot" compare="sim_size" ftype="png"/>
        <output name="volcano_plot" compare="sim_size" ftype="png"/>
        <output name="gene_umap" compare="sim_size" ftype="png"/>
        <output name="gene_hist" compare="sim_size" ftype="png"/>
        <output name="chr_scatter" compare="sim_size" ftype="png"/>
        <output name="tumor_umap" compare="sim_size" ftype="png"/>

        <output name="de_results">
            <assert_contents>
                <has_line_matching expression="^name\tn_cells\t.*did_lfc$"/>
                <has_text text="ENSG00000210082"/>
            </assert_contents>
        </output>

        <output name="tumor_neigh">
            <assert_contents>
                <has_line_matching expression="^name\tneighborhood\t.*did_lfc$"/>
                <has_text text="ENSG00000210082"/>
            </assert_contents>
        </output>
    </test> -->

    <!-- Test 3: JPG -->
    <!-- <test>
        <param name="sce" location="https://zenodo.org/record/16575009/files/glioblastoma_example_data.rds"/>
        <param name="meta_table" value="metadata.tsv"/>
        <param name="cell_id_column" value="11"/>
        <param name="condition_column" value="8"/>
        <param name="batch_column" value="1"/>
        <param name="contrast_condition" value="panobinostat"/>
        <param name="reference_condition" value="ctrl"/>
        <param name="n_embedding" value="15"/>
        <param name="test_fraction" value="0.5"/>
        <param name="sel_gene" value="ENSG00000210082"/>
        <param name="plot_format" value="jpg"/>
        <param name="plot_width" value="6"/>
        <param name="plot_height" value="5"/>
        <param name="tumor_annotation_column" value="chromosome"/>

        <output name="umap_plot" compare="sim_size" ftype="jpg"/>
        <output name="volcano_plot" compare="sim_size" ftype="jpg"/>
        <output name="gene_umap" compare="sim_size" ftype="jpg"/>
        <output name="gene_hist" compare="sim_size" ftype="jpg"/>
        <output name="chr_scatter" compare="sim_size" ftype="jpg"/>
        <output name="tumor_umap" compare="sim_size" ftype="jpg"/>

        <output name="de_results">
            <assert_contents>
                <has_line_matching expression="^name\tn_cells\t.*did_lfc$"/>
                <has_text text="ENSG00000210082"/>
            </assert_contents>
        </output>

        <output name="tumor_neigh">
            <assert_contents>
                <has_line_matching expression="^name\tneighborhood\t.*did_lfc$"/>
                <has_text text="ENSG00000210082"/>
            </assert_contents>
        </output>
    </test> -->
</tests>


    <help><![CDATA[
LEMUR identifies transcriptional differences across conditions in latent space using single-cell RNA-seq data.

**Inputs:**
- A `SingleCellExperiment` object in RDS format.
- Design formula indicating batch and condition variables.
- Parameters for dimensionality and model training.
- Optionally, a gene ID for extra gene-specific plots.
- Apply Harmony alignment: If selected, the latent space is aligned using Harmony before differential expression analysis.
- Selectable output format for all plots: PDF, PNG, or JPG.

**Why use `SingleCellExperiment` (SCE)?**
LEMUR uses the `SingleCellExperiment` (SCE) format because it is the standard Bioconductor structure for single-cell data in R. Unlike Seurat or AnnData, SCE is lightweight, interoperable, and not tied to a specific framework. It cleanly separates assays (e.g., expression values), cell metadata (`colData`), feature metadata (`rowData`), and reduced dimensions (`reducedDims`).

For LEMUR to work correctly, the SCE object **must include**:
- **`logcounts()`**: matrix of log-normalized gene expression.
- **`colData`**: must contain the variables referenced in the `design` formula (e.g., `patient_id`, `condition`).
- **`rowData`** (optional): for tumor plots, must contain a `chromosome` column with gene annotations.

You can easily convert Seurat objects using `as.SingleCellExperiment()` in R.

**Outputs:**
- UMAP plot
- Volcano plot
- Table of differentially expressed neighborhoods (without neighborhood list-column)
- Gene UMAP + histogram plots if a gene ID is given
- Tumor plots if chromosome data and thresholds are provided
    ]]></help>

    <citations>
        <citation type="doi">10.1038/s41588-024-01996-0</citation>
    </citations>
    <creator>
        <organization name="European Galaxy Team" url="https://galaxyproject.org/eu/"/>
        <person givenName="Diana" familyName="Chiang Jurado" email="dianachj@informatik.uni-freiburg.de"/>
    </creator>
</tool>