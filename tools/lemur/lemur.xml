<tool id="lemur" name="LEMUR" version="1.0.1+galaxy0" profile="25.0" license="MIT">
    <description>Multi-condition single-cell latent modeling analysis</description>

    <edam_topics>
        <edam_topic>topic_3945</edam_topic>
        <edam_topic>topic_3308</edam_topic>
    </edam_topics>
    <edam_operations>
        <edam_operation>operation_2945</edam_operation>
        <edam_operation>operation_2947</edam_operation>
        <edam_operation>operation_3432</edam_operation>
        <edam_operation>operation_3659</edam_operation>
        <edam_operation>operation_3560</edam_operation>
    </edam_operations>

    <requirements>
        <requirement type="package" version="1.4.0">bioconductor-lemur</requirement>
        <requirement type="package" version="1.7.5">r-optparse</requirement>
        <requirement type="package" version="2.0.0">r-tidyverse</requirement>
        <requirement type="package" version="1.28.0">bioconductor-singlecellexperiment</requirement>
        <requirement type="package" version="0.1.16">r-uwot</requirement>
    </requirements>    

    <command detect_errors="exit_code">
        <![CDATA[
        Rscript '$__tool_directory__/lemur.R'
          --input_rds '$sce'
          --design '$design_formula'
          --contrast 'cond(condition = "$contrast_condition") - cond(condition = "$reference_condition")'
          --n_embedding '$n_embedding'
          --test_fraction '$test_fraction'
          --output_umap 'umap.pdf'
          --output_volcano 'volcano.pdf'
          --output_de 'de_results.tsv'
          --sel_gene '$sel_gene'
          --output_gene_umap 'gene_umap.pdf'
          --output_gene_hist 'gene_hist.pdf'
          --output_chr_scatter 'chr_scatter.pdf'
          --output_tumor_umap 'tumor_umap.pdf'
          --output_tumor_neigh 'tumor_neigh.tsv'
        ]]>
    </command>

    <inputs>
        <param name="sce" type="data" format="rds" label="SingleCellExperiment object (RDS)" />
        <param name="design_formula" type="text" value="~ patient_id + condition" label="Design formula" />
        <param name="n_embedding" type="integer" min="1" value="15" label="Number of latent dimensions (embedding)" />
        <param name="test_fraction" type="float" value="0.5" min="0.01" max="0.99" label="Fraction of genes used for training" />
        <param name="contrast_condition" type="text" value="panobinostat" label="Condition for contrast (e.g. treatment)" />
        <param name="reference_condition" type="text" value="ctrl" label="Reference condition (e.g. control)" />
        <param name="sel_gene" type="text" value="ENSG00000210082" optional="true" label="Gene ID for gene-specific plots (optional)" />
    </inputs>

    <outputs>
        <data name="umap_pdf" format="pdf" from_work_dir="umap.pdf" label="UMAP plot" />
        <data name="volcano_pdf" format="pdf" from_work_dir="volcano.pdf" label="Volcano plot" />
        <data name="de_results" format="tabular" from_work_dir="de_results.tsv" label="LEMUR DE results" />
        <data name="gene_umap_pdf" format="pdf" from_work_dir="gene_umap.pdf" label="Gene UMAP plot" />
        <data name="gene_hist_pdf" format="pdf" from_work_dir="gene_hist.pdf" label="Gene histogram plot" />
        <data name="chr_scatter_pdf" format="pdf" from_work_dir="chr_scatter.pdf" label="Chromosome scatter plot" />
        <data name="tumor_umap_pdf" format="pdf" from_work_dir="tumor_umap.pdf" label="Tumor UMAP plot" />
        <data name="tumor_neigh" format="tabular" from_work_dir="tumor_neigh.tsv" label="Tumor neighborhood DE results" />
    </outputs>

    <tests>
        <test>
            <param name="sce" value="glioblastoma_example_data.rds"/>
            <param name="design_formula" value="~ patient_id + condition"/>
            <param name="n_embedding" value="15"/>
            <param name="test_fraction" value="0.5"/>
            <param name="contrast_condition" value="panobinostat"/>
            <param name="reference_condition" value="ctrl"/>
            <param name="sel_gene" value="ENSG00000210082"/>

            <output name="umap_pdf" file="umap.pdf" compare="sim_size"/>
            <output name="volcano_pdf" file="volcano.pdf" compare="sim_size"/>
            <output name="de_results" file="de_results.tsv" compare="contains"/>
            <output name="gene_umap_pdf" file="gene_umap.pdf" compare="sim_size"/>
            <output name="gene_hist_pdf" file="gene_hist.pdf" compare="sim_size"/>
            <output name="chr_scatter_pdf" file="chr_scatter.pdf" compare="sim_size"/>
            <output name="tumor_umap_pdf" file="tumor_umap.pdf" compare="sim_size"/>
            <output name="tumor_neigh" file="tumor_neigh.tsv" compare="contains"/>
        </test>
    </tests>

    <help><![CDATA[
LEMUR identifies transcriptional differences across conditions in latent space using single-cell RNA-seq data.

**Inputs:**
- A `SingleCellExperiment` object in RDS format.
- Design formula indicating batch and condition variables.
- Parameters for dimensionality and model training.
- Optionally, a gene ID for extra gene-specific plots.

**Outputs:**
- UMAP plot
- Volcano plot
- Table of differentially expressed neighborhoods (without neighborhood list-column)
- Gene UMAP + histogram plots if a gene ID is given
- Tumor plots if chromosome data and thresholds are provided
    ]]></help>

    <citations>
        <citation type="doi">10.1038/s41588-024-01996-0</citation>
    </citations>
</tool>