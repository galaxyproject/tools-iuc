<tool id="read2tree" name="Read2Tree" version="@TOOL_VERSION@" profile="24.0">
    <description>Infer a species tree from sequencing reads</description>
    <macros>
        <token name="@TOOL_VERSION@">2.0.1</token>
    </macros>

    <xrefs>
       <xref type="bio.tools">read2tree</xref>
    </xrefs>
    
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">read2tree</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[ 
        #import re
        mkdir -p ./genes_dir;

        #for $i, $f in enumerate($marker_genes)
            ln -s '$f' "./genes_dir/$i".fa;
        #end for

        #for $f in $reads
            #set readln = re.sub(r'[^\w\-\\.]', '_', str($f.element_identifier)) 
            ln -s '$f' './$readln';
        #end for

        read2tree --tree --standalone_path genes_dir --reads 
        #for $read in $reads
            #set readln = re.sub(r'[^\w\-\\.]', '_', str($f.element_identifier)) 
            "$readln"
        #end for
        --output_path ./output --dna_reference $dna_ref
    ]]></command>

    <inputs>
        <param argument="reads" type="data" multiple="true" format="fasta,fasta.gz,fastqsanger,fastqsanger.gz,fastqillumina,fastqillumina.gz" 
            label="Input reads in FASTA or FASTQ" help="Set of input reads for the species of interest."/>

        <param argument="marker_genes" type="data_collection" collection_type="list" format="fasta,fasta.gz"
            label="Marker gene files" help="A set of reference orthologous groups, i.e. protein sequences of the marker genes for the reference species. See https://github.com/DessimozLab/read2tree for an example and information on how to obtain a list of marker genes."/>

        <param argument="dna_ref" type="data" format="fasta,fasta.gz" label="DNA reference" 
            help="Reference file containing nucleotide sequences for the set of marker genes presented. See https://github.com/DessimozLab/read2tree for detail."/>
    </inputs>
    
    <outputs>
        <data name="output_tree" format="newick" from_work_dir="output/tree_*.nwk"/>
    </outputs>
    

    <tests>
        <test>
            <param name="reads" value="sample_1.fastq.gz,sample_2.fastq.gz" ftype="fastqsanger.gz"/>
            <param name="marker_genes">
                <collection type="list">
                    <element name="gene1" value="marker_genes/OMAGroup_649157.fa" ftype="fasta"/>
                    <element name="gene2" value="marker_genes/OMAGroup_649216.fa" ftype="fasta"/>
                    <element name="gene3" value="marker_genes/OMAGroup_671579.fa" ftype="fasta"/>
                    <element name="gene4" value="marker_genes/OMAGroup_681083.fa" ftype="fasta"/>
                    <element name="gene5" value="marker_genes/OMAGroup_681195.fa" ftype="fasta"/>
                    <element name="gene6" value="marker_genes/OMAGroup_671579.fa" ftype="fasta"/>
                    <element name="gene7" value="marker_genes/OMAGroup_683078.fa" ftype="fasta"/>
                    <element name="gene8" value="marker_genes/OMAGroup_894224.fa" ftype="fasta"/>
                    <element name="gene9" value="marker_genes/OMAGroup_898327.fa" ftype="fasta"/>
                    <element name="gene10" value="marker_genes/OMAGroup_944789.fa" ftype="fasta"/>
                    <element name="gene11" value="marker_genes/OMAGroup_974829.fa" ftype="fasta"/>
                    <element name="gene12" value="marker_genes/OMAGroup_1001241.fa" ftype="fasta"/>
                    <element name="gene13" value="marker_genes/OMAGroup_1008242.fa" ftype="fasta"/>
                    <element name="gene14" value="marker_genes/OMAGroup_1065415.fa" ftype="fasta"/>
                    <element name="gene15" value="marker_genes/OMAGroup_1121053.fa" ftype="fasta"/>
                    <element name="gene16" value="marker_genes/OMAGroup_1125645.fa" ftype="fasta"/>
                    <element name="gene17" value="marker_genes/OMAGroup_1133018.fa" ftype="fasta"/>
                    <element name="gene18" value="marker_genes/OMAGroup_1151179.fa" ftype="fasta"/>
                    <element name="gene19" value="marker_genes/OMAGroup_1163384.fa" ftype="fasta"/>
                    <element name="gene20" value="marker_genes/OMAGroup_1171372.fa" ftype="fasta"/>
                    <element name="gene21" value="marker_genes/OMAGroup_1188079.fa" ftype="fasta"/>
                </collection>
                </param>
            <param name="dna_ref" value="dna_ref.fa" ftype="fasta"/>
            <output name="output_tree" ftype="newick">
                <assert_contents>
                    <has_text_matching expression="sample_\d+" />
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
        read2tree is a software tool for generating alignment matrices and performing tree inference directly from sequencing reads. It leverages the OMA database and a set of input reads, bypassing many of the standard steps typically required in phylogenomic analysis. In particular, it avoids for read filtering, assembly, gene prediction, gene annotation, all-vs-all comparison, orthology prediction, alignment, and concatenation.
    ]]></help>

    <citations>
        <citation type="doi">10.1038/s41587-023-01753-4</citation>
    </citations>


</tool>
