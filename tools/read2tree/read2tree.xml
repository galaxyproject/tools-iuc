<tool id="read2tree" name="Read2Tree" version="0.1.0" python_template_version="3.5">
    <description>Infer a species tree from sequencing reads</description>

    <requirements>
        <requirement type="package" version="2.0.1">read2tree</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        echo "`pwd`" > '/home/nikolai/dev/galaxy-read2tree/pwd.out';
        
        rm -rf ./genes_dir; 
        rm -rf ./output;
        
        mkdir -p ./genes_dir;

        #set $i = 0
        #for $f in $marker_genes
            #set $i = $i + 1
            ln -s -- `readlink -f $f` "./genes_dir/$i".fa;
        #end for

        #for $f in $reads
            ln -s -- `readlink -f $f` "./$f.name";
        #end for

        read2tree --tree --standalone_path `realpath genes_dir` --reads 
        #for $read in $reads
            $read.name
        #end for
        --output_path ./output --dna_reference $dna_ref > ./r2t.out 2> ./r2t.err;

        ln -s -- `find output -type f -name "tree_*.nwk"` "./tree.nwk";

        { cat ./r2t.out; cat ./r2t.err >&2; }
    ]]></command>

    <inputs>
        <param name="reads" type="data" multiple="true" format="fasta,fastq" label="Input reads in FASTA or FASTQ"
            help="Set of input reads for the species of interest."/>

        <!--param name="marker_genes" type="data" multiple="true" format="fasta" label="Marker genes"/-->

        <param name="marker_genes" type="data_collection" collection_type="list"
            label="Marker gene files" help="A set of reference orthologous groups, i.e. marker genes. See https://github.com/DessimozLab/read2tree for detail."/>

        <param name="dna_ref" type="data" format="fasta" label="DNA reference" 
            help="Reference file containing nucleotide sequences. See https://github.com/DessimozLab/read2tree for detail."/>
    </inputs>
    
    <outputs>
        <!--data name="output_tree" format="newick" label="Output tree" from_work_dir="$output_tree"/-->

        <data name="output_tree" format="newick" label="Output tree" from_work_dir="tree.nwk"/>
    </outputs>

    <tests>
        <test>
            <param name="reads" value="sample_1.fastq,sample_2.fastq"/>
            <param name="marker_genes">
                <collection type="list">
                    <element name="gene1" value="marker_genes/OMAGroup_649157.fa"/>
                    <element name="gene2" value="marker_genes/OMAGroup_649216.fa"/>
                    <element name="gene3" value="marker_genes/OMAGroup_671579.fa"/>
                    <element name="gene4" value="marker_genes/OMAGroup_681083.fa"/>
                    <element name="gene5" value="marker_genes/OMAGroup_681195.fa"/>
                    <element name="gene6" value="marker_genes/OMAGroup_671579.fa"/>
                    <element name="gene7" value="marker_genes/OMAGroup_683078.fa"/>
                    <element name="gene8" value="marker_genes/OMAGroup_894224.fa"/>
                    <element name="gene9" value="marker_genes/OMAGroup_898327.fa"/>
                    <element name="gene10" value="marker_genes/OMAGroup_944789.fa"/>
                    <element name="gene11" value="marker_genes/OMAGroup_974829.fa"/>
                    <element name="gene12" value="marker_genes/OMAGroup_1001241.fa"/>
                    <element name="gene13" value="marker_genes/OMAGroup_1008242.fa"/>
                    <element name="gene14" value="marker_genes/OMAGroup_1065415.fa"/>
                    <element name="gene15" value="marker_genes/OMAGroup_1121053.fa"/>
                    <element name="gene16" value="marker_genes/OMAGroup_1125645.fa"/>
                    <element name="gene17" value="marker_genes/OMAGroup_1133018.fa"/>
                    <element name="gene18" value="marker_genes/OMAGroup_1151179.fa"/>
                    <element name="gene19" value="marker_genes/OMAGroup_1163384.fa"/>
                    <element name="gene20" value="marker_genes/OMAGroup_1171372.fa"/>
                    <element name="gene21" value="marker_genes/OMAGroup_1188079.fa"/>
                </collection>
                </param>
            <param name="dna_ref" value="dna_ref.fa"/>
            <output name="output_tree">
                 <assert_contents>
                    <has_text text="sample_1:" />
                 </assert_contents>
            </output>
        </test>
    </tests>
    
    <help><![CDATA[
        read2tree is a software tool for generating alignment matrices and performing tree inference directly from sequencing reads. It leverages the OMA database and a set of input reads, bypassing many of the standard steps typically required in phylogenomic analysis. In particular, it avoids for read filtering, assembly, gene prediction, gene annotation, all-vs-all comparison, orthology prediction, alignment, and concatenation.
    ]]></help>

    <citations>
        <citation type="doi">10.1038/s41587-023-01753-4</citation>
   </citations>
</tool>