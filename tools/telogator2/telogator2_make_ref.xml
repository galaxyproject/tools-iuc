<tool id="telogator2_make_ref" name="Telogator2 Make Reference" version="@VERSION@+galaxy0" profile="@PROFILE@" license="MIT">
    <description>Create custom telogator reference from T2T assembly</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="edam_ontology"/>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
        make_telogator_ref
        -i '${input_fasta}'
        -o output_ref.fa
        -s '${sample_name}'

        ## Optional contig selection and remapping
        #if str($contigs.contig_list) != ''
            -c '${contigs.contig_list}'
        #end if
        #if str($contigs.remap_names) != ''
            -r '${contigs.remap_names}'
        #end if

        ## Optional kmer file
        #if $kmer_file
            -k '${kmer_file}'
        #end if

        ## Minimum telomere length
        -m '${min_tel_length}'

        ## Optional flags
        ${add_tel}
        ${plot}

        ## Move outputs
        && mv output_ref.fa '${output_fasta}'
        && mv output_ref.fa.fai '${output_fai}'

        ## Handle optional plots if they were generated
        #if $plot
            && if ls *telsignal*.png 1> /dev/null 2>&1; then
                mkdir -p plots &&
                mv *telsignal*.png plots/;
            fi
        #end if
    ]]></command>
    <inputs>
        <param name="input_fasta" type="data" format="fasta,fasta.gz" label="Input T2T reference FASTA" help="Telomere-to-telomere reference genome assembly in FASTA format (gzipped supported)"/>

        <param name="sample_name" argument="-s" type="text" value="sample" label="Sample name" help="Sample name to prepend to contig identifiers in the output">
            <validator type="regex" message="Sample name must contain only alphanumeric characters, underscores, and hyphens">^[a-zA-Z0-9_-]+$</validator>
        </param>

        <section name="contigs" title="Contig Selection and Remapping" expanded="false">
            <param name="contig_list" argument="-c" type="text" value="" optional="true" label="Sorted list of contigs" help="Comma-delimited list of contigs to include (e.g., chr1,chr2,chr3). Leave empty to include all contigs.">
                <sanitizer>
                    <valid initial="string.printable">
                        <remove value="&quot;"/>
                    </valid>
                </sanitizer>
            </param>
            <param name="remap_names" argument="-r" type="text" value="" optional="true" label="Remap contig names" help="Comma-delimited list to remap contig names (same order as contig list). Leave empty for no remapping.">
                <sanitizer>
                    <valid initial="string.printable">
                        <remove value="&quot;"/>
                    </valid>
                </sanitizer>
            </param>
        </section>

        <param name="kmer_file" argument="-k" type="data" format="txt" optional="true" label="Telomere kmers file" help="Optional telomere kmers file. If not provided, built-in defaults for human telomeres will be used."/>

        <param name="min_tel_length" argument="-m" type="integer" value="0" min="0" label="Minimum telomere length" help="Minimum telomere length required at contig ends (in base pairs)"/>

        <param name="add_tel" argument="--add-tel" type="boolean" truevalue="--add-tel" falsevalue="" checked="false" label="Include masked telomeres" help="Include masked telomeres as separate contigs in the output"/>

        <param name="plot" argument="--plot" type="boolean" truevalue="--plot" falsevalue="" checked="false" label="Generate telomere signal plots" help="Generate PNG plots showing telomere signals for each chromosome arm"/>
    </inputs>
    <outputs>
        <data name="output_fasta" format="fasta" label="${tool.name} on ${on_string}: Reference FASTA"/>
        <data name="output_fai" format="fasta.fai" label="${tool.name} on ${on_string}: Reference index"/>
        <collection name="plots" type="list" label="${tool.name} on ${on_string}: Telomere signal plots">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.png$" directory="plots" format="png"/>
            <filter>plot</filter>
        </collection>
    </outputs>
    <tests>
        <!-- Test 1: Basic usage with minimal parameters -->
        <test expect_num_outputs="2">
            <param name="input_fasta" value="t2t_subset.fa.gz"/>
            <param name="sample_name" value="test_sample"/>
            <output name="output_fasta">
                <assert_contents>
                    <has_text text=">test_sample"/>
                    <has_line_matching expression="^&gt;.*"/>
                    <has_line_matching expression="^[ACGTN]+$"/>
                </assert_contents>
            </output>
            <output name="output_fai">
                <assert_contents>
                    <has_text text="test_sample"/>
                    <has_n_columns n="5"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: With contig selection and minimum telomere length -->
        <test expect_num_outputs="2">
            <param name="input_fasta" value="t2t_subset.fa.gz"/>
            <param name="sample_name" value="test_sample2"/>
            <section name="contigs">
                <param name="contig_list" value="t2t-i002c-mat_chr11p"/>
            </section>
            <param name="min_tel_length" value="5000"/>
            <output name="output_fasta">
                <assert_contents>
                    <has_text text=">test_sample2"/>
                </assert_contents>
            </output>
            <output name="output_fai">
                <assert_contents>
                    <has_text text="test_sample2"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: With add-tel flag -->
        <test expect_num_outputs="2">
            <param name="input_fasta" value="t2t_subset.fa.gz"/>
            <param name="sample_name" value="test_sample3"/>
            <param name="add_tel" value="true"/>
            <output name="output_fasta">
                <assert_contents>
                    <has_text text=">test_sample3"/>
                </assert_contents>
            </output>
            <output name="output_fai">
                <assert_contents>
                    <has_text text="test_sample3"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 4: With plot generation -->
        <test expect_num_outputs="3">
            <param name="input_fasta" value="t2t_subset.fa.gz"/>
            <param name="sample_name" value="test_sample4"/>
            <param name="plot" value="true"/>
            <output name="output_fasta">
                <assert_contents>
                    <has_text text=">test_sample4"/>
                </assert_contents>
            </output>
            <output name="output_fai">
                <assert_contents>
                    <has_text text="test_sample4"/>
                </assert_contents>
            </output>
            <output_collection name="plots" type="list">
                <element name=".+telsignal_.+">
                    <assert_contents>
                        <has_size min="1000"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

Telogator2 Make Reference creates a custom telogator reference database from a telomere-to-telomere (T2T) reference genome assembly. This tool is essential for analyzing telomeres in non-human organisms or custom genome assemblies.

The tool performs the following steps:

1. Reads the input T2T reference FASTA file
2. Identifies telomeric sequences at contig ends
3. Optionally filters and remaps contigs
4. Creates a processed reference suitable for telogator2 analysis
5. Generates an index file (.fai) for the reference
6. Optionally generates visualization plots of telomere signals

**When to use this tool**

Use this tool when you need to:

- Analyze telomeres in non-human organisms (e.g., mouse, maize, other species)
- Work with custom or newly assembled T2T genomes
- Create a reference from alternative human T2T assemblies (T2T-yao, T2T-cn1, etc.)
- Prepare references with specific contig selections or naming conventions

**Inputs**

- **T2T reference FASTA**: A telomere-to-telomere reference genome assembly
- **Sample name**: Identifier prepended to contig names (use organism/assembly name)
- **Contig selection** (optional): Specify which contigs to include
- **Contig remapping** (optional): Rename contigs in the output
- **Telomere kmers file** (optional): Custom telomere repeat patterns for non-human organisms
- **Minimum telomere length**: Filter contigs by minimum telomere length at ends

**Outputs**

1. **Reference FASTA**: Processed telogator reference file ready for use with telogator2
2. **Reference index (.fai)**: Index file for the reference FASTA
3. **Telomere signal plots** (optional): PNG plots showing telomere signals for each chromosome arm

**Usage Examples**

**Example 1: Mouse T2T reference**

- Input: Mouse T2T assembly FASTA
- Sample name: mouse_t2t
- Telomere kmers: Mouse-specific kmers file
- This creates a reference for analyzing mouse telomeres

**Example 2: Human T2T with specific chromosomes**

- Input: Human T2T-CHM13 FASTA
- Sample name: chm13
- Contig list: chr1,chr2,chr3,chr4,chr5
- This creates a reference with only chromosomes 1-5

**Example 3: Custom assembly with plots**

- Input: Custom organism T2T assembly
- Sample name: custom_org_v1
- Generate plots: Yes
- This creates a reference and visualizations for quality control

**Important Notes**

- The input FASTA should be a high-quality T2T assembly with telomeres at contig ends
- The sample name should be descriptive (e.g., organism name, assembly version)
- For non-human organisms, provide a telomere kmers file matching the species' telomere repeats
- Generated plots are useful for verifying telomere presence and quality
- The output reference FASTA can be used with the main Telogator2 tool via the "Custom reference FASTA" parameter
- Contig remapping is useful for standardizing chromosome naming conventions

**After creating a reference**

Use the output reference FASTA file as input to the main Telogator2 tool:

1. Run Telogator2 with your sequencing reads
2. In "Reference Options", select your custom reference FASTA
3. If using non-human organisms, also provide the same telomere kmers file

    ]]></help>
    <expand macro="citations"/>
</tool>
