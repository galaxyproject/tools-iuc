<tool id="scvis_map" name="SCVIS map" version="@VERSION@+@GALAXY_VERSION@">
    <description>Parametric alternative to t-SNE for use in high-dimensional data analysis.</description>
    <macros>
        <import>scvis_macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="0.1.1">scvis_galaxy</requirement>
    </requirements>
    <command detect_errors="aggressive"><![CDATA[
@MAP@

scvis map --data_matrix_file '${datafile}'
--pretrained_model_file ckpt_files/train.ckpt
#if $datalabel:
    --data_label_file '${datalabel}'
#end if
#if $configfile:
    --config_file '${configfile}'
#end if
#if $norm.normalize == "Yes":
    --normalize '${norm.normal}'
#end if
&& mkdir plots
&& mkdir tsv
&& mv output/*.tsv tsv
&& mv output/*.png plots
      ]]></command>
    <inputs>
        <param name="datafile" type="data" format="tsv, tabular" label="Data Matrix File" help="Data matrix with first row as the column names"/>
        <param name="model" type="data_collection" format="ckpt" collection_type="list" label="Trained model folder" help="Folder with trained model from scvis train"/>
        <param name="datalabel" type="data" format="tsv, tabular" label="Optional Data Label File" optional="true" help="One column file with header provinding corresponding cluster information for each data point. Used for coloring plots."/>
        <param name="configfile" type="data" format="yaml" optional="true" label="Optional Config File" help="Config yaml file as specified in the scvis docs. Must be same file as was used in scvis_train"/>
        <conditional name="norm">
            <param name="normalize" type="select" label="Set Normalization Value?" help="Use same value as in scvis_train. If not selected, normalization will use maximum absolute value">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
            </param>
            <when value="No"/>
            <when value="Yes">
                <param name="normal" type="float" value="0.5" label="Normalization value" help="A positive float"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
      <collection name="graphs" type="list" label="Final graphical outputs">
          <discover_datasets pattern="__designation__" format="png" directory="plots" visible="false"/>
      </collection>
      <collection name="tsv" type="list" label="Final tsv outputs">
          <discover_datasets pattern="__designation__" format="tabular" directory="tsv" visible="false"/>
      </collection>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="datafile" value="minisynth.tsv"/>
            <param name="datalabel" value="minisynthlabel.tsv"/>
            <param name="model">
                <collection type="list">
                    <element name="checkpoint" ftype="ckpt" value="ckpt_files1/checkpoint" />
                    <element name="train.ckpt.data-00000-of-00001" ftype="ckpt" value="ckpt_files1/train.ckpt.data-00000-of-00001" />
                    <element name="train.ckpt.index" ftype="ckpt" value="ckpt_files1/train.ckpt.index" />
                    <element name="train.ckpt.meta" ftype="ckpt" value="ckpt_files1/train.ckpt.meta" />
                </collection>
            </param>
            <param name="configfile" value="configtest.yaml"/>
            <output_collection name="tsv" type="list">
                <element name="perplexity_10_regularizer_0.001_batch_size_99_learning_rate_0.01_latent_dimension_2_activation_ELU_seed_1_map.tsv" file="map1.tsv" ftype="tabular"/>
            </output_collection>
            <output_collection name="graphs" type="list">
                <element name="perplexity_10_regularizer_0.001_batch_size_99_learning_rate_0.01_latent_dimension_2_activation_ELU_seed_1_map.png" file="map1.png" ftype="png"/>
            </output_collection>
        </test>
        <test expect_num_outputs="2">
            <param name="datafile" value="minisynth.tsv"/>
            <param name="datalabel" value="minisynthlabel.tsv"/>
            <param name="model">
                <collection type="list">
                    <element name="checkpoint" ftype="ckpt" value="ckpt_files2/checkpoint" />
                    <element name="train.ckpt.data-00000-of-00001" ftype="ckpt" value="ckpt_files2/train.ckpt.data-00000-of-00001" />
                    <element name="train.ckpt.index" ftype="ckpt" value="ckpt_files2/train.ckpt.index" />
                    <element name="train.ckpt.meta" ftype="ckpt" value="ckpt_files2/train.ckpt.meta" />
                </collection>
            </param>
            <param name="normalize" value="Yes"/>
            <param name="normal" value="0.5"/>
            <output_collection name="graphs" type="list">
                <element name="perplexity_10_regularizer_0.001_batch_size_99_learning_rate_0.01_latent_dimension_2_activation_ELU_seed_1_map_log_likelihood.png" file="logmap1.png" ftype="png" compare="sim_size"/>
            </output_collection>
        </test>
        <test expect_num_outputs="2">
            <param name="datafile" value="minisynth2.tsv"/>
            <param name="model">
                <collection type="list">
                    <element name="checkpoint" ftype="ckpt" value="ckpt_files1/checkpoint" />
                    <element name="train.ckpt.data-00000-of-00001" ftype="ckpt" value="ckpt_files1/train.ckpt.data-00000-of-00001" />
                    <element name="train.ckpt.index" ftype="ckpt" value="ckpt_files1/train.ckpt.index" />
                    <element name="train.ckpt.meta" ftype="ckpt" value="ckpt_files1/train.ckpt.meta" />
                </collection>
            </param>
            <param name="configfile" value="configtest.yaml"/>
            <output_collection name="tsv" type="list">
                <element name="perplexity_10_regularizer_0.001_batch_size_9_learning_rate_0.01_latent_dimension_2_activation_ELU_seed_1_map_log_likelihood.tsv" file="logmap2.tsv" ftype="tabular"/>
            </output_collection>
            <output_collection name="graphs" type="list">
                <element name="perplexity_10_regularizer_0.001_batch_size_9_learning_rate_0.01_latent_dimension_2_activation_ELU_seed_1_map_log_likelihood.png" file="logmap2.png" ftype="png"/>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
This tool is for the implementation of new data into a pretrained model. To train an initial model, use scvis train. For the model, pass the entire folder output from scvis train.
    ]]></help>
    <citations>
        <citation type="doi">10.1038/s41467-018-04368-5</citation>
    </citations>
</tool>
