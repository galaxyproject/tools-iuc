<tool id="obi_grep" name="obigrep" version="4.4.0" profile="25.1">
    <description>
        Filters sequence file
    </description>
    <macros/>
    <requirements>
        <requirement type="package" version="4.4.0">
            obitools4
        </requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" level="fatal" description="Error in Obitools execution"/>
    </stdio>
    <command>
    obigrep
    --no-progressbar
    ${v}
    #for $i in $repeat_obigrep
        #if str($i.options_grep.options_grep_selector) == 'sequence'
            -s ${i.options_grep.sequence}
        #else if str($i.options_grep.options_grep_selector) == 'definition'
            -D ${i.options_grep.definition}
        #else if str($i.options_grep.options_grep_selector) == 'identifier'
            -I ${i.options_grep.identifier}
        #else if str($i.options_grep.options_grep_selector) == 'idlist'
            --id-list ${i.options_grep.idlist}
        #else if str($i.options_grep.options_grep_selector) == 'attribute'
            #if $i.options_grep.marker == 'None'
                -a '${i.options_grep.attribute}'
            #else 
                -a '${i.options_grep.attribute}'='${i.options_grep.marker}'
            #end if
        #else if str($i.options_grep.options_grep_selector) == 'hasattribute'
            -A ${i.options_grep.hasattribute}
        #else if str($i.options_grep.options_grep_selector) == 'predicat'
            -p ${i.options_grep.predicat}
        #else if str($i.options_grep.options_grep_selector) == 'lmax'
            -L ${i.options_grep.lmax}
        #else if str($i.options_grep.options_grep_selector) == 'lmin'
            -l ${i.options_grep.lmin}
        #else if str($i.options_grep.options_grep_selector) == 'maxcount'
            -C ${i.options_grep.maxcount}
        #else if str($i.options_grep.options_grep_selector) == 'mincount'
            -c ${i.options_grep.mincount}
        #end if
    #end for

    #if $out_format
        --${out_format}-output
    #end if

    $input
        
    &gt; '$output'
    </command>
    <inputs>
        <param name="input" type="data" format="fasta,fastq" label="Input sequences file"/>
        <repeat name="repeat_obigrep" title="filter parameter" min="1">
            <conditional name="options_grep">
                <param name="options_grep_selector" type="select" label="Choose the sequence record selection option">
                    <option value="sequence" selected="true">sequence</option>
                    <option value="definition">definition</option>
                    <option value="identifier">identifier</option>
                    <option value="idlist">idlist</option>
                    <option value="attribute">attribute</option>
                    <option value="hasattribute">hasattribute</option>
                    <option value="predicat">predicat</option>
                    <option value="lmax">lmax</option>
                    <option value="lmin">lmin</option>
                    <option value="maxcount">maxcount</option>
                    <option value="mincount">mincount</option>
                </param>
                <when value="sequence">
                    <param name="sequence" type="text" label="Regular expression pattern to be tested against the sequence itself. The pattern is case insensitive." optional="false">
                        <sanitizer invalid_char="test">
                            <valid initial="default">
                            </valid>
                            <mapping initial="default">
                                <add source="&gt;" target="\&gt;"/>
                                <add source="&quot;" target="\&quot;"/>
                            </mapping>
                        </sanitizer>
                    </param>
                </when>
                <when value="definition">
                    <param name="definition" type="text" label="Regular expression pattern to be tested against the definition of the sequence record. The pattern is case sensitive." optional="false">
                        <sanitizer invalid_char="test">
                            <valid initial="default">
                            </valid>
                            <mapping initial="default">
                                <add source="&gt;" target="\&gt;"/>
                                <add source="&quot;" target="\&quot;"/>
                            </mapping>
                        </sanitizer>
                    </param>
                </when>
                <when value="identifier">
                    <param name="identifier" type="text" label="Regular expression pattern to be tested against the identifier of the sequence record. The pattern is case sensitive." optional="false">
                        <sanitizer invalid_char="test">
                            <valid initial="default">
                            </valid>
                            <mapping initial="default">
                                <add source="&gt;" target="\&gt;"/>
                                <add source="&quot;" target="\&quot;"/>
                            </mapping>
                        </sanitizer>
                    </param>
                </when>
                <when value="idlist">
                    <param name="idlist" type="data" format="txt,tabular" label="points to a text file containing the list of sequence record identifiers to be selected. The file format consists in a single identifier per line." optional="false"/>
                </when>
                <when value="attribute">
                    <param name="attribute" type="text" label="Regular expression pattern matched against the attributes of the sequence record. the value of this attribute is of the form : key=regular_pattern. The pattern is case sensitive." optional="false">
                        <sanitizer invalid_char="test">
                            <valid initial="default">
                            </valid>
                            <mapping initial="default">
                                <add source="&gt;" target="\&gt;"/>
                                <add source="&quot;" target="\&quot;"/>
                            </mapping>
                        </sanitizer>
                    </param>
                    <param name="marker" type="select" label="Select marker" help="Provide a marker to filter the sequence" optional="true">
                        <option value="None">None</option>                            
                        <option value="12S">12S</option>
                        <option value="16S">16S</option>
                        <option value="18S">18S</option>
                        <option value="28S">28S</option>
                        <option value="COI">COI</option>
                        <option value="COI-3P">CO1-3P</option>
                        <option value="COI-5P">CO1-5P</option>
                        <option value="COII">COII</option>
                        <option value="COXIII">COXIII</option>
                        <option value="CYTB">Cytb</option>
                        <option value="H3">H3</option>
                        <option value="ND1">ND1</option>
                        <option value="ND2">ND2</option>
                        <option value="ND3">ND3</option>
                        <option value="ND4">ND4</option>
                        <option value="ND4L">ND4L</option>
                        <option value="ND5-0">ND5-0</option>
                        <option value="ND6">ND6</option>
                        <option value="rbcl">rbcl</option>
                    </param>
                </when>
                <when value="hasattribute">
                    <param name="hasattribute" type="text" label="Selects sequence records having an attribute who is key." optional="false">
                        <sanitizer invalid_char="test">
                            <valid initial="default">
                            </valid>
                            <mapping initial="default">
                                <add source="&gt;" target="\&gt;"/>
                                <add source="&quot;" target="\&quot;"/>
                            </mapping>
                        </sanitizer>
                    </param>
                </when>
                <when value="predicat">
                    <param name="predicat" type="text" optional="false" label="Python boolean expression to be evaluated for each sequence record. The attribute keys defined for each sequence record can be used in the expression as variable names. An extra variable named 'sequence' refers to the sequence record itself. ex: annotations.mode!='join' if you want to keep only the sequences that don't have the mode:join on the annotation line">
                        <sanitizer invalid_char="test">
                            <valid initial="default">
                            </valid>
                            <mapping initial="default">
                                <add source="&gt;" target="\&gt;"/>
                                <add source="&quot;" target="\&quot;"/>
                            </mapping>
                        </sanitizer>
                    </param>
                </when>
                <when value="lmax">
                    <param name="lmax" type="text" label="lmax" optional="false" help="Keeps sequence records whose sequence length is equal or shorter than lmax"/>
                </when>
                <when value="lmin">
                    <param name="lmin" type="text" label="lmin" optional="false" help="Keeps sequence records whose sequence length is equal or longer than lmin"/>
                </when>
                <when value="maxcount">
                    <param name="maxcount" type="text" label="maxcount" optional="false" help="Keeps sequence records whose sequence count is equal or shorter than maxcount"/>
                </when>
                <when value="mincount">
                    <param name="mincount" type="text" label="mincount" optional="false" help="Keeps sequence records whose sequence count is equal or longer than mincount"/>
                </when>
            </conditional>
        </repeat>
        <param name="v" type="boolean" truevalue="-v" falsevalue="" checked="false" label="Invert the sequence record selection (option -v)"/>
        <param name="out_format" type="select" label="Output data type">
            <option value="fasta">
                fasta
            </option>
            <option value="fastq">
                fastq
            </option>
        </param>
    </inputs>
    <outputs>
        <data format="fastq" name="output" label="output with ${tool.name} on ${on_string}">
            <change_format>
                <when input="out_format" value="fasta" format="fasta"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="input" value="input_obigrep_test.fastq"/>
            <repeat name="repeat_obigrep">
                <conditional name="options_grep">
                    <param name="options_grep_selector" value="lmin"/>
                    <param name="lmin" value="150"/>
                </conditional>
            </repeat>
                <param name="v" value="true"/>
                <param name="out_format" value="fastq"/>

                <output name="output" file="output_obigrep1.fastq" ftype="fastq"/>
        </test>
        <test>
            <param name="input" value="input_obigrep_test.fastq"/>
            <repeat name="repeat_obigrep">
                <conditional name="options_grep">
                    <param name="options_grep_selector" value="predicat"/>
                    <param name="predicat" value="annotations.mode!='join'"/>
                </conditional>
            </repeat>
            <param name="v" value="false"/>
            <param name="out_format" value="fasta"/>
            <output name="output" file="output_obigrep2.fasta" ftype="fasta"/>
        </test>
        <test>
            <param name="input" value="input_obigrep_test.fasta"/>
            <repeat name="repeat_obigrep">
                <conditional name="options_grep">
                    <param name="options_grep_selector" value="mincount"/>
                    <param name="mincount" value="5"/>
                </conditional>
            </repeat>
            <repeat name="repeat_obigrep">
                <conditional name="options_grep">
                    <param name="options_grep_selector" value="attribute"/>
                    <param name="attribute" value="merged_sample"/>
                    <param name="marker" value="COI"/>
                </conditional>
            </repeat>
            <param name="v" value="false"/>
            <param name="out_format" value="fasta"/>
            <output name="output" file="output_obigrep3.fasta" ftype="fasta"/>
        </test>
    </tests>
    <help>
        .. class:: infomark

**What it does**

The obigrep command is in some way analog to the standard Unix grep command. It selects a subset of sequence records from a sequence file.

A sequence record is a complex object composed of an identifier, a set of attributes (key=value), a definition, and the sequence itself.

Instead of working text line by text line as the standard Unix tool, selection is done sequence record by sequence record. A large set of options allows refining selection on any of the sequence record elements.

Moreover obigrep allows specifying simultaneously several conditions (that take the value TRUE or FALSE) and only the sequence records that fulfill all the conditions (all conditions are TRUE) are selected.

Sequence record selection options :
* sequence     : Regular expression pattern to be tested against the sequence itself. ex: GAATTC

* definition   : Regular expression pattern to be tested against the definition of the sequence record. ex: [Cc]hloroplast

* identifier   : Regular expression pattern to be tested against the identifier of the sequence record. ex: ^GH

* idlist       : points to a text file containing the list of sequence record identifiers to be selected.

* attribute    : Regular expression pattern matched against the attributes of the sequence record. the value of this attribute is of the form : key:regular_pattern. ex:'family_name:Asteraceae'

* hasattribute : Selects sequence records having an attribute whose key = KEY.

* predicat     : Python boolean expression to be evaluated for each sequence record. The attribute keys defined for each sequence record can be used in the expression as variable names. An extra variable named ‘sequence’ refers to the sequence record itself. ex: annotations.mode!='join'

* lmax         : Keeps sequence records whose sequence length is equal or shorter than lmax. ex : 100

* lmin         : Selects sequence records whose sequence length is equal or longer than lmin. ex : 100

* maxcount     : Keeps sequence records whose sequence count is equal or shorter than lmax. ex : 50

* mincount     : Selects sequence records whose sequence count is equal or longer than lmin. ex : 5

--------

**Project links:**

`OBITools`_

.. _OBITools4: https://obitools4.metabarcoding.org/
    </help>
    <citations>
        <citation type="doi">
            10.1111/1755-0998.12428
        </citation>
    </citations>

</tool>
