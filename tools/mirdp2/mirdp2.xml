<tool id="mirdp2" name="miRDeep-p2" version="@TOOL_VERSION@+galaxy0">
    <description>identify miRNA genes in plant species</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="edam_ontology"/>
    <expand macro="requirements" />    
    <command detect_errors="exit_code"><![CDATA[
        #set large_genome = 4000000000
        mkdir -p output_folder
        #set index_path = ''
        && ln -s \$(dirname \$(which miRDP2-v1.1.4_pipeline.bash)) ./bin
        ##&& ln -s "pre-build scRNA index" ./bin/script/index/rfam_index
        #if str($indexed_genome.source) == "history":
            && bowtie2-build --threads \${GALAXY_SLOTS:-4} '$indexed_genome.own_file' genome
            && ln -s -f '$indexed_genome.own_file' genome.fa
            #set index_path = 'genome'
        #else:
            #set index_path = $indexed_genome.index.fields.path
        #end if
        && miRDP2-v1.1.4_pipeline.bash
        -T
        --genome '${reference_genome}'
        --index '$index_path'
        #if $input_sequence.ext.endswith('fasta') or $input_sequence.ext.endswith('fa')
            --fasta 
        #else
            --fastq
        #end if
        --input '${input_sequence}'
        --locate $advanced_options.locate
        --length $advanced_options.length
        --mismatch $advanced_options.mismatch
        --rpm $advanced_options.rpm
        --thread \${GALAXY_SLOTS:-1}
        #if $genome_size > $large_genome
            --large-index
        #end if
        --output output_folder
        #if $advanced_options.output_format == 'tabular'
            && mv output_folder/*/*_filter_P_prediction $predicted_mirna
        #else
            && mv output_folder/*/*_filter_P_prediction.bed $predicted_mirna
        #end if
    ]]>
    </command>    
    <inputs>
        <param name="reference_genome" type="data" format="fasta" label="Reference genome" help="Select a reference genome in FASTA format."/>
        <!-- indexed genome -->
        <conditional name="indexed_genome">
            <param name="source" type="select" label="Generate a reference genome index from your history or use a built-in index" help="Built-ins were indexed using default options. See Indexes section of help below">
              <option value="indexed">Use a built-in genome index</option>
              <option value="history">Use a genome from the history and build index</option>
            </param>
            <when value="indexed">
              <param name="index" type="select" label="Select reference genome" help="If your genome of interest is not listed, contact the Galaxy team">
                <options from_data_table="mirdp2_databases">
                  <filter type="sort_by" column="2"/>
                  <validator type="no_options" message="No indexes are available for the selected input dataset"/>
                </options>
              </param>
            </when>
            <when value="history">
              <param name="own_file" type="data" format="fasta" label="Select reference genome" />
            </when>
        </conditional>
        <param name="input_sequence" type="data" format="fasta,fastq,fastqsanger" label="Input sequences" help="Select the input sequences in FASTA format."/>
        <param name="genome_size" type="integer"  min="0" max="150000000000" value="" label="Reference genome size"/>
        <section name="advanced_options" title="Advanced options" expanded="True" help="Please be aware that changing these parameters would potentially affect performance and time consumption. In general, increase of parameter a and c and decrease of parameter d would generate a loose result and longer running time and vice versa.">
            <param argument="--locate" type="integer" min="0" max="50" value="15" label="Number of locations where a read can map"
                help="Reads map to too many sites are possibly associated with repeat sequences, and are not likely to related to miRNAs. The default setting is 15. For specific species, if there are miRNA families with many members, the first parameter may be increased manually to adapt to the genome landscape." />
            <param argument="--length" type="integer" min="0" max="500" value="300" label="Length of precursor candidates"
                help="Threshold of length of precursor candidates, default is 300."/>
            <param argument="--mismatch" type="integer" min="0" max="10" value="0" label="Allowed mismatches"
                help="Threshold of allowed mismatches for bowtie/bowtie2 mapping, default is 0." />
            <param argument="--rpm" type="integer" min="0" max="30" value="10" label="Reads RPM when filtering"
                help="To reduce time consumption and false positive, we filter reads by RPM. Only reads exceeded a certain RPM (Reads per million mapped reads) threshold may represent mature sequences of miRNAs rather than background noise, and would be kept for further analysis. The default setting is 10 (RPM)." />
            <param name="output_format" type="select" label="Output format">
                <option value="tabular" selected="True">Tabular</option>
                <option value="bed">BED</option>
            </param>
        </section>
    </inputs>
    <outputs>
        <data name="predicted_mirna" format="tabular"  label="${tool.name} on ${on_string}: predicted miRNAs">
            <change_format>
                <when input="advanced_options.output_format" value="bed" format="bed" />
            </change_format>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="history" />
                <param name="own_file" value="genome.fasta"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <section name="advanced_options">
                <param name="output_format" value="bed"/>
            </section>
            <output name="predicted_mirna" ftype="bed"/>
        </test>
        <test>
            <param name="genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="history" />
                <param name="own_file" value="genome.fasta"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <section name="advanced_options">
                <param name="output_format" value="tabular"/>
                <param name="locate" value="10"/>
            </section>
            <output name="predicted_mirna" ftype="tabular"/>
        </test>
        <test>
            <param name="genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="history" />
                <param name="own_file" value="genome.fasta"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <section name="advanced_options">
                <param name="output_format" value="bed"/>
                <param name="length" value="400"/>
            </section>
            <output name="predicted_mirna" ftype="bed"/>
        </test>
        <test>
            <param name="genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="history" />
                <param name="own_file" value="genome.fasta"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <section name="advanced_options">
                <param name="output_format" value="tabular"/>
                <param name="mismatch" value="10"/>
            </section>
            <output name="predicted_mirna" ftype="tabular"/>
        </test>
        <test>
            <param name="genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="history" />
                <param name="own_file" value="genome.fasta"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <section name="advanced_options">
                <param name="output_format" value="bed"/>
                <param name="rpm" value="20"/>
            </section>
            <output name="predicted_mirna" ftype="bed"/>
        </test>
        <test>
            <param name="genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="indexed" />
                <param name="index" value="test_entry"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <section name="advanced_options">
                <param name="output_format" value="bed"/>
            </section>
            <output name="predicted_mirna" ftype="bed"/>
        </test>
    </tests>
    <help>
    <![CDATA[
        Hello, world!
    ]]></help>
    <expand macro="citations" />
</tool>
