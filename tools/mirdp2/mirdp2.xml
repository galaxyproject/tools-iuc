<tool id="mirdp2" name="miRDeep-p2" version="@TOOL_VERSION@+galaxy0">
    <description>identify miRNA genes in plant species</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="edam_ontology"/>
    <expand macro="requirements" />    
    <command detect_errors="exit_code"><![CDATA[
        #set large_genome = 4000000000
        mkdir -p output_folder
        #set index_path = ''
        && ln -s \$(dirname \$(which miRDP2-v1.1.4_pipeline.bash)) ./bin
        ##&& ln -s "pre-build scRNA index" ./bin/script/index/rfam_index
        #if str($indexed_genome.source) == "history":
            && bowtie2-build --threads \${GALAXY_SLOTS:-4} '${indexed_genome.own_file}' genome
            && ln -s -f '${indexed_genome.own_file}' genome.fa
            #set index = 'genome'
        #else:
            #set index = ''.join([str($indexed_genome.index.fields.path),'/index'])
        #end if
        && miRDP2-v1.1.4_pipeline.bash
        -T
        --genome '${reference_genome}'
        --index '${index}'
        #if $input_sequence.ext.endswith('fasta') or $input_sequence.ext.endswith('fa')
            --fasta 
        #else
            --fastq
        #end if
        --input '${input_sequence}'
        --locate $advanced_options.locate
        --length $advanced_options.length
        --mismatch $advanced_options.mismatch
        --rpm $advanced_options.rpm
        --thread \${GALAXY_SLOTS:-1}
        #if $genome_size > $large_genome
            --large-index
        #end if
        --output output_folder
        && mv output_folder/*/*_filter_P_prediction $predicted_mirna_tabular
        && mv output_folder/*/*_filter_P_prediction.bed $predicted_mirna_bed
    ]]>
    </command>    
    <inputs>
        <param name="reference_genome" type="data" format="fasta" label="Reference genome" help="Select a reference genome in FASTA format."/>
        <!-- indexed genome -->
        <conditional name="indexed_genome">
            <param name="source" type="select" label="Generate a reference genome index from your history or use a built-in index" help="Built-ins were indexed using default options. See Indexes section of help below">
              <option value="indexed">Use a built-in genome index</option>
              <option value="history">Use a genome from the history and build index</option>
            </param>
            <when value="indexed">
              <param name="index" type="select" label="Select reference genome" help="If your genome of interest is not listed, contact the Galaxy team">
                <options from_data_table="mirdp2_databases">
                  <filter type="sort_by" column="2"/>
                  <validator type="no_options" message="No indexes are available for the selected input dataset"/>
                </options>
              </param>
            </when>
            <when value="history">
              <param name="own_file" type="data" format="fasta" label="Select reference genome" />
            </when>
        </conditional>
        <param name="input_sequence" type="data" format="fasta,fastq,fastqsanger" label="Input sequences" help="Select the input sequences in FASTA format."/>
        <param name="genome_size" type="integer"  min="0" max="150000000000" value="" label="Reference genome size"/>
        <section name="advanced_options" title="Advanced options" expanded="True" help="Please be aware that changing these parameters would potentially affect performance and time consumption. In general, increase of parameter a and c and decrease of parameter d would generate a loose result and longer running time and vice versa.">
            <param argument="--locate" type="integer" min="0" max="50" value="15" label="Number of locations where a read can map"
                help="Reads map to too many sites are possibly associated with repeat sequences, and are not likely to related to miRNAs. The default setting is 15. For specific species, if there are miRNA families with many members, the first parameter may be increased manually to adapt to the genome landscape." />
            <param argument="--length" type="integer" min="0" max="500" value="300" label="Length of precursor candidates"
                help="Threshold of length of precursor candidates, default is 300."/>
            <param argument="--mismatch" type="integer" min="0" max="10" value="0" label="Allowed mismatches"
                help="Threshold of allowed mismatches for bowtie/bowtie2 mapping, default is 0." />
            <param argument="--rpm" type="integer" min="0" max="30" value="10" label="Reads RPM when filtering"
                help="To reduce time consumption and false positive, we filter reads by RPM. Only reads exceeded a certain RPM (Reads per million mapped reads) threshold may represent mature sequences of miRNAs rather than background noise, and would be kept for further analysis. The default setting is 10 (RPM)." />
        </section>
    </inputs>
    <outputs>
        <data name="predicted_mirna_bed" format="bed"  label="${tool.name} on ${on_string}: predicted miRNAs (BED)"/>
        <data name="predicted_mirna_tabular" format="tabular"  label="${tool.name} on ${on_string}: predicted miRNAs"/>
    </outputs>
    <tests>
        <test>
            <param name="reference_genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="history" />
                <param name="own_file" value="genome.fasta"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <output name="predicted_mirna_bed" file="test_01.bed" ftype="bed"/>
            <output name="predicted_mirna_tabular" file="test_01.tabular" ftype="tabular"/>
        </test>
        <test>
            <param name="reference_genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="history" />
                <param name="own_file" value="genome.fasta"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <section name="advanced_options">
                <param name="locate" value="10"/>
            </section>
            <output name="predicted_mirna_bed" file="test_02.bed" ftype="bed"/>
            <output name="predicted_mirna_tabular" file="test_02.tabular" ftype="tabular"/>
        </test>
        <test>
            <param name="reference_genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="history" />
                <param name="own_file" value="genome.fasta"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <section name="advanced_options">
                <param name="length" value="400"/>
            </section>
            <output name="predicted_mirna_bed" file="test_03.bed" ftype="bed"/>
            <output name="predicted_mirna_tabular" file="test_03.tabular" ftype="tabular"/>     
        </test>
        <test>
            <param name="reference_genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="history" />
                <param name="own_file" value="genome.fasta"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <section name="advanced_options">
                <param name="mismatch" value="1"/>
            </section>
            <output name="predicted_mirna_bed" file="test_04.bed" ftype="bed"/>
            <output name="predicted_mirna_tabular" file="test_04.tabular" ftype="tabular"/>      
        </test>
        <test>
            <param name="reference_genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="history" />
                <param name="own_file" value="genome.fasta"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <section name="advanced_options">
                <param name="rpm" value="20"/>
            </section>
            <output name="predicted_mirna_bed" file="test_05.bed" ftype="bed"/>
            <output name="predicted_mirna_tabular" file="test_05.tabular" ftype="tabular"/>      
        </test>
        <test>
            <param name="reference_genome" value="genome.fasta" ftype="fasta"/>
            <conditional name="indexed_genome">
                <param name="source" value="indexed" />
                <param name="index" value="test_entry"/>
            </conditional>
            <param name="input_sequence" value="sample_test.fasta" ftype="fasta"/>
            <param name="genome_size" value="135000000"/>
            <output name="predicted_mirna_bed" file="test_06.bed" ftype="bed"/>
            <output name="predicted_mirna_tabular" file="test_06.tabular" ftype="tabular"/>      
        </test>
    </tests>
    <help>
    <![CDATA[

.. class:: infomark

**Purpose**

Based on ultra-deep sampling of small RNA libraries by next generation sequencing, miRDP2 is able to identify miRNA genes in plant species, even for those without detailed annotation, with extremely high speed and reliable performance.

-----

.. class:: infomark

**Formatting reads**

Before run the pipeline, the input reads must be preprocessed into proper format. First, the deep sequencing reads should have the adapters removed from 5' and 3' ends (if present).

Second, the deep sequencing reads must be parsed into FASTA format. Third, redundancy should be removed such that reads with identical sequence are represented with a single FASTA entry. Therefore, each sequence identifier must end with a '_x' and an integer, with the integer indicating the number of times the exact sequence was retrieved in the deep sequencing dataset.

-----

.. class:: infomark

**Redundancy and miRNAs**

In some cases, the output miRNAs from miRDP2 may differ from the known miRNAs. We found that this is mainly due to one of two reasons: heterogeneity of the mature miRNAs or the relative abundance of miRNA and miRNA*. We found that this does not impact the optimal length selection of precursors and the profiling of known miRNA genes.

-----

.. class:: infomark

**Basic functions**

The functions that miRDeep-p2 includes are described below:

        ::

            OPTIONS:

                NECESSARY:
                -g/--genome <file>        reference genome file in fasta format
                -x/--index <path>/prefix  bowtie index file corresponding to reference genome
                -f/--fasta                formatted sRNA-seq file in fasta format
                -q/--fastq                unformatted sRNA-seq file in fastq
                -i/--input                input file(s), multiple files are seperated by comma (,)
                -b/--batch                list file of input files
                -o/--output <path>        path to output folder

                OPTIONAL:
                -L/--locate <int>         THRESHOLD of different locations one read can map to, default is 15
                -N/--length <int>         THRESHOLD of length of precursor candidates, default is 300
                -M/--mismatch <int>       THRESHOLD of allowed mismatches for bowtie mapping, default is 0
                -R/--rpm <int>            THRESHOLD of reads rpm when filtering, default is 10
                -p/--thread <int>         number of thread used for RNAfold, default is 1
                --large-index             use this option when using large bowtie index, e.g. when using *.ebtwl files
                -h/--help                 print this help    

    ]]></help>
    <expand macro="citations" />
</tool>
