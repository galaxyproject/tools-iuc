<tool id="te_finder_1" name="TEfinder" version="1.0.1" profile="21.05">
    <description>A bioinformatics tool for detecting novel transposable element insertions</description>

    <requirements>
        <requirement type="package" version="1.15.1">samtools</requirement>
        <requirement type="package" version="2.30.0">bedtools</requirement>
        <requirement type="package" version="2.27.4">picard</requirement>
    </requirements>

    <command>
        <![CDATA[
            '$__tool_directory__/TEfinder' -fa '$required_inputs.FastaFile' -alignment '$required_inputs.alignmentFile' -gtf '$required_inputs.TransposonsInGenome' -te '$required_inputs.TransposonsToSearch' -bamo '$discordantreads' -outo '$teinsertion' -threads '\${GALAXY_SLOTS:-1}'
            #if str( $advanced.input_options.input_options_selector) == "advanced":
                -fis $($advanced.input_options.FragmentInsertSize)
                -md $($advanced.input_options.MaxDistanceForMerge)
                -k $($advanced.input_options.MaxTSDLength)
            #end if
            #if str( $advanced.input_options.OutFormat) == "gtf":
                -out $($advanced.input_options.OutFormat)
            #end if
        ]]>
    </command>

    <inputs>
        <!-- <param format="fasta" name="input" type="data" label="Source file"/> -->
        <section name="required_inputs" title="Required Inputs" expanded="True">
            <param name="FastaFile" type="data" format="fasta,fa,fna" label="Select reference genome FASTA index (FA/FASTA file)" />
            <param name="alignmentFile" type="data" format="bam,sam" label="Select sample reads aligned to reference genome (BAM/SAM file)" />
            <param name="TransposonsInGenome" type="data" format="gff,gtf" label="Select reference genome TE annotation (GFF/GTF file)" />
            <param name="TransposonsToSearch" type="data" format="text" label="Select TE names (single column text file)" />
        </section>
        <!-- Advanced Options  -->
        <section name="advanced" title="Advanced Options" expanded="False">
            <conditional name="input_options">
                <param name="input_options_selector" type="select" label="Input options">
                    <option value="defaults">Use default values</option>
                    <option value="advanced">Specify input options</option>
                </param>
                <when value="defaults" />
                <when value="advanced">
                    <param name="FragmentInsertSize" argument="-fis" type="integer" min="0" value="400" label="Short-read sequencing fragment insert size [400]" />
                    <param name="MaxDistanceForMerge" argument="-md" type="integer" min="0" value="150" label="Maximum distance between reads for bedtools merge" />
                    <param name="MaxTSDLength" argument="-k" type="integer" min="0" value="20" label="Maximum TE target site duplication (TSD) length" />
                    <param name="OutFormat" argument="-out" type="select" display="radio" label="Select output format as GTF [BED]" help="See help below for more details">
                        <option value="gtf">Other available format is GTF (-out gtf)</option>
                        <option value="bed" selected="True">Default format is BED</option>
                    </param>
                </when>
            </conditional>
        </section>
    </inputs>

    <outputs>
        <data format="bed" name="teinsertion" label="${tool.name} on ${on_string}: BED">
            <change_format>
                <when input="advanced.input_options.OutFormat" value="gtf" format="gtf"/>
            </change_format>
        </data>
        <data format="bam" name="discordantreads" />
    </outputs>

    <tests>
        <!-- Test for the most simple case for BED output : Running TEfinder with a .bam file and a .fasta file -->
        <test expected_num_outputs="2">
            <!-- TEfinder commands: TEfinder -alignment sample.bam -fa reference.fa -gtf TEs.gtf -te List_of_TEs.txt -->
            <param name="FastaFile" ftype="fasta" value="reference.fa"/>
            <param name="alignmentFile" ftype="bam,sam" value="sample.bam"/>
            <param name="TransposonsInGenome" ftype="gtf,gff" value="TEs.gtf"/>
            <param name="TransposonsToSearch" ftype="txt,tabular" value="List_of_TEs.txt"/>
            <conditional name="input_options">
                <param name="OutFormat" value="bed" />
            </conditional>

            <output name="teinsertion" file="TEinsertions.bed" />
            <output name="discordantreads" file="DiscordantReads.bam" />
        </test>
        <!-- Test for the GTF output -->
        <test expected_num_outputs="2">
            <!-- TEfinder commands: TEfinder -alignment sample.bam -fa reference.fa -gtf TEs.gtf -te List_of_TEs.txt -out gtf -->
            <param name="FastaFile" ftype="fasta" value="reference.fa"/>
            <param name="alignmentFile" ftype="bam,sam" value="sample.bam"/>
            <param name="TransposonsInGenome" ftype="gtf,gff" value="TEs.gtf"/>
            <param name="TransposonsToSearch" ftype="txt,tabular" value="List_of_TEs.txt"/>
            <conditional name="input_options">
                <param name="OutFormat" value="gtf" />
            </conditional>

            <output name="teinsertion" file="TEinsertions.gtf" />
            <output name="discordantreads" file="DiscordantReads.bam" />
        </test>
    </tests>

    <help>
        <![CDATA[
        A bioinformatics tool for detecting novel transposable element insertions

        Authors: Vista Sohrab & Dilay Hazal Ayhan

        TEfinder uses discordant reads to detect novel transposable element insertion events in paired-end sample sequencing data.

        **Output files**::

            TE_insertions.bed contains identified TE insertion events in sample (in the final column, FILTER attribute with "PASS" refers to high confidence insertion events while instances labeled as "in_repeat", "weak_evidence", "strand bias" or a combination of these three labels indicate less confident insertion events)
            
            TE_insertions.gtf is provided with the same information as the BED file if using -out GTF
            
            DiscordantReads.bam contains all discordant reads that have been identified based on the TEs of interest that have been submitted to TEfinder

        **Note**::

            Modifying the maximum TSD length (-k) could be useful if there is an unexpected number of insertion events identified with the default parameter. The optimal maximum TSD length can vary across datasets.
            Modifying the fragment insert size (-fis) based on the sequencing library preparation can be useful.

        ]]>
    </help>

    <citations>
        <citation type="doi">10.5281/zenodo.4479946</citation>
    </citations>

</tool>
