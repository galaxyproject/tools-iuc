<tool id="amas" name="AMAS" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="25.0">
    <description>Alignment manipulation (Concatenating, Replicating, Splitting)</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <xrefs>
        <xref type="bio.tools">amas</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">amas</requirement>
    </requirements>
    <version_command>AMAS.py -h</version_command>
    <command><![CDATA[
        ## Create symlinks with original filename for consistent tests
        mkdir -p input_data &&
        #for $f in $input_files
            ln -s '${f}' 'input_data/${f.element_identifier}' &&
        #end for

        AMAS.py
            ## Select action and any flags specific to the action
            #if $action.action_selector == "concat":
                $action.action_selector
                --part-format $part_format
            #end if
##            #if $action.action_selector == "replicate":
##                $action.action_selector
##                --rep-aln ''
##            #end if
##            #if $action.action_selector == "split":
##                '$action.action_selector'
##                --split-by ${split_by}
##                $remove-empty
##            #end if
            --in-files
            #for $f in $input_files
                'input_data/${f.element_identifier}'
            #end for
            --in-format $in_format
            --data-type $data_type
            --out-format $out_format
            $check_align
    ]]></command>
    <inputs>
        <param type="data" name="input_files" format="fasta,phylip,nex" label="Sequences to analyse" multiple="true" help="Can be an assembled genome or transcriptome (DNA), or protein sequences from an annotated gene set."/>
        <conditional name="action">
            <param name="action_selector" type="select" label="Action to perform">
                <option value="concat">Concatenate input alignments</option>
                <!--option value="convert">Convert to other file format</option-->
                <!--option value="replicate">Create replicate data sets for phylogenetic jackknife</option-->
                <!--option value="split">Split alignment according to a partitions file</option-->
                <!--option value="summary">Write alignment summary</option-->
            </param>
            <when value="concat">
                <param name="part_format" type="select" label="Format of the partitions file">
                    <option value="nexus">nexus</option>
                    <option value="raxml">raxml</option>
                    <option value="unspecified" selected="true">unspecified</option>
                </param>
            </when>
            <!--when value="convert"/-->
            <!--when value="replicate">
                <param name="rep_aln" type="text" value="replicates"/>
            </when-->
            <!--when value="split"> 
                <param type="data" name="split_by" format="txt" label="Partitions file to be used for concatenated alignment splitting" help="If you have a partition file, you can split a concatenated alignment and write a file for each partition"/>
                <param name="remove_empty" type="boolean" label="Remove taxa with sequences composed of only undetermined characters?" checked="false" truevalue="--><!--remove-empty" falsevalue=""/>
            </when--> 
            <!--when value="summary">

            </when-->
        </conditional>
        <param name="in_format" type="select" label="Format of the input file">
            <option value="fasta">fasta</option>
            <option value="phylip">phylip</option>
            <option value="phylip-int">phylip-int</option>
            <option value="nexus">nexus(sequential)</option>
            <option value="nexus-int">nexus(interleaved)</option>
        </param>
        <param name="data_type" type="select" label="Data type">
            <option value="aa">Protein alignments</option>
            <option value="dna">Nucleotide alignments</option>
        </param>
        <param name="out_format" type="select" label="Format of the output file (Not used for summary)">
            <option value="fasta">fasta</option>
            <option value="phylip">phylip</option>
            <option value="phylip-int">phylip-int</option>
            <option value="nexus">nexus(sequential)</option>
            <option value="nexus-int">nexus(interleaved)</option>
        </param>
        <param name="check_align" type="boolean" label="Check if input sequences are aligned"
               checked="false" truevalue="--check-align" falsevalue=""/>
    </inputs>
    <outputs>
        <!-- Concat option -->
        <data name="concat_output" from_work_dir="concatenated.out" format_source="out" label="Concatenated alignment (${out_format})">
            <filter>action["action_selector"] == "concat"</filter>
            <change_format>
                <when input="out_format" value="fasta" format="fasta"/>
                <when input="out_format" value="phylip" format="phylip"/>
                <when input="out_format" value="phylip-int" format="phylip"/>
                <when input="out_format" value="nexus" format="nex"/>
                <when input="out_format" value="nexus-int" format="nex"/>
            </change_format>
        </data>
        <data name="partitions_out" from_work_dir="partitions.txt" format="txt" label="Partition file">
            <filter>action["action_selector"] == "concat"</filter>
        </data>
        <!-- Split mode 
        <collection name="split_alignments" type="list" label="Split alignment files (${out_format})">
            <discover_datasets pattern="split_*" directory="." format="fasta"/>
            <filter>action["action_selector"] == "split"</filter>
        </collection> -->
        <!-- Replicate mode 
        <collection name="replicate_alignments" type="list" label="Replicate alignments (${out_format})">
            <discover_datasets pattern="replicate_*" directory="." format="fasta"/>
            <filter>action["action_selector"] == "replicate"</filter>
        </collection>  -->      
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="input_files" value="concat_1.fasta,concat_2.fasta" />
            <conditional name="action">
                <param name="action_selector" value="concat" />
                <param name="part_format" value="nexus" />
            </conditional>
            <param name="in_format" value="fasta" />
            <param name="data_type" value="dna" />
            <param name="out_format" value="phylip" />
            <param name="check_align" value="false" />

            <output name="concat_output" file="expected_concat.phylip" compare="sim_size" />
            <output name="partitions_out" file="expected_partitions.txt" />
        </test>
    </tests>
    <help><![CDATA[
        AMAS: Calculate summary statistics and manipulate multiple sequence alignments 

        AMAS works on amino acid and nucleotide alignments and combines capabilities of sequence manipulation with a function that calculates 
        basic statistics. The manipulation functions include conversions among popular formats, concatenation, extracting sites and splitting 
        according to a pre-defined partitioning scheme, creation of replicate data sets, and removal of taxa. The statistics calculated 
        include the number of taxa, alignment length, total count of matrix cells, overall number of undetermined characters, percent of 
        missing data, AT and GC contents (for DNA alignments), count and proportion of variable sites, count and proportion of parsimony 
        informative sites, and counts of all characters relevant for a nucleotide or amino acid alphabet. AMAS is particularly suitable for 
        very large alignments with hundreds of taxa and thousands of loci. It is computationally efficient, utilizes parallel processing, 
        and performs better at concatenation than other popular tools. AMAS is a Python 3 program that relies solely on Pythonâ€™s 
        core modules and needs no additional dependencies. 

        Note, The Tool Standard Output for concat will say "Wrote concatenated sequences to fasta file 'concatenated.out'"; however the file
        obtained will be renamed with the output format you have chosen (e.g. 'concatenated.fasta' for fasta, 'concatenated.nex' for nexus and nexus-int)

        AMAS source code and manual can be downloaded from http://github.com/marekborowiec/AMAS/ under GNU General Public License.
    ]]></help>
    <expand macro="citations"/>
</tool>