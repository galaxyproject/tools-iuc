<tool id="amas_replicate" name="AMAS replicate" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="25.0">
    <description>replicate multiple alignments</description>
    
    <macros>
        <import>macros.xml</import>
    </macros>

    <xrefs>
        <xref type="bio.tools">amas</xref>
    </xrefs>

    <expand macro="requirements" />
    <expand macro="version_command" />

    <command detect_errors="exit_code"><![CDATA[
        #import re
        set -eu;

        rm -rf "run_dir/action";
        mkdir -p "run_dir/action";

        ## Create symlinks with original filename for consistent tests
        #for $f in $input_files
            #set $safename_input = re.sub('[^\w\-_\.]', '_', $f.element_identifier)
            ln -s '${f}' "run_dir/action/${safename_input}";
        #end for

        cd "run_dir/action";

        python -m amas.AMAS
        replicate
        --rep-aln $replicate_replicates $replicate_loci
        --out-format $out_format
        --in-files
            #for $f in $input_files
                #set $safename_input = re.sub('[^\w\-_\.]', '_', $f.element_identifier)
                '${safename_input}'
            #end for
        --in-format $in_format
        --data-type $data_type
        --cores "\${GALAXY_SLOTS:-1}"
        $check_align
        ]]></command>

    <inputs>
        <param name="input_files" type="data" format="fasta,phylip,nex" label="Sequence to replicate" multiple="true" help="Provide pre-aligned FASTA/PHYLIP/NEXUS files (DNA or protein); mixes of unaligned reads or contigs will produce meaningless results." />
        <expand macro="input_format"/>
        <expand macro="output_format" label="Format of the replicate alignments output"/>
        <param name="replicate_replicates" type="integer" value="10" min="1" label="Number of replicate datasets to build" />
        <param name="replicate_loci" type="integer" value="2" min="1" label="Number of loci per replicate" />
        <param name="data_type" type="select" label="Data type">
            <option value="aa">Protein alignments</option>
            <option value="dna">Nucleotide alignments</option>
        </param>
        <param name="check_align" type="boolean" label="Check if input sequences are aligned" checked="false" truevalue="--check-align" falsevalue="" />
    </inputs>

    <outputs>
        <expand macro="collection_outputs" name="replicate_alignments" label="Replicate alignment files"/>
    </outputs>
    
    <tests>
        <test expect_num_outputs="1">
            <param name="input_files" value="inputs/fasta1.fas" />
            <param name="replicate_replicates" value="2" />
            <param name="replicate_loci" value="1" />
            <param name="out_format" value="nexus" />
            <param name="in_format" value="fasta" />
            <param name="data_type" value="dna" />
            <param name="check_align" value="false" />
            <output_collection name="replicate_alignments_nexus" type="list">
                <element name="replicate1_1-loci-out.nex" file="outputs/expected_replicate1.nex" />
                <element name="replicate2_1-loci-out.nex" file="outputs/expected_replicate2.nex" />
            </output_collection>
        </test>
    </tests>

    <help><![CDATA[
        AMAS (Alignment Manipulation And Summary) was written for modern phylogenomics workflows, where hundreds of taxa and thousands of loci are routinely analysed and summarised. It runs as a lean Python 3 program that depends only on the standard library yet still utilises multiprocessing to chew through very large amino-acid or nucleotide alignments. Drawing on Borowiec 2016 (PeerJ 4:e1660), AMAS combines format conversions, sequence manipulation, partition-aware slicing, replicate generation, and rich summary statistics (taxon counts, alignment length, matrix cells, missing data, AT/GC content, variable and parsimony-informative sites, plus alphabet frequencies). The wrapper surfaces the following sub-commands:

        * **replicate** — generate phylogenetic jack-knife replicates by sampling loci; users set the number of replicates and loci per replicate.

        Common arguments:

        1. `--in-files` (multi-select parameter in Galaxy).
        2. `--in-format` — `fasta`, `phylip`, `nexus`, `phylip-int`, or `nexus-int`.
        3. `--data-type` — `dna` or `aa`.
        4. `--check-align` verifies that sequences are aligned (disabled by default for performance).

        AMAS source code and manual: https://github.com/marekborowiec/AMAS
    ]]></help>

    <expand macro="citations" />
</tool>