<tool id="amas_concat" name="AMAS concat" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="25.0">
    <description>concatenate multiple alignments</description>

    <macros>
        <import>macros.xml</import>
    </macros>

    <xrefs>
        <xref type="bio.tools">amas</xref>
    </xrefs>

    <expand macro="requirements" />
    <expand macro="version_command" />

    <command detect_errors="exit_code"><![CDATA[
        #import re
        set -eu;

        rm -rf "run_dir/action";
        mkdir -p "run_dir/action";

        ## Create symlinks with original filename for consistent tests because
        ##  input filenames are used as str vars in the partitions.txt output
        #for $f in $input_files
            #set $safename_input = re.sub('[^\w\-_\.]', '_', $f.element_identifier)
            ln -s '${f}' "run_dir/action/${safename_input}";
        #end for

        cd "run_dir/action";

        python -m amas.AMAS
            concat
            --concat-part partitions.txt
            --concat-out concatenated.out
            --part-format $part_format
            --out-format $out_format
            --in-files
                #for $f in $input_files
                    #set $safename_input = re.sub('[^\w\-_\.]', '_', $f.element_identifier)
                    '${safename_input}'
                #end for
            --in-format $in_format
            --data-type $data_type
            --cores "\${GALAXY_SLOTS:-1}"
            $check_align
        ]]></command>

    <inputs>
        <param name="input_files" type="data" format="fasta,phylip,nex" label="Sequences to concatenate" multiple="true" 
               help="Provide pre-aligned FASTA/PHYLIP/NEXUS files (DNA or protein); mixes of unaligned reads or contigs will produce meaningless results." />
        <expand macro="input_format" />
        <expand macro="output_format" label="Format of the concatenated alignments output" />
        <param name="part_format" type="select" label="Format of the partitions file"
               help="A file defining how the concatenated alignment is split into separate gene/locus regions. Each line specifies a partition name and its position range (e.g., 'gene1 = 1-500' or 'DNA, gene1 = 1-500' for RAxML format)." />
            <option value="nexus">nexus</option>
            <option value="raxml">raxml</option>
            <option value="unspecified" selected="true">unspecified</option>
        </param>
        <param name="data_type" type="select" label="Data type">
            <option value="aa">Protein alignments</option>
            <option value="dna">Nucleotide alignments</option>
        </param>
        <param name="check_align" type="boolean" label="Check if input sequences are aligned" checked="false" truevalue="--check-align" falsevalue="" />
    </inputs>

    <outputs>
        <data name="output" from_work_dir="run_dir/action/concatenated.out" format="txt" label="Concatenated alignment">
            <change_format>
                <when input="out_format" value="fasta" format="fasta" />
                <when input="out_format" value="phylip" format="phylip" />
                <when input="out_format" value="phylip-int" format="phylip" />
                <when input="out_format" value="nexus" format="nex" />
                <when input="out_format" value="nexus-int" format="nex" />
            </change_format>
        </data>
        <data name="partitions_out" from_work_dir="run_dir/action/partitions.txt" format="txt" label="Partition file" />
    </outputs>

    <tests>
        <test expect_num_outputs="2">
            <param name="input_files" value="inputs/concat_1.fasta,inputs/concat_2.fasta" />
            <param name="out_format" value="phylip" />
            <param name="part_format" value="nexus" />
            <param name="in_format" value="fasta" />
            <param name="data_type" value="dna" />
            <param name="check_align" value="false" />
            <output name="output" file="outputs/expected_concat.phylip" compare="sim_size" />
            <output name="partitions_out" file="outputs/expected_partitions.txt" />
        </test>
        <test expect_num_outputs="2">
            <param name="input_files" value="inputs/concat_1.fasta,inputs/concat_2.fasta" />
            <param name="out_format" value="fasta" />
            <param name="part_format" value="raxml" />
            <param name="in_format" value="fasta" />
            <param name="data_type" value="dna" />
            <param name="check_align" value="false" />
            <output name="output" file="outputs/expected_concat_fasta.fas" compare="sim_size" />
            <output name="partitions_out" file="outputs/expected_partitions_raxml.txt" />
        </test>
    </tests>

    <help><![CDATA[
        **What it does**

        AMAS Concat combines multiple sequence alignments into a single concatenated alignment, commonly used in phylogenomic analyses when analyzing multiple genes or loci together.

        **Inputs**

        - **Multiple alignment files**: Select 2 or more pre-aligned sequence files (FASTA, PHYLIP, or NEXUS format)
        - **Input format**: Specify the format of your input files
        - **Data type**: Choose DNA for nucleotide sequences or Protein for amino acid sequences
        - **Output format**: Select the desired format for the concatenated alignment

        **Outputs**

        1. **Concatenated alignment**: A single file containing all input alignments joined end-to-end
        2. **Partitions file**: Defines the boundaries of each original alignment within the concatenated file

        **What is a partitions file?**

        The partitions file maps each gene/locus to its position in the concatenated alignment. This is essential for downstream phylogenetic analyses (e.g., RAxML, IQ-TREE) that can apply different evolutionary models to different partitions.

        **Example:**

        If you concatenate three genes:
        - gene1.fasta (500 bp)
        - gene2.fasta (700 bp)  
        - gene3.fasta (400 bp)

        The partitions file (unspecified format) will contain::

            gene1 = 1-500
            gene2 = 501-1200
            gene3 = 1201-1600

        **Partition formats:**

        - **Unspecified**: ``gene1 = 1-500``
        - **RAxML**: ``DNA, gene1 = 1-500``
        - **NEXUS**: ``charset gene1 = 1-500;``

        **Use cases**

        - **Multi-locus phylogenomics**: Combine hundreds of genes for species tree inference
        - **Partitioned phylogenetic analysis**: Apply different evolutionary models to different genes using tools like RAxML or IQ-TREE
        - **Supermatrix construction**: Create dataset for concatenation-based phylogenetic methods
        - **Increased phylogenetic signal**: Leverage information from multiple loci to resolve difficult nodes
        - **Comparative analyses**: Prepare datasets for testing hypotheses across multiple genomic regions

        **About AMAS**

        AMAS (Alignment Manipulation And Summary) is designed for modern phylogenomics workflows involving hundreds of taxa and thousands of loci.

        Source code and manual: https://github.com/marekborowiec/AMAS
    ]]></help>

    <expand macro="citations" />
</tool>