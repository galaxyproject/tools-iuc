<tool id="amas" name="AMAS" version="@TOOL_VERSION@+galaxy@WRAPPER_VERSION@" profile="25.0">
    <description>High-throughput alignment manipulation and statistics for large phylogenomics</description>
    <macros>
        <import>info.xml</import>
        <import>macros.xml</import>
    </macros>

    <xrefs>
        <xref type="bio.tools">amas</xref>
    </xrefs>

    <expand macro="requirements" />
    <expand macro="version_command" />
    <command detect_errors="exit_code"><![CDATA[
        #import re
        set -eu;

        rm -rf "run_dir/action";
        mkdir -p "run_dir/action";

        ## Create symlinks with original filename for consistent tests because
        ##  input filenames are used as str vars in the partitions.txt output
        #for $f in $input_files
            #set $safename_input = re.sub('[^\w\-_\.]', '_', $f.element_identifier)
            ln -s '${f}' "run_dir/action/${safename_input}";
        #end for

        cd "run_dir/action";

        python -m amas.AMAS
            concat
            --concat-part partitions.txt
            --concat-out concatenated.out
            --part-format $part_format
            --out-format $concat_out_format
            --in-files
            #for $f in $input_files
                #set $safename_input = re.sub('[^\w\-_\.]', '_', $f.element_identifier)
                '${safename_input}'
            #end for
            --in-format $in_format
            --data-type $data_type
            --cores "\${GALAXY_SLOTS:-1}"
            $check_align
        ]]></command>

    <inputs>
        <param name="input_files" type="data" format="fasta,phylip,nex" label="Sequences to analyse" multiple="true" help="Provide pre-aligned FASTA/PHYLIP/NEXUS files (DNA or protein); mixes of unaligned reads or contigs will produce meaningless results." />
        <expand macro="input_format"/>
        <expand macro="output_format" name="concat_out_format" label="Format of the concatenated alignments output"/>
        <param name="part_format" type="select" label="Format of the partitions file">
            <option value="nexus">nexus</option>
            <option value="raxml">raxml</option>
            <option value="unspecified" selected="true">unspecified</option>
        </param>
        <param name="data_type" type="select" label="Data type">
            <option value="aa">Protein alignments</option>
            <option value="dna">Nucleotide alignments</option>
        </param>
        <param name="check_align" type="boolean" label="Check if input sequences are aligned" checked="false" truevalue="--check-align" falsevalue="" />
    </inputs>

    <outputs>
        <data name="concat_output" from_work_dir="run_dir/action/concatenated.out" format="txt" label="Concatenated alignment">
            <change_format>
                <when input="concat_out_format" value="fasta" format="fasta" />
                <when input="concat_out_format" value="phylip" format="phylip" />
                <when input="concat_out_format" value="phylip-int" format="phylip" />
                <when input="concat_out_format" value="nexus" format="nex" />
                <when input="concat_out_format" value="nexus-int" format="nex" />
            </change_format>
        </data>
        <data name="partitions_out" from_work_dir="run_dir/action/partitions.txt" format="txt" label="Partition file" />
    </outputs>

    <tests>
        <test expect_num_outputs="2">
            <param name="input_files" value="inputs/concat_1.fasta,inputs/concat_2.fasta" />
            <param name="concat_out_format" value="phylip" />
            <param name="part_format" value="nexus" />
            <param name="in_format" value="fasta" />
            <param name="data_type" value="dna" />
            <param name="check_align" value="false" />
            <output name="concat_output" file="outputs/expected_concat.phylip" compare="sim_size" />
            <output name="partitions_out" file="outputs/expected_partitions.txt" />
        </test>
        <test expect_num_outputs="2">
            <param name="input_files" value="inputs/concat_1.fasta,inputs/concat_2.fasta" />
            <param name="concat_out_format" value="fasta" />
            <param name="part_format" value="raxml" />
            <param name="in_format" value="fasta" />
            <param name="data_type" value="dna" />
            <param name="check_align" value="false" />
            <output name="concat_output" file="outputs/expected_concat_fasta.fas" compare="sim_size" />
            <output name="partitions_out" file="outputs/expected_partitions_raxml.txt" />
        </test>
    </tests>

    <expand macro="help" />
    <expand macro="citations" />
</tool>