<?xml version="1.0" encoding="UTF-8"?>
<tool id="read2mut" name="Call specific mutations in reads:" version="1.0.1" profile="19.01">
    <description>Looks for reads with mutation at known positions and calculates frequencies and stats.</description>
    <macros>
        <import>va_macros.xml</import>
    </macros>
    <expand macro="requirements">
        <requirement type="package" version="1.1.0">xlsxwriter</requirement>
    </expand>
    <command><![CDATA[
        ln -s '$file2' bam_input.bam &&
        ln -s '${file2.metadata.bam_index}' bam_input.bam.bai &&
        python '$__tool_directory__/read2mut.py' 
        --mutFile '$file1'
        --bamFile bam_input.bam
        --inputJson '$file3'
        --sscsJson '$file4'
        --thresh '$thresh'
        --phred '$phred'
        --trim '$trim'
        --outputFile '$output_xlsx'
    ]]>
    </command>
    <inputs>
        <param name="file1" type="data" format="tabular" label="DCS Mutation File" optional="false" help="TABULAR file with DCS mutations. See Help section below for a detailed explanation."/>
        <param name="file2" type="data" format="bam" label="BAM File of raw reads" optional="false" help="BAM file with aligned raw reads of selected tags."/>
        <param name="file3" type="data" format="json" label="JSON File with DCS tag stats" optional="false" help="JSON file generated by DCS mutations to tags/reads"/>
        <param name="file4" type="data" format="json" label="JSON File with SSCS tag stats" optional="false" help="JSON file generated by DCS mutations to SSCS stats."/>
        <param name="thresh" type="integer" label="Tag count threshold" value="0" help="Integer threshold for displaying mutations. Only mutations occuring in DCS of less than thresh tags are displayed. Default of 0 displays all."/>
        <param name="phred" type="integer" label="Phred quality score threshold" min="0" max="41" value="20" help="Integer threshold for Phred quality score. Only reads higher than this threshold are considered. Default = 20."/>
        <param name="trim" type="integer" label="Trimming threshold" value="10" help="Integer threshold for assigning mutations at start and end of reads to lower tier. Default 10."/>
    </inputs>
    <outputs>
        <data name="output_xlsx" format="xlsx" label="${tool.name} on ${on_string}: XLSX"/>
    </outputs>
    <tests>
        <test>
            <param name="file1" value="DCS_Mutations_test_data_VA.tabular"/>
            <param name="file2" value="Interesting_Reads_test_data_VA.trim.bam"/>
            <param name="file3" value="tag_count_dict_test_data_VA.json"/>
            <param name="file4" value="SSCS_counts_test_data_VA.json"/>
            <param name="thresh" value="0"/>
            <param name="phred" value="20"/>
            <param name="trim" value="10"/>
            <output name="output_xlsx" file="mutant_reads_summary_short_trim_test_data_VA.xlsx" decompress="true" lines_diff="10"/>
        </test>
    </tests>
    <help> <![CDATA[
**What it does**

Takes a tabular file with mutations, a BAM file of aligned raw reads, and JSON files 
created by the tools **DCS mutations to tags/reads** and **DCS mutations to SSCS stats** 
as input and calculates frequencies and stats for DCS mutations based on information 
from the raw reads.

**Input** 

**Dataset 1:** Tabular file with duplex consesus sequence (DCS) mutations as 
generated by the **Variant Annotator** tool.

**Dataset 2:** BAM file of aligned raw reads. This file can be obtained by the 
tool `Map with BWA-MEM <https://arxiv.org/abs/1303.3997>`_.

**Dataset 3:** JSON file generated by the **DCS mutations to tags/reads** tool 
containing dictonaries of the tags of reads containing mutations 
in the DCS.

**Dataset 4:** JSON file generated by the **DCS mutations to SSCS stats** tool 
stats of tags that carry a mutation in the SSCS at the same position a mutation 
is called in the DCS.

**Output**

The output is an XLSX file containing frequencies stats for DCS mutations based 
on information from the raw reads. In addition to that a tier based 
classification is provided based on the amout of support for a true variant call.

    ]]> 
    </help>
    <expand macro="citation" />
</tool>
