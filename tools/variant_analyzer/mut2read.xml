<?xml version="1.0" encoding="UTF-8"?>
<tool id="mut2read" name="DCS mutations to tags/reads:" version="1.0.0" profile="19.01">
    <description>Extracts all tags that carry a mutation in the duplex consensus sequence (DCS)</description>
    <macros>
        <import>va_macros.xml</import>
    </macros>
	<requirements>
        <requirement type="package" version="2.7">python</requirement>
        <requirement type="package" version="1.4.0">matplotlib</requirement>
        <requirement type="package" version="0.15">pysam</requirement>
    </requirements>
    <command><![CDATA[
        ln -s '$file2' bam_input.bam &&
        ln -s '${file2.metadata.bam_index}' bam_input.bam.bai &&
        python '$__tool_directory__/mut2read.py' 
        --mutFile '$file1'
        --bamFile bam_input.bam
        --familiesFile '$file3'
        --outputFastq '$output_fastq' 
        --outputJson '$output_json'
    ]]>
    </command>
    <inputs>
        <param name="file1" type="data" format="tabular" label="DCS Mutation File" optional="false" help="TABULAR file with DCS mutations. See Help section below for a detailed explanation."/>
        <param name="file2" type="data" format="bam" label="DCS BAM File" optional="false" help="BAM file with aligned DCS reads."/>
        <param name="file3" type="data" format="tabular" label="Aligned Families File" optional="false" help="TABULAR file with aligned families."/>
    </inputs>
    <outputs>
        <data name="output_fastq" format="fastq" label="${tool.name} on ${on_string}: FASTQ"/>
        <data name="output_json" format="json" label="${tool.name} on ${on_string}: JSON"/>
    </outputs>
    <tests>
        <test>
            <param name="file1" value="DCS_Mutations_test_data_VA.tabular"/>
            <param name="file2" value="DCS_test_data_VA.bam"/>
            <param name="file3" value="Aligned_Families_test_data_VA.tabular"/>
            <output name="output_fastq" file="Interesting_Reads_test_data_VA.fastq" lines_diff="136"/>
            <output name="output_json" file="tag_count_dict_test_data_VA.json" lines_diff="2"/>
        </test>
    </tests>
    <help> <![CDATA[
**What it does**

Takes a tabular file with mutations, a BAM file of aligned DCS reads, and a 
tabular file with aligned families as input and prints all tags of reads that 
carry a mutation to a user specified output file and creates a fastq file of 
reads of tags with a mutation.

**Input** 

**Dataset 1:** Tabular file with duplex consesus sequence (DCS) mutations as 
generated by the **Variant Annotator** tool.

**Dataset 2:** BAM file of aligned DCS reads. This file can be obtained by the 
tool `Map with BWA-MEM <https://arxiv.org/abs/1303.3997>`_.

**Dataset 3:** Tabular file with reads as produced by the 
**Du Novo: Align families** tool of the `Du Novo Analysis Pipeline 
<https://doi.org/10.1186/s13059-016-1039-4>`_

**Output**

The output is a json file containing dictonaries of the tags of reads containing mutations 
in the DCS and a fastq file of all reads of these tags.

    ]]> 
    </help>
    <expand macro="citation" />
</tool>
