<tool id="metamdbg_gfa" name="metaMDBG gfa" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Generate graph from metaMDBG</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="creator"/>
    <expand macro="requirements"/>

    <command detect_errors="exit_code"><![CDATA[
        ln -s $tmp_folder tmp_folder.tar.gz &&
        tar -xf tmp_folder.tar.gz -C '.';
        metaMDBG gfa --assembly-dir . --k $k_value --threads \${GALAXY_SLOTS:-1} $readpath $contigpath
    ]]></command>

    <inputs>
        <param name="contigs" type="data" format="fasta.gz" label="Contigs file" />
        <param name="k_values" type="data" format="txt" label="k-values file" />
        <param name="tmp_folder" type="data" format="tar.gz"
            label="Compressed tmp folder"
            help="Archive of the tmp folder produced by the metaMDBG assembly step." />

        <param name="k_value" type="select" label="Select k-mer value">
            <options from_dataset="k_values">
                <column name="value" index="0" />
                <column name="name" index="0" />
                <filter type="regexp" column="0" value="^[0-9]+$" />
            </options>
        </param>
        <param name="contigpath" type="boolean" checked="false" truevalue="--contigpath"
            falsevalue=""
            label="Generate path of contigs"
            help="If enabled, the tool will generate path of contigs in the assembly graph" />
        <param name="readpath" type="boolean" checked="false" truevalue="--readpath" falsevalue=""
            label="Generate path of reads"
            help="If enabled, the tool will generate path of reads in the assembly graph" />
    </inputs>

    <outputs>
        <data name="output_gfa" format="txt" from_work_dir="*bps.gfa"
            label="${tool.name} on ${on_string}: gfa output" />
        <data name="output_gfa_noseq" format="txt" from_work_dir="*bps.noseq.gfa"
            label="${tool.name} on ${on_string}: gfa noseq output" />

        <data name="contig_path" format="tsv" from_work_dir="*contigpath.tsv"
            label="${tool.name} on ${on_string}: path of contigs">
            <filter>contigpath</filter>
        </data>
        <data name="read_path" format="tsv" from_work_dir="*readpath.tsv"
            label="${tool.name} on ${on_string}: path of reads">
            <filter>readpath</filter>
        </data>
    </outputs>

    <tests>
        <test expect_num_outputs="2">
            <param name="contigs" value="contigs.fasta.gz" />
            <param name="k_values" value="test_k_values.txt" />
            <param name="k_value" value="21" />
            <param name="tmp_folder" value="tmp_metaMDBG.tar.gz" />
            <param name="contigpath" value="false" />
            <param name="readpath" value="false" />

            <output name="output_gfa" value="assemblyGraph_k21_4013bps.gfa" compare="sim_size"
                delta="3000" delta_frac="0.05" />
            <output name="output_gfa_noseq" value="assemblyGraph_k21_4013bps.noseq.gfa"
                compare="sim_size" delta="3000" delta_frac="0.05" />

        </test>
    </tests>

    <help><![CDATA[

This tool generates an assembly graph (in GFA format) from the output of a previous `metaMDBG asm` run.

Inputs:

- **Contigs file**: The `contigs.fasta.gz` file from a previous metaMDBG assembly.
- **k-values file**: File listing possible `k` values.
- **k-mer value**: Resolution of the graph. Lower values yield highly connected but fragmented graphs, higher values produce longer unitigs but may miss weak connections.
- **Contig path** *(optional)*: Include paths of contigs in the graph.
- **Read path** *(optional)*: Include paths of reads in the graph. (Note: read paths may be inaccurate for ONT data.)

Outputs:

- **GFA graph**: The assembly graph in `.gfa` format.
- **GFA (no sequences)**: A lighter version of the graph without unitig sequences.
- **Contig path** *(optional)*: TSV file of contig paths in the graph.
- **Read path** *(optional)*: TSV file of read paths in the graph.

To view available `k` values before generating the graph, run the previous tool with "Output possible k values" enabled.

]]></help>

    <expand macro="citations" />

</tool>
