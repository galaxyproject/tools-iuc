<tool id="roary" name="Roary" version="0.1.0">
    <description>Roary the pangenome pipeline - Quickly generate a core gene alignment from gff3 files</description>
    
    <requirements>
      <requirement type="package" version="3.8.2">roary</requirement>
    </requirements>
    
    <stdio>
        <exit_code range="1:" />
    </stdio>
    
    <command><![CDATA[
        #set $files=''
        #for $gff in $gff_input.gffs
          #if $gff.is_of_type("gff3")
            #set $file = str($gff)+".gff"
            cp $gff $file &&
            #set $files += " " + $file
          #end if
        #end for
                
        roary
          -f out 
          -p "\${GALAXY_SLOTS:-1}"
          -e
          -n
          -i $percent_ident
          -cd $core_diff
          #if str($advanced.advanced_selector) == "shown"
            -g $maxclust
            $split_para
            -t $trans_tab
            -iv $mcl
          #end if
          $files
          
    ]]></command>
    
    <inputs>
      <conditional name="gff_input">
        <param name="gff_input_selector" type="select" label="Individual gff files or a dataset collection" help="Select between individual gff files or a collection of gff files">
          <option value="individual">Individual</option>
          <option value="collection">Collection</option>
        </param>
        <when value="individual">
          <param name="gffs" type="data" multiple="true" format="gff3" label="select gff inputs to Roary" help="Select the files you wish to send to Roary, must be in gff3 format with the sequence data at the end of the file." />
        </when>
        <when value='collection'>
          <param name="gffs" type="data_collection" collection_type="list" format="gff3" label="Dataset collection to submit to Roary" help="A dataset list collection of gff3 files to send to Roary for analysis." />
        </when>
      </conditional>
      <param name="percent_ident" type="integer" label="minimum percentage identity for blastp" help="Sets the minimum percentage identity for protein matches" value="95"/>
      <param name="core_diff" type="float" label="percentage of isolates a gene must be in to be core" help="The total percentage of the isolates that must have the gene for it to be considered a core gene." value="99.0"/>
      
      <param name="outputs" type="select" multiple="true" display="checkboxes" label="Additional outputs">
        <option value="abg_fa" selected="False">Accessory binary genes in fasta format</option>
        <option value="accgraph" selected="False">Accessory graph in dot format</option>
        <option value="acchead_embl" selected="False">Accessory header file in embl format</option>
        <option value="acctab" selected="False">Accessory gene table in tabular format</option>
        <option value="blastfreq" selected="False">Blast Identity Frequency Rtab file</option>
        <option value="clust" selected="False">Clustered proteins file</option>
        <option value="coreaccgraph" selected="False">Core Accessory Graph in dot format</option>
        <option value="coreaccembl" selected="False">Core Accessory table in embl format</option>
        <option value="coreacctab" selected="False">Core Accessory table in tabular format</option>
        <option value="genepa_rtab" selected="False">Gene Presence Absence file in Rtab format</option>
        <option value="numcons_rtab" selected="False">Number of Conserved Genes in Rtab format</option>
        <option value="numpangene_rtab" selected="False">Number of Genes in Pan Genome in Rtab format</option>
        <option value="numnew_rtab" selected="False">Number of New Genes in Rtab format</option>
        <option value="numuniq_rtab" selected="False">Number of Unique Genes in Rtab format</option>
      </param>
      
      <conditional name="advanced">
        <param name="advanced_selector" type="select" label="Advanced Settings" help="Show or hide advanced settings">
          <option value="hidden">Hidden (defaults)</option>
          <option value="shown">Shown (advanced)</option>
        </param>
        <when value="hidden">
          
        </when>
        <when value="shown">
          <param name="maxclust" type="integer" value="50000" label="Maximum number of clusters" help="The maximum number of clusters to assign proteins" />
          <param name="split_para" type="boolean" checked="False" truevalue="-s" falsevalue="" label="Don't split paralogs" help="Click yes so that paralogs aren't split."/>
          <param name="trans_tab" type="integer" value="11" label="Translation table to use [1 or 4 or 11]" help="DNA -> RNA translation table to use. Roary is designed for prokaryotes and so tables 1, 4 or 11 will work, others could be problematic." />
          <param name="mcl" type="float" value="1.5" label="MCL inflation value" help="This is an advanced setting, change only if you know what you are doing and then at your own risk!" />
        </when>
      </conditional>
      
    </inputs>
    
    <outputs>
      <data format="tabular" name="sumstats" label="${tool.name} on ${on_string} Summary statistics" from_work_dir="out/summary_statistics.txt" />
      <data format="fasta" name="core_gene_aln" label="${tool.name} on ${on_string} Core Gene Alignment" from_work_dir="out/core_gene_alignment.aln" />
      <data format="csv" name="gene_p_a" label="${tool.name} on ${on_string} Gene Presence Absence" from_work_dir="out/gene_presence_absence.csv" />
      <data format="fasta" name="acc_bin" label="${tool.name} on ${on_string} Accessory Binary Genes" from_work_dir="out/accessory_binary_genes.fa" >
        <filter>outputs and 'abg_fa' in outputs</filter>
      </data>
      <data format="dot" name="acc_graph" label="${tool.name} on ${on_string} Acsessory Graph" from_work_dir="out/accessory_graph.dot">
        <filter>outputs and 'accgraph' in outputs</filter>
      </data>
      <data format="embl" name="acc_head_embl" label="${tool.name} on ${on_string} Accessory Header" from_work_dir="out/accessory.header.embl" >
        <filter>outputs and 'acchead_embl' in outputs</filter>
      </data>
      <data format="tabular" name="acc_tab" label="${tool.name} on ${on_string} Accessory Gene Table" from_work_dir="out/accessory.tab" >
        <filter>outputs and 'acctab' in outputs</filter>
      </data>
      <data format="txt" name="blast_freq" label="${tool.name} on ${on_string} Blast Identity Frequencies" from_work_dir="out/blast_identity_frequency.Rtab" >
        <filter>outputs and 'blastfreq' in outputs</filter>
      </data>
      <data format="txt" name="clust_file" label="${tool.name} on ${on_string} Clustered Proteins" from_work_dir="out/clustered_proteins" >
        <filter>outputs and 'clust' in outputs</filter>
      </data>
      <data format="dot" name="core_acc_graph" label="${tool.name} on ${on_string} Core Accessory Graph" from_work_dir="out/core_accessory_graph.dot" >
        <filter>outputs and 'coreaccgraph' in outputs</filter>
      </data>
      <data format="embl" name="core_acc_embl" label="${tool.name} on ${on_string} Core Accessory EMBL" from_work_dir="out/core_accessory.header.embl" >
        <filter>outputs and 'coreaccembl' in outputs</filter>
      </data>
      <data format="tabular" name="core_acc_tab" label="${tool.name} on ${on_string} Core Accessory Table" from_work_dir="out/core_accessory.tab" >
        <filter>outputs and 'coreacctab' in outputs</filter>
      </data>
      <data format="txt" name="gene_p_a_rtab" label="${tool.name} on ${on_string} Gene Presence Absence Rtab" from_work_dir="out/gene_presence_absence.Rtab" >
        <filter>outputs and 'genepa_rtab' in outputs</filter>
      </data>
      <data format="txt" name="num_cons_rtab" label="${tool.name} on ${on_string} Number of Conserved Genes" from_work_dir="out/number_of_conserved_genes.Rtab" >
        <filter>outputs and 'numcons_rtab' in outputs</filter>
      </data>
      <data format="txt" name="num_pangene_rtab" label="${tool.name} on ${on_string} Number of Genes in Pan Geneome" from_work_dir="out/number_of_genes_in_pan_genome.Rtab" >
        <filter>outputs and 'numpangene_rtab' in outputs</filter>
      </data>
      <data format="txt" name="num_new_rtab" label="${tool.name} on ${on_string} Number of New Genes" from_work_dir="out/number_of_new_genes.Rtab" >
        <filter>outputs and 'numnew_rtab' in outputs</filter>
      </data>
      <data format="txt" name="num_uniq_rtab" label="${tool.name} on ${on_string} Number of Unique Genes" from_work_dir="out/number_of_unique_genes.Rtab" >
        <filter>outputs and 'numuniq_rtab' in outputs</filter>
      </data>
    </outputs>
    
    <tests>
      <test>
        <param name="gff_input_selector" value="individual"/>
        <param name="gffs" value="ex1.gff,ex2.gff" ftype="gff3"/>
        <output name="sumstats" file="out/summary_statistics.txt" ftype="tabular"/>
      </test>
      <test>
        <param name="gff_input_selector" value="individual"/>
        <param name="gffs" value="ex1.gff,ex2.gff" ftype="gff3"/>
        <param name="percent_ident" value="50"/>
        <param name="core_diff" value="50.0"/>
        <output name="sumstats" file="test2/summary_statistics.txt" ftype="tabular"/>
      </test>
    </tests>
    
    <help><![CDATA[
Please cite Roary if you use any of the results it produces:
Andrew J. Page, Carla A. Cummins, Martin Hunt, Vanessa K. Wong, Sandra Reuter, Matthew T. G. Holden, Maria Fookes, Daniel Falush, Jacqueline A. Keane, Julian Parkhill,
"Roary: Rapid large-scale prokaryote pan genome analysis", Bioinformatics, 2015 Nov 15;31(22):3691-3693 
doi: http://doi.org/10.1093/bioinformatics/btv421
Pubmed: 26198102

Usage:   roary [options] *.gff

Options: 

       - Minimum percentage identity for blastp - an integer, default is [95]
       
       - Percentage of isolates a gene must be in to be core - a float, default is [99.0]
       
Advanced Options:
       
       - Maximum number of clusters - integer, default is [50000]
       
       - Don't split paralogs - check box
       
       - Translation table - which translation table to use, an integer, default is [11]
       
       - Change the MCL inflation value - a float, default is [1.5]
       

For further info see: http://sanger-pathogens.github.io/Roary/
    
    ]]></help>
    
    <citations>
        <citation type="doi">http://doi.org/10.1093/bioinformatics/btv421</citation>
    </citations>
    
</tool>