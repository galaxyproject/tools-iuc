<tool id='aegean_locuspocus' name='AEGeAn LocusPocus' version='@TOOL_VERSION@' profile='20.01'>
    <description> calculate locus coordinates for the given gene annotation</description>
    <macros>                                                                                           
        <import>macros.xml</import>
    </macros>                                                                                          
    <expand macro='xrefs'/>
    <expand macro='edam_ontology'/>
    <expand macro='requirements'/>
    <command detect_errors='exit_code'>
        <![CDATA[
            locuspocus '$genesgff3'
            -l $delta
            $mode
            $skipiloci
            #if $refine_options.refine_parameters.refine
                $refine_options.refine_parameters.cds
            #end if
            -m $refine_options.minoverlap
	        #if $outputfiles
                $outputfiles
            #end if
            $retainids
            -f '$filter'
            -o '$output'
            ]]>
    </command>
    <inputs>
        <param name='genesgff3' type='data' format='gff3,gff' label="GFF3 File" />
        <param name='delta' argument='-l' type='integer' 
            min='0' max='1000' value='500'
            label='Gene loci extension'
            help='When parsing interval loci, use the following delta to extend gene loci and include potential regulatory regions' />
        <param name='mode' type='select' label='Annotation mode'>
            <option value='' selected='true'>Default mode</option>
            <option value='--skipends'> Exclude unannotated iLoci at either end of the sequence</option>
            <option value='--endsonly'> Report only incomplete iLocus fragments at the unannotated ends of sequences</option>
        </param>
        <param name='skipiloci' type='boolean'            
            truevalue='---skipiiloci' falsevalue=''
            label='Do not report intergenic iLoci (-y)' />
        <param name='retainids' argument='-T' type='boolean'
            truevalue='--retainids' falsevalue=''
            label='Retain original feature IDs'
            help='Retain original feature IDs from input files; conflicts will arise if input contains duplicated ID values'/>
        <param name='outputfiles' type='select' display='checkboxes' label='Output files'
            multiple='yes' optional='true'>
            <option value='--ilens "$output_ilens"'>Create file with the lenghts of each intergenic iLocus</option>
            <option value='--genemap "$output_genemap"'>Create a mapping from each gene annotation to its correspondig locus</option>
            <option value='--transmap "$output_transmap"'>Create a mapping from each transcript annotation to its correspondent locus</option>
        </param>
        <param type='text' name='filter'
            value='gene'
            label='Comma-separated list of feature types to use (-f)' />
        <section name='refine_options' title='Refine options' expanded='False'>
            <conditional name='refine_parameters'>
                <param name='refine' type='select' 
                    label='Mode for handling of overlpping genes'
                    help='Refine mode allows for a more nuanced handling of overlapping genes.'>
                    <option value=''>Default</option>
                    <option value='--refine'>Refine mode</option>
                </param>
                <when value=''/>
                <when value='--refine'>
                    <param name='cds' argument='-c' type='boolean' 
                        truevalue='--cds' falsevalue=''
                        label='Use CDS rather than UTRs'
                        help='(-c)' />
                </when>
            </conditional>
            <param name='minoverlap' argument='(-m)' type='integer' 
                max='20' min='1' value='1' 
                label='Minimum number of overlapping nucleotides'
                help='The minimum number of nucleotides two genes must overlap to be grouped in the same iLocus' />
        </section>
    </inputs>
    <outputs>
        <data name='output' format='tabular' />
        <data name='output_ilens' format='tabular'>
            <filter>'--ilens "$output_ilens"' in  outputfiles</filter>
        </data>
        <data name='output_genemap' format='tabular'>
            <filter>'--genemap "$output_genemap"' in outputfiles</filter>
        </data>
        <data name='output_transmap' format='tabular'>
            <filter>'--transmap "$output_transmap"' in outputfiles</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name='genesgff3' value='TAIR10_GFF3_genes.gff'/>
            <output name='output' file='locuspocus_output_test1.txt'/>
        </test>
        <test expect_num_outputs="1">
            <param name='genesgff3' value='TAIR10_GFF3_genes.gff'/>
            <param name='mode' value='--skipends'/>
            <output name='output' file='locuspocus_output_test2.txt'/>
        </test>
        <test  expect_num_outputs="1">
            <param name='genesgff3' value='TAIR10_GFF3_genes.gff'/>
            <param name='mode' value='--endsonly'/>
            <output name='output' file='locuspocus_output_test3.txt'/>
        </test>
        <test  expect_num_outputs="1"> 
            <param name='genesgff3' value='TAIR10_GFF3_genes.gff'/>
            <param name='refine' value='--refine'/>
            <param name='minoverlap' value='5'/>
            <output name='output' file='locuspocus_output_test4.txt'/>
        </test>
        <test expect_num_outputs="4">
            <param name='genesgff3' value='TAIR10_GFF3_genes.gff'/>
            <param name='ilens' value='true'/>
            <param name='genemap' value='true'/>
            <param name='transmap' value='true'/>
            <output name='output' file='locuspocus_output_test5.txt'/>
            <output name='output_ilens' file='locuspocus_lenght_test5.txt'/>
            <output name='output_genemap' file='locuspocus_genemap_test5.txt'/>
            <output name='output_transmap' file='locuspocus_transmap_test5.txt'/>
        </test>
        <test expect_num_outputs="4">
            <param name='genesgff3' value='TAIR10_GFF3_genes.gff'/>
            <param name='refine' value='--refine'/>
            <param name='minoverlap' value='5'/>
            <param name='mode' value='--skipends'/>
            <param name='ilens' value='true'/>
            <param name='genemap' value='true'/>
            <param name='transmap' value='true'/>
            <output name='output' file='locuspocus_output_test6.txt'/>
            <output name='output_ilens' file='locuspocus_lenght_test6.txt'/>
            <output name='output_genemap' file='locuspocus_genemap_test6.txt'/>
            <output name='output_transmap' file='locuspocus_transmap_test6.txt'/>
        </test>
    </tests>
    <help>
        <![CDATA[
.. class:: infomark
            
**Purpose**
            
LocusPocus is a program for computing interval loci (iLoci) from a provided set gene annotations. Each iLocus corresponds to a single gene, a set of overlapping genes, or a space between genes. See this page for a description of iLoci as an organizational principle for genomics.
            
-----
            
.. class:: infomark
            
**Input**
            
Input for LocusPocus is one or more files in GFF3 format. The only strict requirement is that the input must be valid GFF3.
            
The use of ##sequence-region pragmas is optional, and many GFF3 files do not include them. LocusPocus uses this information when computing the location of iLoci at the ends of a sequence. Note that if these pragmas are not declared explicitly, iLoci will only be reported for sequence regions containing annotated features.
            
Users can override gene as the default feature of interest, replace it with one or more other feature types, and construct iLoci for these features in the same way.
            
-----
            
.. class:: infomark
            
**Output**
            
LocusPocus computes the location of the iLoci from the given gene features and reports the iLocus locations in GFF3 format. By default, only the iLocus features themselves are reported, with attributes indicating the number of genes and transcripts in the locus. 
            
]]>
    </help>
    <expand macro='citations'/>
</tool>
