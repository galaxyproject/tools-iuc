<?xml version="1.0"?>
<tool id="lions" name="lions " version="@TOOL_VERSION@+@WRAPPER_VERSION@">
    <description>...</description>
    <macros>
        <token name="@TOOL_VERSION@">0.2</token>
        <token name="@GALAXY_VERSION@">galaxy0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">lions</requirement>
    </requirements>
    <stdio></stdio>
    <command detect_errors="exit_code"><![CDATA[
        ## initialize 
        touch 'input.list'
        #for $i, $s in enumerate($input_rep)
            '${s.input_file}    ${s.input_file}   ${s.input_type}' >> input.list &&
        #end for

        touch 'parameter.ctrl' &&

        ln -s '$geneset' ./resources/run/annotation/geneset.txt &&
        ln -s '' ./resources/run/genome/run.fa &&
        ln -s '$repeatmasker' ./resources/run/repeat/run.ucsc &&

        ## run
        ./lions_opt.sh
            -p 'result'
            -i 'input.list' ## created above
            -I $I
            --geneset '$geneset'
            --repeatmasker '$repeatmasker'
            --systemctrl 'system.ctrl' ## created above
            --inread $inread
            --thread \${GALAXY_SLOTS:-1}
            --denovo $denovo
            --minfrags $minfrags
            --multiflag $multiflag
            --mintrim $mintrim
            --trimdrop $trimdrop
            --merger $merger
            --quality $quality
        ]]></command>
    <inputs>
        <repeat name="input_rep" title="Select input files">
            <param argument="input_file" type="data" format="bam" label="Select intput file"/>
            <param argument="input_type" type="select" label="Set input type">
                <option value="control">Control</option>
                <option value="experimental">Experimental</option>
                <option value="other">Other</option>
            </param>
        </repeat>
        <!-- todo insert genome select -->
        
        <param argument="--callsettings" type="select" label="Select settings for TE-initiation">
            <option value="oncoexapatation">Detect high abundance TE isoforms (oncoexapatation)</option>
            <option value="transcriptomeANN">Artifical Neural Network based classifier (transcriptomeANN)</option>
            <option value="screenTE">High sensitivity, low specificity detection (screenTE)</option>
            <option value="driverTE">TE-initiations as main drivers of gene-expression (driverTE)</option>
            <option value="custom’">Use custom settings defined below</option> <!-- todo -->
        </param>
        <param argument="--geneset" type="data" format="tabular" label="Select UCSC gene set file"/>
        <param argument="--repeatmasker" type="data" format="tabular" label="Select repeat-Masker annotation file"/>
        <param argument="--alignbypass" type="boolean" truevalue="1" falsevalue="0" checked="true" label="Create new alignment on input files?" help="If 'no', alignment provided in input files is used."/> <!-- todo, creates a symbolic link TEST ! -->
        <param argument="--inread" type="integer" value="" label="Set inner read distance" help="That is used by Bowtie during alignment (Bowtie's -r option)"/>
        <param argument="--denovo" type="select" label="Select assembly mode of Cufflinks">
            <option value="1">De Novo</option>
            <option value="0">Ab Initio</option>
        </param>
        <param argument="--minfrags" type="integer" value="10" min="0" label="Set Cufflink's 'minimum fragments per transfrag' option"/>
        <param argument="--multiflag" type="float" value="0.75" min="0.0" max="1.0" label="Set Cufflink's 'multi-mapping transfrag fragments' option"/>
        <param argument="--mintrim" type="integer" value="10" min="0" label="Set Cufflink's 'minimum coverage to attempt 3' trimming' option"/>
        <param argument="--trimdrop" type="float" value="" min="0.0" max="1.0" label="Set Cufflink's 'minimum Trim dropoff in fraction' option"/>
        <param argument="--merger " type="integer" value="50" min="0" label="Set Cufflink's 'merge radius in bp' option"/>
        <param argument="--quality" type="text" value="" label="Set RNAseq analysis quality" help="Defined by the string 'q#.F#' where q = quality cutoff; F bam flags to discard, e.g. 'q10.F772' and 'q1.F1796'."/>
        
        <section name="oo" title="Output options">
            <param name="out" type="select" multiple="true" label="Select output file(s)">
                <option value="log" selected="true">log</option>
                <option value="lcsv" selected="true">lcsv</option>
                <option value="lions" selected="true">lions</option>
                <option value="alignment" selected="true">alignment</option>
                <option value="assembly" selected="true">assembly</option>
                <option value="expression" selected="true">expression</option>
                <option value="resources" selected="true">resources</option>
            </param>
        </section>
    </inputs>
    <outputs>
        <collection name="out_logs" type="list" label="${tool.name} on ${on_string}: logs">
            <discover_datasets pattern="__name_and_ext__" directory="result/logs"/>
        </collection>
        <data name="out_library_lcsv" format="txt" from_work_dir="reslt/lib/lib.lcsv" label="${tool.name} on ${on_string}: Library.lcsv">
            <filter>oo['lcsv']</filter>
        </data>
        <data name="out_library_lions" format="txt" from_work_dir="reslt/lib/lib.lions" label="${tool.name} on ${on_string}: Library.lions">
            <filter>oo['lions']</filter>
        </data>
        <collection name="out_alignment" type="list" label="${tool.name} on ${on_string}: alignments">
            <discover_datasets pattern="__name_and_ext__" directory="result/lib/alignment"/>
        </collection>
        <collection name="out_assembly" type="list" label="${tool.name} on ${on_string}: assembly">
            <discover_datasets pattern="__name_and_ext__" directory="result/lib/assembly"/>
        </collection>
        <collection name="out_expression" type="list" label="${tool.name} on ${on_string}: expression">
            <discover_datasets pattern="__name_and_ext__" directory="result/lib/expression"/>
        </collection>
        <collection name="out_resources" type="list" label="${tool.name} on ${on_string}: resources">
            <discover_datasets pattern="__name_and_ext__" directory="result/lib/resources"/>
        </collection>
    </outputs>
    <tests>
        <!-- #1 default -->
        <test expect_num_outputs="5">
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

IONS is a bioinformatic analysis pipeline which brings together a few pieces of software and some home-brewed scripts to annotate a paired-end RNAseq library against a reference TE annotation set (such as Repeat Masker)


**Input**

BAM files.

**Output**

<library>.lcsv’ / '.pc.lcsv’

These are LIONS CSV files which contain the raw calculations for all major numeric operations. This includes ALL TE-exon interactions types (Initiation, Exonization and Termination). As such there are usually hundreds of thousands of TEs which have read fragments joining them to some assembled exon.

The '.pc.’ pre-suffix means the data has been intersected to the input set of protein coding genes. Use this file for re-calculating “TE-Initiations” with new parameters.

'<library>.lion’ This is the filtered set of TE-exon interactions which have been classified as “TE-Initiations” or TE transcription start sites. This is per-library input. 

'<project>.lions’ A merged file of several '.lion’ files combining biological groups definedin the 'input.list’. A good example of this is merging 10 cancer libraries and 10 normal libraries and outputing only those TE-initiations which are in at least
20% of Cancer and no Normal libraries. These parameters can be changed in the 'paramter.ctrl’ input.

'<project>.rslions’ The 'rs’ is for Recurrent and Specific TE-initiations only. That is if you compare the set of libraries 1 (Normal) vs set 2 (Cancer), this contains only those TE-initiations which occur multiple times in Cancer (recurrant) and do not
occur in Normal (specific). As defined by '$cgGroupRecurrence’ and '$cgSpecificity’ in the 'paramter.ctrl’ file.

'<project>.inv.rslions’ The '.inv.’ pre-suffix is simply the inverse of the '.rslion’ file. So instead of “Cancer vs. Normal”, “Normal vs. Cancer”. A necessary control if one makes any conclusions based on enrichment/depletion.

.. class:: infomark

**References**

More information are available on `github <https://github.com/ababaian/LIONS>`_ and in the `manual <https://github.com/ababaian/LIONS/blob/master/user_guide/LIONS_UG.pdf>`_.
    ]]></help>
    <citations>
        <citation type="doi">10.1093/bioinformatics/btz130</citation>        
    </citations>
</tool>