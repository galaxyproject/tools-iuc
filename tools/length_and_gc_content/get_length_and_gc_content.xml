<tool id="length_and_gc_content" name="Gene length and GC content" version="0.1.2">
    <description>from GTF and FASTA file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <stdio>
        <regex match="Execution halted"
               source="both"
               level="fatal"
               description="Execution halted." />
        <regex match="Error in"
               source="both"
               level="fatal"
               description="An undefined error occured, please check your input carefully and contact your administrator." />
        <regex match="Fatal error"
               source="both"
               level="fatal"
               description="An undefined error occured, please check your input carefully and contact your administrator." />
    </stdio>
    <version_command><![CDATA[
        echo $(R --version | grep version | grep -v GNU)", optparse version" $(R --vanilla --slave -e "library(optparse); cat(sessionInfo()\$otherPkgs\$optparse\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", rtracklayer version" $(R --vanilla --slave -e "library(rtracklayer); cat(sessionInfo()\$otherPkgs\$rtracklayer\$Version)" 2> /dev/null | grep -v -i "WARNING: ")", data.table version" $(R --vanilla --slave -e "library(data.table); cat(sessionInfo()\$otherPkgs\$data.table\$Version)" 2> /dev/null | grep -v -i "WARNING: ")
    ]]></version_command>
    <command><![CDATA[

## Get GTF

#if $gtf_file.gtfSource == 'cached':
    ln -s '$gtf_file.gtf_pre_installed.fields.path' gtf
#else:
    ln -s '$gtf_file.gtf_history' gtf
#end if

&&

## Get FASTA

#if $analysis.analysis_select != "length":
    #if $analysis.fasta_file.fastaSource == 'indexed':
        ln -s '$analysis.fasta_file.fasta_pre_installed.fields.path' fasta &&
    #else:
        ln -s '$analysis.fasta_file.fasta_history' fasta &&
    #end if
#end if

Rscript '$__tool_directory__/get_length_and_gc_content.r'

--gtf gtf

#if $analysis.analysis_select != "gc":
    --length '$length'
#end if

#if $analysis.analysis_select != "length":
    --fasta fasta
    --gc_content '$gc_content'
#end if

    ]]></command>

    <inputs>
        <conditional name="gtf_file">
            <param name="gtfSource" type="select" label="Select a built-in GTF file or one from your history"  help="Choose history if you don't see the correct GTF" >
                <option value="cached" selected="true">Use a built-in GTF</option>
                <option value="history">Use a GTF from history</option>
            </param>
            <when value="cached">
                <param name="gtf_pre_installed" type="select" label="Select a GTF file" help="Select the GTF from a list of pre-installed files">
                    <options from_data_table="gene_sets">
                        <filter type="sort_by" column="1" />
                    </options>
                    <validator type="no_options" message="No annotations are available."/>
                </param>
            </when>
            <when value="history">
                <param name="gtf_history" type="data" format="gtf" label="Select a GTF file" help="Make sure that the GTF corresponds to the same genome as the FASTA"/>
            </when>
        </conditional>

        <conditional name="analysis">
            <param name="analysis_select" type="select" label="Analysis to perform">
                <option value="all" selected="true">GC-content and gene lengths</option>
                <option value="gc">GC-content only</option>
                <option value="length">gene lengths only</option>
            </param>
            <when value="all">
                <expand macro="fasta" />
            </when>
            <when value="gc">
                <expand macro="fasta" />
            </when>
            <when value="length"/>
        </conditional>
    </inputs>

    <outputs>
        <data name="length" format="tabular" label="Gene length">
            <filter>analysis['analysis_select'] != "gc"</filter>
            <actions>
                <action name="column_names" type="metadata" default="GeneID,Length" />
            </actions>
        </data>
        <data name="gc_content" format="tabular" label="Gene GC content">
            <filter>analysis['analysis_select'] != "length"</filter>
             <actions>
                <action name="column_names" type="metadata" default="GeneID,GC_content" />
            </actions>
        </data>
    </outputs>

    <tests>
        <!-- The gtf file was generated by
        zcat gencode.v39.basic.annotation.gtf.gz | grep "HOXD" | awk -F "\t" -v OFS="\t" '$0~/HOXD10/ || $0~/HOXD9/ {$1="fake_chr2";$4-=176116521;$5-=176116521; print} -->
        <!-- Ensure length and GC files are output -->
        <test expect_num_outputs="2">
            <param name="gtfSource" value="history" />
            <param name="gtf_history" ftype="gtf" value="in.gtf" />
            <param name="fastaSource" value="history" />
            <param name="fasta_history" ftype="fasta" value="in.fasta" />
            <output name="length" file="length.tab" />
            <output name="gc_content" file="gc.tab" />
        </test>
        <!-- Ensure built-in fasta and gtf work -->
        <test expect_num_outputs="2">
            <param name="gtfSource" value="cached" />
            <param name="fastaSource" value="indexed" />
            <output name="length" file="length.tab" />
            <output name="gc_content" file="gc.tab" />
        </test>
        <!-- Ensure optional gc content works  -->
        <test expect_num_outputs="1">
            <param name="gtfSource" value="cached" />
            <param name="analysis_select" value="length" />
            <output name="length" file="length.tab" />
        </test>
        <!-- Ensure optional length works -->
        <test expect_num_outputs="1">
            <param name="gtfSource" value="cached" />
            <param name="fastaSource" value="indexed" />
            <param name="analysis_select" value="gc" />
            <output name="gc_content" file="gc.tab" />
        </test>
    </tests>
    <help><![CDATA[

**What it does**

.. class:: infomark

This tool calculates the length and/or GC content for the genes in a GTF file.
For the GC content, it requires a FASTA file that is the same genome version as the GTF.

-----

**Inputs**

- a GTF file
- a FASTA file (if GC content is requested)

-----

**Outputs**

- a tabular file with Gene ID and length
- a tabular file with Gene ID and GC content

-----

**More Information**

To calculate gene length, this tool counts the number of bases in all exons of a gene, after merging any overlapping exons from different transcripts.

    ]]></help>
    <citations>
    </citations>
</tool>
