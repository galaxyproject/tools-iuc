<tool id="csaw_windowCounts" name="Window Counts" version="@VERSION@.0">
    <description>count reads overlapping each window</description>
    <macros>
       <import>csaw_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>
    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)
library(Rsamtools)

##calculateCPM

bamFiles <- c()
#for $i in $bam_input
    bamFiles <- c(bamFiles, '${i.bam_file}')
#end for
indexBam(bamFiles)

    

]]>
        </configfile>
    </configfiles>
    <inputs>
        <repeat name="bam_input" title="Upload indexed BAM files in sorted order" >
            <param name="bam_file" type="data" format="bam" label="BAM file" />
        </repeat>
        <param name="spacing" type="integer" value="50" label="Distance between consecutive windows" />
        <param name="width" type="integer" value="" optional="true" label="Width of the window" />

    

            
        
    </inputs>

    <outputs>
        <data name="output" format="txt" label="${tool.name} on ${on_string}: calculateCPM output" />
    </outputs>

    <tests>
        <test>
            <repeat name="bam_input">
                <param name="bam_file" value="rep1.bam" ftype="bam" />
            </repeat>
            <repeat name="bam_input">
                <param name="bam_file" value="rep2.bam" ftype="bam" />
            </repeat>
            <param name="spacing" value="50"/>
            
        </test>
    </tests>

    <help><![CDATA[
        Count the number of extended reads overlapping a sliding window at spaced positions across the genome.
    ]]></help>
    <expand macro="citations" />
</tool>