<tool id="csaw_calculateCPM" name="calculateCPM" version="@VERSION@.0">
    <description>calculates CPM values</description>
    <macros>
       <import>csaw_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>
    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)
library(Rsamtools)

@WINDOWCOUNTS@

object <- window_counts

#if str($calculateCPM.use_norm_factors) == "true"
    use_norm_factors <- TRUE
#else
    use_norm_factors <- FALSE
#end if

#if str($calculateCPM.use_offsets) == "true"
    use_offsets <- TRUE
#else
    use_offsets <- FALSE
#end if

#if str($calculateCPM.log_select.log_selector) == "yes"
    log <- TRUE
    prior_count <- "$calculateCPM.log_select.prior_count"
#else
    log <- FALSE
    prior_count <- 1
#end if

#if str($calculateCPM.assay_id) != ''
    assay_id <- "$calculateCPM.assay_id"
#else
    assay_id <- "counts"
#end if

result <- calculateCPM(object, use.norm.factors=use_norm_factors, use.offsets=use_offsets, log=log, prior.count=prior_count, assay.id=assay_id)

write.table(result, "$output", row.names=FALSE, col.names=FALSE)

]]>
        </configfile>
    </configfiles>
    <inputs>
        <section name="windowCounts" title="Count reads overlapping each window" expanded="true">
          <expand macro="windowCounts" />
        </section>
        <section name="calculateCPM" title="Calculates counts-per-million values" expanded="true">
            <param name="use_norm_factors" type="boolean" truevalue="true" falsevalue="" checked="true" label="Use normalization factors?" help="If yes is selected the effective library size is used for computing CPMs, provided that normalization factors are available in the object" />
            <param name="use_offsets" type="boolean" truevalue="true" falsevalue="" checked="false" label="Use offsets?" help="If yes is selected the offsets are converted into effective library sizes using scaleOffset." />
            <conditional name="log_select">
                <param name="log_selector" type="select" label="Return log2-transformed CPM values?" help="CPMs are calculated in the standard manner when no is selected. If Yes is selected a library size-adjusted prior count is added to both the counts and the library sizes.">
                    <option value="yes" selected="true">Yes</option>
                    <option value="no" selected="false">No</option>
                </param>
                <when value="yes">
                    <param name="prior_count" type="float" value="1" label="Prior count to add" />
                </when>
                <when value="no"> </when>
            </conditional>
            <param name="assay_id" type="text" value="counts" optional="true" label="Indicate which assay of y contains the counts" />
        </section>   
    </inputs>

    <outputs>
        <data name="output" format="txt" label="${tool.name} on ${on_string}: calculateCPM output" />
    </outputs>

    <tests>
        <test>
            <section name="windowCounts">
                <repeat name="bam_input">
                    <param name="bam_file" value="rep1.bam" ftype="bam" />
                </repeat>
                <repeat name="bam_input">
                    <param name="bam_file" value="rep2.bam" ftype="bam" />
                </repeat>
                <param name="spacing" value="50" />
                <param name="width" value="50" />
                <conditional name="ext_selector">
                    <param name="ext_select" value="integer" />
                    <param name="ext" value="100" />
                </conditional>
                <param name="shift" value="0" />
                <param name="filter" value="1" />
                <param name="bin" value="false" />
                <conditional name="readParam_select">
                    <param name="readParam_selector" value="no" />
                </conditional>
            </section>
            <param name="use_norm_factors" value="true" />
            <param name="use_offsets" value="false" />
            <conditional name="log_select">
                <param name="log_selector" value="no"/>
            </conditional>
            <param name="assay_id" value="counts" />
            <output name="output" value="calculateCPM_output0.txt" />
        </test>
        <test>
            <section name="windowCounts">
                <repeat name="bam_input">
                    <param name="bam_file" value="rep1.bam" ftype="bam" />
                </repeat>
                <repeat name="bam_input">
                    <param name="bam_file" value="rep2.bam" ftype="bam" />
                </repeat>
                <param name="spacing" value="50" />
                <param name="width" value="50" />
                <conditional name="ext_selector">
                    <param name="ext_select" value="integer" />
                    <param name="ext" value="100" />
                </conditional>
                <param name="shift" value="0" />
                <param name="filter" value="1" />
                <param name="bin" value="false" />
                <conditional name="readParam_select">
                    <param name="readParam_selector" value="no" />
                </conditional>
            </section>
            <param name="use_norm_factors" value="true" />
            <param name="use_offsets" value="false" />
            <conditional name="log_select">
                <param name="log_selector" value="yes"/>
                <param name="prior_count" value="1" />
            </conditional>
            <param name="assay_id" value="counts" />
            <output name="output" value="calculateCPM_output1.txt" />
        </test>
        <test>
            <section name="windowCounts">
                <repeat name="bam_input">
                    <param name="bam_file" value="rep1.bam" ftype="bam" />
                </repeat>
                <repeat name="bam_input">
                    <param name="bam_file" value="rep2.bam" ftype="bam" />
                </repeat>
                <param name="spacing" value="50" />
                <param name="width" value="50" />
                <conditional name="ext_selector">
                    <param name="ext_select" value="list" />
                    <param name="ext_list1" value="50, 100" />
                    <param name="ext_list2" value="80" />
                </conditional>
                <param name="shift" value="0" />
                <param name="filter" value="1" />
                <param name="bin" value="false" />
                <conditional name="readParam_select">
                    <param name="readParam_selector" value="no" />
                </conditional>
            </section>
            <param name="use_norm_factors" value="true" />
            <param name="use_offsets" value="false" />
            <conditional name="log_select">
                <param name="log_selector" value="yes"/>
                <param name="prior_count" value="1" />
            </conditional>
            <param name="assay_id" value="counts" />
            <output name="output" value="calculateCPM_output2.txt" />
        </test>
        <test>
        <section name="windowCounts">
                <repeat name="bam_input">
                    <param name="bam_file" value="rep1.bam" ftype="bam" />
                </repeat>
                <repeat name="bam_input">
                    <param name="bam_file" value="rep2.bam" ftype="bam" />
                </repeat>
                <param name="spacing" value="50" />
                <param name="width" value="50" />
                <conditional name="ext_selector">
                    <param name="ext_select" value="integer" />
                    <param name="ext" value="100" />
                </conditional>
                <param name="shift" value="0" />
                <param name="filter" value="1" />
                <param name="bin" value="false" />
                <conditional name="readParam_select">
                    <param name="readParam_selector" value="yes" />
                    <param name="pe" value="none" />
                    <param name="max_frag" value="500" />
                    <param name="dedup" value="false" />
                    <param name="minq" value="1" />
                    <param name="forward" value="NA" />
                    <param name="restrict" value="chrA" />
                    <conditional name="discard_select">
                        <param name="discard" value="no" />
                    </conditional>
                </conditional>
            </section>
            <param name="use_norm_factors" value="true" />
            <param name="use_offsets" value="false" />
            <conditional name="log_select">
                <param name="log_selector" value="yes"/>
                <param name="prior_count" value="1" />
            </conditional>
            <param name="assay_id" value="counts" />
            <output name="output" value="calculateCPM_output3.txt" />
        </test>
        <test>
        <section name="windowCounts">
                <repeat name="bam_input">
                    <param name="bam_file" value="rep1.bam" ftype="bam" />
                </repeat>
                <repeat name="bam_input">
                    <param name="bam_file" value="rep2.bam" ftype="bam" />
                </repeat>
                <param name="spacing" value="50" />
                <param name="width" value="50" />
                <conditional name="ext_selector">
                    <param name="ext_select" value="integer" />
                    <param name="ext" value="100" />
                </conditional>
                <param name="shift" value="0" />
                <param name="filter" value="1" />
                <param name="bin" value="false" />
                <conditional name="readParam_select">
                    <param name="readParam_selector" value="yes" />
                    <param name="pe" value="none" />
                    <param name="max_frag" value="500" />
                    <param name="dedup" value="false" />
                    <param name="minq" value="1" />
                    <param name="forward" value="NA" />
                    <param name="restrict" value="chrA" />
                    <conditional name="discard_select">
                        <param name="discard" value="yes" />
                        <param name="GRanges" value="chrA" />
                        <param name="IRanges" value="range_readParam.tabular" />
                    </conditional>
                </conditional>
            </section>
            <param name="use_norm_factors" value="true" />
            <param name="use_offsets" value="false" />
            <conditional name="log_select">
                <param name="log_selector" value="yes"/>
                <param name="prior_count" value="1" />
            </conditional>
            <param name="assay_id" value="counts" />
            <output name="output" value="calculateCPM_output4.txt" />
        </test>
    </tests>
    <help><![CDATA[
        Calculates counts-per-million values.
    ]]></help>
    <expand macro="citations" />
</tool>