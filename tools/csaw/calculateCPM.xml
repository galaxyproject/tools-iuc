<tool id="csaw_calculateCPM" name="calculateCPM" version="@VERSION@.0">
    <description>calculates counts-per-million values</description>
    <macros>
       <import>csaw_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>
    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)

##calculateCPM

#if str($use_norm_factors) == "true"
    use_norm_factors <- TRUE
#else
    use_norm_factors <- FALSE
#end if

#if str($use_offsets) == "true"
    use_offsets <- TRUE
#else
    use_offsets <- FALSE
#end if

#if str($log_select.log_selector) == "yes"
    log <- TRUE
    prior_count <- "$log_selector.prior_count"
#else
    log <- FALSE
    prior_count <- 1
#end if

#if str($assay_id) != ''
    assay_id <- "$assay_id"
#else
    assay_id <- "counts"
#end if

calculateCPM(object, use.norm.factors=use_norm_factors, use.offsets=use_offsets, log=log, prior.count=prior_count, assay.id=assay_id)

]]>
        </configfile>
    </configfiles>
    <inputs>
        <!--FIX OBJECT PARAMETER TO WINDOWCOUNT OUTPUT-->
        <param name="object" type="data" format="txt" label="Wincodw Counts outout" />
        <param name="use_norm_factors" type="boolean" truevalue="true" falsevalue="" checked="true" label="Use normalization factors?" help="If yes is selected the effective library size is used for computing CPMs, provided that normalization factors are available in the object" />
        <param name="use_offsets" type="boolean" truevalue="true" falsevalue="" checked="false" label="Use offsets?" help="If yes is selected the offsets are converted into effective library sizes using scaleOffset." />
        <conditional name="log_select">
            <param name="log_selector" type="select" label="Return log2-transformed CPM values?" help="If Yes is selected a library size-adjusted prior count is added to both the counts and the library sizes.">
                <option value="yes" selected="true">Yes</option>
                <option value="no" selected="false">No</option>
            </param>
            <when value="yes">
                <param name="prior_count" type="float" value="1" label="Prior count to add" />
            </when>
            <when value="no"> </when>
        </conditional>
        <param name="assay_id" type="text" value="counts" optional="true" label="Indicate which assay of y contains the counts" />    
    </inputs>

    <outputs>
        <data name="output" format="txt" label="${tool.name} on ${on_string}: calculateCPM output" />
    </outputs>

    <tests>
        <test>
            <param name="object" value="" />
            <param name="use_norm_factors" value="true" />
            <param name="use_offsets" value="false" />
            <conditional name="log_select">
                <param name="log_selector" value="no"/>
            </conditional>
            <param name="assay_id" value="counts" />
            <output name="output" value="" />
        </test>
        <test>
            <param name="object" value="" />
            <param name="use_norm_factors" value="true" />
            <param name="use_offsets" value="false" />
            <conditional name="log_select">
                <param name="log_selector" value="yes"/>
                <param name="prior_count" value="1" />
            </conditional>
            <param name="assay_id" value="counts" />
            <output name="output" value="" />
        </test>
    </tests>

    <help><![CDATA[
        
    ]]></help>
    <expand macro="citations" />
</tool>