<tool id="csaw_combineTests" name="combineTests" version="@VERSION@.0">
    <description>combines tests</description>
    <macros>
       <import>csaw_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>
    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)

comTest_ids <-scan("$ids", what = integer())
comTest_tab <- read.table("$tab", sep="", header=T)
#if str($weight) != ''
    comTest_w <- scan("$weight", what=numeric())
#else
    comTest_w <- NULL
#end if
@COLNAMES@
result <- combineTests(comTest_ids, comTest_tab, weight=comTest_w, pval.col=pval_col, fc.col=fc_col)
write.table(result, file="$output", row.names=FALSE)

]]></configfile>
    </configfiles>
    <inputs>
        <param name="ids" type="data" format="tabular" label="Cluster ID for each test" help="Upload as a dataframe where each row is an integer." />
        <param name="tab" type="data" format="tabular" label="Dataframe of results with PValue and at least one logFC field for each test" />
        <param name="weight" type="data" format="tabular" optional="true" label="Weights for each window" help="Upload as a dataframe where each row is a numeric value. If none specified, the weight defaults to 1 for each test. Supplying different relative weight values may be useful for downweighting low-confidence tests, e.g., those in repeat regions. In Simes’ procedure, weights are interpreted as relative frequencies of the tests in each cluster." />
        <expand macro="col_names" />
    </inputs>

    <outputs>
        <data name="output" format="txt" label="${tool.name} on ${on_string}: combinTests output" />
    </outputs>

    <tests>
        <test>
            <param name="ids" value="comTest_ids.tabular" />
            <param name="tab" value="comTest_tab.tabular" />
            <param name="weight" value="comTest_w.tabular" />
            <param name="pval_col" value="PValue" />
            <param name="fc_col" value="logFC.whee" />
            <output name="output" value="combineTests_output.txt" />
        </test>
    </tests>

    <help><![CDATA[
        Combines statistics across multiple tests.

        Combines p-values across clustered tests using Simes’ method to control the cluster FDR and to compute the combined p-value for each cluster of tests with the same value of ids. Each combined p-value represents evidence against the global null hypothesis, i.e., all individual nulls are true in each cluster. This may be more relevant than examining each test individually when multiple tests in a cluster represent parts of the same underlying event, e.g., genomic regions consisting of clusters of windows. The BH method is also applied to control the FDR across all clusters.
    ]]></help>
    <expand macro="citations" />
</tool>