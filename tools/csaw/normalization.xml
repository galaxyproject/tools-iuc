<tool id="csaw_normalization" name="Normalization" version="@VERSION@.0">
  <description>with csaw</description>
  <macros>
    <import>csaw_macros.xml</import>
  </macros>
  <expand macro="requirements" />
  <command detect_errors="exit_code"><![CDATA[
    Rscript '$script']]>
  </command>
  <configfiles>
    <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)
library(Rsamtools)

#if str($method_select.method) == 'normOffsets'
  counts <- scan("$method_select.counts", what=integer())
  counts <- matrix(counts, ncol= as.numeric("$method_select.ncol"))
  data <- SummarizedExperiment(list(counts=counts))
  data[["totals"]] <- colSums(counts)

  #if str($method_select.assay_id) != ''
    assay_id <- as.numeric(gsub("([0-9]+).*$", "\\1", "$method_select.assay_id"))
    if (is.na(assay_id)){
      assay_id <- "$method_select.assay_id"
    }
  #else
    assay_id <- NULL
  #end if

  #if str($method_select.type_select.type_selector) == "scaling"
    #if str($method_select.type_select.weighted) == "true"
      weighted <- TRUE
    #else
      weighted <- FALSE
    #end if

    #if str($method_select.type_select.scaling_select.scaling_selector) == "yes"
        ##lib_size <- scan("$method_select.type_select.scaling_select.lib_size", what=integer())
        method_s <- as.character("$method_select.type_select.scaling_select.method_select.method_selector")

        #if str($method_select.type_select.scaling_select.method_select.method_selector) == "TMM"
          #if str($method_select.type_select.scaling_select.method_select.refColumn_select.refColumn_selector) == "integer"
            refColumn <- as.numeric("$method_select.type_select.scaling_select.method_select.refColumn_select.refColumn")
          #else
            refColumn <- scan("$method_select.type_select.scaling_select.method_select.refColumn_select.refColumn", what=integer())
          #end if
          logratioTrim <- as.numeric("$method_select.type_select.scaling_select.method_select.logratioTrim")
          sumTrim <- as.numeric("$method_select.type_select.scaling_select.method_select.sumTrim")
          acutoff <- as.numeric("$method_select.type_select.scaling_select.method_select.acutoff")

          result1 <- normFactors(data, weighted=weighted, method="TMM", refColumn=refColumn, logratioTrim=logratioTrim, sumTrim=sumTrim, Acutoff=acutoff, assay.id=assay_id, se.out=FALSE)
        #else if str($method_select.type_select.scaling_select.method_select.method_selector) == "upperquartile"
          p <- as.numeric("$method_select.type_select.scaling_select.method_select.p")
          result1 <- normFactors(data, weighted=weighted, method="upperquartile", p=p, assay.id=assay_id, se.out=FALSE)
        #else
          result1 <- normFactors(data, weighted=weighted, method=method_s, assay.id=assay_id, se.out=FALSE)
      #end if
    #else
      result1 <- normFactors(data, weighted=weighted, assay.id=assay_id, se.out=FALSE)
    #end if
    write.table(result1, file="$normOffsets_output1", row.names=FALSE, col.names=FALSE)
  #else
    #if str($method_select.type_select.loess_select.loess_selector) == "yes"
      span <- as.numeric("$method_select.type_select.loess_select.span")
      iterations <- as.numeric("$method_select.type_select.loess_select.iterations")
      min_weight <- as.numeric("$method_select.type_select.loess_select.min_weight")
      max_weight <- as.numeric("$method_select.type_select.loess_select.max_weight")

      #if str($method_select.type_select.loess_select.equal_weights_as_null) == "true"
        equal_weights_as_null <- TRUE
      #else
        equal_weights_as_null <- FALSE
      #end if

      result2 <- normOffsets(data, type="loess", weights=NULL, span=span, iterations=iterations, min.weight=min_weight, max.weight=max_weight, equal.weights.as.null=equal_weights_as_null, assay.id="counts", se.out=FALSE)
    #else
      result2 <- normOffsets(data, type="loess", assay.id="counts", se.out=FALSE)
    #end if
    write.table(result2, file="$normOffsets_output2", row.names=FALSE, col.names=FALSE)
  #end if
#else
  #if str($method_select.data_select.data_selector) == "windowCounts"
    @WINDOWCOUNTS_SELECT_METHOD@
    data <- window_counts
  #else
    @REGIONCOUNTS_SELECT_METHOD@
    data <- region_counts
  #end if

  assay_id <- as.numeric(gsub("([0-9]+).*$", "\\1", "$method_select.assay_id"))
  if (is.na(assay_id)){
    assay_id <- "$method_select.assay_id"
  }
  #if str($method_select.DGEList_select.DGEList_selector) == "yes"
    #if str($method_select.DGEList_select.remove_zeros) == "true"
      remove_zeros <- TRUE
    #else
      remove_zeros <- FALSE
    #end if

    #if str($method_select.DGEList_select.group_select.group_selector) == "yes" and str($method_select.lib_sizes_select.lib_sizes_selector) == "yes" and str($method_select.norm_factors_select.norm_factors_selector) == "yes"

      lib_sizes <- scan("$method_select.lib_sizes_select.lib_sizes", what=integer())
      norm_factors <- scan("$method_select.norm_factors_select.norm_factors", what=numeric())
      group <- scan("$method_select.DGEList_select.group_select.group", what=character())
      result <- asDGEList(data, lib_sizes, norm_factors, assay.id=assay_id, group=group, remove.zeros=remove_zeros)

    #else if str($method_select.DGEList_select.group_select.group_selector) == "yes" and str($method_select.lib_sizes_select.lib_sizes_selector) == "yes"

      lib_sizes <- scan("$method_select.lib_sizes_select.lib_sizes", what=integer())
      group <- scan("$method_select.DGEList_select.group_select.group", what=character())
      result <- asDGEList(data, lib_sizes, assay.id=assay_id, group=group, remove.zeros=remove_zeros)

    #else if str($method_select.DGEList_select.group_select.group_selector) == "yes" and str($method_select.norm_factors_select.norm_factors_selector) == "yes"

      norm_factors <- scan("$method_select.norm_factors_select.norm_factors", what=numeric())
      group <- scan("$method_select.DGEList_select.group_select.group", what=character())
      result <- asDGEList(data, norm_factors, assay.id=assay_id, group=group, remove.zeros=remove_zeros)

    #else if str($method_select.DGEList_select.group_select.group_selector) == "yes"

      group <- scan("$method_select.DGEList_select.group_select.group", what=character())
      result <- asDGEList(data, assay.id=assay_id, group=group, remove.zeros=remove_zeros)

    #else
      result <- asDGEList(data, assay.id=assay_id, remove.zeros=remove_zeros)

    #end if

  #else
    #if str($method_select.lib_sizes_select.lib_sizes_selector) == "yes" and str($method_select.norm_factors_select.norm_factors_selector) == "yes"
      lib_sizes <- scan("$method_select.lib_sizes_select.lib_sizes", what=integer())
      norm_factors <- scan("$method_select.norm_factors_select.norm_factors", what=numeric())

      result <- asDGEList(data, lib_sizes, norm_factors, assay.id=assay_id)
    #else if str($method_select.lib_sizes_select.lib_sizes_selector) == "yes"
      lib_sizes <- scan("$method_select.lib_sizes_select.lib_sizes", what=integer())

      result <- asDGEList(data, lib_sizes, assay.id=assay_id)
    #else if str($method_select.norm_factors_select.norm_factors_selector) == "yes"
      norm_factors <- scan("$method_select.norm_factors_select.norm_factors", what=numeric())

      result <- asDGEList(data, norm_factors, assay.id=assay_id)
    #else
      result <- asDGEList(data, assay.id=assay_id)
    #end if
  #end if

  write.table(result[[1]], "$SEmethods_output1", quote = FALSE, row.names = FALSE)
  write.table(result[[2]], "$SEmethods_output2", quote = FALSE)
#end if
]]>
    </configfile>
  </configfiles>
  <inputs>
    <conditional name="method_select">
      <param name="method" type="select" label="Method" >
        <option value="normOffsets">Calculate normalization factors or offsets using count data from multiple libraries.</option>
        <option value="SEmethods">Converting a SummarizedExperiment object to a DGEList object for analysis with edgeR</option>
      </param>
      <when value="normOffsets">
        <param name="counts" type="data" format="tabular" label="Upload a count matrix for the SummarizedExperiment object" />
        <param name="ncol" type="integer" value="" label="Number of columns of the count matrix" />
        <conditional name="type_select">
          <param name="type_selector" type="select" label="What type of normalization is to be performed?" >
            <option value="scaling">scaling</option>
            <option value="loess">loess</option>
          </param>
          <when value="scaling">
            <param name="weighted" type="boolean" truevalue="true" falsevalue="" checked="false" label="Use precision weights for TMM normalization?" />
            <conditional name="scaling_select">
              <param name="scaling_selector" type="select" label="Add other paramaters to be passed to calcNormFactors?">
                <option value="yes">Yes</option>
                <option value="no" selected="true">No</option>
              </param>
              <when value="yes">
                <!--lib_size doesn't work-->
                <!--<param name="lib_size" type="data" format="tabular" label="Upload a dataframe with a column of library sizes" />-->
                <conditional name="method_select">
                  <param name="method_selector" type="select" label="Normalization method to be used" >
                    <option value="TMM">TMM</option>
                    <option value="RLE">RLE</option>
                    <option value="upperquartile">upperquartile</option>
                    <option value="none">none</option>
                  </param>
                  <when value="TMM">
                    <conditional name="refColumn_select">
                      <param name="refColumn_selector" type="select" label="Use a column or upload a dataframe of columns to use as reference?" >
                        <option value="integer">Enter a column number</option>
                        <option value="vector">Upload a dataframe of columns</option>
                      </param>
                      <when value="integer">
                        <param name="refColumn" type="integer" value="" label="Enter a column number" />
                      </when>
                      <when value="vector">
                        <param name="refColumn" type="data" format="tabular" label="Upload a dataframe of column numbers stored in one column" />
                      </when>
                    </conditional>
                    <param name="logratioTrim" type="float" value="0.3" label="Amount of trim to use on log-ratios (M values)" />
                    <param name="sumTrim" type="float" value="0.05" label="Amount of trim to use on the combined absolute levels (A values)" />
                    <!--doWeighting doesn't work-->
                    <!--<param name="doWeighting" type="boolean" truevalue="true" falsevalue="" checked="true" label="Compute (asymptotic binomial precision) weights?" />-->
                    <param name="acutoff" type="float" value="-1e10" label="Cutoff on A values to use before trimming" />
                  </when>
                  <when value="RLE"> </when>
                  <when value="upperquartile"> 
                    <param name="p" type="float" value="0.75" label="Percentile (between 0 and 1) of the counts that is aligned" />
                  </when>
                  <when value="none"> </when>
                </conditional>
              </when>
              <when value="no"> </when>
            </conditional>
          </when>
          <when value="loess">
            <conditional name="loess_select">
              <param name="loess_selector" type="select" label="Add other paramaters to be passed to loessFit?">
                <option value="yes">Yes</option>
                <option value="no" selected="true">No</option>
              </param>
              <when value="yes">
                <!--<param name="weights" type="data" format="tabular" optonal="true" label="Upload a dataframe of non-negative prior weights stored in one column" />-->
                <param name="span" type="float" value="0.3" label="Specify the proportion of data to be used in the local regression moving window" help="Enter a positive value between 0 and 1. Larger numbers give smoother fits." />
                <param name="iterations" type="integer" value="4" label="Iterations" help="This is the number of local regression fits. Values greater than 1 produce robust fits." />
                <param name="min_weight" type="float" value="1e-5" label="Minimum weight" />
                <param name="max_weight" type="float" value="1e5" label="Maximum weight" />
                <param name="equal_weights_as_null" type="boolean" truevalue="true" falsevalue="" checked="true" label="Treat equal weights as if weights are NULL?" help="Applies even if all weights are all zero." />
              </when>
              <when value="no"> </when>
            </conditional>
          </when>
        </conditional>
        <param name="assay_id" type="text" value="counts" optional="true" label="Specify the assay values to use for normalization" />
      </when>
      <when value="SEmethods">
        <conditional name="data_select">
          <param name="data_selector" type="select" label="Create a RangedSummarizedExperiment object by windowCounts or regionCounts?">
            <option value="windowCounts">windowCounts</option>
            <option value="regionCounts">regionCounts</option>
          </param>
          <when value="windowCounts">
            <expand macro="windowCounts" />
          </when>
          <when value="regionCounts">
            <expand macro="regionCounts" />
          </when>
        </conditional>
        <conditional name="lib_sizes_select">
          <param name="lib_sizes_selector" type="select" label="Specify library sizes?" >
            <option value="yes">Yes</option>
            <option value="no" selected="true">No</option>
          </param>
          <when value="yes">
            <param name="lib_sizes" type="data" format="tabular" optional="true" label="Library sizes" help="Upload a dataframe with one column of library sizes" />
          </when>
          <when value="no"> </when>
        </conditional>
        <conditional name="norm_factors_select">
          <param name="norm_factors_selector" type="select" label="Specify normalization factors?" >
            <option value="yes">Yes</option>
            <option value="no" selected="true">No</option>
          </param>
          <when value="yes">
            <param name="norm_factors" type="data" format="tabular" optional="true" label="Normalization factors" help="Upload a dataframe with one column of normalization factors" />
          </when>
          <when value="no"> </when>
        </conditional>
        <param name="assay_id" type="text" value="counts" label="Indicate which assay in object contains the count matrix." />
        <conditional name="DGEList_select">
          <param name="DGEList_selector" type="select" label="Add additional parameters from DGEList?" >
            <option value="yes">Yes</option>
            <option value="no" selected="true">No</option>
          </param>
          <when value="yes">
            <!--TODO: samples, genes-->
            <conditional name="group_select">
              <param name="group_selector" type="select" label="Specify the experimental group/condition for each sample/library?" >
                <option value="yes">Yes</option>
                <option value="no" selected="true">No</option>
              </param>
              <when value="yes">
                <param name="group" type="data" format="tabular" label="Experimental group/condition for each sample/library" help="Upload as dataframe with one column of groupname" />
              </when>
              <when value="no"> </when>
            </conditional>
            <param name="remove_zeros" type="boolean" optional="true" truevalue="true" falsevalue="" checked="false" label="Remove rows that have 0 total count?" />
          </when>
          <when value="no"> </when>
        </conditional>
      </when>
    </conditional>
  </inputs>
  <outputs>
    <data name="normOffsets_output1" format="txt" label="normFactors on ${on_string}: output">
      <filter>method_select['method'] == 'normOffsets' and method_select['type_select']['type_selector'] == 'scaling'</filter>
    </data>
    <data name="normOffsets_output2" format="txt" label="normOffsets on ${on_string}: output" >
      <filter>method_select['method'] == 'normOffsets' and method_select['type_select']['type_selector'] == 'loess'</filter>
    </data>
    <data name="SEmethods_output1" format="txt" label="SEmethods on ${on_string}: counts output">
      <filter>method_select['method'] == 'SEmethods'</filter>
    </data>
    <data name="SEmethods_output2" format="txt" label="SEmethods on ${on_string}: normalization output">
      <filter>method_select['method'] == 'SEmethods'</filter>
    </data>
  </outputs>

  <tests>
    <test expect_num_outputs="1">
      <conditional name="method_select">
        <param name="method" value="normOffsets" />
        <param name="counts" value="normOffsets_counts.tabular" />
        <param name="ncol" value="4" />
        <conditional name="type_select">
          <param name="type_selector" value="scaling" />
            <conditional name="scaling_select">
              <param name="weighted" value="false" />
              <param name="scaling_selector" value="no" />
            </conditional>
        </conditional>
        <param name="assay_id" value="counts" />
      </conditional>
      <output name="normOffsets_output1" value="normOffsets_output1.txt" />
    </test>
    <test expect_num_outputs="1">
      <conditional name="method_select">
        <param name="method" value="normOffsets" />
        <param name="counts" value="normOffsets_counts.tabular" />
        <param name="ncol" value="4" />
        <conditional name="type_select">
          <param name="type_selector" value="scaling" />
            <conditional name="scaling_select">
              <param name="weighted" value="false" />
              <param name="scaling_selector" value="yes" />
                <conditional name="method_select">
                  <param name="method_selector" value="none" />
                </conditional>
            </conditional>
        </conditional>
        <param name="assay_id" value="counts" />
      </conditional>
      <output name="normOffsets_output1" value="normOffsets_output2.txt" />
    </test>
    <test expect_num_outputs="1">
      <conditional name="method_select">
        <param name="method" value="normOffsets" />
        <param name="counts" value="normOffsets_counts.tabular" />
        <param name="ncol" value="4" />
        <conditional name="type_select">
          <param name="type_selector" value="scaling" />
            <conditional name="scaling_select">
              <param name="weighted" value="false" />
              <param name="scaling_selector" value="yes" />
                <conditional name="method_select">
                  <param name="method_selector" value="TMM" />
                    <conditional name="refColumn_select">
                      <param name="refColumn_selector" value="integer" />
                        <param name="refColumn" value="1" />
                    </conditional>
                    <param name="logratioTrim" value="0.3" />
                    <param name="sumTrim" value="0.05" />
                    <param name="acutoff" value="-1e10" />
                </conditional>
            </conditional>
        </conditional>
        <param name="weighted" value="false" />
        <param name="assay_id" value="counts" />
      </conditional>
      <output name="normOffsets_output1" value="normOffsets_output3.txt" />
    </test>
    <test expect_num_outputs="1">
      <conditional name="method_select">
        <param name="method" value="normOffsets" />
        <param name="counts" value="normOffsets_counts.tabular" />
        <param name="ncol" value="4" />
        <conditional name="type_select">
          <param name="type_selector" value="scaling" />
          <param name="weighted" value="false" />
            <conditional name="scaling_select">
              <param name="scaling_selector" value="yes" />
                <conditional name="method_select">
                  <param name="method_selector" value="upperquartile" />
                  <param name="p" value="0.75" />
                </conditional>
            </conditional>
        </conditional>
        <param name="assay_id" value="counts" />
      </conditional>
      <output name="normOffsets_output1" value="normOffsets_output4.txt" />
    </test>
    <test expect_num_outputs="1">
      <conditional name="method_select">
        <param name="method" value="normOffsets" />
        <param name="counts" value="normOffsets_counts.tabular" />
        <param name="ncol" value="4" />
        <conditional name="type_select">
          <param name="type_selector" value="loess" />
            <conditional name="loess_select">
              <param name="loess_selector" value="no" />
            </conditional>
        </conditional>
        <param name="assay_id" value="counts" />
      </conditional>
      <output name="normOffsets_output2" value="normOffsets_output5.txt" />
    </test>
    <test expect_num_outputs="1">
      <conditional name="method_select">
        <param name="method" value="normOffsets" />
        <param name="counts" value="normOffsets_counts.tabular" />
        <param name="ncol" value="4" />
        <conditional name="type_select">
          <param name="type_selector" value="loess" />
            <conditional name="loess_select">
              <param name="loess_selector" value="yes" />
              <param name="span" value="0.3" />
              <param name="iterations" value="4" />
              <param name="min_weight" value="1e-5" />
              <param name="max_weight" value="1e5" />
              <param name="equal_weights_as_null" value="true" />
              <param name="method" value="weightedLowess" />
            </conditional>
        </conditional>
        <param name="assay_id" value="counts" />
      </conditional>
      <output name="normOffsets_output2" value="normOffsets_output6.txt" />
    </test>
    <test expect_num_outputs="2">
      <conditional name="method_select">
        <param name="method" value="SEmethods" />
        <conditional name="data_select">
          <param name="data_selector" value="windowCounts" />
          <repeat name="bam_input">
            <param name="bam_file" value="rep1.bam" ftype="bam" />
          </repeat>
          <repeat name="bam_input">
              <param name="bam_file" value="rep2.bam" ftype="bam" />
          </repeat>
          <param name="width" value="100" />
          <param name="filter" value="1" />
        </conditional>
        <conditional name="lib_sizes_select">
          <param name="lib_sizes_selector" value="no" />
        </conditional>
        <conditional name="norm_factors_select">
          <param name="norm_factors_selector" value="no" />
        </conditional>
        <param name="assay_id" value="counts" />
        <conditional name="DGEList_select">
          <param name="DGEList_selector" value="no" />
        </conditional>
      </conditional>
      <output name="SEmethods_output1" value="SEmethods_count_output1.txt" />
      <output name="SEmethods_output2" value="SEmethods_norm_output1.txt" />
    </test>
    <test expect_num_outputs="2">
      <conditional name="method_select">
        <param name="method" value="SEmethods" />
        <conditional name="data_select">
          <param name="data_selector" value="windowCounts" />
          <repeat name="bam_input">
            <param name="bam_file" value="rep1.bam" ftype="bam" />
          </repeat>
          <repeat name="bam_input">
              <param name="bam_file" value="rep2.bam" ftype="bam" />
          </repeat>
          <param name="width" value="100" />
          <param name="filter" value="1" />
        </conditional>
        <conditional name="lib_sizes_select">
          <param name="lib_sizes_selector" value="yes" />
          <param name="lib_sizes" value="SEmethods_lib_size.tabular" />
        </conditional>
        <conditional name="norm_factors_select">
          <param name="norm_factors_selector" value="no" />
        </conditional>
        <param name="assay_id" value="counts" />
        <conditional name="DGEList_select">
          <param name="DGEList_selector" value="no" />
        </conditional>
      </conditional>
      <output name="SEmethods_output1" value="SEmethods_count_output2.txt" />
      <output name="SEmethods_output2" value="SEmethods_norm_output2.txt" />
    </test>
    <test expect_num_outputs="2">
      <conditional name="method_select">
        <param name="method" value="SEmethods" />
        <conditional name="data_select">
          <param name="data_selector" value="windowCounts" />
          <repeat name="bam_input">
            <param name="bam_file" value="rep1.bam" ftype="bam" />
          </repeat>
          <repeat name="bam_input">
              <param name="bam_file" value="rep2.bam" ftype="bam" />
          </repeat>
          <param name="width" value="100" />
          <param name="filter" value="1" />
        </conditional>
        <conditional name="lib_sizes_select">
          <param name="lib_sizes_selector" value="no" />
        </conditional>
        <conditional name="norm_factors_select">
          <param name="norm_factors_selector" value="yes" />
          <param name="norm_factors" value="SEmethods_norm.tabular" />
        </conditional>
        <param name="assay_id" value="counts" />
        <conditional name="DGEList_select">
          <param name="DGEList_selector" value="no" />
        </conditional>
      </conditional>
      <output name="SEmethods_output1" value="SEmethods_count_output3.txt" />
      <output name="SEmethods_output2" value="SEmethods_norm_output3.txt" />
    </test>
    <test expect_num_outputs="2">
      <conditional name="method_select">
        <param name="method" value="SEmethods" />
        <conditional name="data_select">
          <param name="data_selector" value="windowCounts" />
          <repeat name="bam_input">
            <param name="bam_file" value="rep1.bam" ftype="bam" />
          </repeat>
          <repeat name="bam_input">
              <param name="bam_file" value="rep2.bam" ftype="bam" />
          </repeat>
          <param name="width" value="100" />
          <param name="filter" value="1" />
        </conditional>
        <conditional name="lib_sizes_select">
          <param name="lib_sizes_selector" value="yes" />
          <param name="lib_sizes" value="SEmethods_lib_size.tabular" />
        </conditional>
        <conditional name="norm_factors_select">
          <param name="norm_factors_selector" value="yes" />
          <param name="norm_factors" value="SEmethods_norm.tabular" />
        </conditional>
        <param name="assay_id" value="counts" />
        <conditional name="DGEList_select">
          <param name="DGEList_selector" value="no" />
        </conditional>
      </conditional>
      <output name="SEmethods_output1" value="SEmethods_count_output4.txt" />
      <output name="SEmethods_output2" value="SEmethods_norm_output4.txt" />
    </test>
    <test expect_num_outputs="2">
      <conditional name="method_select">
        <param name="method" value="SEmethods" />
        <conditional name="data_select">
          <param name="data_selector" value="windowCounts" />
          <repeat name="bam_input">
            <param name="bam_file" value="rep1.bam" ftype="bam" />
          </repeat>
          <repeat name="bam_input">
              <param name="bam_file" value="rep2.bam" ftype="bam" />
          </repeat>
          <param name="width" value="100" />
          <param name="filter" value="1" />
        </conditional>
        <conditional name="lib_sizes_select">
          <param name="lib_sizes_selector" value="yes" />
          <param name="lib_sizes" value="SEmethods_lib_size.tabular" />
        </conditional>
        <conditional name="norm_factors_select">
          <param name="norm_factors_selector" value="yes" />
          <param name="norm_factors" value="SEmethods_norm.tabular" />
        </conditional>
        <param name="assay_id" value="counts" />
        <conditional name="DGEList_select">
          <param name="DGEList_selector" value="yes" />
          <conditional name="group_select">
            <param name="group_selector" value="no" />
          </conditional>
          <param name="remove_zeros" value="false" />
        </conditional>
      </conditional>
      <output name="SEmethods_output1" value="SEmethods_count_output5.txt" />
      <output name="SEmethods_output2" value="SEmethods_norm_output5.txt" />
    </test>
    <test expect_num_outputs="2">
      <conditional name="method_select">
        <param name="method" value="SEmethods" />
        <conditional name="data_select">
          <param name="data_selector" value="windowCounts" />
          <repeat name="bam_input">
            <param name="bam_file" value="rep1.bam" ftype="bam" />
          </repeat>
          <repeat name="bam_input">
              <param name="bam_file" value="rep2.bam" ftype="bam" />
          </repeat>
          <param name="width" value="100" />
          <param name="filter" value="1" />
        </conditional>
        <conditional name="lib_sizes_select">
          <param name="lib_sizes_selector" value="yes" />
          <param name="lib_sizes" value="SEmethods_lib_size.tabular" />
        </conditional>
        <conditional name="norm_factors_select">
          <param name="norm_factors_selector" value="yes" />
          <param name="norm_factors" value="SEmethods_norm.tabular" />
        </conditional>
        <param name="assay_id" value="counts" />
        <conditional name="DGEList_select">
          <param name="DGEList_selector" value="yes" />
          <conditional name="group_select">
            <param name="group_selector" value="yes" />
            <param name="group" value="SEmethods_group.tabular" />
          </conditional>
          <param name="remove_zeros" value="false" />
        </conditional>
      </conditional>
      <output name="SEmethods_output1" value="SEmethods_count_output6.txt" />
      <output name="SEmethods_output2" value="SEmethods_norm_output6.txt" />
    </test>
  </tests>
  <help><![CDATA[
Calculate normalization factors or offsets using count data from multiple libraries
===================================================================================

The normFactors function provides a convenience wrapper for the calcNormFactors function in the edgeR package. This uses the trimmed mean of M-values (TMM) method to remove composition biases, typically in background regions of the genome. Precision weighting is turned off by default so as to avoid upweighting high-abundance regions. These are more likely to be bound and thus more likely to be differentially bound. Assigning excessive weight to such regions will defeat the purpose of trimming when normalizing the coverage of background regions. The normOffsets function with type="loess" performs non-linear normalization similar to the fast loess algorithm in normalizeCyclicLoess. This aims to account for mean dependencies in the efficiency biases between libraries. For each sample, a lowess curve is fitted to the log-counts against the log-average count. The fitted value for each genomic window is used as an offset in a generalized linear model for that feature and sample. The use of the average count provides more stability than the average log-count when low counts are present for differentially bound regions. 

normOffsets with type="scaling" behaves the same as normFactors, but is deprecated to avoid confusion when the function returns normalization factors. 

It returns:

- `normalization factors`: a column containing the relative normalization factors for each library is computed

If type="loess", it returns:

- `matrix`: of the same dimensions as counts is computed, containing the log-based offsets for use in GLM fitting


Converting a SummarizedExperiment object to a DGEList object for analysis with edgeR
====================================================================================

Converting a SummarizedExperiment object to a DGEList object for analysis with edgeR.

Counts are extracted from specified assay matrix in the SummarizedExperiment object and used to construct a DGEList object via DGEList. If not specified, library sizes are taken from the totals field in the column data of object. Warnings will be generated if this field is not present.

If norm.factors is not specified, asDGEList will attempt to extract normalization factors from object$norm.factors. If this is not available, factors will be set to the default (all unity).

It returns:

- `DGEList object`: containing counts and normalization information
    ]]></help>
  <expand macro="citations" />
</tool>