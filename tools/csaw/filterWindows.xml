<tool id="csaw_filterWindows" name="filterWindows" version="@VERSION@.0">
    <description>computes filter statistics for windows</description>
     <macros>
       <import>csaw_macros.xml</import>
    </macros>
     <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>
    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)
library(Rsamtools)

#if str($filter_method_select.filter_method_selector) == "filterWindows"
    @WINDOWCOUNTS_FILTERWINDOWS_DATA@  

    data <- windowCounts(bamFiles, spacing=spacing, width=width, ext=ext, shift=shift, filter=filter, bin=bin, param=p)
    type <- "$filter_method_select.type"

    #if str($filter_method_select.assay_data) != "counts"
        assay_data <- as.numeric(gsub("([0-9]+).*$", "\\1", "$filter_method_select.assay_data"))
        if (is.na(assay_data)){
            assay_data <- "$filter_method_select.assay_data"
        }
    #else
        assay_data <- "$filter_method_select.assay_data"
    #end if

    #if str($filter_method_select.assay_back) != "counts"
        assay_back <- as.numeric(gsub("([0-9]+).*$", "\\1", "$filter_method_select.assay_back"))
        if (is.na(assay_back)){
            assay_back <- "$filter_method_select.assay_back"
        }
    #else
        assay_back <- "$filter_method_select.assay_back"
    #end if

    prior_count <- as.numeric("$filter_method_select.prior_count")

    #if str($filter_method_select.scale_info_select.scale_info_selector) == "yes"

        @WINDOWCOUNTS_FILTERWINDOWS_SCALE_DATA@

        data_scale_info <- windowCounts(bamFiles_scale_info, spacing=spacing_scale_info, width=width_scale_info, ext=ext_scale_info, shift=shift_scale_info, filter=filter_scale_info, bin=bin_scale_info, param=p_scale_info)

        @WINDOWCOUNTS_FILTERWINDOWS_SCALE_BG@

        scale_info <- scaleControlFilter(data_scale_info, background_scale_info)
    #else
        scale_info <- NULL
    #end if

    #if str($filter_method_select.background_select.background_selector) == "yes"
        @WINDOWCOUNTS_FILTERWINDOWS_BACKGROUND@

        result <- filterWindows(data, background, type=type, assay.data=assay_data, assay.back=assay_back, prior.count=prior_count, scale.info=scale_info)

        #if str($filter_method_select.type) != "proportion"
            write.table(result[[1]], file = "$abundances_output", quote = FALSE, col.names = FALSE, row.names=FALSE)
            write.table(result[[2]], file = "$back_abundances_output", quote = FALSE, col.names = FALSE, row.names=FALSE)
            write.table(result[[3]], file = "$filter_output", quote = FALSE, col.names = FALSE, row.names=FALSE)

            #if str($filter_method_select.keep_select.keep_selector) == "yes" 
                keep <- result[[3]] > as.numeric("$filter_method_select.keep_select.keep")
                new_data <- data[keep,]

                #if str($filter_method_select.keep_select.keep_sum) == "true"
                    keep_sum <- sum(keep)
                    write.table(keep_sum, file = "$keepsum_output", quote = FALSE, col.names = FALSE, row.names=FALSE)
                #end if
            #end if

        #else
            write.table(result[[1]], file = "$abundances_output", quote = FALSE, col.names = FALSE, row.names=FALSE)
            write.table(result[[2]], file = "$filter_output", quote = FALSE, col.names = FALSE, row.names=FALSE)

                #if str($filter_method_select.keep_select.keep_selector) == "yes" 
                    keep <- result[[2]] > as.numeric("$filter_method_select.keep_select.keep")
                    new_data <- data[keep,]

                    #if str($filter_method_select.keep_select.keep_sum) == "true"
                        keep_sum <- sum(keep)
                        write.table(keep_sum, file = "$keepsum_output", quote = FALSE, col.names = FALSE, row.names=FALSE)
                    #end if
                #end if
        #end if
    #else
        result <- filterWindows(data, type=type, assay.data=assay_data, assay.back=assay_back, prior.count=prior_count, scale.info=scale_info)
        write.table(result[[1]], file = "$abundances_output", quote = FALSE, col.names = FALSE, row.names=FALSE)
        write.table(result[[2]], file = "$filter_output", quote = FALSE, col.names = FALSE, row.names=FALSE)

        #if str($filter_method_select.keep_select.keep_selector) == "yes" 
            keep <- result[[2]] > as.numeric("$filter_method_select.keep_select.keep")
            new_data <- data[keep,]

            #if str($filter_method_select.keep_select.keep_sum) == "true"
                keep_sum <- sum(keep)
                write.table(keep_sum, file = "$keepsum_output", quote = FALSE, col.names = FALSE, row.names=FALSE)
            #end if
        #end if
    #end if
#end if


]]>
        </configfile>
    </configfiles>
    <inputs>
        <conditional name="filter_method_select">
            <param name="filter_method_selector" type="select" label="Filtering method" >
                <option value="filterWindows">filterWindows</option>
                <option value="scaleControlFilter">scaleControlFilter</option>
            </param>
            <when value="filterWindows">
                <section name="data" title="Data: A RangedSummarizedExperiment object containing window-level counts" expanded="true">
                    <expand macro="windowCounts" />
                </section>
                <conditional name="background_select">
                    <param name="background_selector" type="select" label="Specify background defined by a RangedSummarizedExperiment for filtering?">
                        <option value="yes">Yes</option>
                        <option value="no" selected="true">No</option>
                    </param>
                    <when value="yes">                    
                        <section name="background" title="Background: A RangedSummarizedExperiment object" expanded="true">
                            <conditional name="data_select">
                                <param name="data_selector" type="select" label="Create a RangedSummarizedExperiment object by windowCounts or regionCounts?">
                                    <option value="windowCounts">windowCounts</option>
                                    <option value="regionCounts">regionCounts</option>
                                </param>
                                <when value="windowCounts">
                                    <expand macro="windowCounts" />
                                </when>
                                <when value="regionCounts">
                                    <expand macro="regionCounts" />
                                </when>
                            </conditional>
                        </section>
                    </when>
                    <when value="no"> </when>
                </conditional>
                <param name="type" type="select" label="Type of filtering to perfrom" help="When proportion is not selected the background RangedSummarizedExperiment object should contain counts for background regions" >
                    <option value="global" selected="true">global</option>
                    <option value="local">local</option>
                    <option value="control">control</option>
                    <option value="proportion">proportion</option>
                </param>
                <param name="assay_data" type="text" value="counts" label="Specify the assay containing window/bin counts in data" />
                <param name="assay_back" type="text" value="counts" label="Specify the assay containing window/bin counts in background." />
                <param name="prior_count" type="float" value="2" label="Specify the prior count to use in aveLogCPM" /> 
                <conditional name="scale_info_select">
                    <param name="scale_info_selector" type="select" label="Include scaleControlFilter information?" help="i.e., a normalization factor and library sizes for ChIP and control samples.">
                        <option value="yes">Yes</option>
                        <option value="no" selected="true">No</option>
                    </param>
                    <when value="yes">
                        <section name="data" title="Data: A RangedSummarizedExperiment object containing bin-level counts" expanded="true">
                            <expand macro="windowCounts" />
                        </section>
                        <section name="background" title="Background: A RangedSummarizedExperiment object containg bin-level counts for negative control samples" expanded="true">
                            <conditional name="data_select">
                                <param name="data_selector" type="select" label="Create a RangedSummarizedExperiment object by windowCounts or regionCounts?">
                                    <option value="windowCounts">windowCounts</option>
                                    <option value="regionCounts">regionCounts</option>
                                </param>
                                <when value="windowCounts">
                                    <expand macro="windowCounts" />
                                </when>
                                <when value="regionCounts">
                                    <expand macro="regionCounts" />
                                </when>
                            </conditional>
                        </section>
                    </when>
                    <when value="no"> </when>
                </conditional>
                <conditional name="keep_select">
                    <param name="keep_selector" type="select" label="Specify the percentage in decimals to filter out in count data?" >
                        <option value="yes">Yes</option>
                        <option value="no" selected="true">No</option>
                    </param>
                    <when value="yes">
                        <param name="keep" type="float" value="" label="Specify the percentage in decimals to filter out in count data" />
                        <param name="keep_sum" type="boolean" truevalue="true" falsevalue="" checked="false" label="Output the sum of the filtered count data?" />
                    </when>
                    <when value="no"> </when>
                </conditional>      
            </when>
            <when value="scaleControlFilter">
                <section name="data" title="Data: A RangedSummarizedExperiment object containing bin-level counts" expanded="true">
                    <expand macro="windowCounts" />
                </section>
                <section name="background" title="Background: A RangedSummarizedExperiment object containg bin-level counts for negative control samples" expanded="true">
                    <expand macro="windowCounts" />
                </section>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="abundances_output" format="txt" label="${tool.name} on ${on_string}: abundances output" >
            <filter>filter_method_select['filter_method_selector'] == 'filterWindows'</filter>
        </data>
        <data name="back_abundances_output" format="txt" label="${tool.name} on ${on_string}: back abundances output" >
            <filter>filter_method_select['background_select']['background_selector'] == "yes"</filter>
        </data>
        <data name="filter_output" format="txt" label="${tool.name} on ${on_string}: filter output" >
            <filter>filter_method_select['filter_method_selector'] == 'filterWindows'</filter>
        </data>
        <data name="keepsum_output" format="txt" label="${tool.name} on ${on_string}: filtered count sum output" >
            <filter>filter_method_select['keep_select']['keep_selector'] == 'yes' and filter_method_select['keep_select']['keep_selector']['keep_sum'] == 'true'</filter>
        </data>
        <!--<data name="tmp" format="txt" label="${tool.name} on ${on_string}: tmp output" />-->
    </outputs>

    <tests>
        <test expect_num_outputs="3">
            <conditional name="filter_method_select">
                <param name="filter_method_selector" value="filterWindows" />
                <section name="data">
                    <repeat name="bam_input">
                        <param name="bam_file" value="rep1.bam" ftype="bam" />
                    </repeat>
                    <repeat name="bam_input">
                        <param name="bam_file" value="rep2.bam" ftype="bam" />
                    </repeat>
                    <param name="spacing" value="50" />
                    <param name="width" value="" />
                    <conditional name="ext_selector">
                        <param name="ext_select" value="integer" />
                        <param name="ext" value="100" />
                    </conditional>
                    <param name="shift" value="0" />
                    <param name="filter" value="1" />
                    <param name="bin" value="false" />
                    <conditional name="readParam_select">
                        <param name="readParam_selector" value="no" />
                    </conditional>
                </section>
                <conditional name="background_select">
                    <param name="background_selector" value="no" />
                </conditional>
                <param name="type" value="proportion" />
                <param name="assay_data" value="counts" />
                <param name="assay_back" value="counts" />
                <param name="prior_count" value="2" />
                <conditional name="scale_info_select">
                    <param name="scale_info_selector" value="no" />
                </conditional>
                <conditional name="keep_select">
                    <param name="keep_selector" value="yes" />
                    <param name="keep" value="0.99" />
                    <param name="keep_sum" value="true" />
                </conditional>
            </conditional>
            <output name="abundances_output" value="filterWindows_abundances_output1.txt" />
            <output name="filter_output" value="filterWindows_filter_output1.txt" />
            <output name="keepsum_output" value="filterWindows_filtered_count_sum_output.txt" />
        </test>
        <test expect_num_outputs="3">
            <conditional name="filter_method_select">
                <param name="filter_method_selector" value="filterWindows" />
                <section name="data">
                    <repeat name="bam_input">
                        <param name="bam_file" value="rep1.bam" ftype="bam" />
                    </repeat>
                    <repeat name="bam_input">
                        <param name="bam_file" value="rep2.bam" ftype="bam" />
                    </repeat>
                    <param name="spacing" value="50" />
                    <param name="width" value="" />
                    <conditional name="ext_selector">
                        <param name="ext_select" value="integer" />
                        <param name="ext" value="100" />
                    </conditional>
                    <param name="shift" value="0" />
                    <param name="filter" value="1" />
                    <param name="bin" value="false" />
                    <conditional name="readParam_select">
                        <param name="readParam_selector" value="no" />
                    </conditional>
                </section>
                <conditional name="background_select">
                    <param name="background_selector" value="yes" />
                    <section name="background">
                        <conditional name="data_select">
                            <param name="data_selector" value="windowCounts" />
                            <repeat name="bam_input">
                            <param name="bam_file" value="rep1.bam" ftype="bam" />
                            </repeat>
                            <repeat name="bam_input">
                                <param name="bam_file" value="rep2.bam" ftype="bam" />
                            </repeat>
                            <param name="spacing" value="50" />
                            <param name="width" value="300" />
                            <conditional name="ext_selector">
                                <param name="ext_select" value="integer" />
                                <param name="ext" value="100" />
                            </conditional>
                            <param name="shift" value="0" />
                            <param name="filter" value="1" />
                            <param name="bin" value="true" />
                            <conditional name="readParam_select">
                                <param name="readParam_selector" value="no" />
                            </conditional>
                        </conditional>
                    </section>
                </conditional>
                <param name="type" value="global" />
                <param name="assay_data" value="counts" />
                <param name="assay_back" value="counts" />
                <param name="prior_count" value="2" />
                <conditional name="keep_select">
                    <param name="keep_selector" value="no" />
                </conditional>
                <conditional name="scale_info_select">
                    <param name="scale_info_selector" value="no" />
                </conditional>
            </conditional>
            <output name="abundances_output" value="filterWindows_abundances_output2.txt" />
            <output name="back_abundances_output" value="filterWindows_back_abundances_output.txt" />
            <output name="filter_output" value="filterWindows_filter_output2.txt" />
        </test>
        <test expect_num_outputs="2">
            <conditional name="filter_method_select">
                <param name="filter_method_selector" value="filterWindows" />
                <section name="data">
                    <repeat name="bam_input">
                        <param name="bam_file" value="rep1.bam" ftype="bam" />
                    </repeat>
                    <repeat name="bam_input">
                        <param name="bam_file" value="rep2.bam" ftype="bam" />
                    </repeat>
                    <param name="spacing" value="50" />
                    <param name="width" value="" />
                    <conditional name="ext_selector">
                        <param name="ext_select" value="integer" />
                        <param name="ext" value="100" />
                    </conditional>
                    <param name="shift" value="0" />
                    <param name="filter" value="1" />
                    <param name="bin" value="false" />
                    <conditional name="readParam_select">
                        <param name="readParam_selector" value="no" />
                    </conditional>
                </section>
                <conditional name="background_select">
                    <param name="background_selector" value="no" />
                </conditional>
                <param name="type" value="global" />
                <param name="assay_data" value="counts" />
                <param name="assay_back" value="counts" />
                <param name="prior_count" value="2" />
                <conditional name="scale_info_select">
                    <param name="scale_info_selector" value="yes" />
                    <section name="data">
                        <repeat name="bam_input">
                            <param name="bam_file" value="rep1.bam" ftype="bam" />
                        </repeat>
                        <repeat name="bam_input">
                            <param name="bam_file" value="rep2.bam" ftype="bam" />
                        </repeat>
                        <param name="spacing" value="50" />
                        <param name="width" value="" />
                        <conditional name="ext_selector">
                            <param name="ext_select" value="integer" />
                            <param name="ext" value="100" />
                        </conditional>
                        <param name="shift" value="0" />
                        <param name="filter" value="1" />
                        <param name="bin" value="false" />
                        <conditional name="readParam_select">
                            <param name="readParam_selector" value="no" />
                        </conditional>
                    </section>
                    <section name="background">
                        <conditional name="data_select">
                            <param name="data_selector" value="windowCounts" />
                            <repeat name="bam_input">
                                <param name="bam_file" value="rep1.bam" ftype="bam" />
                            </repeat>
                            <repeat name="bam_input">
                                <param name="bam_file" value="rep2.bam" ftype="bam" />
                            </repeat>
                            <param name="spacing" value="50" />
                            <param name="width" value="" />
                            <conditional name="ext_selector">
                                <param name="ext_select" value="integer" />
                                <param name="ext" value="100" />
                            </conditional>
                            <param name="shift" value="0" />
                            <param name="filter" value="1" />
                            <param name="bin" value="false" />
                            <conditional name="readParam_select">
                                <param name="readParam_selector" value="no" />
                            </conditional>
                        </conditional>
                    </section>
                </conditional>
                <conditional name="keep_select">
                    <param name="keep_selector" value="no" />
                </conditional>
            </conditional>
            <output name="abundances_output" value="filterWindows_abundances_output3.txt" />
            <output name="filter_output" value="filterWindows_filter_output3.txt" />
        </test>

        <test expect_num_outputs="3">
            <conditional name="filter_method_select">
                <param name="filter_method_selector" value="filterWindows" />
                <section name="data">
                    <repeat name="bam_input">
                        <param name="bam_file" value="rep1.bam" ftype="bam" />
                    </repeat>
                    <repeat name="bam_input">
                        <param name="bam_file" value="rep2.bam" ftype="bam" />
                    </repeat>
                    <param name="spacing" value="50" />
                    <param name="width" value="" />
                    <conditional name="ext_selector">
                        <param name="ext_select" value="integer" />
                        <param name="ext" value="100" />
                    </conditional>
                    <param name="shift" value="0" />
                    <param name="filter" value="1" />
                    <param name="bin" value="false" />
                    <conditional name="readParam_select">
                        <param name="readParam_selector" value="no" />
                    </conditional>
                </section>
                <conditional name="background_select">
                    <param name="background_selector" value="yes" />
                    <section name="background">
                        <conditional name="data_select">
                            <param name="data_selector" value="regionCounts" />
                            <repeat name="bam_input">
                            <param name="bam_file" value="rep1.bam" ftype="bam" />
                            </repeat>
                            <repeat name="bam_input">
                                <param name="bam_file" value="rep2.bam" ftype="bam" />
                            </repeat>
                            <param name="GRanges" value="filterWindows_regions.tabular" />
                            <param name="named" value="true" />
                            <conditional name="ext_selector">
                                <param name="ext_select" value="integer" />
                                <param name="ext" value="100" />
                            </conditional>
                            <conditional name="readParam_select">
                                <param name="readParam_selector" value="no" />
                            </conditional>
                        </conditional>
                    </section>
                </conditional>
                <param name="type" value="local" />
                <param name="assay_data" value="counts" />
                <param name="assay_back" value="counts" />
                <param name="prior_count" value="2" />
                <conditional name="keep_select">
                    <param name="keep_selector" value="no" />
                </conditional>
                <conditional name="scale_info_select">
                    <param name="scale_info_selector" value="no" />
                </conditional>
            </conditional>
            <output name="abundances_output" value="filterWindows_abundances_output4.txt" />
            <output name="back_abundances_output" value="filterWindows_back_abundances_output2.txt" />
            <output name="filter_output" value="filterWindows_filter_output4.txt" />
        </test>
    </tests>

    <help><![CDATA[
Convenience function to compute filter statistics for windows, based on proportions or using enrichment over background.

Proportion-based filtering supposes that a certain percentage of the genome is genuinely bound. If type="proportion", the filter statistic is defined as the ratio of the rank to the total number of windows. Rank is in ascending order, i.e., higher abundance windows have higher ratios. Windows are retained that have rank ratios above a threshold, e.g., 0.99 if 1% of the genome is assumed to be bound.

All other values of type will perform background-based filtering, where abundances of the windows are compared to those of putative background regions. The filter statistic are generally defined as the difference between window and background abundances, i.e., the log-fold increase in the counts. Windows can be filtered to retain those with large filter statistics, to select those that are more likely to contain genuine binding sites. The differences between the methods center around how the background abundances are obtained for each window.

If type="global", the median average abundance across the genome is used as a global estimate of the background abundance. This should be used when background contains unfiltered counts for large (2 - 10 kbp) genomic bins, from which the background abundance can be computed. The filter statistic for each window is defined as the difference between the window abundance and the global background. If background is not supplied, the background abundance is directly computed from entries in data.

If type="local", the counts of each row in data are subtracted from those of the corresponding row in background. The average abundance of the remaining counts is computed and used as the background abundance. The filter statistic is defined by subtracting the background abundance from the corresponding window abundance for each row. This is designed to be used when background contains counts for expanded windows, to determine the local background estimate.

If type="control", the background abundance is defined as the average abundance of each row in background. The filter statistic is defined as the difference between the average abundance of each row in data and that of the corresponding row in background. This is designed to be used when background contains read counts for each window in the control sample(s). Unlike type="local", there is no subtraction of the counts in background prior to computing the average abundance.
    ]]></help>
    <expand macro="citations" />
</tool>