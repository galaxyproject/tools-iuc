<tool id="csaw_mergeWindows" name="Merge Windows" version="@VERSION@.0">
    <description>merges windows into clusters</description>
    <macros>
       <import>csaw_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>

    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)

##mergeWindows
    @GRANGES@
    mW_tol <- as.numeric("$tol")
    @MAXWIDTH@
    #if str($ignore_strand) == 'true'
        ignore_strand <- T
    #else
        ignore_strand <- F
    #end if
    
    result <- mergeWindows(regions, mW_tol, sign=NULL, max.width=maxWidth, ignore.strand=ignore_strand)
    ids = result[[1]]
    write.table(ids, file="$id_output", row.names=FALSE, col.names=c("id"))
    region <- result[[2]]
    write.table(region, file="$region_output", quote = FALSE, row.names = FALSE)

]]>
        </configfile>
    </configfiles>
    <inputs>
        <expand macro="mergeWindows_param" />
    </inputs>

    <outputs>
        <data name="id_output" format="txt" label="${tool.name} on ${on_string}: mergeWindows id output" />
        <data name="region_output" format="txt" label="${tool.name} on ${on_string}: mergeWindows region output" />
    </outputs>


    <tests>
        <test>
            <param name="GRanges" value="chrA" />
            <param name="IRanges" value="mW_regions.tabular" />
            <param name="tol" value="100" />
            <conditional name="sign_select">
                <param name="sign_selector" value="no" />
            </conditional>
            <param name="max_width" value="5" />
            <output name="id_output" value="mergeWindows_id_output.txt" />
            <output name="region_output" value="mergeWindows_region_output.txt" />
        </test>
    </tests>

    <help><![CDATA[
        Use a simple single-linkage approach to merge adjacent or overlapping windows into clusters. Windows in regions are merged if the gap between the end of one window and the start of the next is no greater than tol. Adjacent windows can then be chained together to build a cluster of windows across the linear genome.
    ]]></help>


</tool>