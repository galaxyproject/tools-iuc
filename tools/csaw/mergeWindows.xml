<tool id="csaw_mergeWindows" name="mergeWindows" version="@VERSION@.0">
    <description>merges windows into clusters</description>
    <macros>
       <import>csaw_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>

    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)

@GRANGES@
tol <- as.numeric("$tol")

#if str($max_width) != ''
    maxWidth <- as.numeric("$max_width")
#else
    maxWidth <- NULL
#end if

#if str($ignore_strand) == 'true'
    ignore_strand <- T
#else
    ignore_strand <- F
#end if
    
result <- mergeWindows(regions, tol, sign=NULL, max.width=maxWidth, ignore.strand=ignore_strand)
ids = result[[1]]
write.table(ids, file="$id_output", row.names=FALSE, col.names=FALSE)
region <- result[[2]]
write.table(region, file="$region_output", quote = FALSE, row.names = FALSE)

]]>
        </configfile>
    </configfiles>
    <inputs>
        <expand macro="gRanges" />
        <param name="tol" type="float" value="" optional="true" label="Maximum distance between adjacent windows" help="A value of zero means that the windows must be contiguous whereas negative values specify minimum overlaps" />
        <conditional name="sign_select">
            <param name="sign_selector" type="select" label="Specify a positive log-FC for each window?" >
              <option value="yes">Yes</option>
              <option value="no" selected="true">No</option>
            </param>
            <when value="yes">
              <param name="sign" type="data" format="tabular" label="Positive log-FC for each window" help="Upload as datafame with a column of logical values" />
            </when>
            <when value="no"> </when>
        </conditional>
        <param name="max_width" type="float" value="" optional="true" label="Maximum size of merged intervals" help="Specification prevents the formation of excessively large clusters when many adjacent regions are present. Any cluster that is wider than the max width is split into multiple subclusters of (roughly) equal size. Specifically, the cluster interval is partitioned into the smallest number of equally-sized subintervals where each subinterval is smaller than max width. Windows are then assigned to each subinterval based on the location of the window midpoints. Suggested values range from 2000 to 10000 bp, but no limits are placed on the maximum size if no value entered." />
        <param name="ignore_strand" type="boolean" truevalue="true" falsevalue="" checked="true" label="Ignore the strandedness of regions?" help="If no is selected, the entries in regions are split into their separate strands." />
    </inputs>
    <outputs>
        <data name="id_output" format="txt" label="${tool.name} on ${on_string}: id output" />
        <data name="region_output" format="txt" label="${tool.name} on ${on_string}: region output" />
    </outputs>
    <tests>
        <test>
            <param name="GRanges" value="gRange_mergeWindows.tabular" />
            <param name="named" value="true" />
            <param name="tol" value="100.0" />
            <conditional name="sign_select">
                <param name="sign_selector" value="no" />
            </conditional>
            <param name="max_width" value="" />
            <param name="ignore_strand" value="true" />
            <output name="id_output" value="mergeWindows_id_output.txt" />
            <output name="region_output" value="mergeWindows_region_output.txt" />
        </test>
        <test>
            <param name="GRanges" value="gRange_mergeWindows.tabular" />
            <param name="named" value="true" />
            <param name="tol" value="100.0" />
            <conditional name="sign_select">
                <param name="sign_selector" value="yes" />
                <param name="sign" value="sign.tabular" />
            </conditional>
            <param name="max_width" value="" />
            <param name="ignore_strand" value="true" />
            <output name="id_output" value="mergeWindows_id_output2.txt" />
            <output name="region_output" value="mergeWindows_region_output2.txt" />
        </test>
    </tests>
    <help><![CDATA[
Use a simple single-linkage approach to merge adjacent or overlapping windows into clusters. Windows in regions are merged if the gap between the end of one window and the start of the next is no greater than tol. Adjacent windows can then be chained together to build a cluster of windows across the linear genome.

It returns:

- `id`: an integer column containing the cluster ID for each window
- `region`: a GRanges object containing the start/stop coordinates for each cluster of windows
    ]]></help>
    <expand macro="citations" />
</tool>