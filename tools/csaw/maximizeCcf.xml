<tool id="csaw_maximizeCcf" name="maximizeCcf" version="@VERSION@.0">
  <description>finds the delay at the maximal CCF</description>
  <macros>
    <import>csaw_macros.xml</import>
  </macros>
  <expand macro="requirements" />
  <command detect_errors="exit_code"><![CDATA[
    Rscript '$script']]>
  </command>
  <configfiles>
    <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)
library(Rsamtools)

profile <- scan("$profile", what = numeric())
ignore <- as.numeric("$ignore")

result <- maximizeCcf(profile, ignore=ignore)

write.table(result, "$output", quote = FALSE, col.names = FALSE, row.names = FALSE)

]]>
    </configfile>
  </configfiles>
  <inputs>
    <param name="profile" type="data" label="Coverage profile" help="Upload a dataframe with one column of the coverage profile" />
    <param name="ignore" type="integer" value="100" label="Specify the distances to ignore" />
  </inputs>
  <outputs>
    <data name="output" format="txt" label="${tool.name} on ${on_string}: maximizeCcf output" />
  </outputs>

  <tests>
    <test>
      <param name="profile" value="maximizeCcf_profile.txt" />
      <param name="profile" value="100" />
      <output name="output" value="maximizeCcf_output.txt" />    
    </test>
  </tests>

  <help><![CDATA[
      Estimate the average fragment length by maximizing the cross-correlations. 

      This function identifies the delay distance at which the cross-correlations are maximized. This distance can then be used as an estimate of the average fragment length, for use in directional extension during read counting. In some datasets, identification of the maxima is confounded by a phantom peak at the read length. This can be overcome by ignoring the first ignore delay distances, such that the distance corresponding to the true peak is used. Obviously, this only works in TF experiments with moderate to strong enrichment, where a strong peak in the CCF profile is present. The function may not perform sensibly in the presence of noisy profiles containing multiple local maxima.
    ]]></help>
  <expand macro="citations" />
</tool>