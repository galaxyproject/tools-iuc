<tool id="csaw_getWidths" name="getWidths" version="@VERSION@.0">
  <description>gets region widths</description>
  <macros>
    <import>csaw_macros.xml</import>
  </macros>
  <expand macro="requirements" />
  <command detect_errors="exit_code"><![CDATA[
    Rscript '$script']]>
  </command>
  <configfiles>
    <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)
library(Rsamtools)

#if str($data_select.data_selector) == "windowCounts"
  @WINDOWCOUNTS_SELECT@
  data <- window_counts
#else
  @REGIONCOUNTS_SELECT@
  data <- region_counts
#end if

result <- getWidths(data)

write.table(result, "$output", quote = FALSE, col.names = FALSE, row.names = FALSE)
]]>
    </configfile>
  </configfiles>
  <inputs>
    <conditional name="data_select">
      <param name="data_selector" type="select" label="Create a RangedSummarizedExperiment object by windowCounts or regionCounts?">
        <option value="windowCounts">windowCounts</option>
        <option value="regionCounts">regionCounts</option>
      </param>
      <when value="windowCounts">
        <expand macro="windowCounts" />
      </when>
      <when value="regionCounts">
        <expand macro="regionCounts" />
      </when>
    </conditional>
  </inputs>
  <outputs>
    <data name="output" format="txt" label="${tool.name} on ${on_string}: output" />
  </outputs>

  <tests>
    <test>
      <conditional name="data_select">
        <param name="data_selector" value="windowCounts" />
        <repeat name="bam_input">
          <param name="bam_file" value="rep1.bam" ftype="bam" />
        </repeat>
        <repeat name="bam_input">
            <param name="bam_file" value="rep2.bam" ftype="bam" />
        </repeat>
        <param name="spacing" value="50" />
        <param name="width" value="1" />
        <conditional name="ext_selector">
          <param name="ext_select" value="list" />
          <param name="ext_list1" value="50, 100" />
          <param name="ext_list2" value="80" />
        </conditional>
        <param name="shift" value="0" />
        <param name="filter" value="1" />
        <param name="bin" value="false" />
        <conditional name="readParam_select">
          <param name="readParam_selector" value="no" />
        </conditional>
      </conditional>
      <output name="output" value="getWidths_output1.txt" />
    </test>
    <test>
      <conditional name="data_select">
        <param name="data_selector" value="windowCounts" />
        <repeat name="bam_input">
          <param name="bam_file" value="rep1.bam" ftype="bam" />
        </repeat>
        <repeat name="bam_input">
            <param name="bam_file" value="rep2.bam" ftype="bam" />
        </repeat>
        <param name="spacing" value="50" />
        <param name="width" value="1" />
        <conditional name="ext_selector">
            <param name="ext_select" value="integer" />
            <param name="ext" value="100" />
        </conditional>
        <param name="shift" value="0" />
        <param name="filter" value="1" />
        <param name="bin" value="false" />
        <conditional name="readParam_select">
          <param name="readParam_selector" value="yes" />
          <param name="pe" value="none" />
          <param name="max_frag" value="500" />
          <param name="dedup" value="false" />
          <param name="minq" value="" />
          <param name="forward" value="NA" />
          <param name="restrict" value="chrA" />
          <conditional name="discard_select">
            <param name="discard" value="no" />
          </conditional>
        </conditional>
      </conditional>
      <output name="output" value="getWidths_output2.txt" />
    </test>
    <test>
      <conditional name="data_select">
        <param name="data_selector" value="windowCounts" />
        <repeat name="bam_input">
          <param name="bam_file" value="rep1.bam" ftype="bam" />
        </repeat>
        <repeat name="bam_input">
            <param name="bam_file" value="rep2.bam" ftype="bam" />
        </repeat>
        <param name="spacing" value="50" />
        <param name="width" value="1" />
        <conditional name="ext_selector">
            <param name="ext_select" value="integer" />
            <param name="ext" value="100" />
        </conditional>
        <param name="shift" value="0" />
        <param name="filter" value="1" />
        <param name="bin" value="false" />
        <conditional name="readParam_select">
          <param name="readParam_selector" value="yes" />
          <param name="pe" value="none" />
          <param name="max_frag" value="500" />
          <param name="dedup" value="false" />
          <param name="minq" value="" />
          <param name="forward" value="NA" />
          <param name="restrict" value="chrA" />
          <conditional name="discard_select">
            <param name="discard" value="yes" />
            <param name="GRanges" value="gRange_discard.tabular" />
          </conditional>
        </conditional>
      </conditional>
      <output name="output" value="getWidths_output3.txt" />
    </test>
    <test>
      <conditional name="data_select">
        <param name="data_selector" value="regionCounts" />
        <repeat name="bam_input">
          <param name="bam_file" value="rep1.bam" ftype="bam" />
        </repeat>
        <repeat name="bam_input">
            <param name="bam_file" value="rep2.bam" ftype="bam" />
        </repeat>
        <param name="GRanges" value="gRange_regionsCount.tabular" />
        <param name="named" value="true" />
        <conditional name="ext_selector">
          <param name="ext_select" value="integer" />
          <param name="ext" value="100" />
        </conditional>
        <conditional name="readParam_select">
            <param name="readParam_selector" value="no" />
        </conditional>
      </conditional>
      <output name="output" value="getWidths_output4.txt" />
    </test>
    <test>
      <conditional name="data_select">
        <param name="data_selector" value="regionCounts" />
        <repeat name="bam_input">
          <param name="bam_file" value="rep1.bam" ftype="bam" />
        </repeat>
        <repeat name="bam_input">
            <param name="bam_file" value="rep2.bam" ftype="bam" />
        </repeat>
        <param name="GRanges" value="gRange_regionsCount.tabular" />
        <param name="named" value="true" />
        <conditional name="ext_selector">
          <param name="ext_select" value="list" />
          <param name="ext_list1" value="50, 100" />
          <param name="ext_list2" value="80" />
        </conditional>
        <conditional name="readParam_select">
          <param name="readParam_selector" value="yes" />
          <param name="pe" value="none" />
          <param name="max_frag" value="500" />
          <param name="dedup" value="false" />
          <param name="minq" value="" />
          <param name="forward" value="NA" />
          <param name="restrict" value="chrB" />
          <conditional name="discard_select">
            <param name="discard" value="no" />
          </conditional>
        </conditional>
      </conditional>
      <output name="output" value="getWidths_output5.txt" />
    </test>
    <test>
      <conditional name="data_select">
        <param name="data_selector" value="regionCounts" />
        <repeat name="bam_input">
          <param name="bam_file" value="rep1.bam" ftype="bam" />
        </repeat>
        <repeat name="bam_input">
            <param name="bam_file" value="rep2.bam" ftype="bam" />
        </repeat>
        <param name="GRanges" value="gRange_regionsCount.tabular" />
        <param name="named" value="true" />
        <conditional name="ext_selector">
          <param name="ext_select" value="list" />
          <param name="ext_list1" value="50, 100" />
          <param name="ext_list2" value="80" />
        </conditional>
        <conditional name="readParam_select">
          <param name="readParam_selector" value="yes" />
          <param name="pe" value="none" />
          <param name="max_frag" value="500" />
          <param name="dedup" value="false" />
          <param name="minq" value="" />
          <param name="forward" value="NA" />
          <param name="restrict" value="chrB" />
          <conditional name="discard_select">
            <param name="discard" value="yes" />
            <param name="GRanges" value="gRange_discard.tabular" />
          </conditional>
        </conditional>
      </conditional>
      <output name="output" value="getWidths_output6.txt" />
    </test>
  </tests>

  <help><![CDATA[
       Get the widths of the read counting interval for each region.

       Widths of all regions are increased by the average fragment length during the calculations. This is because each count represents the number of (imputed) fragments overlapping each region. Thus, a 1 bp window has an effective width that includes the average length of each fragment.
    ]]></help>
  <expand macro="citations" />
</tool>