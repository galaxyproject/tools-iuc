<tool id="csaw_strandedCounts" name="strandedCounts" version="@VERSION@.0">
  <description>gets strand-specific counts</description>
  <macros>
    <import>csaw_macros.xml</import>
  </macros>
  <expand macro="requirements" />
  <command detect_errors="exit_code"><![CDATA[
    Rscript '$script']]>
  </command>
  <configfiles>
    <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)
library(Rsamtools)

bamFiles <- c()
#for $i in $bam_input
  bamFiles <- c(bamFiles, '${i.bam_file}')
#end for
indexBam(bamFiles)

@READPARAM_OBJ@
@GRANGES@

result <- strandedCounts(bam.files, param=p, regions=regions)

write.table(result, "$output", quote = FALSE, col.names = FALSE, row.names = FALSE)

]]>
    </configfile>
  </configfiles>
  <inputs>
    <repeat name="bam_input" title="Upload indexed BAM files in sorted order" >
      <param name="bam_file" type="data" format="bam" label="BAM file" />
    </repeat>
    <expand macro="readParam_select" />
    <conditional name="regions_select">
      <param name="regions_selector" type="select" label="Specify the regions over which reads are to be counted?">
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </param>
      <when value="yes">
        <expand macro="gRanges" />
        <conditional name="ext_selector">
          <param name="ext_select" type="select" label="Average length(s) of the sequenced fragments in each library" >
            <option value="integer" selected="true">Enter an integer</option>
            <option value="list">Enter two integers or lists</option>
          </param>
          <when value="integer">
            <param name="ext" type="integer" value="100" label="Enter an integer as the average length" />
          </when>
          <when value="list">
            <param name="ext_list1" type="text" optional="true" label="Enter an integer or vector" />
            <param name="ext_list2" type="text" optional="true" label="Enter an integer or vector" />
          </when>
        </conditional>
        <expand macro="readParam_select" />
      </when>
      <when value="no">
        <param name="spacing" type="integer" value="50" label="Distance between consecutive windows" help="New windows are defined by sliding the current window to the right by the specified spacing." />
        <param name="width" type="integer" value="" optional="true" label="Width of the window" help="The value of width can be interpreted as the width of the contact area between the DNA and protein. In practical terms, it determines the spatial resolution of the analysis. Larger windows count reads over a larger region which results in larger counts. This results in greater detection power at the cost of resolution." />
        <conditional name="ext_selector">
          <param name="ext_select" type="select" label="Average length(s) of the sequenced fragments in each library" >
            <option value="integer" selected="true">Single fragment length</option>
            <option value="list">Multiple fragment lengths</option>
          </param>
          <when value="integer">
            <param name="ext" type="integer" value="100" label="Enter an integer as the average length" />
          </when>
          <when value="list">
            <param name="ext_list1" type="text" optional="true" label="Enter an integer or list" help="When multiple fragment lengths are specified, enter a list of integers followed by a comma. e.g. 100, 150, 200, 250" />
            <param name="ext_list2" type="text" optional="true" label="Enter an integer or list" help="When multiple fragment lengths are specified, enter a list of integers followed by a comma. e.g. 100, 150, 200, 250" />
          </when>
        </conditional>
          <param name="shift" type="integer" value="0" label="Specifying how much the start of each window should be shifted to the left" help="The first window on a chromosome starts at base position 1. Specifying an appropriate value to shift to the left." />
          <param name="filter" type="integer" value="10" label="Minimum count sum across libraries for each window" />
          <param name="bin" type="boolean" truevalue="true" falsevalue="" checked="false" label="Perform binning?" help="If yes is selected, settings are internally adjusted so that all reads are counted into non-overlapping adjacent bins of size width." />
          <expand macro="readParam_select" />
      </when>
    </conditional>    
  </inputs>
  <outputs>
    <data name="output" format="txt" label="${tool.name} on ${on_string}: getWidths output" />
  </outputs>

  <tests>
    <test>
      <repeat name="bam_input">
        <param name="bam_file" value="rep1.bam" ftype="bam" />
      </repeat>
      <repeat name="bam_input">
        <param name="bam_file" value="rep2.bam" ftype="bam" />
      </repeat>
      <param name="GRanges" value="chrA, chrA, chrB, chrC" />
      <param name="IRanges" value="range1.tabular" />
      
      <output name="output" value="" />
    </test>
  </tests>

  <help><![CDATA[
    Obtain strand-specific counts for each genomic window or region.
    ]]></help>
  <expand macro="citations" />
</tool>