<tool id="csaw_extractReads" name="extractReads" version="@VERSION@.0">
    <description>extracts reads from a BAM file</description>
     <macros>
       <import>csaw_macros.xml</import>
    </macros>
     <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>
    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)
library(Rsamtools)
   
bamFile <- "$bam_file"
indexBam(bamFile)

 @GRANGES@

#if str($ext) != ""
    ext <- as.numeric("$ext")
#else
    ext <- NA
#end if

#if str($as_reads) == "true"
    as_reads <- TRUE
#else
    as_reads <- FALSE
#end if

 @READPARAM@

extractReads(bamFile, region, ext=ext, param=p, as.reads=as_reads)

]]>
        </configfile>
    </configfiles>
    <inputs>
        <param name="bam_file" type="data" format="bam" label="BAM file" />
        <param name="GRanges" type="text" label="Sequence Names of length 1 describing the region of interest" />
        <param name="IRanges" type="data" format="tabular" label="Ranges" help="Upload as a dataframe where the first column is the start position and the second column is the end position." />
        <param name="ext" type="integer" value="" optional="true" label="Specify the fragment length for directional read extension" help=" If a value is entered, then a directional read extension will be performed." />
        <expand macro="readParam_select" />
        <param name="as_reads" type="boolean" truevalue="true" falsevalue="" checked="false" label="Return reads instead of fragments for paired-end data?" />        
    </inputs>
    <outputs>
        <data name="output" format="txt" label="${tool.name} on ${on_string}: extractReads output" />
    </outputs>

    <tests>
        <test>
            <param name="bam_file" value="rep1.bam" ftype="bam" />
            <param name="GRanges" value="chrB" />
            <!--TODO: get Iranges values-->
            <param name="IRanges" value="" />
            <param name="ext" value="100" />
            <conditional name="readParam_select">
                <param name="readParam_selector" value="no" />
            </conditional>
            <param name="as_reads" value="true" />
            <output name="output" value="" />
        </test>
        <test>
            <param name="bam_file" value="rep1.bam" ftype="bam" />
            <param name="GRanges" value="chrB" />
            <!--TODO: get Iranges values-->
            <param name="IRanges" value="" />
            <param name="ext" value="100" />
            <conditional name="readParam_select">
                <param name="readParam_selector" value="yes" />
                <param name="pe" value="both" />
                <param name="max_frag" value="100" />
                <param name="dedup" value="false" />
                <param name="minq" value="20" />
                <param name="forward" value="NA" />
                <param name="restrict" value="" />
                <param name="discard" value="no" />
            </conditional>
            <param name="as_reads" value="true" />
            <output name="output" value="" />
        </test>
    </tests>

    <help><![CDATA[
       Extract reads from a BAM file with the specified parameter settings overlapping a given genomic interval. The aim is to supply the raw data for visualization, in a manner that maintains consistency with the rest of the analysis.
    ]]></help>
    <expand macro="citations" />
</tool>