<tool id="csaw_mergeWindows" name="Merge Windows" version="@VERSION@.0">
    <description> </description>

     <macros>
       <import>csaw_macros.xml</import>
    </macros>

     <expand macro="requirements" />

    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>

    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)

##mergeWindows
#if str($mergeWindows_select.mergeWindows) == 'yes'
    mW_gRange <- as.character(unlist(strsplit(gsub(" ", "", "${mergeWindows_select.GRanges}", ","), ",")))
        mW_b <- unlist(strsplit(gsub(" ", "", "${mergeWindows_select.IRanges}", ","), ";"))
        mW_c <- gsub("\\[|\\]", "", mW_b)
        mW_d <- lapply(mW_c, function(x){x <- as.numeric(unlist(strsplit(x, ",")))})
        mW_e <- c()
        mW_f <- c()
        for (i in seq(mW_d)){ 
            mW_e <- c(mW_e, mW_d[[i]][1])
            mW_f <- c(mW_f, mW_d[[i]][2])
        }
    mW_regions <- GRanges(mW_gRange, IRanges(mW_e,mW_f))
    mW_tol <- as.numeric("${mergeWindows_select.tol}")
    #if str($mergeWindows_select.max_width) != ''
        mW_maxWidth <- as.numeric("${consolidateSizes_select.max_width}")
    #else
        mW_maxWidth <- NULL
    #end if
    #if str($mergeWindows_select.ignore_strand) == 'true'
        ignore_strand <- T
    #else
        ignore_strand <- F
    #end if

sink("$mergeWindows_output")
    mergeWindows(mW_regions, mW_tol, sign=NULL, max.width=mW_maxWidth, ignore.strand=ignore_strand)
sink()

#end if






]]>
        </configfile>
    </configfiles>
    <inputs>
    	<conditional name="mergeWindows_select">
            <param name="mergeWindows" type="select" label="Use a simple single-linkage approach to merge adjacent or overlapping windows into clusters?" help="Windows in regions are merged if the gap between the end of one window and the start of the next is no greater than tol. Adjacent windows can then be chained together to build a cluster of windows across the linear genome.">
                <option value="yes">Yes</option>
                <option value="no" selected="true">No</option>
            </param>
            <when value="yes">
                <expand macro="gRanges" />
                <param name="tol" type="float" value="" optional="true" label="Maximum distance between adjacent windows" help="A value of zero means that the windows must be contiguous whereas negative values specify minimum overlaps" />
                <!--sign-->
                <param name="max_width" type="float" value="" optional="true" label="Maximum size of merged intervals" help="Specification prevents the formation of excessively large clusters when many adjacent regions are present. Any cluster that is wider than the max width is split into multiple subclusters of (roughly) equal size. Specifically, the cluster interval is partitioned into the smallest number of equally-sized subintervals where each subinterval is smaller than max width. Windows are then assigned to each subinterval based on the location of the window midpoints. Suggested values range from 2000 to 10000 bp, but no limits are placed on the maximum size if no value entered." />
                <param name="ignore_strand" type="boolean" truevalue="true" falsevalue="" checked="true" label="Ignore the strandedness of regions?" help="If no is selected, the entries in regions are split into their separate strands." />
            </when>
            <when value="no"> </when>

        </conditional>
    </inputs>

    <outputs>
        <data name="output" format="txt" label="${tool.name} on ${on_string}: checkBiomodality output" />
    </outputs>

    <tests>
        <test>
            <repeat name="bam_input">
                <param name="bam_file" value="rep1.bam" ftype="bam" />
            </repeat>
            <repeat name="bam_input">
                <param name="bam_file" value="rep2.bam" ftype="bam" />
            </repeat>
            <param name="GRanges" value="chrA, chrA, chrB, chrC" />
            <param name="IRanges" value="range1.tabular" />
            <param name="width" value="200" />
            <conditional name="readParam_select">
                <param name="readParam_selector" value="no" />
            </conditional>
            <param name="prior_count" value="5" />
            <param name="invert" value="false" />
            <output name="output" file="checkBiomodality_output1.txt" />
        </test>
        <test>
            <repeat name="bam_input">
                <param name="bam_file" value="rep1.bam" ftype="bam" />
            </repeat>
            <repeat name="bam_input">
                <param name="bam_file" value="rep2.bam" ftype="bam" />
            </repeat>
            <param name="GRanges" value="chrA, chrA, chrB, chrC" />
            <param name="IRanges" value="range1.tabular" />
            <param name="width" value="200" />
            <conditional name="readParam_select">
                <param name="readParam_selector" value="yes" />
                <param name="pe" value="both" />
                <param name="max_frag" value="100" />
                <param name="dedup" value="false" />
                <param name="minq" value="20" />
                <param name="forward" value="NA" />
                <param name="restrict" value="" />
                <param name="discard" value="no" />
            </conditional>
            <param name="prior_count" value="5" />
            <param name="invert" value="False" />
            <output name="output" file="checkBiomodality_output2.txt" />
        </test>
        <test>
            <repeat name="bam_input">
                <param name="bam_file" value="rep1.bam" ftype="bam" />
            </repeat>
            <repeat name="bam_input">
                <param name="bam_file" value="rep2.bam" ftype="bam" />
            </repeat>
            <param name="GRanges" value="chrA, chrA, chrB, chrC" />
            <param name="IRanges" value="range1.tabular" />
            <param name="width" value="200" />
            <conditional name="readParam_select">
                <param name="readParam_selector" value="yes" />
                <param name="pe" value="both" />
                <param name="max_frag" value="100" />
                <param name="dedup" value="false" />
                <param name="minq" value="20" />
                <param name="forward" value="NA" />
                <param name="restrict" value="mitochondria" />
                <conditional name="discard_select">
                    <param name="discard" value="yes" />
                    <param name="GRanges" value="chrA" />
                    <param name="IRanges" value="range_readParam.tabular" />
                </conditional>
            </conditional>
            <param name="prior_count" value="5" />
            <param name="invert" value="False" />
            <output name="output" file="checkBiomodality_output3.txt" />
        </test>
    </tests>

    <help><![CDATA[
        
    ]]></help>


</tool>