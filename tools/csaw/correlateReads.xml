<tool id="csaw_correlateReads" name="correlateReads" version="@VERSION@.0">
    <description>compute correlation coefficients between reads</description>
     <macros>
       <import>csaw_macros.xml</import>
    </macros>
     <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>
    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)
library(Rsamtools)

bamFiles <- c()
#for $i in $bam_input
    bamFiles <- c(bamFiles, '${i.bam_file}')
#end for
indexBam(bamFiles)

max_dist <- as.numeric("$max_dist")
#if str($cross) == "true"
    cross <- TRUE
#else
    cross <- FALSE
#end if

@READPARAM@

result <- correlateReads(bamFiles, max.dist=max_dist, cross=cross, param=p)

write.table(result, file = "$output", quote = FALSE, col.names = FALSE, row.names=FALSE)

]]>
        </configfile>
    </configfiles>
    <inputs>
        <repeat name="bam_input" title="Upload indexed BAM files in sorted order" >
            <param name="bam_file" type="data" format="bam" label="BAM file" />
        </repeat>
        <param name="max_dist" type="integer" value="1000" label="Specify the maximum delay distance over which correlation coefficients will be calculated" />
        <param name="cross" type="boolean" truevalue="true" falsevalue="" checked="true" label="Compute cross-correlations?" help="If yes is selected, then reads are separated into those mapping on the forward and reverse strands. If no is selected, then auto-correlation coefficients are computed without use of strand information." />
        <expand macro="readParam_select" />
    </inputs>
    <outputs>
        <data name="output" format="txt" label="${tool.name} on ${on_string}: correlateReads output" />
    </outputs>

    <tests>
        <test>
            <repeat name="bam_input">
                <param name="bam_file" value="rep1.bam" ftype="bam" />
            </repeat>
            <param name="max_dist" value="1000" />
            <param name="cross" value="true" />
            <conditional name="readParam_select">
                <param name="readParam_selector" value="no" />
            </conditional>
            <output name="output" value="correlateReads_output1.txt" />
        </test>
        <test>
            <repeat name="bam_input">
                <param name="bam_file" value="rep1.bam" ftype="bam" />
            </repeat>
            <param name="max_dist" value="1000" />
            <param name="cross" value="true" />
            <conditional name="readParam_select">
                <param name="readParam_selector" value="yes" />
                <param name="pe" value="both" />
                <param name="max_frag" value="100" />
                <param name="dedup" value="false" />
                <param name="minq" value="20" />
                <param name="forward" value="NA" />
                <param name="restrict" value="chrA" />
                <conditional name="discard_select">
                    <param name="discard" value="no" />
                </conditional>
            </conditional>
            <output name="output" value="correlateReads_output2.txt" />
        </test>
         <test>
            <repeat name="bam_input">
                <param name="bam_file" value="rep1.bam" ftype="bam" />
            </repeat>
            <param name="max_dist" value="1000" />
            <param name="cross" value="true" />
            <conditional name="readParam_select">
                <param name="readParam_selector" value="yes" />
                <param name="pe" value="both" />
                <param name="max_frag" value="100" />
                <param name="dedup" value="false" />
                <param name="minq" value="20" />
                <param name="forward" value="NA" />
                <param name="restrict" value="" />
                <conditional name="discard_select">
                    <param name="discard" value="yes" />
                    <param name="GRanges" value="chrA" />
                    <param name="IRanges" value="range1.tabular" />
                </conditional>
            </conditional>
            <output name="output" value="correlateReads_output3.txt" />
        </test>
    </tests>

    <help><![CDATA[
        Computes the auto- or cross-correlation coefficients between read positions across a set of delay intervals. If multiple BAM files are specified, the reads from all libraries are pooled prior to calculation of the correlation coefficients. This is convenient for determining the average correlation profile across an entire dataset.
    ]]></help>
    <expand macro="citations" />
</tool>