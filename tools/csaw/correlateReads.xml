<tool id="csaw_correlateReads" name="correlateReads" version="@VERSION@.0">
    <description>compute correlation coefficients between reads</description>
     <macros>
       <import>csaw_macros.xml</import>
    </macros>
     <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>
    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)
library(Rsamtools)

bamFiles <- c()
#for $i in $bam_input
    bamFiles <- c(bamFiles, '${i.bam_file}')
#end for
indexBam(bamFiles)

max_dist <- as.numeric("$max_dist")
#if str($cross) == "true"
    cross <- TRUE
#else
    cross <- FALSE
#end if

@READPARAM@

result1 <- correlateReads(bamFiles, max.dist=max_dist, cross=cross, param=p)

write.table(result1, file = "$output", quote = FALSE, col.names = FALSE, row.names=FALSE)

#if str($maximizeCcf_select.maximizeCcf_selector) == "yes"
    ignore <- as.numeric("$maximizeCcf_select.ignore")
    result2 <- maximizeCcf(result1, ignore=ignore)

    write.table(result2, file = "$maximizeCcf_output", quote = FALSE, col.names = FALSE, row.names=FALSE)
#end if
]]>
        </configfile>
    </configfiles>
    <inputs>
        <repeat name="bam_input" title="Upload indexed BAM files in sorted order" >
            <param name="bam_file" type="data" format="bam" label="BAM file" />
        </repeat>
        <param name="max_dist" type="integer" value="1000" label="Specify the maximum delay distance over which correlation coefficients will be calculated" />
        <param name="cross" type="boolean" truevalue="true" falsevalue="" checked="true" label="Compute cross-correlations?" help="If yes is selected, then reads are separated into those mapping on the forward and reverse strands. If no is selected, then auto-correlation coefficients are computed without use of strand information." />
        <expand macro="readParam_select" />
        <conditional name="maximizeCcf_select">
            <param name="maximizeCcf_selector" type="select" label="Estimate the average fragment length by maximizing the cross-correlations?" >
                <option value="yes">Yes</option>
                <option value="no" selected="true">No</option>
            </param>
            <when value="yes">
                <param name="ignore" type="integer" value="100" label="Specify the distances to ignore" />
            </when>
            <when value="no"> </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="output" format="txt" label="${tool.name} on ${on_string}: output" />
        <data name="maximizeCcf_output" format="txt" label="maximizeCcf on ${on_string}: output" >
            <filter>maximizeCcf_select['maximizeCcf_selector'] == 'yes'</filter>
        </data>
    </outputs>

    <tests>
        <test expect_num_outputs="2">
            <repeat name="bam_input">
                <param name="bam_file" value="rep1.bam" ftype="bam" />
            </repeat>
            <param name="max_dist" value="1000" />
            <param name="cross" value="true" />
            <conditional name="readParam_select">
                <param name="readParam_selector" value="no" />
            </conditional>
            <conditional name="maximizeCcf_select">
                <param name="maximizeCcf_selector" value="yes" />
                <param name="ignore" value="100" />
            </conditional>
            <output name="output" value="correlateReads_output1.txt" />
            <output name="maximizeCcf_output" value="maximizeCcf__output.txt" />
        </test>
        <test expect_num_outputs="1">
            <repeat name="bam_input">
                <param name="bam_file" value="rep1.bam" ftype="bam" />
            </repeat>
            <param name="max_dist" value="1000" />
            <param name="cross" value="true" />
            <conditional name="readParam_select">
                <param name="readParam_selector" value="yes" />
                <param name="pe" value="both" />
                <param name="max_frag" value="100" />
                <param name="dedup" value="false" />
                <param name="minq" value="20" />
                <param name="forward" value="NA" />
                <param name="restrict" value="chrA" />
                <conditional name="discard_select">
                    <param name="discard" value="no" />
                </conditional>
            </conditional>
            <conditional name="maximizeCcf_select">
                <param name="maximizeCcf_selector" value="no" />
            </conditional>
            <output name="output" value="correlateReads_output2.txt" />
        </test>
         <test expect_num_outputs="1">
            <repeat name="bam_input">
                <param name="bam_file" value="rep1.bam" ftype="bam" />
            </repeat>
            <param name="max_dist" value="1000" />
            <param name="cross" value="true" />
            <conditional name="readParam_select">
                <param name="readParam_selector" value="yes" />
                <param name="pe" value="both" />
                <param name="max_frag" value="100" />
                <param name="dedup" value="false" />
                <param name="minq" value="20" />
                <param name="forward" value="NA" />
                <param name="restrict" value="" />
                <conditional name="discard_select">
                    <param name="discard" value="yes" />
                    <param name="GRanges" value="gRange_discard.tabular" />
                </conditional>
            </conditional>
            <conditional name="maximizeCcf_select">
                <param name="maximizeCcf_selector" value="no" />
            </conditional>
            <output name="output" value="correlateReads_output3.txt" />
        </test>
    </tests>

    <help><![CDATA[
Computes the auto- or cross-correlation coefficients between read positions across a set of delay intervals
===========================================================================================================

If multiple BAM files are specified, the reads from all libraries are pooled prior to calculation of the correlation coefficients. This is convenient for determining the average correlation profile across an entire dataset.

It returns:

- `correlation`: a column of length max.dist+1 containing the correlation coefficients for each delay interval from 0 to max.dist.

Estimate the average fragment length by maximizing the cross-correlations
=========================================================================

If selected, the delay distance at which the cross-correlations are maximized will be identified. This distance can then be used as an estimate of the average fragment length, for use in directional extension during read counting. In some datasets, identification of the maxima is confounded by a phantom peak at the read length. This can be overcome by ignoring the first ignore delay distances, such that the distance corresponding to the true peak is used. Obviously, this only works in TF experiments with moderate to strong enrichment, where a strong peak in the CCF profile is present. The function may not perform sensibly in the presence of noisy profiles containing multiple local maxima.

It returns:

- `average fragment length `: a number

    ]]></help>
    <expand macro="citations" />
</tool>