<tool id="csaw_consolidateClusters" name="consolidateClusters" version="@VERSION@.0">
    <description>consolidate DB clusters</description>
    <macros>
       <import>csaw_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$script'
    ]]></command>
    <configfiles>
        <configfile name="script"><![CDATA[
## Setup R error handling to go to stderr
options(show.error.messages=F, error=function(){cat(geterrmessage(),file=stderr());q("no",1,F)})
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

## Import library
library(csaw)

## DATALIST
gRangeList <- list()
#for $i in $gRange_obj
    gRangeList <- append(gRangeList, list(read.table("${i.GRanges}")))
#end for
dataList <- c()
for (i in seq(gRangeList)){
    dataList <- c(dataList, GRanges(gRangeList[[i]][[1]], IRanges(gRangeList[[i]][[2]], gRangeList[[i]][[3]])))
}

## RESULTLIST
resultList <- list()
#for $i in $db
    resultList <- append(resultList, list(read.table("${i.result_list}", header=T)))
#end for

#if str($equiweight) == 'true'
    equiweight <- TRUE
#else
    equiweight <- FALSE
#end if

#if str($clusterWindows_select.clusterWindows_selector) == "yes"
    target <- as.numeric("$clusterWindows_select.target")

    #if str($clusterWindows_select.pval_col) != ''
        pval_col <- as.numeric(gsub("([0-9]+).*$", "\\1", "$clusterWindows_select.pval_col"))
        if (is.na(pval_col)){
            pval_col <- "$clusterWindows_select.pval_col"
        }
    #else
        pval_col <- NULL
    #end if
    #if str($clusterWindows_select.fc_col) != ''
        fc_col <- as.numeric(gsub("([0-9]+).*$", "\\1", "$clusterWindows_select.fc_col"))
        if (is.na(fc_col)){
            fc_col <- "$clusterWindows_select.fc_col"
        }
    #else
        fc_col <- NA
    #end if

    tol <- as.numeric("$clusterWindows_select.tol")
    grid_length <- as.numeric("$clusterWindows_select.grid_length")
    iterations <- as.numeric("$clusterWindows_select.iterations")

    #if str($clusterWindows_select.mergeWindows_select.mergeWindows_selector) == "yes"

        ############# Sign parameter not working #######################
        #if str($clusterWindows_select.mergeWindows_select.sign_select.sign_selector) == "yes"
            sign <- scan("$clusterWindows_select.mergeWindows_select.sign_select.sign", what=logical())
        #else 
            sign <- NULL
        #end if
        ################################################################
        
        #if str($clusterWindows_select.mergeWindows_select.max_width) != ""
            max_width <- as.numeric("$clusterWindows_select.mergeWindows_select.max_width")
        #else
            max_width <- NULL
        #end if

        #if str($clusterWindows_select.mergeWindows_select.ignore_strand) == "yes"
            ignore_strand <- TRUE
        #else
            ignore_strand <- FALSE
        #end if

        result <- consolidateClusters(dataList, resultList, equiweight=equiweight, target=target, pval.col=pval_col, fc.col=fc_col, tol=tol,  max.width=max_width, ignore.strand=ignore_strand, grid.length=grid_length, iterations=iterations)
    #else
        result <- consolidateClusters(dataList, resultList, equiweight=equiweight, target=target, pval.col=pval_col, fc.col=fc_col, tol=tol, grid.length=grid_length, iterations=iterations)
    #end if
#else
    result <- consolidateClusters(dataList, resultList, equiweight=equiweight)
#end if

ids <- result[[1]]
lapply(ids, cat, "\n", file="$id_output", append=TRUE)
region <- result[[2]]
write.table(region, file="$region_output", quote = FALSE, row.names = FALSE, col.names = TRUE)
f <- list(result[[3]])
write.table(do.call(rbind, f), file="$fdr_output", quote = FALSE, row.names = c("FDR "), col.names = FALSE)
]]>
        </configfile>
    </configfiles>
    <inputs>
        <repeat name="gRange_obj" title="Enter GRanges objects">
          <expand macro="gRanges" />
        </repeat>
        <repeat name="db" title="Upload dataframes containing the DB test results for each entry of data">
          <param name="result_list" type="data" format="tabular" label="DB test results" />
        </repeat>
        <param name="equiweight" type="boolean" truevalue="true" falsevalue="" checked="true" label="Enforce equal weighting from each analysis?" help="Some effort is required to equalize the contribution of the results from each analysis. This is done by setting selecting yes, where the weight of each window is inversely proportional to the number of windows from that analysis." />
        <conditional name="clusterWindows_select">
            <param name="clusterWindows_selector" type="select" label="Specify clusterWindows parameters?" >
                <option value="yes">Yes</option>
                <option value="no" selected="true">No</option>
            </param>
            <when value="yes">
                <param name="target" type="float" value="" label="Desired cluster-level FDR" />
                <expand macro="col_names" />
                <param name="tol" type="float" value="" optional="true" label="Maximum distance between adjacent windows"/>
                <expand macro="mergeWindows_select" />
                <!--Excluded weight because for internal use was noted-->
                <param name="grid_length" type="integer" value="21" label="Specify the number of points to use in the grid search" />
                <param name="iterations" type="integer" value="4" label="Specify the number of iterations of the grid search" />
            </when>
            <when value="no"> </when>
        </conditional>
    </inputs>

    <outputs>
        <data name="id_output" format="txt" label="${tool.name} on ${on_string}: consolidateClusters id output" />
        <data name="region_output" format="txt" label="${tool.name} on ${on_string}: consolidateClusters region output" />
        <data name="fdr_output" format="txt" label="${tool.name} on ${on_string}: consolidateClusters FDR output" />
    </outputs>

    <tests>
        <test>
            <repeat name="gRange_obj">
                <param name="GRanges" value="gRange_conclus1.tabular" />
            </repeat>
            <repeat name="gRange_obj">
                <param name="GRanges" value="gRange_conclus2.tabular" />
            </repeat>
            <repeat name="gRange_obj">
                <param name="GRanges" value="gRange_conclus3.tabular" />
            </repeat>
            <repeat name="db">
                <param name="result_list" value="db1.tabular" />
            </repeat>
            <repeat name="db">
                <param name="result_list" value="db2.tabular" />
            </repeat>
            <repeat name="db">
                <param name="result_list" value="db3.tabular" />
            </repeat>
            <param name="equiweight" value="true" />
            <conditional name="clusterWindows_select">
                <param name="clusterWindows_selector" value="no" />
            </conditional>
            <output name="id_output" file="consolidateClusters_id_output1.txt"/>
            <output name="region_output" file="consolidateClusters_region_output1.txt"/>
            <output name="fdr_output" file="consolidateClusters_FDR_output1.txt"/>
        </test>
        <test>
            <repeat name="gRange_obj">
                <param name="GRanges" value="gRange_conclus1.tabular" />
            </repeat>
            <repeat name="gRange_obj">
                <param name="GRanges" value="gRange_conclus2.tabular" />
            </repeat>
            <repeat name="gRange_obj">
                <param name="GRanges" value="gRange_conclus3.tabular" />
            </repeat>
            <repeat name="db">
                <param name="result_list" value="db1.tabular" />
            </repeat>
            <repeat name="db">
                <param name="result_list" value="db2.tabular" />
            </repeat>
            <repeat name="db">
                <param name="result_list" value="db3.tabular" />
            </repeat>
            <param name="equiweight" value="true" />
            <conditional name="clusterWindows_select">
                <param name="clusterWindows_selector" value="yes" />
                <param name="target" value="0.05" />
                <param name="pval_col" value="PValue" />
                <param name="fc_col" value="logFC" />
                <param name="tol" value="20" />
                <conditional name="mergeWindows_select" >
                    <param name="mergeWindows_selector" value="no" />
                </conditional>
                <param name="grid_length" value="21" />
                <param name="iterations" value="4" />
            </conditional>
            <output name="id_output" file="consolidateClusters_id_output2.txt"/>
            <output name="region_output" file="consolidateClusters_region_output2.txt"/>
            <output name="fdr_output" file="consolidateClusters_FDR_output2.txt"/>
        </test>
        <test>
            <repeat name="gRange_obj">
                <param name="GRanges" value="gRange_conclus1.tabular" />
            </repeat>
            <repeat name="gRange_obj">
                <param name="GRanges" value="gRange_conclus2.tabular" />
            </repeat>
            <repeat name="gRange_obj">
                <param name="GRanges" value="gRange_conclus3.tabular" />
            </repeat>
            <repeat name="db">
                <param name="result_list" value="db1.tabular" />
            </repeat>
            <repeat name="db">
                <param name="result_list" value="db2.tabular" />
            </repeat>
            <repeat name="db">
                <param name="result_list" value="db3.tabular" />
            </repeat>
            <param name="equiweight" value="true" />
            <conditional name="clusterWindows_select">
                <param name="clusterWindows_selector" value="yes" />
                <param name="target" value="0.05" />
                <param name="pval_col" value="PValue" />
                <param name="fc_col" value="PValue" />
                <param name="tol" value="20" />
                <conditional name="mergeWindows_select" >
                     <param name="mergeWindows_selector" value="yes" />
                    <param name="max_width" value="10" />
                    <param name="ignore_strand" value="false" />
                </conditional>
                <param name="grid_length" value="21" />
                <param name="iterations" value="4" />
            </conditional>
            <output name="id_output" file="consolidateClusters_id_output3.txt"/>
            <output name="region_output" file="consolidateClusters_region_output3.txt"/>
            <output name="fdr_output" file="consolidateClusters_FDR_output3.txt"/>
        </test>
    </tests>

    <help><![CDATA[
        Consolidate DB results from multiple analyses with cluster-level FDR control typically involving different window sizes. The aim is to provide comprehensive detection of DB at a range of spatial resolutions. Significant windows from each analysis are identified and used for clustering with cluster windows. This represents the post-hoc counterpart to consolidateSizes.
    ]]></help>
    <expand macro="citations" />
</tool>