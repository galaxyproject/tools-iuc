<tool id="sourmash_tax_grep" name="sourmash tax grep" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>searches taxonomies for matching strings</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        sourmash tax grep
        
        '$pattern'
        --taxonomy
        #for $t in $taxonomy_files:
            '$t'
        #end for
        #if $rank:
            -r '$rank'
        #end if
        $ignore_case
        $output_non_match
        -o pattern.csv
    ]]></command>
    <inputs>
        <expand macro="tax_files" help="The 'tax grep' searches taxonomies for matching strings and saves them into a new database."/>
        <param name="pattern" label="Pattern" type="text" help="Pattern is a regular expression. Note: tax grep only searches taxonomic ranks, not identifier strings.">
            <sanitizer>
                <valid initial="string.printable"/>
            </sanitizer>
        </param>
        <param name="rank" type="select" label="Rank" optional="true" help="Restrict query to this rank. Note that the taxonomy CSV must contain lineage information at this rank">
            <option value="species">Species</option>
            <option value="genus">Genus</option>
            <option value="family">Family</option>
            <option value="order">Order</option>
            <option value="class">Class</option>
            <option value="phylum">Phylum</option>
            <option value="superkingdom">Superkingdom</option>
        </param>
        <param name="ignore_case" argument="-i" label="Ignore case" type="boolean" value="false" truevalue="-i" falsevalue="" help="Ignore the case of the regular expression"/>
        <param name="output_non_match" argument="-v" label="Output not match" type="boolean" value="false" truevalue="-v" falsevalue="" help="output only taxonomic lineages that do not match the pattern"/>
    </inputs>
    <outputs>
        <data name="grep" from_work_dir="pattern.csv" format="csv" label="${tool.name} on ${on_string}: grep matches"/>
    </outputs>
    <tests>
        <!-- 1) grep  -->
        <test expect_num_outputs="1">
            <param name="taxonomy_files" value="test.ncbi-taxonomy.csv"/>
            <param name="pattern" value="coli"/>
            <output name="grep" ftype="csv">
                <assert_contents>
                    <has_n_lines n="2"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kfound 1 matches; saved identifiers to picklist file "/>
            </assert_stderr>
        </test>
        <!-- 2) grep + rank-->
        <test expect_num_outputs="1">
            <param name="taxonomy_files" value="test.ncbi-taxonomy.csv"/>
            <param name="pattern" value="coli"/>
            <param name="rank" value="class"/>
            <output name="grep" ftype="csv">
                <assert_contents>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kfound 0 matches; saved identifiers to picklist file "/>
            </assert_stderr>
        </test>
        <!-- 3) grep + ignore case-->
        <test expect_num_outputs="1">
            <param name="taxonomy_files" value="test.ncbi-taxonomy.csv"/>
            <param name="pattern" value="COLI"/>
            <param name="ignore_case" value="true"/>
            <output name="grep" ftype="csv">
                <assert_contents>
                    <has_n_lines n="2"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kfound 1 matches; saved identifiers to picklist file "/>
            </assert_stderr>
        </test>
        <!-- 4) grep + output non match-->
        <test expect_num_outputs="1">
            <param name="taxonomy_files" value="test.ncbi-taxonomy.csv"/>
            <param name="pattern" value="coli"/>
            <param name="output_non_match" value="true"/>
            <output name="grep" ftype="csv">
                <assert_contents>
                    <has_n_lines n="6"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kfound 5 matches; saved identifiers to picklist file "/>
            </assert_stderr>
        </test>
    </tests>
    <help><![CDATA[
        **Sourmash Taxonomy**

        The sourmash tax subcommands support taxonomic analysis of genomes and taxonomic profiling of metagenomes.

        **grep**
        
        Subsets taxonomies and creates picklists based on string matches in lineage names.

        @taxa_file_help@
    ]]></help>
    <expand macro="citations"/>
</tool>
