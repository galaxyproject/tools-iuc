<tool id="sourmash_plot" name="sourmash plot" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>plot comparison matrix</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        ln -s $input cmp.dist &&
        #if $labels_cond.labels_param == "--labels" or $labels_cond.labels_param == "--indices" :
            ln -s $labels_cond.labels_file cmp.dist.labels.txt &&
        #end if
        
        sourmash plot cmp.dist
        #if $labels_cond.labels_param == "--labels-from":
            $labels_cond.labels_param $labels_cond.labels_file_csv
        #else:
            $labels_cond.labels_param
        #end if

        ### advanced settings        
        --vmin $advanced_settings.vmin
        --vmax $advanced_settings.vmax
        --subsample-seed=$advanced_settings.subsample_seed

        #if $advanced_settings.subsample:
        --subsample=$advanced_settings.subsample
        #end if
        ]]></command>
    <inputs>
        <param name="input" type="data" format="binary" label="Input file" help="input file generated distance matrix file generated with sourmash compare"/>
        <conditional name="labels_cond">
            <param name="labels_param" type="select" label="Show label or indices" help="show sample labels on dendrogram/matrix">
                <option value="--labels">Labels from text file</option>
                <option value="--labels-from">Labels from csv file</option>
                <option value="--indices">Indices</option>
                <option value="--no-labels --no-indices" selected="true"> None</option>
            </param>
            <when value="--labels">
                <param name="labels_file" type="data" format="txt" label="Lables file" help="labels text file generated with sourmash compare"/>
            </when>
            <when value="--labels-from">
                <param name="labels_file_csv" type="data" format="csv" label="Lables file" help="labels csv file generated with sourmash compare"/>
            </when>
            <when value="--indices">
                <param name="labels_file" type="data" format="txt" label="Lables file" help="labels file generated with sourmash compare"/>
            </when>
            <when value="--no-labels --no-indices"/>
        </conditional>
        <section name="advanced_settings" title="Advanced Settings" expanded="no">
            <param argument="--vmax" type="float" value="1.0" min="0" max="1.0" label="Max Heatmap value" help=""/>
            <param argument="--vmin" type="float" value="0.0" min="0" max="1.0" label="Max Heatmap value" help=""/>
            <param name="subsample" type="integer" optional="true" min="1" label="Subsample count" help="Randomly downsample the distance matrix to this number of samples before plotting. Use to speed up plotting large matrices. Leave empty to use all samples."/>
            <param name="subsample_seed" type="integer" value="1" min="0" label="Random seed" help="Seed for the subsampling process. Use a fixed seed for reproducible plots."/>
        </section>
    </inputs>
    <outputs>
        <data name="matrix" format="png" from_work_dir="cmp.dist.matrix.png" label='${tool.name} on ${on_string}: matrix'/>
        <data name="histogram" format="png" from_work_dir="cmp.dist.hist.png" label='${tool.name} on ${on_string}: histogram'/>
        <data name="dendrogram" format="png" from_work_dir="cmp.dist.dendro.png" label='${tool.name} on ${on_string}: dendrogram'/>
    </outputs>
    <tests>
        <!-- 1) no labels only indices-->
        <test expect_num_outputs="3">
            <param name="input" value="cmp.dist" />
            <output name="matrix" ftype="png">
                <assert_contents>
                    <has_size size="12k" delta="3k"/>
                </assert_contents>
            </output>
            <output name="histogram" ftype="png">
                <assert_contents>
                    <has_size size="9k" delta="3k"/>
                </assert_contents>
            </output>
            <output name="dendrogram" ftype="png">
                <assert_contents>
                    <has_size size="4k" delta="3k"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <not_has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
            </assert_stdout>
        </test>
        <!-- 2) labels-->
        <test expect_num_outputs="3">
            <param name="input" value="cmp.dist" />       
            <conditional name="labels_cond">
                <param name="labels_param" value="--labels"/>
                <param name="labels_file" value="cmp.dist.labels.txt"/>
            </conditional>
            <output name="matrix" ftype="png">
                <assert_contents>
                    <has_size size="22k" delta="2k"/>
                </assert_contents>
            </output>
            <output name="histogram" ftype="png">
                <assert_contents>
                    <has_size size="9k" delta="3k"/>
                </assert_contents>
            </output>
            <output name="dendrogram" ftype="png">
                <assert_contents>
                    <has_size size="7k" delta="3k"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <has_text_matching expression="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
            </assert_stdout>
        </test>
        <!-- 3) no labels no indices-->
        <test expect_num_outputs="3">
            <param name="input" value="cmp.dist" />       
            <conditional name="labels_cond">
                <param name="labels_param" value="--no-labels --no-indices"/>
            </conditional>   
            <output name="matrix" ftype="png">
                <assert_contents>
                    <has_size size="11k" delta="3k"/>
                </assert_contents>
            </output>
            <output name="histogram" ftype="png">
                <assert_contents>
                    <has_size size="9k" delta="3k"/>
                </assert_contents>
            </output>
            <output name="dendrogram" ftype="png">
                <assert_contents>
                    <has_size size="3k" delta="3k"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <not_has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
            </assert_stdout>
        </test>
        <!-- 4) vmin vmax -->
        <test expect_num_outputs="3">
            <param name="input" value="cmp.dist" />       
            <conditional name="labels_cond">
                <param name="labels_param" value="--no-labels --no-indices"/>
            </conditional>
            <section name="advanced_settings">
                <param name="vmax" value="0.5"/>
                <param name="vmin" value="0.3"/>
            </section>
            <output name="matrix" ftype="png">
                <assert_contents>
                    <has_size size="17k" delta="3k"/>
                </assert_contents>
            </output>
            <output name="histogram" ftype="png">
                <assert_contents>
                    <has_size size="10k" delta="3k"/>
                </assert_contents>
            </output>
            <output name="dendrogram" ftype="png">
                <assert_contents>
                    <has_size size="4k" delta="3k"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <not_has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
            </assert_stdout>
        </test>
        <!-- 5) subsample -->
        <test expect_num_outputs="3">
            <param name="input" value="cmp.dist" />       
            <conditional name="labels_cond">
                <param name="labels_param" value="--no-labels --no-indices"/>
            </conditional>
            <section name="advanced_settings">
                <param name="subsample" value="5"/>
            </section>
            <output name="matrix" ftype="png">
                <assert_contents>
                    <has_size size="12k" delta="3k"/>
                </assert_contents>
            </output>
            <output name="histogram" ftype="png">
                <assert_contents>
                    <has_size size="10k" delta="3k"/>
                </assert_contents>
            </output>
            <output name="dendrogram" ftype="png">
                <assert_contents>
                    <has_size size="4k" delta="3k"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <not_has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
            </assert_stdout>
        </test>
        <!-- 6) subsample seed -->
        <test expect_num_outputs="3">
            <param name="input" value="cmp.dist" />       
            <conditional name="labels_cond">
                <param name="labels_param" value="--no-labels --no-indices"/>
            </conditional>
            <section name="advanced_settings">
                <param name="subsample_seed" value="15"/>
            </section>
            <output name="matrix" ftype="png">
                <assert_contents>
                    <has_size size="12k" delta="3k"/>
                </assert_contents>
            </output>
            <output name="histogram" ftype="png">
                <assert_contents>
                    <has_size size="10k" delta="3k"/>
                </assert_contents>
            </output>
            <output name="dendrogram" ftype="png">
                <assert_contents>
                    <has_size size="4k" delta="3k"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <not_has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
            </assert_stdout>
        </test>
    </tests>
    <help><![CDATA[
    **What the tool does?**

    Sourmash plot produces two plots from a matrix created by sourmash compare:
    
    - a dendrogram - a tree like diagram showing how similar samples cluster together.
    - a dendrogram+matrix - dendrogram placed beside a heatmap of the distance matrix so you see both clustering and pairwise distances at the same time.
        
    **Input files**
        
    a distance matrix file (cmp.dist) generated by *sourmash compare*
    ]]></help>
    <expand macro="citations"/>
</tool>
