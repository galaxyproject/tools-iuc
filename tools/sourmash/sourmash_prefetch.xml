<tool id="sourmash_prefetch" name="sourmash prefetch" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>search a scaled signature for matches in a large database of genomes, using containment</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        @Picklist_copy_file@

        sourmash prefetch
        '$query_sig'
        #for $i in $databases:
            '$i'
        #end for

        @common_params_commandline@
        --threshold-bp $threshold_bp

        ## outputs
        -o $prefetch_csv
        #if $output_options.save_matches:
            --save-matches '$matches_sig'
        #end if
        #if $output_options.save_matching_hashes:
            --save-matching-hashes '$matching_hashes_sig'
        #end if
        #if $output_options.save_unmatched_hashes:
            --save-unmatched-hashes '$unmatched_hashes_sig'
        #end if

        @Picklist_commandline@
    ]]></command>
    <inputs>
        <param name="query_sig" type="data" format="sourmash.sig" label="Query signature" help="Scaled (FracMinHash) signature used as the query (often a metagenome or genome signature)."/>
        <param name="databases" type="data" format="zip,sourmash.sig" multiple="true" label="Database(s)" help="One or more signature collections / indexed databases to search."/>
        <param argument="--threshold-bp" type="integer" value="50000" min="1" label="Minimum overlap" help="Require at least this many estimated overlapping base pairs to report/save a match."/>
        <section name="output_options" title="Outputs" expanded="true">
            <param argument="--save-matches" type="boolean" checked="false" label="Save matching signatures" help="Save all matching signatures (as a multi-signature .sig)."/>
            <param argument="--save-matching-hashes" type="boolean" checked="false" label="Save matching hashes" help="Save one signature containing hashes that matched any DB signature at/above threshold."/>
            <param argument="--save-unmatched-hashes" type="boolean" checked="false" label="Save unmatched hashes" help="Save one signature containing the complement of matching hashes."/>
        </section>
        <section name="sig_select" title="Signature selectors" expanded="false">
            <expand macro="ksize_macro"/>
            <expand macro="mol_type_macro"/>
            <expand macro="scaled_macro"/>
        </section>
        <expand macro="picklist_macro"/>
    </inputs>
    <outputs>
        <data name="prefetch_csv" format="csv" label="${tool.name} CSV on ${on_string}"/>
        <data name="matches_sig" format="sourmash.sig" label="${tool.name} on ${on_string}: Matches signatures">
            <filter>output_options['save_matches']</filter>
        </data>
        <data name="matching_hashes_sig" format="sourmash.sig" label="${tool.name} on ${on_string}: Matching hashes signatures">
            <filter>output_options['save_matching_hashes']</filter>
        </data>
        <data name="unmatched_hashes_sig" format="sourmash.sig" label="${tool.name} on ${on_string}: Unmatched hashes signature">
            <filter>output_options['save_unmatched_hashes']</filter>
        </data>
    </outputs>
    <tests>
        <!-- 1) against database-->
        <test expect_num_outputs="1">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="databases" value="indexed.sbt.zip"/>
            <output name="prefetch_csv" ftype="csv">
                <assert_contents>
                    <has_text text="0a8632c6"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Ktotal of 1 matching signatures."/>
            </assert_stderr>
        </test>
        <!-- 2) against signatures-->
        <test expect_num_outputs="1">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="databases" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <output name="prefetch_csv" ftype="csv">
                <assert_contents>
                    <has_text text="0a8632c6"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="[Kloaded 3 total signatures from 3 locations."/>
                <has_text text="Ktotal of 1 matching signatures."/>
            </assert_stderr>
        </test>
        <!-- 3) test multiple outputs-->
        <test expect_num_outputs="4">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="databases" value="indexed.sbt.zip"/>
            <section name="output_options">
                <param name="save_matches" value="true"/>
                <param name="save_matching_hashes" value="true"/>
                <param name="save_unmatched_hashes" value="true"/>
            </section>
            <output name="prefetch_csv" ftype="csv">
                <assert_contents>
                    <has_text text="0a8632c6"/>
                </assert_contents>
            </output>
            <output name="matches_sig" ftype="sourmash.sig">
                <assert_contents>
                    <has_text text="1652243004613"/>
                </assert_contents>
            </output>
            <output name="matches_sig" ftype="sourmash.sig">
                <assert_contents>
                    <has_text text="1652243004613"/>
                </assert_contents>
            </output>
            <output name="unmatched_hashes_sig" ftype="sourmash.sig">
                <assert_contents>
                    <has_text text="c16a5320fa475530d9583c34fd356ef5"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Ktotal of 1 matching signatures."/>
            </assert_stderr>
        </test>
        <!-- 4) common params -->
        <test expect_num_outputs="1">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="databases" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <section name="sig_select">
                <param name="mol_type" value="--dna"/>
                <param name="ksize" value="31"/>
                <param name="scaled" value="1000"/>
            </section>
            <output name="prefetch_csv" ftype="csv">
                <assert_contents>
                    <has_text text="0a8632c6"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="[Kloaded 3 total signatures from 3 locations."/>
                <has_text text="Ktotal of 1 matching signatures."/>
            </assert_stderr>
        </test>
        <!-- 5) Picklist-->
        <test expect_num_outputs="1">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="databases" value="indexed.sbt.zip"/>
            <section name="picklist">
                <param name="picklist_file" value="labels.csv"/>
                <param name="pickstyle" value="include"/>
            </section>
            <output name="prefetch_csv" ftype="csv">
                <assert_contents>
                    <has_n_lines n="0"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="[Ktotal of 0 matching signatures."/>
            </assert_stderr>
        </test>
        <!-- 6) Min overlap-->
        <test expect_num_outputs="1">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="databases" value="indexed.sbt.zip"/>
            <param name="threshold_bp" value="10"/>
            <output name="prefetch_csv" ftype="csv">
                <assert_contents>
                    <has_n_lines n="4"/>
                    <has_text text="GCF_000017325.1_ASM1732v1_genomic.fna.gz"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="[Ktotal of 3 matching signatures."/>
            </assert_stderr>
        </test>
    </tests>
    <help><![CDATA[
    **What the too does?**

    ``sourmash prefetch`` performs a **containment search** to quickly identify all database signatures contained within a query signature above a specified basepair threshold.

    Unlike ``sourmash gather``, which iteratively finds the minimum cover of a query, ``prefetch`` does a **single pass** through the database and reports **all matches** above the threshold without post-processing. This makes it much faster for initial database subsetting.

    **Key Use Cases**
        - Reduce massive databases to manageable subsets before running `gather`
        - Experiment with different threshold parameters efficiently
        - Find all genomes contained within a metagenome sample

    **Inputs**
        - **Query signature**: Typically a metagenome, genome, or composite signature to search against
        - **Database(s)**: One or more databases or signature collections

    **Outputs**
        - **CSV file**: Match table with `name`, `md5`, `intersect_bp`, `f_orig_query`, `f_match` columns

    Optional outputs (when enabled):
        - **Matching signatures**: All DB signatures that matched above threshold
        - **Matching hashes**: Query hashes that matched any DB signature
        - **Unmatched hashes**: Query hashes with no matches above threshold
    ]]></help>
    <expand macro="citations"/>
</tool>
