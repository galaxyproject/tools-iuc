<tool id="sourmash_compare" name="sourmash compare" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>compares one or more signature files</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        @Picklist_copy_file@ 
        
        sourmash compare
            @Picklist_commandline@
        #for $i in $inputs:
            ${i}
        #end for
        $matrix_type

        #for $i in $output_options:
            ${i}
        #end for

        @common_params_commandline@

        -o cmp.dist
        ]]></command>
    <inputs>
        <param name="inputs" type="data" format="sourmash.sig" multiple="true" label="Input files" help="Input signatures files generated with sourmash sketch"/>
        <param name="matrix_type" type="select" label="Matrix type" help="How to Calculate the outputted matrix">
            <option value="" selected="true">Jaccard or Angular Similarity</option>
            <option value="--ignore-abundance">Force Jaccard Similarity</option>
            <option value="--containment">Containment</option>
            <option value="--max-containment">Max Containment</option>
            <option value="--avg-containment">Average Containment</option>
            <option value="--ani">Average Nucleotide Identity (ANI)</option>
            <option value="--ani --containment">ANI (with Containment)</option>
        </param>
        <param name="output_options" type="select" optional="true" multiple="true" label="Output Options" help="">
            <option value="--distance-matrix">Distnace instead of Similarity</option>
            <option value="--labels-to labels.csv">Output labels.csv</option>
            <option value="--csv cmp.csv">Output matrix in csv format</option>
        </param>
        <expand macro="common_params"/>
        <expand macro="picklist_macro"/>
    </inputs>
    <!-- Outputs -->
    <outputs>
        <data name="matrix" format="binary" from_work_dir="cmp.dist" label='${tool.name} on ${on_string}: matrix'/>
        <data name="labels_txt" format="txt" from_work_dir="cmp.dist.labels.txt" label='${tool.name} on ${on_string}: labels text'/>
        <data name="labels_csv" format="csv" from_work_dir="labels.csv" label='${tool.name} on ${on_string}: labels csv'>
            <filter>output_options and '--labels-to labels.csv' in output_options</filter>
        </data>
        <data name="matrix_csv" format="csv" from_work_dir="cmp.csv" label='${tool.name} on ${on_string}: matrix csv'>
            <filter>output_options and '--csv cmp.csv' in output_options</filter>
        </data>
    </outputs>
    <tests>
        <!-- 1) default -->
        <test expect_num_outputs="2">
            <param name="inputs" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <output name="matrix" ftype="binary">
                <assert_contents>
                    <has_size size="200" delta="10"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <has_text text="min similarity in matrix: 0.0"/>
            </assert_stdout>
        </test>
        <!-- 2) containment -->
        <test expect_num_outputs="2">
            <param name="inputs" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="matrix_type" value="--containment"/>
            <output name="matrix" ftype="binary">
                <assert_contents>
                    <has_size size="200" delta="10"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <has_text text="min similarity in matrix: 0.0"/>
            </assert_stdout>
        </test>
        <!-- 3) ani -->
        <test expect_num_outputs="2">
            <param name="inputs" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="matrix_type" value="--ani"/>
            <output name="matrix" ftype="binary">
                <assert_contents>
                    <has_size size="200" delta="10"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <has_text text="min similarity in matrix: 0.760"/>
            </assert_stdout>
        </test>
        <!-- 4) ani with containment-->
        <test expect_num_outputs="2">
            <param name="inputs" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="matrix_type" value="--ani --containment"/>
            <output name="matrix" ftype="binary">
                <assert_contents>
                    <has_size size="200" delta="10"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <has_text text="min similarity in matrix: 0.759"/>
            </assert_stdout>
        </test>
        <!-- 5) Output options -->
        <test expect_num_outputs="4">
            <param name="inputs" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="output_options" value="--distance-matrix,--labels-to labels.csv,--csv cmp.csv"/>
            <output name="matrix" ftype="binary">
                <assert_contents>
                    <has_size size="200" delta="10"/>
                </assert_contents>
            </output>
            <output name="labels_csv" ftype="csv">
                <assert_contents>
                    <has_n_lines n="4"/>
                </assert_contents>
            </output>
            <output name="matrix_csv" ftype="csv">
                <assert_contents>
                    <has_n_lines n="4"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <has_text text="max distance in matrix: 1.0"/>
            </assert_stdout>
        </test>
        <!-- 6) ksize param -->
        <test expect_num_outputs="2">
            <param name="inputs" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <section name="sig_select">
                <param name="ksize" value="31"/>
                <param name="mol_type" value="--dna"/>
            </section>
            <output name="matrix" ftype="binary">
                <assert_contents>
                    <has_size size="200" delta="10"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <has_text text="min similarity in matrix: 0.0"/>
            </assert_stdout>
        </test>
        <!-- 7) test picklist -->
        <test expect_num_outputs="2">
            <param name="inputs" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <conditional name="picklist_cond">
                <param name="picklist_param" value="true"/>
                <param name="picklist_file" value="labels.csv"/>
                <param name="pickstyle" value="include"/>
            </conditional>
            <output name="matrix" ftype="binary">
                <assert_contents>
                    <has_size size="160" delta="10"/>
                </assert_contents>
            </output>
            <assert_stdout>
                <has_text text="min similarity in matrix: 0.321"/>
                <not_has_text text="GCF_000005845.2"/>
            </assert_stdout>
        </test>
    </tests>
    <help><![CDATA[
        **What the tool does?**

        Sourmash Compare compares one or more signatures (generated with sourmash sketch)

        **How does it work?**

        The input signatures are compared using the use-defined mode. Jaccard is most appropriate for genome comparisons, while angular similarity has been used for comparing metagenomes. 

        **Tool Modes**
            - Jaccard similarity (default): Fraction of shared k-mers. Symmetric matrix; good for clustering.
	        - Angular similarity (with abundance): Used for metagenome comparisons.
            - Force Jaccard: Force Jaccard even for abundance signatures.
            - Containment (--containment): Computes how much of sketch B is contained in sketch A: C(A, B) = B.contained_by(A) Matrix becomes asymmetric.
	        - ANI (with Jaccard): Converts Jaccard values into an ANI estimate.
            - ANI (with containment): output is also asymmetric.

        **Tool Outputs**
            - Distance matrix: distance matrix instead of similarity = 1 − similarity. 
            - CSV (--csv) — can be passed in to sourmash plot with --labels-from in order to customize the labels.
            - Label file (--labels-to) — for custom labeling in plots.
        
        @Picklist_help@
    ]]></help>
    <expand macro="citations"/>
</tool>
