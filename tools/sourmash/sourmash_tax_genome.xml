<tool id="sourmash_tax_genome" name="sourmash tax genome" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>taxonomic classification for gather results</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        sourmash tax genome
        @tax_inputs_command@
    ]]></command>
    <inputs>
        <expand macro="tax_inputs"/>
        <param name="output_format" argument="-F" type="select" multiple="true" optional="false" label="Outputs" help="Choose output format(s)">
            <option value="human">human</option>
            <option value="csv_summary" selected="true">csv_summary</option>
            <option value="krona">krona</option>
            <option value="lineage_csv">lineage_csv</option>
        </param>
        <expand macro="rank"/>
    </inputs>
    <outputs>
        <data name="csv_summary_genome" from_work_dir="output.classifications.csv" format="csv" label="${tool.name} on ${on_string}: Classifications CSV">
            <filter>'csv_summary' in output_format</filter>
        </data>
        <data name="human" from_work_dir="output.human.txt" format="txt" label="${tool.name} on ${on_string}: human">
            <filter>'human' in output_format</filter>
        </data>
        <data name="krona" from_work_dir="output.krona.tsv" format="tsv" label="${tool.name} on ${on_string}: krona">
            <filter>'krona' in output_format</filter>
        </data>
        <data name="lineage_csv" from_work_dir="output.lineage.csv" format="csv" label="${tool.name} on ${on_string}: lineage CSV">
            <filter>'lineage_csv' in output_format</filter>
        </data>
    </outputs>
    <tests>
        <!-- 1) tax genome test output formats: csv_summary,human,krona, lineage_summary -->
        <test expect_num_outputs="4">
            <param name="gather_csv" value="test1.gather.csv"/>
            <param name="taxonomy_csv" value="test.taxonomy.csv"/>
            <param name="output_format" value="csv_summary,human,krona,lineage_csv"/>
            <output name="human" ftype="txt">
                <assert_contents>
                    <has_text text="below_threshold"/>
                </assert_contents>
            </output>
            <output name="csv_summary_genome" ftype="csv">
                <assert_contents>
                    <has_n_lines n="2"/>
                </assert_contents>
            </output>
            <output name="krona" ftype="tsv">
                <assert_contents>
                    <has_text text="g__Prevotella"/>
                </assert_contents>
            </output>
            <output name="lineage_csv" ftype="csv">
                <assert_contents>
                    <has_n_lines n="2"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kloaded results for 1 queries from 1 gather CSVs"/>
                <has_text text="Ksaving 'human' output to"/>
                <has_text text="Ksaving 'krona' output to"/>
                <has_text text="Ksaving 'lineage_csv' output to"/>
                <has_text text="Ksaving 'classification' output to"/>
            </assert_stderr>
        </test>
    </tests>
    <help><![CDATA[
        **Sourmash Taxonomy**

        The sourmash tax subcommands support taxonomic analysis of genomes and taxonomic profiling of metagenomes.

        **genome**
        
        Classifies single-genome `gather` results to the most likely lineage, using coverage thresholds or rank-specific summarization.        

        @taxa_file_help@
    ]]></help>
    <expand macro="citations"/>
</tool>
