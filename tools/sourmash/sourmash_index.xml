<!-- Tool is not ready for review-->
<tool id="sourmash_index" name="sourmash index" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[        
        sourmash index

        #if $index_type == "rocksdb":
            indexed.rocksdb
        #else
            indexed
        #end if

        #for $i in $input_sigs:
            ${i}
        #end for

        ### Basic Parametrs
        --index-type $index_type

        #if $mol_type_cond.mol_type_param == "protein":
            --protein
            #if $mol_type_cond.protein_encoding == "dayhoff":
                --dayhoff
            #elif $mol_type_cond.protein_encoding == "hp":
                --hp
            #elif $mol_type_cond.protein_encoding == "skipm1n3":
                --skipm1n3
            #elif $mol_type_cond.protein_encoding == "skipm2n3":
                --skipm2n3
            #end if
        #elif $mol_type_cond.mol_type_param == "dna":
            --dna
        #end if

        #if $ksize:
            --ksize $ksize
        #end if
        #if $scaled:
            --scaled $scaled
        #end if

        ## Optional parameters
        #if $optional_params.n_children:
            --n_children $optional_params.n_children
        #end if
        
        #if $optional_params.bf_size:
            --bf-size $optional_params.bf_size
        #end if
        
        #if $optional_params.sparseness:
            --sparseness $optional_params.sparseness
        #end if
        
        #if $optional_params.force:
            --force
        #end if
        
        #if $optional_params.append:
            --append
        #end if

        #if $index_type == "rocksdb":
            && zip -qr indexed.rocksdb.zip indexed.rocksdb
        #end if
        ]]></command>
    <inputs>
        <param name="input_sigs" type="data" format="json" multiple="true" label="Database" help="The database is the signature files to look against."/>
        
        <!-- CORE PARAMETERS SECTION -->
        <param name="index_type" argument="-F" type="select" label="Index Type" help="choose the database index type">
            <option value="SBT" selected="true">SBT - Sequence Bloom Trees</option>
            <option value="rocksdb" >RocksDB</option>
        </param>
        <conditional name="mol_type_cond">
            <param name="mol_type_param" type="select" label="Molecule type" help="Choose between nucleotide (DNA/RNA) or protein signatures">
                <option value="dna" selected="true">DNA/RNA (Nucleotide)</option>
                <option value="protein">Protein</option>
            </param>
            <when value="dna"/>
            <when value="protein">
                <param name="protein_encoding" type="select" label="Protein encoding" help="Choose amino acid encoding scheme for protein signatures">
                    <option value="standard" selected="true">Standard amino acids</option>
                    <option value="dayhoff">Dayhoff-encoded</option>
                    <option value="hp">Hydrophobic-Polar (HP)</option>
                    <option value="skipm1n3">Skipmer (m1n3)</option>
                    <option value="skipm2n3">Skipmer (m2n3)</option>
                </param>
            </when>
        </conditional>
        <param argument="--ksize" type="integer" optional="true" min="1" max="64" label="K-mer size" help="K-mer size to select. Must match the k-mer size of input signatures. Common values: 21, 31, 51"/>
        <param argument="--scaled" type="integer" optional="true" min="100" max="1000000" label="Scaled parameter" help="Downsample to this scaled value. Smaller values = more precision but larger databases. Range: 100-1000000"/>

        <!-- Advanced options-->
        <section name="optional_params" title="Advanced Options" expanded="false">
            <param argument="--n_children" type="integer" optional="true" min="1" label="Number of children for internal nodes" help="Number of children per internal SBT node. Default: 2. Higher values = flatter tree structure"/>
            <param argument="--bf-size" type="integer" optional="true" min="1" label="Bloom filter size" help="Bloom filter size for internal SBT nodes. Larger values reduce false positives but increase memory usage"/>
            <param argument="--sparseness" type="float" optional="true" min="0.0" max="1.0" label="Sparseness of internal nodes" help="Percentage of internal nodes to skip saving (0.0 = save all, 1.0 = save none). Reduces database size at cost of query speed"/>
            <param argument="--force" type="boolean" truevalue="--force" falsevalue="" label="Force load of all files" help="Try loading ALL files in provided subdirectories, not just .sig files. Use with caution"/>
            <param argument="--append" type="boolean" truevalue="--append" falsevalue="" label="Append to existing index" help="Add signatures to an existing SBT instead of creating new index"/>
        </section>
    </inputs>
    <!-- Outputs -->
    <outputs>
        <data name="indexed_db" format="zip" from_work_dir="indexed*.zip" label="${tool.name} on ${on_string}"/>
    </outputs>
    <tests>
        <!-- 1) testing SBT -->
        <test>
            <param name="input_sigs" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <output name="indexed_db" ftype="zip">
                <assert_contents>
                    <has_size size="175K" delta="10K"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kloading 3 files into SBT index"/>
            </assert_stderr>
        </test>
        <!-- 2) testing rocksdb -->
        <test>
            <param name="input_sigs" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="index_type" value="rocksdb"/>
            <output name="indexed_db" ftype="zip">
                <assert_contents>
                    <has_size size="295.9K" delta="1K"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kloading 3 files into rocksdb index"/>
            </assert_stderr>
        </test>
    </tests>
    <help><![CDATA[
        **What the tool does?**

        The sourmash index command creates indexed databases from a collection of signatures. This can be used to create databases from private collections of genomes or metagenomes, and can also be used to create databases for e.g. subsets of GenBank.

        All signatures in an index must be of compatible types (i.e. the same k-mer size, scaled, and molecule type). You can specify the usual command line selectors (-k, --scaled, --dna/--protein/--hp/--dayhoff/--skipm1n3/--skipm2n3, etc.) to pick out the types of signatures to include when running index.

        Create an on-disk database of signatures that can be searched quickly
        & in low memory. All signatures must be scaled, and must be the same
        k-mer size and molecule type; the standard signature selectors
        (-k/--ksize, --scaled, --dna/--protein) choose which signatures to be
        added.
        
        **Database Types**
            - SBT:
            - rocksdb:
            - zip:

        **Tool Outputs**
            - Distance matrix: distance matrix instead of similarity = 1 − similarity. 
            - CSV (--csv) — can be passed in to sourmash plot with --labels-from in order to customize the labels.
            - Label file (--labels-to) — for custom labeling in plots.

            **What the tool does?**
    
    Sourmash index creates an on-disk database of signatures that can be searched quickly and in low memory. 
    This is essential for building searchable signature databases that can be queried with ``sourmash search``.
    
    All input signatures must have:
    - The same k-mer size (specified with ``--ksize``)
    - The same molecule type (DNA/RNA or protein)
    - Be scaled signatures (used for containment and similarity searches)
    
    **Input files**
    
    - **Signature files (.sig)**: MinHash signatures generated by ``sourmash sketch`` or similar tools
    - **Signature list file (optional)**: Text file with one signature path per line
    
    **Output**
    
    An indexed database that can be quickly searched. The format depends on the index type chosen:
    - **RocksDB** (recommended): High-performance key-value store, smallest footprint
    - **SBT** (Sequence Bloom Tree): Original sourmash index format, good for phylogenetic relationships
    - **ZIP**: Archived format for portable databases
    
    **Key Parameters**
    
    - **K-mer size**: Must match input signatures. Common values are 21, 31 (nucleotide) or 10, 15 (protein)
    - **Scaled**: Controls database precision/size tradeoff. Smaller = more precise but larger
    - **Index type**: RocksDB recommended for new databases (becoming default in v5)
    
    **Protein Encoding Options**
    
    When working with protein signatures, you can select different amino acid encodings:
    - **Standard**: Full 20 amino acids
    - **Dayhoff**: 6-letter Dayhoff encoding (chemical similarity groups)
    - **HP**: 2-letter hydrophobic-polar encoding (physical properties)
    - **Skipmer**: Skip-mer encodings for reduced alphabet
    
    **Advanced Options**
    
    - **n_children**: Tree branching factor. Higher values create flatter, shallower trees
    - **Bloom filter size**: Trade-off between false positives and memory usage
    - **Sparseness**: Skip saving some internal nodes to reduce database size (SBT only)
    - **Picklist**: Filter which signatures to include based on a CSV file
    
    For more information, see the `sourmash documentation <https://sourmash.readthedocs.io/en/latest/command-line.html#sourmash-index-build-an-index-of-signatures>`_.
    ]]></help>
    <expand macro="citations"/>
</tool>
