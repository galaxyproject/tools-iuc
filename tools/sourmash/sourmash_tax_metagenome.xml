<tool id="sourmash_tax_metagenome" name="sourmash tax metagenome" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>summarizes gather results for metagenomes by taxonomic lineage</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        sourmash tax metagenome
        @tax_inputs_command@
        $abund
    ]]></command>
    <inputs>
        <expand macro="tax_inputs"/>
        <param name="output_format" argument="-F" type="select" multiple="true" optional="false" label="Outputs" help="Choose output format(s)">
            <option value="human">human</option>
            <option value="csv_summary" selected="true">csv_summary</option>
            <option value="krona">krona</option>
            <option value="lineage_summary">lineage_summary</option>
            <option value="kreport">kreport</option>
            <option value="lingroup">lingroup</option>
            <option value="bioboxes">bioboxes</option>
        </param>
        <param name="abund" type="boolean" value="false" falsevalue="--no-abundances" truevalue="--use-abundances" label="Create abundance-weighted taxonomy" help="by default, sourmash tracks k-mer presence, not their abundance. However, it is possible to take into account abundance information by selecting this option."/>
        <expand macro="rank"/>
        <param name="threshhold" argument="--containment-threshold" type="float" value="0.1" min="0.0" max="1" label="Minimum containment threshold" help="Minimum containment threshold for classification"/>
        <param name="ani_threshhold" argument="--ani-threshold" type="float" optional="true" value="" min="0.0" max="1" label="Minimum ANI threshold" help="Minimum ANI threshold (nucleotide gather) or AAI threshold (protein gather) for classification"/>
    </inputs>
    <outputs>
        <data name="csv_summary" from_work_dir="output.summarized.csv" format="csv" label="${tool.name} n ${on_string}: Summary CSV">
            <filter>'csv_summary' in output_format</filter>
        </data>
        <data name="human" from_work_dir="output.human.txt" format="txt" label="${tool.name} on ${on_string}: human">
            <filter>'human' in output_format</filter>
        </data>
        <data name="krona" from_work_dir="output.krona.tsv" format="tsv" label="${tool.name} on ${on_string}: krona">
            <filter>'krona' in output_format</filter>
        </data>
        <data name="lineage_summary" from_work_dir="output.lineage_summary.tsv" format="tsv" label="${tool.name} on ${on_string}: lineage_summary">
            <filter>'lineage_summary' in output_format</filter>
        </data>
        <data name="lineage_csv" from_work_dir="output.lineage.csv" format="csv" label="${tool.name} on ${on_string}: lineage CSV">
            <filter>'lineage_csv' in output_format</filter>
        </data>
        <data name="kreport" from_work_dir="output.kreport.txt" format="txt" label="${tool.name} on ${on_string}: kreport">
            <filter>'kreport' in output_format</filter>
        </data>
        <data name="bioboxes" from_work_dir="output.bioboxes.profile" format="txt" label="${tool.name} on ${on_string}: bioboxes">
            <filter>'bioboxes' in output_format</filter>
        </data>
    </outputs>
    <tests>
        <!-- 1) metagenome test output formats: csv_summary,human,krona -->
        <test expect_num_outputs="4">
            <param name="gather_csv" value="test1.gather.csv"/>
            <param name="taxonomy_csv" value="test.taxonomy.csv"/>
            <param name="output_format" value="csv_summary,human,krona,lineage_summary"/>
            <output name="human" ftype="txt">
                <assert_contents>
                    <has_text text="unclassified"/>
                </assert_contents>
            </output>
            <output name="csv_summary" ftype="csv">
                <assert_contents>
                    <has_n_lines n="23"/>
                </assert_contents>
            </output>
            <output name="krona" ftype="tsv">
                <assert_contents>
                    <has_text text="g__Prevotella"/>
                </assert_contents>
            </output>
            <output name="lineage_summary" ftype="tsv">
                <assert_contents>
                    <has_text text="027522935779816515"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kloaded results for 1 queries from 1 gather CSVs"/>
            </assert_stderr>
        </test>
        <!-- 2) metagenome test output formats: kreport -->
        <test expect_num_outputs="1">
            <param name="gather_csv" value="lemonade-MAG3.x.gtdb.csv"/>
            <param name="taxonomy_csv" value="lemonade-MAG3.x.gtdb.matches.tax.csv"/>
            <param name="output_format" value="kreport"/>
            <output name="kreport" ftype="txt">
                <assert_contents>
                    <has_text text="116000"/>
                </assert_contents>
            </output>
        </test>
        <!-- 3) metagenome test output formats: bioboxes -->
        <test expect_num_outputs="1">
            <param name="gather_csv" value="test1.gather.v450.csv"/>
            <param name="taxonomy_csv" value="test.ncbi-taxonomy.csv"/>
            <param name="output_format" value="bioboxes"/>
            <output name="bioboxes" ftype="txt">
                <assert_contents>
                    <has_text text="# Taxonomic Profiling Output"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
        **Sourmash Taxonomy**

        The sourmash tax subcommands support taxonomic analysis of genomes and taxonomic profiling of metagenomes.

        **metagenome**: 
        Summarizes `gather` (or `multigather`) results for metagenomes by taxonomic lineage at each rank (e.g., phylum, species), producing formats like CSV, Krona, or Kraken-style reports.

        !please note that metagenome subcommand cannot produce `kreport` from gather results before sourmash v4.5.0.!

        @taxa_file_help@
    ]]></help>
    <expand macro="citations"/>
</tool>
