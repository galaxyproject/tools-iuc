<!-- Not Ready for Review Yet -->
<tool id="sourmash_tax" name="sourmash tax" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        sourmash tax

        #if $tax.subcommand == "metagenome":
            $tax.subcommand
            -g $tax.gather_csv
            -t $tax.taxonomy_csv
            -F
            #for $fmt in $tax.output_format:
                $fmt
            #end for
            --rank species
            $tax.abund
            -o output
        #end if
    ]]></command>
    <inputs>
        <conditional name="tax" label="Sourmash Tax Subcommand">
            <param name="subcommand" type="select" label="Subcommand" help="Choose the sourmash tax subcommand tool. Read Help section ...">
                <option value="metagenome" selected="true">Metagenome</option>
                <option value="genome">Genome</option>
                <option value="annotate">Annotate</option>
                <option value="prepare">Prepare</option>
                <option value="grep">grep</option>
                <option value="summarize">Summarize</option>
            </param>
            <when value="metagenome">
                <param name="gather_csv" argument="-g" type="data" format="csv" multiple="true" label="gather CSV" help="One or more  CSVs from sourmash gathe"/>
                <param name="taxonomy_csv" argument="-t" type="data" format="csv" label="taxonomy CSV" help="Taxonomy File. Database lineages CSV"/>
                <param name="output_format" argument="-F" type="select" multiple="true" label="taxonomy CSV" help="Choose output format(s)">
                    <option value="human">human</option>
                    <option value="csv_summary" selected="true">csv_summary</option>
                    <option value="krona">krona</option>
                    <option value="lineage_summary">lineage_summary</option>
                    <option value="kreport">kreport</option>
                    <option value="lingroup">lingroup</option>
                    <option value="bioboxes">bioboxes</option>
                </param>
                <param name="abund" type="boolean" value="false" falsevalue="--no-abundances" truevalue="--use-abundances" label="Create abundance-weighted taxonomy" help="by default, sourmash tracks k-mer presence, not their abundance. However, it is possible to take into account abundance information by selecting this option."/>
            </when>
            <when value="genome">
            </when>
            <when value="annotate">
            </when>
            <when value="prepare">
            </when>
            <when value="grep">
            </when>
            <when value="summarize">
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="csv_summary" from_work_dir="output.summarized.csv" format="csv" label="${tool.name} ${tax.subcommand} on ${on_string}: Summary CSV">
            <filter>'csv_summary' in tax['output_format'] and tax['subcommand'] == 'metagenome'</filter>
        </data>
        <data name="human" from_work_dir="output.human.txt" format="txt" label="${tool.name} ${tax.subcommand} on ${on_string}: human">
            <filter>'human' in tax['output_format'] and tax['subcommand'] == 'metagenome'</filter>
        </data>
        <data name="krona" from_work_dir="output.krona.tsv" format="tsv" label="${tool.name} ${tax.subcommand} on ${on_string}: krona">
            <filter>'krona' in tax['output_format'] and tax['subcommand'] == 'metagenome'</filter>
        </data>
        <data name="lineage_summary" from_work_dir="output.lineage_summary.tsv" format="tsv" label="${tool.name} ${tax.subcommand} on ${on_string}: lineage_summary">
            <filter>'lineage_summary' in tax['output_format'] and tax['subcommand'] == 'metagenome'</filter>
        </data>
        <data name="kreport" from_work_dir="output.kreport.txt" format="txt" label="${tool.name} ${tax.subcommand} on ${on_string}: kreport">
            <filter>'kreport' in tax['output_format'] and tax['subcommand'] == 'metagenome'</filter>
        </data>
        <data name="bioboxes" from_work_dir="output.bioboxes.profile" format="txt" label="${tool.name} ${tax.subcommand} on ${on_string}: bioboxes">
            <filter>'bioboxes' in tax['output_format'] and tax['subcommand'] == 'metagenome'</filter>
        </data>
    </outputs>
    <tests>
        <!-- 1) metagenome test output formats: csv_summary,human,krona -->
        <test expect_num_outputs="4">
            <conditional name="tax">
                <param name="subcommand" value="metagenome"/> 
                <param name="gather_csv" value="test1.gather.csv"/>
                <param name="taxonomy_csv" value="test.taxonomy.csv"/>
                <param name="output_format" value="csv_summary,human,krona,lineage_summary"/>
            </conditional>
            <output name="human" ftype="txt">
                <assert_contents>
                    <has_text text="unclassified"/>
                </assert_contents>
            </output>
            <output name="csv_summary" ftype="csv">
                <assert_contents>
                    <has_n_lines n="23"/>
                </assert_contents>
            </output>
            <output name="krona" ftype="tsv">
                <assert_contents>
                    <has_text text="g__Prevotella"/>
                </assert_contents>
            </output>
            <output name="lineage_summary" ftype="tsv">
                <assert_contents>
                    <has_text text="027522935779816515"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kloaded results for 1 queries from 1 gather CSVs"/>
            </assert_stderr>
        </test>
        <!-- 2) metagenome test output formats: kreport -->
        <test expect_num_outputs="1">
            <conditional name="tax">
                <param name="subcommand" value="metagenome"/> 
                <param name="gather_csv" value="lemonade-MAG3.x.gtdb.csv"/>
                <param name="taxonomy_csv" value="lemonade-MAG3.x.gtdb.matches.tax.csv"/>
                <param name="output_format" value="kreport"/>
            </conditional>
            <output name="kreport" ftype="txt">
                <assert_contents>
                    <has_text text="116000"/>
                </assert_contents>
            </output>
        </test>
        <!-- 3) metagenome test output formats: bioboxes -->
        <test expect_num_outputs="1">
            <conditional name="tax">
                <param name="subcommand" value="metagenome"/> 
                <param name="gather_csv" value="test1.gather.v450.csv"/>
                <param name="taxonomy_csv" value="test.ncbi-taxonomy.csv"/>
                <param name="output_format" value="bioboxes"/>
            </conditional>
            <output name="bioboxes" ftype="txt">
                <assert_contents>
                    <has_text text="# Taxonomic Profiling Output"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
        **Sourmash Taxonomy**

        The sourmash tax subcommands support taxonomic analysis of genomes and taxonomic profiling of metagenomes.

        List of Subcomand to choose from:
            - metagenome:
            - genome:
            - annotate:
            - prepare:
            - grep:
            - summarize:
    ]]></help>
    <expand macro="citations"/>
</tool>
