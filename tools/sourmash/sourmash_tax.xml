<tool id="sourmash_tax" name="sourmash tax" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        sourmash tax

        #if $tax.subcommand == "metagenome":
            @tax_inputs_command@
            $tax.abund
        #else if $tax.subcommand == "genome":
            @tax_inputs_command@
        #else if $tax.subcommand == "annotate":
            $tax.subcommand
            -g
            #for $g in $tax.gather_csv:
                $g
            #end for
            -t $tax.taxonomy_csv
        
        #else if $tax.subcommand == "prepare":
            $tax.subcommand
            --taxonomy
            #for $t in $tax.taxonomy_files:
                $t
            #end for
            #if $tax.database_type == "csv": 
                -o tax.csv
                -F csv
            #else:
                -o tax.db
                -F sql
            #end if
        
        #else if $tax.subcommand == "grep":
            $tax.subcommand
            $tax.pattern
            --taxonomy
            #for $t in $tax.taxonomy_files:
                $t
            #end for
            #if $tax.rank:
                -r $tax.rank
            #end if
            $tax.ignore_case
            $tax.output_non_match
            -o pattern.csv
        #else if $tax.subcommand == "summarize":
            $tax.subcommand
            #for $t in $tax.taxonomy_files:
                $t
            #end for
            -o ranks.csv
        #end if 
    ]]></command>
    <inputs>
        <conditional name="tax" label="Sourmash Tax Subcommand">
            <param name="subcommand" type="select" optional="false" label="Subcommand" help="Choose the sourmash tax subcommand tool. Read Help section for detailed information about each subcommand.">
                <option value="annotate">Annotate</option>
                <option value="prepare">Prepare</option>
                <option value="metagenome">Metagenome</option>
                <option value="genome">Genome</option>
                <option value="grep">grep</option>
                <option value="summarize">Summarize</option>
            </param>
            <!-- Tax Metagenome -->
            <when value="metagenome">
                <expand macro="tax_inputs"/>
                <param name="output_format" argument="-F" type="select" multiple="true" optional="false" label="Outputs" help="Choose output format(s)">
                    <option value="human">human</option>
                    <option value="csv_summary" selected="true">csv_summary</option>
                    <option value="krona">krona</option>
                    <option value="lineage_summary">lineage_summary</option>
                    <option value="kreport">kreport</option>
                    <option value="lingroup">lingroup</option>
                    <option value="bioboxes">bioboxes</option>
                </param>
                <param name="abund" type="boolean" value="false" falsevalue="--no-abundances" truevalue="--use-abundances" label="Create abundance-weighted taxonomy" help="by default, sourmash tracks k-mer presence, not their abundance. However, it is possible to take into account abundance information by selecting this option."/>
                <expand macro="rank"/>
                <param name="threshhold" argument="--containment-threshold" type="float" value="0.1" min="0.0" max="1" label="Minimum containment threshold" help="Minimum containment threshold for classification"/>
                <param name="ani_threshhold" argument="--ani-threshold" type="float" optional="true" min="0.0" max="1" label="Minimum ANI threshold" help="Minimum ANI threshold (nucleotide gather) or AAI threshold (protein gather) for classification"/>
            </when>
            <!-- Tax Genome -->
            <when value="genome">
                <expand macro="tax_inputs"/>
                <param name="output_format" argument="-F" type="select" multiple="true" optional="false" label="Outputs" help="Choose output format(s)">
                    <option value="human">human</option>
                    <option value="csv_summary" selected="true">csv_summary</option>
                    <option value="krona">krona</option>
                    <option value="lineage_csv">lineage_csv</option>
                </param>
                <expand macro="rank"/>
            </when>
            <!-- Tax Annotate -->
            <when value="annotate">
                <expand macro="tax_inputs"/>
            </when>
            <!-- Tax Prepare -->
            <when value="prepare">
                <expand macro="tax_files" help="The 'tax prepare' command reads in one or more taxonomy databases and saves them into a new database either as CSV or a SQLite database."/>
                <param name="database_type" type="select" label="Database Type" help="Choose the type of the output database. SQLite databases are much faster for large taxonomies, while CSV files are easier to view and modify using spreadsheet software.">
                    <option value="csv">CSV</option>
                    <option value="sql" selected="true">SQLite database</option>
                </param>
            </when>
            <!-- Tax grep -->
            <when value="grep">
                <expand macro="tax_files" help="The 'tax grep' searches taxonomies for matching strings and saves them into a new database."/>
                <param name="pattern" label="Pattern" type="text" help="Pattern is a regular expression. Note: tax grep only searches taxonomic ranks, not identifier strings."/>
                <param name="rank" type="select" label="Rank" optional="true" help="Restrict query to this rank. Note that the taxonomy CSV must contain lineage information at this rank">
                    <option value="species">Species</option>
                    <option value="genus">Genus</option>
                    <option value="family">Family</option>
                    <option value="order">Order</option>
                    <option value="class">Class</option>
                    <option value="phylum">Phylum</option>
                    <option value="superkingdom">Superkingdom</option>
                </param>
                <param name="ignore_case" argument="-i" label="Ignore case" type="boolean" value="false" truevalue="-i" falsevalue="" help="Ignore the case of the regulare expression"/>
                <param name="output_non_match" argument="-v" label="Output not match" type="boolean" value="false" truevalue="-v" falsevalue="" help="output only taxonomic lineages that do not match the pattern"/>
            </when>
            <!-- Tax Summarize -->
            <when value="summarize">
                <expand macro="tax_files" help="sourmash tax summarize loads in one or more lineage spreadsheets, counts the distinct taxonomic lineages, and outputs a summary."/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="csv_summary" from_work_dir="output.summarized.csv" format="csv" label="${tool.name} ${tax.subcommand} on ${on_string}: Summary CSV">
            <filter>tax['subcommand'] == 'metagenome' and 'csv_summary' in tax['output_format']</filter>
        </data>
        <data name="csv_summary_genome" from_work_dir="output.classifications.csv" format="csv" label="${tool.name} ${tax.subcommand} on ${on_string}: Classifications CSV">
            <filter>tax['subcommand'] == 'genome' and 'csv_summary' in tax['output_format']</filter>
        </data>
        <data name="human" from_work_dir="output.human.txt" format="txt" label="${tool.name} ${tax.subcommand} on ${on_string}: human">
            <filter>tax['subcommand'] in ('metagenome', 'genome') and 'human' in tax['output_format']</filter>
        </data>
        <data name="krona" from_work_dir="output.krona.tsv" format="tsv" label="${tool.name} ${tax.subcommand} on ${on_string}: krona">
            <filter>tax['subcommand'] in ('metagenome', 'genome') and 'krona' in tax['output_format']</filter>
        </data>
        <data name="lineage_summary" from_work_dir="output.lineage_summary.tsv" format="tsv" label="${tool.name} ${tax.subcommand} on ${on_string}: lineage_summary">
            <filter>tax['subcommand'] == 'metagenome' and 'lineage_summary' in tax['output_format']</filter>
        </data>
        <data name="lineage_csv" from_work_dir="output.lineage.csv" format="csv" label="${tool.name} ${tax.subcommand} on ${on_string}: lineage CSV">
            <filter>tax['subcommand'] == 'genome' and 'lineage_csv' in tax['output_format']</filter>
        </data>
        <data name="kreport" from_work_dir="output.kreport.txt" format="txt" label="${tool.name} ${tax.subcommand} on ${on_string}: kreport">
            <filter>tax['subcommand'] == 'metagenome' and 'kreport' in tax['output_format']</filter>
        </data>
        <data name="bioboxes" from_work_dir="output.bioboxes.profile" format="txt" label="${tool.name} ${tax.subcommand} on ${on_string}: bioboxes">
            <filter>tax['subcommand'] == 'metagenome' and 'bioboxes' in tax['output_format']</filter>
        </data>
        <data name="with_lineage" from_work_dir="*with-lineage*" format="csv" label="${tool.name} ${tax.subcommand} on ${on_string}: CSV with Lineage">
            <filter>tax['subcommand'] == 'annotate'</filter>
        </data>
        <data name="prepare_csv" from_work_dir="tax.csv" format="csv" label="${tool.name} ${tax.subcommand} on ${on_string}: CSV Database">
            <filter>tax['subcommand'] == 'prepare' and tax['database_type'] == 'csv'</filter>
        </data>
        <data name="prepare_sql" from_work_dir="tax.db" format="binary" label="${tool.name} ${tax.subcommand} on ${on_string}: SQLite Database">
            <filter>tax['subcommand'] == 'prepare' and tax['database_type'] == 'sql'</filter>
        </data>
        <data name="grep" from_work_dir="pattern.csv" format="csv" label="${tool.name} ${tax.subcommand} on ${on_string}: grep matches">
            <filter>tax['subcommand'] == 'grep'</filter>
        </data>
        <data name="summarize" from_work_dir="ranks.csv" format="csv" label="${tool.name} ${tax.subcommand} on ${on_string}: Summarize CSV">
            <filter>tax['subcommand'] == 'summarize'</filter>
        </data>
    </outputs>
    <tests>
        <!-- 1) metagenome test output formats: csv_summary,human,krona -->
        <test expect_num_outputs="4">
            <conditional name="tax">
                <param name="subcommand" value="metagenome"/> 
                <param name="gather_csv" value="test1.gather.csv"/>
                <param name="taxonomy_csv" value="test.taxonomy.csv"/>
                <param name="output_format" value="csv_summary,human,krona,lineage_summary"/>
            </conditional>
            <output name="human" ftype="txt">
                <assert_contents>
                    <has_text text="unclassified"/>
                </assert_contents>
            </output>
            <output name="csv_summary" ftype="csv">
                <assert_contents>
                    <has_n_lines n="23"/>
                </assert_contents>
            </output>
            <output name="krona" ftype="tsv">
                <assert_contents>
                    <has_text text="g__Prevotella"/>
                </assert_contents>
            </output>
            <output name="lineage_summary" ftype="tsv">
                <assert_contents>
                    <has_text text="027522935779816515"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kloaded results for 1 queries from 1 gather CSVs"/>
            </assert_stderr>
        </test>
        <!-- 2) metagenome test output formats: kreport -->
        <test expect_num_outputs="1">
            <conditional name="tax">
                <param name="subcommand" value="metagenome"/> 
                <param name="gather_csv" value="lemonade-MAG3.x.gtdb.csv"/>
                <param name="taxonomy_csv" value="lemonade-MAG3.x.gtdb.matches.tax.csv"/>
                <param name="output_format" value="kreport"/>
            </conditional>
            <output name="kreport" ftype="txt">
                <assert_contents>
                    <has_text text="116000"/>
                </assert_contents>
            </output>
        </test>
        <!-- 3) metagenome test output formats: bioboxes -->
        <test expect_num_outputs="1">
            <conditional name="tax">
                <param name="subcommand" value="metagenome"/> 
                <param name="gather_csv" value="test1.gather.v450.csv"/>
                <param name="taxonomy_csv" value="test.ncbi-taxonomy.csv"/>
                <param name="output_format" value="bioboxes"/>
            </conditional>
            <output name="bioboxes" ftype="txt">
                <assert_contents>
                    <has_text text="# Taxonomic Profiling Output"/>
                </assert_contents>
            </output>
        </test>
        <!-- 4) tax genome test output formats: csv_summary,human,krona, lineage_summary -->
        <test expect_num_outputs="4">
            <conditional name="tax">
                <param name="subcommand" value="genome"/> 
                <param name="gather_csv" value="test1.gather.csv"/>
                <param name="taxonomy_csv" value="test.taxonomy.csv"/>
                <param name="output_format" value="csv_summary,human,krona,lineage_csv"/>
            </conditional>
            <output name="human" ftype="txt">
                <assert_contents>
                    <has_text text="below_threshold"/>
                </assert_contents>
            </output>
            <output name="csv_summary_genome" ftype="csv">
                <assert_contents>
                    <has_n_lines n="2"/>
                </assert_contents>
            </output>
            <output name="krona" ftype="tsv">
                <assert_contents>
                    <has_text text="g__Prevotella"/>
                </assert_contents>
            </output>
            <output name="lineage_csv" ftype="csv">
                <assert_contents>
                    <has_n_lines n="2"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kloaded results for 1 queries from 1 gather CSVs"/>
                <has_text text="Ksaving 'human' output to"/>
                <has_text text="Ksaving 'krona' output to"/>
                <has_text text="Ksaving 'lineage_csv' output to"/>
                <has_text text="Ksaving 'classification' output to"/>
            </assert_stderr>
        </test>
        <!-- 5) Annotate -->
        <test expect_num_outputs="1">
            <conditional name="tax">
                <param name="subcommand" value="annotate"/> 
                <param name="gather_csv" value="test1.gather.csv"/>
                <param name="taxonomy_csv" value="test.taxonomy.csv"/>
            </conditional>
            <output name="with_lineage" ftype="csv">
                <assert_contents>
                    <has_n_lines n="5"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="KAnnotated 4 of 4 total rows"/>
            </assert_stderr>
        </test>
        <!-- 6) prepare -->
        <test expect_num_outputs="1">
            <conditional name="tax">
                <param name="subcommand" value="prepare"/> 
                <param name="taxonomy_files" value="test.ncbi-taxonomy.csv,lemonade-MAG3.x.gtdb.matches.tax.csv"/>
                <param name="database_type" value="csv"/>
            </conditional>
            <output name="prepare_csv" ftype="csv">
                <assert_contents>
                    <has_n_lines n="10"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="K...loaded 9 entries."/>
            </assert_stderr>
        </test>
        <!-- 7) grep  -->
        <test expect_num_outputs="1">
            <conditional name="tax">
                <param name="subcommand" value="grep"/> 
                <param name="taxonomy_files" value="test.ncbi-taxonomy.csv"/>
                <param name="pattern" value="coli"/>
            </conditional>
            <output name="grep" ftype="csv">
                <assert_contents>
                    <has_n_lines n="2"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kfound 1 matches; saved identifiers to picklist file "/>
            </assert_stderr>
        </test>
        <!-- 8) grep + rank-->
        <test expect_num_outputs="1">
            <conditional name="tax">
                <param name="subcommand" value="grep"/> 
                <param name="taxonomy_files" value="test.ncbi-taxonomy.csv"/>
                <param name="pattern" value="coli"/>
                <param name="rank" value="class"/>
            </conditional>
            <output name="grep" ftype="csv">
                <assert_contents>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kfound 0 matches; saved identifiers to picklist file "/>
            </assert_stderr>
        </test>
        <!-- 9) grep + ignore case-->
        <test expect_num_outputs="1">
            <conditional name="tax">
                <param name="subcommand" value="grep"/> 
                <param name="taxonomy_files" value="test.ncbi-taxonomy.csv"/>
                <param name="pattern" value="COLI"/>
                <param name="ignore_case" value="true"/>
            </conditional>
            <output name="grep" ftype="csv">
                <assert_contents>
                    <has_n_lines n="2"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kfound 1 matches; saved identifiers to picklist file "/>
            </assert_stderr>
        </test>
        <!-- 10) grep + output non match-->
        <test expect_num_outputs="1">
            <conditional name="tax">
                <param name="subcommand" value="grep"/> 
                <param name="taxonomy_files" value="test.ncbi-taxonomy.csv"/>
                <param name="pattern" value="coli"/>
                <param name="output_non_match" value="true"/>
            </conditional>
            <output name="grep" ftype="csv">
                <assert_contents>
                    <has_n_lines n="6"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Kfound 5 matches; saved identifiers to picklist file "/>
            </assert_stderr>
        </test>
        <!-- 11) summarize -->
        <test expect_num_outputs="1">
            <conditional name="tax">
                <param name="subcommand" value="summarize"/> 
                <param name="taxonomy_files" value="test.ncbi-taxonomy.csv"/>
            </conditional>
            <output name="summarize" ftype="csv">
                <assert_contents>
                    <has_n_lines n="23"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text text="Ksaved 22 lineage counts to 'ranks.csv'"/>
            </assert_stderr>
        </test>
    </tests>
    <help><![CDATA[
        **Sourmash Taxonomy**

        The sourmash tax subcommands support taxonomic analysis of genomes and taxonomic profiling of metagenomes.

        List of Subcomand to choose from:
            - **annotate**: Adds genome-level lineage info to `gather` results without summarization or classification.
            - **prepare**: Converts CSV taxonomy files to SQLite databases or combines multiple files for faster `tax` operations.
            - **metagenome**: Summarizes `gather` (or `multigather`) results for metagenomes by taxonomic lineage at each rank (e.g., phylum, species), producing formats like CSV, Krona, or Kraken-style reports.
            - **genome**: Classifies single-genome `gather` results to the most likely lineage, using coverage thresholds or rank-specific summarization.        
            - **grep**: Subsets taxonomies and creates picklists based on string matches in lineage names.
            - **summarize**: Prints lineage counts and summary stats from taxonomy files or databases.

        !please note that metagenome subcommand cannot produce `kreport` from gather results before sourmash v4.5.0.!

    ]]></help>
    <expand macro="citations"/>
</tool>
