<tool id="sourmash_multigather" name="sourmash multigather" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        sourmash multigather
        --query
        #for $i in $queries:
            $i
        #end for
        --db
        #for $i in $databases:
            $i
        #end for

        @common_params_commandline@
        --threshold-bp $threshold_bp
    ]]></command>
    <inputs>
        <param name="queries" type="data" format="sourmash.sig" multiple="true" label="Query signatures" help="One or more query signature files to gather against databases"/>
        <param name="databases" type="data" format="zip,sourmash.sig" multiple="true" label="Database(s)" help="One or more signature collections / indexed databases to search"/>
        <param name="threshold_bp" type="integer" value="50000" label="Threshold (bp)" help="Minimum number of base pairs to report in a match. Default is 50,000 bp"/>
        <expand macro="common_params"/>
    </inputs>
    <outputs>
        <collection name="prefetch_csvs" type="list" label="${tool.name} CSVs">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.csv" format="csv"/>
        </collection>
        <collection name="matches_sigs" type="list" label="${tool.name} matching signatures">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.matches\.sig" format="sourmash.sig"/>
        </collection>
        <collection name="unassigned_sigs" type="list" label="${tool.name} unassigned signatures">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.unassigned\.sig" format="sourmash.sig"/>
        </collection>
    </outputs>
    <tests>
        <!-- 1) 1 query -->
        <test expect_num_outputs="3">
            <param name="queries" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="databases" value="indexed.sbt.zip"/>
            <assert_stderr>
                <has_text text="conducted gather searches on 1 signatures"/>
                <has_text text="Kloaded 3 total signatures from 1 locations."/>
            </assert_stderr>
        </test>
        <!-- 2) 3 queries -->
        <test expect_num_outputs="3">
            <param name="queries" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="databases" value="indexed.sbt.zip"/>
            <param name="threshold_bp" value="50000"/>
            <assert_stderr>
                <has_text text="conducted gather searches on 3 signatures"/>
                <has_text text="Kloaded 3 total signatures from 1 locations."/>
            </assert_stderr>
        </test>
    </tests>
    <help><![CDATA[
        **What it does**

        Sourmash multigather runs a multiple query signatures against one or more databases.
        
        It is a wrapper that runs sourmash gather on multiple query signatures against one or more databases, rather than running gather multiple times separately.

        **Outputs**

        Multigather produces 3 collections:
            - **CSVs** - Gather CSV output with matching results for each query
            - **matching signatures** - All matching signatures for each query
            - **unassigned signatures** - All remaining unassigned hashes for each query

        **References**
            - `sourmash multigather documentation <https://sourmash.readthedocs.io/en/latest/command-line.html#id15>`_
    ]]></help>
    <expand macro="citations"/>
</tool>
