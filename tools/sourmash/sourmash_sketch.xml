<tool id="sourmash_sketch" name="sourmash sketch" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>create sourmash signature</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        sourmash sketch $input_type_cond.input_type_param 
        
        ## build settings string

        #if $advanced_settings.abund:
            #set settings = "abund"
        #else 
            #set settings = "noabund"
        #end if
        
        #for $i, $x in enumerate($advanced_settings.k_size_repeat):
            #set settings += ',k=%s' % (str($x.k_size))
        #end for

        #if $advanced_settings.resolution_cond.resolution_param == "scaled":
            #set settings += ',scaled=%s' % str($advanced_settings.resolution_cond.scaled)
        #end if

        #if $advanced_settings.resolution_cond.resolution_param == "num":
            #set settings += ',num=%s' % str($advanced_settings.resolution_cond.num)
        #end if
        
        #set settings += ',seed=%s' % (str($advanced_settings.seed))

        #set settings += ',%s' % (str($input_type_cond.sketch_type))

        -p "${settings}"
        
        ### input files

        $input

        #if $advanced_settings.merge:
            #for $s in $advanced_settings.merge:
                $s
            #end for
            --name sketch
        #end if



        -o $out_file1
    ]]></command>
    <inputs>
        <param name="input" type="data" format="fasta,fastqsanger,fastqillumina" label="Input file"/>
        <conditional name="input_type_cond">
            <param name="input_type_param" type="select" label="Input reads type" help="Select the type that suits your input file">
                <option value="dna" selected="true">DNA</option>
                <option value="protein">Protein</option>
                <option value="translate">Translate - reads in DNA sequences, translate it into protein and then sketch the protein sequences.</option>
            </param>
            <when value="dna">
                <param name="sketch_type" type="select" label="Sketch type" help="This controls how the sketch is encoded">
                    <option value="dna" selected="true">DNA</option>
                    <option value="skipm1n3">skipm1n3</option>
                    <option value="skipm2n3">skipm2n3</option>
                </param>
            </when>
            <when value="protein">
                <param name="sketch_type" type="select" label="Sketch type" help="This controls how the sketch is encoded">
                    <option value="protein" selected="true">Protein</option>
                    <option value="dayhoff">dayhoff</option>
                    <option value="hp">hp</option>
                    <option value="skipm1n3">skipm1n3</option>
                    <option value="skipm2n3">skipm2n3</option>
                </param>
            </when>
            <when value="translate">
                <param name="sketch_type" type="select" label="Sketch type" help="This controls how the sketch is encoded">
                    <option value="protein" selected="true">Protein</option>
                    <option value="dayhoff">dayhoff</option>
                    <option value="hp">hp</option>
                    <option value="skipm1n3">skipm1n3</option>
                    <option value="skipm2n3">skipm2n3</option>
                </param>
            </when>
        </conditional>
        <section name="advanced_settings" title="Advanced Settings" expanded="no">
            <param name="merge" type="data" optional="true" label="Add more input files" multiple="true" format="fasta,fastqsanger,fastqillumina" help="adding more files would have the effects of merging the sequence records before signature creation"/>
            <!-- Control Hash size (added condiotion because params are incompatable with each other) -->
            <conditional name="resolution_cond" label="Signatures resoltion">
                <param name="resolution_param" type="select" label="Choose signature resolution method" help="sourmash supports two ways of choosing the resolution or size of your signatures: using num to specify the maximum number of hashes, or scaled to specify the compression ratio.">
                    <option value="scaled">Scaled</option>
                    <option value="num">Number</option>
                    <option value="default" selected="true">Use Defaults</option>
                </param>
                <when value="scaled">
                    <param name="scaled" type="integer" min="1" optional="true" value="" label="Compression ratio" help="sets the sampling rate for k-mers in the scaled MinHash sketch."/>
                </when>
                <when value="num">
                    <param name="num" type="integer" min="1" optional="true" value="" label="Minhash size" help="create a standard MinHash with no more than [value] k-mers kept"/>
                </when>
                <when value="default"/>
            </conditional>
            <repeat name="k_size_repeat" title="k-mer sizes" min="0" help="create a sketch at this k-mer size; can provide more than one">
                <param name="k_size" type="integer" min="4" max="100" label=""/>
            </repeat>
            <param name="abund" type="boolean" value="false" label="Create abundance-weighted" help="by default, sourmash tracks k-mer presence, not their abundance. However, it is possible to take into account abundance information by selecting this option."/>
            <param name="seed" type="integer" value="42" min="0" label="Seed" help="set the random number seed used for k-mer hashing"/>
        </section>
    </inputs>
    <outputs>
        <data name="out_file1" format="sourmash.sig" label="${tool.name} on ${on_string}"/>
    </outputs>
        <tests>
        <!-- 1) test moode dna-->
        <test expect_num_outputs="1">
            <param name="input" location="https://zenodo.org/records/17746813/files/GCF_000005845.2_ASM584v2_genomic.fna.gz" />       
            <conditional name="input_type_cond">
                <param name="input_type_param" value="dna"/>
            </conditional> 
            <output name="out_file1" ftype="sourmash.sig">
                <assert_contents>
                    <has_text text="sourmash_signature"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- 2) test k-mer size-->
        <test expect_num_outputs="1">
            <param name="input" location="https://zenodo.org/records/17746813/files/GCF_000005845.2_ASM584v2_genomic.fna.gz" />       
            <conditional name="input_type_cond">
                <param name="input_type_param" value="dna"/>
            </conditional> 
            <section name="advanced_settings">
                <param name="k_size_repeat_0|k_size" value="10"/> 
            </section>
            <output name="out_file1" ftype="sourmash.sig">
                <assert_contents>
                    <has_text text="40364619113918"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- 3) test scale -->
        <test expect_num_outputs="1">
            <param name="input" location="https://zenodo.org/records/17746813/files/GCF_000005845.2_ASM584v2_genomic.fna.gz" />       
            <conditional name="input_type_cond">
                <param name="input_type_param" value="dna"/> 
            </conditional> 
            <section name="advanced_settings">
                <conditional name="resolution_cond">
                    <param name="resolution_param" value="scaled"/>
                    <param name="scaled" value="500"/>          
                </conditional>
            </section>
            <output name="out_file1" ftype="sourmash.sig">
                <assert_contents>
                    <has_text text="1652243004613"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- 4) test number -->
        <test expect_num_outputs="1">
            <param name="input" location="https://zenodo.org/records/17746813/files/GCF_000005845.2_ASM584v2_genomic.fna.gz" />       
            <conditional name="input_type_cond">
                <param name="input_type_param" value="dna"/> 
            </conditional>
            <section name="advanced_settings">
                <conditional name="resolution_cond">
                    <param name="resolution_param" value="num"/>
                    <param name="num" value="1000"/>            
                </conditional>
            </section>
            <output name="out_file1" ftype="sourmash.sig">
                <assert_contents>
                    <has_text text="9061051479453"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- 5) abund -->
        <test expect_num_outputs="1">
            <param name="input" location="https://zenodo.org/records/17746813/files/GCF_000005845.2_ASM584v2_genomic.fna.gz" />       
            <conditional name="input_type_cond">
                <param name="input_type_param" value="dna"/> 
            </conditional>            
            <section name="advanced_settings">
                <param name="abund" value="true"/>
            </section>
            <output name="out_file1" ftype="sourmash.sig">
                <assert_contents>
                    <has_text text="1652243004613"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- 6) seed 
        <test expect_num_outputs="1">
            <param name="input" location="https://zenodo.org/records/17746813/files/GCF_000005845.2_ASM584v2_genomic.fna.gz" />       
            <conditional name="input_type_cond">
                <param name="input_type_param" value="dna"/>          
            </conditional>    
            <section name="advanced_settings">
                <param name="seed" value="30"/>
            </section>
            <output name="out_file1">
                <assert_contents>
                    <has_text text="2001073340508"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>-->
        <!-- 7) output type -->
        <test expect_num_outputs="1">
            <param name="input" location="https://zenodo.org/records/17746813/files/GCF_000005845.2_ASM584v2_genomic.fna.gz" />       
            <conditional name="input_type_cond">
                <param name="input_type_param" value="translate"/>
                <param name="sketch_type" value="protein"/>       
            </conditional>    
            <section name="advanced_settings">
                <conditional name="resolution_cond">
                    <param name="resolution_param" value="num"/>
                    <param name="num" value="500"/>            
                </conditional>
                <param name="k_size_repeat_0|k_size" value="30"/> 
            </section>
            <output name="out_file1" ftype="sourmash.sig">
                <assert_contents>
                    <has_text text="1073771966595,8590342626069,11888203597014,12380852885337"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- 8) Merge files -->
        <test expect_num_outputs="1">
            <param name="input" location="https://zenodo.org/records/17746813/files/GCF_000005845.2_ASM584v2_genomic.fna.gz" />       
            <conditional name="input_type_cond">
                <param name="input_type_param" value="dna"/>
            </conditional>    
            <section name="advanced_settings">
                <param name="merge" location="https://zenodo.org/records/17746813/files/GCF_000017325.1_ASM1732v1_genomic.fna.gz"/>
                <param name="merge" location="https://zenodo.org/records/17746813/files/GCF_000021665.1_ASM2166v1_genomic.fna.gz"/>
            </section>
            <output name="out_file1" ftype="sourmash.sig">
                <assert_contents>
                    <has_text text="18446744073709552"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
        **What the too does?**
        
        This tool generates MinHash sketches from sequence data. MinHash sketches are compact representations of sequences that enable fast comparisons and similarity searches.

        **Input**

        Accepts FASTA or FASTQ files containing DNA or protein sequences.

        **Modes**

        - dna: Processes DNA sequences and outputs DNA sketches.
        - protein: Processes protein sequences and outputs protein sketches.
        - translate: Translates DNA sequences in all six frames and outputs protein sketches.
        - fromfile: Reads a CSV file listing genome and proteome locations, producing sketches for all specified entries.

        **Advanced Settings**

        - k-mer sizes: Specify one or more k-mer sizes to create sketches at multiple resolutions.
        - Compression ratio (scaled): Use scaled MinHash to deterministically sample k-mers at a given ratio, reducing sketch size.
        - MinHash size (number): Limit the number of k-mers retained in a standard MinHash sketch.
    ]]></help>
    <expand macro="citations"/>
</tool>
