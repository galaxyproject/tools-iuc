<tool id="sourmash_search" name="sourmash search" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>search a collection of signatures for matches to a single query signature</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        @Picklist_copy_file@

        sourmash search
        '$query_sig'
        #for $db in $database:
            ${db}
        #end for
        
        $search_options.search_type

        -t $search_options.t

        @Picklist_commandline@
        
        @common_params_commandline@

        ### Output Options
        #if $output_section.save_matches:
            --save-matches $save_matches
        #end if
        #if $output_section.output_csv:
            -o $search_results
        #end if
        #if $output_section.output_log:
            > $log_file
        #end if
        $output_section.best_only
        #if $output_section.num_results:
            --num-results $output_section.num_results
        #end if
    ]]></command>
    <inputs>
        <param name="query_sig" type="data" format="sourmash.sig" label="Query Signature" help="Single signature file to search for matches"/>
        <param name="database" type="data" multiple="true" format="zip,sourmash.sig" label="Indexed Database" help="Indexed database files (.sbt.zip, .rocksdb.zip) or Signature files (please don't input multiple fie format)"/>
        <section name="search_options" title="Search Options" expanded="true">
            <param name="search_type" type="select" label="Search metric" help="Choose similarity measure for matching">
                <option value="" selected="true">Jaccard similarity (symmetric)</option>
                <option value="--containment">Containment (query contained in match)</option>
                <option value="--max-containment">Max-containment (max directional)</option>
            </param>
            <param argument="-t" type="float" value="0.08" min="0.0" max="1.0" label="Similarity threshold" help="Minimum score to report matches"/>
        </section>
        <section name="output_section" title="Outputs options" expanded="false">
            <param name="output_csv" type="boolean" checked="true" label="Save results to CSV" help="Write matches â‰¥ threshold to CSV"/>
            <param name="output_log" type="boolean" checked="true" label="Output Log File" help="Write the tools standard output to a file"/>
            <param argument="--save-matches" type="boolean" checked="false" label="Save Matches" help="Save matches to a signature file"/>
            <param argument="--best-only" type="boolean" optional="true" checked="false" truevalue="--best-only" falsevalue="" label="Best Only" help="Save the best match only"/>
            <param argument="--num-results" type="integer" optional="true" value="" min="1" label="Number of Results" help="Search for max given number of results"/>
        </section>
        <section name="sig_select" title="Signature selectors" expanded="false">
            <expand macro="ksize_macro"/>
            <expand macro="mol_type_macro"/>
            <expand macro="scaled_macro"/>
        </section>
        <expand macro="picklist_macro"/>
    </inputs>
    <outputs>
        <data name="log_file" format="txt" label="${tool.name} on ${on_string}: log">
            <filter>output_section['output_log']</filter>
        </data>
        <data name="search_results" format="csv" from_work_dir="search_results.csv" label="${tool.name} on ${on_string}: Search matches">
            <filter>output_section['output_csv']</filter>
        </data>
        <data name="save_matches" format="sourmash.sig"  label="${tool.name} on ${on_string}: Save matches">
            <filter>output_section['save_matches']</filter>
        </data>
    </outputs>
    <tests>
        <!-- 1) Jaccard similarity -->
        <test expect_num_outputs="2">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <section name="output_section">
                <param name="output_csv" value="true"/>
                <param name="output_log" value="true"/>
            </section>
            <output name="search_results" ftype="csv">
                <assert_contents>
                    <has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
                </assert_contents>
            </output>
            <output name="log_file" ftype="txt">
                <assert_contents>
                    <has_text_matching expression="1 matches"/>
                </assert_contents>
            </output>
        </test>
        <!-- 2) containment -->
        <test expect_num_outputs="2">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <section name="search_options">
                <param name="search_type" value="--containment"/>
            </section>
            <section name="output_section">
                <param name="output_csv" value="true"/>
                <param name="output_log" value="true"/>
            </section>
            <output name="search_results" ftype="csv">
                <assert_contents>
                    <has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
                </assert_contents>
            </output>
            <output name="log_file" ftype="txt">
                <assert_contents>
                    <has_text_matching expression="1 matches"/>
                </assert_contents>
            </output>
        </test>
        <!-- 3) max-containment -->
        <test expect_num_outputs="2">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <section name="search_options">
                <param name="search_type" value="--max-containment"/>
            </section>
            <section name="output_section">
                <param name="output_csv" value="true"/>
                <param name="output_log" value="true"/>
            </section>
            <output name="search_results" ftype="csv">
                <assert_contents>
                    <has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
                </assert_contents>
            </output>
            <output name="log_file" ftype="txt">
                <assert_contents>
                    <has_text_matching expression="1 matches"/>
                </assert_contents>
            </output>
        </test>
        <!-- 4) threshold parameter (set to 0.0) -->
        <test expect_num_outputs="2">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <section name="search_options">
                <param name="t" value="0.0"/>
            </section>
            <section name="output_section">
                <param name="output_csv" value="true"/>
                <param name="output_log" value="true"/>
            </section>
            <output name="search_results" ftype="csv">
                <assert_contents>
                    <has_text_matching expression="(?i)\bsimilarity\b"/>
                    <has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
                </assert_contents>
            </output>
            <output name="log_file" ftype="txt">
                <assert_contents>
                    <has_text_matching expression="3 matches"/>
                </assert_contents>
            </output>
        </test>
        <!-- 5) picklist -->
        <test expect_num_outputs="2">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <section name="search_options">
                <param name="t" value="0.0"/>
            </section>
            <section name="picklist">
                <param name="picklist_file" value="labels.csv"/>
                <param name="pickstyle" value="include"/>
            </section>
            <section name="output_section">
                <param name="output_csv" value="true"/>
                <param name="output_log" value="true"/>
            </section>
            <output name="search_results" ftype="csv">
                <assert_contents>
                    <has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
                </assert_contents>
            </output>
            <output name="log_file" ftype="txt">
                <assert_contents>
                    <has_text_matching expression="2 matches"/>
                </assert_contents>
            </output>
        </test>
        <!-- 6) Save matches -->
        <test expect_num_outputs="1">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <section name="output_section">
                <param name="output_csv" value="false"/>
                <param name="output_log" value="false"/>
                <param name="save_matches" value="true"/>
            </section>
            <output name="save_matches" ftype="sourmash.sig">
                <assert_contents>
                    <has_text text="18446744073709552"/>
                </assert_contents>
            </output>
        </test>
        <!-- 7) best only -->
        <test expect_num_outputs="1">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <section name="output_section">
                <param name="output_csv" value="false"/>
                <param name="output_log" value="true"/>
                <param name="save_matches" value="false"/>
                <param name="best_only" value="true"/>
            </section>
            <output name="log_file" ftype="txt">
                <assert_contents>
                    <has_text_matching expression="1 matches"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    
    <help><![CDATA[
**What it does?**

`sourmash search` finds **one query signature** against an indexed database (could be created using `sourmash index`), returning the most similar matches ranked by **Jaccard similarity** or **containment**.

**Search Mode**:
    - Jaccard similarity: Symmetric measure of overlap between two sets.
    - Containment: Asymmetric; measures the fraction of query hashes found in the match. Useful for finding genomes within metagenomes.
    - Max-containment: Maximum of forward and reverse containment. Bidirectional asymmetric metric.

**Outputs**:
    - CSV File: saves all matches to csv file. Columns include:
        - `match_name`: Matched signature identifier
        - `similarity` or `containment`: Match score
        - `match_md5`: Signature hash
    - Log File

@Picklist_help@
]]></help>
    <expand macro="citations"/>
</tool>