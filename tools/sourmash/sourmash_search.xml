<tool id="sourmash_search" name="sourmash search" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        @Picklist_copy_file@

        sourmash search
        '$query_sig'
        '$database'
        
        $search_options.search_type

        -t $search_options.threshold

        @Picklist_commandline@
        
        #if $output_csv:
            -o $search_results
        #end if

        #if $output_log:
            > $log_file
        #end if
    ]]></command>
    <inputs>
        <param name="query_sig" type="data" format="json" label="Query Signature" help="Single signature file (.sig, .json) to search for matches"/>
        <param name="database" type="data" format="zip" label="Indexed Database" help="Indexed database file (.sbt.zip, .rocksdb.zip)"/>
        <section name="search_options" title="Search Options" expanded="true">
            <param name="search_type" type="select" label="Search metric" help="Choose similarity measure for matching">
                <option value="" selected="true">Jaccard similarity (symmetric)</option>
                <option value="--containment">Containment (query contained in match)</option>
                <option value="--max-containment">Max-containment (max directional)</option>
            </param>
            <param name="threshold" argument="-t" type="float" value="0.08" min="0.0" max="1.0" label="Similarity threshold" help="Minimum score to report matches"/>
        </section>
        <param name="output_csv" type="boolean" checked="true" label="Save results to CSV" help="Write ALL matches ≥ threshold to CSV"/>
        <param name="output_log" type="boolean" checked="true" label="Output Log File" help="Write the tools standard output to a file"/>
        <expand macro="picklist_macro"/>
    </inputs>
    <outputs>
        <data name="log_file" format="txt" label="${tool.name} on ${on_string}: log">
            <filter>output_log</filter>
        </data>
        <data name="search_results" format="csv" from_work_dir="search_results.csv" label="${tool.name} on ${on_string}: Search matches">
            <filter>output_csv</filter>
        </data>
    </outputs>
    <tests>
        <!-- 1) Jaccard similarity -->
        <test expect_num_outputs="2">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <param name="output_csv" value="true"/>
            <param name="output_log" value="true"/>
            <output name="search_results" ftype="csv">
                <assert_contents>
                    <has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
                </assert_contents>
            </output>
            <output name="log_file" ftype="txt">
                <assert_contents>
                    <has_text_matching expression="1 matches"/>
                </assert_contents>
            </output>
        </test>
        <!-- 2) containment -->
        <test expect_num_outputs="2">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <section name="search_options">
                <param name="search_type" value="--containment"/>
            </section>
            <param name="output_csv" value="true"/>
            <param name="output_log" value="true"/>
            <output name="search_results" ftype="csv">
                <assert_contents>
                    <has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
                </assert_contents>
            </output>
            <output name="log_file" ftype="txt">
                <assert_contents>
                    <has_text_matching expression="1 matches"/>
                </assert_contents>
            </output>
        </test>
        <!-- 3) max-containment -->
        <test expect_num_outputs="2">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <section name="search_options">
                <param name="search_type" value="--max-containment"/>
            </section>
            <param name="output_csv" value="true"/>
            <param name="output_log" value="true"/>
            <output name="search_results" ftype="csv">
                <assert_contents>
                    <has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
                </assert_contents>
            </output>
            <output name="log_file" ftype="txt">
                <assert_contents>
                    <has_text_matching expression="1 matches"/>
                </assert_contents>
            </output>
        </test>
        <!-- 4) threshold parameter (set to 0.0) -->
        <test expect_num_outputs="2">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <section name="search_options">
                <param name="threshold" value="0.0"/>
            </section>
            <param name="output_csv" value="true"/>
            <param name="output_log" value="true"/>
            <output name="search_results" ftype="csv">
                <assert_contents>
                    <has_text_matching expression="(?i)\bsimilarity\b"/>
                    <has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
                </assert_contents>
            </output>
            <output name="log_file" ftype="txt">
                <assert_contents>
                    <has_text_matching expression="3 matches"/>
                </assert_contents>
            </output>
        </test>
        <!-- 5) picklist -->
        <test expect_num_outputs="2">
            <param name="query_sig" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
            <param name="database" value="indexed.sbt.zip"/>
            <section name="search_options">
                <param name="threshold" value="0.0"/>
            </section>
            <conditional name="picklist_cond">
                <param name="picklist_param" value="true"/>
                <param name="picklist_file" value="labels.csv"/>
                <param name="pickstyle" value="include"/>
            </conditional>
            <param name="output_csv" value="true"/>
            <param name="output_log" value="true"/>
            <output name="search_results" ftype="csv">
                <assert_contents>
                    <has_text text="GCF_000005845.2_ASM584v2_genomic.fna.gz"/>
                </assert_contents>
            </output>
            <output name="log_file" ftype="txt">
                <assert_contents>
                    <has_text_matching expression="2 matches"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    
    <help><![CDATA[
## What it does

`sourmash search` finds **one query signature** against a collection or indexed database, returning the most similar matches ranked by **Jaccard similarity** (default) or **containment**.

## Key Concepts

**Jaccard similarity**: Symmetric measure of overlap between two sets. Ranges 0–1 (default metric).

**Containment**: Asymmetric; measures the fraction of query hashes found in the match. Useful for finding genomes within metagenomes.

**Max-containment**: Maximum of forward and reverse containment. Bidirectional asymmetric metric.

**Threshold**: Minimum score (0.0–1.0) to report a match; default 0.08.

## Output

### Console (stdout)
Shows top `-n` matches with similarity/containment % and signature name.

### CSV File (`-o`)
Saves **all matches ≥ threshold** (not limited by `-n`). Columns include:
- `match_name`: Matched signature identifier
- `similarity` or `containment`: Match score
- `match_md5`: Signature hash

@Picklist_help@
]]></help>
    <expand macro="citations"/>
</tool>