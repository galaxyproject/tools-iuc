<!-- Not Ready for Review Yet -->
<tool id="sourmash_signature" name="sourmash signature" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        sourmash sig

        #if $sig.subcommand == "describe":
            describe $sig.signature
            > describe.txt
        #else if $sig.subcommand == "cat": 
            @list_inputs@
            -o all.sig.zip
        #else if $sig.subcommand == "grep": 
            grep
            #set patterns_string = ""
            #for $i, $s in enumerate($sig.patterns):
                #if $i > 0:
                    #set patterns_string += "|"
                #end if
                #set patterns_string += '%s' % ($s.pattern) 
            #end for
            '$patterns_string'
            #for $file in $sig.input_files:
                $file
            #end for
            $sig.case_insensitive
            $sig.exclusion
            -o match.sig.zip
        #else if $sig.subcommand == "merge":
            @list_inputs@
            $sig.flatten
            @sig_params@
            -o merged.sig
        #else if $sig.subcommand == "split":  
            split
            $sig.signature
            @sig_params@
            --outdir sigs
        #end if
    ]]></command>
    <inputs>
        <conditional name="sig" label="Sourmash Signature Subcommand">
            <param name="subcommand" type="select" optional="false" label="Subcommand" help="Choose the sourmash lca subcommand tool. Read Help section for detailed information about each subcommand.">
                <option value="describe">describe</option>
                <option value="cat">cat</option>
                <option value="grep">grep</option>
                <option value="merge">merge</option>
                <option value="split">split</option>
            </param>
            <when value="describe">
                <expand macro="single_signature"/>
            </when>
            <when value="cat">
                <expand macro="multiple_signatures"/>
            </when>
            <when value="grep">
                <param name="input_files" type="data" format="json,zip" multiple="true" label="Input files" help="Signature files to search against. Accepts individual signature files or compressed archives containing multiple signatures."/>
                <repeat name="patterns" title="Patterns" min="0"  help="Insert a pattern to match against the provided signature files.">
                    <param name="pattern" type="text" label="Pattern"/> 
                </repeat>
                <param name="case_insensitive" argument="-i" type="boolean" truevalue="-i" falsevalue="" checked="false" label="Case-insensitive" help="If checked, matching is performed in a case-insensitive manner."/> 
                <param name="exclusion" argument="-v" type="boolean" truevalue="-v" falsevalue="" checked="false" label="Exclusion" help="If checked, exclude signatures that match the given patterns instead of including them."/> 
            </when>
            <when value="merge">
                <expand macro="multiple_signatures"/>
                <param argument="--flatten" type="boolean" truevalue="--flatten" falsevalue="" checked="false" label="Flatten" help="Remove abundances from all signatures."/>
                <expand macro="sig_ksize" help="Specifies which k-mer size to merge when multiple signature files with different k-sizes are provided."/>
                <expand macro="sig_moltype" help="Specifies which moltype to merge when multiple signature files with different moltypes are provided."/>
            </when>
            <when value="split">
                <expand macro="single_signature"/>
                <expand macro="sig_ksize" help="Select the k-mer size to extract when splitting a merged signatures file containing multiple k-sizes. Leave blank to keep all k-sizes."/>
                <expand macro="sig_moltype" help="Select the molecule type to extract when splitting signatures with mixed moltypes. Leave blank to keep all moltypes."/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="describe" from_work_dir="describe.txt" format="txt" label="${tool.name} ${sig.subcommand} on ${on_string}: Signature Describtion">
            <filter>sig['subcommand'] == 'describe'</filter>
        </data>
        <data name="cat" from_work_dir="all.sig.zip" format="zip" label="${tool.name} ${sig.subcommand} on ${on_string}: All signatures">
            <filter>sig['subcommand'] == 'cat'</filter>
        </data>
        <data name="grep" from_work_dir="match.sig.zip" format="zip" label="${tool.name} ${sig.subcommand} on ${on_string}: Found Matches">
            <filter>sig['subcommand'] == 'grep'</filter>
        </data>
        <data name="merge" from_work_dir="merged.sig" format="json" label="${tool.name} ${sig.subcommand} on ${on_string}: Merged Sigantures">
            <filter>sig['subcommand'] == 'merge'</filter>
        </data>
        <collection name="split_output" type="list" format="json" label="Splitted Signatures">
            <discover_datasets pattern="__name_and_ext__" directory="sigs" />
            <filter>sig['subcommand'] == 'split'</filter>
        </collection>
    </outputs>
    <tests>
    <!-- 1) describe -->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="describe"/>
            <param name="signature" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
        </conditional>
        <output name="describe" ftype="txt">
            <assert_contents>
                <has_text text="size: 4476"/>
            </assert_contents>
        </output>
    </test>
    <!-- 2) cat -->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="cat"/>
            <param name="signatures" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
        </conditional>
        <output name="cat" ftype="zip">
            <assert_contents>
                <has_archive_member path=".*\.csv" min="1">
                    <has_n_lines n="5"/>
                </has_archive_member>
            </assert_contents>
        </output>
    </test>
    <!-- 3) grep normal 2 patterns-->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="grep"/>
            <param name="input_files" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="patterns_0|pattern" value="09a08691ce52952152f0e866a59f6261"/>
            <param name="patterns_1|pattern" value="0a8632c67e6d88f737ddb510bef90337"/>
        </conditional>
        <output name="grep" ftype="zip">
            <assert_contents>
                <has_archive_member path=".*\.csv" min="1">
                    <has_n_lines n="4"/>
                </has_archive_member>
            </assert_contents>
        </output>
        <assert_stderr>
            <has_text text="Kextracted 2 signatures from 3 file(s)"/>
        </assert_stderr>
    </test>
    <!-- 4) grep - case insensitive-->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="grep"/>
            <param name="input_files" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="patterns_0|pattern" value="09A08691ce52952152f0e866a59f6261"/>
            <param name="patterns_1|pattern" value="0A8632c67e6d88f737ddb510bef90337"/>
            <param name="case_insensitive" value="true"/>
        </conditional>
        <output name="grep" ftype="zip">
            <assert_contents>
                <has_archive_member path=".*\.csv" min="1">
                    <has_n_lines n="4"/>
                </has_archive_member>
            </assert_contents>
        </output>
        <assert_stderr>
            <has_text text="Kextracted 2 signatures from 3 file(s)"/>
        </assert_stderr>
    </test>
    <!-- 5) grep - EXCLUSION-->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="grep"/>
            <param name="input_files" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="patterns_0|pattern" value="09A08691ce52952152f0e866a59f6261"/>
            <param name="patterns_1|pattern" value="0A8632c67e6d88f737ddb510bef90337"/>
            <param name="case_insensitive" value="true"/>
            <param name="exclusion" value="true"/>
        </conditional>
        <output name="grep" ftype="zip">
            <assert_contents>
                <has_archive_member path=".*\.csv" min="1">
                    <has_n_lines n="3"/>
                </has_archive_member>
            </assert_contents>
        </output>
        <assert_stderr>
            <has_text text="Kextracted 1 signatures from 3 file(s)"/>
        </assert_stderr>
    </test>
    <!-- 6) Merge -->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="merge"/>
            <param name="signatures" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="mol_type" value="--dna"/>
        </conditional>
        <output name="merge" ftype="json">
            <assert_contents>
                <has_text text="1652243004613"/>
            </assert_contents>
        </output>
        <assert_stderr>
            <has_text text="Kloaded and merged 3 signatures"/>
        </assert_stderr>
    </test>
    <!-- 7) split -->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="split"/>
            <param name="signature" value="2.fa.sig"/>
            <param name="ksize" value="51"/>
        </conditional>
        <output_collection name="split_output" type="list">
            <element name="43f3b48e.k=51.scaled=1000.DNA.dup=0.2.fa" file="43f3b48e.k=51.scaled=1000.DNA.dup=0.2.fa" ftype="json" />
        </output_collection>
        <assert_stderr>
            <has_text text="Kloaded and split 1 signatures total."/>
        </assert_stderr>
    </test>
    </tests>
    <help><![CDATA[
        **Sourmash lca**

        These commands use LCA databases (created with lca index, below, or prepared databases)

        List of Subcomand to choose from:
            - **describe**:
            - **cat**:
            - **grep**:
            - **merge**: Merge two (or more) signatures. Please note that sig merge can only merge compatible sketches - if there are multiple k-mer sizes or molecule types present in any of the signature files, you will need to choose one k-mer size and/or one moltype.
            - **split**: 

            
    ]]></help>
    <expand macro="citations"/>
</tool>
