<!-- Not Ready for Review Yet -->
<tool id="sourmash_signature" name="sourmash signature" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        sourmash sig

        #if $sig.subcommand == "describe":
            describe $sig.signature
            > describe.txt
        #else if $sig.subcommand == "cat": 
            @list_inputs@
            -o all.sig.zip
        #else if $sig.subcommand == "grep": 
            grep
            #set patterns_string = ""
            #for $i, $s in enumerate($sig.patterns):
                #if $i > 0:
                    #set patterns_string += "|"
                #end if
                #set patterns_string += '%s' % ($s.pattern) 
            #end for
            '$patterns_string'
            #for $file in $sig.input_files:
                $file
            #end for
            $sig.case_insensitive
            $sig.exclusion
            -o match.sig.zip
        #end if
    ]]></command>
    <inputs>
        <conditional name="sig" label="Sourmash Signature Subcommand">
            <param name="subcommand" type="select" optional="false" label="Subcommand" help="Choose the sourmash lca subcommand tool. Read Help section for detailed information about each subcommand.">
                <option value="describe">describe</option>
                <option value="cat">cat</option>
                <option value="grep">grep</option>
            </param>
            <when value="describe">
                <expand macro="single_signature"/>
            </when>
            <when value="cat">
                <expand macro="multiple_signatures"/>
            </when>
            <when value="grep">
                <param name="input_files" type="data" format="json,zip" multiple="true" label="Input files" help="Signature files to search against. Accepts individual signature files or compressed archives containing multiple signatures."/>
                <repeat name="patterns" title="Patterns" min="0"  help="Insert a pattern to match against the provided signature files.">    
                    <param name="pattern" type="text" label="pattern"/> 
                </repeat>
                <param name="case_insensitive" argument="-i" type="boolean" truevalue="-i" falsevalue="" checked="false" label="Case-insensitive" help="If checked, matching is performed in a case-insensitive manner."/> 
                <param name="exclusion" argument="-v" type="boolean" truevalue="-v" falsevalue="" checked="false" label="Exclusion" help="If checked, exclude signatures that match the given patterns instead of including them."/> 
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="describe" from_work_dir="describe.txt" format="txt" label="${tool.name} ${sig.subcommand} on ${on_string}: Signature Describtion">
            <filter>sig['subcommand'] == 'describe'</filter>
        </data>
        <data name="cat" from_work_dir="all.sig.zip" format="zip" label="${tool.name} ${sig.subcommand} on ${on_string}: All signatures">
            <filter>sig['subcommand'] == 'cat'</filter>
        </data>
        <data name="grep" from_work_dir="match.sig.zip" format="zip" label="${tool.name} ${sig.subcommand} on ${on_string}: Found Matches">
            <filter>sig['subcommand'] == 'grep'</filter>
        </data>
    </outputs>
    <tests>
    <!-- 1) describe -->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="describe"/>
            <param name="signature" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig"/>
        </conditional>
        <output name="describe" ftype="txt">
            <assert_contents>
                <has_text text="size: 4476"/>
            </assert_contents>
        </output>
    </test>
    <!-- 2) cat -->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="cat"/>
            <param name="signatures" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
        </conditional>
        <output name="cat" ftype="zip">
            <assert_contents>
                <has_archive_member path=".*\.csv" min="1">
                    <has_n_lines n="5"/>
                </has_archive_member>
            </assert_contents>
        </output>
    </test>
    <!-- grep normal 2 patterns-->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="grep"/>
            <param name="input_files" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="patterns_0|pattern" value="09a08691ce52952152f0e866a59f6261"/>
            <param name="patterns_1|pattern" value="0a8632c67e6d88f737ddb510bef90337"/>
        </conditional>
        <output name="grep" ftype="zip">
            <assert_contents>
                <has_archive_member path=".*\csv" min="1">
                    <has_n_lines n="4"/>
                </has_archive_member>
            </assert_contents>
        </output>
    </test>
    <!-- grep - case insensitive-->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="grep"/>
            <param name="input_files" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="patterns_0|pattern" value="09A08691ce52952152f0e866a59f6261"/>
            <param name="patterns_1|pattern" value="0A8632c67e6d88f737ddb510bef90337"/>
            <param name="case_insensitive" value="true"/>
        </conditional>
        <output name="grep" ftype="zip">
            <assert_contents>
                <has_archive_member path=".*\csv" min="1">
                    <has_n_lines n="4"/>
                </has_archive_member>
            </assert_contents>
        </output>
        <assert_stderr>
            <has_text text="Kextracted 2 signatures from 3 file(s)"/>
        </assert_stderr>
    </test>
    <!-- grep - EXCLUSION-->
    <test expect_num_outputs="1">
        <conditional name="sig">
            <param name="subcommand" value="grep"/>
            <param name="input_files" value="GCF_000005845.2_ASM584v2_genomic.fna.gz.sig,GCF_000017325.1_ASM1732v1_genomic.fna.gz.sig,GCF_000021665.1_ASM2166v1_genomic.fna.gz.sig"/>
            <param name="patterns_0|pattern" value="09A08691ce52952152f0e866a59f6261"/>
            <param name="patterns_1|pattern" value="0A8632c67e6d88f737ddb510bef90337"/>
            <param name="case_insensitive" value="true"/>
            <param name="exclusion" value="true"/>
        </conditional>
        <output name="grep" ftype="zip">
            <assert_contents>
                <has_archive_member path=".*\csv" min="1">
                    <has_n_lines n="3"/>
                </has_archive_member>
            </assert_contents>
        </output>
        <assert_stderr>
            <has_text text="Kextracted 1 signatures from 3 file(s)"/>
        </assert_stderr>
    </test>
    </tests>
    <help><![CDATA[
        **Sourmash lca**

        These commands use LCA databases (created with lca index, below, or prepared databases)

        List of Subcomand to choose from:
            - **describe**:
            - **index**:
            - **classify**:
    ]]></help>
    <expand macro="citations"/>
</tool>
