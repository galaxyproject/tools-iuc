<tool id="gatk4_base_recalibrator" name="GATK4 BaseRecalibrator" version="@WRAPPER_VERSION@" profile="@PROFILE@">
    <description>Generates recalibration table for Base Quality Score Recalibration (BQSR)</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_cmd"/>
    
    <command detect_errors="exit_code"><![CDATA[
    ## Create a temp directory
    mkdir -p tmp &&

    ## 1. Link Reference Genome
    @GATK_LINK_REF@

    ## 2. Link Input BAM and Index
    ln -s '$input_bam' input.bam &&
    ln -s '${input_bam.metadata.bam_index}' input.bai &&

    ## 3. Link Known Sites
    ## Loop handles multiple input files (e.g., dbSNP and Indels)
    #for $i, $site in enumerate($known_sites):
        ln -s '$site' known_sites_${i}.vcf.gz &&
        ln -s '${site.metadata.tabix_index}' known_sites_${i}.vcf.gz.tbi &&
    #end for

    ## 4. Link Interval List (if provided)
    #if $intervals:
        ln -s '$intervals' intervals.interval_list &&
    #end if

    ## 5. Run BaseRecalibrator
    gatk --java-options "-Xmx\${GALAXY_MEMORY_MB:-4096}m -XX:-UsePerfData" BaseRecalibrator
        -R reference.fa
        -I input.bam
        -O recal_data.table
        
        ## Add all known sites from the list
        #for $i, $site in enumerate($known_sites):
            --known-sites known_sites_${i}.vcf.gz
        #end for
        
        ## Use dedicated temp directory
        --tmp-dir tmp

        ## Use the original qualities (OQ tag) if requested by the user
        $use_original_qualities

        #if $intervals:
            -L intervals.interval_list
        #end if
    ]]></command>

    <inputs>
        <expand macro="gatk_ref_source" />
        
        <param name="input_bam" argument="-I" type="data" format="bam" label="Input BAM" help="The aligned input BAM file. Must be coordinate-sorted and indexed." />
        
        <expand macro="gatk_param_known_sites" />

        <expand macro="gatk_param_use_original_qualities" />

        <expand macro="gatk_param_intervals" />
    </inputs>

    <outputs>
        <data name="output_recal" format="txt" from_work_dir="recal_data.table" label="${tool.name} on ${on_string}: Recalibration Table" />
    </outputs>

    <tests>
        <test>
            <conditional name="reference_source">
                <param name="reference_source_selector" value="history" />
                <param name="reference_sequence" value="test_ref.fasta" />
            </conditional>
            <param name="input_bam" value="bqsr_input.bam" />
            <param name="known_sites" value="test_dbsnp.vcf.gz,test_mills.vcf.gz" />
            <param name="use_original_qualities" value="true" />
            <param name="intervals" value="bqsr_interval.interval_list" />
            <output name="output_recal" file="bqsr_expected.table" lines_diff="2" />
        </test>

        <test>
            <conditional name="reference_source">
                <param name="reference_source_selector" value="cached" />
                <param name="reference_sequence" value="test_ref" />
            </conditional>
            <param name="input_bam" value="bqsr_input.bam" />
            <param name="known_sites" value="test_dbsnp.vcf.gz,test_mills.vcf.gz" />
            <param name="use_original_qualities" value="true" />
            <param name="intervals" value="bqsr_interval.interval_list" />
            <output name="output_recal" file="bqsr_expected.table" lines_diff="2" />
        </test>
    </tests>

    <help><![CDATA[
        **BaseRecalibrator**

        Generates a recalibration table for Base Quality Score Recalibration (BQSR).

        **Input Requirements**

        * **Input BAM:** Must be aligned and indexed.
        * **Known Sites:** One or more VCF files (bgzipped/indexed) to mask real variants.

        **More Information**
        Visit `GATK Documentation <https://gatk.broadinstitute.org/hc/en-us/articles/360037593511-BaseRecalibrator>`_.
    ]]></help>

    <citations>
        <expand macro="citations" />
    </citations>
</tool>