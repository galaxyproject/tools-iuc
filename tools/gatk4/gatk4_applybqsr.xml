<tool id="gatk4_applybqsr" name="GATK4 ApplyBQSR" version="@WRAPPER_VERSION@" profile="@PROFILE@">
    <description>Apply Base Quality Score Recalibration (BQSR) to a BAM file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_cmd"/>
    
    <command detect_errors="exit_code"><![CDATA[
    ## Create a temp directory
    mkdir -p tmp &&

    ## 1. Link Reference Genome
    #if $reference_source.reference_source_selector == "history":
        ln -s '$reference_source.reference_sequence' reference.fa &&
        samtools faidx reference.fa &&
    #else:
        ln -s '$reference_source.reference_sequence.fields.path' reference.fa &&
        ln -s '${reference_source.reference_sequence.fields.path}.fai' reference.fa.fai &&
    #end if
    
    ## Ensure dictionary exists
    gatk CreateSequenceDictionary -R reference.fa &&

    ## 2. Link Input BAM and Index
    ln -s '$input_bam' input.bam &&
    ln -s '${input_bam.metadata.bam_index}' input.bai &&

    ## 3. Link Recalibration Table (From BaseRecalibrator)
    ln -s '$bqsr_recal_file' recal_data.table &&

    ## 4. Link Interval List (if provided)
    #if $ival_type.ival_type_sel == 'ival_file':
        ln -s '$ival_type.intervals' intervals.interval_list &&
    #end if

    ## 5. Run ApplyBQSR
    gatk --java-options "-Xmx\${GALAXY_MEMORY_MB:-4096}m -XX:-UsePerfData" ApplyBQSR
        -R reference.fa
        -I input.bam
        -O output.bam
        --bqsr-recal-file recal_data.table
        
        ## Use current working directory for temp files
        --tmp-dir tmp

        ## Use the original qualities (OQ tag) if requested by the user
        $use_original_qualities
        
        ## Record the tool execution in the BAM header (PG tag)
        $add_output_sam_program_record

        #if $ival_type.ival_type_sel == 'ival_file':
            -L intervals.interval_list
        #end if
    ]]></command>

    <inputs>
        <conditional name="reference_source">
            <param name="reference_source_selector" type="select" label="Choose the source for the reference genome">
                <option value="cached">Locally cached</option>
                <option value="history" selected="true">History</option>
            </param>
            <when value="cached">
                <param name="reference_sequence" type="select" label="Reference" help="Select reference genome">
                    <options from_data_table="fasta_indexes" />
                </param>
            </when>
            <when value="history">
                <param name="reference_sequence" type="data" format="fasta" label="Reference" help="Select reference genome from history" />
            </when>
        </conditional>
        
        <param name="input_bam" argument="-I" type="data" format="bam" label="Input BAM" help="The original (uncalibrated) BAM file." />
        
        <param name="bqsr_recal_file" argument="--bqsr-recal-file" type="data" format="txt" label="Recalibration Table" help="The table generated by BaseRecalibrator." />

        <param argument="--use-original-qualities" type="boolean" truevalue="--use-original-qualities" falsevalue="" checked="true" label="Use Original Qualities" help="Use the OQ tag if present." />
        
        <param argument="--add-output-sam-program-record" type="boolean" truevalue="--add-output-sam-program-record" falsevalue="" checked="true" label="Add Output SAM Program Record" help="Adds an extra PG tag to the header." />

        <conditional name="ival_type">
            <param name="ival_type_sel" type="select" label="Restrict to Intervals?">
                <option value="no_ival" selected="true">No, process whole BAM</option>
                <option value="ival_file">Yes, use an Interval List</option>
            </param>
            <when value="no_ival"/>
            <when value="ival_file">
                <param name="intervals" argument="-L" type="data" format="picard_interval_list" label="Interval List" />
            </when>
        </conditional>
    </inputs>

    <outputs>
        <data name="output_bam" format="bam" from_work_dir="output.bam" label="${tool.name} on ${on_string}: Recalibrated BAM" />
    </outputs>

    <tests>
        <test>
            <conditional name="reference_source">
                <param name="reference_source_selector" value="history" />
                <param name="reference_sequence" value="test_ref.fasta" />
            </conditional>
            
            <param name="input_bam" value="bqsr_input.bam" />
            
            <param name="bqsr_recal_file" value="bqsr_expected.table" />
            
            <param name="use_original_qualities" value="true" />
            <param name="add_output_sam_program_record" value="true" />
            
            <conditional name="ival_type">
                <param name="ival_type_sel" value="ival_file" />
                <param name="intervals" value="bqsr_interval.interval_list" />
            </conditional>

            <output name="output_bam" file="applybqsr_expected.bam" compare="sim_size" delta="200" />
        </test>

        <test>
            <conditional name="reference_source">
                <param name="reference_source_selector" value="cached" />
                <param name="reference_sequence" value="test_ref" />
            </conditional>
            
            <param name="input_bam" value="bqsr_input.bam" />
            <param name="bqsr_recal_file" value="bqsr_expected.table" />
            <param name="use_original_qualities" value="true" />
            <param name="add_output_sam_program_record" value="true" />
            
            <conditional name="ival_type">
                <param name="ival_type_sel" value="ival_file" />
                <param name="intervals" value="bqsr_interval.interval_list" />
            </conditional>
            
            <output name="output_bam" file="applybqsr_expected.bam" compare="sim_size" delta="200" />
        </test>
    </tests>

    <help><![CDATA[
        **ApplyBQSR**

        This tool applies the recalibration table calculated by **BaseRecalibrator** to the input BAM file. It corrects the base quality scores to match the empirical error rate.

        **Input Requirements**

        * **Input BAM:** The original aligned BAM.
        * **Recalibration Table:** The output from BaseRecalibrator.

        **Output**

        * **Recalibrated BAM:** A new BAM file with corrected quality scores, ready for variant calling.

        **More Information**
        Visit `GATK Documentation <https://gatk.broadinstitute.org/hc/en-us/articles/360037593551-ApplyBQSR>`_.
    ]]></help>

    <citations>
        <expand macro="citations" />
    </citations>
</tool>