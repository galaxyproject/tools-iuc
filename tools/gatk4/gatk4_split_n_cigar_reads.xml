<tool id="gatk4_split_n_cigar_reads" name="GATK4 SplitNCigarReads" version="@WRAPPER_VERSION@" profile="@PROFILE@">
    <description>Splits reads that contain Ns in their CIGAR string (RNA-seq)</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_cmd"/>
    
    <command detect_errors="exit_code"><![CDATA[
    ## Create a temp directory
    mkdir -p tmp &&

    ## 1. Link Reference Genome
    @GATK_LINK_REF@

    ## 2. Link Input BAM and Index
    ## Link Galaxy metadata index to the expected GATK location
    ln -s '$input_bam' input.bam &&
    ln -s '${input_bam.metadata.bam_index}' input.bai &&

    ## 3. Link Interval List (if provided)
    #if $ival_type.ival_type_sel == 'ival_file':
        ln -s '$ival_type.intervals' intervals.interval_list &&
    #end if

    ## 4. Run SplitNCigarReads
    ## -XX:-UsePerfData prevents hsperfdata creation to avoid file locking issues
    gatk --java-options "-Xmx\${GALAXY_MEMORY_MB:-4096}m -XX:-UsePerfData" SplitNCigarReads
        -R reference.fa
        -I input.bam
        -O output.bam
        
        ## Disable internal index creation (Galaxy handles indexing)
        --create-output-bam-index false
        
        ## Use dedicated temp directory
        --tmp-dir tmp
        
        #if $ival_type.ival_type_sel == 'ival_file':
            -L intervals.interval_list
        #end if
    ]]></command>

    <inputs>
        <expand macro="gatk_ref_source" />
        
        <param name="input_bam" argument="-I" type="data" format="bam" label="Input BAM" help="BAM file from RNA-seq alignment (e.g., MarkDuplicates output). Must be indexed." />
        
        <expand macro="gatk_ival_type" />
    </inputs>

    <outputs>
        <data name="output_bam" format="bam" from_work_dir="output.bam" label="${tool.name} on ${on_string}: Split BAM" />
    </outputs>

    <tests>
        <test>
            <conditional name="reference_source">
                <param name="reference_source_selector" value="history" />
                <param name="reference_sequence" value="test_ref.fasta" />
            </conditional>
            <param name="input_bam" value="split_input.bam" />
            <conditional name="ival_type">
                <param name="ival_type_sel" value="ival_file" />
                <param name="intervals" value="split_interval.interval_list" />
            </conditional>
            <output name="output_bam" file="split_expected.bam" compare="sim_size" delta="200" />
        </test>

        <test>
            <conditional name="reference_source">
                <param name="reference_source_selector" value="cached" />
                <param name="reference_sequence" value="test_ref" />
            </conditional>
            <param name="input_bam" value="split_input.bam" />
            <conditional name="ival_type">
                <param name="ival_type_sel" value="ival_file" />
                <param name="intervals" value="split_interval.interval_list" />
            </conditional>
            <output name="output_bam" file="split_expected.bam" compare="sim_size" delta="200" />
        </test>
    </tests>

    <help><![CDATA[
        **SplitNCigarReads**

        This tool splits reads that contain Ns in their CIGAR string (e.g., spanning introns in RNA-seq data). It identifies Ns in the CIGAR string and splits the read into two or more supplementary alignments.

        **Why is this necessary?**

        This is a required preprocessing step for RNA-seq variant calling with GATK HaplotypeCaller. It reduces false positives caused by splicing artifacts.

        **Input Requirements**

        * **Input BAM:** Must be aligned and indexed.
        * **Reference:** FASTA format (local or history).

        **More Information**

        For detailed documentation, please visit the `GATK Tool Documentation <https://gatk.broadinstitute.org/hc/en-us/articles/360037593931-SplitNCigarReads>`_.
    ]]></help>

    <citations>
        <expand macro="citations" />
    </citations>
</tool>