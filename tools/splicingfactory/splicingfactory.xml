<tool id='splicingfactory' name='SplicingFactory' version='@TOOL_VERSION@+galaxy@SUFFIX_VERSION@'>
  <description>Calculate splicing diversity</description>
  <macros>
      <import>macros.xml</import>
  </macros>
  <expand macro='xrefs'/>
  <expand macro='requirements'/>

  <command detect_errors='exit_code'><![CDATA[
Rscript '${__tool_directory__}/splicingfactory_calc.R'
  --input '$input'
  --input_type 'auto'
  #if $tx2gene
    --tx2gene '$tx2gene' 
  #end if
  --method '$method'
  --norm '$norm'
  --tpm '$tpm'
  #if $plotting.generate_plots
    --plot_dir '.'
    --plot_format '$plotting.plot_format'
    #if $plotting.group_column and $plotting.group_column != ''
    --group_column '$plotting.group_column'
    #end if
  #end if
  --out_div './diversity.tsv'
  --out_se './diversity_se.rds'
  --session_out './session.txt'
]]></command>

  <inputs>
    <param name='input' type='data' format='rds,tsv' label='Transcript expression matrix (TSV) or SummarizedExperiment/tximport (RDS)'>
      <help>Rows should be transcript IDs (first column as rownames), columns samples. Alternatively, provide an RDS containing a SummarizedExperiment or a tximport list.</help>
    </param>
    <param name='tx2gene' type='data' format='tabular' optional='true' label='Transcript to gene mapping (TSV)'>
      <help>Two-column TSV: transcript_id	gene_id (no header). Required when input is a transcript-level matrix or tximport list.</help>
    </param>
    <param name='method' type='select' label='Diversity method'>
      <option value='laplace'>Laplace entropy (default)</option>
      <option value='naive'>Naive entropy</option>
      <option value='gini'>Gini index</option>
      <option value='simpson'>Simpson index</option>
      <option value='invsimpson'>Inverse Simpson index</option>
    </param>
    <param name='norm' type='boolean' truevalue='True' falsevalue='False' checked='True' label='Normalize entropy?' />
    <param name='tpm' type='boolean' truevalue='True' falsevalue='False' checked='False' label='Input is TPM (use abundance from tximport)?' />
  <section name='plotting' title='Plotting options' expanded='false'>
      <param name='generate_plots' type='boolean' checked='false' label='Generate ggplot figures (density, boxplot, heatmap)?' />
      <param name='plot_format' type='select' label='Plot image format'>
        <option value='png' selected='true'>PNG</option>
        <option value='pdf'>PDF</option>
      </param>
      <param name='group_column' type='text' optional='true' label='Group column in colData for boxplot' help='Name of a column in colData(res_se) to group samples (e.g., Condition)' />
    </section>
    <param name='output_summarizedExperiment_RDS' type='boolean' truevalue='True' falsevalue='False' checked='false' label='Output SummarizedExperiment (RDS)?'/>
  </inputs>


  <outputs>
    <data name='diversity' format='tabular' from_work_dir='diversity.tsv' label='Diversity table (TSV)' />
    <data name='se' format='rds' from_work_dir='diversity_se.rds' label='Diversity SummarizedExperiment (RDS)'>
      <filter>output_summarizedExperiment_RDS</filter>
    </data>
    <!-- Optional plot outputs -->
    <data name='plot_density' format='png' from_work_dir='diversity_density.png' label='Diversity density plot'>
      <filter>plotting['generate_plots'] and plotting['plot_format'] == 'png'</filter>
    </data>
    <data name='plot_density_pdf' format='pdf' from_work_dir='diversity_density.pdf' label='Diversity density plot (PDF)'>
      <filter>plotting['generate_plots'] and plotting['plot_format'] == 'pdf'</filter>
    </data>

    <data name='plot_boxplot' format='png' from_work_dir='diversity_boxplot.png' label='Diversity boxplot'>
      <filter>plotting['generate_plots'] and plotting['plot_format'] == 'png'</filter>
    </data>
    <data name='plot_boxplot_pdf' format='pdf' from_work_dir='diversity_boxplot.pdf' label='Diversity boxplot (PDF)'>
      <filter>plotting['generate_plots'] and plotting['plot_format'] == 'pdf'</filter>
    </data>

    <data name='plot_heatmap' format='png' from_work_dir='diversity_heatmap.png' label='Diversity heatmap'>
      <filter>plotting['generate_plots'] and plotting['plot_format'] == 'png'</filter>
    </data>
    <data name='plot_heatmap_pdf' format='pdf' from_work_dir='diversity_heatmap.pdf' label='Diversity heatmap (PDF)'>
      <filter>plotting['generate_plots'] and plotting['plot_format'] == 'pdf'</filter>
    </data>
  </outputs>

  <tests>
    <!-- Basic test on TSV matrix input with laplace method and normalization -->
    <test expect_num_outputs='2'>
      <param name='input' value='transcripts.tsv' ftype='tabular' />
      <param name='tx2gene' value='tx2gene.tsv' ftype='tabular' />
      <param name='method' value='laplace' />
      <param name='norm' value='True' />
      <param name='tpm' value='False' />
      <pamra name='output_summarizedExperiment_RDS' value='True' />
      <output name='diversity' file='expected_diversity_01.tsv' compare='diff' />
      <output name='se'>
        <assert_contents>
          <has_size value='450' delta='30' />
        </assert_contents>
      </output>

    </test>

    <!-- Test naive method -->
    <test expect_num_outputs='1'>
      <param name='input' value='transcripts.tsv' ftype='tabular' />
      <param name='tx2gene' value='tx2gene.tsv' ftype='tabular' />
      <param name='method' value='naive' />

      <output name='diversity' file='expected_diversity_02.tsv' compare='diff' />
    </test>

    <!-- Test naive method -->
    <test expect_num_outputs='1'>
      <param name='input' value='transcripts.tsv' ftype='tabular' />
      <param name='tx2gene' value='tx2gene.tsv' ftype='tabular' />
      <param name='method' value='gini' />
      <output name='diversity' file='expected_diversity_03.tsv' compare='diff' />
    </test>

        <!-- Test naive method -->
    <test expect_num_outputs='1'>
      <param name='input' value='transcripts.tsv' ftype='tabular' />
      <param name='tx2gene' value='tx2gene.tsv' ftype='tabular' />
      <param name='method' value='simpson'/>
      <output name='diversity' file='expected_diversity_05.tsv' compare='diff' />
    </test>

            <!-- Plotting enabled: verify plot files are produced (PNG) -->
    <test expect_num_outputs='6'>
      <param name='input' value='transcripts.tsv' ftype='tabular' />
      <param name='tx2gene' value='tx2gene.tsv' ftype='tabular' />
      <param name='method' value='laplace' />
      <param name='norm' value='True' />
      <param name='tpm' value='False' />
      <section name='plotting'>
        <param name='generate_plots' value='true' />
        <param name='plot_format' value='png' />
      </section>
      <output name='plot_density' ftype='png'>
        <assert_contents>
          <has_size value='8795' delta='300'/>
        </assert_contents>
      </output>
      <output name='plot_boxplot' ftype='png'>
        <assert_contents>
          <has_size value='8795' delta='300' />
        </assert_contents>
      </output>
      <output name='plot_heatmap' ftype='png'>
        <assert_contents>
          <has_size value='18182' delta='300' />
        </assert_contents>
      </output>
    </test>

  </tests>

  <help><![CDATA[

.. class:: infomark
  
**SplicingFactory** is an R package designed for analyzing alternative splicing isoform diversity in RNA-seq data. It offers several metrics that quantify splicing diversity, helping to identify significant changes between different samples or conditions.

-----

.. class:: infomark

**Metrics Used in SplicingFactory**

- **Shannon Entropy**: it measures the uncertainty involved in predicting the identity of a randomly chosen isoform. Values range from 0 (one isoform present) to 1 (equal expression across all isoforms). Higher values indicate greater diversity and uncertainty. This metric is particularly useful for understanding the richness and evenness of isoform expression, providing insight into the complexity of splicing patterns in given conditions.
- **Laplace Entropy**: it refines Shannon entropy by adding a pseudo-count (typically 1) to each isoform, addressing the issue of zero counts for low-abundance isoforms. This adjustment makes it especially effective in datasets with many low counts, providing a more reliable estimate of diversity. Laplace entropy is beneficial when comparing samples with different sequencing depths or when few isoforms are expressed.
- **Gini Index**: it assesses the inequality in expression levels among isoforms, ranging from 0 (perfect equality) to 1 (complete inequality). A high Gini index suggests that a few isoforms dominate expression levels, whereas a low Gini index points to a more balanced distribution among many isoforms. The Gini index is instrumental in identifying which isoforms are primarily responsible for observed expression patterns, helping to highlight biologically significant players.
- **Simpson Index**: it evaluates the probability that two randomly selected isoforms belong to different categories or classes. Values range from 0 (no diversity) to 1 (maximum diversity). Lower values suggest dominance by a few isoforms, while higher values reflect a more evenly distributed population. The Simpson index is particularly useful for studies focused on biodiversity within tissues or conditions, as it accounts for both evenness and richness.
- **Inverse Simpson Index**: it is the reciprocal of the Simpson index and provides an intuitive understanding of diversity. It starts at 1 (indicating low diversity), and higher values suggest greater isoform diversity. This metric is straightforward to interpret, making it easier for researchers to communicate findings related to isoform variety.

-----

.. class:: infomark

**Practical Applications**

These metrics collectively help analyze RNA-seq data:
- **Shannon and Laplace Entropy**: Assess overall diversity, particularly in comparative studies, to reveal shifts in splicing under different conditions or treatments.
- **Gini Index**: Identify dominant isoforms and glean insights into biological significance, guiding further functional studies on these key isoforms.
- **Simpson and Inverse Simpson Index**: Emphasize the variety of isoforms present in samples, aiding in understanding the complexity and dynamics of alternative splicing.

-----

.. class:: infomark

**Inputs**

- Transcript expression matrix (TSV) with transcript IDs as row names and samples as columns.
- Transcript-to-gene mapping TSV with two columns: transcript and gene.

-----

.. class:: infomark

**Outputs**

- `diversity.tsv`: gene x sample diversity values.
- `diversity_se.rds`: `SummarizedExperiment` R object containing diversity assay.
- `session.txt`: `sessionInfo()` for debugging.

-----

.. class:: infomark

**Optional Plots (when enabled)**

- `diversity_density.(png|pdf)`: Visual representation of the density distribution of diversity metrics, facilitating comparison between samples.
- `diversity_boxplot.(png|pdf)`: Boxplots illustrating diversity across samples, highlighting potential outliers and variations.
- `diversity_heatmap.(png|pdf)`: Heatmap showing diversity values across samples and genes, allowing for quick visual assessment of isoform expression patterns.

  ]]></help>
  <expand macro='citations' />
</tool>
