<tool id="splicingfactory" name="SplicingFactory" version="@TOOL_VERSION@+galaxy@SUFFIX_VERSION@">
  <description>Calculate splicing diversity</description>
  <macros>
      <import>macros.xml</import>
  </macros>
  <expand macro='xrefs'/>
  <expand macro='requirements'/>

  <command detect_errors="exit_code"><![CDATA[
Rscript '${__tool_directory__}/splicingfactory_calc.R' --input '$input' --input_type 'auto' \
#if $tx2gene
  --tx2gene '$tx2gene' \
#end if
--method '$method' --norm '$norm' --tpm '$tpm' \
#if $plotting.generate_plots
  --plot_dir '.' --plot_format '$plotting.plot_format' \
  #if $plotting.group_column and $plotting.group_column != ''
    --group_column '$plotting.group_column' \
  #end if
#end if
--out_div diversity.tsv --out_se diversity_se.rds --session_out session.txt
]]></command>

  <inputs>
    <param name="input" type="data" format="tabular,rds" label="Transcript expression matrix (TSV) or SummarizedExperiment/tximport (RDS)">
      <help>Rows should be transcript IDs (first column as rownames), columns samples. Alternatively, provide an RDS containing a SummarizedExperiment or a tximport list.</help>
    </param>
    <param name="tx2gene" type="data" format="tabular" optional="true" label="Transcript to gene mapping (TSV)">
      <help>Two-column TSV: transcript_id	gene_id (no header). Required when input is a transcript-level matrix or tximport list.</help>
    </param>
    <param name="method" type="select" label="Diversity method">
      <option value="laplace">Laplace entropy (default)</option>
      <option value="naive">Naive entropy</option>
      <option value="gini">Gini index</option>
      <option value="simpson">Simpson index</option>
      <option value="invsimpson">Inverse Simpson index</option>
    </param>
    <param name="norm" type="boolean" truevalue="True" falsevalue="False" checked="True" label="Normalize entropy?" />
    <param name="tpm" type="boolean" truevalue="True" falsevalue="False" checked="False" label="Input is TPM (use abundance from tximport)?" />
  <section name="plotting" title="Plotting options" expanded="false">
      <param name="generate_plots" type="boolean" checked="false" label="Generate ggplot figures (density, boxplot, heatmap)?" />
      <param name="plot_format" type="select" label="Plot image format">
        <option value="png" selected="true">PNG</option>
        <option value="pdf">PDF</option>
      </param>
      <param name="group_column" type="text" optional="true" label="Group column in colData for boxplot" help="Name of a column in colData(res_se) to group samples (e.g., Condition)" />
    </section>
  </inputs>


  <outputs>
    <data name="diversity" format="tabular" from_work_dir="diversity.tsv" label="Diversity table (TSV)" />
    <data name="se" format="rds" from_work_dir="diversity_se.rds" label="Diversity SummarizedExperiment (RDS)" />
    <data name="session_info" format="txt" from_work_dir="session.txt" label="R session info (txt)" />

    <!-- Optional plot outputs -->
    <data name="plot_density" format="png" from_work_dir="diversity_density.png" label="Diversity density plot">
      <filter>plotting['generate_plots'] and plotting['plot_format'] == "png"</filter>
    </data>
    <data name="plot_density_pdf" format="pdf" from_work_dir="diversity_density.pdf" label="Diversity density plot (PDF)">
      <filter>plotting['generate_plots'] and plotting['plot_format'] == "pdf"</filter>
    </data>

    <data name="plot_boxplot" format="png" from_work_dir="diversity_boxplot.png" label="Diversity boxplot">
      <filter>plotting['generate_plots'] and plotting['plot_format'] == "png"</filter>
    </data>
    <data name="plot_boxplot_pdf" format="pdf" from_work_dir="diversity_boxplot.pdf" label="Diversity boxplot (PDF)">
      <filter>plotting['generate_plots'] and plotting['plot_format'] == "pdf"</filter>
    </data>

    <data name="plot_heatmap" format="png" from_work_dir="diversity_heatmap.png" label="Diversity heatmap">
      <filter>plotting['generate_plots'] and plotting['plot_format'] == "png"</filter>
    </data>
    <data name="plot_heatmap_pdf" format="pdf" from_work_dir="diversity_heatmap.pdf" label="Diversity heatmap (PDF)">
      <filter>plotting['generate_plots'] and plotting['plot_format'] == "pdf"</filter>
    </data>
  </outputs>

  <tests>
    <!-- Basic test on TSV matrix input with laplace method and normalization -->
    <test expect_num_outputs="3">
      <param name="input" value="transcripts.tsv" ftype="tabular" />
      <param name="tx2gene" value="tx2gene.tsv" ftype="tabular" />
      <param name="method" value="laplace" />
      <param name="norm" value="True" />
      <param name="tpm" value="False" />
      <output name="diversity" file="expected_diversity.tsv" compare="diff" />
      <output name="se">
        <assert_contents>
          <has_size value="0" negate="true" />
        </assert_contents>
      </output>
      <output name="session_info">
        <assert_contents>
          <has_text text="R version" />
        </assert_contents>
      </output>
    </test>

    <!-- Variant test toggling method and turning off normalization -->
    <test expect_num_outputs="3">
      <param name="input" value="transcripts.tsv" ftype="tabular" />
      <param name="tx2gene" value="tx2gene.tsv" ftype="tabular" />
      <param name="method" value="naive" />
      <param name="norm" value="False" />
      <param name="tpm" value="False" />
      <!-- Just check output headers and shape are sensible without asserting full values -->
      <output name="diversity">
        <assert_contents>
          <has_text text="Gene" />
        </assert_contents>
      </output>
      <output name="se">
        <assert_contents>
          <has_size value="0" negate="true" />
        </assert_contents>
      </output>
      <output name="session_info">
        <assert_contents>
          <has_text text="SplicingFactory wrapper run" />
        </assert_contents>
      </output>
    </test>

    <!-- Version check to ensure the wrapper reports a version -->
    <test expect_num_outputs="0">
      <param name="input" value="transcripts.tsv" ftype="tabular" />
      <param name="tx2gene" value="tx2gene.tsv" ftype="tabular" />
      <param name="method" value="laplace" />
      <param name="norm" value="True" />
      <param name="tpm" value="False" />
      <assert_command>
        <has_text text="SplicingFactory" />
      </assert_command>
    </test>

  <!-- Additional test: check specific values for a tiny dataset (first data row) -->
    <test expect_num_outputs="3">
      <param name="input" value="transcripts.tsv" ftype="tabular" />
      <param name="tx2gene" value="tx2gene.tsv" ftype="tabular" />
      <param name="method" value="laplace" />
      <param name="norm" value="True" />
      <output name="diversity">
        <assert_contents>
          <!-- Header columns should be Gene, Sample1, Sample2 -->
          <has_text text="Gene	Sample1	Sample2" />
          <!-- First data row should start with GeneA and contain two numeric values -->
          <has_line_matching expression="^GeneA	[0-9\.eE\-]+\t[0-9\.eE\-]+$" />
        </assert_contents>
      </output>
    </test>

    <!-- Additional method test: gini index with normalization on -->
    <test expect_num_outputs="3">
      <param name="input" value="transcripts.tsv" ftype="tabular" />
      <param name="tx2gene" value="tx2gene.tsv" ftype="tabular" />
      <param name="method" value="gini" />
      <param name="norm" value="True" />
      <output name="diversity">
        <assert_contents>
          <!-- Ensure output has expected header and row count (2 lines: header + 1 row) -->
          <has_text text="Gene	Sample1	Sample2" />
          <has_n_lines n="2" />
        </assert_contents>
      </output>
    </test>

            <!-- Plotting enabled: verify plot files are produced (PNG) -->
    <test expect_num_outputs="6">
      <param name="input" value="transcripts.tsv" ftype="tabular" />
      <param name="tx2gene" value="tx2gene.tsv" ftype="tabular" />
      <param name="method" value="laplace" />
      <param name="norm" value="True" />
      <param name="tpm" value="False" />
      <section name="plotting">
        <param name="generate_plots" value="true" />
        <param name="plot_format" value="png" />
      </section>
      <output name="plot_density">
        <assert_contents>
          <has_size value="0" negate="true" />
        </assert_contents>
      </output>
      <output name="plot_boxplot">
        <assert_contents>
          <has_size value="0" negate="true" />
        </assert_contents>
      </output>
      <output name="plot_heatmap">
        <assert_contents>
          <has_size value="0" negate="true" />
        </assert_contents>
      </output>
    </test>

  </tests>

  <help>
  
## Technical Information on SplicingFactory Tool

**SplicingFactory** is an R package designed for analyzing alternative splicing isoform diversity in RNA-seq data. It offers several metrics that quantify splicing diversity, helping to identify significant changes between different samples or conditions.

### Metrics Used in SplicingFactory


**Shannon Entropy**

Shannon entropy measures the uncertainty involved in predicting the identity of a randomly chosen isoform. Values range from 0 (one isoform present) to 1 (equal expression across all isoforms). Higher values indicate greater diversity and uncertainty.

**Laplace Entropy**

Laplace entropy refines Shannon entropy by adding a pseudo-count (typically 1) to each isoform. It is especially effective in handling low-abundance isoforms, providing a robust estimate of diversity in datasets with many low counts.

**Gini Index**

The Gini index assesses the inequality in expression levels among isoforms. It ranges from 0 (perfect equality) to 1 (complete inequality). A high value suggests that a few isoforms dominate expression, while a low value indicates a more balanced distribution.

**Simpson Index**

This index evaluates the probability that two randomly selected isoforms belong to different categories. Values range from 0 (no diversity) to 1 (maximum diversity). Lower values suggest dominance by a few isoforms, while higher values reflect a more evenly distributed population.

**Inverse Simpson Index**

The inverse Simpson index provides an intuitive understanding of diversity by being the reciprocal of the Simpson index. It starts at 1 (low diversity) and higher values indicate greater isoform diversity, making interpretation easier.

### Practical Applications

These metrics collectively help analyze RNA-seq data:
- Shannon and Laplace Entropy: Assess overall diversity, particularly in comparative studies.
- Gini Index: Identify dominant isoforms and glean insights into biological significance.
- Simpson and Inverse Simpson Index: Emphasize the variety of isoforms present in samples.


Inputs:
- Transcript expression matrix (TSV) with transcript IDs as row names and samples as columns.
- Transcript-to-gene mapping TSV with two columns: transcript and gene.

Outputs:
- `diversity.tsv`: gene x sample diversity values.
- `diversity_se.rds`: `SummarizedExperiment` R object containing diversity assay.
- `session.txt`: `sessionInfo()` for debugging.

Optional plots (when enabled):
- `diversity_density.(png|pdf)`
- `diversity_boxplot.(png|pdf)`
- `diversity_heatmap.(png|pdf)`


  </help>

  <expand macro="citations" />

</tool>
