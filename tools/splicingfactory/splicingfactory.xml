<?xml version="1.0"?>
<tool id="splicingfactory" name="SplicingFactory: Splicing Diversity Analysis" version="1.0.0">
  <description>Calculate splicing diversity using the SplicingFactory R package</description>

  <requirements>
    <requirement type="package" version="1.18.0">r-splicingfactory</requirement>
    <requirement type="package" version="1.8.0">bioconductor-summarizedexperiment</requirement>
    <requirement type="package" version="1.7.5">r-optparse</requirement>
  </requirements>



  <version_command><![CDATA[
Rscript -e "cat(as.character(utils::packageVersion('SplicingFactory')))"
]]></version_command>

  <command><![CDATA[
Rscript '${__tool_directory__}/splicingfactory_calc.R' --input '$input' --input_type 'auto' --tx2gene '$tx2gene' --method '$method' --norm '$norm' --tpm '$tpm' --out_div diversity.tsv --out_se diversity_se.rds --session_out session.txt
]]></command>

  <inputs>
    <param name="input" type="data" format="tabular" label="Transcript expression matrix (TSV)">
      <help>Rows should be transcript IDs (first column as rownames), columns samples.</help>
    </param>
    <param name="tx2gene" type="data" format="tabular" label="Transcript to gene mapping (TSV)">
      <help>Two-column TSV: transcript_id\tgene_id (no header).</help>
    </param>
    <param name="method" type="select" label="Diversity method">
      <option value="laplace">Laplace entropy (default)</option>
      <option value="naive">Naive entropy</option>
      <option value="gini">Gini index</option>
      <option value="simpson">Simpson index</option>
      <option value="invsimpson">Inverse Simpson index</option>
    </param>
    <param name="norm" type="boolean" truevalue="True" falsevalue="False" checked="True" label="Normalize entropy?" />
    <param name="tpm" type="boolean" truevalue="True" falsevalue="False" checked="False" label="Input is TPM (use abundance from tximport)?" />
  </inputs>


  <outputs>
    <data name="diversity" format="tabular" label="Diversity table (TSV)" />
    <data name="se" format="rds" label="Diversity SummarizedExperiment (RDS)" />
    <data name="session_info" format="txt" label="R session info (txt)" />
  </outputs>

  <tests>
    <test expect_num_outputs="3">
      <param name="input" value="test-data/transcripts.tsv" ftype="tabular" />
      <param name="tx2gene" value="test-data/tx2gene.tsv" ftype="tabular" />
      <param name="method" value="laplace" />
      <output name="diversity" file="test-data/expected_diversity.tsv" />
    </test>

  </tests>

  <help>
Calculate gene-level splicing diversity from transcript-level expression values using SplicingFactory::calculate_diversity.

Inputs:
- Transcript expression matrix (TSV) with transcript IDs as row names and samples as columns.
- Transcript-to-gene mapping TSV with two columns: transcript and gene.

Outputs:
- `diversity.tsv`: gene x sample diversity values.
- `diversity_se.rds`: `SummarizedExperiment` R object containing diversity assay.
- `session.txt`: `sessionInfo()` for debugging.
  </help>

  <citations>
    <citation type="doi">10.1038/s41587-020-0529-4</citation>
  </citations>

</tool>
