<tool id="bg_diamond_makedb" name="Diamond makedb" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="23.2" license="GPL-3.0">
    <description>build database from a FASTA file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command detect_errors="aggressive">
        <!-- DB has two files, *.dmnd and *.tx -->
    <![CDATA[
    ln -s '$infile' database.$infile.ext &&

    diamond makedb
        --threads \${GALAXY_SLOTS:-12}
        --in database.$infile.ext
        --db ./database

      #if $tax_cond.tax_select == 'yes':
        --taxonmap '$tax_cond.taxonmap'
        --taxonnodes '$tax_cond.taxonnodes'
        --taxonnames '$tax_cond.taxonnames'
      #else if $tax_cond.tax_select == 'yes_cached':
        --taxonmap '$tax_cond.ncbi_taxonomy.fields.path'/prot.accession2taxid
        --taxonnodes '$tax_cond.ncbi_taxonomy.fields.path'/nodes.dmp
        --taxonnames '$tax_cond.ncbi_taxonomy.fields.path'/names.dmp
      #end if
    ]]>
    </command>
    <inputs>
        <param name="infile" type="data" format="fasta,fasta.gz" label="Input reference file in FASTA format"/>
        <conditional name="tax_cond">
            <param name="tax_select" type="select" label="Add taxonomic data?" help="Needs to be supplied in order to provide taxonomy features of the aligner">
                <option value="yes_cached">Using built in NCBI taxonomy</option>
                <option value="yes">Yes using datasets from history</option>
                <option value="no" selected="true">No</option>
            </param>
            <when value="yes">
                <param argument="--taxonmap" type="data" format="tabular" label="Protein accession to taxid mapping file" help="Path to mapping file that maps NCBI protein accession numbers to taxon ids (gzip compressed). This parameter is optional and needs to be supplied in order to provide taxonomy features.                A custom file following the same format may be supplied here. Note that the first line of this file is assumed to contain headings and will be ignored"/>
                <param argument="--taxonnodes" type="data" format="tabular" label="Taxonomy nodes.dmp from NCBI" help="This parameter is optional and needs to be supplied in order to provide taxonomy features"/>
                <param argument="--taxonnames" type="data" format="tabular" label="Taxonomy names.dmp from NCBI" help="This parameter is optional and needs to be supplied in order to provide taxonomy features"/>
            </when>
            <when value="yes_cached">
                <param name="ncbi_taxonomy" type="select" optional="true" label="NCBI taxonomy database" help="Needed for output of taxonomy columns in tabular output">
                    <options from_data_table="ncbi_taxonomy">
                        <validator message="No NCBI database is available. Ask your Galaxy adin" type="no_options"/>
                    </options>
                </param>
            </when>
            <when value="no"/>
        </conditional>
    </inputs>
    <outputs>
        <data format="dmnd" name="outfile" from_work_dir="database.dmnd" label="${tool.name} on ${on_string}"/>
    </outputs>
    <tests>
        <test>
            <param name="infile" value="db.fasta" ftype="fasta"/>
            <output name="outfile" value="db.dmnd" compare="sim_size" delta="2"/>
            <assert_stderr>
                <has_text_matching expression="Database sequences +5"/>
                <has_text_matching expression="Database letters +2578"/>
            </assert_stderr>
        </test>
        <test>
            <param name="infile" value="db.fasta.gz" ftype="fasta.gz"/>
            <output name="outfile" value="db.dmnd" compare="sim_size" delta="2"/>
            <assert_stderr>
                <has_text_matching expression="Database sequences +5"/>
                <has_text_matching expression="Database letters +2578"/>
            </assert_stderr>
        </test>
        <test>
            <param name="infile" value="db.fasta" ftype="fasta"/>
            <conditional name="tax_cond">
                <param name="tax_select" value="yes"/>
                <param name="taxonmap" ftype="tabular" value="prot.accession2taxid"/>
                <param name="taxonnodes" ftype="tabular" value="nodes.dmp"/>
                <param name="taxonnames" ftype="tabular" value="names.dmp"/>
            </conditional>
            <!-- this test uses a taxdb with consecutive taxIDs which creates the small dmnd test file -->
            <output name="outfile" value="db-wtax.dmnd" compare="sim_size" delta="2"/>
            <assert_stderr>
                <has_text_matching expression="Entries in accession to taxid file +5"/>
                <has_text_matching expression="Database accessions mapped to taxid +5"/>
                <has_text_matching expression="Database sequences mapped to taxid +5"/>
            </assert_stderr>
        </test>
        <test>
            <param name="infile" value="db.fasta" ftype="fasta"/>
            <conditional name="tax_cond">
                <param name="tax_select" value="yes_cached"/>
                <param name="ncbi_taxonomy" value="test"/>
            </conditional>
            <!-- note that this test uses a different taxDB (original taxIDs - not consecutive)
                 and therefore we get a larger dmnd file -->
            <output name="outfile">
                <assert_contents>
                    <has_size size="20279226"/>
                </assert_contents>
            </output>
            <assert_stderr>
                <has_text_matching expression="Entries in accession to taxid file +5"/>
                <has_text_matching expression="Database accessions mapped to taxid +5"/>
                <has_text_matching expression="Database sequences mapped to taxid +5"/>
            </assert_stderr>
        </test>
    </tests>
    <help>
<![CDATA[

.. class:: infomark

**What it does**

DIAMOND_ is a new alignment tool for aligning short DNA sequencing reads to a protein reference database such as NCBI-NR.
On Illumina reads of length 100-150bp, in fast mode, DIAMOND is about 20,000 times faster than BLASTX, while reporting
about 80-90% of all matches that BLASTX finds, with an e-value of at most 1e-5. In sensitive mode, DIAMOND is about 2,500
times faster than BLASTX, finding more than 94% of all matches.

.. _DIAMOND: http://ab.inf.uni-tuebingen.de/software/diamond/


- taxonmap: Path to mapping file that maps NCBI protein accession numbers to taxon ids (gzip compressed). This parameter is optional and needs to be supplied in order to provide taxonomy features. The file can be downloaded from NCBI: ftp://ftp.ncbi.nlm.nih.gov/pub/taxonomy/accession2taxid/prot.accession2taxid.gz

- taxonnames: Path to the names.dmp file from the NCBI taxonomy. This parameter is optional and needs to be supplied in order to provide taxonomy features. The file is contained within this archive downloadable at NCBI: ftp.ncbi.nlm.nih.gov/pub/taxonomy/taxdmp.zip

- taxonnodes: Path to the nodes.dmp file from the NCBI taxonomy. This parameter is optional and needs to be supplied in order to provide taxonomy features. The file is contained within this archive downloadable at NCBI: ftp.ncbi.nlm.nih.gov/pub/taxonomy/taxdmp.zip
]]>
    </help>
    <expand macro="citations"/>
</tool>
