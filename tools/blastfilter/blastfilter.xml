<tool id="blastfilter" name="blastfilter" version="0.1.0+galaxy0" python_template_version="3.5" profile="23.1">
    <description></description>
    <requirements>
        <requirement type="package" version="3.8">python</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
python3 '$__tool_directory__/blastfilter.py'
    -i '$input'
    -o '$output'
    -p $pident
    -l $length
    -pid $pid
    -covs $covs
    -covq $covq
    -t '$blast_type'
    -outfmt '$outfmt'
    ]]></command>
   <inputs>
        <param name="input" type="data" format="tabular" label="BLAST tabular output file"/>
        <param name="pident" type="float" value="30" label="Percent identity cutoff"/>
        <param name="length" type="float" value="80" label="Alignment length cutoff"/>
        <param name="pid" type="select" label="Pident method" help="Choose how percent identity threshold is applied.">
            <option value="static" selected="true">Filter using fixed percent identity and alignment length thresholds</option>
            <option value="rost1999">Rost 1999 â€“ Adaptive cutoff based on alignment length ('twilight zone' aware)</option>
        </param>
        <param name="covs" type="float" value="0.0" label="Coverage threshold on subject (covs = length/slen)"/>
        <param name="covq" type="float" value="0.0" label="Coverage threshold on query (covq = length/qlen)"/>
        <param name="blast_type" type="select" label="BLAST type used to generate input">
            <option value="blastp" selected="true">blastp</option>
            <option value="blastn">blastn</option>
            <option value="blastx">blastx</option>
            <option value="tblastn">tblastn</option>
            <option value="tblastx">tblastx</option>
        </param>
        <param name="outfmt" type="select" label="BLAST output format used">
            <option value="std" selected="true">std</option>
            <option value="raw">raw</option>
            <option value="rbhplus">rbhplus</option>
        </param>
    </inputs>
    <outputs>
        <data name="output" format="tabular" label="Filtered BLAST output"/>
    </outputs>

    <tests>
        <test>
        <param name="input" value="blastp.tab"/>
        <param name="pident" value="40"/>
        <param name="length" value="100"/>
        <param name="pid" value="static"/>
        <param name="covs" value="0.0"/>
        <param name="covq" value="0.0"/>
        <param name="blast_type" value="blastp"/>
        <param name="outfmt" value="std"/>
        <output name="output" file="blastp.tab.filter"/>
        </test>
    </tests>
    <help><![CDATA[
    This tool filters BLAST tabular output files using identity percentage, alignment length, and optional coverage criteria on query and subject.

### Parameters:
- **Percent identity cutoff**: Minimum % identity for hits to be retained.
- **Alignment length cutoff**: Minimum alignment length.
- **Pident method**: Choose between static threshold or dynamic threshold based on the Rost 1999 function.
- **Coverage thresholds**: Define the minimum thresholds of the query or subject sequence that must be covered.
- **BLAST type**: Helps interpret the input file (in aa or bp).
- **BLAST output format**: The column structure of the input file.

### Percent Identity Filtering Methods

- **Static**: Uses a fixed percent identity threshold (e.g., 30%). Suitable when alignment lengths are relatively consistent.
- **Rost 1999**: Applies a dynamic threshold based on alignment length using the "twilight zone" model from Rost (1999). Shorter alignments must meet higher identity to be considered significant, preventing false positives.

### Output:
A filtered tabular file containing only alignments that meet the selected criteria.
    ]]></help>
    <citations>
        <citation type="doi">10.1186/s12859-019-2996-x</citation>
        <citation type="doi">10.1093/protein/12.2.85</citation>
    </citations>
</tool>

