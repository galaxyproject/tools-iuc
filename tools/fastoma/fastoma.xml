<tool id="fastoma" name="FastOMA" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" python_template_version="3.5" profile="21.05">
    <description>FastOMA is a scalable software package to infer orthology relationship.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <xrefs>
        <xref type="bio.tools">oma</xref>
    </xrefs>
    <requirements>
        <expand macro="requirements" />
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    mkdir -p input/proteome  &&

    #for $proteome in $proteomes: 
    ln -s    '$proteome' 'input/proteome/$proteome.element_identifier' &&
    #end for
    ln -s '$species_tree' input/species_tree.nwk 
    &&
    printf '%s\n' \
             'process {' \
             '  resourceLimits = [' \
             "    cpus: \${GALAXY_SLOTS}," \
             "    memory: \${GALAXY_MEMORY_MB:-16000}.MB," \
             '    time: 72.h' \
             '  ]' \
             '}' > galaxy.conf
    &&

    nextflow run dessimozlab/FastOMA -r dev -latest 
        -c galaxy.conf
        -ansi-log false 
        --input  input
        --output_folder results
        --omamer_db '$database.fields.path' 
    #if $report
        --report 
    #end if
    ]]></command>
    <inputs>
        <param name="proteomes" type="data" multiple="true" format="fasta" label="Protein sequences of proteome"/>
        <param name="species_tree" type="data" format="newick" label="Species tree in newick format" help="The species tree must contain all species present in the proteome files"/>
        <param name="database" label="OMAmer database" type="select">
            <options from_data_table="omamer"/>
        </param>
        <param argument="--report" type="boolean" truevalue="--report" falsevalue="" help="create a report on FastOMA run"/>
    </inputs>
    <outputs>
        <data format="xml" name="FastOMA_HOGs" label="Hierarchical Orthologous groups (HOGs) by ${tool.name}" from_work_dir="results/FastOMA_HOGs.orthoxml" />
        <data format="html" name="report_html" label="${tool.name} Report (HTML)" from_work_dir="results/report.html"><filter>report</filter></data>
        <data format="ipynb" name="report_jpynb" label="${tool.name} Report (Notebook)" from_work_dir="results/report.jpynb"><filter>report</filter></data>
        <data format="fasta" name="RootHOGsFasta" label="${tool.name} fasta files per root-level HOGs" from_work_dir="results/RootHOGsFasta/*.fa" />
        <data format="tsv" name="RootHOGsTSV" label="${tool.name} protein assignments to RootHOGs" from_work_dir="results/RootHOGs.tsv" />
    </outputs>
    <tests>
        <test expect_num_outputs="5">
            <param name="proteomes" value="test-proteomes/AQUAE.fa,test-proteomes/CHLTR.fa,test-proteomes/MYCGE.fa"/>
            <param name="species_tree" value="species_tree.nwk" ftype="newick"/>
            <param name="database" value="test"/>
            <param name="report" value="true"/>
            <output name="FastOMA_HOGs">
                <assert_contents>
                    <is_valid_xml />
		    <has_text_matching expression="&lt;orthoXML .* origin=.FastOMA @TOOL_VERSION@" />
		    <has_text_matching expression="&lt;species " n="3" />
		    <has_size size="7053" delta="300" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
FastOMA is a software tool to infer orthology relationships among multiple species based on their proteomes.

The main output of FastOMA are Hierarchical Orthologous Groups (HOGs) in OrthoXML format, which represent 
groups of genes that have evolved from a common ancestor. These groups are hierarchically nested, 
reflecting the evolutionary relationships among the species. 

.. class:: warningmark
    The galaxy tool of FastOMA is not intended for large scale analysis. All steps are run on a single machine, 
    which usually is not suitable for large datasets. For large scale analysis, please use FastOMA directly 
    through Nextflow as described in the the documentation: https://github.com/dessimozlab/FastOMA

**Input data**
- Protein sequences of proteomes: Provide the protein sequences of the species in FASTA format. Each proteome should be in a separate file.

- Species tree in Newick format: Provide a species tree that includes all species present in the proteome files.

- OMAmer database: Select an OMAmer database from the available options. Usually it is benefitial to use the most comprehensive database available (e.g. LUCA). 

**Outputs**
- Hierarchical Orthologous groups (HOGs) by FastOMA: The main output file in OrthoXML format containing the inferred HOGs.

- FastOMA Report: An jupyter notebook and HTML report summarizing the results of the FastOMA run.

- FastOMA fasta files per root-level HOGs: FASTA files containing the sequences for each root-level HOG.

]]></help>
<expand macro="citation" />
</tool>
