<tool id="pirate" name="Pirate" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@" license="MIT">
    <description>Analysing the pangenomes of bacteria, from largely clonal to panmictic species with Pirate</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>

    <command detect_errors="exit_code"><![CDATA[
        mkdir out &&
        #import re, os
        #set input_directory = 'input_directory'
        mkdir $input_directory &&

        """
        See if this is needed for the input:
        #set $filename = '%s.gff' % re.sub('[^\w_-]', '_', str($gff.element_identifier))
                cp '$gff' '$input_directory/$filename' &&
        """
        PIRATE
            -i $input_directory/*.gff
            -o out
            --steps '$steps'
            --features '$features'
            $nucl
            --pan-opt '$pan_opt'
            $pan_off
            $para_off
            $align
            $rplots
            --threads '$threads'
            $quiet
            #if $z != 'None':
                    -z '$z'
                #end if
            $check
    ]]></command>

    <inputs>
        <!-- Global: -->
        <param argument="--steps" type="text" value="50,60,70,80,90,95,98" label="Identity thresholds to use for pangenome construction" help="Set a comma separated list of identity thresholds for the pangenome construction"/>
        <param argument="--features" type="text" value="CDS" label="Features to use for pangenome construction" help="Set a features for pangenome construction. Multiple may be entered, seperated by a comma"/>
        <param argument="--nucl" type="boolean" truevalue="--nucl" falsevalue="" label="CDS are not translated to AA sequence" help="Set a if CDS are not translated to AA sequences"/>
        <param argument="--pan-opt" type="text" value="" label="Additional arguments to pass to pangenome contruction" help="Set additional arguments to pass to pangenome_contruction"/>
        <param argument="--pan-off" type="boolean" truevalue="--pan-off" falsevalue="" label="Do not run pangenome tool" help="Assumes PIRATE has been previously run and resulting files are present in output folder"/>
        
        <!-- Paralog classification: -->
        <param argument="--para-off" type="boolean" truevalue="--para-off" falsevalue="" label="Switch off paralog identification" help="Switch paralog identification off"/>
        
        <!-- Output: -->
        <param argument="--align" type="boolean" truevalue="--align" falsevalue="" label="Align all genes and produce core/pangenome alignments" help="Decide for or against gene alignment to produce core/pangenome alignments"/>
        <param argument="--rplots" type="boolean" truevalue="--rplots" falsevalue="" label="Produce R plots" help="Plot summaries using R"/>
        
        <!-- Usage: -->
        <param argument="--threads" type="integer" value="2" label=" Number of threads/cores used" help="Set the number of threads/cores used by PIRATE"/>
        <param argument="--quiet" type="boolean" truevalue="--quiet" falsevalue="" label="Switch off verbose" help="Suppress output messages"/>
        <param argument="-z" type="select" label="Retain intermediate files" help= "0 = none, 1 = retain pangenome files, 2 = all">
            <option value="0">0</option>
            <option value="1" selected="True">1</option>
            <option value="2">2</option>
        </param>
        <param argument="--check" type="boolean" truevalue="--check" falsevalue="" label="Check installation" help="Check installation and run on example files"/>
    </inputs>

    <outputs>
        <!--17 Basic Pirate outputs -->
        <data format="fasta" name="binary_presence_absence" label="${tool.name} on ${on_string} : Binary Presence Absence" from_work_dir="out/binary_presence_absence.fasta"/>
        <data format="txt" name="binary_presence_absence_nwk" label="${tool.name} on ${on_string} : Binary Presence Absence Nwk" from_work_dir="out/binary_presence_absence.nwk"/>
        <data format="tabular" name="cluster_alleles" label="${tool.name} on ${on_string} : Cluster Alleles" from_work_dir="out/cluster_alleles.tab"/>
        <data format="txt" name="genome_list" label="${tool.name} on ${on_string} : Genome List" from_work_dir="out/genome_list.txt"/>
        <data format="tabular" name="genome2loci" label="${tool.name} on ${on_string} : Genome 2 Loci" from_work_dir="out/genome2loci.tab"/>
        <data format="txt" name="link_clusters" label="${tool.name} on ${on_string} : Link Clusters" from_work_dir="out/link_clusters.log"/>
        <data format="tabular" name="loci_list" label="${tool.name} on ${on_string} : Loci List" from_work_dir="out/loci_list.tab"/>
        <data format="tabular" name="loci_paralog_categories" label="${tool.name} on ${on_string} : Loci Paralog Categories" from_work_dir="out/loci_paralog_categories.tab"/>
        <data format="fasta" name="pan_sequences" label="${tool.name} on ${on_string} : Pan Sequences" from_work_dir="out/pan_sequences.fasta"/>
        <data format="txt" name="pangenome_log" label="${tool.name} on ${on_string} : Pangenome Log" from_work_dir="out/pangenome_log.txt"/>
        <data format="tabular" name="paralog_clusters" label="${tool.name} on ${on_string} : Paralog Clusters" from_work_dir="out/paralog_clusters.tab"/>
        <data format="tsv" name="PIRATE_gene_families" label="${tool.name} on ${on_string} : PIRATE Gene Families" from_work_dir="out/PIRATE.gene_families.tsv"/>
        <data format="tsv" name="PIRATE_genomes_per_allele" label="${tool.name} on ${on_string} : PIRATE Genomes Per Allele" from_work_dir="out/PIRATE.genomes_per_allele.tsv"/>
        <data format="txt" name="PIRATE_log" label="${tool.name} on ${on_string} : PIRATE Log" from_work_dir="out/PIRATE.log"/>
        <data format="txt" name="PIRATE_pangenome_summary" label="${tool.name} on ${on_string} : PIRATE Pangenome Summary" from_work_dir="out/PIRATE.pangenome_summary.txt"/>
        <data format="tsv" name="PIRATE_unique_alleles" label="${tool.name} on ${on_string} : PIRATE Unique Alleles" from_work_dir="out/PIRATE.unique_alleles.tsv"/>
        <data format="txt" name="split_groups" label="${tool.name} on ${on_string} : Split Groups Log" from_work_dir="out/split_groups.log"/>
    </outputs>

    <tests>
        <!--Test 01: -->
        <test expect_num_outputs="17">
            <param name="input_gff">
                <collection type="list">
                    <element name="GCA_021342655.1.gff" location="https://zenodo.org/records/16568442/files/GCA_021342655.1.gff"/>
                    <element name="GCA_021534865.1.gff" location="https://zenodo.org/records/16568442/files/GCA_021534865.1.gff"/>
                    <element name="GCA_021697815.1.gff" location="https://zenodo.org/records/16568442/files/GCA_021697815.1.gff"/>
                    <element name="GCA_021890555.1.gff" location="https://zenodo.org/records/16568442/files/GCA_021890555.1.gff"/>
                </collection>
            </param>

            <param name="table" value="10"/>
            <output name="annotated_clusters" ftype="json">
                <assert_contents>
                    <has_text text="GCA_021342655.1-NZ_JAJTPH010000093.1-5475-cds-WP_000557454.1"/>
                    <has_n_lines n="96508" delta='3'/>
                </assert_contents>
            </output>
        </test> 
    </tests>
    <help><![CDATA[

The pangenomics toolbox PIRATE identifies and classifies orthologous gene families in bacterial pangenomes over a wide range of sequence similarity thresholds. It builds upon recent scalable  software developments for the rapid interrogation of pangenomes. PIRATE clusters genes over a wide range of amino-acid or nucleotide identity thresholds, and classifies paralogous genes families into either putative gene fission/fusion events or gene duplications. Furthermore, PIRATE provides a measure of allelic variance and cluster homology, and orders the resulting pangenome on a pangenome graph.

**INPUTS**

- A collection of gff3 files. 

**OUTPUTS**

- binary_presence_absence.fasta
- binary_presence_absence.nwk
- cluster_alleles.tab
- genome_list.txt
- genome2loci.tab
- link_clusters.log
- loci_list.tab
- loci_paralog_categories.tab
- pan_sequences.fasta
- pangenome_log.txt
- paralog_clusters.tab
- PIRATE.gene_families.tsv
- PIRATE.genomes_per_allele.tsv
- PIRATE.log
- PIRATE.pangenome_summary.txt
- PIRATE.unique_alleles.tsv
- split_groups.log

    ]]></help>
    <citations>
        <citation type="doi">10.1093/gigascience/giz119</citation>
    </citations>
    <expand macro="creator"/>
</tool>
