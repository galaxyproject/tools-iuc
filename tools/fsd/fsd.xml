<?xml version="1.0" encoding="UTF-8"?>
<tool id="fsd" name="FSD:" version="1.0.0">
    <description>Family Size Distribution of duplex sequencing tags</description>
    <macros>
        <import>fsd_macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="2.7">python</requirement>
        <requirement type="package" version="1.4.0">matplotlib</requirement>
    </requirements>
    <command>
python '$__tool_directory__/fsd.py'
--inputFile1 '${file1}'
--inputName1 '${file1.element_identifier}'
#if str($file2) != 'None':
    --inputFile2 '${file2}'
    --inputName2 '${file2.element_identifier}'
#end if
#if str($file3) != 'None':
    --inputFile3 '${file3}'
    --inputName3 '${file3.element_identifier}'
#end if
#if str($file2) != 'None':
    --inputFile4 '${file4}'
    --inputName4 '${file4.element_identifier}'
#end if
$log_axis 
$rel_freq 
--output_pdf '$output_pdf'
--output_tabular '$output_tabular'
--inputFile2 '${file2}' --inputName2 '${file2.element_identifier}' --inputFile3 '${file3}' --inputName3 '${file3.element_identifier}' --inputFile4 '${file4}' --inputName4 '${file4.element_identifier}' $log_axis $rel_freq --output_pdf $output_pdf --output_tabular $output_tabular 
    </command>
    <inputs>
        <param name="file1" type="data" format="tabular" label="Input tags" optional="false"/>
        <param name="file2" type="data" format="tabular" label="Input tags (optional)" optional="true"  />
        <param name="file3" type="data" format="tabular" label="Input tags (optional)" optional="true" />
        <param name="file4" type="data" format="tabular" label="Input tags (optional)" optional="true"  help="This dataset is generated by post-processing of the output from 'Make Families' tool. See Help section below for an explanation."/>
        <param name="log_axis" type="boolean" label="Log scale for y axis?" truevalue="" falsevalue="--log_axis" checked="False" help="Transform y axis in log scale."/>
        <param name="rel_freq" type="boolean" label="Relative frequency?" truevalue="" falsevalue="--rel_freq" checked="False" help="If True (YES), the relative frequency to the total tags/families is plotted instead of the absolute numbers."/>
    </inputs>
    <outputs>
        <data name="output_pdf" format="pdf" label="${tool.name} on ${on_string}: PDF"/>
        <data name="output_tabular" format="tabular" label="${tool.name} on ${on_string}: Summary"/>
    </outputs>
    <tests>
        <test>
            <param name="file1" value="fsd_data1.tab"/>
            <param name="file2" value="fsd_data2.tab"/>
            <param name="file3" value="fsd_data3.tab"/>
            <param name="file4" value="fsd_data4.tab"/>
            <output name="output_pdf" file="fsd_output1.pdf" lines_diff="285"/>
            <output name="output_tabular" file="fsd_output1.tab"/>
        </test>
        <test>
            <param name="file1" value="fsd_data1.tab"/>
            <param name="file2" value="fsd_data2.tab"/>
            <param name="file3" value="fsd_data3.tab"/>
            <output name="output_pdf" file="fsd_output2.pdf" lines_diff="285"/>
            <output name="output_tabular" file="fsd_output2.tab"/>
        </test>
    </tests>
    <help><![CDATA[

**What it does**
        
This tool provides a computationally very fast insight into the distribution of the family sizes of ALL tags from a Duplex Sequencing experiment (DS) and gives a first assessment of the distribution of PE-reads in families with 1 member up to >20 members. This information is very useful in early decision steps of the analysis parameters, such as the minimum number of PE-reads to build the single stranded consensus sequence (SSCS). Moreover, this tool can compare several datasets or different steps in the analysis pipeline to monitor data loss or gain (e.g families re-united with barcode correction tool from the `Du Novo Analysis Pipeline <https://doi.org/10.1186/s13059-016-1039-4>`_). In an extension of this tool, each family is stratified into SSCS (ab/ba) and DSC and visualizes the allocation of DCSs respective to SSCS-ab and SSCS-ba. This is quite handy to better understand the relationship of SSCS to DCS per family and identify sources of bias (e.g. more SSCS to DCS in a particular family size, or more forward ab than reverse ba reads).
        
**Input**
        
This tools expects a tabular file with the tags of all families, their sizes and information about forward (ab) and reverse (ba) strands:: 

 1 2                        3
 -----------------------------
 1 AAAAAAAAAAAAAAAAATGGTATG ba
 3 AAAAAAAAAAAAAATGGTATGGAC ab
 
.. class:: infomark

**How to generate the input**

The first step of the `Du Novo Analysis Pipeline <https://doi.org/10.1186/s13059-016-1039-4>`_ is the **Make Families** tool or the **Correct Barcodes** tool that produces output in this form::

 1                        2  3     4
 ------------------------------------------------------
 AAAAAAAAAAAAAAATAGCTCGAT ab read1 CGCTACGTGACTGGGTCATG
 AAAAAAAAAAAAAAATAGCTCGAT ab read2 CGCTACGTGACTGGGTCATG
 AAAAAAAAAAAAAAATAGCTCGAT ab read3 CGCTACGTGACTGGGTCATG
 AAAAAAAAAAAAAAAAATGGTATG ba read3 CGCTACGTGACTAAAACATG

We only need columns 1 and 2. These two columns can be extracted from this dataset using the **Cut** tool::

 1                        2 
 ---------------------------
 AAAAAAAAAAAAAAATAGCTCGAT ab
 AAAAAAAAAAAAAAATAGCTCGAT ab
 AAAAAAAAAAAAAAATAGCTCGAT ab
 AAAAAAAAAAAAAAAAATGGTATG ba

Next, the tags are sorted in ascending or descending order using the **Sort** tool::

 1                        2 
 ---------------------------
 AAAAAAAAAAAAAAAAATGGTATG ba 
 AAAAAAAAAAAAAAATAGCTCGAT ab
 AAAAAAAAAAAAAAATAGCTCGAT ab
 AAAAAAAAAAAAAAATAGCTCGAT ab

Finally, unique occurencies of each tag are counted. This is done using **Unique lines** tool that adds an additional column with the counts that also represent the family size (column 1)::

 1 2                        3
 -----------------------------
 1 AAAAAAAAAAAAAAAAATGGTATG ba
 3 AAAAAAAAAAAAAATGGTATGGAC ab

These data can now be used in this tool.
          
**Output**
        
The output is a PDF file with a plot and a summary of the data in the plot. The tool analyzes the family size distribution, that is the number of PE-reads per tag or family. This information is presented graphically as a histogram. The output can interpreted the following way:

The **first part** of the output from this tool is “FSD after tags” and “FSD after PE reads” depending whether the data is compared to the total number of unique tags/families or the total number of PE-reads. The data is presented in a histogram showing the frequency of family sizes (FS) ranging from FS=1 to FS>20 members in a step-wise manner. Multiple datasets or steps of an analysis can be merged in one histogram (e.g. tags before and after barcode correction). The family size distribution gives the user an insight into the allocation of DCS in the libary; information that can be used to decide on the optimal family size parameter for building SSCSs.

The **second part** of the output shows the family size distribution (FSD) for each of the datasets in more detail. The tags are categorized based on whether they form DCS (duplex = complementary tags in the ab and ba direction) or form only SSCS-ab or SSCS-ba with no matching complement.
        
]]> 
</help>
 <expand macro="citation" />
</tool>
