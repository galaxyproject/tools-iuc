<?xml version="1.0"?>
<tool id="chromhmm_evalsubset" name="chromHMM EvalSubset" version="@TOOL_VERSION@+@WRAPPER_VERSION@">
    <description>of chromatin states</description>

    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements"/>

    <stdio></stdio>  

    <command detect_errors="exit_code"><![CDATA[
        ## initialize
        mkdir -p input/binary &&
        mkdir -p input/segments &&
        #set $available_marks = []
        ln -s '${inputmodel}' input/model.txt &&
        
        ## numstates is the first value in the header of the model file
        ## and will be used for the name pattern of '_segments' files
        #set $numstates = [next(open(str($inputmodel))) for x in range(1)][0].split("\t")[0].strip()
        
        ## '_binary.txt' and '_segments.bed' files must have a matching name pattern
        #for $i, $s in enumerate($input_rep)
            ## use dataset names for output files
            #set $name = ''
            #set $chr = ''

            ## '_binary' file
            #set $name = [next(open(str($s.inputdir))) for x in range(1)][0].split("\t")[0].strip()
            #set $chr = [next(open(str($s.inputdir))) for x in range(1)][0].split("\t")[1].strip()
            ln -s '${s.inputdir}' input/binary/${name}_${chr}_binary.txt &&
            ## marks can be found in the second (== 1) line of every '_binary.txt' file
            #set $available_marks = [x for j, x in enumerate(open(str($s.inputdir))) if j == 1][0].strip().split()

            ## '_segments.bed' file
            ln -s '${s.segmentdir_cond.segmentdir}' input/segments/${name}_${numstates}_segments.bed &&
        #end for

        ## create bit string with "1" for a mark selected by user, and "0" else
        #set $selected_marks = str($includemarks).strip().split(',')
        #set $bit_marks = "".join(["1" if j in $selected_marks else "0" for j in $available_marks])

        ## run
        @RUN@
            EvalSubset
            ## optional parameters
            #if $oo.append == 'append'
                -append
            #end if
            -b $ap.b
            -color $oo.color
            $ap.many
            $ap.scalebeta
            ## required parameters
            input/model.txt ## inputmodel
            input/binary ## inputdir
            input/segments ## segmentdir
            matrix ## outconfusionfileprefix
            $bit_marks ##includemarks
        ]]></command>
    <inputs>
        <!-- excluded: -->
        <!-- imitated with additional output options: -noimage -->
        <param argument="inputmodel" type="data" format="txt" multiple="false" label="Select file with model parameters." help="Usually a textfile with the prefix 'model_'."/>      
        <repeat name="input_rep" title="Dataset" min="1" help="Only group '_binary.txt' and '_segements.bed' files of the same dataset together, e.g. GM12878.">
            <param argument="inputdir" type="data" format="txt" label="Select binary input file(s)." help="Usually text files with suffix '_binary'."/>      
            <conditional name="segmentdir_cond">
                <param name="segmentdir_sel" type="select" label="" help="">
                    <option value="seg">Segmentation</option>
                    <option value="post">Posterior</option>
                    <option value="state">StateByLine</option>
                </param>
                <when value="seg">
                    <param name="segmentdir" type="data" format="bed" label="Select segmentation file(s)" help=""/>
                </when>
                <when value="post">
                    <param name="segmentdir" type="data" format="bed" label="Select posterior segmentation file(s)" help=""/>
                </when>
                <when value="state">
                    <param name="segmentdir" type="data" format="bed" label="Select statebyline segmentation file(s)" help=""/>
                </when>
            </conditional>
        </repeat>
        <param argument="includemarks" type="text" value="" optional="false" multiple="true" label="Set mark(s) to be inlcuded." help="Comma separated list, e.g. H3K9ac,H4K20me1,WCE">
            <validator type="empty_field"/> <!-- todo -->
        </param>
        <!-- advanced parameters -->
        <section name="ap" title="Advanced parameters">
            <param argument="-b" type="integer" value="200" min="0" label="Set binsize." help="The number of base pairs in a bin determining the resolution of the model learning and segmentation."/>
            <param argument="-many" type="boolean" truevalue="-many" falsevalue="" checked="false" label="Activate many features procedure?" help="Use a slower, but more numerically stable procedure for evaluating the emission parameters. Should be used if there are several hundreds of features."/>
            <param argument="-scalebeta" type="boolean" truevalue="-scalebeta" falsevalue="" checked="false" label="Set scale beta." help="Change the internal numerical procedure for computing the backward variables that can prevent numerical overflow observed in specialized settings. Specifically the backward variables are rescaled based on the sum of their values at a position opposed to reusing the scaling of the forward variables. Numerical underflow is prevented by setting the beta values to 10^(-300) if they fall below that, and likewise for the forward variables with the added condition that emission must evaluate greater than 0 at the position."/>
        </section>

        <section name="oo" title="Output options">
            <param name="matrix" type="select" multiple="true" label="Confusion matrix: Which files should be created?" help="">
                <!-- txt is always generated-->
                <option value="png">png</option>
                <option value="svg">svg</option>
            </param>
            <param argument="-append" type="select" label="Append output to result or overwrite it? " help="">
                <option value="overwritten">Overwrite</option>
                <option value="append">Append</option>
            </param>
            <param argument="-color" type="text" value="0,0,255" label="Set heatmap colors." help="Integer values between 0 and 255, separated by commas."/>
        </section>
    </inputs>

    <outputs>
        <data name="out_matrix_txt" format="txt" from_work_dir="matrix.txt" label="${tool.name} on $(on_string) Confusion Matrix, txt"/>
        <data name="out_matrix_png" format="png" from_work_dir="matrix.png" label="${tool.name} on $(on_string) Confusion Matrix, png">
            <filter>'png' in str(oo['matrix'])</filter>
        </data>
        <data name="out_matrix_svg" format="svg" from_work_dir="matrix.svg" label="${tool.name} on $(on_string) Confusion Matrix, svg">
            <filter>'svg' in str(oo['matrix'])</filter>
        </data>
    </outputs> 

    <tests> 
        <!-- #1 only required parameters, all outputs -->
        <test>
            <param name="inputmodel" value="model_2.txt"/>      
            <repeat name="input_rep">
                <param name="inputdir" value="GM12878_chr11_binary.txt.gz"/>      
                <conditional name="segmentdir_cond">
                    <param name="segmentdir_sel" value="seg"/>
                    <param name="segmentdir" value="GM12878_2_segments.bed.gz"/>
                </conditional>
            </repeat>
            <repeat name="input_rep">
                <param name="inputdir" value="K562_chr11_binary.txt.gz"/>      
                <conditional name="segmentdir_cond">
                    <param name="segmentdir_sel" value="seg"/>
                    <param name="segmentdir" value="K562_2_segments.bed.gz"/>
                </conditional>
            </repeat>
            <param name="includemarks" value="CTCF,H3K27ac"/>
            <section name="oo">
                <param name="matrix" value="png,svg"/>
            </section>
            <output name="out_matrix_png" file="evalsubset.png"/>            
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

EvalSubset @HELP_WID@

EvalSubset evaluates the extent to which an existing segmentation can be recovered using only a subset of marks.

**Input**

The method takes an input the model used to generate an existing segmentation, the data used to generate the segmentation, the existing segmentation, an output file prefix, and which subset of marks to include.

**Output**

The output is a confusion matrix comparing the state assignments based on the full set of marks and those based on using the model learned on the full data but with the state assignments generated based only on a subset of inputs. Each row of the confusion matrix indicates the proportion of state assignments based on the full marks assigned to each state using a subset of marks (columns).

.. class:: infomark

**References**

@HELP_REFERENCES@
    ]]></help>
    <citations>
        <expand macro="citations"/>
    </citations>
</tool>