<?xml version="1.0"?>
<tool id="chromhmm_binarizebam" name="chromHMM BinarizeBam" version="@TOOL_VERSION@+@WRAPPER_VERSION@">
    <description>create binary from bam</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <stdio></stdio>
    <command detect_errors="exit_code"><![CDATA[
        ## initialize
        mkdir -p 'input/bam' 'input/control' 'output/control' 'output/binary' 'output/signal' &&
        ## bam files, filenames need to match entries in '$cellmarkfiletable', one folder
        #for $file in $inputbamdir
            ln -s '${file}' 'input/bam/${file.name}' &&
        #end for

        ## run
        @RUN@
            BinarizeBam
            ## optional parameters
            #if $oo.t
                -t 'output/signal'
            #end if
            #if $ap.paired_cond.paired_sel == 'yes'
                -paired
            #else if $ap.paired_cond.paired_sel == 'no'
                #if $ap.paired_cond.assign_cond.assign_sel == 'shift'
                    -n $ap.paired_cond.assign_cond.n
                #else if $ap.paired_cond.assign_cond.assign_sel == 'center'
                    -center
                #end if
                #if $ap.paired_cond.peaks_cond.peaks_sel == 'yes'
                    -peaks
                    #unless $ap.paired_cond.peaks_cond.i == ''
                        -i '$ap.paired_cond.peaks_cond.i'
                    #end unless
                #end if
            #end if
            -b $ap.b
            -e $ap.e
            -f $ap.f
            -g $ap.g
            -p $ap.p
            -s $ap.s
            $ap.strictthresh
            ## required parameters (specific order)
            '${__tool_directory__}/tool-data/CHROMSIZES/${assembly}.txt' ## chromosomelengthfile
            'input/bam' ## inputbeddir
            '$cellmarkfiletable' ## cellmarkfiletable
            'output/binary' ## outputbinarydir
        ]]></command>
    <inputs>
        <param argument="inputbamdir" type="data" format="bam" multiple="true" label="Select bam input file(s)" help="Filenames have to match entries in cellmarkfiletable."/>
        <expand macro="cellmarkfiletable"/>
        <expand macro="assembly"/>

        <section name="ap" title="Advanced parameters">
            <expand macro="b"/>
            <expand macro="e"/>
            <expand macro="f"/>
            <expand macro="g"/>
            <expand macro="p"/>
            <expand macro="s"/>
            <expand macro="strictthresh"/>
            <conditional name="paired_cond">
                <param name="paired_sel" type="select" label="Treat BAM files as pairs" help="Each pair is counted once with bin assignment is based on shifting half the insert size.">
                    <option value="no">No</option>
                    <option value="yes">Yes</option>
                </param>
                <when value="no">
                    <conditional name="assign_cond">
                        <param name="assign_sel" type="select" multiple="false" label="Select mode to determine the bin to assign a read" help="Center can make sense to use if the coordinates are based on already extended reads. If this option is selected, then the strand information of a read and the shift parameter are ignored. By default reads are assigned to a bin based on the position of its 5' end as determined from the strand of the read after shifting an amount determined by the -n option with respect to the strand orientation.. The number of bases a read should be shifted to determine a bin assignment. If bam files should be treated as peak calls, a '1' is called to any bin overlapping, which is not recommend for broad peak calls. If paired is present then reads in the BAM file are treated as pairs, and each pair is counted once with bin assignment is based on shifting half the insert size. (-center, -n, -peaks, -paired)">
                            <option value="shift">Shift</option>
                            <option value="center">Center</option>
                        </param>
                        <when value="shift">
                            <param argument="-n" type="integer" value="100" label="Set number of bases a read should be shifted to determine a bin assignment" help="Bin assignment is based on the 5' end of a read shifted this amount with respect to the strand orientation."/>
                        </when>
                        <when value="center"/>
                    </conditional>
                    <conditional name="peaks_cond">
                        <param name="peaks_sel" type="select" label="Treat BED files as peak calls" help="Give a '1' call to any bin overlapping a peak call. Not recommend for broad peak calls. (-peaks)">
                            <option value="no">No</option>
                            <option value="yes">Yes</option>
                        </param>
                        <when value="no"/>
                        <when value="yes">
                            <param argument="-i" type="integer" value="" optional="true" label="Set splitindex" help="Generates row split files for each chromosome only for positions corresponding to rows in the interval [splitindex*numsplitbins, (splitindex+1)*numsplitbins]. This option enables greater parallel processing and reduced memory usage when binarizing based on peak files to generate. If using this option BinarizeBed should be run once for each value of splitindex between 0 and ceil(max(chromosome size)/(binsize*numsplitbins))-1. When using this option output is provided for all chromosomes in chromosomelengthfile opposed to just those that contain peaks."/>
                        </when>
                    </conditional>
                </when>
                <when value="yes"/>
            </conditional>
        </section>
        
        <section name="oo" title="Output options">
            <expand macro="t"/>
        </section>
    </inputs>
    <outputs>        
        <expand macro="out_binary"/>        
        <expand macro="out_signal"/>
    </outputs>
    <tests>
        <!-- #1; required parameters -->
        <test expect_num_outputs="1">
            <param name="inputbamdir" value="binarizebam_test_1.bam,binarizebam_test_2.bam"/>
            <param name="cellmarkfiletable" value="binarizebam_cellmark.txt"/>
            <param name="assembly" value="hg18"/>
            <output name="out_binary">
                <discovered_dataset designation="cell1_chr18" ftype="">
                    <assert_contents>
                        <has_n_lines n="380587"/>
                        <has_line line="cell1&#009;chr18"/>
                        <has_line line="0"/>
                    </assert_contents>
                </discovered_dataset>
                <discovered_dataset designation="cell2_chr18" ftype="">
                    <assert_contents>
                        <has_n_lines n="380587"/>
                        <has_line line="cell2&#009;chr18"/>
                        <has_line line="0"/>
                    </assert_contents>
                </discovered_dataset>
            </output>
        </test>
        <!-- #2; advanced parameters, paired -->
        <test expect_num_outputs="2">
            <param name="inputbamdir" value="binarizebam_test_1.bam,binarizebam_test_2.bam"/>
            <param name="cellmarkfiletable" value="binarizebam_cellmark.txt"/>
            <param name="assembly" value="hg18"/>
            <section name="ap">
                <param name="b" value="201"/>
                <param name="e" value="2"/>
                <param name="f" value="0.1"/>
                <param name="g" value="0.1"/>
                <param name="p" value="0.0002"/>
                <param name="s" value="1"/>
                <param name="strictthresh" value="true"/>
                <conditional name="paired_cond">
                    <param name="paired_sel" value="no"/>
                    <conditional name="assign_cond">
                        <param name="assign_sel" value="shift"/>
                        <param name="n" value="110"/>
                    </conditional>
                    <conditional name="peaks_cond">
                        <param name="peaks_sel" value="yes"/>
                    </conditional>
                </conditional>
            </section>
            <section name="oo">
                <param name="t" value="true"/>
            </section>
            <output name="out_binary">
                <discovered_dataset designation="cell1_chr18" ftype="">
                    <assert_contents>
                        <has_n_lines n="378694"/>
                        <has_line line="cell1&#009;chr18"/>
                        <has_line line="0"/>
                    </assert_contents>
                </discovered_dataset>
                <discovered_dataset designation="cell2_chr18" ftype="">
                    <assert_contents>
                        <has_n_lines n="378694"/>
                        <has_line line="cell2&#009;chr18"/>
                        <has_line line="0"/>
                    </assert_contents>
                </discovered_dataset>
            </output>
            <output name="out_signal">
                <discovered_dataset designation="cell1_chr18" ftype="">
                    <assert_contents>
                        <has_n_lines n="378694"/>
                        <has_line line="cell1&#009;chr18"/>
                        <has_line line="0"/>
                    </assert_contents>
                </discovered_dataset>
                <discovered_dataset designation="cell2_chr18" ftype="">
                    <assert_contents>
                        <has_n_lines n="378694"/>
                        <has_line line="cell2&#009;chr18"/>
                        <has_line line="0"/>
                    </assert_contents>
                </discovered_dataset>
            </output>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

BinarizeBam @HELP_WID@

@HELP_CHROMHMM@

BinarizeBam converts coordinates of aligned reads into binarized data form from which a chromatin state model can be learned. The binarization is based on a poisson background model. If no control data is specified the parameter to the poisson distribution is the global average number of reads per bin. If control data is specified the global average number of reads is multiplied by the local enrichment for control reads as determined by the specified parameters. Optionally intermediate signal files can also be outputted and these signal files can later be directly converted into binary form using the BinarizeSignal command. 

**Input**

@HELP_FILETYPE_BAM@
@HELP_FILETYPE_CELLMARKFILETABLE@

**Output**

@HELP_FILETYPE_BINARY@
@HELP_FILETYPE_SIGNAL@

.. class:: infomark

**References**

@HELP_REFERENCES@
    ]]></help>
    <citations>
        <expand macro="citations"/>
    </citations>
</tool>