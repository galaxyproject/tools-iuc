<?xml version="1.0"?>
<tool id="chromhmm_convertgenetable" name="chromHMM ConvertGeneTable" version="@TOOL_VERSION@+@WRAPPER_VERSION@">
    <description>to generate external annotation files</description>

    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements"/>

    <stdio></stdio>  

    <command detect_errors="exit_code"><![CDATA[
        ## initialize
        ## outputfiles are written in the ANCHORFILES and COORDS folder
        mkdir -p output/anchor_out &&
        mkdir -p output/anchor_tmp &&
        mkdir -p output/coords_out &&
        mkdir -p output/coords_tmp &&
        mkdir input &&
        ln -s '${inputgenetable}' ucsc_table.txt &&

        ## run
        @RUN@
            ConvertGeneTable
            -l ${__tool_directory__}/tool-data/CHROMSIZES/${assembly}.txt
            -u output/coords_tmp/
            -v output/anchor_tmp/
            -w $ap.w
            ucsc_table.txt
            '$prefix'
            ${assembly} &&

        ## link output, soft link doesn't work
        ln output/anchor_tmp/${assembly}/* output/anchor_out/ &&
        ln output/coords_tmp/${assembly}/* output/coords_out/ 
        ]]></command>
    <inputs>
        <param name="inputgenetable" type="data" format="txt" multiple="false" label="Select gene annotation file." help="A gene table in a format provided by the UCSC genome table browser. See help section for details."/>
        <param argument="assembly" type="select" label="Specify assembly." help="">
            <options from_data_table="chromhmm_assemblies">
                <validator message="No assembly is available" type="no_options"/>
            </options>
        </param>
        <param argument="prefix" type="text" value="" label="Set prefix for external annotation files." help=""/>
        <section name="ap" title="Advanced parameters" expanded="false">
            <param argument="-w" type="integer" value="2000" min="0" label="Specify the window in number of base pairs around the TSS to include in one of the annotation files." help="Bases +/- that value from the TSS are included."/>
        </section>
    </inputs>

    <outputs>
        <collection name="out_anchor" type="list" label="${tool.name} on ${on_string}: ANCHORFILES">
            <discover_datasets pattern="__name_and_ext__" directory="output/anchor_out"/>
        </collection>
        <collection name="out_coords" type="list" label="${tool.name} on ${on_string}: COORDS">
            <discover_datasets pattern="__name_and_ext__" directory="output/coords_out"/>
        </collection>
    </outputs> 

    <tests> 
        <!-- #1 required parameters -->
        <test>
            <param name="inputgenetable" value="ucsc_tables.txt.gz"/>
            <param name="prefix" value="test"/>
            <param name="assembly" value="hg18"/> 
            <output_collection name="out_anchor" type="list" count="2">
                <element name="testTES.hg18" ftype="txt">
                    <assert_contents>
                        <has_n_lines n="35276"/>
                        <has_line_matching expression="chr1&#009;\d*&#009;\S*"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="out_coords" type="list" count="5">
                <element name="testExon.hg18" ftype="bed">
                    <assert_contents>
                        <has_n_lines n="273906"/>
                        <has_line_matching expression="chr1&#009;\d*&#009;\d*"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- #2 optional parameters -->
        <test>
            <param name="inputgenetable" value="ucsc_tables.txt.gz"/>
            <param name="prefix" value="test"/>
            <param name="assembly" value="hg18"/> 
            <section name="ap">
                <param name="w" value="1900"/>
            </section>
            <output_collection name="out_anchor" type="list" count="2">
                <element name="testTES.hg18" ftype="txt">
                    <assert_contents>
                        <has_n_lines n="35276"/>
                        <has_line_matching expression="chr1&#009;\d*&#009;\S*"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="out_coords" type="list" count="5">
                <element name="testExon.hg18" ftype="bed">
                    <assert_contents>
                        <has_n_lines n="273906"/>
                        <has_line_matching expression="chr1&#009;\d*&#009;\d*"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

ConvertGeneTable @HELP_WID@

ConvertGeneTable takes as input a gene table in a format provided by the UCSC genome table browser and generates external annotation files.

**Input**

@HELP_FILETYPE_UCSC@

**Output**

@HELP_FILETYPE_ANNOTATION@

.. class:: infomark

**References**

@HELP_REFERENCES@
    ]]></help>
    <citations>
        <expand macro="citations"/>
    </citations>
</tool>