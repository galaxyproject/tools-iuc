<?xml version="1.0"?>
<tool id="chromhmm_convertgenetable" name="chromHMM ConvertGeneTable" version="@TOOL_VERSION@+@WRAPPER_VERSION@">
    <description>to generate external annotation files</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <stdio></stdio>
    <command detect_errors="exit_code"><![CDATA[
        ## initialize
        mkdir -p 'input' 'output/anchor_out' 'output/anchor_tmp' 'output/coords_out' 'output/coords_tmp' &&
        ln -s '${inputgenetable}' 'ucsc_table.txt' &&

        ## run
        @RUN@
            ConvertGeneTable
            ## optional parameters
            @L@
            -u 'output/coords_tmp/' ## required
            -v 'output/anchor_tmp/' ## required
            -w $ap.w
            ## required parameters (specific order)
            'ucsc_table.txt' ## inputgenetable
            '$prefix' ## prefix
            '${assembly}' && ## assembly

        ## $assembly cannot be accessed in output
        ## link output (soft links don't work)
        ln output/anchor_tmp/${assembly}/* 'output/anchor_out/' &&
        ln output/coords_tmp/${assembly}/* 'output/coords_out/' 
        ]]></command>
    <inputs>
        <param argument="inputgenetable" type="data" format="tabular" multiple="false" label="Select gene annotation file" help="A gene table in a format provided by the UCSC genome table browser. See help section for details."/>
        <expand macro="assembly"/>
        <param argument="prefix" type="text" value="" label="Set prefix for external annotation files" help="">
            <validator type="empty_field"/>
        </param>
        
        <section name="ap" title="Advanced parameters" expanded="false">
            <param argument="-w" type="integer" value="2000" min="0" label="Specify the window in number of base pairs around the TSS to include in one of the annotation files" help="Bases +/- that value from the TSS are included."/>
        </section>
    </inputs>
    <outputs>
        <collection name="out_anchor" type="list" label="${tool.name} on ${on_string}: ANCHORFILES">
            <discover_datasets pattern="__name_and_ext__" directory="output/anchor_out"/>
        </collection>
        <collection name="out_coords" type="list" label="${tool.name} on ${on_string}: COORDS">
            <discover_datasets pattern="__name_and_ext__" directory="output/coords_out"/>
        </collection>
    </outputs>
    <tests>
        <!-- #1; required parameters -->
        <test expect_num_outputs="2">
            <param name="inputgenetable" value="ucsc_tables.txt.gz"/>
            <param name="prefix" value="test"/>
            <param name="assembly" value="hg18"/>
            <output_collection name="out_anchor" type="list" count="2">
                <element name="testTES.hg18" ftype="txt">
                    <assert_contents>
                        <has_n_lines n="453"/>
                        <has_line_matching expression="chr1&#009;\d*&#009;\S*"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="out_coords" type="list" count="5">
                <element name="testExon.hg18" ftype="bed">
                    <assert_contents>
                        <has_n_lines n="6079"/>
                        <has_line_matching expression="chr1&#009;\d*&#009;\d*"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- #2; optional parameters -->
        <test expect_num_outputs="2">
            <param name="inputgenetable" value="ucsc_tables.txt.gz"/>
            <param name="prefix" value="test"/>
            <param name="assembly" value="hg18"/>
            <section name="ap">
                <param name="w" value="1900"/>
            </section>
            <output_collection name="out_anchor" type="list" count="2">
                <element name="testTES.hg18" ftype="txt">
                    <assert_contents>
                        <has_n_lines n="453"/>
                        <has_line_matching expression="chr1&#009;\d*&#009;\S*"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="out_coords" type="list" count="5">
                <element name="testExon.hg18" ftype="bed">
                    <assert_contents>
                        <has_n_lines n="6079"/>
                        <has_line_matching expression="chr1&#009;\d*&#009;\d*"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

ConvertGeneTable @HELP_WID@

@HELP_CHROMHMM@

ConvertGeneTable takes as input a gene table in a format provided by the UCSC genome table browser and generates external annotation files.

**Input**

@HELP_FILETYPE_UCSC@

**Output**

@HELP_FILETYPE_ANCHOR@
@HELP_FILETYPE_COORDS@

.. class:: infomark

**References**

@HELP_REFERENCES@
    ]]></help>
    <citations>
        <expand macro="citations"/>
    </citations>
</tool>