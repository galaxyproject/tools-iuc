<macros>
    <token name="@FASTQC_COMMAND@"><![CDATA[
        #for $j, $repeat2 in enumerate( $repeat.software_cond.output )
            @CREATE_REPEAT_DIR_1@
            #if str($repeat2.type) == "data"
                #for $k, $file in enumerate($repeat2.input)
                    #set file_dir = os.path.join($repeat_dir, 'file_' + str($k))
                    #set file_path = os.path.join($file_dir, 'fastqc_data.txt')
                    mkdir '$file_dir' &&
                    ln -s '$file' '$file_path' &&
                #end for
            #elif str($repeat2.type) == "theoretical_gc"
                #for $file in $repeat2.input
                    @ESCAPE_IDENTIFIER@
                    #set file_path = os.path.join($repeat_dir, str($identifier) + '_fastqc_theoretical_gc')
                    ln -s '$file' '$file_path' &&
                #end for
            #end if
        #end for
    ]]></token>

    <xml name="fastqc_form">
        <repeat name="output" title="FastQC output" min="1">
            <param name="type" type="select" label="Type of FastQC output?">
                <option value="data">Raw data</option>
                <option value="theoretical_gc">Theorectical GC</option>
            </param>
            <param name="input" type="data" format="txt" multiple="true" label="FastQC output">
                <validator type="expression" message="MultiQC does not accept the HTML report generated by FastQC, only the Raw Data">value is not None and value.extension != "html"</validator>
            </param>
        </repeat>
    </xml>

    <!-- add here your test files and tests, the more stringent the better -->
    <xml name="fastqc_test">
        <test expect_num_outputs="7">
            <repeat name="results">
                <conditional name="software_cond">
                    <param name="software" value="fastqc" />
                    <repeat name="output">
                        <param name="type" value="data"/>
                        <param name="input" value="fastqc_1.txt,fastqc_2.txt"/>
                    </repeat>
                </conditional>
            </repeat>
            <param name="title" value="Title of the report"/>
            <param name="comment" value="Commment for the report"/>
            <param name="flat" value="true"/>
            <param name="export" value="true"/>
            <output name="html_report">
                <assert_contents>
                    <has_text text="Title of the report" />
                    <has_text text="Commment for the report" />
                    <has_text text="fastqc_seq_heatmap_key_t" />
                </assert_contents>
            </output>
            <output name="stats">
                <assert_contents>
                    <has_text text="poulet5_1"/>
                    <has_text text="poulet5_2"/>
                    <has_text text="fastqc-median_sequence_length"/>
                    <has_n_lines n="3"/>
                    <has_n_columns n="7"/>
                </assert_contents>
            </output>
            <output_collection name="plots" type="list" count="7"/>
            <output_collection name="exported_png" type="list" count="0"/>
            <output_collection name="exported_svg" type="list" count="0"/>
            <output_collection name="exported_pdf" type="list" count="0"/>
            <output_collection name="plot_data" type="list" count="0"/>
        </test>
        <test expect_num_outputs="3">
            <repeat name="results">
                <conditional name="software_cond">
                    <param name="software" value="fastqc" />
                    <repeat name="output">
                        <param name="type" value="data"/>
                        <param name="input" value="fastqc_1.txt,fastqc_2.txt"/>
                    </repeat>
                </conditional>
            </repeat>
            <param name="title" value="PDF test report"/>
            <param name="comment" value="PDF only test"/>
            <param name="pdf" value="true"/>
            <output name="html_report">
                <assert_contents>
                    <has_text text="PDF test report"/>
                    <has_text text="PDF only test"/>
                </assert_contents>
            </output>
            <output name="stats">
                <assert_contents>
                    <has_text text="fastqc-percent_gc"/>
                </assert_contents>
            </output>
            <!-- Assumes multiqc.xml defines a pdf_report data output gated by the 'pdf' param -->
            <output name="report_pdf" ftype="pdf">
                <assert_contents>
                    <has_size min="0"/>
                </assert_contents>
            </output>
        </test>
    </xml>
</macros>
