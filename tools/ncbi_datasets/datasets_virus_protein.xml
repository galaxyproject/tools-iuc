<tool id="datasets-virus-protein" name="NCBI datasets download virus protein" profile="@PROFILE@" license="@LICENSE" version="@TOOL_VERSION@">
    <description>Download a coronavirus protein dataset</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"></expand>
    <command><![CDATA[
@SETUP_CERTIFICATES@
datasets download virus protein
#for $protein in $proteins:
    $protein
#end for
$annotated
$complete_only
@EXCLUDES_VIRUS_PROTEIN@
#if str($geo_location):
    --geo-location '$geo_location'
#end if
#if str($host):
    --host '$host'
#end if
#if str($lineage):
    --host '$lineage'
#end if
$refseq
@RELEASED_SINCE@
&& 7z x ncbi_dataset.zip
]]></command>
    <inputs>
        <param name="proteins" type="select" multiple="true" label="Select viral protein(s)">
            <option value="ORF1ab">ORF1ab</option>
            <option value="ORF1a">ORF1a</option>
            <option value="nsp1">nsp1</option>
            <option value="nsp2">nsp2</option>
            <option value="nsp3">nsp3</option>
            <option value="nsp4">nsp4</option>
            <option value="nsp5">nsp5</option>
            <option value="nsp6">nsp6</option>
            <option value="nsp7">nsp7</option>
            <option value="nsp8">nsp8</option>
            <option value="nsp9">nsp9</option>
            <option value="nsp10">nsp10</option>
            <option value="rdrp">rdrp</option>
            <option value="nsp11">nsp11</option>
            <option value="nsp13">nsp13</option>
            <option value="nsp14">nsp14</option>
            <option value="nsp15">nsp15</option>
            <option value="nsp16">nsp16</option>
            <option value="S">S</option>
            <option value="ORF3a">ORF3a</option>
            <option value="E">E</option>
            <option value="M">M</option>
            <option value="ORF6">ORF6</option>
            <option value="ORF7a">ORF7a</option>
            <option value="ORF7b">ORF7b</option>
            <option value="ORF8">ORF8</option>
            <option value="N">N</option>
            <option value="ORF10">ORF10</option>
        </param>
        <expand macro="annotation"></expand>
        <param argument="--complete-only" truevalue="--complete-only" falsevalue="" type="boolean" label="limit to complete coronavirus genomes?"/>
        <expand macro="excludes_virus_protein"></expand>
        <param argument="--geo-location" type="text" label="Limit to coronavirus genomes isolated from a specified geographic location" help="Continent, country or U.S. state"/>
        <param argument="--host" type="text" label="Limit to coronavirus genomes isolated from a specified host" help="NCBI Taxonomy ID, scientific or common name at any taxonomic rank"/>
        <param argument="--lineage" type="text" label="Limit to SARS-CoV-2 genomes classified as the specified lineage (variant) by pangolin using the pangoLEARN algorithm" />
        <param argument="--refseq" type="boolean" truevalue="--refseq" falsevalue="" label="Limit to RefSeq coronavirus genomes"/>
        <expand macro="released_options" before_or_after="since"></expand>
    </inputs>
    <outputs>
        <data name="cds_fasta" format="fasta" label="NCBI datasets virus genome: CDS fasta" from_work_dir="ncbi_dataset/data/cds.fna">
            <filter>not exclude_cds</filter>
        </data>
        <data name="protein_fasta" format="fasta" label="NCBI datasets virus genome: protein fasta" from_work_dir="ncbi_dataset/data/protein.faa">
            <filter>not exclude_protein</filter>
        </data>
        <data name="protein_genbank" format="fasta" label="NCBI datasets virus genome: protein genbank" from_work_dir="ncbi_dataset/data/protein.gpff">
            <filter>not exclude_gpff</filter>
        </data>
        <collection name="protein_structure" type="list" format="pdb" label="NCBI datasets virus genome: protein structure">
            <discover_datasets pattern="(?P&lt;identifier_0&gt;.*?)\.pdb" ext="pdb" directory="ncbi_dataset/data/pdb"></discover_datasets>
            <filter>not exclude_pdb</filter>
        </collection>
    </outputs>
    <tests>
        <test title="Test download of PDB collection">
            <param name="proteins" value="S,M"/>
            <param name="exclude_cds" value="true"/>
            <param name="exclude_protein" value="true"/>
            <param name="exclude_gpff" value="true"/>
            <param name="released_since" value="07/07/2021"/>
            <param name="refseq" value="true"/>
            <output_collection name="protein_structure" type="list">
                <element name="6VYB" checksum="sha256$307a56951050faa61f4b57e6b8ceabb7ca743125058421c232746f1820484069"/>
                <element name="6VYO" checksum="sha256$1dab20880b7ae913da336e8a6dba838689256e63a3faaaaa439b7bd7f3651eaf"/>
                <element name="6W37" checksum="sha256$f115326ed4b3f7b332b44790c1a3ca769deb2d440dae68ce4ccae8e650dd1d7e"/>
                <element name="6W4H" checksum="sha256$a49bc40b5652664b7e01e562279786520b0abcf6e34a7d7f603d6e429afbf384"/>
                <element name="6W9C" checksum="sha256$0f845885e5a9d41e42628c3b05b194ecbac59f38211927eb924e80c830190753"/>
                <element name="6W9Q" checksum="sha256$c5d34126464ac47738c8883f03455cf3d73ba41a6aa9e0c40e92bca411321ed7"/>
            </output_collection>
        </test>
        <test title="Test download of non-collection elements" expect_num_outputs="3">
            <param name="exclude_pdb" value="true"/>
            <param name="proteins" value="S,M"/>
            <param name="refseq" value="true"/>
            <output name="cds_fasta">
                <assert_contents>
                    <has_line line="ATGTTTGTTTTTCTTGTTTTATTGCCACTAGTCTCTAGTCAGTGTGTTAATCTTACAACCAGAACTCAAT"/>
                </assert_contents>
            </output>
            <output name="protein_fasta">
                <assert_contents>
                    <has_line line="MFVFLVLLPLVSSQCVNLTTRTQLPPAYTNSFTRGVYYPDKVFRSSVLHSTQDLFLPFFSNVTWFHAIHV"/>
                </assert_contents>
            </output>
            <output name="protein_genbank">
                <assert_contents>
                    <has_line line="ACCESSION   YP_009724390"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
Downloads a coronavirus SARS-CoV-2 protein dataset
    </help>

</tool>
