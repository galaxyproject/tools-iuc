<tool id="datasets_download_ortholog" name="NCBI Datasets Ortholog" profile="@PROFILE@" license="@LICENSE" version="@TOOL_VERSION@">
    <description>download sequence and metadata for gene ortholog groups</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"></expand>
    <command><![CDATA[
@SETUP_CERTIFICATES@
datasets download ortholog $subcommand.download_by
#if $subcommand.download_by != 'taxon':
    #if $subcommand.text_or_file.text_or_file == 'text':
        #if $subcommand.download_by == 'gene-id':
            $subcommand.text_or_file.accession
        #else
            #echo " ".join(f"'{x}'" for x in $subcommand.text_or_file.accession.split(' ') if x)
        #end if
    #else
        --inputfile '$subcommand.text_or_file.inputfile'
    #end if
#else:
    '$subcommand.taxon'
#end if
@EXCLUDES_GENE@
#if $taxon_filter:
    --taxon-filter '$taxon_filter'
#end if
&& 7z x ncbi_dataset.zip
]]></command>
    <inputs>
        <conditional name="subcommand">
            <param name="download_by" type="select" label="Choose how to find ortholog dataset to download">
                <option value="gene-id">Download a ortholog dataset by NCBI Gene ID</option>
                <option value="symbol">Download a ortholog dataset by gene symbol</option>
                <option value="accession">Download a orthologsdataset by RefSeq nucleotide or protein accession</option>
            </param>
            <when value="gene-id">
                <expand macro="text_or_file" what="gene-id" what_extended="NCBI Gene ID" help="Should be valid NCBI Gene ID">
                    <sanitizer invalid_char="">
                        <valid initial="string.digits">
                            <add value=" " />
                        </valid>
                    </sanitizer>
                </expand>
            </when>
            <when value="symbol">
                <expand macro="text_or_file" what="symbol" what_extended="gene symbol" help="Should be valid gene symbol"/>
                <param argument="--taxon" type="text" value="human" label="Specify a species name" help="Species name can be common or scientific name or species-level NCBI Taxonomy ID"/>
            </when>
            <when value="accession">
                <expand macro="text_or_file" what="accession" what_extended="RefSeq nucleotide or protein accession" help="Should be RefSeq nucleotide or protein accession"/>
            </when>
        </conditional>
        <param argument="--taxon-filter" type="text" optional="true" label="limit genes to a specified taxon" help="any rank"/>
        <expand macro="excludes_gene"></expand>
    </inputs>
    <outputs>
        <data name="gene_fasta" format="fasta" label="NCBI datasets ortholog: gene fasta" from_work_dir="ncbi_dataset/data/gene.fna">
            <filter>not exclude_gene</filter>
        </data>
        <data name="protein_fasta" format="fasta" label="NCBI datasets ortholog: protein fasta" from_work_dir="ncbi_dataset/data/protein.faa">
            <filter>not exclude_protein</filter>
        </data>
        <data name="rna_fasta" format="fasta" label="NCBI datasets ortholog: rna fasta" from_work_dir="ncbi_dataset/data/rna.fna">
            <filter>not exclude_rna</filter>
        </data>
    </outputs>
    <tests>
        <test title="test download by gene-id">
            <conditional name="subcommand">
                <param name="download_by" value="gene-id"></param>
                <conditional name="text_or_file">
                    <param name="text_or_file" value="text"></param>
                    <param name="accession" value="472 672"></param>
                </conditional>
            </conditional>
            <param name="taxon_filter" value="Puma"/>
            <output name="gene_fasta">
                <assert_contents>
                    <has_line line="ATGGATTTATCTGCAGATCGTGTTGAAGAAGTACAAAGTGTCCTTAATGCTATGCAGAAAATCTTAGAGT"/>
                    <has_line line="GGGCAGAGGGGCGGAACTACAAGTGCGCAATCGTGGGCCGCGGCCCATTTCCCCTTCCCAGGTAAATTCG"/>
                </assert_contents>
            </output>
        </test>
        <test title="test download by gene-id, test sanitizer">
            <conditional name="subcommand">
                <param name="download_by" value="gene-id"></param>
                <conditional name="text_or_file">
                    <param name="text_or_file" value="text"></param>
                    <param name="accession" value="472 672"></param>
                </conditional>
            </conditional>
            <param name="taxon_filter" value="Puma"/>
            <output name="gene_fasta">
                <assert_contents>
                    <has_line line="ATGGATTTATCTGCAGATCGTGTTGAAGAAGTACAAAGTGTCCTTAATGCTATGCAGAAAATCTTAGAGT"/>
                    <has_line line="GGGCAGAGGGGCGGAACTACAAGTGCGCAATCGTGGGCCGCGGCCCATTTCCCCTTCCCAGGTAAATTCG"/>
                </assert_contents>
            </output>
            <assert_command>
                <not_has_text text="exit"/>
            </assert_command>
        </test>
        <test title="test download by gene symbol">
            <conditional name="subcommand">
                <param name="download_by" value="symbol"></param>
                <conditional name="text_or_file">
                    <param name="text_or_file" value="text"></param>
                    <param name="accession" value="BRCA1 ATM"></param>
                </conditional>
            </conditional>
            <param name="taxon_filter" value="Puma"/>
            <output name="gene_fasta">
                <assert_contents>
                    <has_line line="ATGGATTTATCTGCAGATCGTGTTGAAGAAGTACAAAGTGTCCTTAATGCTATGCAGAAAATCTTAGAGT"/>
                    <has_line line="GGGCAGAGGGGCGGAACTACAAGTGCGCAATCGTGGGCCGCGGCCCATTTCCCCTTCCCAGGTAAATTCG"/>
                </assert_contents>
            </output>
        </test>
        <test title="test download by accession">
            <conditional name="subcommand">
                <param name="download_by" value="accession"></param>
                <conditional name="text_or_file">
                    <param name="text_or_file" value="text"></param>
                    <param name="accession" value="NM_000546.6 NM_000492.4"></param>
                </conditional>
            </conditional>
            <param name="taxon_filter" value="Puma"/>
            <output name="gene_fasta">
                <assert_contents>
                    <has_line line="ATGCAGGAGCCGCCATTGGAACTCACCATCGAGCCCCCTCTGAGCCAGGAGACATTTTCGGAATTGTGGA"/>
                    <has_line line="AGTTGGAAGCAAATGACATCACTGCGGGTCAGAGAAAAAGGGGCGAGCAGCCTGCGCCAGAAGAGTAGGG"/>
                </assert_contents>
            </output>
            <assert_command>
                <has_text text="'NM_000546.6' 'NM_000492.4'"/>
            </assert_command>
        </test>
    </tests>
    <help>
        Download an ortholog dataset including gene, transcript and protein sequence, a data table and a data report. Ortholog data is calculated by NCBI for vertebrates and insects. Ortholog datasets can be specified by NCBI Gene ID, symbol or RefSeq accession.)
    </help>

</tool>
