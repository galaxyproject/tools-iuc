<tool id="normalise_scater" name="Scater Normalisation" version="@VERSION@.0">
    <!-- TODO:
         - Help text
         -->
    <description>Normalise a SCE count matrix</description>
    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements" />

    <command detect_errors="exit_code"><![CDATA[
    Rscript '@SCRIPT_DIR@/scater_normalise.R' '@SCRIPT_DIR@' '$rconf_norm' &&
    mv sce_out.rds '${out_rdat}'
    ]]></command>

    <configfiles>
        <configfile name="rconf_norm" >
# General Args
sce = readRDS( '$inp_rdat' )
nmethod = '$method'
ret_log = as.logical( 'T' )
        </configfile>
    </configfiles>

    <inputs>
        <param name="inp_rdat" type="data" format="rdat.sce" label="Input SCE matrix" help="A (SingleCellExperiment) RData matrix of cell columns and transcript rows, output from the scater filter module" />
        <param name="method" type="select" >
            <option value="TMM" >(TMM) Trimmed Mean of M-valuesy</option>
            <option value="RLE" >(RLE) Relative Log Expression</option>
            <option value="upperquartile" >(UQ) Upper quartile</option>
            <option value="none" >None</option>
            <help><![CDATA[
<table>
<tr><td>TMM</td><td>Trimmed Mean of M-values</td><td>The weighted trimmed mean of M-values (to the reference) proposed by Robinson and Oshlack (2010), where the weights are from the delta method on Binomial data. If refColumn is unspecified, the library whose upper quartile is closest to the mean upper quartile is used.</td></tr>
<tr><td>RLE</td><td>Relative Log Expression</td><td>The scaling factor method proposed by Anders and Huber (2010). We call it "relative log expression", as median library is calculated from the geometric mean of all columns and the median ratio of each sample to the median library is taken as the scale factor.</td></tr>
<tr><td>UQ</td><td>Upper Quartile</td><td>The upper-quartile normalization method of Bullard et al (2010), in which the scale factors are calculated from the 75% quantile of the counts for each library, after removing genes which are zero in all libraries. This idea is generalized here to allow scaling by any quantile of the distributions.</td></tr>
<tr><td>None</td><td><td>The normalisation factors are set to 1</td></tr>
</table>
]]>
            </help>
        </param>
    </inputs>

    <outputs>
        <data name="out_rdat" format="rdata.sce" label="${tool.name} on ${on_string} : SCE Rdata" />
    </outputs>
    <tests>
        <test>
            <param name="inp_rdat" value="filtered.rds" />
            <param name="method" value="TMM" />
            <output name="out_rdat" value="filtered_out_TMM.rds" />
        </test>
        <test>
            <param name="inp_rdat" value="filtered.rds" />
            <param name="method" value="RLE" />
            <output name="out_rdat" value="filtered_out_RLE.rds" />
        </test>
        <test>
            <param name="inp_rdat" value="filtered.rds" />
            <param name="method" value="upperquartile" />
            <output name="out_rdat" value="filtered_out_UQ.rds" />
        </test>
        <test>
            <param name="inp_rdat" value="filtered.rds" />
            <param name="method" value="none" />
            <output name="out_rdat" value="filtered_out_none.rds" />
        </test>
xo    </tests> 
    <help><![CDATA[

        see: https://www.rdocumentation.org/packages/scater/versions/1.0.4/topics/normaliseExprs

        ]]>
    </help>
    <expand macro="citations" />
</tool>
