#!/usr/bin/env Rscript

args = commandArgs(trailingOnly=T)

script_dir = args[1]
config_file = args[2]

# Load libs, common functions, source RaceID and Galaxy Params
source(paste(script_dir, "common.R", sep="/"))

# Read input data
x <- read.table(count_matrix, header=col_header, comment=commchar, row.names=row_head)

message("Count matrix with %.0f cells and %.0f genes", dim(x)[1], dim(x)[2])

# Perform the spike-in filtering
x_filt <- x[!grepl(filterout,x),]

sce <- SingleCellExperiment(assays = list(counts = as.matrix(x_filt)))
sce <- calculateQCMetrics(sce)
cnts <- counts(sce)

sce_f <- sce[rowSums(cnts) > min_gene_trans, colSums(cnts) > min_cell_trans]

plotter("OUT_prefilter_totalcounts",
        hist(
            sce$total_counts, breaks=100, 
            xlab="Total Transcripts per Cell", 
            ylab="Frequency", 
            main=""
        )
        )


