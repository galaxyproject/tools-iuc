<tool id="filter_scater" name="Scater Filter" version="@VERSION@.0">
    <description>Filter a scRNA count matrix or table</description>
    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements" />

    <command detect_errors="exit_code"><![CDATA[
    Rscript '@SCRIPT_DIR@/scater_filter.R' '@SCRIPT_DIR@' '$rconf_filter' &&

    mv table.stats '${out_stats}' &&
    mv table.counts '${out_table}' &&
    mv table.rds '${out_rdat}' &&

    mkdir '${out_html_report.files_path}' &&
    cp OUT_*.svg '${out_html_report.files_path}' &&

    echo "<html><head></head><body>
    <h1>Cell and Feature Histograms with QC cutoffs</h1><br />
    <img src=\"OUT_prefilter_totalcounts.svg\" ><br />
    <img src=\"OUT_prefilter_totalgenes.svg\" ><br />
    </body></html>" > '$out_html_report'

    ]]></command>

    <configfiles>
        <configfile name="rconf_filter" >
# General Args
count_matrix = '$inp_table'
min_cell_trans = as.integer('$min_cell_trans')
min_gene_trans = as.integer('$min_gene_trans')
gdetect_mintrans = as.integer('$gdetect.mintrans')
gdetect_mincells = as.integer('$gdetect.mincells')
filterout = '$genenames_grep'

# Advanced Args
col_header= as.logical('$advanced.col_header')
row_head= as.integer('$advanced.row_head')
commchar= as.character('$advanced.commchar')
        </configfile>
    </configfiles>
    <inputs>
        <param name="inp_table" type="data" format="tabular" label="Input count matrix" help="A matrix of cell columns and transcript rows, with the first row denoting cell headers and the first column denoting transcript names. (Specify otherwise in the advanced parameters.)" />
        <param name="min_cell_trans" type="integer" value="3000" label="Minimum total cell transcripts" help="Cells with a column sum less than this amount are discarded." />
        <param name="min_gene_trans" type="integer" value="0" label="Minimum total gene transcripts" help="Genes with a row sum less that this amount are discarded. It is advised not to filter based on this metric too stringently since transcripts counts across rows are likely to change after normalisation." />
        <param name="genenames_grep" type="text" value="" label="Filter out gene names matching this string (grep)." help="Useful for removing spike-ins, or unwanted genes (e.g. 'ERCC')" />        
        <section name="gdetect" title="Gene Detectability" expanded="true" >
            <param name="mintrans" type="integer" min="0" value="0" label="Minimum level of transcripts a gene must have in a particular cell to make it 'detectable'." />
            <param name="mincells" type="integer" min="0" value="2" label="Minimum number of cells a gene must be 'detectable' within." />
        </section>

        <section name="advanced" title="Advanced Input Parameters" >
            <param name="col_header" type="boolean" truevalue="T" falsevalue="F" checked="true" label="Matrix has header row?" />
            <param name="row_head" type="boolean" truevalue="1" falsevalue="0" checked="true" label="Matrix has header row?" />
            <param name="commchar" type="text" value="?" label="Comment character" />
        </section>
    </inputs>
    <outputs>
        <data name="out_stats" format="tabular" label="${tool.name} on ${on_string}: Stats"/>
        <data name="out_table" format="tabular" label="${tool.name} on ${on_string}: Filtered Table" />
        <data name="out_rdat" format="rdata.sce" label="${tool.name} on ${on_string} : SCE Rdata" />
        <data name="out_html_report" format="html" label="${tool.name} on ${on_string} : Report" />
    </outputs>
    <tests>
        <test>
            <param name="inp_table" value="test_matrix.tsv" />
            <param name="min_cell_trans" value="500" />
            <output name="out_stats" value="test_out.stats" />
            <output name="out_table" value="test_out.table" />
            <output name="out_rdat" value="test_out.rdat" />
            <output name="out_html_report" value="test_out.html" />
        </test>
    </tests>
    <help><![CDATA[
Help test
    
    ]]></help>
    <expand macro="citations" />
</tool>
