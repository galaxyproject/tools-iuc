<tool id="normalise_metrics" name="Normalisation Metrics" version="@VERSION@.0">
    <!-- TODO:
         - Help text
         -->
    <description>generates relative log expression plots for different normalisation modules</description>
    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements" />

    <command detect_errors="exit_code"><![CDATA[
    Rscript '@SCRIPT_DIR@/normalise_metrics.R' '@SCRIPT_DIR@' '$rconf_norm' &&
    mkdir -p '${out_html.files_path}' &&
    cp OUT_plotrle.svg '${out_html.files_path}'/ &&

    echo "<html>
    <head><h3>Relative log expression plots</h3></head>
    <body>" > '${out_html}' &&
    cat table.html >> '${out_html}' &&
    echo "<br /><img src=\"OUT_plotrle.svg\" /></body></html>" >> '${out_html}'
    ]]></command>

    <configfiles>
        <configfile name="rconf_norm" >
matrices = list()
colourby = NULL

#for $i, $repeat in enumerate( $inp_rdats ):
matrices[['$repeat.name']] = readRDS('$repeat.sce')
#end for

#for $i, $repeat in enumerate( $highlight )
colourby = c(colourby, '$repeat.name')
#end for
        </configfile>
    </configfiles>
    <inputs>
        <repeat name="inp_rdats" title="Input SCE matrix" min="1">
            <param name="sce" type="data" format="rdat.sce" label="R Data" />
            <param name="name" type="text" value="" label="Name of R Data" />
        </repeat>
        <repeat name="highlight" title="Colour by" min="0">
            <param name="name" type="text" label="Feature name" help="If all the above SCE inputs have this field, then assign a colour to (e.g. 'plate_number', 'is_control_cell')" />
        </repeat>
    </inputs>

    <outputs>
        <data name="out_html" format="html" label="${tool.name} on ${on_string} : Normalisation Report" />
    </outputs>
    <tests>
        <test>
            <repeat name="inp_rdats" >
                <param name="sce" value="filtered_out_none.rds" />
                <param name="name" value="scater None" />
            </repeat>
            <repeat name="inp_rdats" >
                <param name="sce" value="filtered_out_RLE.rds" />
                <param name="name" value="scater RLE" />
            </repeat>
            <repeat name="inp_rdats" >
                <param name="sce" value="filtered_out_scran_default.rds" />
                <param name="name" value="scran Default" />
            </repeat>
            <output name="out_html" value="normalplot1.html" />
        </test>
        <test>
            <repeat name="inp_rdats" >
                <param name="sce" value="filtered_out_scran_opts.rds" />
                <param name="name" value="scater Opts" />
            </repeat>
            <repeat name="inp_rdats" >
                <param name="sce" value="filtered_out_TMM.rds" />
                <param name="name" value="scater TMM" />
            </repeat>
            <repeat name="inp_rdats" >
                <param name="sce" value="filtered_out_UQ.rds" />
                <param name="name" value="scran UQ" />
            </repeat>
            <!-- <repeat name="highlight" > -->
            <!--     <param name="name" value="plate_number" /> -->
            <!-- </repeat> -->
            <output name="out_html" value="normalplot2.html" />
        </test>        
    </tests>
    <help><![CDATA[
empty
        ]]>
    </help>
    <expand macro="citations" />
</tool>
