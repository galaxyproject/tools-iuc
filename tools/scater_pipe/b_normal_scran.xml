<tool id="normalise_scran" name="SCRAN Normalisation" version="@VERSION@.0">
    <!-- TODO:
         - Help text
         -->
    <description>Normalise a SCE count matrix</description>
    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements" >
            <requirement type="package" version="1.6.2">bioconductor-scran</requirement>
    </expand>

    <command detect_errors="exit_code"><![CDATA[
    Rscript '@SCRIPT_DIR@/scran_normalise.R' '@SCRIPT_DIR@' '$rconf_norm' &&
    mv sce_out.rds '${out_rdat}'
    ]]></command>

    <configfiles>
        <configfile name="rconf_norm" >
# General Args
sce = readRDS( '$inp_rdat' )
qclust_perform = F
qclust_minsize = NULL
#if '$qclust.perform.value' == 'T':
qclust_minsize = as.integer('$qclust.minsize')
#end if

# sizes = ignore for now
c_min_mean = as.numeric('$min_mean')
c_positive = as.logical('$use_linear')
        </configfile>
    </configfiles>

    <inputs>
        <expand macro="input_rdat" />
        <conditional name="qclust" >
            <param name="perform" type="select" label="Perform initial clustering using qclust" >
                <option value="T">Yes</option>
                <option value="F" selected="true" >No</option>
            </param>

            <when value="F" />
            <when value="T" >
                <param name="minsize" type="integer" min="1" value="2" label="Minimum size of each cluster" />
            </when>
        </conditional>
        <param name="min_mean" type="float" min="1e-5" value="1" label="Minimum (library-sized adjusted) average count of genes to be used for normalisation." />
        <param name="use_linear" type="boolean" truevalue="T" falsevalue="F" checked="false" label="Use linear inverse models to enforce positive estimates?" />
    </inputs>

    <outputs>
        <expand macro="output_rdat" />
    </outputs>
    <tests>
        <test>
            <param name="inp_rdat" value="filtered.rds" />
            <output name="out_rdat" value="filtered_out_scran_default.rds" />
        </test>
        <test>
            <param name="inp_rdat" value="filtered.rds" />
            <param name="perform" value="T" />
            <param name="minsize" value="3" />
            <param name="min_mean" value="1" />
            <param name="use_linear" value="F" />
            <output name="out_rdat" value="filtered_out_scran_opts.rds" />
        </test>
    </tests>
    <help><![CDATA[

    see: https://www.rdocumentation.org/packages/scran/versions/1.0.3/topics/Normalized%20Expression

        ]]>
    </help>
    <expand macro="citations" />
</tool>
