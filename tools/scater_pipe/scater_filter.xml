<tool id="scater_filter" name="Scater Filter" version="@VERSION@.0">
    <description>Filter a scRNA count matrix or table</description>
    <macros>
    </macros>

    <command detect_errors="exit_code"><![CDATA[
    Rscript '@SCRIPT_DIR@/scater_filter.R' '@SCRIPT_DIR@' '$rconf_filter' &&

    mv table.stats '${out_stats}' &&
    mv table.counts '${out_table}' &&
    mv table.rds '${out_rdat}' &&

    mkdir '${out_html_report.files_path}' &&
    cp OUT_*.svg '${out_html_report.files_path}' &&

    echo "<html>
    <head></head><body>
    <h1>Cell and Feature Histograms -- Pre-filtered Data with QC cut-offs in red</h1><br />
    <img src=\"OUT_prefilter_totalcounts.svg\" ><br />
    <img src=\"OUT_prefilter_totalgenes.svg\" ><br />
    </body></html>" > '$out_html_report'

    ]]></command>

    <configfiles>
        <configfile name="rconf_filter" >
# General Args
count_matrix = '$inp_table'
min_cell_trans = as.integer( '$min_cell_trans' )
min_gene_trans = as.integer( '$min_gene_trans' )
gdetect_mintrans = as.integer( '$gdetect.mintrans' )
gdetect_mincells = as.integer( '$gdetect.mincells' )
filterout = '$genenames_grep'

# Advanced Args
col_header= as.logical( '$advanced.col_header' )
row_head= as.integer( '$advanced.row_head' )
commchar= as.character( '$advanced.commchar' )
        </configfile>
    </configfiles>

    <inputs>
        <param name="inp_table" type="tabular" label="Input count matrix" help="A matrix of cell columns and transcript rows, with the first row denoting cell headers and the first column denoting transcript names. (Specify otherwise in the advanced parameters.)" />
        <param name="min_cell_trans" type="integer" value="3000" label="Minimum total cell transcripts" help="Cells with a column sum less than this amount are discarded." />
        <param name="min_gene_trans" type="integer" value="0" label="Minimum total gene transcripts" help="Genes with a row sum less that this amount are discarded. It is advised not to filter based on this metric too stringently since transcripts counts across rows are likely to change after normalisation." />
        <section name="gdetect" title="Gene Detectability" expanded="true" >
            <param name="mintrans" type="integer" value="0" label="Minimum level of transcripts a gene must have in a particular cell to make it 'detectable'." />
            <param name="mincells" type="integer" value="2" label="Minimum number of cells a gene must be 'detectable' within." />
        </section>

        <section name="advanced" title="Advanced Input Parameters" >
            <param name="col_header" type="boolean" value="true" label="Matrix has header row?" />
            <param name="row_head" type="boolean" truevalue="1" falsevalue="0" value="true" label="Matrix has header row?" />
            <param name="commchar" type="string" value="|" label="Comment character" />
        </section>
    </inputs>
    <outputs>
        <data name="out_stats" format="tabular" label="${tool.name} on ${on_string}: Stats"/>
        <data name="out_table" format="txt" label="${tool.name} on ${on_string}: Filtered Table" />
        <data name="out_rdat" format="rdata.sce" label="${tool.name} on ${on_string} : SCE Rdata" />
        <data name="out_html_report" format="html" label="${tool.name} on ${on_string} : Report" />
    </outputs>
    <tests>
        <test>
        </test>
    </tests>
    <help><![CDATA[


UMI-tools whitelist - Extract barcodes from fastq
==================================================

Purpose
-------

Extract cell barcodes and identify the most likely true barcodes using
the 'knee' method.

Options
-------

--bc-pattern
       This should be used where the barcodes are always in the same
       place in the read.

       - N = UMI position (required)
       - C = cell barcode position (optional)
       - X = sample position (optional)

       Bases with Ns and Cs will be extracted and added to the read
       name. The corresponding sequence qualities will be removed from
       the read. Bases with an X will be reattached to the read.

       E.g. If the pattern is NNNNCC,
       Then the read:
       @HISEQ:87:00000000 read1
       AAGGTTGCTGATTGGATGGGCTAG
       DA1AEBFGGCG01DFH00B1FF0B
       +
       will become:
       @HISEQ:87:00000000_TT_AAGG read1
       GCTGATTGGATGGGCTAG
       1AFGGCG01DFH00B1FF0B
       +

       where 'TT' is the cell barcode and 'AAGG' is the UMI.


--set-cell-number
        Use this option to explicity set the number of cell barcodes
        which should be accepted. Note that the exact number of cell
        barcodes in the outputted whitelist may be slightly less than
        this if there are multiple cells observed with the same
        frequency at the threshold between accepted and rejected cell
        barcodes.

--expect-cells=[EXPECTED_CELLS]
        An upper limit estimate for the number of inputted cells. The knee
        method will now select the first threshold (order ascendingly)
        which results in the number of cell barcodes accepted being <=
        EXPECTED_CELLS and > EXPECTED_CELLS * 0.1.


--bc-pattern2
       Use this option to specify the format of the UMI/barcode for
       the second read pair if required. If --bc-pattern2 is not
       supplied, this defaults to the same pattern as --bc-pattern

--3prime
       By default the barcode is assumed to be on the 5' end of the read, but
       use this option to sepecify that it is on the 3' end instead

Usage:
------

For single ended reads:
        umi_tools whitelist --bc-pattern=[PATTERN] -L extract.log
        [OPTIONS]

reads from stdin and outputs to stdout.

For paired end reads where the cell barcodes is split across the read pairs:
        umi_tools whitelist --bc-pattern=[PATTERN]
        --bc-pattern2=[PATTERN] --read2-in=[FASTQIN] -L extract.log
        [OPTIONS]

reads end one from stdin and end two from FASTQIN and outputs to stdin


Output:
-------

The whitelist is outputted as 4 tab-separated columns:

    1. whitelisted cell barcode
    2. Other cell barcode(s) (comma-separated) to correct to the
       whitelisted barcode
    3. Count for whitelisted cell barcodes
    4. Count(s) for the other cell barcode(s) (comma-separated)

example output:

    AAAAAA      AGAAAA          146     1
    AAAATC                      22
    AAACAT                      21
    AAACTA      AAACTN,GAACTA   27      1,1
    AAATAC                      72
    AAATCA      GAATCA          37      3
    AAATGT      AAAGGT,CAATGT   41      1,1
    AAATTG      CAATTG          36      1
    AACAAT                      18
    AACATA                      24

If --error-correct-threshold is set to 0, columns 2 and 4 will be empty.


    ]]></help>
    <expand macro="citations" />
</tool>
