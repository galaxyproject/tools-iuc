<?xml version="1.0" encoding="utf-8"?>
<tool id="scanpy-find-markers" name="Scanpy FindMarkers" version="0.0.2">
  <macros>
    <import>scanpy_macros.xml</import>
  </macros>
  <expand macro="requirements"/>
  <command detect_errors="exit_code"><![CDATA[
ln -s $input_obj_file input.h5;
scanpy-find-markers.py -i input.h5
                       -f $input_format
                       -o output.h5
                       -F $output_format
		       -n $n_genes
#if $output_markers
                       --output-text-file output.csv
#end if
#if $settings.default == "false"
                       -g $settings.group_by
                       --reference $settings.reference
                       --method $settings.method
    #if $settings.use_raw == "false"
                       --no-raw
    #end if
    #if $settings.use_abs
                       --rankby_abs
    #end if
    #if $settings.groups
                       --groups $settings.groups
    #end if
#end if
]]></command>

  <inputs>
    <expand macro="input_object_params"/>
    <expand macro="output_object_params"/>
    <param name="n_genes" type="integer" label="Number of top genes to show per group/cluster" value="50"/>
    <param name="output_markers" type="boolean" label="Output markers table in csv format" checked="true"/>
    <conditional name="settings">
      <param name="default" type="boolean" label="Use programme defaults" checked="true"/>
      <when value="true"/>
      <when value="false">
	<param name="group_by" type="text" label="The sample grouping/clustering to use." value="louvain"/>
	<param name="use_raw" type="boolean" label="Use raw attribute if present" checked="true"/>
	<param name="reference" type="text" label="If 'rest', compare to the union of the rest of the group/cluster. If a group identifier, compare to that group" value="rest">
	  <option value="rest">rest</option>
	</param>
	<param name="method" type="select" label="Method for testing differentially expressed genes">
	  <option value="t-test_overestim_var" selected="true">t-test with over-estimated variance</option>
	  <option value="t-test">t-test</option>
	  <option value="wilcoxon">wilcoxon test, currently broken don't use</option>
	  <option value="logreg">logistic regression</option>
	</param>
	<param name="use_abs" type="boolean" label="Rank by absolute value of the scores instead of the scores" checked="false"/>
	<param name="groups" type="text" label="Subset of groups/clusters to which comparisons shell be restricted." optional="true"/>
      </when>
    </conditional>
  </inputs>

  <outputs>
    <data name="output_h5" format="h5" label="" from_work_dir="output.h5"/>
    <data name="output_txt" format="csv" label="" from_work_dir="output.csv">
      <filter>output_markers</filter>
    </data>
  </outputs>

  <tests>
    <test>
      <param name="input_obj_file" value="find_cluster.h5"/>
      <param name="input_format" value="anndata"/>
      <param name="output_format" value="anndata"/>
      <param name="output_txt" value="true"/>
      <param name="n_genes" value="50"/>
      <param name="default" value="false"/>
      <param name="group_by" value="louvain"/>
      <param name="method" value="t-test_overestim_var"/>
      <param name="use_abs" value="false"/>
      <output name="output_h5" file="find_markers.h5" ftype="h5" compare="sim_size"/>
      <output name="output_txt" file="find_markers.txt" ftype="csv"/>
    </test>
  </tests>

  <help><![CDATA[
usage: scanpy-find-cluster.py [options]

optional arguments:
  -h, --help            show this help message and exit

  --debug               Print debug information.

  -i INPUT_OBJECT_FILE, --input-object-file INPUT_OBJECT_FILE
                        Path to anndata or loom file.

  -f {loom,anndata,auto-detect}, --input-format {loom,anndata,auto-detect}
                        Format for input object: loom/anndata/[auto-detect].

  -o OUTPUT_OBJECT_FILE, --output-object-file OUTPUT_OBJECT_FILE
                        File name in which to store serialized python object.

  -F {loom,anndata,auto-detect}, --output-format {loom,anndata,auto-detect}
                        Format for output object: loom/anndata/[auto-detect].

  --output-text-file OUTPUT_TEXT_FILE
                        File name in which to store text format set of clusters

  --flavor {vtraag,igraph}
                        Choose between two packages for computing the clustering."vtraag" is much more
                        powerful, and the default.

  --resolution RESOLUTION
                        For the default flavor "vtraag", you can provide a resolution (higher resolution means
                        finding more and smaller clusters). Default: 1.0

  --restrict-to RESTRICT_TO
                        Restrict the clustering to the categories within the key for sample annotation, tuple
                        needs to contain (obs key, list of categories).

  --key-added KEY_ADDED
                        Key under which to add the cluster labels. Default: louvain

  --use-weights         Use weights from knn graph.

  -s RANDOM_SEED, --random-seed RANDOM_SEED
                        The seed used to initialise optimisation. Default: 0


]]></help>
  <expand macro="citations"/>
</tool>
