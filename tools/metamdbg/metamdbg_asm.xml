<tool id="metamdbg_asm" name="metaMDBG assemble" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@" license="MIT">
  <description>Assemble long-read metagenomes (HiFi / ONT)</description>
  <macros><import>macros.xml</import></macros>
  <expand macro="edam"/>
  <requirements><requirement type="package" version="@TOOL_VERSION@">metamdbg</requirement></requirements>
  <version_command>metaMDBG --version</version_command>
  <stdio><exit_code range="1:" level="fatal"/></stdio>

  <command detect_errors="exit_code"><![CDATA[
    mkdir -p assemblyDir ;

    ## Build space-separated reads list from datasets and/or collection
    #set reads_list = []
    #if $reads
      #for $r in $reads
        #set $x = $reads_list.append($r.file_name)
      #end for
    #end if
    #if $reads_collection
      #for $c in $reads_collection
        #set $y = $reads_list.append($c.file_name)
      #end for
    #end if
    #set READS_ARG = " ".join($reads_list)

    #if $read_type == "hifi"
      #set READ_FLAG = "--in-hifi"
    #else
      #set READ_FLAG = "--in-ont"
    #end if

    metaMDBG asm --out-dir assemblyDir $READ_FLAG $READS_ARG --threads ${GALAXY_SLOTS:-4} ;

    ## Bundle the assembly directory (portable input for metamdbg_gfa)
    tar -C assemblyDir -czf assemblyDir.tgz . ;
  ]]></command>

  <inputs>
    <param name="read_type" type="select" label="Read type">
      <option value="hifi">PacBio HiFi</option>
      <option value="ont">Nanopore R10.4+</option>
    </param>
    <section name="inputs" title="Input reads">
      <param name="reads" type="data" format="fastq,fastq.gz,fastqsanger,fastqsanger.gz" multiple="true" optional="true" label="FASTQ file(s)"/>
      <param name="reads_collection" type="data_collection" collection_type="list" optional="true" label="OR: FASTQ collection (list)"/>
    </section>
  </inputs>

  <outputs>
    <data name="contigs" format="fasta.gz" from_work_dir="assemblyDir/contigs.fasta.gz" label="metaMDBG contigs on ${on_string}"/>
    <data name="assembly_bundle" format="tar.gz" from_work_dir="assemblyDir.tgz" label="metaMDBG assembly bundle (tar)"/>
  </outputs>

  <tests>
    <test expect_num_outputs="2">
      <param name="read_type" value="hifi"/>
      <param name="reads" value="hifi_reads_small.fastq.gz"/>
      <output name="contigs">
        <assert_contents>
          <has_text text=">ctg"/>
          <has_text text="length="/>
          <has_text text="coverage="/>
          <has_text text="circular="/>
        </assert_contents>
      </output>
      <output name="assembly_bundle" ftype="tar.gz"/>
    </test>
  </tests>

    <help><![CDATA[
    **metaMDBG** assembles long, accurate metagenomic reads using a minimizer-space de Bruijn graph.
    It supports **PacBio HiFi** (`--in-hifi`) and **ONT R10.4+** (`--in-ont`) inputs.

    **Inputs**
    - One or more FASTQ files (you can multi-select) *or* a list **collection** of FASTQs.
    - Choose the read type to map to `--in-hifi` or `--in-ont`.

    **Outputs**
    - `contigs.fasta.gz` in the output directory (`assemblyDir`).
    - Optional `*.gfa` graph when "Generate assembly graph" is enabled.

    **Notes**
    - For ONT data, read-path annotations in GFA may be less accurate than for HiFi.

    More info: GitHub README and the Nature Biotechnology paper describing metaMDBG.]]>
    </help>
  <expand macro="citations"/>
</tool>

