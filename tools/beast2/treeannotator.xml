<tool id="beast2_treeannotator" name="TreeAnnotator" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Summarize a sample of trees with annotations</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        treeannotator
        -heights '$heights'
        #if $burnin_source.burnin_selector == 'percentage':
            -burnin $burnin_source.burnin_percent
        #end if
        #if $limit:
            -limit $limit
        #end if
        #if $target:
            -target '$target'
        #end if
        $force_discrete
        #if $hpd2d_options.hpd2d_selector == 'set_hpd':
            -hpd2D $hpd2d_options.hpd2d_value
        #elif $hpd2d_options.hpd2d_selector == 'no_hpd':
            -nohpd2D
        #end if
        $no_sa
        '$input'
        '$output'
    ]]></command>
    <inputs>
        <param name="input" type="data" format="beast.trees" label="Input tree file" help="File containing a sample of trees (from BEAST MCMC output)"/>
        <param argument="-heights" type="select" label="Node heights" help="How to summarize node heights across trees">
            <option value="keep" selected="true">Keep target tree heights</option>
            <option value="median">Median heights</option>
            <option value="mean">Mean heights</option>
            <option value="ca">Common ancestor heights</option>
        </param>
        <conditional name="burnin_source">
            <param name="burnin_selector" type="select" label="Specify burn-in">
                <option value="percentage">Specify burn-in percentage</option>
                <option value="none" selected="true">No burn-in (use all trees)</option>
            </param>
            <when value="percentage">
                <param name="burnin_percent" type="integer" value="10" min="0" max="100" label="Burn-in percentage" help="Percentage of trees to discard as burn-in"/>
            </when>
            <when value="none"/>
        </conditional>
        <param argument="-limit" type="float" optional="true" min="0" max="1" label="Posterior probability limit" help="Minimum posterior probability for a node to be annotated (optional)"/>
        <param argument="-target" type="data" format="txt,nhx,nex" optional="true" label="Target tree" help="Optional user-specified target tree to be annotated"/>    
        <param argument="-force_discrete" type="boolean" truevalue="-forceDiscrete" falsevalue="" label="Force discrete traits" help="Forces integer traits to be treated as discrete traits"/>
        <conditional name="hpd2d_options">
            <param name="hpd2d_selector" type="select" label="Bivariate trait HPD options">
                <option value="default" selected="true">Use default HPD settings</option>
                <option value="set_hpd">Set custom HPD interval</option>
                <option value="no_hpd">Suppress HPD calculation</option>
            </param>
            <when value="default"/>
            <when value="set_hpd">
                <param name="hpd2d_value" type="float" value="0.95" min="0" max="1" label="HPD interval for bivariate traits" help="The HPD (Highest Posterior Density) interval to be used"/>
            </when>
            <when value="no_hpd"/>
        </conditional>
        <param argument="no_sa" type="boolean" truevalue="-noSA" falsevalue="" label="Not sampled ancestor analysis" help="Interpret the tree set as NOT being from a sampled ancestor analysis, even if there are zero branch lengths"/>
    </inputs>
    <outputs>
        <data name="output" format="beast.trees" label="${tool.name} on ${on_string}: Annotated tree"/>
    </outputs>

    <tests>
        <!-- Testing -height option -->
        <test expect_num_outputs="1">
            <param name="input" value="input.trees"/>
            <param name="heights" value="keep"/>
            <output name="output" file="output.trees" compare="diff"/>
        </test>
        <!-- Testing -burnout option -->
        <test expect_num_outputs="1">
            <param name="input" value="input.trees"/>
            <param name="heights" value="median"/>
            <conditional name="burnin_source">
                <param name="burnin_selector" value="percentage"/>
                <param name="burnin_percent" value="1"/>
            </conditional>
            <output name="output" file="output_burnout.trees" compare="diff"/>
        </test>
        <!-- Testing -limit option -->
        <test expect_num_outputs="1">
            <param name="input" value="input.trees"/>
            <param name="heights" value="mean"/>
            <param name="limit" value="0.9"/>
            <output name="output" file="output_limit.trees" compare="diff"/>
        </test>
        <!-- Testing -target option -->
        <test expect_num_outputs="1">
            <param name="input" value="input.trees"/>
            <param name="heights" value="ca"/>
            <param name="target" value="target.trees"/>
            <output name="output" file="output_target.trees" compare="diff"/>
        </test>
        <!-- Testing -hpd2D option -->
        <test expect_num_outputs="1">
            <param name="input" value="input.trees"/>
            <param name="heights" value="ca"/>
            <conditional name="hpd2d_options">
                <param name="hpd2d_selector" value="set_hpd"/>
                <param name="hpd2d_value" value="0.95"/>
            </conditional>
            <output name="output" file="output_hpd.trees" compare="diff"/>
        </test>
        <!-- Testing -noSA option -->
        <test expect_num_outputs="1">
            <param name="input" value="input.trees"/>
            <param name="no_sa" value="true"/>
            <output name="output" file="output_no_sa.trees" compare="diff"/>
        </test>
    </tests>
    
    <help><![CDATA[
**What it does**

TreeAnnotator summarizes a sample of trees from a posterior distribution (those produced by BEAST) 
into a single annotated tree. It can calculate summary statistics for node heights and other parameters, 
and annotate the tree with posterior probabilities and other relevant information.

**Input**

The input should be a file containing multiple trees in Trees format typically from an MCMC analysis.

**Options**

- **Node heights**: Method for summarizing node heights across the tree sample
  
  - *Keep*: Retain the heights from a target tree
  - *Median*: Use median heights across all trees
  - *Mean*: Use mean heights across all trees  
  - *Common ancestor (CA)*: Use heights from common ancestor nodes

- **Burn-in**: Percentage of initial trees to discard as burn-in period

- **Posterior probability limit**: Only annotate nodes with posterior probability above this threshold

- **Target tree**: Optionally provide a specific tree topology to annotate

- **Force discrete**: Treat integer-valued traits as discrete rather than continuous

- **Bivariate HPD**: Options for calculating highest posterior density intervals for two-dimensional traits

- **Not sampled ancestor**: Use when trees are not from sampled ancestor analysis

**Output**

A single annotated tree file containing summary information from the posterior tree distribution.

    ]]></help>
    <expand macro="citations"/>
    <expand macro="creator"/>
</tool>