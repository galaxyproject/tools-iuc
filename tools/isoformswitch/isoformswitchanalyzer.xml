<tool id="isoformswitchanalyzer" name="IsoformSwitchAnalyzeR" version="@TOOL_VERSION@+galaxy@SUFFIX_VERSION@">
    <description>statistical identification of isoform switching</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro='requirements'/>
    <expand macro='xrefs'/>
    <stdio>
        <regex match="Execution halted"
           source="both"
           level="fatal"
           description="Execution halted." />
        <regex match="Error in"
           source="both"
           level="fatal"
           description="An undefined error occurred, please check your input carefully and contact your administrator." />
        <regex match="Fatal error"
           source="both"
           level="fatal"
           description="An undefined error occurred, please check your input carefully and contact your administrator." />
    </stdio>
    <command><![CDATA[
            mk -p 'input_files' &&
            #if $function_mode.tool_selector == 'stringtie'
                #set $filename = 't_data.ctab'
            #else
                #set $filename = 't_data.ctab' ################ NEEDS TO BE RENAMED
            #end if
            #for $index,$factor in enumerate($select_data.factorLevel):
                #set $outdir = './input_files/${factor}${index}/'
                mkdir $outdir &&
                ln -s $select_data.trans_counts[$index] '${outdir}${filename}' &&
            #end for
            Rscript '${__tool_directory__}/IsoformSwitchAnalyzerR.R'

]]></command>
    <inputs>
    <conditional name="function_mode">
        <param name="selector" type="select" label="Tool function mode" 
            help="The first step of a IsoformSwitchAnalyzeR workflow is to import and integrate the isoform quantification 
                with its basic annotation. Once you have all the relevant data imported into R (IsoformSwitchAnalyzeR will 
                also help you with that), the workflow for identification and analysis of isoform switches with functional 
                consequences can be divided into two parts.">
            <option value="data_import">Analysis part 1: Import data</option>
            <option value="first_step">Analysis part 2: Extract isoform switches and their sequences</option>
            <option value="second_step">Analysis part 3: Plot all isoform switches and their annotation</option>
        </param>
        <when value="data_import">
            <param name="tool_selector" type="select" label="Quantification data source" help="IsoformSwitchAnalyzeR has different functions for importing data">
                <option value="stringtie">StringTie</option>
                <option value="salmon">Salmon/Kallisto</option>
            </param>
            <repeat name="rep_factorLevel" title="Factor level" min="2" default="2">
                <param name="factorLevel" type="text" value="FactorLevel" label="Specify a factor level, typical values could be 'tumor' or 'treated'"
                    help="Only letters, numbers and underscores will be retained in this field">
                    <sanitizer>
                        <valid initial="string.letters,string.digits"><add value="_" /></valid>
                    </sanitizer>
                </param>
                <param name="trans_counts" type="data" format="tabular" multiple="true" 
                    label="Transcript-level expression measurements" help="It is generate by Stringtie with the -B option." /> 
            </repeat>
            <param name="genome_annotation" type="data" format="gtf,gtf.gz" label="Genome annotation (GTF)" 
                help="It is used to integrate the coding sequence (CDS) regions from in the GTF file as the ORF regions used by IsoformSwitchAnalyzeR." />
            <param name="transcriptome" type="data" format="fasta,fasta.gz" label="Transcriptome" 
                help="Please note this different from a fasta file with the sequences of the entire genome." />
            <param name="fixed_quantification" type="boolean" truevalue="true" falsevalue="false" checked="true" 
                label="Fix StringTie annotation problem" help="This option will automatically try and correct some of the annoation problems created when 
                    doing transcript assembly (unassigned transcripts and merged genes)." />
        </when>
        <when value="first_step">
            <section name="prefilter" title="Pre-filter parameters" help="SwitchAnalyzeR will remove genes/isoforms with the aim of allowing faster
                processing time as well as more trustworthy results." expanded="true">
                <param argument="geneExpressionCutoff" type="float" min="0" value="1" label="Gene expression cutoff" help="The expression cutoff (most 
                    likely in TPM/RPKM/FPKM) which the average expression in BOTH condisions must be higher than." />
                <param argument="isoformExpressionCutoff" type="float" min="0" value="0" label="Isoform expresion cutoff" help="The expression cutoff (most 
                    likely in RPKM/FPKM) which isoforms must be expressed more than, in at least one conditions of a comparison. Default is 0 (which removes 
                    completely unused isoforms)." />                
            </section>
            <section name="dexseq" title="DEXseq parameters" help="DEXSeq is used to test isoforms (isoform resolution) for differential isoform usage." expanded="true">
                <param argument="alpha" type="float" min="0" max="1" value="0.05" label="Alpha value" help="The cutoff which the FDR correct p-values must be 
                    smaller than for calling significant switches." />
            </section>    
            <section name="novel_isoform" title="Novel isoform analysis parameters" help="For the subset of isoforms not already annotated with ORFs this 
                function predicts the most likely Open Reading Frame (ORF) and the NMD sensitivity. This function is made to help annotate
                isoforms if you have performed (guided) de-novo isoform reconstruction (isoform deconvolution)." expanded="true">
                <param argument="minORFlength" type="integer" min="0" value="100" label="Minimum ORF length" help="The minimum size (in nucleotides) an ORF must be to be considered (and reported). Please note that we recommend using CPAT to predict coding potential
                instead of this cutoff. Default is 100 nucleotides, which around 97.5% of Gencode coding isoforms in both human and mouse have." />
            </section>         
            <section name="extract_sequence" title="Sequence extraction parameters" help="switchAnalyzeR will extracts the nucleotide (NT) sequence of transcripts by 
                extracting and concatenating the sequences of a reference genome corresponding to the genomic coordinates of the isoforms. " expanded="true">
                <param argument="alpha" type="float" min="0" max="1" value="0.05" label="Alpha value" help="The cutoff which the FDR correct p-values must be smaller 
                than for calling significant switches." />
            </section>            
            <section name="summary" title="Summary generation parameters" expanded="true">
                <param argument="filterForConsequences" type="boolean" truevalue="true" falsevalue="false" checked="false" 
                    label="Filter for consquences" help="A logical indicating whether to filter for genes with functional consequences.
                        Requires that analyzeSwitchConsequences() have been run on the switchAnalyzeRlist. The output will then be the number of significant genes 
                        and isoforms originating from genes with predicted consequences" />
            </section>
        </when>
        <when value="second_step">
            <conditional name="coding_potential">
                <param name="selector" type="select" label="Include prediction of coding potential information" 
                    help="Integrate in the analysis de output from CPAT or CPC2.">
                    <option value="disabled">Disabled</option>
                    <option value="cpat">CPAT</option>
                    <option value="cpc2">CPC2</option>
                </param>
                <when value="disabled"/>
                <when value="cpat">
                    <param argument="analyzeCPAT" type="data" format="txt" label="CPAT result file" 
                        help=" Use default parameters and the nucleotide fasta file (_nt.fasta). If the webserver was used, download the tab-delimited 
                            result file (available at the bottom of the result page). If a stand-alone version was used, just supply the path to the result file" />
                </when>
                <when value="cpc2">
                    <param argument="analyzeCPC2" type="data" format="txt" label="CPC2 result file" 
                        help="Use default parameters and if required select the most similar species. If the webserver (batch submission) was used, 
                            download the tab-delimited result file (via the “Download the result” button). If a stand-alone version was just just supply the path to the result file" />
                </when>
            </conditional>
            <param argument="analyzePFAM" type="data" format="txt" multiple="true" optional="true" label="PFAM" help="Use default parameters and the amino acid fasta file (_AA.fasta). If the webserver 
                is used you need to copy/paste the result part of the mail you receive into an empty plain text document (notepad, sublimetext, TextEdit or similar 
                    (not Word)) and save that to a plain text (txt) file. The path to that file should be supplied. If a stand-alone version was used, just supply the 
                    path to the result file" />
            <param argument="analyzeSignalP" type="data" format="txt" multiple="true" optional="true" label="SignalP" help="Use the amino acid fasta file (_AA.fasta). If using the webserver SignalP 
                should be run with the parameter 'Short output (no figures)' under 'Output format' and one should select the appropriate 'Organism group'. When 
                using a stand-alone version SignalP should be run with the '-f summary' option. If using the webserver the results can be downloaded using the 
                'Downloads' button in the top-right corner where the user should select 'Prediction summary' and supply the path to the resulting file to the 
                'pathToSignalPresultFile' argument. If a stand-alone version was just supply the path to the summary result file." />
            <conditional name="disordered_regions">
                <param name="selector" type="select" label="Include prediction of intrinsically disordered Regions (IDR) information" 
                    help="Integrate in the analysis de output from CPAT or CPC2.">
                    <option value="disabled">Disabled</option>
                    <option value="iupred2a">IUPred2A</option>
                    <option value="netsurfp">NetSurfP-2</option>
                </param>
                <when value="disabled"/>
                <when value="iupred2a">
                    <param argument="AanalyzeIUPred2A" type="data" format="txt" label="IUPred2A result file" help="Can be gziped. If
                    multiple result files were created (multiple web-server runs) just supply all of them." />
                </when>
                <when value="netsurfp">
                    <param argument="analyzeNetSurfP2" type="data" format="txt,gz" multiple="true" label="NetSurfP-2 result file" help="Can be gziped. If
                    multiple result files were created (multiple web-server runs) just supply all of them." />
                </when>
            </conditional>


        </when>
    </conditional>


    </inputs>
    <outputs>

    </outputs>

    <tests>
    </tests>
    <help><![CDATA[
.. class:: infomark

Hello, world!

    ]]></help>
    <expand macro="citations" />
</tool>
