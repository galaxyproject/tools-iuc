<tool id="raceid_diffgene" name="RaceID differential gene expression analysis" version="@VERSION@.0">
1;5003;0c    <description>Identify differentially regulated genes</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
    Rscript "@SCRIPT_DIR@/raceID_diffgenes.R" "@SCRIPT_DIR@" '$rconf_source';

    #if "$gen_final_heat.value" == "T" or "$compare_clusters.do_compare_clusters.value" == "T":    
    mkdir "${out_html.files_path}" &&
    cp plot_*.png "${out_html.files_path}" &&

    echo "<html><head><title>${tool.name}</title>
    <body>
    <img src=\"plot_finalheat.png\" ><br />
    <img src=\"plot_diffgenes.png\" ><br />
    </body>
    </html>" > $out_html
    #end if

    
    ]]></command>

    <configfiles>
        <configfile name="rconf_source" >
            sc = readRDS( "$inp_rdat" )
            output_rdat = "$out_rdat"

            c_pval = as.numeric( "$pval" )
            generate_finheat = as.logical( "$gen_final_heat.value" )
            generate_extable = as.logical( "$gen_gexpr_table.value" )
            generate_robject = as.logical( "$genoutrdat.value" )
            compare_clusters = as.logical( "$compare_clusters.do_compare_clusters.value" )

            #if $compare_clusters.do_compare_clusters.value == "T":
            gene_name = "$compare_clusters.gene"
            clust1 = "$compare_clusters.cl1"
            clust2 = "$compare_clusters.cl2"
            mcount = "$compare_clusters.mincount"
            #end if
        </configfile>
    </configfiles>

    <inputs>
        <param name="inp_rdat" type="data" format="rdata" label="Count matrix with clusters" help="This file can be generated from a spreadsheet via the RaceID filter tool, but should preferably be the output of the RaceID outlier tool." />
        <param name="pval" type="float" value="0.01" min="1e-10" max="0.5" label="Retain genes with p-value smaller than threshold" help="The p-value for observing the difference in mean expression between the cluster and all cells based on binomial counting statistics." />
        <param name="gen_gexpr_table" type="boolean" checked="true" truevalue="T" falsevalue="F" label="Generate table of all differentially expressed genes?" />
        <param name="gen_final_heat" type="boolean" checked="true" truevalue="T" falsevalue="F" label="Generate a heatmap of the final clustering?" />
        <conditional name="compare_clusters">
            <param name="do_compare_clusters" type="select" label="Compare the expression of a specific gene between two sets of clusters?" >
                <option value="T" >Yes</option>
                <option value="F" selected="true" >No</option>
            </param>
            <when value="F" />
            <when value="T" >
                <param name="gene" type="text" label="Gene name of interest" >
                    <sanitizer invalid_char="" >
                        <valid initial="string.letters,string.digits">
                            <add value="_"/><add value="+" /><add value="-" />
                        </valid>
                    </sanitizer>
                </param>
                <param name="cl1" type="text" value="1" label="Cluster set 1" help="e.g. if you wish to compare cluster 2 to clusters 1 and 3, then type '2' here and '1,3' in the next input." >
                    <sanitizer invalid_char="" >
                        <valid initial="string.letters,string.digits"><add value="," /></valid>
                    </sanitizer>
                </param>
                <param name="cl2" type="text" value="2" label="Cluster set 2" help="You can also compare sets of clusters to one another: e.g. 1,4,5 against 2,3." >
                    <sanitizer invalid_char="" >
                        <valid initial="string.letters,string.digits"><add value="," /></valid>
                    </sanitizer>
                </param>
                <param name="mincount" type="integer" value="5" min="1" label="Only count genes with more than this number of transcripts in at least one cell within cl1 or cl2" />
            </when>
        </conditional>
        <param name="genoutrdat" type="boolean" checked="true" truevalue="T" falsevalue="F" label="Generate an additional R object?" help="This can be used as input for downstream RaceID analysis (e.g. clustering, differential expression and tSNE plots)" />
    </inputs>

    <outputs>
        <data name="out_html" format="html" label="${tool.name} on ${on_string}: Web Report" />
        <data name="out_rdat" format="rdata" label="${tool.name} on ${on_string}: RData" >
            <filter>genoutrdat.value == "T"</filter>
        </data>
        <collection name="out_tables" type="list" label="${tool.name} on ${on_string}: DiffExpr Tables" >
            <discover_datasets pattern="gdiff_.*" />
            <discover_datasets ext="tsv" />
            <discover_datasets format="tsv" />
            <discover_datasets format="tsv" />
            <discover_datasets pattern=".*" />
        </collection>
    </outputs>

    <tests>
        <test><!-- -->
            <param name="inp_rdat" value="trans_outlier.rds" />
            <output name="out_rdat" value="trans_diffgene.rds" />
            <output name="out_html" value="trans_diffgene.html" />
            <!-- verify just two of the outputs -->
            <output_collection name="out_tables" type="list" >
                <element name="gdiff_cl.1" file="gdiff_cl.1.tsv" />
                <element name="gdiff_cl.2" file="gdiff_cl.2.tsv" />
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[

    This module performs 

    ]]></help>
    <expand macro="citations" />
</tool>
