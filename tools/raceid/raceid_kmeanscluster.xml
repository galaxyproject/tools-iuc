<tool id="raceid_kmeansheatmap" name="RaceID k-means and heatmap" version="@VERSION@.0">
    <description>Perform k-means clustering and produce a heatmap</description>
    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements" />

    <command detect_errors="exit_code"><![CDATA[
    Rscript "@SCRIPT_DIR@/raceID_kmeans_heatmap.R" "@SCRIPT_DIR@" '$rconf_source' &&

    mkdir "${out_html.files_path}" &&
    cp kk_*.png "${out_html.files_path}" &&

    echo "<html><head><title>RaceID k-means plots</title>
    <body>
    <img src=\"kk_gap.png\" ><br />
    <img src=\"kk_jaccard.png\" ><br />
    <img src=\"kk_silhouette.png\" ><br />
    <img src=\"kk_clustheatmap.png\" ><br />
    </body>
    </html>" > $out_html    
    
    ]]></command>

    <configfiles>
        <configfile name="rconf_source">
            sc = readRDS( "$inp_rdat" )
            output_rdat = "$out_rdat"

            c_metric = "pearson"; c_cln = 0; dogap = T; c_clustnr = 20; bgap = 50;
            semethod = "Tibs2001SEmax"; sefactor = .25; c_bootnr = 50; c_rseed = 17000;

            #if $clustering.use_cluster_defaults == "Advanced Options":
            c_metric = "$clustering.metric"
            c_cln = as.integer( "$clustering.cln" )
            #if $clustering.gapstats.dogap.value == "T":
            dogap = as.logical( "$clustering.gapstats.dogap" )
            c_clustnr = as.integer( "$clustering.gapstats.clustnr" )
            bgap = as.integer( "$clustering.gapstats.bgap" )
            semethod = "$clustering.gapstats.semethod.value"
            sefactor = as.numeric( "$clustering.gapstats.sefactor" )
            #end if
            c_bootnr = as.integer( "$clustering.bootnr" )
            c_rseed = as.integer( "$clustering.rseed" )
            #end if
            generate_final_rdata = as.logical( $genoutrdat )
        </configfile>
    </configfiles>
    <inputs>
        <param name="inp_rdat" type="data" format="rdata" label="Count matrix (R SCseq object)" help="This file can be generated from a spreadsheet via the RaceID filter tool." />
        <conditional name="clustering">
            <param name="use_cluster_defaults" type="select" label="Clustering Parameters" >
                <option value="Use Defaults" selected="true" />
                <option value="Advanced Options" />
            </param>
            <when value="Use Defaults" />
            <when value="Advanced Options" >
                <param name="metric" type="select" label="Distance metric">
                    <option value="pearson" selected="true" />
                    <option value="spearman" />
                    <option value="kendall" />
                    <option value="euclidean" />
                    <option value="maximum" />
                    <option value="manhattan" />
                    <option value="canberra" />
                    <option value="binary" />
                    <option value="minkowski" />
                </param>

                <param name="cln" type="integer" value="0" min="0" label="Number of clusters for k-means" help="Leave as zero to automatically determine the number based on gap statistics" />
                
                <conditional name="gapstats">
                    <param name="dogap" type="select" label="Use gap statistics to determine clusters" >
                        <option value="T" selected="true" >Yes</option>
                        <option value="F" >No</option>
                    </param>

                    <when value="F" />
                    <when value="T" >
                        <param name="clustnr" type="integer" value="2" min="0" label="Maximum number of clusters for the computation of the gap statistic" help="If more major cell types are expected, a higher number than 2 should be chosen." />
                        <param name="bgap" type="integer" value="50" min="1" label="Number of bootstraps to run the gap statistic calculation" />
                        <param name="semethod" type="select" label="Method used for determining first local maximum" >
                            <option value="Tibs2001SEmax" selected="true" />
                            <option value="globalmax" />
                            <option value="firstmax" />
                            <option value="firstSEmax" />
                            <option value="globalSEmax" />                            
                        </param>

                        <param name="sefactor" type="float" value="0.25" min="0.0001" max="1" label="Fraction of the standard deviation that the local maximum must differ from neighbouring points." />
                    </when>
                </conditional>

                <param name="bootnr" type="integer" value="50" min="1" label="Number of bootstraps for clustering" />
                <param name="rseed" type="integer" value="17000" min="1" label="Seed value (for reproducibility)" />
            </when>
        </conditional>
        <param name="genoutrdat" type="boolean" checked="true" truevalue="T" falsevalue="F" label="Generate an additional R object?" help="This can be used as input for downstream RaceID analysis (e.g. outlier, clustering, differential expression and tSNE plots)" />           
    </inputs>
    
    <outputs>
        <data name="out_html" format="html" />
        <data name="out_rdat" format="rdata" >
            <filter>genoutrdat.value == "T"</filter>
        </data>
    </outputs>
    
    <tests>
        <test>
            <!-- Auto gap, clustering defaults, produce R obj. -->
            <param name="inp_rdat" value="trans_filter_ds.rds" />
            <output name="out_rdat" value="trans_kmeans.rds" />
            <output name="out_html" value="trans_kmeans.html" />
        </test>
        <test>
            <!-- Set k-value, no gap, no R obj, metrics and bootrepl. -->
            <param name="inp_rdat" value="trans_filter_ds.rds" />
            <param name="genoutrdat" value="F" />
            <param name="use_cluster_defaults" value="Advanced Options" />
            <param name="metric" value="manhattan" />
            <param name="cln" value="6" />
            <param name="dogap" value="F" />
            <param name="bootnr" value="10" />
            <output name="out_html" value="trans_kmeans.html" />
        </test>
        <test>
            <!-- Auto gap with gap params -->
            <param name="inp_rdat" value="trans_filter_ds.rds" />
            <param name="use_cluster_defaults" value="Advanced Options" />
            <param name="clustnr" value="5" />
            <param name="bgap" value="10" />
            <param name="semethod" value="globalSEmax" />
            <param name="sefactor" value="0.6" />
            <output name="out_html" value="trans_kmeans.html" />
            <output name="out_rdat" value="trans_kmeans_2.rds" />
        </test>
    </tests>
    <help><![CDATA[

    This module performs k-means clustering and plots gap statistics, jaccard similarity, silhoutte plots, and preliminary heatmap.
    
    ]]></help>
    <expand macro="citations" />
</tool>
