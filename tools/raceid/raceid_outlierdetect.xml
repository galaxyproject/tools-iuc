<tool id="raceid_outlierdetect" name="RaceID outlier detection" version="@VERSION@.0">
    <description>Detect outlier cells and genes</description>
    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements" />

    <command detect_errors="exit_code"><![CDATA[
    Rscript "@SCRIPT_DIR@/raceID_outlierdetect.R" "@SCRIPT_DIR@" '$rconf_source'
    ]]></command>

    <configfiles>
        <configfile name="rconf_source">
            sc = readRDS( "$inp_rdat" )
            output_rdat = "$out_rdat"

            # set defaults
            c_outminc = 5; c_outlg = 2; c_probthr = 2; c_outdistquant = 0.75;

            #if $outliers.use_outlier_defaults == "Advanced Options":
            c_outminc = as.integer( "$outliers.outminc" )
            c_outlg = as.integer( "$outliers.outlg" )
            c_probthr = as.numeric( "$outliers.probthr" )
            c_outdistquant = as.numeric( "$outliers.probthr" )
            #end if
            generate_final_rdata = as.logical( "$genoutrdat" )
        </configfile>
    </configfiles>
    <inputs>
        <param name="inp_rdat" type="data" format="rdata" label="Count matrix (R SCseq object)" help="This file can be generated from a spreadsheet via the RaceID filter tool, but should preferably be the output of the RaceID kmeans tool." />
        <conditional name="outliers">
            <param name="use_outlier_defaults" type="select" label="Outlier Parameters" >
                <option value="Use Defaults" selected="true" />
                <option value="Advanced Options" />
            </param>
            <when value="Use Defaults" />
            <when value="Advanced Options" >
                <param name="outminc" type="integer" value="5" min="1" label="Expression cutoff threshold for outlier genes"  />
                <param name="probthr" type="float" value="10e-3" min="10e-8" max="1" label="Probability threshold of observing a given gene expression level in a cell" help="If lower than this cutoff, the cell is considered an outlier for this gene." />
                <param name="outlg" type="integer" value="2" min="1" label="Minimal number of outlier genes required to flag an outlier cells" />
                <param name="outdistquant" type="select" label="Merge cells into outlier clusters if their similarity exceeds this quantile in a similarity distribution for all cell pairs" >
                    <option value="0.25">first (0.25)</option>
                    <option value="0.50">second (0.50)</option>
                    <option value="0.75">third (0.75)</option>
                </param>
            </when>
        </conditional>
        <param name="genoutrdat" type="boolean" checked="true" truevalue="T" falsevalue="F" label="Generate an additional R object?" help="This can be used as input for downstream RaceID analysis (e.g. clustering, differential expression and tSNE plots)" />
    </inputs>

    <outputs>
        <data name="out_html" format="html" />
        <data name="out_rdat" format="rdata" >
            <filter>genoutrdat.value == "T"</filter>
        </data>
    </outputs>

    <tests>
        <test>
            <param name="inp_rdat" value="trans_kmeans.rds" />
            <output name="out_rdat" value="trans_outlier.rds" />
            <output name="out_html" value="trans_outlier.html" />
        </test>
        <!-- <test> -->
        <!--     <param name="inp_count" value="transcript_counts_intestine_sub.tsv" /> -->
        <!--     <param name="do_filter" value="T" /> -->
        <!--     <param name="do_filter_defaults" value="Advanced Options" /> -->
        <!--     <param name="mintotal" value="10" /> -->
        <!--     <param name="minexpr" value="1" /> -->
        <!--     <param name="maxexpr" value="2000" /> -->
        <!--     <param name="do_downsample" value="T" /> -->
        <!--     <output name="out_table" value="transcript_output.tsv" /> -->
        <!--     <output name="out_rdat" value="trans_filter_ds.rds" /> -->
        <!-- </test> -->
    </tests>
    <help><![CDATA[

    This module perform k-means clustering and plots gap statistics, jaccard similarity, silhoutte plots, and preliminary heatmap.

    ]]></help>
    <expand macro="citations" />
</tool>
