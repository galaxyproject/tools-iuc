<tool id="raceid_outlierdetect" name="RaceID outlier detection" version="@VERSION@.0">
    <description>Detect outlier cells and genes</description>
    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements" />

    <command detect_errors="exit_code"><![CDATA[
    Rscript "@SCRIPT_DIR@/raceID_outlierdetect.R" "@SCRIPT_DIR@" '$rconf_source'
    ]]></command>

    <configfiles>
        <configfile name="rconf_source">
            sc = readRDS( "$inp_rdat" )
            output_rdat = "$out_rdat"
            output_table= "$out_table"

            # set defaults
            c_outminc = 5; c_outlg = 2; c_probthr = 1e-3; c_outdistquant = 0.75;

            #if $outliers.use_outlier_defaults == "Advanced Options":
            c_outminc = as.integer( "$outliers.outminc" )
            c_outlg = as.integer( "$outliers.outlg" )
            c_probthr = as.numeric( "$outliers.probthr" )
            c_outdistquant = as.numeric( "$outliers.probthr" )
            #end if
            generate_final_rdata = as.logical( "$genoutrdat" )
        </configfile>
    </configfiles>
    <inputs>
        <param name="inp_rdat" type="data" format="rdata" label="Count matrix (R SCseq object)" help="This file can be generated from a spreadsheet via the RaceID filter tool, but should preferably be the output of the RaceID kmeans tool." />
        <conditional name="outliers">
            <param name="use_outlier_defaults" type="select" label="Outlier Parameters" >
                <option value="Use Defaults" selected="true" />
                <option value="Advanced Options" />
            </param>
            <when value="Use Defaults" />
            <when value="Advanced Options" >
                <param name="outminc" type="integer" value="5" min="1" label="Expression cutoff threshold for outlier genes"  />
                <param name="probthr" type="float" value="1e-3" min="1e-8" max="1" label="Probability threshold of observing a given gene expression level in a cell" help="If lower than this cutoff, the cell is considered an outlier for this gene." />
                <param name="outlg" type="integer" value="2" min="1" label="Minimal number of outlier genes required to flag an outlier cells" />
                <param name="outdistquant" type="select" label="Merge cells into outlier clusters if their similarity exceeds this quantile in a similarity distribution for all cell pairs" >
                    <option value="0.25">first (0.25)</option>
                    <option value="0.50">second (0.50)</option>
                    <option value="0.75">third (0.75)</option>
                </param>
            </when>
        </conditional>
        <param name="genoutrdat" type="boolean" checked="true" truevalue="T" falsevalue="F" label="Generate an additional R object?" help="This can be used as input for downstream RaceID analysis (e.g. clustering, differential expression and tSNE plots)" />
    </inputs>

    <outputs>
        <data name="out_html" format="html" />
        <data name="out_table" format="tsv" />
        <data name="out_rdat" format="rdata" >
            <filter>genoutrdat.value == "T"</filter>
        </data>
    </outputs>

    <tests>
        <test><!-- With reduced minc -->
            <param name="inp_rdat" value="trans_outlier_in.rds" />
            <param name="use_outlier_defaults" value="Advanced Options" />
            <param name="outminc" value="1" />
            <output name="out_rdat" value="trans_outlier.rds" />
            <output name="out_html" value="trans_outlier.html" />
            <output name="out_table" value="trans_outlier1.tsv" />
        </test>
        <test><!-- No R out, other opts-->
            <param name="inp_rdat" value="trans_outlier_in.rds" />
            <param name="use_outlier_defaults" value="Advanced Options" />
            <param name="outminc" value="1" />
            <param name="probthr" value="1e-5" />
            <param name="outlg" value="10" />
            <param name="outdistquant" value="0.50" />
            <output name="out_html" value="trans_outlier.html" />
            <output name="out_table" value="trans_outlier2.tsv" />
        </test>

    </tests>
    <help><![CDATA[

    This module performs outlier detection by calibrating against a background noise model within each cluster, and searching for cells that fall outside of the transcript count distribution for that gene (modelled as a negative binomial). Cells that are outliers for more than a user-set amount of genes are suspected as being outlier cells.

    ]]></help>
    <expand macro="citations" />
</tool>
