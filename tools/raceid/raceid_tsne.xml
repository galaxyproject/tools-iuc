<tool id="raceid_tsne" name="RaceID tSNE plots for cell types and target genes" version="@VERSION@.0">
    <description>Produces multiple tSNE plots of cell clusters with highlighting for specific features such as genes of interest and known cell types</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
    Rscript "@SCRIPT_DIR@/raceID_tsne.R" "@SCRIPT_DIR@" '$rconf_source';

    mkdir "${out_html.files_path}" &&
    cp plot_*.png "${out_html.files_path}" &&

    echo "<html><head><title>RaceID tSNE</title>
    <body>
    <h3>Initial k-means clusters</h3>
    <br /><img src=\"plot_initial.png\" >
    <h3>Final clusters</h3>
    <br /><img src=\"plot_final.png\" >
    <h3>Labelled</h3>
    <br /><img src=\"plot_labels.png\" >
    <h3>Symbols</h3>
    <br /><img src=\"plot_symbols.png\" > " > $out_html

    #if $genexp.use_gexpr == "Yes":
        #for $gene_set in $genexp.all_sets:
    echo "<h3>Expression for: [$gene_set]</h3>" >> $out_html
    echo "<br /><img src=\"plot_$gene_set\" >" >> $out_html  ## Comma within filename...
        #end for
    #end if

    echo "</body></html>" >> $out_html

    ]]></command>

    <configfiles>
        <configfile name="rconf_source" >
            sc = readRDS( "$inp_rdat" )
            output_rdat = "$out_rdat"
            regex_val = ""
            c_rseed = "$rseed"
            gene_sets = ""
            #if $genexp.use_gexpr == "Yes":
            gene_sets = "#for $gs in $genexp.all_sets# ${gs} _split_ #end for#"
            regex_val = "$genexp.regex"
            #end if
            final_rdata = as.logical( "$final_rdata" )
        </configfile>
    </configfiles>

    <inputs>
        <param name="inp_rdat" type="data" format="rdata" label="Count matrix with clusters" help="This file can be generated from a spreadsheet via the RaceID filter tool, but should preferably be the output of the RaceID diffgene tool." />
        <conditional name="genexp" >
            <param name="use_gexpr" type="select" label="Highlight the expression of a set of (related) genes over all clusters?" >
                <option value="Yes" />
                <option value="No" selected="true" />
            </param>
            <when value="No" />
            <when value="Yes" >
                <param name="all_sets" type="text" multiple="true" label="Gene(s) of interest" help="e.g. 'Apoa1__chr9+Apoa1bp__chr6'" >
                    <sanitizer invalid_char="" >
                        <valid initial="string.letters,string.digits"><add value="+" /><add value="_" /><add value="-" /></valid>
                        <!-- comma use makes multiple test selection problematic -->
                    </sanitizer>
                </param>
                <param name="regex" type="text" value="" label="Regular expression to apply over cell labels to identify cell types" help="e.g. for barcodes [ cl_1_ACCAG, cl_1_ACGGA, cl_2_TTAC, ... ] can be grouped into [ cl_1, cl_2, ... ] by the expression: '_[ACTG]+', which removes the last '_' and any following characters belonging to A C T or G." >
                    <sanitizer invalid_char="" >
                        <valid initial="string.printable" />
                    </sanitizer>
                </param>
            </when>
        </conditional>
        <param name="rseed" type="integer" min="1" value="15555" label="Seed (for reproducibility)" />
        <expand macro="rdata_out" />
    </inputs>

    <outputs>
        <data name="out_html" format="html" label="${tool.name} on ${on_string}: Web Report" />
        <data name="out_rdat" format="rdata" label="${tool.name} on ${on_string}: RData" >
            <filter>genoutrdat.value == "T"</filter>
        </data>
    </outputs>

    <tests>
        <test>
            <param name="inp_rdat" value="trans_diffgene.rds" />
            <output name="out_rdat" value="trans_tsne1.rds" />
            <output name="out_html" value="trans_tsne1.html" />
        </test>
        <test>
            <param name="inp_rdat" value="trans_diffgene.rds" />
            <param name="use_gexpr" value="Yes" />
            <!--multiple value string does not parse.. -->
            <param name="all_sets" value="4930415F15Rik__chr11+4930430F21Rik__chr15+4930429B21Rik__chr3,4930425O10Rik__chr3+4930444A02Rik__chr8" />
            <param name="regex" value="[^_]+__" />
            <output name="out_rdat" value="trans_tsne2.rds" />
            <output name="out_html" value="trans_tsne2.html" />
        </test>

    </tests>
    <help><![CDATA[
    

This module performs.

    ]]></help>
    <expand macro="citations" />
</tool>
