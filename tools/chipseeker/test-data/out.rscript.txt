
options( show.error.messages=F, error = function () { cat( geterrmessage(), file=stderr() ); q( "no", 1, F ) } )

# we need that to not crash galaxy with an UTF8 error on German LC settings.
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

suppressPackageStartupMessages(library(ChIPseeker))

genome <- "hg19"

if (genome == "hg38") {
    suppressPackageStartupMessages({
        library(TxDb.Hsapiens.UCSC.hg38.knownGene)
        library(org.Hs.eg.db)
    })
    txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
    annodb <- "org.Hs.eg.db"
} else if (genome == "hg19") {
    suppressPackageStartupMessages({
        library(TxDb.Hsapiens.UCSC.hg19.knownGene)
        library(org.Hs.eg.db)
    })
    txdb <- TxDb.Hsapiens.UCSC.hg19.knownGene
    annodb <- "org.Hs.eg.db"
} else if (genome == "mm10") {
    suppressPackageStartupMessages({
        library(TxDb.Mmusculus.UCSC.mm10.knownGene)
        library(org.Mm.eg.db)
    })
    txdb <- TxDb.Mmusculus.UCSC.mm10.knownGene
    annodb <- "org.Mm.eg.db"
} else {
    cat(paste("Genome not supported", genome))
}

peaks <- readPeakFile('/private/var/folders/zn/m_qvr9zd7tq0wdtsbq255f8xypj_zg/T/tmp719830/files/000/dataset_1.dat')
peakAnno <-  annotatePeak(peaks, TxDb=txdb, annoDb=annodb)
write.table(peakAnno, file='/private/var/folders/zn/m_qvr9zd7tq0wdtsbq255f8xypj_zg/T/tmp719830/files/000/dataset_2.dat', sep="\t", row.names=FALSE, quote=FALSE)

if (!is.null("True")) {
    pdf("out.pdf", width=14)
    plotAnnoPie(peakAnno)
    plotAnnoBar(peakAnno)
    vennpie(peakAnno)
    upsetplot(peakAnno)
    plotDistToTSS(peakAnno, title="Distribution of transcription factor-binding loci\nrelative to TSS")
    dev.off()
}
    