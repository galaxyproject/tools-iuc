<tool id="ucsc_mafgene" name="mafGene" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@" license="MIT">
    <description>Output protein alignments using maf and genePred</description>
    <macros>
        <token name="@TOOL_VERSION@">490</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <token name="@PROFILE@">25.0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">ucsc-mafgene</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
        cp '$ucsc_db_connection' "\${HOME}/.hg.conf" &&
        chmod 600 "\${HOME}/.hg.conf" &&
        #if $twobit_source.twobit_selector == "cached"
            ln -s '${twobit_source.twobit_file.fields.path}' input.2bit &&
        #else
            ln -s '${twobit_source.twobit_file}' input.2bit &&
        #end if
        ln -s '$maf_file' "${maf_file.element_identifier}" &&
        ln -s '$genepred_file' "${genepred_file.element_identifier}" &&
        mafGene
        -twoBit=input.2bit
        '$db_name'
        "${maf_file.element_identifier}"
        "${genepred_file.element_identifier}"
        $species_list
        '$output'
        #if $gene_selection.selection_type == "single"
            -geneName='${gene_selection.gene_name}'
        #elif $gene_selection.selection_type == "list"
            -geneList='${gene_selection.gene_list}'
        #elif $gene_selection.selection_type == "bed"
            -geneBeds='${gene_selection.gene_beds}'
        #elif $gene_selection.selection_type == "chrom"
            -chrom='${gene_selection.chrom}'
        #end if
        $exons
        $noTrans
        $uniqAA
        $includeUtr
        $noDash
        ]]>
    </command>
        <configfiles>
        <configfile name="ucsc_db_connection"><![CDATA[
#European MariaDB server
db.host=genome-euro-mysql.soe.ucsc.edu
db.user=genomep
db.password=password
central.db=hgcentral
central.host=genome-euro-mysql.soe.ucsc.edu
central.user=genomep
central.password=password
gbdbLoc1=http://hgdownload.soe.ucsc.edu/gbdb/
forceTwoBit=on 
        ]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="twobit_source">
            <param name="twobit_selector" type="select" label="Choose 2bit file source">
                <option value="cached" selected="true">Use a built-in 2bit file</option>
                <option value="history">Use a 2bit file from history</option>
            </param>
            <when value="cached">
                <param name="twobit_file" type="select" label="Select 2bit reference genome">
                    <options from_data_table="lastz_seqs">
                        <filter type="sort_by" column="1"/>
                        <validator type="no_options" message="No .2bit files are available"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param name="twobit_file" type="data" format="twobit" label="Select 2bit file from history"/>
            </when>
        </conditional>
        <param name="db_name" type="text" label="Database name" value="hg38" help="Name of the genome database (e.g., hg19, mm10)"/>
        <param name="maf_file" type="data" format="maf" label="MAF alignment file"/>
        <param name="genepred_file" type="data" format="tabular" label="GenePred file"/>
        <param name="species_list" type="data" format="txt" label="Species list file" help="Text file with one species name per line"/>
        <conditional name="gene_selection">
            <param name="selection_type" type="select" label="Gene selection method">
                <option value="all" selected="true">All genes</option>
                <option value="single">Single gene by name</option>
                <option value="list">List of genes</option>
                <option value="bed">BED file with gene positions</option>
                <option value="chrom">All genes on chromosome</option>
            </param>
            <when value="all"/>
            <when value="single">
                <param name="gene_name" type="text" label="Gene name">
                    <validator type="empty_field" message="Gene name is required"/>
                </param>
            </when>
            <when value="list">
                <param name="gene_list" type="data" format="txt" label="File with list of gene names"/>
            </when>
            <when value="bed">
                <param name="gene_beds" type="data" format="bed" label="BED file with genes and positions"/>
            </when>
            <when value="chrom">
                <param name="chrom" type="text" label="Chromosome name" help="e.g., chr1">
                    <validator type="empty_field" message="Chromosome name is required"/>
                </param>
            </when>
        </conditional>
        <param argument="-exons" type="boolean" truevalue="-exons" falsevalue="" label="Output exons" help="Output exons instead of full genes"/>
        <param argument="-noTrans" type="boolean" truevalue="-noTrans" falsevalue="" label="Don't translate to amino acids" help="Keep nucleotide sequences"/>
        <param argument="-uniqAA" type="boolean" truevalue="-uniqAA" falsevalue="" label="Unique pseudo-AA for every codon" help="Put out unique pseudo-AA for every different codon"/>
        <param argument="-includeUtr" type="boolean" truevalue="-includeUtr" falsevalue="" label="Include UTRs" help="Include the UTRs (use only with 'Don't translate' option)"/>
        <param argument="-noDash" type="boolean" truevalue="-noDash" falsevalue="" label="Don't output all-dash lines" help="Skip lines with all dashes"/>
    </inputs>
    <outputs>
        <data name="output" format="fasta"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <conditional name="twobit_source">
                <param name="twobit_selector" value="history"/>
                <param name="twobit_file" location="https://zenodo.org/records/17962560/files/sacCer3.2bit"/>
            </conditional>
            <param name="db_name" value="sacCer3"/>
            <param name="maf_file" location="https://zenodo.org/records/17962560/files/sacCer3.bigMaf"/>
            <param name="genepred_file" location="https://zenodo.org/records/17962560/files/sgdGene.gp"/>
            <param name="species_list" location="https://zenodo.org/records/17962560/files/species.lst"/>
            <conditional name="gene_selection">
                <param name="selection_type" value="all"/>
            </conditional>
            <output name="output" location="https://zenodo.org/records/17962560/files/output.fasta"/>
        </test>
    </tests>

    <help><![CDATA[
**What it does**

mafGene extracts protein alignments from MAF (Multiple Alignment Format) files using gene predictions from genePred format files.

**Inputs**

- **2bit file**: Reference genome in 2bit format (either from built-in data tables or uploaded)
- **MAF/bigMaf file**: Multiple alignment file containing aligned sequences
- **GenePred file**: Gene predictions in genePred format
- **Species list**: Text file with one species name per line

**Gene Selection**

You can select genes to process using several methods:

- **All genes**: Process all genes in the genePred file
- **Single gene**: Process one specific gene by name
- **Gene list**: Process multiple genes from a file (one gene name per line)
- **BED file**: Process genes specified in a BED format file
- **Chromosome**: Process all genes on a specific chromosome

**Output Options**

- **Output exons**: Extract exons instead of full gene sequences
- **Don't translate**: Keep nucleotide sequences instead of translating to amino acids
- **Unique pseudo-AA**: Generate unique pseudo-amino acids for each different codon
- **Include UTRs**: Include untranslated regions (only use with nucleotide output)
- **Don't output all-dash lines**: Skip alignment rows that contain only gaps

**Output**

The tool produces a FASTA file containing the extracted alignments, by default translated to amino acid sequences.

**Notes**

- The 2bit file is used to fill in gaps in the alignment
- When using "Include UTRs", make sure "Don't translate" is also enabled
    ]]></help>
        <citations>
            <citation type="bibtex">
                @misc{mafGene,
                author = {Kent UCSC},
                title = {mafGene: A tool for output protein alignments using maf and genePred},
                note = {Tool for output protein alignments using maf and genePred}
            </citation>
    </citations>
    <creator>
        <person givenName="Saim" familyName="Momin" url="https://github.com/SaimMomin12" identifier="https://orcid.org/0009-0003-9935-828X"/>
        <organization name="Galaxy Europe" url="https://galaxyproject.org/eu/"/>
    </creator>
</tool>
