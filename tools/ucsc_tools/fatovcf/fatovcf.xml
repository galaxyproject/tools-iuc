<tool id="fatovcf" name="faToVcf" version="@TOOL_VERSION@+galaxy0" profile="21.05" license="MIT">
    <description>
        Convert a FASTA alignment file to Variant Call Format (VCF) single-nucleotide diffs
    </description>
    <macros>
        <token name="@TOOL_VERSION@">426</token>
    </macros>
    <xrefs>
        <xref type="bio.tools">ucsc-fatovcf</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">ucsc-fatovcf</requirement>
    </requirements>
    <version_command><![CDATA[ echo "@TOOL_VERSION@" ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[
    #if $excl_seq.excludeFile
        ln -sfn '$excl_seq.excludeFile' excludeFile.txt &&
    #end if
    #if $in_fasta
        ln -sfn '$in_fasta' input.fa &&
    #end if
    faToVcf
        input.fa
        out.vcf
        #if $ref_seq.ref == "false"
            -ref=$ref_seq.refSeqName
        #end if
        -startOffset=$startOffset
        $ambig_bases.ambiguousToN
        $ambig_bases.resolveAmbiguous
        #if $excl_seq.excludeFile
            -excludeFile='excludeFile.txt'
        #end if
        -maxDiff=$excl_seq.maxDiff
        #if $mask_sites.maskSites
            -maskSites='$mask_sites.maskSites'
        #end if
        -windowSize=$mask_sites.windowSize
        -minAmbigInWindow=$mask_sites.minAmbigInWindow
        $includeNoAltN
        -minAc=$minAc
        -minAf=$minAf
        $output.includeRef
        $output.noGenotypes
        #if $output.vcfChrom
            -vcfChrom='$output.vcfChrom'
        #end if
    ]]></command>
    <inputs>
        <param name="in_fasta" format="fasta" type="data" label="FASTA Alignment" help="Must contain a series of sequences with different names and the same length. Both N and - are treated as missing information." />
        
        <conditional name="ref_seq">
            <param name="ref" type="boolean" checked="true" truevalue="" falsevalue="false" label="First sequence as the reference sequence" help="Use the first sequence in the FASTA file as the reference sequence." />
            <when value="" />
            <when value="false">
                <param name="refSeqName" type="text" label="Name of sequence that should be used as reference sequence:" help="Must be present in the FASTA file." />
            </when>
        </conditional>

        <param argument="-startOffset" type="integer" min="0" value="0" label="Start offset" help="Add N bases to each position, e.g. for trimmed alignments." />

        <section name="ambig_bases" title="Handle ambiguous bases" expanded="true">
            <param argument="-ambiguousToN" type="boolean" truevalue="-ambiguousToN" falsevalue="" label="Ambiguous bases as N" help="Treat all IUPAC ambiguous bases (N, R, V etc.) as N (no call)." />
            <param argument="-resolveAmbiguous" type="boolean" truevalue="-resolveAmbiguous" falsevalue="" label="Resolve ambiguous characters" help="For IUPAC ambiguous characters like R (A or G), if the character represents two bases and one is the reference base, convert it to the non-reference base. Otherwise convert it to N." />
        </section>
        <section name="excl_seq" title="Exclude sequences" expanded="true">
            <param argument="-excludeFile" format="" type="data" optional="true" label="Exclude sequences from text file" help="Exclude sequences named in file which has one sequence name per line." />
            <param argument="-maxDiff" type="integer" min="0" value="0" label="Exclude mismatches" help="Exclude sequences from the VCF file with more than N mismatches with the reference sequence. If -windowSize is used, sequences are masked accordingly before the mismatches are counted." />
        </section>
        <section name="mask_sites" title="Mask sites" expanded="true">
            <param argument="-maskSites" format="vcf" type="data" optional="true" label="Mask sites at given positions (VCF file)" help="Exclude variants in positions recommended for masking in file. Typically https://github.com/W-L/ProblematicSites_SARS-CoV2/raw/master/problematic_sites_sarsCov2.vcf" />
            <param argument="-windowSize" type="integer" min="0" value="0" label="Window size to mask bases" help="Mask any base for which there are at least -minAmbigWindow bases in a window of +-N bases around the base. Masking approach adapted from https://github.com/roblanf/sarscov2phylo/blob/master/scripts/mask_seq.py Use -windowSize=7 for same results." />
            <param argument="-minAmbigInWindow" type="integer" min="0" value="2" label="Minimum of ambiguous characters within the window given above" help="When -windowSize is provided, mask any base for which there are at least this many N, ambiguous or gap characters within the window." />
        </section>
        
        <param argument="-includeNoAltN" type="boolean" truevalue="-includeNoAltN" falsevalue="" label="Include base positions" help="Include base positions with no alternate alleles observed, but at least one N (missing base/no-call)." />
        <param argument="-minAc" type="integer" min="0" value="0" label="Minimum allele count" help="Ignore alternate alleles observed fewer than N times." />
        <param argument="-minAf" type="float" min="0.0" max="1.0" value="0.0" label="Minimum allele frequency" help="Ignore alternate alleles observed in less than F of non-N bases." />

        <section name="output" title="Output VCF options" expanded="true">
            <param argument="-includeRef" type="boolean" truevalue="-includeRef" falsevalue="" label="Include the reference in the genotype columns" help="Default: omitted as redundant." />
            <param argument="-noGenotypes" type="boolean" truevalue="-noGenotypes" falsevalue="" label="Output 8-column VCF" help="VCF without the sample genotype columns." />
            <param argument="-vcfChrom" type="text" optional="true" label="Use this sequence for the CHROM column in the VCF" help="Default: name of the reference sequence." />
        </section>

    </inputs>
    <outputs>
        <data name="out" format="vcf" />
    </outputs>
    <tests>
        <test expect_num_outputs="1"> <!-- test with default params -->
            <param name="in_fasta" value="input.fa" />
            <output name="out" file="out1.vcf" />
        </test>
    </tests>
    <help><![CDATA[
**What it does**

`faToVcf`_ is a tool to extract a VCF from a multi-sequence FASTA alignment.

.. _faToVcf: http://hgdownload.cse.ucsc.edu/admin/exe/linux.x86_64/FOOTER.txt 
    ]]>    </help>
    <citations>
    </citations>
</tool>
