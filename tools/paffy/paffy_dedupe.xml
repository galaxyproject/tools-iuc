<tool id="paffy_dedupe" name="Paffy dedupe" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>removes duplicates from a PAF file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        set -o pipefail; 
        
        ## Uncompress input PAF file if necessary and pipe it
        @UNCOMPRESS_PAF@

        ## Run main command
        paffy dedupe
            $checkInverse
            --logLevel 'INFO'
        
        ## Compress output if requested by user 
        @COMPRESS_PAF@
    ]]></command>
    <inputs>
        <expand macro="input_paf"/>      
        <param argument="--checkInverse" type="boolean" truevalue="--checkInverse" falsevalue="" checked="false" label="Check inverse" help="Also deduplicate alignments that are the same, but with query and target reversed"/> 
        <expand macro="params_conditional_compression"/> 
    </inputs>
    <outputs>
        <data name="out_file" format="paf" label="${tool.name} on ${on_string}: Deduped PAF">
            <change_format>
                <when input="compression.type" value="gz" format="paf.gz"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: Tool defaults -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="paffy_dedupe_input.paf"/>
            <output name="out_file" ftype="paf">
                <assert_contents>
                    <has_text text="simDog.chr6&#009;593897&#009;3853&#009;11343&#009;+&#009;simCow.chr6&#009;602619&#009;3865&#009;11278&#009;4995&#009;8140&#009;255&#009;AS:i:233953" n="1"/>
                    <has_text text="simCow.chr6&#009;602619&#009;3865&#009;11278&#009;+&#009;simDog.chr6&#009;593897&#009;3853&#009;11343&#009;4995&#009;8140&#009;255&#009;AS:i:233953" n="1"/>
                    <has_n_lines n="223"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: Compressed input (.gz) -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="paffy_dedupe_input.paf.gz"/>
            <output name="out_file" ftype="paf">
                <assert_contents>
                    <has_text text="simDog.chr6&#009;593897&#009;3853&#009;11343&#009;+&#009;simCow.chr6&#009;602619&#009;3865&#009;11278&#009;4995&#009;8140&#009;255&#009;AS:i:233953" n="1"/>
                    <has_text text="simCow.chr6&#009;602619&#009;3865&#009;11278&#009;+&#009;simDog.chr6&#009;593897&#009;3853&#009;11343&#009;4995&#009;8140&#009;255&#009;AS:i:233953" n="1"/>
                    <has_n_lines n="223"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: Compressed input & output (.gz) -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="paffy_dedupe_input.paf.gz"/>
            <conditional name="compression">
                <param name="type" value="gz"/>
            </conditional>
            <output name="out_file" ftype="paf.gz">
                <assert_contents>
                    <has_size size="38329"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 4: Removing same alignments with query and target reversed -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="paffy_dedupe_input.paf"/>
            <param name="checkInverse" value="true"/>
            <output name="out_file" ftype="paf">
                <assert_contents>
                    <has_text text="simDog.chr6&#009;593897&#009;3853&#009;11343&#009;+&#009;simCow.chr6&#009;602619&#009;3865&#009;11278&#009;4995&#009;8140&#009;255&#009;AS:i:233953" n="1"/>
                    <has_text text="simCow.chr6&#009;602619&#009;3865&#009;11278&#009;+&#009;simDog.chr6&#009;593897&#009;3853&#009;11343&#009;4995&#009;8140&#009;255&#009;AS:i:233953" negate="true"/>
                    <has_n_lines n="222"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
Paffy dedupe scans an input PAF file and removes duplicate alignments that share identical query and target coordinates. 
Only one copy of each exact alignment is kept. 
Optionally, the tool can also detect duplicates where the query and target are swapped, treating inverted records as duplicates of each other.
As output, a new PAF file is generated with the deduplicated alignments.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>