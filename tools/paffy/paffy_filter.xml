<tool id="paffy_filter" name="Paffy filter" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>filters PAFs based on alignment stats</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[    
        #if $input_paf.ext.endswith('.gz')
            gunzip -c '$input_paf' |
        #end if
        paffy filter
            $invert
            #if $filters.minChainScore >= 0:
                --minChainScore $filters.minChainScore
            #end if
            #if $filters.minAlignmentScore >= 0:
                --minAlignmentScore $filters.minAlignmentScore
            #end if
            #if $filters.minIdentity >= 0:
                --minIdentity $filters.minIdentity
            #end if
            #if $filters.minIdentityWithGaps >= 0:
                --minIdentityWithGaps $filters.minIdentityWithGaps
            #end if
            #if $filters.maxTileLevel >= 0:
                --maxTileLevel $filters.maxTileLevel
            #end if
            --logLevel 'INFO'
            --outputFile '$out_file'
            #if not $input_paf.ext.endswith('.gz')
                --inputFile '$input_paf'
            #end if
    ]]></command>
    <inputs>
        <expand macro="input_paf"/>
        <section name="filters" title="Filter criteria" expanded="true" help="Filters can be disabled by specifying a negative value">
            <param argument="--minChainScore" type="integer" min="-1" value="-1" label="Min. chain score" help="Filter alignments with a chain score less than this value"/> 
            <param argument="--minAlignmentScore" type="integer" min="-1" value="-1" label="Min. alignment score" help="Filter alignments with an alignment score less than this value"/>        
            <param argument="--minIdentity" type="float" min="-1" value="-1" label="Min. identity" help="Filter alignments with an identity less than this value, exclude indels"/> 
            <param argument="--minIdentityWithGaps" type="float" min="-1" value="-1" label="Min. identity with gaps" help="Filter alignments with an identity less than this value, including indels"/> 
            <param argument="--maxTileLevel" type="integer" min="-1" value="-1" label="Max. tile level" help="Filter alignments with a tile level greater than this value"/> 
        </section>
        <param argument="--invert" type="boolean" truevalue="--invert" falsevalue="" checked="false" label="Invert filters" help="Only output alignments that don't pass the above filters"/>  
    </inputs>
    <outputs>
        <data name="out_file" format="paf" label="${tool.name} on ${on_string}: Filtered PAF"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <conditional name="filters">
                <param name="minAlignmentScore" value="20000"/>
            </conditional>
            <output name="out_file" ftype="paf" file="paffy_filter_minAlignmentScore_output.paf"/>
        </test>
         <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf.gz"/>
            <conditional name="filters">
                <param name="minAlignmentScore" value="20000"/>
            </conditional>
            <output name="out_file" ftype="paf" file="paffy_filter_minAlignmentScore_output.paf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_paf" value="paffy_chain_output.paf"/>
            <conditional name="filters">
                <param name="minChainScore" value="5000"/>
            </conditional>
            <output name="out_file" ftype="paf" file="paffy_filter_minChainScore_output.paf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_paf" value="paffy_tile_output.paf"/>
            <conditional name="filters">
                <param name="maxTileLevel" value="2"/>
            </conditional>
            <output name="out_file" ftype="paf" file="paffy_filter_maxTileLevel_output.paf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <conditional name="filters">
                <param name="minIdentityWithGaps" value="0.75"/>
            </conditional>
            <output name="out_file" ftype="paf" file="paffy_filter_minIdentityWithGaps_output.paf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <conditional name="filters">
                <param name="minAlignmentScore" value="20000"/>
                <param name="minIdentityWithGaps" value="0.75"/>
            </conditional>
            <output name="out_file" ftype="paf" file="paffy_filter_multiple_output.paf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <conditional name="filters">
                <param name="minAlignmentScore" value="20000"/>
                <param name="minIdentityWithGaps" value="0.75"/>
            </conditional>
            <param name="invert" value="true"/>
            <output name="out_file" ftype="paf" file="paffy_filter_multiple_invert_output.paf"/>
        </test>
    </tests>
    <help><![CDATA[
Paffy filter removes PAF alignments based on a set of quantitative criteria such as alignment score, chain score, sequence identity, and tile level. 
This allows control over which alignments are kept for downstream analysis.
By default, only alignments that pass all specified filters are written to the output. 
An optional invert mode outputs only the alignments that don't pass filters.
As output, a new PAF file is generated with the filtered alignments.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>