<tool id="paffy_upconvert" name="Paffy upconvert" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>converts coordinates of PAF alignments to refer to extracted subsequences</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        #if $input_paf.ext.endswith('.gz')
            gunzip -c '$input_paf' |
        #end if
        paffy upconvert
            #for $fasta_file in $input_fasta:
                #if $fasta_file.ext.endswith('.gz')
                    <(gunzip -c '$fasta_file')
                #else if $fasta_file.ext.endswith('.bz2')
                    <(bzip2 -dk '$fasta_file')
                #else
                    '$fasta_file'
                #end if
            #end for
            --logLevel 'INFO'
            --outputFile '$out_file'
            #if not $input_paf.ext.endswith('.gz')
                --inFile '$input_paf'
            #end if
    ]]></command>
    <inputs>
        <expand macro="input_paf"/>
        <expand macro="params_fastaList"/>
    </inputs>
    <outputs>
        <data name="out_file" format="paf" label="${tool.name} on ${on_string}"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.range.fasta.bz2" ftype="fasta"/>
                    <element name="002" value="simDog.chr6.range.fasta" ftype="fasta"/>
                </collection>
            </param>
            <output name="out_file" ftype="paf" file="paffy_upconvert_output.paf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf.gz"/>
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.range.fasta.gz" ftype="fasta"/>
                    <element name="002" value="simDog.chr6.range.fasta" ftype="fasta"/>
                </collection>
            </param>
            <output name="out_file" ftype="paf" file="paffy_upconvert_output.paf"/>
        </test>
    </tests>
    <help><![CDATA[
Paffy upconvert converts global alignment coordinates into local coordinates relative to provided subsequences.
This is useful for analyzing specific regions of interest instead of whole chromosomes.
It parses the start offset from the header of the input FASTA files (formatted as ``>Name|Length|Start``) and adjusts the PAF coordinates relative to the chunk.
Adjusted alignments are identified by sequence names that include the length and start offset of the subsequence.
As output, a new PAF file is generated with the upconverted alignments. 
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>