<tool id="paffy_upconvert" name="Paffy upconvert" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>translates coordinates of PAF alignments to refer to extracted subsequences</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        set -o pipefail; 
        
        ## Uncompress input FASTA files if necessary and create symlinks for uncompressed files
        @UNCOMPRESS_FASTA@

        ## Uncompress input PAF file if necessary and pipe it
        @UNCOMPRESS_PAF@
        
        ## Run main command
        paffy upconvert
            @LOOP_UNCOMPRESS_FASTA@
            --logLevel 'INFO'
            
        ## Compress output if requested by user 
        @COMPRESS_PAF@
    ]]></command>
    <inputs>
        <expand macro="input_paf"/>
        <expand macro="params_fastaList"/>
        <expand macro="params_conditional_compression"/>
    </inputs>
    <outputs>
        <data name="out_file" format="paf" label="${tool.name} on ${on_string}">
            <change_format>
                <when input="compression.type" value="gz" format="paf.gz"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: Tool defaults -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="input_fasta" value="simCow.chr6.range.fasta,simDog.chr6.range.fasta"/>
            <output name="out_file" ftype="paf">
                <assert_contents>
                    <has_text text="simDog.chr6&#009;593897&#009;9163&#009;9272" negate="true"/>
                    <has_text text="simCow.chr6&#009;602619&#009;9185&#009;9295" negate="true"/>
                    <has_text text="simDog.chr6|593897|5000&#009;593897&#009;4163&#009;4272"/>
                    <has_text text="simCow.chr6|602619|5000&#009;602619&#009;4185&#009;4295"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: Compressed input (.gz) -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf.gz"/>
            <param name="input_fasta" value="simCow.chr6.range.fasta.gz,simDog.chr6.range.fasta"/>
            <output name="out_file" ftype="paf">
                <assert_contents>
                    <has_text text="simDog.chr6&#009;593897&#009;9163&#009;9272" negate="true"/>
                    <has_text text="simCow.chr6&#009;602619&#009;9185&#009;9295" negate="true"/>
                    <has_text text="simDog.chr6|593897|5000&#009;593897&#009;4163&#009;4272"/>
                    <has_text text="simCow.chr6|602619|5000&#009;602619&#009;4185&#009;4295"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: Compressed input & output (.bz2/.gz) -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf.gz"/>
            <param name="input_fasta" value="simCow.chr6.range.fasta.bz2,simDog.chr6.range.fasta"/>
            <conditional name="compression">
                <param name="type" value="gz"/>
            </conditional>
            <output name="out_file" ftype="paf.gz">
                <assert_contents>
                    <has_size size="38189"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
Paffy upconvert translates global alignment coordinates into local coordinates relative to provided subsequences.
This is useful for analyzing specific regions of interest instead of processing the entire global sequences.
The tool parses the start offset directly from the headers of the input FASTA subsequences (which must be formatted as ``>Name|Length|Start``) and recalculates the PAF coordinates relative to each chunk.
As output, a new PAF file is generated where sequence names are updated with length and offset metadata, and coordinates are properly translated.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>