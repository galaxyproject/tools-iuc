<tool id="paffy_dechunk" name="Paffy dechunk" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>updates coordinates based on encoded positions in alignment names</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        set -o pipefail; 
        
        ## Uncompress input PAF file if necessary and pipe it
        @UNCOMPRESS_PAF@

        ## Run main command
        paffy dechunk
            --logLevel 'INFO'
        
        ## Compress output if requested by user 
        @COMPRESS_PAF@
    ]]></command>
    <inputs>
        <expand macro="input_paf"/>     
        <expand macro="params_conditional_compression"/>  
    </inputs>
    <outputs>
        <data name="out_file" format="paf" label="${tool.name} on ${on_string}: Dechunked PAF">
            <change_format>
                <when input="compression.type" value="gz" format="paf.gz"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: Tool defaults -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPafChunked.paf"/>
            <output name="out_file" ftype="paf">
                <assert_contents>
                    <has_text text="simDog.chr6"/>
                    <has_text text="simCow.chr6"/>
                    <has_text text="simDog.chr6|" negate="true"/>
                    <has_text text="simCow.chr6|" negate="true"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: Compressed input (.gz) -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPafChunked.paf.gz"/>
            <output name="out_file" ftype="paf">
                <assert_contents>
                    <has_text text="simDog.chr6"/>
                    <has_text text="simCow.chr6"/>
                    <has_text text="simDog.chr6|" negate="true"/>
                    <has_text text="simCow.chr6|" negate="true"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: Compressed input & output (.gz) -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPafChunked.paf.gz"/>
            <conditional name="compression">
                <param name="type" value="gz"/>
            </conditional>
            <output name="out_file" ftype="paf.gz">
                <assert_contents>
                    <has_size size="38332"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
Paffy dechunk updates alignment coordinates of PAF files generated from FASTA sequences that were previously split using 'faffy chunk'.
FASTA sequences split using 'faffy chunk' are annotated with ``|Length|Start`` to the their header, where ``Length`` is the original sequence length and ``Start`` indicates the 0-based start coordinate in the original sequence. 
This chunk-specific encoding is carried over into the query and/or target names in the resulting PAF file.

This tool removes the chunk-specific encoding present in the query and/or target names and updates the PAF alignment coordinates accordingly. 
For this, the alignments to be updated must contain their chunk-specific encoding in their query and/or target names (as ``Name|Length|Start``).
As output, a new PAF file is generated with updated coordinates and alignment namings.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>