<tool id="faffy_merge" name="Faffy merge" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>combines FASTA files into a single FASTA file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        set -o pipefail; 

        ## --inputFile is a file with a list of file paths pointing to the FASTA's
        #for $i, $fasta_file in enumerate($input_fasta):
            #set temp_fasta_file = "input_${i}.fasta"
            #if $fasta_file.is_of_type('fasta.gz')
                gunzip -c '$fasta_file' > '$temp_fasta_file' &&
                echo '$temp_fasta_file' >> file_list.txt &&
            #else if $fasta_file.is_of_type('fasta.bz2')
                bunzip2 -c '$fasta_file' > '$temp_fasta_file' &&
                echo '$temp_fasta_file' >> file_list.txt &&
            #else
                echo '$fasta_file' >> file_list.txt &&
            #end if
        #end for
        
        ## Run main command 
        faffy merge
            --logLevel 'INFO'
            --inputFile file_list.txt

        ## Compress output if requested by user
        @COMPRESS_FASTA@
    ]]></command>
    <inputs>
        <expand macro="params_fastaList"/>
        <expand macro="params_conditional_compression_fasta"/>  
    </inputs>
    <outputs>
        <data name="out_file" format="fasta" label="${tool.name} on ${on_string}">
            <change_format>
                <when input="compression.type" value="gz" format="fasta.gz"/>
                <when input="compression.type" value="bz2" format="fasta.bz2"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: Multiple FASTA files with blunt ends -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="faffy_chunk_output/0.fa,faffy_chunk_output/1.fa,faffy_chunk_output/2.fa" ftype="fasta"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6"/>
                     <has_text text=">" n="1"/>
                    <has_size value="602635"/>
                    <has_n_lines n="4"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: Multiple compressed (.bz2) FASTA files with sticky ends -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="faffy_chunk_overlap_output/0.fa.bz2,faffy_chunk_overlap_output/1.fa.bz2,faffy_chunk_overlap_output/2.fa.bz2" ftype="fasta"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6"/>
                    <has_line line=">simDog.chr6"/>
                    <has_text text=">" n="2"/>
                    <has_size value="902659"/>
                    <has_n_lines n="6"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: Multiple compressed (.bz2) FASTA files with sticky ends, compressing output (.gz) -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="faffy_chunk_overlap_output/0.fa.bz2,faffy_chunk_overlap_output/1.fa.bz2,faffy_chunk_overlap_output/2.fa.bz2" ftype="fasta"/>
            <conditional name="compression">
                <param name="type" value="gz"/>
            </conditional>
            <output name="out_file" ftype="fasta.gz">
                <assert_contents>
                    <has_size size="268785"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 4: Multiple compressed (.bz2) FASTA files with sticky ends, compressing output (.bz2) -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="faffy_chunk_overlap_output/0.fa.bz2,faffy_chunk_overlap_output/1.fa.bz2,faffy_chunk_overlap_output/2.fa.bz2" ftype="fasta"/>
            <conditional name="compression">
                <param name="type" value="bz2"/>
            </conditional>
            <output name="out_file" ftype="fasta.bz2">
                <assert_contents>
                    <has_size size="244847"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
Faffy merge combines a list of FASTA files produced by `Faffy chunk`, containing consecutive sequence chunks, into a single output file. 
Input sequence headers must be annotated in the format ``>Name|Length|Start``, where ``Length`` is the original sequence length and ``Start`` indicates the 0-based start coordinate in the original sequence. 
The tool requires the initial chunk of a sequence to start at coordinate 0. 
Annotations are automatically removed in the final merged output.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>