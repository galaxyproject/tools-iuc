<tool id="faffy_extract" name="Faffy extract" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>extracts subsequences from a FASTA file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        faffy extract
            #for $fasta_file in $input_fasta:
                #if $fasta_file.ext.endswith('.gz')
                    <(gunzip -c '$fasta_file')
                #else if $fasta_file.ext.endswith('.bz2')
                    <(bzip2 -dk '$fasta_file')
                #else
                    '$fasta_file'
                #end if
            #end for
            $skipMissing
            --flank $flank
            --minSize $minSize
            --logLevel 'INFO'
            --bedFile '$input_bed'
            --outputFile '$out_file'
    ]]></command>
    <inputs>
        <expand macro="params_fastaList"/>    
        <param name="input_bed" type="data" format="bed" label="BED file" help="BED file with the regions to extract"/>
        <param argument="--flank" type="integer" min="0" value="10" label="Flanking size" help="Number of additional base pairs to include at each end of each extracted sequence"/>   
        <param argument="--minSize" type="integer" min="0" value="100" label="Minimum sequence length" help="The minimum length of a sequence (before adding the flanks) to extract"/>   
        <param argument="--skipMissing" type="boolean" truevalue="--skipMissing" falsevalue="" checked="false" label="Skip missing sequences" help="Skip BED intervals that reference missing sequences instead of causing an error"/>
    </inputs>
    <outputs>
        <data name="out_file" format="fasta" label="${tool.name} on ${on_string}"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta" ftype="fasta"/>
                </collection>
            </param>
            <param name="input_bed" value="faffy_extract_input.bed"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|990"/>
                    <has_line line=">simCow.chr6|602619|9990"/>
                    <has_n_lines n="15"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta.gz" ftype="fasta"/>
                </collection>
            </param>
            <param name="input_bed" value="faffy_extract_input.bed"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|990"/>
                    <has_line line=">simCow.chr6|602619|9990"/>
                    <has_n_lines n="15"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta.bz2" ftype="fasta"/>
                </collection>
            </param>
            <param name="input_bed" value="faffy_extract_input.bed"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|990"/>
                    <has_line line=">simCow.chr6|602619|9990"/>
                    <has_n_lines n="15"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta" ftype="fasta"/>
                </collection>
            </param>
            <param name="input_bed" value="faffy_extract_input.bed"/>
            <param name="flank" value="0"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|1000"/>
                    <has_line line=">simCow.chr6|602619|10000"/>
                    <has_n_lines n="13"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta" ftype="fasta"/>
                </collection>
            </param>
            <param name="input_bed" value="faffy_extract_input.bed"/>
            <param name="minSize" value="40"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|990"/>
                    <has_line line=">simCow.chr6|602619|4990"/>
                    <has_line line=">simCow.chr6|602619|9990"/>
                    <has_n_lines n="17"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta" ftype="fasta"/>
                </collection>
            </param>
            <param name="input_bed" value="faffy_extract_skipMissing_input.bed"/>
            <param name="skipMissing" value="true"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|990"/>
                    <has_line line=">simCow.chr6|602619|9990"/>
                    <has_n_lines n="15"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta" ftype="fasta"/>
                    <element name="002" value="simDog.chr6.fasta" ftype="fasta"/>
                </collection>
            </param>
            <param name="input_bed" value="faffy_extract_skipMissing_input.bed"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|990"/>
                    <has_line line=">simCow.chr6|602619|9990"/>
                    <has_line line=">simDog.chr6|593897|4990"/>
                    <has_n_lines n="37"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
Faffy extract takes one or more FASTA files and extracts subsequences specified by a BED file of intervals. 
Each extracted sequence is annotated in its header with ``|Length|Start``, indicating the 0-based start coordinate in the original sequence. 
Optional flanking regions can be added at both ends of each extracted interval.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>