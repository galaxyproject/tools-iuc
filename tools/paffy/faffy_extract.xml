<tool id="faffy_extract" name="Faffy extract" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>obtains subsequences from FASTA files</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        set -o pipefail; 

        ## Uncompress input files if necessary and create symlinks for uncompressed files
        @UNCOMPRESS_FASTA@

        ## Run main command
        faffy extract
            @LOOP_UNCOMPRESS_FASTA@
            $skipMissing
            --flank $flank
            --minSize $minSize
            --logLevel 'INFO'
            --bedFile '$input_bed'
       
        ## Compress output if requested by user     
        @COMPRESS_FASTA@
    ]]></command>
    <inputs>
        <expand macro="params_fastaList"/>    
        <param name="input_bed" type="data" format="bed" label="BED file" help="BED file with the regions to extract"/>
        <param argument="--flank" type="integer" min="0" value="10" label="Flanking size" help="Number of additional base pairs to include at each end of each extracted sequence"/>   
        <param argument="--minSize" type="integer" min="0" value="100" label="Minimum sequence length" help="The minimum length of a sequence (before adding the flanks) to extract"/>   
        <param argument="--skipMissing" type="boolean" truevalue="--skipMissing" falsevalue="" checked="false" label="Skip missing sequences" help="Skip BED intervals that reference missing sequences instead of causing an error"/>
        <expand macro="params_conditional_compression_fasta"/>  
    </inputs>
    <outputs>
        <data name="out_file" format="fasta" label="${tool.name} on ${on_string}">
            <change_format>
                <when input="compression.type" value="gz" format="fasta.gz"/>
                <when input="compression.type" value="bz2" format="fasta.bz2"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: Tool defaults -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="simCow.chr6.fasta" ftype="fasta"/>
            <param name="input_bed" value="faffy_extract_input.bed"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|990"/>
                    <has_line line=">simCow.chr6|602619|4990" negate="true"/>
                    <has_line line=">simCow.chr6|602619|9990"/>
                    <has_text text=">" n="2"/>
                    <has_n_lines n="15"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: Compressed input and output (.gz) -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="simCow.chr6.fasta.gz" ftype="fasta.gz"/>
            <param name="input_bed" value="faffy_extract_input.bed"/>
            <conditional name="compression">
                <param name="type" value="gz"/>
            </conditional>
            <output name="out_file" ftype="fasta.gz">
                <assert_contents>
                    <has_size size="468"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: Compressed input and output (.bz2) -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="simCow.chr6.fasta.bz2" ftype="fasta.bz2"/>
            <param name="input_bed" value="faffy_extract_input.bed"/>
            <conditional name="compression">
                <param name="type" value="bz2"/>
            </conditional>
            <output name="out_file" ftype="fasta.bz2">
                <assert_contents>
                    <has_size size="459"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 4: No flanking regions -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="simCow.chr6.fasta" ftype="fasta"/>
            <param name="input_bed" value="faffy_extract_input.bed"/>
            <param name="flank" value="0"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|1000"/>
                    <has_line line=">simCow.chr6|602619|5000" negate="true"/>
                    <has_line line=">simCow.chr6|602619|10000"/>
                    <has_text text=">" n="2"/>
                    <has_n_lines n="13"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 5: Minimum length of a sequence lowered compared to default -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="simCow.chr6.fasta" ftype="fasta"/>
            <param name="input_bed" value="faffy_extract_input.bed"/>
            <param name="minSize" value="40"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|990"/>
                    <has_line line=">simCow.chr6|602619|4990"/>
                    <has_line line=">simCow.chr6|602619|9990"/>
                    <has_text text=">" n="3"/>
                    <has_n_lines n="17"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 6: Skipping missing sequences not present in input FASTA files -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="simCow.chr6.fasta" ftype="fasta"/>
            <param name="input_bed" value="faffy_extract_skipMissing_input.bed"/>
            <param name="skipMissing" value="true"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|990"/>
                    <has_line line=">simCow.chr6|602619|4990" negate="true"/>
                    <has_line line=">simCow.chr6|602619|9990"/>
                    <has_line line=">simDog.chr6|593897|4990" negate="true"/>
                    <has_text text=">" n="2"/>
                    <has_n_lines n="15"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 7: Extracting from multiple FASTAs with defaults -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="simCow.chr6.fasta,simDog.chr6.fasta" ftype="fasta"/>
            <param name="input_bed" value="faffy_extract_skipMissing_input.bed"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">simCow.chr6|602619|990"/>
                    <has_line line=">simCow.chr6|602619|4990" negate="true"/>
                    <has_line line=">simCow.chr6|602619|9990"/>
                    <has_line line=">simDog.chr6|593897|4990"/>
                    <has_text text=">" n="3"/>
                    <has_n_lines n="37"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
Faffy extract subsequences from one or more FASTA files based on intervals specified in a BED file.
Each extracted sequence header is annotated with ``|Length|Start``, where ``Length`` is the original sequence length and ``Start`` indicates the 0-based start coordinate in the original sequence. 
Optional flanking regions can be added at both ends of each extracted interval, which then adjusts the annotated ``Start`` in the sequence header by ``Start-flankSize``.
By default, the tool throws an error if a BED record references a missing sequence, but enabling 'Skip missing sequences' will ignore these intervals instead.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>