<tool id="faffy_chunk" name="Faffy chunk" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>breaks FASTA file(s) into smaller files</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        ## Uncompress input files if necessary and create symlinks for uncompressed files
        @UNCOMPRESS_FASTA@

        ## Run main command
        mkdir -p chunks && 
        faffy chunk
            @LOOP_UNCOMPRESS_FASTA@
            --logLevel 'INFO'
            --chunkSize $chunkSize
            --overlap $overlap
            --dir chunks
            
        ## Compress output files in the chunk directory if requested by user
        #if $compression.type == 'gz':
            && find chunks -maxdepth 1 -type f -name '*.fa' -exec gzip \{\} ';'
        #else if $compression.type == 'bz2':
            && find chunks -maxdepth 1 -type f -name '*.fa' -exec bzip2 \{\} ';'
        #end if
    ]]></command>
    <inputs>
        <expand macro="params_fastaList"/>
        <param argument="--chunkSize" type="integer" min="1" value="10000000" label="Chunk size (bp)" help="The target length of each chunk"/>   
        <param argument="--overlap" type="integer" min="0" value="100000" label="Overlap size (bp)" help="Number of base pairs overlapping with the next chunk. Total output length will be chunkSize + overlapSize"/>   
        <expand macro="params_conditional_compression_fasta"/>  
    </inputs>
    <outputs>
        <collection name="out_chunks" type="list" label="${tool.name} on ${on_string}: Chunked FASTA">
            <discover_datasets pattern="(?P&lt;designation&gt;\d+)\.fa$" directory="chunks" format="fasta"/>
            <discover_datasets pattern="(?P&lt;designation&gt;\d+)\.fa\.gz$" directory="chunks" format="fasta.gz"/>
            <discover_datasets pattern="(?P&lt;designation&gt;\d+)\.fa\.bz2$" directory="chunks" format="fasta.bz2"/>
        </collection>
    </outputs>
    <tests>
        <!-- Test 1: Chunking of compressed FASTA (0bp overlap). Outputs serve as input for faffy_merge -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="simCow.chr6.fasta.gz" ftype="fasta.gz"/>
            <param name="chunkSize" value="300000"/>
            <param name="overlap" value="0"/>
            <output_collection name="out_chunks" type="list" count="3">
                <element name="0" file="faffy_chunk_output/0.fa" ftype="fasta"/>
                <element name="1" file="faffy_chunk_output/1.fa" ftype="fasta"/>
                <element name="2" file="faffy_chunk_output/2.fa" ftype="fasta"/>
            </output_collection>
        </test>
        <!-- Test 2: Compressed output (.gz) -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="simCow.chr6.fasta.gz" ftype="fasta.gz"/>
            <param name="chunkSize" value="300000"/>
            <param name="overlap" value="0"/>
            <conditional name="compression">
                <param name="type" value="gz"/>
            </conditional>
            <output_collection name="out_chunks" type="list" count="3">
                <element name="0" ftype="fasta.gz">
                    <assert_contents>
                        <has_size size="94334"/>
                    </assert_contents>
                </element>
                <element name="1" ftype="fasta.gz">
                    <assert_contents>
                        <has_size size="93838"/>
                    </assert_contents>
                </element>
                <element name="2" ftype="fasta.gz">
                    <assert_contents>
                        <has_size size="969"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- Test 3: Compressed output (.bz2) & pooling of multiple FASTAs (with 10bp overlap). Outputs serve as input for faffy_merge -->
        <test expect_num_outputs="1">
            <param name="input_fasta" value="simCow.chr6.fasta.bz2,simDog.chr6.fasta"/>
            <param name="chunkSize" value="300000"/>
            <param name="overlap" value="10"/>
            <conditional name="compression">
                <param name="type" value="bz2"/>
            </conditional>
            <output_collection name="out_chunks" type="list" count="4">
                <element name="0" file="faffy_chunk_overlap_output/0.fa.bz2" ftype="fasta.bz2"/>
                <element name="1" file="faffy_chunk_overlap_output/1.fa.bz2" ftype="fasta.bz2"/>
                <element name="2" file="faffy_chunk_overlap_output/2.fa.bz2" ftype="fasta.bz2"/>
                <element name="3" file="faffy_chunk_overlap_output/3.fa.bz2" ftype="fasta.bz2"/>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
Faffy chunk breaks FASTA sequences into smaller, optionally overlapping chunks distributed across multiple output FASTA files.
Corresponding chunks from multiple inputs are pooled together (e.g., all first chunks go into the first output file). 
It handles both upper and lower case nucleotides, and sequences smaller than the set chunk size are treated as the first chunk. 
Position information for each chunk is retained by annotating ``|Length|Start`` to the sequence header,  where ``Length`` is the original sequence length and ``Start`` indicates the 0-based start coordinate in the original sequence. 
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>