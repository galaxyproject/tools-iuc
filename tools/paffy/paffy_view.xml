<tool id="paffy_view" name="Paffy view" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>prints and extract stats about PAF alignments</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        set -o pipefail;

        ## Uncompress input FASTA files if necessary and create symlinks for uncompressed files
        @UNCOMPRESS_FASTA@

        ## Uncompress input PAF file if necessary and pipe it
        @UNCOMPRESS_PAF@

        ## Run main command
        paffy view
            @LOOP_UNCOMPRESS_FASTA@
            --logLevel 'INFO'
            --errorIfIdentityLowerThanX $check.errorIfIdentityLowerThanX
            --errorIfAlignedBasesLowerThanX $check.errorIfAlignedBasesLowerThanX
            $includeAlignment
            $noPerAlignmentStats
            --printAggregateStats ## Must be set and can't be optional. Otherwise, asserts in the tool will throw to 100%
            --outputFile '$out_file'
    ]]></command>
    <inputs>
        <expand macro="input_paf"/>
        <expand macro="params_fastaList"/>
        <param argument="--includeAlignment" type="boolean" truevalue="--includeAlignment" falsevalue="" checked="false" label="Include alignment details" help="Include base-level alignment in output"/>  
        <param argument="--noPerAlignmentStats" type="boolean" truevalue="--noPerAlignmentStats" falsevalue="" checked="false" label="Disable per-alignment statistics" help="Suppresses statistics for individual PAF alignments and only prints the overall summary statistics"/>  
        <section name="check" title="Sanity check for testing" expanded="true">
            <param argument="--errorIfIdentityLowerThanX" type="float" min="0" value="0" max="1" label="Error if identify is lower than given value" help="Asserts if identity is >= given value"/>
            <param argument="--errorIfAlignedBasesLowerThanX" type="integer" min="0" value="0" label="Error if aligned bases is lower than given value" help="Asserts if total aligned based is >= given value"/>
        </section>
    </inputs>
    <outputs>
        <data name="out_file" format="tabular" label="${tool.name} on ${on_string}: Pretty-printed PAF">
            <change_format>
                <when input="includeAlignment" value="--includeAlignment" format="txt"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: Tool defaults -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="input_fasta" value="simCow.chr6.fasta.bz2,simDog.chr6.fasta"/>
            <output name="out_file" ftype="tabular">
                <assert_contents>
                    <has_text text="TTTCTGGTGCGCGACCCAATCTGTAGAC" negate="true"/>
                    <has_text text="Query:"/>
                    <has_text text="Target:"/>
                    <has_text text="Score:"/>
                    <has_text text="Same-strand:"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: Compressed input (.gz) -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf.gz"/>
            <param name="input_fasta" value="simCow.chr6.fasta.gz,simDog.chr6.fasta"/>
            <output name="out_file" ftype="tabular">
                <assert_contents>
                    <has_text text="TTTCTGGTGCGCGACCCAATCTGTAGAC" negate="true"/>
                    <has_text text="Query:"/>
                    <has_text text="Target:"/>
                    <has_text text="Score:"/>
                    <has_text text="Same-strand:"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: Include base level alignment -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="input_fasta" value="simCow.chr6.fasta,simDog.chr6.fasta" ftype="fasta"/>
            <param name="includeAlignment" value="true"/>
            <output name="out_file" ftype="txt">
                <assert_contents>
                    <has_text text="TTTCTGGTGCGCGACCCAATCTGTAGAC"/>
                    <has_text text="Query:"/>
                    <has_text text="Target:"/>
                    <has_text text="Score:"/>
                    <has_text text="Same-strand:"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 4: No stats about each PAF alignment -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="input_fasta" value="simCow.chr6.fasta,simDog.chr6.fasta" ftype="fasta"/>
            <param name="noPerAlignmentStats" value="true"/>
            <output name="out_file" ftype="tabular">
                <assert_contents>
                    <has_text text="Total-alignments:"/>
                    <has_text text="Avg-Identity:"/>
                    <has_text text="Avg-Identity-with-gaps:"/>
                    <has_text text="Aligned-bases:"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 5: Sanity checks -->
        <test expect_failure="true">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="input_fasta" value="simCow.chr6.fasta,simDog.chr6.fasta" ftype="fasta"/>
            <section name="check">
                <param name="errorIfIdentityLowerThanX" value="0.80"/>
                <param name="errorIfAlignedBasesLowerThanX" value="530000"/>
            </section>
        </test>
    </tests>
    <help><![CDATA[
Paffy view is a tool to process and pretty-print PAF files while calculating alignment statistics and sequence identity.
To perform these calculations, the tool requires the original query and target FASTA sequences as input. 
Optional sanity checks can be run that cause execution to fail if alignments do not meet minimum sequence identity or aligned-base thresholds.
The tool outputs the result as a table. If alignments are included, the output is a txt file.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>