<tool id="paffy_view" name="paffy view" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>prints and extract stats about PAF alignments</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        paffy view
            #for $fasta_file in $input_fasta:
                '$fasta_file'
            #end for
            --logLevel "INFO"
            --errorIfIdentityLowerThanX $check.errorIfIdentityLowerThanX
            --errorIfAlignedBasesLowerThanX $check.errorIfAlignedBasesLowerThanX
            $includeAlignment
            $noPerAlignmentStats
            --printAggregateStats ## Must be set and can't be optional. Otherwise, the sanity checks in the tool will throw and exit_code is >= 1 to 100%
            --outputFile '$out_file'
            #if $input_paf.ext.endswith(".gz")
                < gunzip -c '$input_paf' 
            #else:
                --inputFile '$input_paf'
            #end if
    ]]></command>
    <inputs>
        <expand macro="input_paf"/>
        <expand macro="params_fastaList"/>
        <param argument="--includeAlignment" type="boolean" truevalue="--includeAlignment" falsevalue="" checked="false" label="Include alignment" help="Include base level alignment in output"/>  
        <param argument="--noPerAlignmentStats" type="boolean" truevalue="--noPerAlignmentStats" falsevalue="" checked="false" label="No per alignment stats" help="Do not print stats about each PAF"/>  
        <section name="check" title="Sanity check for testing" expanded="true">
            <param argument="--errorIfIdentityLowerThanX" type="float" min="0" value="0" max="1" label="Error if identify is lower than given value" help="Asserts if identity is >= given value"/>
            <param argument="--errorIfAlignedBasesLowerThanX" type="integer" min="0" value="0" label="Error if aligned bases is lower than given value" help="Asserts if total aligned based is >= given value"/>
        </section>
    </inputs>
    <outputs>
        <data name="out_file" format="tsv" label="${tool.name} on ${on_string}: Pretty-printed PAF">
            <change_format>
                <when input="includeAlignment" value="--includeAlignment" format="txt"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta" ftype="fasta"/>
                    <element name="002" value="simDog.chr6.fasta" ftype="fasta"/>
                </collection>
            </param>
            <output name="out_file" ftype="tsv" file="paffy_view_output.tsv"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf.gz"/>
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta" ftype="fasta"/>
                    <element name="002" value="simDog.chr6.fasta" ftype="fasta"/>
                </collection>
            </param>
            <output name="out_file" ftype="tsv" file="paffy_view_output.tsv"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta" ftype="fasta"/>
                    <element name="002" value="simDog.chr6.fasta" ftype="fasta"/>
                </collection>
            </param>
            <param name="includeAlignment" value="true"/>
            <output name="out_file" ftype="txt">
                <assert_contents>
                    <has_text text="Total-alignments:222"/>
                    <has_text text="Avg-Identity:0.740985"/>
                    <has_text text="Avg-Identity-with-gaps:0.579598"/>
                    <has_text text="Aligned-bases:530236"/>
                    <has_text text="Aligned-bases-with-gaps:677879"/>
                    <has_text text="Query-inserts:7619"/>
                    <has_text text="Query-deletes:7334"/>
                    <has_n_lines n="14107"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta" ftype="fasta"/>
                    <element name="002" value="simDog.chr6.fasta" ftype="fasta"/>
                </collection>
            </param>
            <param name="noPerAlignmentStats" value="true"/>
            <output name="out_file" ftype="tsv">
                 <assert_contents>
                    <has_text text="Total-alignments:222"/>
                    <has_text text="Avg-Identity:0.740985"/>
                    <has_text text="Avg-Identity-with-gaps:0.579598"/>
                    <has_text text="Aligned-bases:530236"/>
                    <has_text text="Aligned-bases-with-gaps:677879"/>
                    <has_text text="Query-inserts:7619"/>
                    <has_text text="Query-deletes:7334"/>
                    <has_n_lines n="1"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="input_fasta">
                <collection type="list">
                    <element name="001" value="simCow.chr6.fasta" ftype="fasta"/>
                    <element name="002" value="simDog.chr6.fasta" ftype="fasta"/>
                </collection>
            </param>
            <section name="check">
                <param name="errorIfIdentityLowerThanX" value="0.70"/>
                <param name="errorIfAlignedBasesLowerThanX" value="530000"/>
            </section>
            <output name="out_file" ftype="tsv" file="paffy_view_output.tsv"/>
        </test>
    </tests>
    <help><![CDATA[
Paffy view is a tool to process and pretty-print PAF files. 
FASTA file(s) referenced in the PAF file (query and target sequences) are required as input.
Optional sanity checks can be run that cause execution to fail if alignments do not meet minimum identity or aligned-base thresholds.
The tool outputs the result as a tsv file. If alignments are included, the output is a txt file.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>