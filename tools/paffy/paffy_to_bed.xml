<tool id="paffy_to_bed" name="Paffy to bed" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>creates a BED file representing alignment coverage on query sequences</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        set -o pipefail; 
        
        ## Uncompress input PAF file if necessary and pipe it
        @UNCOMPRESS_PAF@

        ## Run main command
        paffy to_bed
            #if $alignment.exclude == '--excludeAligned':
                --excludeAligned
            #else if $alignment.exclude == '--excludeUnaligned':
                --excludeUnaligned
            #end if
            $includeInverted
            $binary
            --minSize $minSize
            --logLevel 'INFO'
            ## Convert spaces to tabs for broader BED tool compatibility
            | tr ' ' '\t' > '$out_file'
    ]]></command>
    <inputs>
        <expand macro="input_paf"/>
        <conditional name="alignment">
            <param name="exclude" type="select" label="Alignment coverage exclusion">
                <option value="" selected="true">Include intervals with any alignment coverage (default)</option>
                <option value="--excludeAligned">Exclude intervals with > 0 alignment coverage (--excludeAligned)</option>
                <option value="--excludeUnaligned">Exclude intervals with 0 alignment coverage (--excludeUnaligned)</option>
            </param>
            <when value=""/>
            <when value="--excludeAligned"/>
            <when value="--excludeUnaligned"/>
        </conditional>
        <param argument="--minSize" type="integer" min="1" value="1" label="Min size" help="Exclude any interval shorter than this given value"/> 
        <param argument="--binary" type="boolean" truevalue="--binary" falsevalue="" checked="false" label="Binary output for alignments" help="If enabled, outputs 0 for unaligned and 1 for aligned, rather than reporting the actual number of alignments"/>  
        <param argument="--includeInverted" type="boolean" truevalue="--includeInverted" falsevalue="" checked="false" label="Include target sequence" help="Flip the alignments to also include the target sequences"/>   
    </inputs>
    <outputs>
        <data name="out_file" format="bed" label="${tool.name} on ${on_string}"/>
    </outputs>
    <tests>
        <!-- Test 1: Tool defaults -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <output name="out_file" ftype="bed">
                <assert_contents>
                    <has_line line="simCow.chr6&#009;0&#009;2&#009;0" negate="true"/>
                    <has_line line="simDog.chr6&#009;0&#009;3&#009;0"/>
                    <has_line line="simDog.chr6&#009;3&#009;126&#009;1"/>
                    <has_line line="simDog.chr6&#009;488539&#009;488641&#009;2"/>
                    <has_n_lines n="15599"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: Compressed input (.gz) -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf.gz"/>
            <output name="out_file" ftype="bed">
                <assert_contents>
                    <has_line line="simCow.chr6&#009;0&#009;2&#009;0" negate="true"/>
                    <has_line line="simDog.chr6&#009;0&#009;3&#009;0"/>
                    <has_line line="simDog.chr6&#009;3&#009;126&#009;1"/>
                    <has_line line="simDog.chr6&#009;488539&#009;488641&#009;2"/>
                    <has_n_lines n="15599"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: Test minSize of intervals -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="minSize" value="100"/>
            <output name="out_file" ftype="bed">
                <assert_contents>
                    <has_line line="simCow.chr6&#009;0&#009;2&#009;0" negate="true"/>
                    <has_line line="simDog.chr6&#009;0&#009;3&#009;0" negate="true"/>
                    <has_line line="simDog.chr6&#009;3&#009;126&#009;1"/>
                    <has_line line="simDog.chr6&#009;488539&#009;488641&#009;2"/>
                    <has_n_lines n="1747"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 4: Test binary output -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="binary" value="true"/>
            <output name="out_file" ftype="bed">
                <assert_contents>
                    <has_line line="simCow.chr6&#009;0&#009;2&#009;0" negate="true"/>
                    <has_line line="simDog.chr6&#009;0&#009;3&#009;0"/>
                    <has_line line="simDog.chr6&#009;3&#009;126&#009;1"/>
                    <has_line line="simDog.chr6&#009;488539&#009;488641&#009;2" negate="true"/>
                    <has_n_lines n="14116"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 5: Test exclude unaligned -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <conditional name="alignment">
                <param name="exclude" value="--excludeUnaligned"/>
            </conditional>
            <output name="out_file" ftype="bed">
                <assert_contents>
                    <has_line line="simCow.chr6&#009;0&#009;2&#009;0" negate="true"/>
                    <has_line line="simDog.chr6&#009;0&#009;3&#009;0" negate="true"/>
                    <has_line line="simDog.chr6&#009;3&#009;126&#009;1"/>
                    <has_line line="simDog.chr6&#009;488539&#009;488641&#009;2"/>
                    <has_n_lines n="8541"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 6: Test exclude aligned -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <conditional name="alignment">
                <param name="exclude" value="--excludeAligned"/>
            </conditional>
            <output name="out_file" ftype="bed">
                <assert_contents>
                    <has_line line="simCow.chr6&#009;0&#009;2&#009;0" negate="true"/>
                    <has_line line="simDog.chr6&#009;0&#009;3&#009;0"/>
                    <has_line line="simDog.chr6&#009;3&#009;126&#009;1" negate="true"/>
                    <has_line line="simDog.chr6&#009;488539&#009;488641&#009;2" negate="true"/>
                    <has_n_lines n="7058"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 7: Multiple parameters combined -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <conditional name="alignment">
                <param name="exclude" value="--excludeUnaligned"/>
            </conditional>
            <param name="minSize" value="100"/>
            <param name="binary" value="true"/>
            <output name="out_file" ftype="bed">
                <assert_contents>
                    <has_line line="simCow.chr6&#009;0&#009;2&#009;0" negate="true"/>
                    <has_line line="simDog.chr6&#009;0&#009;3&#009;0" negate="true"/>
                    <has_line line="simDog.chr6&#009;3&#009;126&#009;1"/>
                    <has_line line="simDog.chr6&#009;488539&#009;488641&#009;2" negate="true"/>
                    <has_n_lines n="1720"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 8: Include target sequence -->
        <test expect_num_outputs="1">
            <param name="input_paf" value="testPaf.paf"/>
            <param name="includeInverted" value="true"/>
            <output name="out_file" ftype="bed">
                <assert_contents>
                    <has_line line="simCow.chr6&#009;0&#009;2&#009;0"/>
                    <has_line line="simDog.chr6&#009;0&#009;3&#009;0"/>
                    <has_line line="simDog.chr6&#009;3&#009;126&#009;1"/>
                    <has_line line="simDog.chr6&#009;488539&#009;488641&#009;2"/>
                    <has_n_lines n="30644"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
Paffy to bed creates a BED file representing the coverage of alignments on the query sequences of the PAF alignments.
The output describes the depth of coverage, indicating exactly how many alignments span each interval. 
If the binary option is enabled, adjacent covered regions are merged into a single contiguous block, effectively showing only the presence (1) or absence (0) of alignments rather than their absolute depth.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>