<macros>
	<token name="@TOOL_VERSION@">2.5.3</token>
    <token name="@VERSION_SUFFIX@">0</token>
    <xml name="requirements">
        <requirement type="package" version="@TOOL_VERSION@">snapatac2</requirement>
        <!--<requirement type="package" version="3.0.0">macs3</requirement>-->
        <requirement type="package" version="5.18.0">plotly</requirement>
        <requirement type="package" version="0.2.1">python-kaleido</requirement>
        <requirement type="package" version="0.19.19">polars</requirement>
        <requirement type="package" version="14.0.1">pyarrow</requirement>
        <requirement type="package" version="0.11.3">python-igraph</requirement>
        <yield />
    </xml>

    <token name="@PREP_ADATA@"><![CDATA[
        cp '$method.adata' 'anndata.h5ad' &&
        ]]>
    </token>

    <token name="@CMD@"><![CDATA[
        cat '$script_file' > '$hidden_output' &&
        python '$script_file' >> '$hidden_output' &&
        ls . >> '$hidden_output' &&
		touch 'anndata_info.txt' &&
		cat 'anndata_info.txt' @CMD_prettify_stdout@
        ]]>
    </token>

    <token name="@CMD_prettify_stdout@"><![CDATA[ | sed -r '1 s|AnnData object with (.+) = (.*)\s*|\1: \2|g' | sed "s|'||g"  | sed -r 's|^\s*(.*):\s(.*)|[\1]\n-    \2|g' | sed 's|, |\n-    |g'
    ]]></token>

    <token name="@CMD_imports@"><![CDATA[
import snapatac2 as sa
    ]]>
    </token>
    <xml name="sanitize_query" token_validinitial="string.printable">
        <sanitizer>
            <valid initial="@VALIDINITIAL@">
                <remove value="&apos;" />
            </valid>
        </sanitizer>
    </xml>
    
    <xml name="inputs_anndata">
        <param name="adata" type="data" format="h5ad" label="Annotated data matrix"/>
    </xml>
    
    <token name="@CMD_read_inputs@"><![CDATA[

adata = sa.read('anndata.h5ad')
]]>
    </token>

    <xml name="dimentions_plot">
        <param name="width" type="integer" value="500" label="Width of the plot"/>
		<param name="height" type="integer" value="400" label="Height of the plot"/>
    </xml>

    <xml name="param_groupby">
        <param argument="groupby" type="text" optional="flase" label="The key of the observation grouping to consider" help="If it is given, the plot is ordered by the respective group. It is expected that to be a categorical. If it is not a categorical observation, it would be subdivided into 'num_categories'.">
            <expand macro="sanitize_query" />
        </param>
    </xml>

    <xml name="out_file">
        <param name="out_file" type="select" optional="true" label="Type of output file">
            <option value="png" selected="true">PNG</option>
            <option value="svg" >SVG</option>
            <option value="pdf">PDF</option>
            <option value="html">HTML</option>
		</param>
    </xml>
    <token name="@CMD_anndata_write_outputs@"><![CDATA[
adata.write('anndata.h5ad')
with open('anndata_info.txt','w', encoding='utf-8') as ainfo:
    print(adata, file=ainfo)
]]>
    </token>
    <xml name="inputs_common_advanced">
        <section name="advanced_common" title="Advanced Options" expanded="false">
            <param name="show_log" type="boolean"  checked="false" label="Output Log?" />
        </section>
    </xml>
    <xml name="render_plot">
        <param name="width" type="integer" value="600" label="Width of the plot"/>
        <param name="height" type="integer" value="400" label="Height of the plot"/>
        <param name="scale" type="float" optional="true" label="Scale factor for the image"/>
        <expand macro="out_file"/>
    </xml>
    <xml name="shift">
    	<param name="shift_left" type="integer" value="4" label="Insertion site correction for the left end" help="Note this has no effect on single-end reads"/>
    	<param name="shift_right" type="integer" value="5" label="Insertion site correction for the right end" help="Note this has no effect on single-end reads"/>
    </xml>
    <xml name="chunk_size">
    	<param name="chunk_size" type="integer" value="500" label="chunk size"/>
    </xml>
    <xml name="backend">
    	<param name="backend" type="select" label="The backend">
    		<option value="hdf5" selected="true">hdf5</option>
    	</param>
	</xml>
	<xml name="min_max_frag_size">
		<param name="min_frag_size" type="integer" optional="true" label="Minimum fragment size to include"/>
		<param name="max_frag_size" type="integer" optional="true" label="Maximum fragment size to include"/>
	</xml>
	<xml name="inplace">
		<param name="inplace" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Whether to add the tile matrix to the AnnData object or return a new AnnData object"/>
	</xml>
	<xml name="verbose">
		<param name="verbose" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Whether to print progress messages"/>
	</xml>
    <xml name="use">
        <param name="use_rep" type="text" value="X_spectral" optional="flase" label="The key for the matrix"/>
		<param name="use_dims" type="text" optional="true" label="The dimensions used for computation">
			<expand macro="sanitize_query"/>
		</param>
    </xml>
	<xml name="data_integration">
		<expand macro="use"/>
		<param argument="groupby" type="text" optional="true" label="The key of the observation grouping to consider">
            <expand macro="sanitize_query" />
        </param>
		<param name="key_added" type="text" optional="true" label="If specified, add the result to adata.obsm with this key"/>
	</xml>  
    <xml name="n_comps">
        <param name="n_comps" type="integer" value="30" label="Number of dimensions to keep"/>
    </xml>
    <xml name="random_state">
        <param name="random_state" type="integer" value="0" label="Seed of the random state generator"/>
    </xml>
    <xml name="weighted_by_sd">
        <param name="weighted_by_sd" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Whether to weight the result eigenvectors by the square root of eigenvalues"/>
    </xml>
    <xml name="key_added">
        <param name="key_added" type="integer" label="adata.obs key under which to add the cluster labels"/>
    </xml>
    <xml name="use_rep">
        <param name="use_rep" type="text" value="X_spectral" optional="flase" label="Which data in adata.obsm to use for clustering"/>
    </xml>
    <xml name="genome_fasta">
        <param name="genome_fasta" type="text" optional="false" label="A fasta file containing the genome sequences or a Genome object"/>
    </xml>
    <xml name="background">
        <param name="background" type="text" optional="true" label="A list of regions to be used as the background">
			<expand macro="sanitize_query"/>
		</param>
    </xml>
    <xml name="mat">
        <param name="peak_mat" type="data" format="h5ad" optional="true" label="AnnData or AnnDataSet object storing the cell by peak count matrix"/>
		<param name="gene_mat" type="data" format="h5ad" optional="true" label="AnnData or AnnDataSet object storing the cell by gene count matrix"/>
    </xml>
    <xml name="network">
        <param name="network" type="text" optional="flase" label="network"/>
    </xml>
    <xml name="citations">
        <citations>
            <citation type="doi">10.1101/2023.09.11.557221</citation>
        </citations>
    </xml>
    <xml name="render_plot_test">
    	<param name="width" value="650"/>
        <param name="height" value="450"/>
        <param name="scale" value="1"/>
    </xml>
    <xml name="render_plot_matching_text">
    	<has_text_matching expression="width = 650"/>
        <has_text_matching expression="height = 450"/>
        <has_text_matching expression="scale = 1"/>
    </xml>
    <token name="@CMD_params_render_plot@"><![CDATA[
width = $method.width,
height = $method.height,
out_file = 'plot.$method.out_file',
#if $method.scale
scale = $method.scale
#end if
    ]]>
    </token>
</macros>
