<tool id='matutils' name='matUtils' version='@TOOL_VERSION@+@GALAXY_TOOL_VERSION@' profile='20.01'>
    <description>analyze, edit, and manipulate mutation annotated tree files</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro='edam_ontology' />
    <expand macro='requirements' />
    <version_command>usher --version</version_command>
    <command detect_errors='exit_code'><![CDATA[
        matUtils
        --input-mat $mutation_annotaton_file
        --threads \${GALAXY_SLOTS:-1}

    ]]>    </command>
    <inputs>
        <param name="mutation_annotation_file" type="data" format="protobuf3" label="Mutation-annotated tree object" help="Load a mutation annotated tree file, in protocol-buffers format (protobuf3)."/>
        <conditional name="matutils_mode">
            <param name="options_mode" type="select" label="matUtils mode">
                <option value="extract">Extract: subsetting and converting a MAT pb to other file formats</option>
                <option value="summary">Summary: get basic statistics and attribute information about the MAT</option>
                <option value="annotate">Annotate: adding clade annotation information to the MAT</option>
                <option value="uncertainly">Uncertainly: calculates two specific metrics for sample placement certainty</option>
                <option value="mask">Mask: mask specific samples out of the MAT, removing their mutations from visibility</option>
            </param>
            <when value="extract">
                <conditional name="operation_mode">
                    <param name="operation" type="select" label="Operation mode">
                        <option value="samples">Select samples by naming them</option>
                        <option value="clade">Select samples by clade(s)</option>
                        <option value="mutation">Select samples by mutation</option>
                        <option value="max-epps">Select samples by parsimonious placements</option>
                        <option value="max-parsimony">Select samples by parsimonious score</option>
                        <option value="nearest-k">Select samples by sample and context</option>
                        <option value="max-branch-lenght">Remove samples by branch lenght</option>
                    </param>
                    <when value="samples">       
                        <param argument="--samples" type="data" format="txt" optional="True" label="Select samples by explicitly naming them, one per line in a plain text file" />
                        <param argument="--prune" type="boolean" truevalue="--prune" falsevalue="" label="Remove the selected samples" help="Remove the selected samples instead of keeping them in the output files" />
                    </when>
                    <when value="clade">   
                        <param argument="--clade" type="text" value="" label="Select samples by membership in any of the indicated clade(s), comma delimited- e.g. -c clade1,clade2">
                            <expand macro="sanitize_string" />
                        </param>
                        <param argument="--prune" type="boolean" truevalue="--prune" falsevalue="" label="Remove the selected samples" help="Remove the selected samples instead of keeping them in the output files" />
                    </when>
                    <when value="mutation">    
                        <param argument="--mutation" type="text" value="" label="Select samples by whether they contain any of the indicated mutation(s), comma delimited- e.g. -m mutation1,mutation2">
                            <expand macro="sanitize_string" />
                        </param>
                        <param argument="--prune" type="boolean" truevalue="--prune" falsevalue="" label="Remove the selected samples" help="Remove the selected samples instead of keeping them in the output files" />
                    </when>
                    <when value="max-epps">   
                        <param argument="--max-epps" type="integer" min="0" max="1000" value="" label="Select samples by whether they have less than or equal to the maximum number of indicated equally parsimonious placements" />
                        <param argument="--prune" type="boolean" truevalue="--prune" falsevalue="" label="Remove the selected samples" help="Remove the selected samples instead of keeping them in the output files" />
                    </when>
                    <when value="max-parsimony">   
                        <param argument="--max-parsimony" type="integer" min="0" max="1000" value="" label="Select samples by whether they have less than or equal to the indicated maximum parsimony score (terminal branch length)" />
                        <param argument="--prune" type="boolean" truevalue="--prune" falsevalue="" label="Remove the selected samples" help="Remove the selected samples instead of keeping them in the output files" />
                    </when>
                    <when value="nearest-k">
                        <param argument="--nearest-k" type="text" value="" label="Select a specific sample and X context samples, formatted as 'sample_name:X'">
                            <expand macro="sanitize_string" />
                        </param>
                        <param argument="--prune" type="boolean" truevalue="--prune" falsevalue="" label="Remove the selected samples" help="Remove the selected samples instead of keeping them in the output files" />
                    </when>
                    <when value="max-branch-lenght">       
                        <param argument="--max-branch-length" type="integer" min="0" max="1000" value="" label="Remove samples which have branches of greater than the indicated length in their ancestry" />
                    </when>
                </conditional>
                <param argument="--get-representative" type="boolean" truevalue="--get-representative" falsevalue="" label="Select two representative samples per clade" help=" Toggle to automatically select two representative samples per clade currently included in the tree, pruning all other samples from the tree. Applies after other selection steps" />
                <param argument="--resolve-polytomies" type="boolean" truevalue="--resolve-polytomies" falsevalue="" label="Resolve all polytomies" help="Resolve all polytomies by assigning branch length 0 relationships arbitrarily. Applied after selection; prevents recondensing of the MAT" />
                <param name="outputs" type="select" display="checkboxes" multiple="true" optional="true" label="Select the desired output">
                    <option value="--used-samples selected_sample_ids.txt">Write a simple text file containing selected sample names</option>
                    <option value="--sample-paths path_mutations.tabular">Write the path of mutations defining each sample in the subtree</option>
                    <option value="--clade-paths path_clades.tabular">Write the path of mutations defining each clade in the subtree</option>
                    <option value="--all-paths all_paths.txt">Write mutations assigned to each node in the subtree in depth-first traversal order</option>
                    <option value="--write-vcf subtree.vcf">Output VCF file representing selected subtree</option>  
                    <option value="--write-vcf subtree_no_genotype.vcf --no-genotypes">Output VCF file representing selected subtree without including genotype column</option>  
                    <option value="--write-mat mutation_annotated.pb">Write the selected subtree as a mutation annotated tree</option>  
                    <option value="--write-mat mutation_annotated.pb --collapse-tree">Write the selected subtree as a collapsed mutation annotated tree</option>  
                    <option value="--write-json subtree.json">Write an Auspice-compatbile json representing the selected subtree</option>  
                    <option value="--write-tree tree.nh"> Write a newick string representing the selected subtree</option>
                    <option value="--write-tree tree.nh --retain-branch-length"> Write a newick string representing the selected subtree without recalculating branch lenghts</option>  
                </param>
            </when>
            <when value="summary">
                <param name="summary_options" type="select" display="checkboxes" multiple="true" label="Select statistics and attribute information">
                    <option value="">Number of nodes, number of samples, number of condensed nodes, and total tree parsimony</option>
                    <option value="--samples samples.tabular">Samples in the tree and their parsimony score (terminal branch length)</option>
                    <option value="--clades clades.tabular">Clades and the count of associated samples in the tree</option>
                    <option value="--mutations mutations.tabular">Mutations in the tree and their occurrence count</option>
                    <option value="--aberrant aberrant.tabular">Potentially problematic nodes</option>
                </param>
            </when>
            <when value="annotate">
                <param name="clade_names" type="data" format="tabular" optional="True" label="File containing clade asssignments of samples" help="An algorithm automatically locates and annotates clade root nodes."/>
                <param name="clade_to_nid" type="data" format="tabular" optional="True" label="File mapping clades to their respective internal node identifiers" help="Internal node names are not maintained when saving and loading from a .pb file. It is not guaranteed that internal node names will correspond directly between two .pb files, so use the direct assignment method with caution."/>                
                <param argument="--set-overlap" type="float" min="0" max="1" value="" label="Minimum fraction of the lineage samples" help=" Minimum fraction of the lineage samples that should be desecendants of the assigned clade root. Defualt = 0.6." />
                <param argument="--clear-current" type="boolean" truevalue="--clear-current" falsevalue="" label="Remove current annotations" help="Use to remove current annotations before applying new annotations." />
                <param argument="--allele-frequency" type="float" min="0" max="1" value="" label=" Minimum allele frequency for finding the best clade root" help=" Minimum allele frequency in input samples for finding the best clade root. Used only with -l. Default = 0.8." />
            </when>
            <when value="uncertainly">
                <param argument="--samples" type="data" format="txt" label="Select samples by explicitly naming them, one per line in a plain text file" />
                <param name="uncertainly_options" type="select" display="checkboxes" multiple="true" label="Metrics for sample placement certainty">
                    <option value="--get-parsimony">Total tree parsimony score</option>
                    <option value="--find-epps equally_parsimonious.tabular">Number of equally parsimonious placements for each sample</option>
                    <option value="--find-neighborhood neighborhood.tabular">Neighborhood size scores</option>
                </param>
            </when>
            <when value="mask">
                <param name="restricted-sample" type="data" format="txt" label="Select samples by explicitly naming them, one per line in a plain text file" help="Sample names to restrict. Use to perform masking"/>
                <param name="rename-samples" type="data" format="tabular" optional="True" label="TSV file containing names of the samples to be renamed and their new names"/>
                <param argument="--simplify" type="boolean" truevalue="--simplify" falsevalue="" label="Use to automatically remove identifying information from the tree, including all sample names and private mutations" />
            </when>
        </conditional>
    </inputs>
    <outputs>
    </outputs>
    <tests>
    </tests>
    <help><![CDATA[

    hello, world!

    ]]>    </help>
    <expand macro="citations" />
</tool>
