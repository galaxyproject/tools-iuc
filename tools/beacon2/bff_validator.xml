<tool id="bff_validator" name="Beacon2 BFF Validator" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <description>Validate and serialize XLSX/JSON metadata against Beacon v2 Models</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <expand macro="creators"/>
    <command detect_errors="exit_code"><![CDATA[   
        ln -s '$schema_dir' ./schema_dir &&
        #import re
        #set $names = []
        #set $x=1
        #for $x, $i in enumerate($input):
            #set $name_base = re.sub('[^\w\-_\.]', '_', $i.element_identifier)
            #set $name = $name_base
            #silent $names.append( $name )
            ln -s '$i' ${name}  &&
        #end for
        bff-validator
            #for $name in $names:
                --input ${name}
            #end for
            #if str($bff_input.input_bff_file) == "json":
                #if str($bff_input.genomicVariations.genomicVariations_avail) == "yes":    
                    $bff_input.genomicVariations.gv
                #end if
                $bff_input.ignore_validation
            #end if
            #if str($bff_input.input_bff_file) == "xlsx":
                --out-dir ./
            #end if
            --schema-dir ./schema_dir
            > bff_validation.txt
    ]]></command>
    <inputs>
        <param argument="--input" type="data" multiple="true" format="json" label="Metadata xlsx or Json files" help="" />
        <conditional name="bff_input">
            <param name="input_bff_file" type="select" label="Type of bff file" help="">
                <option value="xlsx" >Validate the quality of the XLSX metadata file</option>
                <option value="json" selected="True">Validate the quality of the JSON file/s</option>
            </param>
            <when value="xlsx">
            </when>
            <when value="json">
                <conditional name="genomicVariations">
                    <param name="genomicVariations_avail" type="select" label="Do you have genomicVariations.json file withen your data" help="">
                        <option value="yes">Check this if you are validating genomicVariations file</option>
                        <option value="no" selected="True">No genomicVariations file in your input data</option>
                    </param>
                    <when value="yes">
                        <param argument="-gv" type="boolean" checked="false" truevalue="-gv" falsevalue="" label="process genomicVariations.json entity" help="" />
                    </when>
                    <when value="no">
                    </when>
                </conditional>
                <param argument="--ignore-validation" type="boolean" checked="false" truevalue="--ignore-validation" falsevalue="" label="Ignore validation" help="Writes JSON collection regardless of results from validation against JSON schemas" />
            </when>
        </conditional>
        <param argument="--schema-dir" type="data" format="directory" label="Directory with JSON schemas" help="Must have JSON pointers de-referenced" />
    </inputs>
    <outputs>
        <data name="validate_bff_files" format="txt" label="${tool.name} on ${on_string}: validate_bff_files results" from_work_dir="bff_validation.txt" />
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_bff_file" value="json" />
            <param name="input" ftype="json" value="runs.json,individuals.json" />
            <param name="schema_dir" value="deref_schemas" />
            <output name="validate_bff_files" file="bff_validation.txt" compare="sim_size">
                <assert_contents><has_size value="1000" delta="100" /></assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
           A script that validates metadata (XLSX|JSON) against Beacon v2 Models and serializes it to BFF (JSON)
    ]]></help>
    <expand macro="citations" />
</tool>