<tool id="bff_validator" name="Beacon2 BFF Validator" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <description>Validate and serialize XLSX metadata against Beacon v2 Models and serializes it to BFF (JSON)</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <expand macro="creators"/>
    <command detect_errors="exit_code"><![CDATA[   
        ln -s '$schema_dir' ./schema_dir &&
        ln -s '$input' ./input.xlsx &&
        #import re
        bff-validator
            --input ./input.xlsx
            --schema-dir ./schema_dir
            --out-dir ./
            $ignore_validation
            > bff_validation.txt
    ]]></command>
    <inputs>
        <param argument="--input" type="data" multiple="true" format="xlsx" label="Metadata xlsx or Json files" help="" />
        <param argument="--schema-dir" type="data" format="directory" label="Directory with JSON schemas" help="Must have JSON pointers de-referenced" />
        <param argument="-ignore-validation" type="boolean" checked="false" truevalue="-ignore-validation" falsevalue="" label="Ignore validation" help="Writes JSON collection regardless of results from validation against JSON schemas" />
    </inputs>
    <outputs>
        <data name="validate_bff_files" format="txt" label="${tool.name} on ${on_string}: Validate bff files results" from_work_dir="bff_validation.txt" />
        <data name="analyses" format="json" label="${tool.name} on ${on_string}: Analyses Metadata" from_work_dir="analyses.json" />
        <data name="runs" format="json" label="${tool.name} on ${on_string}: Runs Metadata" from_work_dir="runs.json" />
        <data name="individuals" format="json" label="${tool.name} on ${on_string}: individuals Metadata" from_work_dir="individuals.json" />
        <data name="biosamples" format="json" label="${tool.name} on ${on_string}: Biosamples Metadata" from_work_dir="biosamples.json" />
        <data name="cohorts" format="json" label="${tool.name} on ${on_string}: Cohorts Metadata" from_work_dir="cohorts.json" />
        <data name="datasets" format="json" label="${tool.name} on ${on_string}: Datasets Metadata" from_work_dir="datasets.json" />
    </outputs>
    <tests>
        <test expect_num_outputs="7">
            <param name="input" ftype="xlsx" value="template.xlsx" />
            <param name="ignore_validation" value="1"/>
            <param name="schema_dir" value="deref_schemas" />
            <output name="validate_bff_files" file="bff_validation.txt" compare="sim_size">
                <assert_contents><has_size value="5000" delta="2500" /></assert_contents>
            </output>
            <output name="analyses" file="analyses.json" />
            <output name="runs" file="runs.json"  compare="sim_size">
                <assert_contents><has_size value="15000" delta="5000" /></assert_contents>
            </output>
            <output name="individuals" file="individuals.json" compare="sim_size" >
                <assert_contents><has_size value="75000" delta="5000" /></assert_contents>
            </output>
            <output name="biosamples" file="biosamples.json" />
            <output name="cohorts" file="cohorts.json" />
            <output name="datasets" file="datasets.json" />
        </test>
    </tests>
    <help><![CDATA[
           This tool validates metadata (XLSX) against Beacon v2 Models and serializes it to BFF (JSON).
        It generates six metadata files: analyses.json, biosamples.json, cohorts.json, datasets.json, individuals.json, and runs.json.
        
        **Inputs**:
        - **Metadata Files**: Upload XLSX file containing metadata.
        - **Schema Directory**: Provide a directory containing JSON schemas (must have JSON pointers de-referenced).
        
        **Options**:
        - **Ignore Validation**: Check this to write the JSON collection regardless of validation results.
        
        **Outputs**:
        - **Validation Results**: A text file containing the results of the validation.
        - **Metadata JSON Files**: The tool outputs JSON files for analyses, runs, individuals, biosamples, cohorts, and datasets.
    ]]></help>
    <expand macro="citations" />
</tool>