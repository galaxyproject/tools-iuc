<tool id="music-deconvolution" name="MuSiC" version="@GALAXY_VERSION@+@PACKAGE_VERSION@" python_template_version="3.5">
    <requirements>
        <requirement type="package" version="@PACKAGE_VERSION@" >music-deconvolution</requirement>
        <requirement type="package" version="0.9.3" >r-cowplot</requirement>
        <requirement type="package" version="1.4.4" >r-reshape2</requirement>
    </requirements>
    <macros>
        <macro name="celltypes_macro" >
            <param name="celltypes" type="text" optional="true" value=""
                   label="List of cell types to use from scRNA dataset" help="If NULL, then use all cell types." />
        </macro>
        <token name="@GALAXY_VERSION@">0</token>
        <token name="@PACKAGE_VERSION@">0.1.1</token>
    </macros>
    <command detect_errors="exit_code"><![CDATA[
mkdir report_data &&
Rscript --vanilla $__tool_directory__/scripts/${do.method}.R '$conf'
]]></command>
    <configfiles>
        <configfile name="conf" >

null_str_vec = function(gstr){
   tokens = unlist(as.vector(strsplit(gstr, split=",")))
   if (length(tokens) == 0){
      return(NULL)
   }
   if (length(tokens) == 1){
      return(tokens[[1]])
   }
   return(tokens)
}

#if str($do.method) == "estimateprops":

bulk_eset = readRDS('$do.bulk_eset')
scrna_eset = readRDS('$do.scrna_eset')

phenotype_factors = null_str_vec('$do.phenotype_factors')
celltypes_label = null_str_vec('$do.celltypes_label')
samples_label = null_str_vec('$do.samples_label')
celltypes = null_str_vec('$do.celltypes')
methods = null_str_vec('$do.methods')
phenotype_gene = null_str_vec('$do.phenotype_gene')
sample_groups = null_str_vec('$do.sample_groups')
sample_disease_group = null_str_vec('$do.sample_disease_group')
sample_disease_group_scale = as.integer('$do.sample_disease_group_scale')
healthy_phenotype = null_str_vec('$do.healthy_phenotype')
compare_title = null_str_vec('$do.compare_title')
outfile_pdf='$out_pdf'

#elif str($do.method) == "dendrogram":

bulk_eset = readRDS('$do.bulk_eset')
scrna_eset = readRDS('$do.scrna_eset')

celltypes_label = null_str_vec('$do.celltypes_label')
clustertype_label = null_str_vec('$do.clustertype_label')
samples_label = null_str_vec('$do.samples_label')
celltypes = null_str_vec('$do.celltypes')

data.to.use = list(
    #for $i, $repeat in enumerate( $do.cluster_groups )
        $repeat.cluster_id = list(cell.types = c( null_str_vec('$repeat.celltypes') ),
                                  marker.names = null_str_vec('$repeat.marker_name'),
                                  marker.list = read_list('$repeat.marker_list')),
    #end for
)

outfile_pdf='$out_pdf'

#elif str($do.method) == "inspect":

rds_eset = readRDS('$do.rds_eset')
inspector = null_str_vec('$do.inspector')
outfile_tab='$out_tab'

#else
    stop("No such option")
#end if

        </configfile>
    </configfiles>
    <inputs>
        <conditional name="do" >
            <param name="method" type="select" label="Purpose" >
                <!-- The values here correspond to script names in the scripts folder
                     and must remain so -->
                <option value="inspect">Inspect Dataset</option>
                <option value="estimateprops">Estimate Proportions</option>
                <option value="dendrogram">Compute Dendrogram</option>
            </param>
            <when value="inspect" >
                <param name="rds_eset" label="ESet Dataset" type="data" format="rdata" />
                <param name="inspector" label="Inspect" type="select"
                       help="Inspect an aspect of the ESet dataset" >
                    <!-- See: https://www.rdocumentation.org/packages/Biobase/versions/2.32.0/topics/eSet -->
                    <option value="print" selected="true">General Information</option>
                    <option value="pData" >PhenoType Data Table</option>
                    <option value="fData" >Feature Data Table</option>
                    <option value="dims" >Dimension</option>
                    <option value="experimentData" />
                    <option value="signature" />
                    <option value="annotation" />
                    <option value="abstract" />
                </param>
            </when>
            <when value="estimateprops" >
                <param name="scrna_eset" label="scRNA Dataset" type="data" format="rdata" />
                <param name="bulk_eset" label="Bulk RNA Dataset" type="data" format="rdata" />
                <param name="celltypes_label" type="text" value="cellType"
                       label="Cell Types Label from scRNA dataset" />
                <param name="samples_label" type="text" value="sampleID"
                       label="Samples Identifier from scRNA dataset" />
                <expand macro="celltypes_macro" />
                <param name="methods" multiple="true" type="select" display="checkboxes" label="Cell Proportion Method" >
                    <option value="MuSiC" selected="true" />
                    <option value="NNLS" selected="true" />
                </param>
                <param name="phenotype_factors" type="text"
                       label="List of phenotypes factors" help="If NULL, then use all phenotypes." />
                <param name="phenotype_gene" type="text" label="Causative Gene"
                       help="MUST exist in the phenotype factors above." />
                <param name="sample_groups" type="text" label="List of Sample Groups" />
                <param name="sample_disease_group" type="text" label="Sample Disease Group"
                       help="MUST exist in the sample_groups above." />
                <param name="sample_disease_group_scale" type="integer"
                       label="Sample Disease Group (Scale)" value="5"
                       help="Used to accentutate certain features in the plots. Increase this number to reduce the effect."/>
                <param name="healthy_phenotype" type="text" label="Healthy Phenotype" />
                <param name="compare_title" type="text" label="Plot Title" />
            </when>
            <when value="dendrogram" >
                <param name="scrna_eset" label="scRNA Dataset" type="data" format="rdata" />
                <param name="bulk_eset" label="Bulk RNA Dataset" type="data" format="rdata" />

                <param name="celltypes_label" type="text" value="cellType"
                       label="Cell Types Label from scRNA dataset" />
                <param name="clustertype_label" type="text" value="clusterType"
                       label="Cell Types Label from scRNA dataset" />
                <param name="samples_label" type="text" value="sampleID"
                       label="Samples Identifier from scRNA dataset" />
                <expand macro="celltypes_macro" />
                <repeat name="cluster_groups" title="Cluster Groups" min="2" >
                    <param name="cluster_id" label="Cluster ID" type="text" value=""
                           help="e.g. C1 or Cluster1, etc." />
                    <expand macro="celltypes_macro" />
                    <param name="marker_name" label="Marker Gene Group Name" type="text"
                           help="Name of the list of geme markers used to describe the marker list supplied below." />
                    <param name="marker_list" label="List of Gene Markers" type="data" format="tabular"
                           help="A single column of marker genes" />
                </repeat>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="out_tab" format="tabular" label="${tool.name} on ${on_string}: Inspection Result" >
            <filter>do["method"] == "inspect"</filter>
        </data>
        <data name="out_pdf" format="pdf" label="${tool.name} on ${on_string}: PDF Plots" >
            <filter>do["method"] != "inspect"</filter>
        </data>
        <collection name="summaries" type="list" label="${tool.name} on ${on_string}: Method Summaries">
            <filter>do["method"] != "inspect"</filter>
            <discover_datasets pattern="summ_(?P&lt;designation&gt;.+)\.txt" format="txt"
                               directory="report_data" />
        </collection>
    </outputs>
    <tests>
        <test expect_num_outputs="2" >
            <!-- Estimate Proportions test -->
            <conditional name="do" >
                <param name="bulk_eset" value="GSE50244bulkeset.rds" />
                <param name="scrna_eset" value="EMTABesethealthy.rds" />
                <param name="method" value="estimateprops" />
                <param name="celltypes_label" value="cellType" />
                <param name="samples_label" value="sampleID" />
                <param name="celltypes" value="alpha,beta,delta,gamma,acinar,ductal" />
                <param name="methods" value="MuSiC,NNLS" />
                <param name="phenotype_factors" value="age,bmi,hba1c,gender" />
                <param name="phenotype_gene" value="hba1c" />
                <param name="sample_groups" value="Normal,T2D" />
                <param name="sample_disease_group" value="T2D" />
                <param name="sample_disease_group_scale" value="5" />
                <param name="healthy_phenotype" value="Normal" />
                <param name="compare_title" value="HbA1c vs Beta Cell Type Proportion" />
            </conditional>
            <output name="out_pdf" value="default_output.pdf" compare="sim_size" />
            <output_collection name="summaries" count="2">
                <element name="MuSiC" ftype="txt">
                    <assert_contents>
                        <has_text text="Residual standard error: 0.167 on 72 degrees of freedom"/>
                    </assert_contents>
                </element>
                <element name="NNLS" ftype="txt">
                    <assert_contents>
                        <has_text text="Residual standard error: 0.04799 on 72 degrees of freedom"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <test expect_num_outputs="1" >
            <!-- Inspect 0 -->
            <conditional name="do" >
                <param name="rds_eset" value="EMTABesethealthy.rds" />
                <param name="method" value="inspect" />
                <param name="inspector" value="print" />
            </conditional>
            <output name="out_tab" >
                <assert_contents>
                    <has_text text="sampleNames: AZ_A10 AZ_A11 ... HP1509101_P9 (1097 total)" />
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1" >
            <!-- Inspect 1 -->
            <conditional name="do" >
                <param name="rds_eset" value="EMTABesethealthy.rds" />
                <param name="method" value="inspect" />
                <param name="inspector" value="pData" />
            </conditional>
            <output name="out_tab" >
                <assert_contents>
                    <has_n_columns n="5" />
                    <has_text_matching expression="AZ_A10\s+1\s+Non T2D\s+1\s+5\s+delta" />
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1" >
            <!-- Inspect 2 -->
            <conditional name="do" >
                <param name="rds_eset" value="EMTABesethealthy.rds" />
                <param name="method" value="inspect" />
                <param name="inspector" value="dims" />
            </conditional>
            <output name="out_tab" >
                <assert_contents>
                    <has_n_columns n="1" />
                    <has_text_matching expression="Samples\s+1097"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
</tool>