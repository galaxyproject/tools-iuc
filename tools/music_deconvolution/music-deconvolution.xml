<tool id="music-deconvolution" name="MuSiC" version="@GALAXY_VERSION@+@PACKAGE_VERSION@" python_template_version="3.5">
    <requirements>
        <requirement type="package" version="@PACKAGE_VERSION@" >music-deconvolution</requirement>
        <requirement type="package" version="0.9.3" >r-cowplot</requirement>
        <requirement type="package" version="1.4.4" >r-reshape2</requirement>
    </requirements>
    <macros>
        <token name="@GALAXY_VERSION@">0</token>
        <token name="@PACKAGE_VERSION@">0.1.1</token>
    </macros>
    <command detect_errors="exit_code"><![CDATA[
#if str($do.method) == "estprop":
    Rscript --vanilla $__tool_directory__/scripts/estimateprops.R '$conf'
#elif str($purpose.do) == "dendrog":

#else

#end if
]]></command>
    <configfiles>
        <configfile name="conf" >
bulk_eset = readRDS('$bulk_eset')
scrna_eset = readRDS('$scrna_eset')

str_or_vec = function(gstr){
   tokens = unlist(as.vector(strsplit(gstr, split=",")))
   if (length(tokens) == 1){
      return(tokens[[1]])
   }
   return(tokens)
}

#if str($do.method) == "estprop":
clusters_label = str_or_vec('$do.clusters_label')
samples_label = str_or_vec('$do.samples_label')
phenotype_factors = str_or_vec('$do.phenotype_factors')
celltypes = str_or_vec('$do.celltypes')
methods = str_or_vec('$do.methods')
phenotype_gene = str_or_vec('$do.phenotype_gene')
sample_groups = str_or_vec('$do.sample_groups')
sample_disease_group = str_or_vec('$do.sample_disease_group')
sample_disease_group_scale = as.integer('$do.sample_disease_group_scale')
healthy_phenotype = str_or_vec('$do.healthy_phenotype')

compare_title = str_or_vec('$do.compare_title')

#elif str($do.method) == "dendrog":

#else
    stop("No such option")
#end if

outfile_pdf='$out_pdf'

        </configfile>
    </configfiles>
    <inputs>
        <param name="bulk_eset" label="Bulk RNA Dataset" type="data" format="rdata" />
        <param name="scrna_eset" label="scRNA Dataset" type="data" format="rdata" />

        <conditional name="do" >
            <param name="method" type="select" label="Purpose" >
                <option value="estprop">Estimate Proportions</option>
                <option value="dendrog">Compute Dendrogram</option>
            </param>
            <when value="estprop" >
                <param name="clusters_label" type="text" value="cellType"
                       label="Cluster Identifier from scRNA dataset" />
                <param name="samples_label" type="text" value="sampleID"
                       label="Samples Identifier from scRNA dataset" />
                <param name="celltypes" type="text" optional="true" value=""
                       label="List of cell types to use" help="If NULL, then use all cell types." />
                <param name="methods" multiple="true" type="select" display="checkboxes" label="Cell Proportion Method" >
                    <option value="MuSiC" selected="true" />
                    <option value="NNLS" selected="true" />
                </param>
                <param name="phenotype_factors" type="text"
                       label="List of phenotypes factors" help="If NULL, then use all phenotypes." />
                <param name="phenotype_gene" type="text" label="Causative Gene"
                       help="MUST exist in the phenotype factors above." />
                <param name="sample_groups" type="text" label="List of Sample Groups" />
                <param name="sample_disease_group" type="text" label="Sample Disease Group"
                       help="MUST exist in the sample_groups above." />
                <param name="sample_disease_group_scale" type="integer"
                       label="Sample Disease Group (Scale)" value="5"
                       help="Used to accentutate certain features in the plots. Increase this number to reduce the effect."/>
                <param name="healthy_phenotype" type="text" label="Healthy Phenotype" />
                <param name="compare_title" type="text" label="Plot Title" />
            </when>
            <when value="dendrog" >
                <!-- TODO! -->
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="out_pdf" format="pdf" label="${tool.name} on ${on_string}: PDF Plots" />
    </outputs>
    <tests>
        <test expect_num_outputs="1" >
            <param name="bulk_eset" value="GSE50244bulkeset.rds" />
            <param name="scrna_eset" value="EMTABesethealthy.rds" />
            <conditional name="do" >
                <param name="method" value="estprop" />
                <param name="clusters_label" value="cellType" />
                <param name="samples_label" value="sampleID" />
                <param name="celltypes" value="alpha,beta,delta,gamma,acinar,ductal" />
                <param name="methods" value="MuSiC,NNLS" />
                <param name="phenotype_factors" value="age,bmi,hba1c,gender" />
                <param name="phenotype_gene" value="hba1c" />
                <param name="sample_groups" value="Normal,T2D" />
                <param name="sample_disease_group" value="T2D" />
                <param name="sample_disease_group_scale" value="5" />
                <param name="healthy_phenotype" value="Normal" />
                <param name="compare_title" value="HbA1c vs Beta Cell Type Proportion" />
            </conditional>
            <output name="out_pdf" value="default_output.pdf" compare="sim_size" />
        </test>
    </tests>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
</tool>