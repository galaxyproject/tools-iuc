<tool id="arriba_drawfusions" name="Draw Fusions" version="@TOOL_VERSION@+galaxy@WRAPPER_VERSION@" profile="@PROFILE@" license="GPL-3.0-or-later" >
    <description>
        a tool for the drawing the gene fusions from RNA-Seq data generated by Arriba
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <expand macro="requirements" />
        <requirement type="package" version="1.26.4" >bioconductor-genomeinfodb</requirement>
        <requirement type="package" version="1.2.4" >bioconductor-genomeinfodbdata</requirement>
        <requirement type="package" version="1.26.0" >bioconductor-genomicalignments</requirement>
        <requirement type="package" version="1.42.0" >bioconductor-genomicranges</requirement>
    </requirements>
    <version_command><![CDATA[
    @VERSION_COMMAND@
    ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[

#if $alignments
    #if $alignments.datatype.file_ext == 'sam'
        #set $alignfile = 'alignments.sam'
        ln -s '${alignments}' '$alignfile' &&
    #else
        #set $alignfile = 'alignments.bam'
        ln -s '${alignments}' '$alignfile' &&
        ln -s '${alignments.metadata.bam_index}' alignments.bai &&
    #end if
#end if

draw_fusions.R
--annotation='$annotation'
--fusions='$fusions'
--output='$output'
#if $alignments
    --alignments='$alignfile'
#end if
#if $cytobands
    --cytobands='$cytobands'
#end if
#if $proteinDomains
    --proteinDomains='$proteinDomains'
#end if
#if $plotopts.mergeDomainsOverlappingBy
    --mergeDomainsOverlappingBy='$plotopts.mergeDomainsOverlappingBy'
#end if
#if $plotopts.showIntergenicVicinity
    --showIntergenicVicinity='$plotopts.showIntergenicVicinity'
#end if
#if $plotopts.transcriptSelection
    --transcriptSelection='$plotopts.transcriptSelection'
#end if
#if $plotopts.minConfidenceForCircosPlot
    --minConfidenceForCircosPlot='$plotopts.minConfidenceForCircosPlot'
#end if
#if $plotopts.fontSize
    --fontSize='$plotopts.fontSize'
#end if
#if $plotopts.pdfWidth
    --pdfWidth='$plotopts.pdfWidth'
#end if
#if $plotopts.pdfHeight
    --pdfHeight='$plotopts.pdfHeight'
#end if
#if $plotopts.color1
    --color1='$plotopts.color1'
#end if
#if $plotopts.color2
    --color2='$plotopts.color2'
#end if
--squishIntrons='$plotopts.squishIntrons'
--printExonLabels='$plotopts.printExonLabels'
--render3dEffect='$plotopts.render3dEffect'
--optimizeDomainColors='$plotopts.optimizeDomainColors'

    ]]></command>
    <inputs>
        <param argument="--annotation" type="data" format="gtf" label="Gene Annotations" />
        <param argument="--fusions" type="data" format="tabular,tsv" label="Fusion Predictions"
               help="Predictions file from Arriba or STAR-Fusion" />
        <param argument="--alignments" type="data" format="bam" label="Alignments" optional="true"
               help="BAM file containing normal alignments from STAR. File must be sorted by coordinates and indexed. If this argument given, the script generates plots." />
        <param argument="--cytobands" type="data" format="tabular,tsv" label="Giemsa staining bands" optional="true"
               help="Coordinates of the Giemsa staining bands. This information is used to draw ideograms. If the argument is omitted, then no ideograms are rendered. The file must have the following columns: contig, start, end, name, giemsa. Recognized values for the Giemsa staining intensity are: gneg, gpos followed by a percentage, acen, stalk. Distributions of Arriba provide Giemsa staining annotation for all supported assemblies in the database directory." />
        <param argument="--proteinDomains" type="data" format="gff3" label="Coordinates of Protein Domains" optional="true"
               help="GFF3 file containing the genomic coordinates of protein domains. Distributions of Arriba offer protein domain annotations for all supported assemblies in the database directory. When this file is given, a plot is generated, which shows the protein domains retained in the fusion transcript." >
            <!-- This option requires the Bioconductor package GenomicRanges -->
        </param>
        <section name="plotopts" title="Plot Options" >
            <param argument="--mergeDomainsOverlappingBy" type="float" min="0" value="0.9" optional="true"
                   label="Merge Domains Overlapping By"
                   help="Occasionally, domains are annotated redundantly. For example, tyrosine kinase domains are frequently annotated as Protein tyrosine kinase and Protein kinase domain. In order to simplify the visualization, such domains can be merged into one, given that they overlap by the given fraction. The description of the larger domain is used. Default: 0.9" />
            <param argument="--showIntergenicVicinity" type="float" value="0" optional="true"
                   label="Intergenic Vicinity"
                   help="This option only applies to intergenic breakpoints. If it is set to a value greater than 0, then the script draws the genes which are no more than the given distance away from an intergenic breakpoint. Note that this option is incompatible with --squishIntrons. Default: 0" />
            <param argument="--transcriptSelection" type="select" optional="true"
                   label="Transcript Selection"
                   help="By default the transcript isoform with the highest coverage is drawn. Alternatively, the transcript isoform that is provided in the columns transcript_id1 and transcript_id2 in the given fusions file can be drawn. Selecting the isoform with the highest coverage usually produces nicer plots, in the sense that the coverage track is smooth and shows a visible increase in coverage after the fusion breakpoint. However, the isoform with the highest coverage may not be the one that is involved in the fusion. Often, genomic rearrangements lead to non-canonical isoforms being transcribed. For this reason, it can make sense to rely on the transcript selection provided by the columns transcript_id1/2, which reflect the actual isoforms involved in a fusion. As a third option, the transcripts that are annotated as canonical can be drawn. Transcript isoforms tagged with appris_principal, appris_candidate, or CCDS are considered canonical. Default: coverage" >
                <option value="coverage" />
                <option value="provided" />
                <option value="canonical" />
            </param>
            <param argument="--minConfidenceForCircosPlot" type="select"
                   help="The fusion of interest is drawn as a solid line in the circos plot. To give an impression of the overall degree of rearrangement, all other fusions are drawn as semi-transparent lines in the background. This option determines which other fusions should be included in the circos plot. none means only the fusion of interest is drawn; all other values specify the minimum confidence a fusion must have to be included. It usually makes no sense to include low-confidence fusions in circos plots, because they are abundant and unreliable, and would clutter up the circos plot. Default: medium" >
                <option value="none" />
                <option value="low" />
                <option value="medium" selected="true" />
                <option value="high" />
            </param>
            <param argument="--fontSize" type="float" min="0" value="1" optional="true"
                   label="Font Size" help="Decimal value to scale the size of text. Default: 1" />
            <param argument="--pdfWidth" type="float" min="0" value="11.692"
                   label="PDF Width"
                   help="Width of the pages of the PDF output file in inches. Default: 11.692" />
            <param argument="--pdfHeight" type="float" min="0" value="8.267"
                   label="PDF Height"
                   help="Height of the pages of the PDF output file in inches. Default: 8.267" />
            <param argument="--squishIntrons" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true"
                   label="Squish Intron"
                   help="Exons usually make up only a small fraction of a gene. They may be hard to see in the plot. Since introns are in most situations of no interest in the context of gene fusions, this switch can be used to shrink the size of introns to a fixed, negligible size. It makes sense to disable this feature, if breakpoints in introns are of importance. Default: TRUE" />
            <param argument="--color1" type="color" value="#e5a5a5"
                   label="5-prime color"
                   help="Color of the 5-prime end of the fusion. The color can be specified in any notation that is a valid color specification in R. Default: #e5a5a5" />
            <param argument="--color2" type="color" value="#a7c4e5"
                   label="3-prime color"
                   help="Color of the 3' end of the fusion. The color can be specified in any notation that is a valid color specification in R. Default: #a7c4e5" />
            <param argument="--printExonLabels" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true"
                   label="Print Exon Labels"
                   help="By default the number of an exon is printed inside each exon, which is taken from the attribute exon_number of the GTF annotation. When a gene has many exons, the boxes may be too narrow to contain the labels, resulting in unreadable exon labels. In these situations, it may be better to turn off exon labels. Default: TRUE"/>
            <param argument="--render3dEffect" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true"
                   label="Render 3D Effect"
                   help="Whether light and shadow should be rendered to give objects a 3D effect. Default: TRUE"/>
            <param argument="--optimizeDomainColors" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false"
                   label="Optimize Domain Colors"
                   help="By default, the script colorizes domains according to the colors specified in the file given in --annotation. This way, coloring of domains is consistent across all proteins. But since there are more distinct domains than colors, this can lead to different domains having the same color. If this option is set to TRUE, the colors are recomputed for each fusion separately. This ensures that the colors have the maximum distance for each individual fusion, but they are no longer consistent across different fusions. Default: FALSE"/>
        </section>
    </inputs>
    <outputs>
        <data name="output" format="pdf" label="${tool.name} on ${on_string}: Gene Fusions Vizualisation" />
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <!-- Defaults -->
            <param name="annotation" value="dm6.refGene.cg2930_ec.gtf" />
            <param name="fusions" value="fusions.tsv" />
            <output name="output" value="output.pdf" compare="sim_size" />
        </test>
        <test expect_num_outputs="1" >
            <!-- Toggle all parameters with non-defaults and use an alignment file -->
            <param name="annotation" value="dm6.refGene.cg2930_ec.gtf" />
            <param name="fusions" value="fusions.tsv" />
            <param name="alignments" value="tres.chrX_3851937_3873176.sorted.bam" >
                <!-- prints a coverage plot over the genes -->
            </param>
            <section name="plotopts" >
                <param name="mergeDomainsOverlappingBy" value="0.1" />
                <param name="showIntergenicVicinity" value="3.0" >
                    <!-- only works if squishIntrons is false -->
                </param>
                <param name="transcriptSelection" value="coverage" />
                <param name="minConfidenceForCircosPlot" value="low" />
                <param name="fontSize" value="0.3" />
                <param name="pdfWidth" value="5" />
                <param name="pdfHeight" value="5" />
                <param name="squishIntrons" value="FALSE" />
                <param name="color1" value="#c4bd97" />
                <param name="color2" value="#e36c09" />
                <param name="printExonLabels" value="FALSE" />
                <param name="render3dEffect" value="FALSE" />
                <param name="optimizeDomainColors" value="TRUE" />
            </section>
            <output name="output" value="output_withalign.pdf" compare="sim_size" />
        </test>
        <test expect_num_outputs="1" >
            <!-- Test extreme plot overlap values -->
            <param name="annotation" value="dm6.refGene.cg2930_ec.gtf" />
            <param name="fusions" value="fusions.tsv" />
            <param name="alignments" value="tres.chrX_3851937_3873176.sorted.bam" />
            <section name="plotopts" >
                <param name="mergeDomainsOverlappingBy" value="10" />
                <param name="showIntergenicVicinity" value="10" />
                <param name="transcriptSelection" value="canonical" />
                <param name="minConfidenceForCircosPlot" value="high" />
                <param name="squishIntrons" value="FALSE" />
                <param name="optimizeDomainColors" value="TRUE" />
            </section>
            <output name="output" value="output_withalign2.pdf" compare="sim_size" />
        </test>
    </tests>
    <help><![CDATA[
Draw Fusions (Arriba)
=====================

Arriba comes with an R script draw_fusions.R that renders publication-quality visualizations of the transcripts involved in predicted fusions. It generates a PDF file with one page for each predicted fusion. Each page depicts the fusion partners, their orientation, the retained exons in the fusion transcript, statistics about the number of supporting reads, and - if the column fusion_transcript has a value - an excerpt of the sequence around the breakpoint.

.. image:: $PATH_TO_IMAGES/draw-fusions-example-small.png
   :scale: 80 %

If a gene has multiple transcript variants, the script picks a transcript in the following order of preference:

* transcripts with splice-sites matching the breakpoints
* if alignments are given: the highest expressed transcript as determined by the coverage
* transcripts tagged as appris_principal
* transcripts tagged as appris_candidate
* transcripts tagged as appris_alternative
* transcripts tagged as CCDS

If there are still multiple eligible transcripts, then the one with the longest coding sequence or longest non-coding sequence is taken.

For more information, please visit the homepage: https://arriba.readthedocs.io/

]]></help>
    <expand macro="citations" />
</tool>
