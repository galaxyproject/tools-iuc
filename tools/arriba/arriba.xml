<tool id="arriba" name="Arriba" version="@VERSION@+galaxy@WRAPPER_VERSION@" profile="@PROFILE@" license="MIT" >
    <description>
        a tool for the detection of gene fusions from RNA-Seq data
    </description>
    <macros>
        <import>macros.xml</import>
        <macro name="validator_index_identifiers" >
            <validator type="regex" message="Specify a comma-separated list of index names without special characters">^([0-9A-Z*_]+[ ,]?)+$</validator>
            <sanitizer sanitize="false" />
        </macro>
    </macros>
    <requirements>
        <expand macro="requirements" />
    </requirements>
    <version_command><![CDATA[
    @VERSION_COMMAND@
    ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[
ln -s '$a' assembly.fa &&
arriba
#if $optfiles.c# -c '$optfiles.c' #end if
-x '$x'
-g '$g'
-a assembly.fa
#if $optfiles.b
-b '$optfiles.b'
#else
-f blacklist
#end if
#if $optfiles.k# -k '$optfiles.k' #end if
#if $optfiles.d# -d '$optfiles.d' #end if
#if $optfiles.t# -t '$optfiles.t' #end if
#if $optfiles.p# -p '$optfiles.p' #end if
#if $optargs.D# -D '$optargs.D' #end if
#if $optargs.s# -s '$optargs.s' #end if
#if $optargs.i# -i '$optargs.i' #end if
#if $optargs.v# -v '$optargs.v' #end if
#if $optargs.f# -f '$optargs.f' #end if
#if $optargs.E# -E '$optargs.E' #end if
#if $optargs.S# -S '$optargs.S' #end if
#if $optargs.m# -m '$optargs.m' #end if
#if $optargs.L# -L '$optargs.L' #end if
#if $optargs.H# -H '$optargs.H' #end if
#if $optargs.R# -R '$optargs.R' #end if
#if $optargs.A# -A '$optargs.A' #end if
#if $optargs.M# -M '$optargs.M' #end if
#if $optargs.K# -K '$optargs.K' #end if
#if $optargs.V# -V '$optargs.V' #end if
#if $optargs.F# -F '$optargs.F' #end if
#if $optargs.U# -U '$optargs.U' #end if
#if $optargs.Q# -Q '$optargs.Q' #end if
#if $optargs.e# -e '$optargs.e' #end if
#if $optargs.T# -T '$optargs.T' #end if
#if $optargs.C# -C '$optargs.C' #end if
#if $optargs.l# -l '$optargs.l' #end if
#if $optargs.u# -u #end if
#if $optargs.X# -X #end if
#if $optargs.I# -I #end if
-o '$o'
-O '$O'
    ]]></command>

    <inputs>
        <param argument="-x" type="data" format="sam,bam"
               label="Alignment File" help="File with main alignments as generated by STAR" />
        <param argument="-g" type="data" format="gtf"
               label="Annotation File" help="GTF file with gene annotation" />
        <param argument="-a" type="data" format="fasta"
               label="Assembly File" help="File with genomic assembly sequences." />
        <section name="optfiles" title="Optional Files" expanded="true" >
            <param argument="-c" type="data" format="sam,bam,cram" optional="true"
                   label="Chimeric Alignments"
                   help="File with chimeric alignments as generated by STAR. This parameter is only required, if STAR was run with the parameter '--chimOutType SeparateSAMold'. When STAR was run with the parameter '--chimOutType WithinBAM' this file can be ommited." />
            <param argument="-b" type="data" format="tabular,txt" optional="true"
                   label="Blacklisted Events File"
                   help="File containing blacklisted events (recurrent artifacts and transcripts observed in healthy tissue)." />
            <param argument="-k" type="data" format="tsv" optional="true"
                   label="Recurrent Fusions File"
                   help="File containing known/recurrent fusions. Some cancer entities are often characterized by fusions between the same pair of genes. In order to boost sensitivity, a list of known fusions can be supplied using this parameter. The list must contain two columns with the names of the fused genes, separated by tabs." />
            <param argument="-d" type="data" format="tsv" optional="true"
                   label="Structural Variants File"
                   help="Tab-separated file with coordinates of structural variants found using whole-genome sequencing data. These coordinates serve to increase sensitivity towards weakly expressed fusions and to eliminate fusions with low evidence." />
            <param argument="-t" type="data" format="tsv" optional="true"
                   label="Fusion Tag Annotations File"
                   help="Tab-separated file containing fusions to annotate with tags in the 'tags' column. The first two columns specify the genes; the third column specifies the tag." />
            <param argument="-p" type="data" format="gff3" optional="true"
                   label="Coordinates of Protein Domains"
                   help="File in GFF3 format containing coordinates of the protein domains of genes. The protein domains retained in a fusion are listed in the column 'retained_protein_domains'"/>
        </section>
        <section name="optargs" title="Optional Arguments" expanded="false" >
            <param argument="-D" type="integer" min="1" value="100000" optional="true"
                   label="MAX_GENOMIC_BREAKPOINT_DISTANCE"
                   help="When a file with genomic breakpoints obtained from whole-genome sequencing is supplied via the parameter -d, this parameter determines how far a genomic breakpoint may be away from a transcriptomic breakpoint to still consider it as a related event. For events inside genes, the distance is added to the end of the gene; for intergenic events, the distance threshold is applied as is. Default: 100000" />
            <param argument="-s" type="select" optional="true"
                   label="STRANDEDNESS"
                   help="Whether a strand-specific protocol was used for library preparation, and if so, the type of strandedness. Even when an unstranded library is processed, Arriba can often infer the strand from splice-patterns. But in unclear situations, stranded data helps resolve ambiguities. Default: auto" >
                <option value="auto" selected="true">auto : auto-detect whether the library is stranded and the type of strandedness</option>
                <option value="yes">yes: the library is stranded and the strand of the read designated as first-in-pair matches the transcribed strand</option>
                <option value="no">no: the library is not stranded</option>
                <option value="reverse">reverse: the library is stranded and the strand of the read designated as first-in-pair is the reverse of the transcribed strand</option>
            </param>
            <param argument="-i" type="text" optional="true"
                   value="1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 X Y AC_* NC_*"
                   label="Interesting Contigs"
                   help="Comma-/space-separated list of interesting contigs. Fusions between genes on other contigs are ignored. Contigs can be specified with or without the prefix chr. Asterisks (*) are treated as wild-cards. Default: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 X Y AC_* NC_*" >
                <expand macro="validator_index_identifiers" />
            </param>
            <param argument="-v" type="text" value="AC_* NC_*" optional="true"
                   label="Viral Contigs"
                   help="Comma-/space-separated list of viral contigs for reporting of viral integration sites. Contigs can be specified with or without the prefix chr. Asterisks (*) are treated as wild-cards. Default: AC_* NC_*" >
                <expand macro="validator_index_identifiers" />
            </param>
            <param argument="-f" type="select" display="checkboxes" multiple="true" optional="true"
                   label="Disabled filters"
                   help="Comma-/space-separated list of filters to disable. By default all filters are enabled." >
                <option value="top_expressed_viral_contigs" />
                <option value="viral_contigs" />
                <option value="low_coverage_viral_contigs" />
                <option value="uninteresting_contigs" />
                <option value="no_genomic_support" />
                <option value="short_anchor" />
                <option value="select_best" />
                <option value="many_spliced" />
                <option value="long_gap" />
                <option value="merge_adjacent" />
                <option value="hairpin" />
                <option value="small_insert_size" />
                <option value="same_gene" />
                <option value="genomic_support" />
                <option value="read_through" />
                <option value="no_coverage" />
                <option value="mismatches" />
                <option value="homopolymer" />
                <option value="low_entropy" />
                <option value="multimappers" />
                <option value="inconsistently_clipped" />
                <option value="duplicates" />
                <option value="homologs" />
                <option value="blacklist" />
                <option value="mismappers" />
                <option value="spliced" />
                <option value="relative_support" />
                <option value="min_support" />
                <option value="known_fusions" />
                <option value="end_to_end" />
                <option value="non_coding_neighbors" />
                <option value="isoforms" />
                <option value="intronic" />
                <option value="in_vitro" />
                <option value="intragenic_exonic" />
                <option value="internal_tandem_duplication" />
            </param>
            <param argument="-E" type="float" min="0" value="0.3" optional="true"
                   label="Max E-value"
                   help="Arriba estimates the number of fusions with a given number of supporting reads which one would expect to see by random chance. If the expected number of fusions (e-value) is higher than this threshold the fusion is discarded by the filter relative_support. Note: Increasing this threshold can dramatically increase the number of false positives and may increase the runtime of resource-intensive steps. Fractional values are possible. Default: 0.3" />
            <param argument="-S" type="integer" min="0" value="2" optional="true"
                   label="Minimum Supporting Reads"
                   help="The filter min_support discards all fusions with fewer than this many supporting reads (split reads and discordant mates combined). Default: 2" />
            <param argument="-m" type="float" value="0.8" optional="true"
                   label="Maximum Mismappers"
                   help="When more than this fraction of supporting reads turns out to be mapped incorrectly, the filter mismappers discards the fusion. Default: 0.8" />
            <param argument="-L" type="float" min="0" value="0.3" optional="true"
                   label="Maximum Homolog Identity"
                   help="Genes with more than the given fraction of sequence identity are considered homologs and removed by the filter homologs. Default: 0.3" />
            <param argument="-H" type="integer" min="0" value="6" optional="true"
                   label="Homopolymer Length"
                   help="The filter homopolymer removes breakpoints adjacent to homopolymers of the given length or more. Default: 6" />
            <param argument="-R" type="integer" min="0" value="10000" optional="true"
                   label="Readthrough Distance"
                   help="The filter read_through removes read-through fusions where the breakpoints are less than the given distance away from each other. Default: 10000" />
            <param argument="-A" type="integer" min="0" value="23" optional="true"
                   label="Min Anchor Length"
                   help="Alignment artifacts are often characterized by split reads coming from only one gene and no discordant mates. Moreover, the split reads only align to a short stretch in one of the genes. The filter short_anchor removes these fusions. This parameter sets the threshold in bp for what the filter considers short. Default: 23" />
            <param argument="-M" type="integer" min="0" value="4" optional="true"
                   label="Many Spliced Events"
                   help="The filter many_spliced recovers fusions between genes that have at least this many spliced breakpoints. Default: 4" />
            <param argument="-K" type="float" min="0" value="0.6" optional="true"
                   label="Maximum Kmer Content"
                   help="The filter low_entropy removes reads with repetitive 3-mers. If the 3-mers make up more than the given fraction of the sequence, then the read is discarded. Default: 0.6" />
            <param argument="-V" type="float" min="0" value="0.01" optional="true"
                   label="Maximum Mismatch P-value"
                   help="The filter mismatches uses a binomial model to calculate a p-value for observing a given number of mismatches in a read. If the number of mismatches is too high, the read is discarded. Default: 0.01" />
            <param argument="-F" type="integer" min="0" value="200" optional="true"
                   label="Fragment Length"
                   help="When paired-end data is given, the fragment length is estimated automatically and this parameter has no effect. But when single-end data is given, the mean fragment length should be specified to effectively filter fusions that arise from hairpin structures. Default: 200" />
            <param argument="-U" type="integer" min="0" value="300" optional="true"
                   label="Maximum Reads"
                   help="Subsample fusions with more than the given number of supporting reads. This improves performance without compromising sensitivity, as long as the threshold is high. Counting of supporting reads beyond the threshold is inaccurate, obviously. Default: 300" />
            <param argument="-Q" type="float" min="0" value="0.998" optional="true"
                   label="Quantile"
                   help="Highly expressed genes are prone to produce artifacts during library preparation. Genes with an expression above the given quantile are eligible for filtering by the filter in_vitro. Default: 0.998" />
            <param argument="-e" type="float" min="0" value="0.2" optional="true"
                   label="Exonic Fraction"
                   help="The breakpoints of false-positive predictions of intragenic events are often both in exons. True predictions are more likely to have at least one breakpoint in an intron, because introns are larger. If the fraction of exonic sequence between two breakpoints is smaller than the given fraction, the filter discards the event. Default: 0.2" />
            <param argument="-T" type="integer" min="0" value="5" optional="true"
                   label="Top N"
                   help="If a tumor is truly infected with a virus, a substantial number of reads should map to the respective viral contig. Only report viral integration sites of the top N most highly expressed viral contigs. Default: 5" />
            <param argument="-C" type="float" min="0" value="0.15" optional="true"
                   label="Coverage Fraction"
                   help="Ignore virus-associated events if the virus is not fully expressed, i.e., less than the given fraction of the viral contig is transcribed. Default: 0.15" />
            <param argument="-l" type="integer" min="0" value="100" optional="true"
                   label="Max ITD Length"
                   help="Maximum length of internal tandem duplications (ITDs) in bp. STAR often fails to align ITDs with a length of more than a few bp. However, many known oncogenic ITDs are longer than 20 bp and thus at risk of being overlooked. Arriba can manually search for reads that potentially arise from ITDs by attempting to align clipped reads as an ITD. This parameter defines the search space and also limits the effects of the internal_tandem_duplications filter. Note: Increasing this value can impair performance, because Arriba needs to perform an alignment for candidate reads and the alignment complexity depends on the the maximum search space. Moreover, increasing the value beyond the default can lead to many false positives, because the blacklist was trained with the default value and frequent germline variants with a larger length will not be filtered effectively by the blacklist. Default: 100" />
            <param argument="-u" type="boolean" checked="false"
                   label="Mark duplicates?"
                   help="Arriba performs marking of duplicates internally based on identical mapping coordinates. When this switch is set, internal marking of duplicates is disabled and Arriba assumes that duplicates have been marked by a preceding program. In this case, Arriba only discards alignments flagged with the BAM_FDUP flag. This makes sense when duplicates cannot be reliably identified solely based on their mapping coordinates, e.g. when unique molecular identifiers (UMIs) are used or when independently generated libraries are merged in a single BAM file and the read group must be interrogated to distinguish duplicates from reads that map to the same coordinates by chance. In addition, when this switch is set, duplicate reads are not considered for the calculation of the coverage at fusion breakpoints (columns coverage1 and coverage2 in the output file)." />
            <param argument="-X" type="boolean" checked="false"
                   label="Report Extra Information?"
                   help="To reduce the runtime and file size, by default, the columns fusion_transcript, peptide_sequence, and read_identifiers are left empty in the file containing discarded fusion candidates (see parameter -O). When this flag is set, this extra information is reported in the discarded fusions file." />
            <param argument="-I" type="boolean" checked="false"
                   label="Fill gaps with sequences from assembly?"
                   help="By default, the fusion transcript sequence is assembled from the supporting reads. Like so, non-template bases, reference mismatches, aberrant splicing, and other deviations from the reference are correctly reflected in the sequence. However, when there are only few supporting reads, the assembled transcript can be incomplete. Gaps in the sequence are then denoted as '...' When this switch is enabled, such gaps are filled with the sequence from the assembly wherever possible. Moreover, the sequence is expanded to the start and end of the fusion partners, yielding the complete sequence of the fusion gene. If the sequence exceeds the boundaries of the fused transcripts, it is trimmed to the boundaries. Since the fusion peptide sequence builds upon the fusion transcript sequence, enabling this switch implicitly causes Arriba to compute the full peptide sequence from the start codon of the 5-prime fusion partner to the stop codon of the 3-prime fusion partner. The main disadvantage of enabling this switch is that under rare circumstances the resulting sequence may lack some deviations from the reference, such as reference mismatches or aberrant splicing. It should be noted that not all gaps can be filled and that the fusion transcript sequence may still be incomplete. A complete construction of the 5-prime end is marked by a caret sign at the beginning of the fusion transcript sequence; a complete construction of the 3-prime end is marked by a dollar sign at the end." />
        </section>
    </inputs>
    <outputs>
        <data name="o" format="tsv" label="${tool.name} on ${on_string}: Fusions" />
        <data name="O" format="tsv" label="${tool.name} on ${on_string}: Discarded Fusions" />
    </outputs>
    <tests>
        <test expect_num_outputs="2" >
            <!-- Defaults -->
            <param name="x" value="tres.chrX_3851937_3873176.sorted.bam" />
            <param name="g" value="dm6.refGene.cg2930_ec.gtf" />
            <param name="a" value="dm6.sub.fa.gz" >
                <!-- fa.gz, but galaxy automatically converts to fa -->
            </param>

            <output name="o" value="fusions.tsv" />
            <output name="O" >
                <assert_contents>
                    <has_n_columns n="30" />
                    <has_line_matching expression="^CG2930\s+ec.*chrX:3873163\s+chrX:3852032\s+CDS.*" />
                    <has_line_matching expression="^ec\(6127\),CG2930\(5225\)\s+ec\(6183\),CG2930\(5169\).*chrX:3863748\s+chrX:3863804\s+intergenic.*" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
        <!-- nothing yet -->
    </help>
    <expand macro="citations" />
</tool>
