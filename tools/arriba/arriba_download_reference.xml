<tool id="arriba_download_reference" name="Arriba Reference" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" python_template_version="3.5">
    <description>Download to history</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="version_command" />
    <command detect_errors="exit_code"><![CDATA[
    echo $arriba_reference_name > '$star_index' &&
    BASE_DIR=\$(dirname \$(dirname `which arriba`)) &&
    REF_SCRIPT=`find \$BASE_DIR -name 'download_references.sh'` &&
    #if $is_test != 'yes'
    \$REF_SCRIPT '$arriba_reference_name' &&
    cp *.fa*  '$genome_fasta' &&
    cp *.gtf*  '$genome_gtf' &&
    mv STAR_index_* '$star_index.extra_files_path'
    #else
    [[ -x \$REF_SCRIPT ]]
    #end if
    ]]></command>
    <inputs>
        <param name="is_test" type="hidden" value="no"/>
        <param name="arriba_reference_name" type="select" label="Select reference">
            <option value="GRCh38+ENSEMBL93">GRCh38+ENSEMBL93</option>
            <option value="GRCh38+GENCODE28">GRCh38+GENCODE28</option>
            <option value="GRCh38+RefSeq">GRCh38+RefSeq</option>
            <option value="GRCh38viral+ENSEMBL93">GRCh38viral+ENSEMBL93</option>
            <option value="GRCh38viral+GENCODE28">GRCh38viral+GENCODE28</option>
            <option value="GRCh38viral+RefSeq">GRCh38viral+RefSeq</option>
            <option value="hg38+ENSEMBL93">hg38+ENSEMBL93</option>
            <option value="hg38+GENCODE28">hg38+GENCODE28</option>
            <option value="hg38+RefSeq">hg38+RefSeq</option>
            <option value="hg38viral+ENSEMBL93">hg38viral+ENSEMBL93</option>
            <option value="hg38viral+GENCODE28">hg38viral+GENCODE28</option>
            <option value="hg38viral+RefSeq">hg38viral+RefSeq</option>
            <option value="GRCh37+ENSEMBL87">GRCh37+ENSEMBL87</option>
            <option value="GRCh37+GENCODE19">GRCh37+GENCODE19</option>
            <option value="GRCh37+RefSeq">GRCh37+RefSeq</option>
            <option value="GRCh37viral+ENSEMBL87">GRCh37viral+ENSEMBL87</option>
            <option value="GRCh37viral+GENCODE19">GRCh37viral+GENCODE19</option>
            <option value="GRCh37viral+RefSeq">GRCh37viral+RefSeq</option>
            <option value="hg19+ENSEMBL87">hg19+ENSEMBL87</option>
            <option value="hg19+GENCODE19">hg19+GENCODE19</option>
            <option value="hg19+RefSeq">hg19+RefSeq</option>
            <option value="hg19viral+ENSEMBL87">hg19viral+ENSEMBL87</option>
            <option value="hg19viral+GENCODE19">hg19viral+GENCODE19</option>
            <option value="hg19viral+RefSeq">hg19viral+RefSeq</option>
            <option value="hs37d5+ENSEMBL87">hs37d5+ENSEMBL87</option>
            <option value="hs37d5+GENCODE19">hs37d5+GENCODE19</option>
            <option value="hs37d5+RefSeq">hs37d5+RefSeq</option>
            <option value="hs37d5viral+ENSEMBL87">hs37d5viral+ENSEMBL87</option>
            <option value="hs37d5viral+GENCODE19">hs37d5viral+GENCODE19</option>
            <option value="hs37d5viral+RefSeq">hs37d5viral+RefSeq</option>
            <option value="GRCm38+GENCODEM25">GRCm38+GENCODEM25</option>
            <option value="GRCm38+RefSeq">GRCm38+RefSeq</option>
            <option value="GRCm38viral+GENCODEM25">GRCm38viral+GENCODEM25</option>
            <option value="GRCm38viral+RefSeq">GRCm38viral+RefSeq</option>
            <option value="mm10+GENCODEM25">mm10+GENCODEM25</option>
            <option value="mm10+RefSeq">mm10+RefSeq</option>
            <option value="mm10viral+GENCODEM25">mm10viral+GENCODEM25</option>
            <option value="mm10viral+RefSeq">mm10viral+RefSeq</option>
        </param>
    </inputs>
    <outputs>
        <data name="genome_fasta" format="fasta" label="${tool.name} ${arriba_reference_name} fasta"/>
        <data name="genome_gtf" format="gtf" label="${tool.name} ${arriba_reference_name} GTF"/>
        <data name="star_index" format="txt" label="${tool.name} ${arriba_reference_name} STAR index"/>
    </outputs>
    <tests>
        <!-- Downloading a genome and annotation plus build a STAR index requires too many resources for testing. 
              Just test that we can locate the script. -->
        <test>
            <param name="is_test" value="yes"/>
            <param name="arriba_reference_name" value="GRCh38+ENSEMBL93"/>
            <output name="star_index">
                <assert_contents>
                    <has_text text="GRCh38+ENSEMBL93"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
** Arriba Reference **

Arriba_ is a fast tool to search for aberrant transcripts such as gene fusions.
It is based on chimeric alignments found by the STAR RNA-Seq aligner.

**Arriba Reference** downloads a genome sequence fasta and its related annotation GTF, and then build a STAR index for the RNA STAR aligner.  

These datasets will be added to your Galaxy history:

    - genome assembly fasta 
    - genome annotation GTF 
    - STAR index

See Arriba manual pages:

  - https://arriba.readthedocs.io/en/latest/workflow/
  - https://arriba.readthedocs.io/en/latest/input-files/


**NOTE:** This is a resource intensive process, so the results should be copied to new histories as needed rather than running this in each workflow.

.. _Arriba: https://arriba.readthedocs.io/en/latest/

]]></help>
    <expand macro="citations" />
</tool>
