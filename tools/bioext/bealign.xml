<?xml version="1.0"?>
<tool id="bioext_bealign" name="Align sequences" version="@VERSION@.0">
  <description>to a reference using a codon alignment algorithm</description>
  <macros>
    <import>macros.xml</import>
  </macros>
  <expand macro="requirements"/>
  <version_command>bealign --version</version_command>
  <command detect_errors="exit_code"><![CDATA[
    bealign --reference '$select_reference.reference' $advanced.expected_identity --alphabet $advanced.alphabet
        --score-matrix $advanced.score_matrix $advanced.reverse_complement $advanced.keep_reference
        #if $advanced.discard:
            $advanced.discard $advanced.discarded_reads
        #end if
        $input $output
    ]]></command>
  <inputs>
    <param name="input" type="data" format="fasta" label="Input reads"/>
    <conditional name="select_reference">
      <param name="reference_type" type="select">
        <option value="preset">Select preset</option>
        <option value="dataset">Use a history dataset</option>
      </param>
      <when value="preset">
        <param argument="--reference" type="select">
          <option value="HXB2_tat">HXB2 tat</option>
          <option value="HXB2_gag">HXB2 gag</option>
          <option value="HXB2_pol">HXB2 polymerase</option>
          <option value="HXB2_int">HXB2 integrase</option>
          <option value="HXB2_vif">HXB2 vif</option>
          <option value="HXB2_pr">HXB2 protease</option>
          <option value="HXB2_vpr">HXB2 vpr</option>
          <option value="NL4-3_prrt">NL4-3 protease and reverse transcriptase</option>
          <option value="HXB2_nef">HXB2 nef</option>
          <option value="HXB2_env">HXB2 envelope</option>
          <option value="HXB2_rt">HXB2 reverse transcriptase</option>
          <option value="HXB2_prrt">HXB2 protease and reverse transcriptase</option>
          <option value="HXB2_rev">HXB2 rev</option>
          <option value="HXB2_vpu">HXB2 vpu</option>
        </param>
      </when>
      <when value="dataset">
        <param argument="--reference" type="data" format="fasta" label="Reference sequences"/>
      </when>
    </conditional>
    <section name="advanced" title="Advanced options" expanded="False">
      <param name="expected_identity" argument="--expected-identity" type="boolean" checked="False" truevalue="--expected-identity" falsevalue="" label="Discard sequences that are insufficiently identical to the reference"/>
      <param argument="--alphabet" type="select" label="Alphabet to use for alignment">
        <option value="codon" selected="True">Codon</option>
        <option value="dna">DNA</option>
        <option value="amino">Amino acids</option>
      </param>
      <param name="score_matrix" argument="--score-matrix" type="select" label="Parametrize using score matrix">
        <option value="BLOSUM62" selected="True">Blocks substitution</option>
        <option value="DNA65">DNA, 65% expected identity</option>
        <option value="DNA70">DNA, 70% expected identity</option>
        <option value="DNA88">DNA, 88% expected identity</option>
        <option value="DNA80">DNA, 80% expected identity</option>
        <option value="DNA95">DNA, 95% expected identity</option>
        <option value="PAM200">PAM 200 substitution</option>
        <option value="PAM250">PAM 250 substitution</option>
        <option value="HIV_BETWEEN_F">HIV between+F</option>
      </param>
      <param argument="--discard" type="boolean" checked="False" truevalue="--discard" falsevalue="" label="Output discarded sequences to a separate dataset"/>
      <param name="reverse_complement" argument="--reverse-complement" type="boolean" checked="False" truevalue="--reverse-complement" falsevalue="" label="Also try to align against reverse complement of reference"/>
      <param name="keep_reference" argument="--keep-reference" type="boolean" checked="False" truevalue="--keep-reference" falsevalue="" label="Include reference as first sequence in aligned BAM"/>
    </section>
  </inputs>
  <outputs>
    <data name="output" format="bam"/>
    <data name="discarded_reads" format="fasta">
      <filter>discard</filter>
    </data>
  </outputs>
  <tests>
    <test>
      <param name="input" ftype="fasta" value="bealign-in1.fa"/>
      <param name="reference_type" value="dataset"/>
      <param name="score_matrix" value="HIV_BETWEEN_F"/>
      <param name="reference" ftype="fasta" value="bealign-in-ref-1.fa"/>
      <assert_stderr>
        <has_text text="7 reads"/>
      </assert_stderr>
    </test>
    <test>
      <param name="input" ftype="fasta" value="bealign-in2.fa"/>
      <param name="reference_type" value="dataset"/>
      <param name="score_matrix" value="BLOSUM62"/>
      <param name="reference" ftype="fasta" value="bealign-in-ref-2.fa"/>
      <assert_stderr>
        <has_text text="1 reads"/>
      </assert_stderr>
    </test>
  </tests>
  <help><![CDATA[
  -r REFERENCE, --reference REFERENCE
                        REFERENCE FASTA file or {HXB2_tat, HXB2_nef, HXB2_vpu,
                        HXB2_vif, HXB2_env, HXB2_vpr, HXB2_rev, HXB2_pol,
                        HXB2_prrt, NL4-3_prrt, HXB2_rt, HXB2_gag, HXB2_pr,
                        HXB2_int}
  -e EXPECTED_IDENTITY, --expected-identity EXPECTED_IDENTITY
                        discard sequences that are insufficiently identical to
                        the reference
  -a ALPHABET, --alphabet ALPHABET
                        perform an alignment using one of {amino, dna, codon}
                        [default=codon]
  -m SCOREMATRIX, --score-matrix SCOREMATRIX
                        parameterize using one of {PAM250, DNA80,
                        HIV_BETWEEN_F, BLOSUM62, DNA70, DNA88, PAM200, DNA95,
                        DNA65} [default=BLOSUM62]
  -D DISCARD, --discard DISCARD
                        discarded sequences are sent to DISCARD
  -R, --reverse-complement
                        also align the reverse complement of each query
                        sequence, returning it if the alignment is superior
  -S, --no-sort         do NOT sort the resulting BAM file [the default is to
                        sort]
  -q, --quiet           do not print status update messages
  -v, --version         print version information and exit
  -K, --keep-reference  include the reference sequence as the first one in the
                        resulting BAM file [the default is to strip it]
    ]]></help>
  <expand macro="citations"/>
</tool>
