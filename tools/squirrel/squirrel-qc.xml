<tool id="squirrel" name="squirrel-qc" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <description>phylogenetic analysis of MPXV</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_command"/>

    <command detect_errors="exit_code"><![CDATA[
      #set $input_file_name = str($sequences.element_identifier).replace(".fasta", "")
      #set $linked_input = str($input_file_name) + '.fasta'
      #set $html_output = str($input_file_name) + '.report.html'
      #set $mask_output = str($input_file_name) + '.suggested_mask.csv'
      #set $exclude_output = 'suggested_to_exclude.csv'

      ln -s '${sequences}' '${linked_input}' &&

      squirrel
      --seq-qc
      --clade $clade
      $no_mask
      $no_iter_mask

      --threads \${GALAXY_SLOTS:-Z}

      '$linked_input' &&

      mv '${html_output}' '$html' &&
      mv '${mask_output}' '$mask' &&
      mv '${exclude_output}' '$exclude'
    ]]></command>

    <inputs>
        <param name="sequences"
          type="data"
          format="fasta"
          label="Sequences in fasta format" 
          help="You can upload a FASTA sequence to the history and use it as reference" />
        <param name="clade"
          type="select"
          label="Select MPXV Clade">
          <option value="cladei">Clade I</option>
          <option value="cladeia">Clade Ia</option>
          <option value="cladeib">Clade Ib</option>
          <option value="cladeii">Clade II</option>
          <option value="cladeiia">Clade IIa</option>
          <option value="cladeiib">Clade IIb</option>
        </param>
        <param name="no_mask"
          type="boolean" 
          truevalue="--no-mask"
          falsevalue=""
          label="SKIP masking repeat regions?" 
          help="Set to True to Skip masking of repetitive regions. Default: masks repeat regions." />
        <param name="no_iter_mask"
          type="boolean" 
          truevalue="--no-itr-mask"
          falsevalue=""
          label="SKIP masking of end ITR?" 
          help="Set to True to skip masking of end ITR. Default: masks ITR" />
    </inputs>

    <outputs>
      <!-- standard outputs-->
      <data name="html" format="html" label="${tool.name} - html report" />
      <data name="mask" format="csv" label="${tool.name} - flagged mutations to mask" />
      <data name="exclude" format="csv" label="${tool.name} - flagged sequences to exclude" />
    </outputs>
    
    <tests>
        <test expect_num_outputs="3">
          <param name="sequences" value="sequences.fasta" />
          <param name="clade" value="cladeii" />
          <param name="no_mask" value="false" />
          <param name="no_iter_mask" value="false" />
          <output name="html" file="sequences.report.html" />
          <output name="mask" file="sequences.suggested_mask.csv" />
          <output name="exclude" file="suggested_to_exclude.csv" />
        </test>
        <test expect_num_outputs="3">
          <param name="sequences" value="sequences.fasta" />
          <param name="clade" value="cladeii" />
          <param name="no_mask" value="true" />
          <param name="no_iter_mask" value="true" />
          <output name="html" file="sequences.report.html" />
          <output name="mask" file="sequences.suggested_mask.csv" />
          <output name="exclude" file="suggested_to_exclude.csv" />
        </test>
    </tests>
    <help><![CDATA[
Input-Output options:
  input                 Input fasta file of sequences to analyse.
  -o OUTDIR, --outdir OUTDIR
                        Output directory. Default: current working directory
  --outfile OUTFILE     Optional output file name. Default: <input>.aln.fasta
  --tempdir TEMPDIR     Specify where you want the temp stuff to go. Default: $TMPDIR
  --no-temp             Output all intermediate files, for dev purposes.

Alignment options:
  -qc, --seq-qc         Flag potentially problematic SNPs and sequences. Default: don't run
                        QC
  --assembly-refs ASSEMBLY_REFS
                        References to check for `calls to reference` against.
  --no-mask             Skip masking of repetitive regions. Default: masks repeat regions
  --no-itr-mask         Skip masking of end ITR. Default: masks ITR
  --additional-mask ADDITIONAL_MASK
                        Masking additional sites provided as a csv. Needs columns `Maximum`
                        and `Minimum` in 1-base.
  --sequence-mask SEQUENCE_MASK
                        Mask sites in specific sequences in the alignment as a csv, rather
                        than the whole alignment column. Needs `sequence` and `site`
                        (1-based) column.
  -ex EXCLUDE, --exclude EXCLUDE
                        Supply a csv file listing sequences that should be excluded from the
                        analysis.
  --extract-cds         Extract coding sequences based on coordinates in the reference
  --concatenate         Concatenate coding sequences for each genome, separated by `NNN`.
                        Default: write out as separate records
  --clade CLADE         Specify whether the alignment is primarily for `cladei` or `cladeii`
                        (can also specify a or b, e.g. `cladeia`, `cladeiib`). This will
                        determine reference used for alignment, mask file and background set
                        used if `--include-background` flag used in conjunction with the
                        `--run-phylo` option. Default: `cladeii`

    ]]></help>
    <citations>
        <citation type="bibtex">
@misc{githubsquirrel,
  author = {O'Toole, √Åine},
  year = {2025},
  title = {Squirrel: Some QUIck Reconstruction to Resolve Evolutionary Links},
  publisher = {GitHub},
  journal = {GitHub},
  url = {https://github.com/aineniamh/squirrel},
}</citation>
    </citations>
</tool>