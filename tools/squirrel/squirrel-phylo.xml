<tool id="squirrel" name="squirrel phylo" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <description>phylogenetic analysis of MPXV</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    
    <command detect_errors="exit_code"><![CDATA[
      #set $input_file_name = str($sequences.element_identifier).replace(".fasta", "")
      #set $linked_input = str($input_file_name) + '.fasta'
      #set $alignment_output = str($input_file_name) + '.aln.fasta'
      #set $tree_output = str($input_file_name) + '.tree'

      #if $apobec3
        #set $aa_recon_output = str($input_file_name) + ".tree.amino_acid.reconstruction.csv"
        #set $branch_snps_output = str($input_file_name) + ".tree.branch_snps.reconstruction.csv"
        #set $svg_output = str($input_file_name) + ".tree.svg"
        #set $png_output = str($input_file_name) + ".tree.png"
      #end if

      ln -s '${sequences}' '${linked_input}' &&

      squirrel
      #if $apobec3
        --run-apobec3-phylo
        --fig-height $fig_height
        --fig-width $fig_width
      #else
        --run-phylo
      #end if

      --clade $clade

      #if $mask_file
        --additional-mask $mask_file
      #end if

      #if $bg_file
        --background-file '$bg_file'
      #else
        --include-background
      #end if

      --threads \${GALAXY_SLOTS:-1}
      '$linked_input' &&

      mv '${alignment_output}' '$alignment' &&
      mv '${tree_output}' '$tree'

      #if $apobec3
        && mv '${aa_recon_output}' '$aa_recon' &&
        mv '${branch_snps_output}' '$branch_snps' &&
        mv '${svg_output}' '$svg' &&
        mv '${png_output}' '$png'
      #end if
    ]]></command>

    <inputs>
        <param name="sequences"
          type="data"
          format="fasta"
          label="Sequences in fasta format" 
          help="You can upload a FASTA sequence to the history and use it as reference" />
        <param name="apobec3"
          type="boolean"
          checked="false"
          label="Run additional APOBEC3-mutation reconstruction pipeline" />
        <param name="clade"
          type="select"
          label="Select MPXV Clade">
          <option value="cladei">Clade I</option>
          <option value="cladeia">Clade Ia</option>
          <option value="cladeib">Clade Ib</option>
          <option value="cladeii">Clade II</option>
          <option value="cladeiia">Clade IIa</option>
          <option value="cladeiib">Clade IIb</option>
        </param>
        <param name="mask_file"
          type="data" 
          format="csv"
          optional="true"
          label="Mask additional sites" 
          help="Run squirrel in alignment with qc to generate the snp mask file." />
        <param name="bg_file" 
          type="data"
          format="fasta"
          optional="true"
          label="Background file - leave empty for automatic background sequences."
          help="Include a default background set of sequences for the phylogenetics pipeline. The set will be determined by previous 'clade' setting"/>
        <param name="fig_height"
          label="Overwrite tree figure default height"
          type="integer"
          min="0"
          value="25"
          optional="true">
        </param>
        <param name="fig_width"
          label="Overwrite tree figure default width"
          type="integer"
          min="0"
          value="40"
          optional="true">
        </param>
    </inputs>

    <outputs>
      <!-- standard outputs-->
      <data name="tree" format="newick" label="${tool.name} - phylogenetic tree" />
      <data name="alignment" format="fasta" label="${tool.name} - aligned sequences" />
      <!-- apobec3 outputs-->
      <data name="svg" format="svg" label="${tool.name} - phylotree svg image">
          <filter>apobec3</filter>
      </data>
      <data name="png" format="png" label="${tool.name} - phylotree png image"> <filter>apobec3</filter> </data>
      <data name="aa_recon" format="png" label="${tool.name} - amino acid mutations ancestral reconstruction"> <filter>apobec3</filter> </data>
      <data name="branch_snps" format="png" label="${tool.name} - apobec3 nt mutations"> <filter>apobec3</filter> </data>

    </outputs>
    
    <tests>
        <test expect_num_outputs="2">
          <param name="sequences" value="sequences.fasta" />
          <param name="apobec3" value="false" />
          <output name="alignment" file="sequences.aln.fasta" />
          <output name="tree" file="sequences.tree" />
        </test>
        <test expect_num_outputs="6">
          <param name="sequences" value="sequences.fasta" />
          <param name="apobec3" value="true" />
          <output name="alignment" file="sequences.aln.fasta" />
          <output name="tree" file="sequences.aln.newick" />
          <output name="svg" file="sequences.tree.svg" />
          <output name="png" file="sequences.tree.svg" />
          <output name="aa_recon" file="sequences.tree.amino_acid.reconstruction.csv" />
          <output name="branch_snps" file="sequences.tree.branch_snps.reconstruction.csv" />
        </test>
    </tests>
    <help><![CDATA[
Input-Output options:
  input                 Input fasta file of sequences to analyse.
  -o OUTDIR, --outdir OUTDIR
                        Output directory. Default: current working directory
  --outfile OUTFILE     Optional output file name. Default: <input>.aln.fasta
  --tempdir TEMPDIR     Specify where you want the temp stuff to go. Default: $TMPDIR
  --no-temp             Output all intermediate files, for dev purposes.

Alignment options:
  -qc, --seq-qc         Flag potentially problematic SNPs and sequences. Default: don't run
                        QC
  --assembly-refs ASSEMBLY_REFS
                        References to check for `calls to reference` against.
  --no-mask             Skip masking of repetitive regions. Default: masks repeat regions
  --no-itr-mask         Skip masking of end ITR. Default: masks ITR
  --additional-mask ADDITIONAL_MASK
                        Masking additional sites provided as a csv. Needs columns `Maximum`
                        and `Minimum` in 1-base.
  --sequence-mask SEQUENCE_MASK
                        Mask sites in specific sequences in the alignment as a csv, rather
                        than the whole alignment column. Needs `sequence` and `site`
                        (1-based) column.
  -ex EXCLUDE, --exclude EXCLUDE
                        Supply a csv file listing sequences that should be excluded from the
                        analysis.
  --extract-cds         Extract coding sequences based on coordinates in the reference
  --concatenate         Concatenate coding sequences for each genome, separated by `NNN`.
                        Default: write out as separate records
  --clade CLADE         Specify whether the alignment is primarily for `cladei` or `cladeii`
                        (can also specify a or b, e.g. `cladeia`, `cladeiib`). This will
                        determine reference used for alignment, mask file and background set
                        used if `--include-background` flag used in conjunction with the
                        `--run-phylo` option. Default: `cladeii`

Phylo options:
  -p, --run-phylo       Run phylogenetics pipeline
  -a, --run-apobec3-phylo
                        Run phylogenetics & APOBEC3-mutation reconstruction pipeline
  --outgroups OUTGROUPS
                        Specify which MPXV outgroup(s) in the alignment to use in the
                        phylogeny. These will get pruned out from the final tree.
  -bg, --include-background
                        Include a default background set of sequences for the phylogenetics
                        pipeline. The set will be determined by the `--clade` specified.
  -bf BACKGROUND_FILE, --background-file BACKGROUND_FILE
                        Include this additional FASTA file as background to the
                        phylogenetics.
  -bm, --binary-partition-mask
                        Calculate and write binary partition mask
  --bm-separate-dimers  Write partition mask with 0 for non-apo, 1 for GA and 2 for TC
                        target sites

Tree figure options:
  -tfig, --tree-figure-only
                        Re-render tree figure custom height and width arguments. Requires:
                        tree file, branch reconstruction file, height, width.
  -tf TREE_FILE, --tree-file TREE_FILE
                        Tree for re-rendering the figure.
  -brf BRANCH_RECONSTRUCTION_FILE, --branch-reconstruction-file BRANCH_RECONSTRUCTION_FILE
                        Reconstruction file for re-rendering the figure.
  --fig-height FIG_HEIGHT
                        Overwrite tree figure default height.
  --fig-width FIG_WIDTH
                        Overwrite tree figure default width.
  --point-style POINT_STYLE
                        Shape of points for apobec3 reconstruction figure. Options: circle,
                        square. Default: circle
  --point-justify POINT_JUSTIFY
                        Justification of points for apobec3 reconstruction figure. Options:
                        left, right. Default: left

Misc options:
  -v, --version         show program's version number and exit
  --verbose             Print lots of stuff to screen
  -t THREADS, --threads THREADS
                        Number of threads
    ]]></help>

<expand macro="citations" />
</tool>