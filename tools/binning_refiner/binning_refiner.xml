<tool id="bin_refiner" name="Binning refiner" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>refines metagenome bins</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
#import re

## Binning refiner prepends the -p param value
## (which we set to be the string 'refined' in
## the command line) to a hard-coded string (i.e.,
## '_Binning_refiner_outputs') to set the base
## output directory.

#for $i, $bin in enumerate($binned_fasta_files):
    #set dir_name = 'bin' + str($i)
    mkdir -p input_bin_dir/$dir_name &&
    #for $f in $bin.input_collection:
        #set identifier = re.sub('[^\s\w\-]', '_', str($f.element_identifier))
        #set file_name = $identifier + '.' + $f.ext
        ## Binning_refiner doesn't handle gzipped files.
        #if $f.ext.endswith(".gz")
            gunzip -c '${f}' > 'input_bin_dir/${dir_name}/${file_name}' &&
        #else:
            ln -s '${f}' 'input_bin_dir/${dir_name}/${file_name}' &&
        #end if
    #end for
#end for

Binning_refiner
-i input_bin_dir
-p 'refined'
&& mv 'refined_Binning_refiner_outputs/refined_contigs.txt' '$output_refined_contigs'
&& mv 'refined_Binning_refiner_outputs/refined_sources_and_length.txt' '$output_sources_and_length'
    ]]></command>
    <inputs>
        <repeat name="binned_fasta_files" title="Binned fasta files" min="1">
            <param name="input_collection" format="fasta,fasta.gz" type="data_collection" collection_type="list" label="Collection of binned fasta files"/>
        </repeat>
        <param argument="-m" type="integer" value="512" label="Minimum size (Kbp) of refined bin" help="Bins smaller than this will be eliminated"/>
    </inputs>
    <outputs>
        <collection name="output_refined_bins" type="list" label="${tool.name} on ${on_string}: (refined bins)">
            <discover_datasets pattern="(?P&lt;designation&gt;.*)\.fasta" format="fasta" directory="refined_Binning_refiner_outputs/refined_refined_bins"/>
        </collection>
        <data name="output_refined_contigs" format="tabular" label="${tool.name} on ${on_string} (refined contigs)"/>
        <data name="output_sources_and_length" format="tabular" label="${tool.name} on ${on_string} (sources and length)"/>
    </outputs>
    <tests>
        <test expect_num_outputs="3">
            <repeat name="binned_fasta_files">
                <param name="input_collection">
                    <collection type="list">
                        <element name="MetaBAT.17.fa.gz" value="MetaBAT.17.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.18.fa.gz" value="MetaBAT.18.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.19.fa.gz" value="MetaBAT.19.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.20.fa.gz" value="MetaBAT.20.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.21.fa.gz" value="MetaBAT.21.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.22.fa.gz" value="MetaBAT.22.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.23.fa.gz" value="MetaBAT.23.fa.gz" ftype="fasta.gz"/>
                    </collection>
                </param>
            </repeat>
            <output_collection name="output_refined_bins" type="list" count="7">
                <element name="refined_1" ftype="fasta">
                    <assert_contents>
                        <has_size value="941488"/>
                        <has_text text=">scaffold_1301"/>
                        <has_n_lines n="15461"/>
                    </assert_contents>
                </element>
                <element name="refined_2" ftype="fasta">
                    <assert_contents>
                        <has_size value="883642"/>
                        <has_text text=">scaffold_262"/>
                        <has_n_lines n="14495"/>
                    </assert_contents>
                </element>
                <element name="refined_3" ftype="fasta">
                    <assert_contents>
                        <has_size value="765454"/>
                        <has_text text=">scaffold_1435"/>
                        <has_n_lines n="12588"/>
                    </assert_contents>
                </element>
                <element name="refined_4" ftype="fasta">
                    <assert_contents>
                        <has_size value="758509"/>
                        <has_text text=">scaffold_923"/>
                        <has_n_lines n="12484"/>
                    </assert_contents>
                </element>
                <element name="refined_5" ftype="fasta">
                    <assert_contents>
                        <has_size value="722197"/>
                        <has_text text=">scaffold_232"/>
                        <has_n_lines n="11849"/>
                    </assert_contents>
                </element>
                <element name="refined_6" ftype="fasta">
                    <assert_contents>
                        <has_size value="637342"/>
                        <has_text text=">scaffold_259"/>
                        <has_n_lines n="10460"/>
                    </assert_contents>
                </element>
                <element name="refined_7" ftype="fasta">
                    <assert_contents>
                        <has_size value="560996"/>
                        <has_text text=">scaffold_1510"/>
                        <has_n_lines n="9219"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output name="output_refined_contigs" file="output_refined_contigs1.tabular" ftype="tabular"/>
            <output name="output_sources_and_length" file="output_sources_and_length1.tabular" ftype="tabular"/>
        </test>
        <test expect_num_outputs="3">
            <repeat name="binned_fasta_files">
                <param name="input_collection">
                    <collection type="list">
                        <element name="MetaBAT.17" value="MetaBAT.17.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.18" value="MetaBAT.18.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.19" value="MetaBAT.19.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.20" value="MetaBAT.20.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.21" value="MetaBAT.21.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.22" value="MetaBAT.22.fa.gz" ftype="fasta.gz"/>
                        <element name="MetaBAT.23" value="MetaBAT.23.fa.gz" ftype="fasta.gz"/>
                    </collection>
                </param>
            </repeat>
            <repeat name="binned_fasta_files">
                <param name="input_collection">
                    <collection type="list">
                        <element name="Concoct_1" value="Concoct_1.fa.gz" ftype="fasta.gz"/>
                        <element name="Concoct_3" value="Concoct_3.fa.gz" ftype="fasta.gz"/>
                        <element name="Concoct_8" value="Concoct_8.fa.gz" ftype="fasta.gz"/>
                    </collection>
                </param>
            </repeat>
            <output_collection name="output_refined_bins" type="list" count="1">
                <element name="refined_1" ftype="fasta">
                    <assert_contents>
                        <has_size value="765454"/>
                        <has_text text=">scaffold_293"/>
                        <has_n_lines n="12588"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output name="output_refined_contigs" file="output_refined_contigs2.tabular" ftype="tabular"/>
            <output name="output_sources_and_length" file="output_sources_and_length2.tabular" ftype="tabular"/>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

Reconciles the outputs of different binning programs with the aim to improve the quality of genome bins,
especially with respect to contamination levels.

The tool accepts collections of fasta datasets (i.e., bins) that were produced by metagenome binning tools
(CONCOCT MaxBin2, MetaBAT2 and others).

All refined bins larger than the specified "minimum size (Kbp) of refined bin" will be output as a dataset
collection of fasta files.  Additional outputs include a tabular dataset containing the id of the contigs
in each refined bin (refined contigs) and another tabular dataset containing the size of each refined bin
and the origin of its contigs (sources and length).

**More information**

https://github.com/songweizhi/Binning_refiner

    ]]></help>
    <expand macro="citations"/>
</tool>
