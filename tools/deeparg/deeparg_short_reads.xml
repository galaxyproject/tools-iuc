<tool id="deeparg_short_reads" name="DeepARG short reads" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>pipeline to detect Antibiotic Resistance Genes (ARGs) from raw reads</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
    mkdir -p deeparg_short_reads_output &&
    deeparg download_data -o 'deeparg_data' &&
    deeparg short_reads_pipeline
        --forward_pe_file '$forward_pe_file'
        --reverse_pe_file '$reverse_pe_file'
        --output_file 'deeparg_short_reads_output/SR'
        -d 'deeparg_data'
        --deeparg_identity $deeparg_identity
        --deeparg_probability $deeparg_probability
        --deeparg_evalue $deeparg_evalue
        --gene_coverage $gene_coverage
        --bowtie_16s_identity $bowtie_16s_identity 
]]></command>
    <inputs>
        <param argument="--forward_pe_file" type="data" format="fasta,fasta.gz,fastqsanger,fastqsanger.gz" label="Forward mate from paired end library"/>
        <param argument="--reverse_pe_file" type="data" format="fasta,fasta.gz,fastqsanger,fastqsanger.gz" label="Reverse mate from paired end library"/>
        <param argument="--deeparg_identity" type="integer" min="0" value="80" label="Minimum identity for ARG alignments [default 80]" />
        <param argument="--deeparg_probability" type="float" min="0" max="1" value="0.8" label="Minimum probability for considering a reads as ARG-like [default 0.8]" />
        <param argument="--deeparg_evalue" type="float" min="0" value="1e-10" label="Minimum e-value for ARG alignments [default 1e-10]" />
        <param argument="--gene_coverage" type="integer" min="0" max="100" value="1" label="Minimum coverage required for considering a full gene in percentage. This parameter looks at the full gene and all hits that align to the gene. If the overlap of all hits is below the threshold the gene is discarded. Use with caution [default 1]" />
        <param argument="--bowtie_16s_identity" type="float" min="0" max="1" value="0.8" label="minimum identity a read as a 16s rRNA gene [default 0.8]" />
        <section name="output_files" title="Selection of the output files">
          <param name="output_selection" type="select" display="checkboxes" multiple="true"  label="Output files selection">
              <option value="file_ARG_tsv" selected="true">ARG detected with prob higher or equal to --prob in TSV</option>
              <option value="file_merged_ARG_tsv" selected="false">ARG sorted and merged in TSV file</option>
              <option value="file_ARG_subtype_tsv" selected="true">ARGs merged by subtype in TSV file</option>
              <option value="file_ARG_type_tsv" selected="true">ARGs merged by type in TSV file</option>
              <option value="file_potential_ARG_tsv" selected="false">ARG detected with prob below --prob in TSV</option>
              <option value="file_all_hits_tsv" selected="false">All hits detected in TSV</option>
          </param>
        </section> 
    </inputs>
    <outputs>
        <data name="output_mapping_ARG" format="tabular" from_work_dir="deeparg_short_reads_output/SR.clean.deeparg.mapping.ARG" label="${tool.name} on ${on_string} : ARG detected (prob higher or equal to --prob)" >
            <filter>output_files['output_selection'] and "file_ARG_tsv" in output_files['output_selection']</filter>
        </data>
        <data name="output_merged_ARG" format="tabular" from_work_dir="deeparg_short_reads_output/SR.clean.deeparg.mapping.ARG.merged" label="${tool.name} on ${on_string} : ARG merged and sorted" >
            <filter>output_files['output_selection'] and "file_merged_ARG_tsv" in output_files['output_selection']</filter>
        </data>
        <data name="output_subtype_ARG" format="tabular" from_work_dir="deeparg_short_reads_output/SR.clean.deeparg.mapping.ARG.merged.quant.subtype" label="${tool.name} on ${on_string} : ARG merged by subtype" >
            <filter>output_files['output_selection'] and "file_ARG_subtype_tsv" in output_files['output_selection']</filter>
        </data>
        <data name="output_type_ARG" format="tabular" from_work_dir="deeparg_short_reads_output/SR.clean.deeparg.mapping.ARG.merged.quant.type" label="${tool.name} on ${on_string} : ARG merged by type" >
            <filter>output_files['output_selection'] and "file_ARG_type_tsv" in output_files['output_selection']</filter>
        </data>
        <data name="output_mapping_potential_ARG" format="tabular" from_work_dir="deeparg_short_reads_output/SR.clean.deeparg.mapping.potential.ARG" label="${tool.name} on ${on_string} : Potential ARG (prob below --prob)" >
            <filter>output_files['output_selection'] and "file_potential_ARG_tsv" in output_files['output_selection']</filter>
        </data>
        <data name="output_all_hits" format="tabular" from_work_dir="deeparg_short_reads_output/SR.clean.deeparg.align.daa.tsv" label="${tool.name} on ${on_string} : all hits detected">
            <filter>output_files['output_selection'] and "file_all_hits_tsv" in output_files['output_selection']</filter>
        </data>
    </outputs>
    <tests>
        <!-- Test 1 -->
        <test expect_num_outputs="6">
            <param name="forward_pe_file" value="F.fq.gz" ftype="fastqsanger.gz"/>
            <param name="reverse_pe_file" value="R.fq.gz" ftype="fastqsanger.gz"/>
            <section name="output_files">
                <param name="output_selection" value="file_ARG_tsv,file_merged_ARG_tsv,file_ARG_subtype_tsv,file_ARG_type_tsv,file_potential_ARG_tsv,file_all_hits_tsv"/>
            </section>
            <output name="output_mapping_ARG" ftype="tabular">
                <assert_contents>
                    <has_text text="gi:446053005:ref:WP_000130860.1:|FEATURES|mdtD|multidrug|mdtD" />
                    <has_text text="CATA" />
                </assert_contents>
            </output>
            <output name="output_merged_ARG" ftype="tabular">
                <assert_contents>
                    <has_text text="ACRB	147	179	1	multidrug" />
                    <has_text text="VANR	137	169	1	glycopeptide" />
                </assert_contents>
            </output>
            <output name="output_subtype_ARG" ftype="tabular">
                <assert_contents>
                    <has_text text="MAJOR_FACILITATOR_SUPERFAMILY_TRANSPORTER	1	0.092030848329" />
                    <has_text text="ACRD	1	0.0345226615236" />
                </assert_contents>
            </output>
            <output name="output_type_ARG" ftype="tabular">
                <assert_contents>
                    <has_text text="aminoglycoside	5	0.795555555556" />
                    <has_text text="glycopeptide	2	0.312663755459" />
                </assert_contents>
            </output>
            <output name="output_mapping_potential_ARG" ftype="tabular">
                <assert_contents>
                    <has_text text="gi:447120629:ref:WP_001197885.1:|FEATURES|mdtB|multidrug|mdtB" />
                    <has_text text="PORIN_OMPC" />
                </assert_contents>
            </output>
            <output name="output_all_hits" ftype="tabular">
                <assert_contents>
                    <has_text text="gi:920668789:ref:WP_053044741.1:|FEATURES|aph(6)-I|aminoglycoside|aph(6)-I" />
                    <has_text text="YP_401803|FEATURES|kasugamycin_resistance_protein_ksgA|aminoglycoside|kasugamycin_resistance_protein_ksgA" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
Predict Antibiotic Resistance Genes (ARGs) from metagenomes
    </help>
    <expand macro="citations"/>
</tool>
