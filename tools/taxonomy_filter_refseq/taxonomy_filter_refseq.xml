<tool id="taxonomy_filter_refseq" name="Filter RefSeq by taxonomy" version="@TOOL_VERSION@+galaxy0">
    <description>Filters RefSeq FASTA files, only retaining sequences that are descendants of a given taxonomic node.</description>
    <macros>
        <token name="@TOOL_VERSION@">0.1.4</token>
    </macros>
    <edam_topics>
        <edam_topic>topic_0091</edam_topic>
    </edam_topics>
    <edam_operations>
        <edam_operation>operation_3460</edam_operation>
    </edam_operations>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">rust-ncbitaxonomy</requirement>
    </requirements>
    <command detect_errors="aggressive"><![CDATA[
        #if str($refseq.refseq_source) == 'builtin':
            #set $refseq_input = str( $refseq.builtin_refseq.fields.path )
        #else:
            ln -s '$refseq.history_refseq' refseq.fasta &&
            #set $refseq_input = "refseq.fasta"
        #end if
        #if str($taxonomy.taxonomy_source) == 'builtin':
            #set $taxonomy_dir = '$taxonomy.taxonomy_table.fields.path'
        #else:
            mkdir taxonomy && ln -s '$taxonomy.nodes' taxonomy/nodes.dmp && ln -s '$taxonomy.names' taxonomy/names.dmp &&
            #set $taxonomy_dir = 'taxonomy'
        #end if
	    taxonomy_filter_refseq '$refseq_input' '$taxonomy_dir' '$ancestor_name' >'$output1'
    ]]></command>
    <inputs>
        <!-- TODO: select 2 input files for taxonomy source -->
        <conditional name="taxonomy">
            <param name="taxonomy_source" type="select" label="Choose source of NCBI Taxonomy">
                <option value="builtin" selected="true">Built-in</option>
                <option value="history">Datasets from history</option>
            </param>
            <when value="builtin">
                <param type="select" name="taxonomy_table" label="NCBI Taxonomy database">
                    <options from_data_table="ncbi_taxonomy">
                        <filter type="sort_by" column="name" /> 
                        <validator type="no_options" message="No NCBI Taxonomy downloads are available" />
                    </options>
                    <validator type="no_options" message="No NCBI Taxonomy database download is available" />
                </param>
            </when>
            <when value="history">
                <param name="nodes" type="data" format="txt" label="NCBI Taxonomy nodes.dmp file" />
                <param name="names" type="data" format="txt" label="NCBI Taxonomy names.dmp file" />
            </when>
        </conditional>
        <conditional name="refseq">
            <param name="refseq_source" type="select" label="Choose source of RefSeq sequences">
                <option value="builtin" selected="true">Built-in</option>
                <option value="history">History</option>
            </param>
            <when value="builtin">
                <param type="select" name="builtin_refseq" label="Select RefSeq FASTA file">
                    <options from_data_table="all_fasta">
                        <filter type="sort_by" column="name" /> 
                        <validator type="no_options" message="No FASTA data is available" />
                    </options>
                    <validator type="no_options" message="No FASTA data is available" />
                </param>
            </when>
            <when value="history">
                <param type="data" name="history_refseq" format="fasta" label="RefSeq FASTA file" />
            </when>
        </conditional>
        <!-- the next parameter is sized to be able to take the longest scientific name in 
             the NCBI taxonomy database as of January 2019 -->
        <param name="ancestor_name" type="text" size="110" label="Ancestor taxon (scientific) name" />
    </inputs>
    <outputs>
        <data name="output1" format="fasta" label="${tool.name} on ${on_string}" />
    </outputs>
    <tests>
        <test>
            <param name="taxonomy_source" value="history" />
            <param name="refseq_source" value="history" />
            <param name="nodes" ftype="txt" value="sample_tree_nodes.dmp" />
            <param name="names" ftype="txt" value="sample_tree_names.dmp" />
            <param name="history_refseq" ftype="fasta" value="sample_refseq.fasta" />
            <param name="ancestor_name" value="unclassified bacterial viruses" />
            <output name="output1" value="output1.fasta" />
        </test>
    </tests>
    <help><![CDATA[
        This tool allows NCBI RefSeq sequences to be filtered so that only those whose species name are 
        descendants of a given taxon in the NCBI taxonomy are retained. For example, from the NCBI RefSeq
        "other vertebrate" file only ray finned fishes can be retained by filtering for "Actinopterygii".

        The NCBI RefSeq FASTA files can either be provided by the Galaxy administrator or from the user
        history. The NCBI taxonomy should be provided by the Galaxy administrator but if that is not
        possible the nodes.dmp and names.dmp files from the NCBI taxonomy can be provided in the history.
    ]]></help>
</tool>
