<tool id='amplican' name='AmpliCan' version='@TOOL_VERSION@+galaxy@SUFFIX_VERSION@' profile='20.01'>
    <description>analysis tool for genome editing </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro='edam_ontology' />
    <expand macro='requirements' />
    <command detect_errors='exit_code'><![CDATA[
        mkdir ./fastq_folder ./output_folder
        #for '${i}' in $fastq_files
            && ln -s $i ./fastq_folder/'${i.element_identifier}'
        #end for
        && Rscript '${__tool_directory__}/amplican.R'
            -c '${config_file}'
            -i ./fastq_folder
            -o ./output_folder
            -M $match_scoring
            -s $mismatch_scoring
            -b $base_only
            -t $scoring_type
            -f $write_alignment_format
            -k $knit_reports
            -a $average_quality
            -m $min_quality
            -u FALSE ## Needs to be modified
            -O $gap_opening
            -e $gap_extension
            -T $fastq_use
            -P $primer_mismatch
            -A $donor_mismatch
            -B $primer_dimer
            -F $event_filter
            -d $cut_buffer
            -C $promiscuous_consensus
            && ls -l ./output_folder
            && ls -l ./output_folder/reports
            && ls -l ./output_folder/alignments
            && mv ./output_folder/reports/amplicon_report.html '${output_html.extra_files_path}'
            && mv ./output_folder/reports/barcode_report.html '${output_html.extra_files_path}'
            && mv ./output_folder/reports/group_report.html '${output_html.extra_files_path}'
            && mv ./output_folder/reports/guide_report.html '${output_html.extra_files_path}'
            && mv ./output_folder/reports/id_report.html '${output_html.extra_files_path}'
    ]]>    </command>
    <inputs>
        <param name="config_file" type="data" format="txt" label="Configuration file"/>
        <param name="fastq_files" type="data" format="fastq, fastq.gz, fastqsanger, fastqsanger.gz"
            multiple="True" label="FASTQ files"/>
        <param argument="knit_reports" type="boolean" 
            truevalue="TRUE" falsevalue="FALSE" checked="True" 
            label="Generate knit plots" help="If enabled, it plot all reports. When disabled, the reports will be prepared, but not plotted" />
        <param argument="write_alignment_format" type="select" display="checkboxes" multiple="true" label="Alignment format outputs" help="Whether it should write alignments results to separate files">
            <option value="None">None: don't write any alignments to files</option>
            <option value="txt" selected="True">TXT: read information followed by forward read and amplicon sequence followed by reverse read with its amplicon sequence</option>
            <option value="fasta">FASTA: outputs alignments in fasta format where header indicates experiment ID, read id and number of reads</option>
        </param>
        <param argument="average_quality" type="integer" min="0" max="93" 
            value="0" label="Average quality" 
            help="If the average quality of the reads fall below value of average_quality then sequence is filtered. Default is 0" />
        <param argument="min_quality" type="integer" min="0" max="93" 
            value="20" label="Minimum quality" 
            help="If one of nucleotides has quality below min_quality, then the sequence is filtered. Default is 20" />
        <param argument="gap_opening" type="integer" min="0" max="40" value="25" label="Gap opening" help="The opening gap score" />
        <param argument="gap_extension" type="integer" min="0" max="40" value="0" label="Gap extension" help="The gap extension score" />
        <param argument="fastq_use" type="select" label="FASTQ files to use" help="Normally you want to use both FASTQ files. But in some special cases, you may want to use only the forward file, or only the reverse file">
            <option value="0">Use both FASTQ files</option>
            <option value="0.5">Use both FASTQ files, but only for one of the reads (forward or reverse) is required to have primer perfectly matched to sequence</option>
            <option value="1">Use only the forward FASTQ file</option>
            <option value="2">Use only the reverse FASTQ file</option>
        </param>
        <param argument="primer_mismatch" type="integer" min="0" max="40" value="0" label="Primer mismatch" help="Decide how many mismatches are allowed during primer matching of the reads, that groups reads by experiments. When primer_mismatch = 0 no mismatches are allowed, which can increase number of unasssigned read" />
        <param argument="donor_mismatch" type="integer" min="0" max="40" value="3" label="Donor mismatch" help="How many events of length 1 (mismatches, deletions and insertions of length 1) are allowed when aligning toward the donor template. This parameter is only used when donor template is specified. The higher the parameter the less strict will be algorithm accepting read as HDR. Set to 0 if only perfect alignments to the donor template marked as HDR, unadvised due to error rate of the sequencers" />
        <param argument="primer_dimer" type="integer" min="0" max="50" value="30" label="Primer dimer" help="Value specifying buffer for PRIMER DIMER detection. For a given read it will be recognized as PRIMER DIMER when alignment will introduce gap of size bigger than: length of amplicon - (lengths of PRIMERS + PRIMER_DIMER value)" />
        <param argument="event_filter" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="True" label="Event filter" help="Whether detection of offtarget reads, should be enabled" />
        <param argument="cut_buffer" type="integer" min="0" max="30" value="5" label="Cut buffer" help="he number of bases by which extend expected cut sites (specified as UPPER case letters in the amplicon) in 5' and 3' directions" />
        <param argument="promiscuous_consensus" type="boolean" truevalue="TRUE" falsevalue="FALSE" label="Promiscuous consensus" help="Whether rules of amplicanConsensus should be promiscuous. When promiscuous, we allow indels that have no confirmation on the other strand" />
        <!--Scoring matrix options-->
        <param argument="match_scoring" type="integer" min="0" max="20" value="5" label="Match scoring" help="TODO" />
        <param argument="mismatch_scoring" type="integer" min="-20" max="0" value="-4" label="Mismatch scoring" help="TODO" />
        <param argument="base_only" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="True" label="Base only" help="TODO" />
        <param argument="scoring_type" type="select" label="Scoring matrix type" help="TODO">
            <option value="DNA" selected="True">DNA</option>
            <option value="RNA">RNA</option>
        </param>
    </inputs>      
    <outputs>
        <data name="config_summary" from_work_dir="./output_folder/config_summary.csv" format="csv" label="${tool.name} on ${on_string}: config summary"/>
        <data name="barcode_reads" from_work_dir="./output_folder/barcode_reads_filters.csv" format="tabular" label="${tool.name} on ${on_string}: barcode reads filters"/>
        <data name="output_html" from_work_dir="./output_folder/reports/index.html" format="html" label="${tool.name} on ${on_string}: report"/>
    </outputs>
    <tests>
        <test></test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**Purpose**

----

Columns of the config file:

ID - should be a unique identifier of your experiments
Barcode - use this to group experiments with the same barcode
Forward_Reads, Reverse_Reads - put names of your files in these fields, you can put here files compressed to .gz, we will unpack them for you
Group - use this field if you want to group ID by other criteria, here for instance we will group by person that performed experiment, on later stage it is possible to generate report with breakdown using this field
guideRNA - put your guideRNA in 5’ to 3’ fashion here, if he has to be reverse complemented to be found in the amplicon put “1” into Direction field, we will use this field to make sure your guideRNA is inside the amplicon and during plotting of the results
Forward_Primer, Reverse_Primer - make sure these primers are correct for each of your IDs, Forward_Primer should be found in the amplicon as is, on the left side of the guide, Reverse_Primer reverse complement should be found on the amplicon on the right side of the guide
Direction - here “0” means guide does not requires to be reverse complemented to be matched to the amplicon, “1” means it should be reverse complemented, this field is also used when plotting deletions, mismatches and insertions
Amplicon - insert amplicon sequence as lower case letters, by putting UPPER CASE letters you can specify expected cut site, you should specify at least one cut site, here for example we specify in uppercase letter PAM sequence of the corresponding guideRNA
Donor - insert donor template if you have designed HDR experiments or used base editors, otherwise leave empty, but keep the column. amplican will estimate HDR efficiency based on the events from aligning donor and amplicon sequences, donor and reads and reads and amplicon.
If you have only forward primers leave column Reverse_Primer empty, leave empty also the Reverse_Reads column. You can still use amplican like normal.                  
    ]]>    </help>
    <expand macro="citations" />
</tool>
