<tool id="snpfreqplot" name="SNP Frequency Plot" version="@VERSION@+@GALAXY_VERSION@" profile="20.09">
    <description>Plots a heatmap of allele frequencies grouped by variant type</description>
    <macros>
        <token name="@VERSION@">1.0</token>
        <token name="@GALAXY_VERSION@">1</token>
    </macros>
    <requirements>
        <requirement type="package" version="1.0.12">r-pheatmap</requirement>
        <requirement type="package" version="1.1_2">r-rcolorbrewer</requirement>
        <requirement type="package" version="1.3.0">r-tidyverse</requirement>
        <requirement type="package" version="1.18.0">bioconductor-variantfiltering</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
Rscript '$__tool_directory__/heatmap_for_variants.R' '$options' >&2
    ]]>
    </command>
    <configfiles>
        <configfile name="options"><![CDATA[
samples = list(ids = c(), files = c())
#for $i, $x in enumerate($sinputs):
samples\$ids = c(samples\$ids, '${x.sid}')
samples\$files = c(samples\$files, '${x.sdata}')
#end for
samples = data.frame(samples, stringsAsFactors=F)

## ## Disabled
## ## - Date sorting has been disabled, because the user can simply provide
## ##   the ordering using the sample IDs
## #if str($date.has) == "TRUE"
## date.has <- TRUE
## date.regex <- as.character( '$date.regex' )
## #else
## date.has <- FALSE
## #end if

variant.frequency <- as.numeric( '$varfreq' )
img.multiplier_width <- as.numeric( '$advanced.multiplier_width' )
img.multiplier_height <- as.numeric( '$advanced.multiplier_height' )
brewer.color_gene_annotation <- as.character( '$advanced.color' )

#if str($clustering.do) == "TRUE":
pheat.clustering <- TRUE
pheat.clustering_method <- as.character( '$clustering.method' )
pheat.number_of_clusters <- as.integer( '$clustering.nclust' )
#else
pheat.clustering <- FALSE
#end if

out.filepdf <- '$outpdf'

]]>
        </configfile>
    </configfiles>
    <inputs>
        <repeat name="sinputs" min="2" value="2" title="Sample Inputs">
            <param name="sid" type="text" label="Sample ID" help="Used as axes labels" >
                <!-- <validator>these might be strictly numeric, will check later</validator> -->
            </param>
            <param name="sdata" type="data" format="tabular" label="Sample Data" />
        </repeat>
        <!-- Date sorting has been disabled, because the user can simply provide
             the ordering using the sample IDs -->
        <!-- <conditional name="date"> -->
        <!--     <param name="has" type="select" label="Filenames contain Date Information?" help="Sample inputs contain date information?" > -->
        <!--         <option value="TRUE">Yes</option> -->
        <!--         <option value="FALSE" selected="true">No</option> -->
        <!--     </param> -->
        <!--     <when value="TRUE"> -->
        <!--         <param name="regex" type="text" label="Date Regex" help="Regex used to extract dates from sample data" -->
        <!--                value="\d{2}[[:punct:]]\d{2}[[:punct:]]\d{4}" > -->
        <!--             <!-\- <validator type="regex" message=" ">this needs work</validator> -\-> -->
        <!--         </param> -->
        <!--     </when> -->
        <!--     <when value="FALSE" /> -->
        <!-- </conditional> -->
        <param name="varfreq" type="float" min="0" max="1"
               value="0.1" label="Variant Frequency" />
        <section name="advanced" title="Image Properties" >
            <param name="multiplier_width" type="float" value="0.5"
                   min="0.1" max="1" label="PDF Width Multiplier" />
            <param name="multiplier_height" type="float" value="0.6"
                   min="0.1" max="1" label="PDF Height Multiplier" />
            <param name="color" type="select" label="Color Gene Annotation" >
                <option value="Set1" />
                <option value="Set2" />
                <option value="Set3" selected="true" />
                <option value="Pastel2" />
                <option value="Pastel1" />
                <option value="Paired" />
                <option value="Dark2" />
                <option value="Accent" />
                <option value="YlOrRd" />
                <option value="YlOrBr" />
                <option value="YlGnBu" />
                <option value="YlGn" />
                <option value="Reds" />
                <option value="RdPu" />
                <option value="Purples" />
                <option value="PuRd" />
                <option value="PuBuGn" />
                <option value="PuBu" />
                <option value="OrRd" />
                <option value="Oranges" />
                <option value="Greys" />
                <option value="Greens" />
                <option value="GnBu" />
                <option value="BuPu" />
                <option value="BuGn" />
                <option value="Blues" />
                <option value="Spectral" />
                <option value="RdYlGn" />
                <option value="RdYlBu" />
                <option value="RdGy" />
                <option value="RdBu" />
                <option value="PuOr" />
                <option value="PRGn" />
                <option value="PiYG" />
                <option value="BrBG" />
            </param>
        </section>
        <conditional name="clustering">
            <param name="do" type="select" label="Perform Clustering?" >
                <option value="TRUE">Yes</option>
                <option value="FALSE" selected="true">No</option>
            </param>
            <when value="TRUE" >
                <param name="nclust" type="integer"
                       min="1" value="5" label="Number of Cluster" />
                <param name="method" type="select" label="Clustering Method" >
                    <option value="ward.D" />
                    <option value="ward.D2" selected="true" />
                    <option value="single" />
                    <option value="complete" />
                    <option value="average" >average (UPGMA)</option>
                    <option value="mcquitty" >mcquitty (WPGMA)</option>
                    <option value="median" >median (WPGMC)</option>
                    <option value="centroid" >centroid (UPGMC)</option>
                </param>
            </when>
            <when value="FALSE" />
        </conditional>
    </inputs>
    <outputs>
        <data name="outpdf" format="pdf" label="SNP Frequency Plot on ${on_string}" />
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <!-- defaults -->
            <param name="sinputs_0|sid" value="436" />
            <param name="sinputs_0|sdata" value="input436.tabular" />
            <param name="sinputs_1|sid" value="437" />
            <param name="sinputs_1|sdata" value="input437.tabular" />
            <param name="sinputs_2|sid" value="438" />
            <param name="sinputs_2|sdata" value="input438_date-01-06-2007.tabular" />
            <param name="sinputs_3|sid" value="439" />
            <param name="sinputs_3|sdata" value="input439_date-02-06-2007.tabular" />
            <param name="sinputs_4|sid" value="440" />
            <param name="sinputs_4|sdata" value="input440_date-01-07-2007.tabular" />
            <param name="sinputs_5|sid" value="441" />
            <param name="sinputs_5|sdata" value="input441_date-20-05-2007.tabular" />
            <param name="sinputs_6|sid" value="442" />
            <param name="sinputs_6|sdata" value="input442_date-20-05-2006.tabular" />
            <param name="sinputs_7|sid" value="443" />
            <param name="sinputs_7|sdata" value="input443.tabular" />
            <param name="sinputs_8|sid" value="444" />
            <param name="sinputs_8|sdata" value="input444.tabular" />
            <output name="outpdf" value="heatmap.default.pdf" compare="sim_size" delta="250" />
        </test>
        <test expect_num_outputs="1">
            <!-- small data, non-numeric IDS, image options -->
            <param name="sinputs_0|sid" value="MyID1" />
            <param name="sinputs_0|sdata" value="input436.tabular" />
            <param name="sinputs_1|sid" value="MyID2" />
            <param name="sinputs_1|sdata" value="input437.tabular" />
            <param name="sinputs_2|sid" value="MyID3" />
            <param name="sinputs_2|sdata" value="input443.tabular" />
            <param name="sinputs_3|sid" value="MyID4" />
            <param name="sinputs_3|sdata" value="input444.tabular" />
            <param name="varfreq" value="0.5" />
            <section name="advanced" >
                <param name="multiplier_width" value="0.8" />
                <param name="multiplier_height" value="1" />
                <param name="color" value="Spectral" />
            </section>
            <output name="outpdf" value="heatmap.imageopts.pdf" compare="sim_size" delta="250" />
        </test>
        <test expect_num_outputs="1">
            <!-- clustering defaults -->
            <param name="sinputs_0|sid" value="438" />
            <param name="sinputs_0|sdata" value="input438_date-01-06-2007.tabular" />
            <param name="sinputs_1|sid" value="439" />
            <param name="sinputs_1|sdata" value="input439_date-02-06-2007.tabular" />
            <param name="sinputs_2|sid" value="440" />
            <param name="sinputs_2|sdata" value="input440_date-01-07-2007.tabular" />
            <param name="sinputs_3|sid" value="441" />
            <param name="sinputs_3|sdata" value="input441_date-20-05-2007.tabular" />
            <param name="sinputs_4|sid" value="442" />
            <param name="sinputs_4|sdata" value="input442_date-20-05-2006.tabular" />
            <conditional name="clustering">
                <param name="do" value="TRUE" />
            </conditional>
            <section name="advanced" >
                <param name="color" value="Greys" />
            </section>
            <output name="outpdf" value="heatmap.clustering.pdf" compare="sim_size" delta="250" />
        </test>
        <test expect_num_outputs="1">
            <!-- clustering extras, mixed alphanumeric labels -->
            <param name="sinputs_0|sid" value="labelA" />
            <param name="sinputs_0|sdata" value="input436.tabular" />
            <param name="sinputs_1|sid" value="438" />
            <param name="sinputs_1|sdata" value="input438_date-01-06-2007.tabular" />
            <param name="sinputs_2|sid" value="labelB" />
            <param name="sinputs_2|sdata" value="input443.tabular" />
            <param name="sinputs_3|sid" value="444" />
            <param name="sinputs_3|sdata" value="input444.tabular" />
            <conditional name="clustering">
                <param name="do" value="TRUE" />
                <param name="nclust" value="2" />
                <param name="method" value="centroid" />
            </conditional>
            <section name="advanced" >
                <param name="color" value="Purples" />
            </section>
            <output name="outpdf" value="heatmap.clustering2.pdf" compare="sim_size" delta="250" />
        </test>
    </tests>
    <help><![CDATA[

    ]]></help>
    <citations>
        <!-- <citation type="doi"></citation> -->
    </citations>
</tool>
