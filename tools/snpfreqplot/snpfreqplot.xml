<tool id="snpfreqplot" name="SNP Frequency Plot" version="@VERSION@+galaxy@GALAXY_VERSION@" profile="20.09"
      license="GPL-3.0-or-later" >
    <description>Generates a heatmap of allele frequencies grouped by variant type for SnpEFF annotated SARS-CoV-2 data</description>
    <macros>
        <token name="@VERSION@">1.0</token>
        <token name="@GALAXY_VERSION@">0</token>
    </macros>
    <requirements>
        <requirement type="package" version="1.0.12">r-pheatmap</requirement>
        <requirement type="package" version="1.1_2">r-rcolorbrewer</requirement>
        <requirement type="package" version="1.3.0">r-tidyverse</requirement>
        <requirement type="package" version="1.36.0">bioconductor-variantannotation</requirement>
    </requirements>
    <edam_topics>
        <edam_topic>topic_0797</edam_topic>
        <edam_topic>topic_0092</edam_topic>
    </edam_topics>
    <edam_operations>
        <edam_operation>operation_3436</edam_operation>
    </edam_operations>
    <command detect_errors="exit_code"><![CDATA[
cat '$__tool_directory__/helperFunctions.R' \
    '$__tool_directory__/snpEffExtract.R' \
    '$__tool_directory__/heatmap_for_variants.R' > /dev/null
&& Rscript '$configscript'
    ]]>
    </command>
    <configfiles>
        <configfile name="configscript"><![CDATA[
## 1. Set Sample Inputs
##    ------------------
##    Create a dataframe of sample ids, filetypes, and filenames
##    from the input collection. At this point, the list could be
##    of mixed type (vcf and tabular), though maybe Galaxy
##    restricts that.
samples = list(ids = c(), exts= c(), files = c())
#for $i, $file in enumerate($sinputs):
samples\$ids = c(samples\$ids, '${file.element_identifier}')
samples\$exts = c(samples\$exts, '${file.extension}')
samples\$files = c(samples\$files, '${file}')
#end for
samples = data.frame(samples, stringsAsFactors=F)

## 2. Input Conversion (external script)
##    ----------------------------------
##    We source the input conversion script *after* the samples
##    have been populated, so that it performs an inplace replacement
##    of the vcf inputs with their converted tabular counterparts.
##
##    All samples are all tabular after this point
source('$__tool_directory__/helperFunctions.R')
source('$__tool_directory__/snpEffExtract.R')

## 3. Galaxy Params
##    --------------
##    Set the general script parameters from the UI
variant_frequency <- as.numeric( '$varfreq' )
brewer_color_gene_annotation <- as.character( '$advanced.color' )

#if str($clustering.do) == "TRUE":
pheat_clustering <- TRUE
pheat_clustering_method <- as.character( '$clustering.method' )
pheat_number_of_clusters <- as.integer( '$clustering.nclust' )
#else
pheat_clustering <- FALSE
pheat_clustering_method <- "ward.D2"
pheat_number_of_clusters <- 5
#end if

cell_width = as.integer('$advanced.cellwidth')
cell_height = as.integer('$advanced.cellheight')
if (cell_width == 0 ){ cell_width = NA}
if (cell_height == 0 ){ cell_height = NA}

out_file <- '$outfile'
out_type = '$advanced.output_type'

## 4. Generate Heatmap (external script)
##    ----------------------------------
source('$__tool_directory__/heatmap_for_variants.R')

]]>
        </configfile>
    </configfiles>
    <inputs>
        <param name="sinputs" format="tabular,vcf" type="data" multiple="true"
               collection_type="list" label="Sample Inputs"
               help="The dataset names within the collection will be used as sample identifiers." />
        <param name="varfreq" type="float" min="0" max="1"
               value="0.1" label="Variant Frequency Threshold" />
        <section name="advanced" title="Image Properties" >
            <param name="output_type" type="select" label="Output Format" >
                <option value="PDF" selected="true" />
                <option value="PNG" />
                <!-- <option value="SVG" /> -->
                <option value="TIFF" />
                <option value="BMP" />
                <option value="JPEG" />
            </param>
            <param name="cellwidth" label="Cell Width" type="integer"
                   min="0" value="0"
                   help="Individual Cell Width in points. If set to 0, then the values depend on the size of plotting window." />
            <param name="cellheight" label="Cell Height" type="integer"
                   min="0" value="0"
                   help="Individual Cell Height in points. If set to 0, then the values depend on the size of plotting window." />
            <param name="color" type="select" label="Color Gene Annotation" >
                <option value="Set1" />
                <option value="Set2" />
                <option value="Set3" selected="true" />
                <option value="Pastel2" />
                <option value="Pastel1" />
                <option value="Paired" />
                <option value="Dark2" />
                <option value="Accent" />
                <option value="YlOrRd" />
                <option value="YlOrBr" />
                <option value="YlGnBu" />
                <option value="YlGn" />
                <option value="Reds" />
                <option value="RdPu" />
                <option value="Purples" />
                <option value="PuRd" />
                <option value="PuBuGn" />
                <option value="PuBu" />
                <option value="OrRd" />
                <option value="Oranges" />
                <option value="Greys" />
                <option value="Greens" />
                <option value="GnBu" />
                <option value="BuPu" />
                <option value="BuGn" />
                <option value="Blues" />
                <option value="Spectral" />
                <option value="RdYlGn" />
                <option value="RdYlBu" />
                <option value="RdGy" />
                <option value="RdBu" />
                <option value="PuOr" />
                <option value="PRGn" />
                <option value="PiYG" />
                <option value="BrBG" />
            </param>
        </section>
        <conditional name="clustering">
            <param name="do" type="select" label="Perform Clustering?" >
                <option value="TRUE">Yes</option>
                <option value="FALSE" selected="true">No</option>
            </param>
            <when value="TRUE" >
                <param name="nclust" type="integer"
                       min="1" value="5" label="Number of Cluster" />
                <param name="method" type="select" label="Clustering Method" >
                    <option value="ward.D" />
                    <option value="ward.D2" selected="true" />
                    <option value="single" />
                    <option value="complete" />
                    <option value="average" >average (UPGMA)</option>
                    <option value="mcquitty" >mcquitty (WPGMA)</option>
                    <option value="median" >median (WPGMC)</option>
                    <option value="centroid" >centroid (UPGMC)</option>
                </param>
            </when>
            <when value="FALSE" />
        </conditional>
    </inputs>
    <outputs>
        <data name="outfile" label="SNP Frequency Plot on ${on_string}: ${advanced.output_type}" >
            <change_format>
                <when input="advanced.output_type" value="PDF" format="pdf" />
                <!-- <when input="advanced.output_type" value="SVG" format="svg" /> -->
                <when input="advanced.output_type" value="PNG" format="png" />
                <when input="advanced.output_type" value="TIFF" format="tiff" />
                <when input="advanced.output_type" value="BMP" format="bmp" />
                <when input="advanced.output_type" value="JPEG" format="jpg" />
            </change_format>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <!-- PDF, tabular inputs -->
            <param name="sinputs" ftype="tabular"
                   value="input436.tabular,input437.tabular,input438.tabular,input439.tabular,input440.tabular,input441.tabular,input442.tabular,input443.tabular,input444.tabular" />
            <section name="advanced" >
                <param name="cellwidth" value="20" />
                <param name="cellheight" value="25" />
            </section>
            <output name="outfile" value="heatmap.default.pdf" compare="sim_size" delta="250" />
        </test>
        <test expect_num_outputs="1">
            <!-- JPEG, multiple inputs, non-numeric IDS -->
            <param name="sinputs" ftype="tabular" value="input436.tabular,input437.tabular,input443.tabular,input444.tabular" />
            <param name="varfreq" value="0.5" />
            <section name="advanced" >
                <param name="color" value="Spectral" />
                <param name="cellheight" value="35" />
                <param name="output_type" value="JPEG" />
            </section>
            <output name="outfile" value="heatmap.imageopts.jpg" compare="sim_size" delta="250" />
        </test>
        <test expect_num_outputs="1">
            <!-- PDF, clustering defaults -->
            <param name="sinputs" ftype="tabular"
                   value="input438.tabular,input439.tabular,input440.tabular,input441.tabular,input442.tabular" />
            <conditional name="clustering">
                <param name="do" value="TRUE" />
            </conditional>
            <section name="advanced" >
                <param name="color" value="Greys" />
                <param name="cellheight" value="35" />
                <param name="output_type" value="PDF" />
            </section>
            <output name="outfile" value="heatmap.clustering.pdf" compare="sim_size" delta="500" />
        </test>
        <test expect_num_outputs="1">
            <!-- PNG, clustering extras, mixed alphanumeric labels -->
            <param name="sinputs" ftype="tabular"
                   value="input436.tabular,input443.tabular,input438.tabular,input444.tabular" />
            <conditional name="clustering">
                <param name="do" value="TRUE" />
                <param name="nclust" value="2" />
                <param name="method" value="centroid" />
            </conditional>
            <section name="advanced" >
                <param name="color" value="Purples" />
                <param name="cellheight" value="30" />
                <param name="output_type" value="PNG" />
            </section>
            <output name="outfile" value="heatmap.clustering2.png" compare="sim_size" delta="250" />
        </test>
        <test expect_num_outputs="1">
            <!-- TIFF, vcf test -->
            <param name="sinputs" ftype="vcf"
                   value="snpeff.123.vcf,snpeff.456.vcf,snpeff.789.vcf" />
            <section name="advanced" >
                <param name="color" value="PuBuGn" />
                <param name="cellheight" value="30" />
                <param name="output_type" value="TIFF" />
            </section>
            <output name="outfile" value="heatmap.clustering_vcf.tiff" compare="sim_size" delta="250" />
        </test>
        <test expect_num_outputs="1">
            <!-- JPEG, problematic vcf test -->
            <param name="sinputs" ftype="vcf" value="1084286.vcf,1084592.vcf,1084910.vcf,1085150.vcf,1085841.vcf,1085980.vcf,1084452.vcf,1084825.vcf,1085080.vcf,1085445.vcf,1085844.vcf,1085990.vcf" />
            <section name="advanced" >
                <param name="cellheight" value="20" />
                <param name="output_type" value="JPEG" />
            </section>
            <output name="outfile" value="heatmap.default_vcf.jpg" compare="sim_size" delta="250" />
        </test>
    </tests>
    <help><![CDATA[
TODO: Fill me with info
    ]]></help>
    <citations>
        <!-- <citation type="doi"></citation> -->
    </citations>
</tool>
