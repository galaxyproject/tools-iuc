<tool id="ODB-mapper" name="Map to orthology" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Map FASTA to OrthoDB orthology</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
    ## set the number of threads to be used
    export NTHREADS=\${GALAXY_SLOTS:-1} &&
    ODB-mapper SETUP &&
    ODB-mapper MAP odbmap
    odbmap:'$fasta'
    #if '$node':
      '$node'
    #end if
    ##
    ## softlink result files - the directory name depends on OrthoDB version used in the mapping
    && results_path="\$(ODB-mapper CONFIG project)/Results"
    && grep -v '^#' \$results_path/odbmap.og.annotations > odbmap.og.annotations
    && grep -v '^#' \$results_path/odbmap.og.odb > odbmap.og.odb 
    && ln -sf \$results_path/odbmap.summary.txt ./
    ]]></command>
    <inputs>
        <param type="data" name="fasta" format="fasta" label="Input FASTA file"/>
        <param type="integer" name="node" optional="true" label="optional OrthDB node as NCBI taxid - if not given, it uses busco autolineage to establish node"/>
    </inputs>
    <outputs>
        <data name="annotations" label="${tool.name} on ${on_string} : mapped genes with annotations"    format="tsv" from_work_dir="odbmap.og.annotations">
            <actions>
                <action name="column_names" type="metadata" default="query,odb_og,evalue,score,COG_category,Description,GOs_mf,GOs_bp,EC,KEGG_ko,Interpro" />
            </actions>
        </data>
        <data name="clusters"    label="${tool.name} on ${on_string} : clusters with OrthoDB ids" format="txt" from_work_dir="odbmap.og.odb">
            <actions>
                <action name="column_names" type="metadata" default="odb_og,gene_id,og_type,nvertices,ali_start,ali_end,pid,score,evalue" />
            </actions>
        </data>
        <data name="summary"     label="${tool.name} on ${on_string} : clustering stats"  format="txt" from_work_dir="odbmap.summary.txt" />
    </outputs>
    <tests>
        <test>
            <param name="fasta" value="example.fs"/>
            <param name="node" value="1489911"/>
            <output name="clusters">
                <assert_contents>
                    <has_size value="13876269" delta="3000"/>
                </assert_contents>
            </output>

        </test>
    </tests>
    <help><![CDATA[

    This tool maps a given fasta file against OrthoDB orthology.
    The level is given as an NCBI taxid (e.g 33208 for Metazoa).
    If no level is given, a level is selected using busco autolineage.
    
    Taxids can be found at `NCBI <https://www.ncbi.nlm.nih.gov/taxonomy>`_ .
    
    For more information
    * `orthologer user manual <https://orthologer.ezlab.org>`_
    
    ]]></help>
    <expand macro="citations"/>
</tool>
