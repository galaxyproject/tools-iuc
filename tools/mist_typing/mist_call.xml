<tool id="mist_call" name="Minimap2-inferred sequence typing (MiST) call" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <description>Calls alleles from a FASTA file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        #import re

        mist call

        --fasta '$section_input.fasta'
        #set $identifier = re.sub('[^\s\w\-\\.]', '_', str($section_input.fasta.element_identifier))
        --sample-id '${identifier}'
        --db '$section_input.db.fields.path'

        #if 'tsv' in $output_files:
            --out-tsv '$out_tsv'
        #end if
        #if 'json' in $output_files:
            --out-json '$out_json'
        #end if

        --multi '$section_options.multi'
        --threads \${GALAXY_SLOTS:-1}
    ]]></command>
    <inputs>
        <!-- Input files -->
        <section name="section_input" title="Input" expanded="true">
            <param argument="--fasta" type="data" format="fasta" label="Input FASTA file"/>
            <param argument="--db" type="select" label="(cg)MLST scheme">
                <options from_data_table="mist_dbs"/>
            </param>
        </section>

        <!-- Options -->
        <section name="section_options" title="Options" expanded="true">
            <param argument="--multi" type="select" label="Multi-hit strategy" help="Strategy to handle multiple perfect matches.">
                <option value="all">All</option>
                <option value="first">First</option>
                <option value="longest" selected="true">Longest</option>
            </param>
        </section>

        <!-- Output -->
        <param name="output_files" type="select" optional="false" multiple="true" label="Output files">
            <option value="json" selected="false">JSON</option>
            <option value="tsv" selected="true">Tabular (TSV)</option>
        </param>
    </inputs>
    <outputs>
        <data name="out_tsv" format="tabular" label="${tool.name} on ${on_string} - ${section_input.db.fields.name} (TSV)">
            <filter>'tsv' in output_files</filter>
        </data>
        <data name="out_json" format="json" label="${tool.name} on ${on_string} - ${section_input.db.fields.name} (JSON)">
            <filter>'json' in output_files</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="section_input|fasta" value="query-perfect_hits.fasta"/>
            <param name="section_input|db" value="example_scheme"/>
        </test>
    </tests>
    <help><![CDATA[
        **What it does**

        MiST_ is a suite of tools for rapid multi-locus sequence typing (MLST), core-genome MLST (cgMLST),
        and whole-genome MLST (wgMLST).

        `MiST call`_ queries a pre-indexed MSLT, cgMLST or wgMLST database using a FASTA file containing a (draft)
        genome. It performs allele calling for each locus in the selected scheme.

        The output of `MiST call`_ can be used to generate pairwise distance matrices or allele matrices with *MiST dists*.

        .. _MiST: https://github.com/BioinformaticsPlatformWIV-ISP/MiST
        .. _`MiST call`: https://github.com/BioinformaticsPlatformWIV-ISP/MiST/wiki/running-mist

-----

        **How to run**

        1. Select a FASTA file as input
        2. Select a MLST, cgMLST or wgMLST database
        3. Run the tool

-----

        **Output**

        **MiST call** can generate output in the following formats:

        - **TSV**: Tabular output, with one line per locus
        - **JSON**: Detailed output containing additional information on all identified alleles

        If the sequence type is present in the database, it is reported in the logs and included in the JSON output.

-----

        **More information**

        Step-by-step tutorials and additional documentation are available in the `MiST wiki`.

        .. _`MiST wiki`: https://github.com/BioinformaticsPlatformWIV-ISP/MiST/wiki
    ]]></help>
    <expand macro="citations"/>
</tool>