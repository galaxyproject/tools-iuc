<tool id="mist_dists" name="Minimap2-inferred sequence typing (MiST) dists" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <description>Builds distance and allele matrices from MiST output files</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        ## Input files
        #set $input_files = []
        #for $i, $input in enumerate($section_input.input):
            ## Create a safe filename (e.g., input_0.tsv, input_1.tsv).
            ## MiST relies upon the extension to identify the datatype.
            #set $ext = 'tsv' if $input.ext == 'tabular' else $input.ext
            #set $safe_name = 'input_%d.%s' % ($i, $ext)
            ln -s '$input' '$safe_name' &&
            #silent $input_files.append($safe_name)
        #end for

        ## Command
        mist dists
        ${' '.join($input_files)}

        ## Output files
        #if 'dists' in $output_files:
            --out-dists '$out_dists'
        #end if
        #if 'matrix' in $output_files:
            --out-matrix '$out_matrix'
        #end if

        ## Options
        --min-perc-loci $section_options.min_perc_loci
        --min-perc-samples $section_options.min_perc_samples
    ]]></command>
    <inputs>
        <!-- Input files -->
        <section name="section_input" title="Input" expanded="true">
            <param name="input" type="data" multiple="true" format="tabular,json" label="MiST call output files"
                   help="MiST call output files (TSV or JSON). Multiple datasets can be selected, but each dataset must be either TSV or JSON."/>
        </section>

        <!-- Options -->
        <section name="section_options" title="Options" expanded="true">
            <param argument="--min-perc-loci" type="integer" min="-1" max="100" value="90" label="Min. % loci"
                   help="Minimum percentage of loci that must be present in a sample. Samples with fewer loci than this threshold are removed." />
            <param argument="--min-perc-samples" type="integer" min="-1" max="100" value="90" label="Min. % samples"
                   help="Minimum percentage of samples in which a locus must be present. Loci present in fewer samples than this threshold are removed." />
        </section>

        <!-- Output -->
        <param name="output_files" type="select" optional="false" multiple="true" label="Output files">
            <option value="dists" selected="true">Pairwise distance matrix</option>
            <option value="matrix" selected="true">Allele matrix</option>
        </param>
    </inputs>
    <outputs>
        <data name="out_dists" format="tabular" label="${tool.name} on ${on_string} (pairwise distances)">
            <filter>'dists' in output_files</filter>
        </data>
        <data name="out_matrix" format="tabular" label="${tool.name} on ${on_string} (allele matrix)">
            <filter>'matrix' in output_files</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="section_input|input" value="dists/GCF_000010485.1.json,dists/GCF_025995355.1.json,dists/GCF_026016785.1.json,dists/GCF_036419615.1.json"/>
             <output name="out_dists">
                <assert_contents>
                    <has_text text="GCF_000010485.1" />
                    <has_text text="GCF_025995355.1" />
                    <has_text text="GCF_026016785.1" />
                    <has_text text="GCF_036419615.1" />
                </assert_contents>
            </output>
             <output name="out_matrix">
                <assert_contents>
                    <has_text text="GCF_000010485.1" />
                    <has_text text="GCF_025995355.1" />
                    <has_text text="GCF_026016785.1" />
                    <has_text text="GCF_036419615.1" />
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="2">
            <param name="section_input|input" value="dists/GCF_000010485.1.tsv,dists/GCF_025995355.1.tsv,dists/GCF_026016785.1.tsv,dists/GCF_036419615.1.tsv"/>
        </test>
    </tests>
    <help><![CDATA[
        **What it does**

        MiST_ is a suite of tools for rapid multi-locus sequence typing (MLST), core-genome MLST (cgMLST),
        and whole-genome MLST (wgMLST).

        `MiST dists`_ Builds distance and allele matrices from *MiST call* output files.

        The allele matrix produced by `MiST dists`_ can be used as input for phylogenetic analyses using
        tree-building tools such as GrapeTree_.

        .. _MiST: https://github.com/BioinformaticsPlatformWIV-ISP/MiST
        .. _`MiST dists`: https://github.com/BioinformaticsPlatformWIV-ISP/MiST/wiki/phylogenies
        .. _GrapeTree: https://github.com/achtman-lab/GrapeTree

-----

        **How to run**

        1. Select *MiST call* output files as input. Both TSV and JSON formats are supported; however, only one format should be provided per sample.
        2. Configure the allele matrix filtering options.
        3. Run the tool.

-----

        **Output**

        **MiST dists** can generate output in the following formats:

        - **Allele matrix**: A matrix in which each column represents a locus and each row represents a dataset.
        - **Pairwise distances**: A symmetric distance matrix containing pairwise allele distances derived from the filtered allele matrix.

-----

        **More information**

        Step-by-step tutorials and additional documentation are available in the `MiST wiki`_.

        .. _`MiST wiki`: https://github.com/BioinformaticsPlatformWIV-ISP/MiST/wiki
    ]]></help>
    <expand macro="citations"/>
</tool>
