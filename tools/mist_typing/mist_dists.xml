<tool id="mist_dists" name="Minimap2-inferred sequence typing (MiST) dists" version="1.0.0+galaxy0" profile="21.05">
    <description>Builds distance and allele matrices from MiST output files</description>
    <requirements>
        <requirement type="package" version="1.0.0">mist_typing</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        ## Input files
        #set $input_files = []
        #if $section_input.input_type.input_type_selector == "tsv":
            #for $i, $input in enumerate($section_input.input_type.input_tsv):
                ## Create a safe filename (e.g., input_0.tsv, input_1.tsv)
                #set $safe_name = "input_%d.tsv" % $i
                ln -s '$input' '$safe_name' &&
                #silent $input_files.append($safe_name)
            #end for
        #else if $section_input.input_type.input_type_selector == "json":
            #for $i, $input in enumerate($section_input.input_type.input_json):
                #set $safe_name = "input_%d.json" % $i
                ln -s '$input' '$safe_name' &&
                #silent $input_files.append($safe_name)
            #end for
        #end if

        ## Command
        mist dists
        ${' '.join($input_files)}

        ## Output files
        #if 'dists' in $output_files:
            --out-dists $out_dists
        #end if
        #if 'matrix' in $output_files:
            --out-matrix $out_matrix
        #end if

        ## Options
        --min-perc-loci $section_options.min_perc_loci
        --min-perc-samples $section_options.min_perc_samples
    ]]></command>
    <inputs>
        <!-- Input files -->
        <section name="section_input" title="Input" expanded="true">
            <conditional name="input_type">
                <param name="input_type_selector" type="select" label="Input type" help="The files should be generated using MiST call">
                    <option value="tsv" selected="true">TSV</option>
                    <option value="json">JSON</option>
                </param>
                <when value="tsv">
                    <param name="input_tsv" type="data" multiple="true" format="tabular" label="MiST call TSV output"/>
                </when>
                <when value="json">
                    <param name="input_json" type="data" multiple="true" format="json" label="MiST call JSON output"/>
                </when>
            </conditional>
        </section>

        <!-- Options -->
        <section name="section_options" title="Options" expanded="true">
            <param argument="--min-perc-loci" type="integer" min="-1" max="100" value="90" label="Min. % loci"
                   help="Minimum percentage of loci that must be present in a sample. Samples with fewer loci than this threshold are removed." />
            <param argument="--min-perc-samples" type="integer" min="-1" max="100" value="90" label="Min. % samples"
                   help="Minimum percentage of samples in which a locus must be present. Loci present in fewer samples than this threshold are removed." />
        </section>

        <!-- Output -->
        <param name="output_files" type="select" display="checkboxes" optional="true" multiple="true" label="Output files">
            <option value="dists" selected="true">Pairwise distance matrix</option>
            <option value="matrix" selected="true">Allele matrix</option>
        </param>
    </inputs>
    <outputs>
        <data name="out_dists" format="tabular" label="MiST dists on ${on_string} (pairwise distances)">
            <filter>'dists' in output_files</filter>
        </data>
        <data name="out_matrix" format="tabular" label="MiST dists on ${on_string} (allele matrix)">
            <filter>'matrix' in output_files</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="section_input|input_type|input_type_selector" value="json"/>
            <param name="section_input|input_type|input_json" value="dists/GCF_000010485.1.json,dists/GCF_025995355.1.json,dists/GCF_026016785.1.json,dists/GCF_036419615.1.json"/>
        </test>
        <test expect_num_outputs="2">
            <param name="section_input|input_type|input_type_selector" value="tsv"/>
            <param name="section_input|input_type|input_tsv" value="dists/GCF_000010485.1.tsv,dists/GCF_025995355.1.tsv,dists/GCF_026016785.1.tsv,dists/GCF_036419615.1.tsv"/>
        </test>
    </tests>
    <help><![CDATA[
        **How to run**

        1. Select MiST output files
        2. Run the tool

        **More information**

        More information and tutorials are available on the **MiST wiki**:
        https://github.com/BioinformaticsPlatformWIV-ISP/MiST/wiki
    ]]></help>

    <citations>
        <citation type="doi">https://doi.org/10.1186/s12864-025-12324-z</citation>
    </citations>
</tool>
