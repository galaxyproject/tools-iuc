<tool id="mmseqs2_easy_taxonomy" name="MMseqs2 Easy Taxonomy" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>
        assignment of sequences against a reference database
    </description>
    <macros>
        <import>macro.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command detect_errors="aggressive"><![CDATA[
##Used only for test
#if str($download_tax_db) == 'true':
cp -r '$database.database_type.mmseqs2_db_select.fields.path'/database* . &&

mmseqs createtaxdb
    database
    'tmp' &&
#end if
##

mmseqs easy-taxonomy
    '$query_fasta'
    ##Used only for test
    #if str($download_tax_db) == 'true':
        'database'
    ##
    #else
        '$database.database_type.mmseqs2_db_select.fields.path'/database
    #end if
    'result'
    'tmp'

    @CMD_DBTYPE@

    ## Pre-filter options
    @CMD_PREFILTER@
    --spaced-kmer-mode $prefilter.spaced_kmer_mode
    @CMD_SEARCH_COMMON@

    ## Align options
    @CMD_ALIGN@
    @CMD_SEARCH_ALIGN@

    ## Profile options
    --mask-profile $profile.mask_profile
    --e-profile $profile.e_profile
    --wg $profile.wg
    --filter-msa $profile.filter_msa
    --filter-min-enable $profile.filter_min_enable
    --max-seq-id $profile.max_seq_id
    --qid $profile.qid
    --qsc $profile.qsc
    --cov $profile.cov
    --diff $profile.diff
    --pseudo-cnt-mode $profile.pseudo_cnt_mode
    --exhaustive-search $profile.exhaustive_search
    --lca-search $profile.lca_search

    ## Taxonomy options
    --orf-filter-e $taxonomy.orf_filter_e
    --orf-filter-s $taxonomy.orf_filter_s
    --lca-mode $taxonomy.lca_mode
    --tax-output-mode $taxonomy.tax_output_mode
    --majority $taxonomy.majority
    --vote-mode $taxonomy.vote_mode
    --tax-lineage $taxonomy.tax_lineage
    --blacklist $taxonomy.blacklist

    ## Search type
    --search-type $database.database_type.search_type

    ## Common options
    @CMD_THREADS@
    --max-seq-len $common.max_seq_len

    ## Expert options
    @CMD_EXPERT@
    --chain-alignments $expert.chain_alignments
    --merge-query $expert.merge_query
    ]]></command>
    <inputs>
        <!-- used only for tests, this makes it possible to download the taxonomy part of the db -->
        <param name="download_tax_db" type="hidden" value=""/>
        <!-- -->
        <param name="query_fasta" type="data" format="fasta,fasta.gz,fastq,fastq.gz" label="Query FASTA/Q file" help=""/>
        <section name="database" title="Taxonomy reference database" expanded="true">
            <conditional name="database_type">
                <param name="type" type="select" label="Database type" help="">
                    <option value="amino_acid_tax" selected="true">Amino acid with taxonomy information</option>
                    <option value="nucleotides_tax">Nucleotides with taxonomy information</option>
                </param>
                <when value="amino_acid_tax">
                    <param name="mmseqs2_db_select" type="select" label="MMseqs2 databases">
                        <options from_data_table="mmseqs2_databases">
                            <filter type="static_value" value="aminoacid" column="type"/>
                            <filter type="static_value" value="yes" column="taxonomy"/>
                            <validator message="No mmseqs2 database is available" type="no_options"/>
                        </options>
                    </param>
                    <expand macro="search_type_aa"/>
                </when>
                <when value="nucleotides_tax">
                    <param name="mmseqs2_db_select" type="select" label="MMseqs2 databases">
                        <options from_data_table="mmseqs2_databases">
                            <filter type="static_value" value="nucleotide" column="type"/>
                            <filter type="static_value" value="yes" column="taxonomy"/>
                            <validator message="No mmseqs2 database is available" type="no_options"/>
                        </options>
                    </param>
                    <expand macro="search_type_nt"/>
                </when>
            </conditional>
        </section>
        <expand macro="dbtype_conditional"/>
        <section name="prefilter" title="Pre-filter">
            <expand macro="prefilter_common_parameters"/>
            <param argument="--spaced-kmer-mode" type="select" label="Spaced k-mer mode" help="">
                <option value="0">Use consecutive positions in k-mers</option>
                <option value="1" selected="true">Use spaced k-mers</option>
            </param>
            <expand macro="search_prefilter_parameters"/>
        </section>
        <section name="align" title="Align">
            <expand macro="align_common_parameters"/>
            <expand macro="search_align_parameters" evalue_default="1" min_seq_id_default="0" cov_default="0" max_rejected_default="5" max_accept_default="30"/>
        </section>
        <section name="profile" title="Profile">
            <expand macro="profile_parameters"/>
        </section>
        <section name="taxonomy" title="Taxonomy">
            <expand macro="taxonomy_misc_parameters"/>
        </section>
        <expand macro="common_section"/>
        <section name="expert" title="Expert">
            <expand macro="expert_common_parameters"/>
            <param argument="--chain-alignments" type="integer" min="0" value="0" label="Chain alignments" help=""/>
            <param argument="--merge-query" type="integer" min="0" value="1" label="Combine ORFs/split sequences to a single entry" help=""/>
        </section>
        <section name="output_options" title="Output options">
            <param name="output_selection" type="select" multiple="true" min="0" label="Additional outputs">
                <option value="report" selected="true">Kraken-style report</option>
                <option value="tophit_aln">Top hit alignments</option>
                <option value="tophit_report">Top hit report</option>
                <validator type="no_options" message="Select at least one additional output or deselect all"/>
            </param>
        </section>
    </inputs>
    <outputs>
        <data name="output_lca" format="tabular" from_work_dir="result_lca.tsv" label="${tool.name} on ${on_string}: LCA results"/>
        <data name="output_report" format="txt" from_work_dir="result_report" label="${tool.name} on ${on_string}: Kraken Report">
            <filter>output_options['output_selection'] and "report" in output_options['output_selection']</filter>
        </data>
        <data name="output_tophit_aln" format="tabular" from_work_dir="result_tophit_aln" label="${tool.name} on ${on_string}: Top Hit Alignments">
            <filter>output_options['output_selection'] and "tophit_aln" in output_options['output_selection']</filter>
        </data>
        <data name="output_tophit_report" format="txt" from_work_dir="result_tophit_report" label="${tool.name} on ${on_string}: Top Hit Report">
            <filter>output_options['output_selection'] and "tophit_report" in output_options['output_selection']</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="download_tax_db" value="true"/>
            <param name="query_fasta" value="light_mystery_reads.fasta" ftype="fasta"/>
            <section name="database">
                <conditional name="database_type">
                    <param name="type" value="amino_acid_tax"/>
                    <param name="mmseqs2_db_select" value="UniProtKB/Swiss-Prot-15.6f452-10022025"/>
                </conditional>
            </section>
            <conditional name="alph_type">
                <param name="dbtype" value="2"/>
            </conditional>
            <section name="output_options">
                <param name="output_selection" value="report"/>
            </section>
            <output name="output_lca" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="8"/>
                </assert_contents>
            </output>
            <output name="output_report" ftype="txt">
                <assert_contents>
                    <has_text text="kingdom"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help format="markdown"><![CDATA[
@HELP_HEADER@

**Usage**

MMseqs easy-taxonomy assigns taxonomy labels to query sequences by searching against
a reference database with taxonomy information and computing the lowest common ancestor
(LCA) of the found homologs.

This is a simplified alternative to the manual taxonomy pipeline (createdb, taxonomy,
createtsv, taxonomyreport). It accepts FASTA/FASTQ files directly and produces
taxonomy results in standard formats.

**Outputs**

- **LCA results** (always produced): Tab-separated file with taxonomy assignments per query
- **Kraken report** (optional): Kraken-style report with taxonomy tree
- **Top hit alignments** (optional): Best alignment per query in BLAST-tab format
- **Top hit report** (optional): Taxonomy report based on top hits

**LCA modes**

- **Single search LCA**: Single search followed by LCA
- **Approximate 2bLCA** (default): Two-step LCA with better sensitivity
- **Top hit**: Use the top hit as taxonomy assignment

@HELP_FOOTER@
    ]]></help>
    <expand macro="citations"/>
</tool>
