<tool id="mmseqs2_easy_search" name="MMseqs2 Easy Search" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>
        sensitive homology search
    </description>
    <macros>
        <import>macro.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command detect_errors="aggressive"><![CDATA[
mmseqs easy-search
    '$query_fasta'
    #if str($target_source.target_source_select) == "history"
        '$target_source.target_fasta'
    #else
        '$target_source.mmseqs2_db_select.fields.path'/database
    #end if
    'search_results'
    'tmp'

    @CMD_DBTYPE@

    ## Pre-filter options
    @CMD_PREFILTER@
    --spaced-kmer-mode $prefilter.spaced_kmer_mode
    @CMD_SEARCH_COMMON@

    ## Align options
    @CMD_ALIGN@
    @CMD_SEARCH_ALIGN@
    --exhaustive-search-filter $align.exhaustive_search_filter

    ## Profile (iterative search)
    --num-iterations $profile.num_iterations

    ## Output format
    @CMD_FORMAT_OUTPUT@

    ## Search type
    --search-type $search_type

    ## Common options
    @CMD_THREADS@
    --max-seq-len $common.max_seq_len

    ## Expert options
    @CMD_EXPERT@
    --chain-alignments $expert.chain_alignments
    --merge-query $expert.merge_query
    --strand $expert.strand
    ]]></command>
    <inputs>
        <param name="query_fasta" type="data" format="fasta,fasta.gz,fastq,fastq.gz" label="Query FASTA/Q file" help=""/>
        <expand macro="target_source_conditional"/>
        <expand macro="dbtype_conditional"/>
        <param argument="--search-type" type="select" label="Search type" help="">
            <option value="0" selected="true">Auto</option>
            <option value="1">Amino acid</option>
            <option value="2">Translated</option>
            <option value="3">Nucleotide</option>
            <option value="4">Translated nucleotide alignment</option>
        </param>
        <section name="prefilter" title="Pre-filter">
            <expand macro="prefilter_common_parameters"/>
            <param argument="--spaced-kmer-mode" type="select" label="Spaced k-mer mode" help="">
                <option value="0">Use consecutive positions in k-mers</option>
                <option value="1" selected="true">Use spaced k-mers</option>
            </param>
            <expand macro="search_prefilter_parameters"/>
        </section>
        <section name="align" title="Align">
            <expand macro="align_common_parameters"/>
            <expand macro="search_align_parameters" evalue_default="1.000E-03" min_seq_id_default="0" cov_default="0" max_rejected_default="2147483647" max_accept_default="2147483647"/>
            <param argument="--exhaustive-search-filter" type="boolean" checked="false" truevalue="1" falsevalue="0" label="Filter result during search" help=""/>
        </section>
        <section name="profile" title="Profile (iterative search)">
            <param argument="--num-iterations" type="integer" min="1" value="1" label="Number of iterative profile search iterations" help="Increase for more sensitive search at the cost of speed"/>
        </section>
        <expand macro="output_format_section"/>
        <expand macro="common_section"/>
        <section name="expert" title="Expert">
            <expand macro="expert_common_parameters"/>
            <param argument="--chain-alignments" type="integer" min="0" value="0" label="Chain alignments" help=""/>
            <param argument="--merge-query" type="integer" min="0" value="1" label="Combine ORFs/split sequences to a single entry" help=""/>
            <param argument="--strand" type="select" label="Strand selection" help="Only works for DNA/DNA search">
                <option value="0">Reverse</option>
                <option value="1" selected="true">Forward</option>
                <option value="2">Both</option>
            </param>
        </section>
    </inputs>
    <outputs>
        <data name="output" format="tabular" from_work_dir="search_results" label="${tool.name} on ${on_string}">
            <change_format>
                <when input="output_format.format_mode" value="1" format="sam"/>
                <when input="output_format.format_mode" value="3" format="html"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: Default protein self-search -->
        <test expect_num_outputs="1">
            <param name="query_fasta" value="small_proteins.fasta" ftype="fasta"/>
            <conditional name="target_source">
                <param name="target_source_select" value="history"/>
                <param name="target_fasta" value="small_proteins.fasta" ftype="fasta"/>
            </conditional>
            <output name="output" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="12"/>
                    <has_text text="sp_prot1"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: Custom output columns -->
        <test expect_num_outputs="1">
            <param name="query_fasta" value="small_proteins.fasta" ftype="fasta"/>
            <conditional name="target_source">
                <param name="target_source_select" value="history"/>
                <param name="target_fasta" value="small_proteins.fasta" ftype="fasta"/>
            </conditional>
            <section name="output_format">
                <param name="format_fields" value="query,target,evalue,pident,alnlen"/>
            </section>
            <output name="output" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="5"/>
                    <has_text text="sp_prot1"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help format="markdown"><![CDATA[
@HELP_HEADER@

**Usage**

MMseqs easy-search performs sensitive sequence searches, similar to BLAST but much faster.
It accepts FASTA/FASTQ files directly and produces alignment results in various formats.

Depending on the input types and `--search-type`, easy-search supports:

- **Protein vs protein** (like BLASTP)
- **Translated nucleotide vs protein** (like BLASTX)
- **Nucleotide vs nucleotide** (like BLASTN, use `--search-type 3`)
- **Translated nucleotide alignment** (like TBLASTX, use `--search-type 2`)

The target can be a FASTA file from history or a pre-built MMseqs2 database from the server.

**Output formats**

- BLAST-TAB (default): Tab-separated alignment table with customizable columns
- SAM: Standard alignment format
- BLAST-TAB with lengths: Includes query and target sequence lengths
- Pretty HTML: Visual alignment display
- BLAST-TAB with headers: Includes column header line

@HELP_FOOTER@
    ]]></help>
    <expand macro="citations"/>
</tool>
