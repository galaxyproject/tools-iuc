<tool id="mmseqs2_easy_proteomecluster" name="MMseqs2 Proteome Clustering" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>
        of proteomes and reference proteome identification
    </description>
    <macros>
        <import>macro.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command detect_errors="aggressive"><![CDATA[
mmseqs easy-proteomecluster
    '$input_fasta'
    'result'
    'tmp'

    @CMD_DBTYPE@

    ## Pre-filter options
    @CMD_PREFILTER@
    --spaced-kmer-mode $prefilter.spaced_kmer_mode
    @CMD_SEARCH_COMMON@

    ## Align options
    @CMD_ALIGN@
    --alignment-mode $align.alignment_mode
    -e $align.evalue
    --min-seq-id $min_seq_id
    -c $cov
    --cov-mode $cov_mode
    --max-rejected $align.max_rejected
    --max-accept $align.max_accept

    ## Clustering options
    @CMD_CLUSTERING@

    ## Proteome clustering options
    --proteome-cluster-type $proteome.proteome_cluster_type
    --proteome-cluster-min-order $proteome.proteome_cluster_min_order
    --proteome-cluster-min-ratio $proteome.proteome_cluster_min_ratio

    ## Misc options
    @CMD_MISC@

    ## Common options
    @CMD_THREADS@
    --max-seq-len $common.max_seq_len

    ## Expert options
    @CMD_EXPERT@
    ]]></command>
    <inputs>
        <param name="input_fasta" type="data" format="fasta,fasta.gz" label="Input FASTA file" help="Sequences should be grouped by proteome (organism) using sequence headers"/>
        <expand macro="dbtype_conditional"/>
        <expand macro="sequence_identity_param" default_value="0.3"/>
        <expand macro="coverage_params" cov_default="0.800" cov_mode_default="0"/>
        <section name="prefilter" title="Pre-filter">
            <expand macro="prefilter_common_parameters"/>
            <param argument="--spaced-kmer-mode" type="select" label="Spaced k-mer mode" help="">
                <option value="0">Use consecutive positions in k-mers</option>
                <option value="1" selected="true">Use spaced k-mers</option>
            </param>
            <expand macro="search_prefilter_parameters"/>
        </section>
        <section name="align" title="Align">
            <expand macro="align_common_parameters"/>
            <param argument="--alignment-mode" type="select" label="Alignment mode" help="">
                <option value="0" selected="true">Automatic</option>
                <option value="1">Only score and end_pos</option>
                <option value="2">Also start_pos and cov</option>
                <option value="3">Also seq.id</option>
                <option value="4">Only ungapped alignment</option>
            </param>
            <expand macro="evalue_param" default_value="1.000E-03"/>
            <param argument="--max-rejected" type="integer" min="0" value="2147483647" label="Maximum rejected alignments before alignment calculation for a query is stopped" help=""/>
            <param argument="--max-accept" type="integer" min="0" value="2147483647" label="Maximum accepted alignments before alignment calculation for a query is stopped" help=""/>
        </section>
        <section name="cluster" title="Clustering">
            <expand macro="clustering_parameters"/>
        </section>
        <section name="proteome" title="Proteome clustering">
            <param argument="--proteome-cluster-type" type="select" label="Proteome cluster type" help="">
                <option value="0" selected="true">Proteome coverage</option>
                <option value="1">Proteome alignment score</option>
            </param>
            <param argument="--proteome-cluster-min-order" type="integer" min="0" value="0" label="Minimum order of complexity for proteome clustering" help=""/>
            <param argument="--proteome-cluster-min-ratio" type="float" min="0" max="1" value="0.900" label="Minimum ratio for proteome inclusion" help=""/>
        </section>
        <section name="misc" title="Misc">
            <expand macro="misc_parameters"/>
        </section>
        <expand macro="common_section"/>
        <section name="expert" title="Expert">
            <expand macro="expert_common_parameters"/>
        </section>
        <expand macro="clustering_output_selection"/>
    </inputs>
    <outputs>
        <expand macro="clustering_outputs"/>
    </outputs>
    <tests>
        <test expect_num_outputs="3">
            <param name="input_fasta" value="small_proteins.fasta" ftype="fasta"/>
            <output name="output_rep_seq" ftype="fasta">
                <assert_contents>
                    <has_text text="sp_prot"/>
                </assert_contents>
            </output>
            <output name="output_all_seq" ftype="fasta">
                <assert_contents>
                    <has_text text="sp_prot"/>
                </assert_contents>
            </output>
            <output name="output_cluster" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="2"/>
                    <has_text text="sp_prot"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help format="markdown"><![CDATA[
@HELP_HEADER@

**Usage**

MMseqs easy-proteomecluster clusters proteomes (sets of sequences from the same organism)
and identifies reference proteomes. It accepts FASTA files directly and produces clustering
results.

Input sequences should be grouped by organism/proteome using the FASTA headers. The tool
identifies clusters of proteomes based on shared homologous sequences and selects
representative proteomes.

**Outputs**

- **Representative sequences**: One FASTA entry per cluster (the representative)
- **FASTA-like per cluster**: All sequences grouped by cluster
- **Adjacency list**: TSV with two columns (representative, member)

@HELP_FOOTER@
    ]]></help>
    <expand macro="citations"/>
</tool>
