<tool id="mmseqs2_easy-cluster" name="mmseqs2_easy-cluster" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="23.0">
    <description>A fast and scalable tool for clustering large protein and nucleotide sequence datasets with high sensitivity</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        mkdir -p ./tmp_dir/ &&

        mmseqs easy-cluster
        "$input_fasta" 
        clusterRes
        "./tmp_dir"
        --threads \${GALAXY_SLOTS:-4} 
        #if $coverage
            -c '$coverage'
        #end if
        #if $cov_mode
            --cov-mode '$cov_mode'
        #end if
        #if $align_mode
            --alignment-mode '$align_mode'
        #end if
        #if $align_output_mode
            --alignment-output-mode '$align_output_mode'
        #end if
        #if $min_seq_id
            --min-seq-id '$min_seq_id'
        #end if
        #if $min_align_len
            --min-aln-len '$min_align_len'
        #end if
        #if $seq_id_mode
            --seq-id-mode '$seq_id_mode'
        #end if
        #if $rescore_mode
            --rescore-mode '$rescore_mode'
        #end if
        #if $dbtype
            --dbtype '$dbtype'
        #end if
        #if $prefilter_options.prefilter.customize_prefilter_options == 'customize'
            -s $prefilter_options.prefilter.sensitivity
            --target-search-mode $prefilter_options.prefilter.target_search_mode
            --split-mode $prefilter_options.prefilter.split_mode
            --mask $prefilter_options.prefilter.mask
        #end if 
        #if $cluster_options.cluster.customize_cluster_options == 'customize'
            --cluster-mode $cluster_options.cluster.cluster_mode
            --similarity-type $cluster_options.cluster.similarity_type
        #end if
        #if $common_options.common.customize_common_options == 'customize'
            --db-load-mode  $cluster_options.cluster.db_load_mode
            -v $cluster_options.cluster.Verbosity_level
            --sort-results $cluster_options.cluster.sort_results
        #end if 
       
    ]]></command>
    <inputs>
        <param name="input_fasta" type="data" format="fasta,fasta.gz,fasta.bz2,fastq,fastq.gz" label="Input FASTA/FASTQ file" help="FASTA/FASTQ file containing sequences to be clustered."/>
        <param name="coverage" type="float" value="0.8" min="0.5" max="1" label="Coverage Threshold" help="Minimum fraction of aligned (covered) residues (default: 0.8)."/>
        <param name="cov_mode" type="select" optional="true" label="Coverage mode" help="default value is 0 (coverage of query and target).">
            <option value="0" selected="True">coverage of query and target</option>
            <option value="1">coverage of target</option>
            <option value="2">coverage of query</option>
            <option value="3">target seq. length has to be at least x% of query length</option>
            <option value="4">query seq. length has to be at least x% of target length</option>
            <option value="5">short seq. needs to be at least x% of the other seq. length</option>
        </param>
        <param name="align_mode" type="select" optional="true" label="Alignment mode" help="How to compute the alignment. The default value is 3 (also seq.id).">
            <option value="0">automatic</option>
            <option value="1">only score and end_pos</option>
            <option value="2">also start_pos and cov</option>
            <option value="3" selected="True">also seq.id</option>
            <option value="4">only ungapped alignment</option>
        </param>
        <param name="align_output_mode" type="select" optional="true" label="Alignment output mode" help="How to compute the alignment. The default value is 0 (automatic).">
            <option value="0" selected="True">automatic</option>
            <option value="1">only score and end_pos</option>
            <option value="2">also start_pos and cov</option>
            <option value="3">also seq.id</option>
            <option value="4">only ungapped alignment</option>
            <option value="5">score only (output) cluster format</option>
        </param>
        <param name="min_seq_id" type="float" value="0.5" min="0.0" max="1.0" label="Minimum Sequence Identity" help="Set the minimum sequence identity for clustering (0-1)."/>
        <param name="min_align_len" type="float" value="0" min="0.0" label="Minimum alignment length" help="Set the minimum alignment length (range 0-INT_MAX)."/>
        <param name="seq_id_mode" type="select" optional="true"  label="Sequence id mode" help="select an id mode">
            <option value="0" selected="True">alignment length</option>
            <option value="1">shorter sequence</option>
            <option value="2">longer sequence</option>
        </param>
        <param name="dbtype" type="select" optional="true" label="Database type" help="select a database type. The default value is 0 (auto).">
            <option value="0" selected="True">auto</option>
            <option value="1">amino acid</option>
            <option value="2">nucleotides</option>
        </param>
        <param name="rescore_mode" type="select" optional="true" label="Rescore diagonals with" help="Select a method to rescore diagonals. Default: 0 (Hamming distance).">
            <option value="0" selected="True">Hamming distance</option>
            <option value="1">local alignment (score only)</option>
            <option value="2">local alignment</option>
            <option value="3">global alignment</option>
            <option value="4">longest alignment fulfilling window quality criterion</option>
        </param>
         <section name="prefilter_options" title="Prefilter" expanded="true">
            <conditional name="prefilter">
                <param argument="customize_prefilter_options" type="select" label="Prefilter options">
                    <option value="default_options">No, Use param defaults</option>
                    <option value="customize">Yes, See full parameter list</option>
                </param>
                <when value="customize">
                    <param name="sensitivity" type="float" min="1.0" max="7.5" value="4.0" label="Sensitivity" help="Set clustering sensitivity. Lower values (1.0) are faster but less sensitive, while higher values (7.5) are more sensitive but slower. Default is 4.0."/>
                    <param name="target_search_mode" type="select" value="0" label="Target Search Mode" help="Select the target search mode. Default is regular k-mer search (0).">
                        <option value="0" selected="true">Regular k-mer search</option>
                        <option value="1">Similar k-mer search</option>
                    </param>
                    <param name="split_mode" type="select" optional="true" value="2" label="Split Mode" help="Choose how to split the database for processing. Default is auto mode (2).">
                        <option value="0">Split target database</option>
                        <option value="1">Split query database</option>
                        <option value="2" selected="true">Auto (depending on main memory)</option>
                    </param>
                    <param name="mask" type="select" optional="true" value="1" label="Mask sequences in prefilter stage" help="Choose whether to apply low complexity masking using tantan. Default is with masking (1).">
                        <option value="0">Without low complexity masking</option>
                        <option value="1" selected="true">With low complexity masking</option>
                    </param>
                    </when>
                <when value="default_options">
                    <!-- Define actions or defaults for the default option if necessary -->
                </when>
            </conditional>
        </section>
        <section name="cluster_options" title="Cluster" expanded="true">
            <conditional name="cluster">
                <param argument="customize_cluster_options" type="select" label="Prefilter options">
                    <option value="default_options">No, Use param defaults</option>
                    <option value="customize">Yes, See full parameter list</option>
                </param>
                <when value="customize">
                    <param name="cluster_mode" type="select" optional="true" value="0" label="Clustering Mode" help="Select the clustering strategy to use. Default is 0 (Set-Cover (greedy)).">
                        <option value="0" selected="true">Set-Cover (Greedy)</option>
                        <option value="1">Connected Component (BLASTclust)</option>
                        <option value="2">Greedy clustering by sequence length (CDHIT)</option>
                        <option value="3">Greedy clustering by sequence length (CDHIT alternative)</option>
                    </param>                    
                    <param name="similarity_type" type="select" optional="true" value="2" label="Similarity Type" help="Select the type of score used for clustering. Default is 2 (sequence identity).">
                        <option value="1">Alignment Score</option>
                        <option value="2" selected="true">Sequence Identity</option>
                    </param>
                    </when>
                <when value="default_options">
                    <!-- Define actions or defaults for the default option if necessary -->
                </when>
            </conditional>
        </section>
        <section name="common_options" title="Common_expert_options" expanded="true">
            <conditional name="common">
                <param argument="customize_common_options" type="select" label="Prefilter options">
                    <option value="default_options">No, Use param defaults</option>
                    <option value="customize">Yes, See full parameter list</option>
                </param>
                <when value="customize">
                    <param name="db_load_mode" type="select" optional="true" value="0" label="Database Preload Mode" help="Select the database preload mode. Default is 0 (auto).">
                        <option value="0" selected="true">auto</option>
                        <option value="1">fread (File Read)</option>
                        <option value="2">mmap (Memory Mapping)</option>
                        <option value="3">mmap+touch (Memory Mapping with Touch)</option>
                    </param>
                    <param name="verbosity_level" type="select" optional="true" value="3" label="Verbosity Level" help="Select the level of verbosity for logging output. Default is 3 (info (full logging output)).">
                        <option value="0">quiet (No output)</option>
                        <option value="1">errors only</option>
                        <option value="2">warnings and errors</option>
                        <option value="3" selected="true">info (full logging output)</option>
                    </param>
                    <param name="sort_results" type="select" optional="true" value="0" label="Sort Results" help="Select how the results should be sorted. Default is 0 (no sorting).">
                        <option value="0" selected="true">no sorting</option>
                        <option value="1">sort by E-value (for alignment) or sequence identity (for Hamming)</option>
                    </param>
                    </when>
                <when value="default_options">
                    <!-- Define actions or defaults for the default option if necessary -->
                </when>
            </conditional>
        </section>
    </inputs>
    <outputs>
        <data name="clusterRes_all_seqs" format="fasta" label="All Clustered Sequences (FASTA)" from_work_dir="clusterRes_all_seqs.fasta"/>
        <data name="clusterRes_cluster" format="tabular" label="Cluster Assignment (TSV)" from_work_dir="clusterRes_cluster.tsv"/>            
        <data name="clusterRes_rep_seq" format="fasta" label="Representative Sequences (FASTA)" from_work_dir="clusterRes_rep_seq.fasta"/>
    </outputs>
    <tests>
        <test expect_num_outputs="3">
            <param name="input_fasta" value="QUERY.fasta"/>
            <param name="min_seq_id" value="0.5"/>
            <param name="coverage" value="0.8"/>
            <param name="cov_mode" value="1"/>
            <output name="clusterRes_all_seqs" file="clusterRes_all_seqs.fasta" ftype="fasta">
                <assert_contents>
                    <has_text_matching expression=">A7TBS3*"/>
                    <has_n_lines n="1480" delta="10"/>
                    <has_size value="309288" delta="100000"/>
                </assert_contents>
            </output>
            <output name="clusterRes_cluster" file="clusterRes_cluster.tsv" ftype="tabular" compare="sim_size"/>
            <output name="clusterRes_rep_seq" file="clusterRes_rep_seq.fasta" ftype="fasta">
                <assert_contents>
                    <has_text_matching expression=">tr*"/>
                    <has_n_lines n="960" delta="5"/>
                    <has_size value="290905" delta="100000"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="3">
            <param name="input_fasta" value="DB_test.fasta"/>
            <param name="min_seq_id" value="0.7"/>
            <param name="coverage" value="0.7"/>
            <param name="align_output_mode" value="1"/>
            <output name="clusterRes_all_seqs" file="clustertest_all_seqs.fasta" ftype="fasta">
                <assert_contents>
                    <has_text_matching expression=">W0FSK4*"/>
                    <has_n_lines n="2950" delta="10"/>
                    <has_size value="612399" delta="100000"/>
                </assert_contents>
            </output>
            <output name="clusterRes_cluster" file="clustertest_cluster.tsv" ftype="tabular" compare="sim_size"/>
            <output name="clusterRes_rep_seq" file="clustertest_rep_seq.fasta" ftype="fasta" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
What it does
============
MMseqs2 `easy-cluster` is a fast and sensitive sequence clustering tool. It groups highly similar sequences together, reducing redundancy in large datasets.

How it works
============
This tool clusters sequences using alignment-based or sequence-identity-based methods.

- Input: A FASTA/FASTQ file containing nucleotide or protein sequences.
- Processing: Sequences are clustered based on sequence similarity.
- Output: 
  - Representative sequences for each cluster.
  - All sequences assigned to clusters.
  - A clustering report in `.tsv` format.

Required Inputs
===============
- A FASTA or FASTQ file containing the sequences to be clustered.

Generated Outputs
=================
The tool generates three key output files:
1. Cluster Representatives (`_rep_seq.fasta`) - A FASTA file containing one representative sequence per cluster.
2. All Sequences (`_all_seqs.fasta`) - A FASTA file listing sequences grouped by cluster.
3. Cluster Report (`_cluster.tsv`) - A TSV file showing sequence-cluster assignments.

Additional Resources
====================
For a more comprehensive understanding of MMseqs2 and detailed usage instructions, visit:
- MMseqs2 GitHub: [https://github.com/soedinglab/MMseqs2]
    ]]></help>
    <expand macro="citations"/>
</tool>
