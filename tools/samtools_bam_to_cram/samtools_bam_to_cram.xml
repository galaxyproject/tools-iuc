<tool id="samtools_bam_to_cram" name="samtools BAM to CRAM" version="1.2.a">
    <description>convert BAM alignments to CRAM format</description>

    <requirements>
        <requirement type="package" version="1.2">samtools</requirement>
    </requirements>
    
    <stdio>
        <exit_code range="1:" />
        <exit_code range=":-1" />
    </stdio>

    <version_command><![CDATA[ samtools 2>&1 | grep Version ]]></version_command>

    <command>
    <![CDATA[
        samtools view
            -C
            -T ${reference_source.input_reference}
            -o $output_alignment
            $input_alignment
            
            ## -L FILE  only include reads overlapping this BED FILE [null]
            ## -> todo: check if unmapped reads are also selected when bed fil is selected
            ## [region]
    ]]>
    </command>

    <inputs>
        <param name="input_alignment" type="data" format="bam,sam" label="BAM (or SAM) alignment file"/>
        <conditional name="reference_source">
            <param name="reference_source_selector" type="select" label="Load reference genome from">
                <option value="cached">Local cache</option>
                <option value="history">History</option>
            </param>
            <when value="cached">
                <param name="input_reference" type="select" format="fasta" label="Genome reference FASTA file">
                    <options from_data_table="all_fasta">
                        <filter type="data_meta" ref="input_alignment" key="dbkey" column="1" />
                    </options>
                    <validator type="no_options" message="A built-in reference genome is not available for the build associated with the selected input file"/>
                </param>
            </when>
            <when value="history">
                <param name="input_reference" type="data" format="fasta" label="Genome reference FASTA file"/>
            </when>
        </conditional>
    </inputs>

    <outputs>
        <data format="cram" name="output_alignment" label="$tool.name on ${on_string}"></data>
    </outputs>

    <tests>
        <test>
            <param name="input_alignment" value="test.bam" ftype="bam" />
            <param name="reference_source_selector" value="history" />
            <param name="input_reference" value="test.fa" />

            <output name="output_alignment" file="test.cram"  compare="sim_size" delta="250" /><!-- Some headers may change, depending on file paths -->
        </test>
        <test>
            <param name="input_alignment" value="test.sam" ftype="sam" />
            <param name="reference_source_selector" value="history" />
            <param name="input_reference" value="test.fa" />

            <output name="output_alignment" file="test.cram"  compare="sim_size" delta="250" /><!-- Some headers may change, depending on file paths -->
        </test>
    </tests>

    <help>
**What this tool does**

Converts alignments from the BAM format to the CRAM format. The CRAM format does additional compression relative to the reference genome which makes the compression in terms of file size more effictient.
    </help>

    <citations>
    </citations>
</tool>
