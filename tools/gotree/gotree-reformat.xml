<tool id="gotree_reformat" name="gotree reformat" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="23.0">
    <description>Convert phylogenetic trees between Nexus/NHX, Newick and phyloxml formats.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    
    <command detect_errors="exit_code"><![CDATA[
      #set format=$input_tree.file_ext
      case "$format" in 
          newick) TREEFORMAT="newick" ;;
          nex) TREEFORMAT="nexus" ;;
          nexus) TREEFORMAT="nexus" ;;
          phyloxml) TREEFORMAT="phyloxml" ;;
          json) TREEFORMAT="nextstrain" ;;
          *) echo "Unknown format: \$TREEFORMAT" && exit 1 ;;
      esac &&

      gotree reformat $output_format
      --input $input_tree
      --input-format \$TREEFORMAT
      --output ./output.tree
      --threads \${GALAXY_SLOTS:-1} &&

      mv ./output.tree '$output_tree'

    ]]></command>

    <inputs>
        <param name="input_tree"
          type="data"
          format="newick,nex,phyloxml,json"
          label="Input tree" 
          help="Accepted formats: newick, nexus, phyloxml, nextstrain (json)" />

        <param name="output_format"
          type="select"
          label="Select output tree format">
          <option value="newick">Newick</option>
          <option value="nexus">Nexus</option>
          <option value="phyloxml">Phyloxml</option>
        </param>
    </inputs>

    <outputs>
      <data name="output_tree" format="txt" label="${tool.name} on ${on_string}">
          <change_format>
              <when input="output_format" value="newick" format="newick" />
              <when input="output_format" value="nexus" format="nex" />
              <when input="output_format" value="phyloxml" format="phyloxml" />            
          </change_format>
      </data> 
    </outputs>

    <tests>
    <!-- Test 1: Convert from Newick to Nexus -->
    <test expect_num_outputs="1">
        <param name="input_tree" value="test.newick" ftype="newick"/>
        <param name="output_format" value="nexus" />
        <output name="output_tree" file="newick-to.nex">
          <assert_contents> <has_text text="#NEXUS"/> </assert_contents>
        </output>
    </test>

    <!-- Test 2: Convert from Nexus to PhyloXML -->
    <test expect_num_outputs="1">
        <param name="input_tree" value="test.nex" ftype="nex"/>
        <param name="output_format" value="phyloxml" />
        <output name="output_tree" file="newick-to.xml">
          <assert_contents> <has_text text="phylogeny rooted="/> </assert_contents>
        </output>
    </test>

    <!-- Test 3: Convert from PhyloXML to Newick -->
    <test expect_num_outputs="1">
        <param name="input_tree" value="test.xml" ftype="phyloxml"/>
        <param name="output_format" value="newick" />
        <output name="output_tree" file="phylo-to.newick" >
          <assert_contents> <has_text text="(((hCoV-19"/> </assert_contents>
        </output>
    </test>
</tests>

    <help><![CDATA[
    **GoTree Reformat**
    Reformats an input tree file into different formats.

    Input formats: Nexus, Newick, Phyloxml or Nextstrain
    Output formats: Newick, Nexus or Phyloxml
    ]]></help>

<expand macro="citations" />
</tool>