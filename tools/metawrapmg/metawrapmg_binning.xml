<tool id="metawrapmg_binning" name="MetaWRAP" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@" license="MIT">
    <description>metagenome binning pipeline.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
            ## set memory usage
            if [ -n "\$GALAXY_MEMORY_MB" ] ; then
                GALAXY_MEMORY_GB=\$((GALAXY_MEMORY_MB / 1024)) ;
            fi ;

            ##################
            ## SET UP FILES ##
            ##################

            ## should always be FASTA
            #set mg_fn = 'metagenome.' + str($metagenome.ext)
            ln -s '$metagenome' $mg_fn
            &&

            ## Only FASTQ. Separate files for each sample. Metawrap checks for
            ## files named _1.fastq and _2.fastq.
            #set input1_fn = 'reads_1.fastq'
            ln -s '$input_1' $input1_fn
            &&

            #set input2_fn = 'reads_2.fastq'
            ln -s '$input_2' $input2_fn
            &&

            #####################
            ## INITIAL BINNING ##
            #####################

            metawrap binning 
            --metabat2 --maxbin2 --concoct 
            -a '$mg_fn'
            -m \${GALAXY_MEMORY_GB:-16}
            -o INITIAL_BINNING
            -t \${GALAXY_SLOTS:-4}
            '$input1_fn'
            '$input2_fn'
            &&

            ## Check which binning programs produced bins            
            bin_dirs=(INITIAL_BINNING/concoct_bins INITIAL_BINNING/maxbin2_bins INITIAL_BINNING/metabat2_bins) &&
            switches=('-A' '-B' '-C') &&

            i=0 &&
            bin_string="" &&

            for dir in "\${bin_dirs[@]}" ; do
                if find "\${dir}" -mindepth 1 -maxdepth 1 | read; then
                    bin_string="\${bin_string} \${switches[\$i]} \${dir}" ;
                    i+=1 ;
                fi
            done &&


            ####################
            ## BIN REFINEMENT ##
            ####################

            ## This will require a data manager for the checkm database.

            ## Note that checkm expects the database under
            ## `/srv/whitlam/bio/db/checkm_data/1.0.0`. This can be changed
            ## using the CHECKM_DATA_PATH environment variable at runtime, but
            ## only after v1.1.6. The metawrap-mg conda package has CheckM
            ## v1.0.12.
            
            ## To change the database location in the older version, checkm
            ## wants *write* access to the config file
            ## at /usr/local/lib/python2.7/site-packages/checkm/DATA_CONFIG
            
            ## One solution is to bind a
            ## directory to /srv/whitlam/bio/db/checkm_data/1.0.0, 
            ## e.g. as a singularity_run_extra_arguments in
            ## job_config_file.

            ## See https://github.com/Ecogenomics/CheckM/pull/326

            metawrap bin_refinement
            -t \${GALAXY_SLOTS:-4}
            -m \${GALAXY_MEMORY_GB:-16}
            -c $binning.c
            -x $binning.x
            -o BIN_REFINEMENT
            ## Only run bin_refinement on bins with contigs
            \${bin_string}
            &&

            ####################
            ## COLLECT OUTPUT ##
            ####################

            find BIN_REFINEMENT
            -maxdepth 1
            -mindepth 1
            -type d
            -name "metawrap*bins" 
            -exec ln -s \{\} metawrap_results ';'
            &&

            exit 0 ;

    ]]></command>
    <inputs>
        <!-- metagenome assembly -->
        <param name="metagenome" format="fasta" type="data" label="Metagenome" help="Metagenome co-assembly for binning" />
        <!-- fastq files (could be a repeat or a collection) -->
        <param name="input_1" format="fastq" type="data" label="Read 1" help="Original reads that were used for the assembly" />
        <param name="input_2" format="fastq" type="data" label="Read 2" help="Original reads that were used for the assembly" />
        <section name="binning" title="Binning parameters" expanded="false">
            <param argument='-c' type="integer" value="70" min="50" max="100" label="Percent completion" help="Minimum % completion of bins (default=70)" />
            <param argument='-x' type="integer" value="10" min="0" max="100" label="Percent contamination" help="Maximum % contamination of bins that is acceptable (default=10)" />
        </section>

    </inputs>
    <outputs>
        <!-- will need to catch the different bins with collections > discover_datasets -->
        <collection name="metawrap_bins" type="list" label="MetaWRAP bins">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.fa" format="fasta" directory="metawrap_results" visible="false" />
        </collection>
        <collection name="metawrap_figures" type="list" label="Summary figures">
            <discover_datasets pattern="__designation_and_ext__" directory="BIN_REFINEMENT/figures" visible="false" />
        </collection>
    </outputs>
    <tests>
        <!-- basic function -->
        <test>
            <param name="metagenome" value="subset.fasta.gz"/>
            <param name="input_1" value="ALL_READS_1.subset.fastq.gz"/>
            <param name="input_2" value="ALL_READS_2.subset.fastq.gz"/>
            <output_collection name="metawrap_bins" type="list">
                <element name="bin.1" file="bin.1.fa" ftype="fasta"/>
            </output_collection>
            <output_collection name="metawrap_figures" type="list">
                <element name="binning_results" file="binning_results.png" ftype="png"/>
            </output_collection>
        </test>
    </tests>
        <help><![CDATA[
            FIXME
        ]]></help>
    <expand macro="citations"/>
</tool>
