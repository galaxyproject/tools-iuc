<tool id="isescan" name="ISEScan" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description> Insertion Sequence Elements detection in prokaryotic genomes </description>
    <macros>
        <import>macro.xml</import>
    </macros>
    <expand macro='xrefs'/>
    <expand macro="requirements" />
    <expand macro="version_command" />
    <command detect_errors="exit_code"><![CDATA[
        isescan.py
        --seqfile '$input_file'
        --output 'results'
        $remove_short_is
        --nthread \${GALAXY_SLOTS:-7}
        | tee '$logfile' &&

        mv 'results/**/*.sum' $summary
        #if '$output_format' == 'raw'
            mv 'results/**/*.fna.raw' $is_results &&
        #else if '$output_format' == 'csv'
            mv 'results/**/*.fna.csv' $is_results &&
        #else if '$output_format' == 'tsv'
            mv 'results/**/*.fna.tsv' $is_results &&
        #end if
        mv 'results/**/*.fna.gff' '$gff_file' &&
        mv 'results/**/*.fna.is.fna' '$is_fasta' &&
        mv 'results/**/*.fna.orf.faa' '$tpase_amino' &&
        mv 'results/**/*.fna.orf.fna' '$tpase_fasta' &&
        mv 'results/**/*.log' '$logfile'


    ]]>
    </command>
    <inputs>
        <param name="input_file" type="data" format="fasta,fasta.gz" label="Genome fasta input" help="Fasta sequence to analyse for IS"/>
        <param name="remove_short_is" argument="--removeShortIS" type="boolean" truevalue="--removeShortIS" falsevalue=""
               label="Remove incomplete IS elements"
               help="Remove partial IS elements which include IS element with length &gt; 400 or single copy IS element without perfect TIR"/>
        <param name="output_format" type="select" label="Output format type" help="Choose an output file format">
            <option value="raw"> Raw format (txt) </option>
            <option value="csv"> Coma separate file (CSV) </option>
            <option value="tsv" selected="true"> Tabular separate file (TSV) </option>
        </param>
        <param name="log_activate" type="boolean" truevalue="True" falsevalue="False" checked="True" label="Keep the log file"/>
    </inputs>
    <outputs>
        <data name="summary" format="txt" label="${tool.name} on ${on_string}: Summary of detected IS"/>
        <data name="is_results" format="tabular" from_work_dir="output_dir" label="${tool.name} on ${on_string}: IS detected">
          <change_format>
              <when input="output_format" value="raw" format="txt"/>
              <when input="output_format" value="csv" format="csv"/>
              <when input="output_format" value="tsv" format="tabular"/>
          </change_format>
        </data>
        <data name="gff_file" format="gff3" label="${tool.name} on ${on_string}: IS annotation"/>
        <data name="is_fasta" format="fasta" label="${tool.name} on ${on_string}: IS nucleic sequence"/>
        <data name="tpase_fasta" format="fasta" label="${tool.name} on ${on_string}: Transposase nucleic acid sequence"/>
        <data name="tpase_amino" format="fasta" label="${tool.name} on ${on_string}: Transposase amino acid sequence"/>
        <data name="logfile" format="txt" label="${tool.name} on ${on_string}: Log file">
            <filter> log_activate == True </filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="7"> <!-- TEST_1 default parameters -->
            <param name="input_file" value="NC_012624.fna" />
            <output name="summary" value="TEST_1/test_1.fna.sum"/>
            <output name="is_results" value="TEST_1/test_1.fna.tsv"/>
            <output name="gff_file" value="TEST_1/test_1.fna.gff"/>
            <output name="is_fasta" value="TEST_1/test_1.fna.is.fna"/>
            <output name="tpase_fasta" value="TEST_1/test_1.fna.orf.fna"/>
            <output name="tpase_amino" value="TEST_1/test_1.fna.orf.faa"/>
            <output name="logfile" value="TEST_1/test_1.log" lines_diff="60"/>
        </test>
        <test expect_num_outputs="7"> <!-- TEST_2 with remove_short_is and raw output-->
            <param name="input_file" value="NC_012624.fna"/>
            <param name="remove_short_is" value="true"/>
            <param name="output_format" value="raw"/>
            <output name="summary" value="TEST_2/test_2.fna.sum"/>
            <output name="is_results" value="TEST_2/test_2.fna.raw"/>
            <output name="gff_file" value="TEST_2/test_2.fna.gff"/>
            <output name="is_fasta" value="TEST_2/test_2.fna.is.fna"/>
            <output name="tpase_fasta" value="TEST_2/test_2.fna.orf.fna"/>
            <output name="tpase_amino" value="TEST_2/test_2.fna.orf.faa"/>
            <output name="logfile" value="TEST_2/test_2.log" lines_diff="60"/>
        </test>
        <test expect_num_outputs="6"> <!-- TEST_3 without logfile and with csv output-->
            <param name="input_file" value="NC_012624.fna"/>
            <param name="remove_short_is" value="false"/>
            <param name="output_format" value="csv"/>
            <param name="log_activate" value="False"/>
            <output name="summary" value="TEST_3/test_3.fna.sum"/>
            <output name="is_results" value="TEST_3/test_3.fna.csv"/>
            <output name="gff_file" value="TEST_3/test_3.fna.gff"/>
            <output name="is_fasta" value="TEST_3/test_3.fna.is.fna"/>
            <output name="tpase_fasta" value="TEST_3/test_3.fna.orf.fna"/>
            <output name="tpase_amino" value="TEST_3/test_3.fna.orf.faa"/>
        </test>
    </tests>
    <help><![CDATA[
      **What it does**
      ISEScan is a python pipeline to identify Insertion Sequence elements (both complete and incomplete IS elements) in genome.
      If you want isescan to report only complete IS elements, you need to set command removeShortIS.

      **Input data**
      ISEScan accept fasta file format as input

      **Parameters**
      You can remove the short partial IS elements which include IS element with length < 400 or single copy IS element without perfect TIR/>
      You can chose an output format for the list of detected IS between txt, csv, tsv formats

        ]]>
    </help>
    <expand macro="citations"/>
</tool>
