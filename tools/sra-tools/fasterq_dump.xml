<tool id="fasterq_dump" name="Faster Download and Extract Reads in FASTQ" version="@VERSION@.4">
    <description>format from NCBI SRA</description>
    <macros>
        <import>sra_macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <version_command>fasterq-dump --version</version_command>
    <command detect_errors="exit_code"><![CDATA[

    fasterq-dump '${input.input}'
    $adv.split
    #if str( $adv.minlen ) != "":
        --min-read-len "$adv.minlen"
    #end if
    $adv.skip_technical
    &&
    mkdir -p output;
    count=`ls *.fastq | wc -l` ;
    echo "There are \$count fastq";
    data=(\$(ls *.fastq));
    if [ "\$count" -eq 1 ]; then
        mv '${input.input}'.fastq output/'${input.input}'_single.fastqsanger;
    elif [ "$adv.split" = "--split-3" ]; then
        if [ -e '${input.input}'.fastq ]; then
            mv '${input.input}'.fastq output/'${input.input}'_single.fastqsanger;
        fi;
        mv '${input.input}'_1.fastq output/'${input.input}'_forward.fastqsanger;
        mv '${input.input}'_2.fastq output/'${input.input}'_reverse.fastqsanger;
    elif [ "\$count" -eq 2 ]; then
        mv "\${data[0]}" output/\$(basename "\${data[0]}" .fastq)_forward.fastqsanger;
        mv "\${data[1]}" output/\$(basename "\${data[1]}" .fastq)_reverse.fastqsanger;
    else
        for file in \${data[*]}; do
            mv "\$file" output/"\$file"sanger;
        done;
    fi;
    #if str($outputformat) != "fastqsanger":
    for f in \$(ls output/*.fastqsanger); do
        #if str($outputformat) == "fastqsanger.gz":
            gzip \$f;
        #elif str($outputformat) == "fastqsanger.bz2":   
            bzip2 \$f;
        #end if
    done
    #end if
    ]]>
    </command>
    <inputs>
        <conditional name="input">
            <param name="input_select" type="select" label="select input type">
                <option value="accession_number">SRR accession</option>
                <option value="file">SRA archive in current history</option>
            </param>
            <when value="accession_number">
                <param name="input" type="text" label="Accession" help="Must start with SRR, DRR or ERR, e.g. SRR925743, ERR343809">
                    <expand macro="sanitize_query" />
                    <validator type="empty_field" message="An accession is required"/>
                </param>
            </when>
            <when value="file">
                <param format="sra" name="input" type="data" label="sra archive"/>
            </when>
        </conditional>
        <param name="outputformat" type="select" display="radio" label="Select output format" help="Compression will greatly reduce the amount of space occupied by downloaded data. Downstream applications such as a short-read mappers will accept compressed data as input. Consider this example: an uncoimpressed 400 Mb fastq datasets compresses to 100 Mb or 80 Mb by gzip or bzip2, respectively.">
            <option value="fastqsanger.gz">gzip compressed fastq</option>
            <option value="fastqsanger">Uncompressed fastq</option>
            <option value="fastqsanger.bz2">bzip2 compressed fastq</option>
        </param>
        <section name="adv" title="Advanced Options" expanded="False">
            <param name="minlen" type="integer" label="Minimum read length" optional="true" help="Filter by sequence length. Will dump only reads longer or equal to this value." argument="--min-read-len"/>
            <param name="split" type="select" display="radio" label="Select how to split the spots" help="This option will only be used when there are multiple reads per spot (for example paired-end).">
                <option value="--split-3">--split-3: write reads into different files and single reads in special file</option>
                <option value="--split-spot">--split-spot: split spots into reads (only one output file)</option>
                <option value="--split-files">--split-files: write reads into different files (forward and reverse may not match if one read is empty)</option>
                <option value="--concatenate-reads">--concatenate-reads: writes whole spots into one file</option>
            </param>
            <param name="skip_technical" type="boolean" truevalue="--skip-technical" falsevalue="--include-technical" checked="False" label="Dump only biological reads" help="Will not be used if --split-3 is selected." argument="--skip-technical/--include-technical"/>
        </section>
    </inputs>
    <outputs>
        <data format="fastqsanger" name="output" label="fasterq-dump">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.fastqsanger" directory="output" visible="true" format="fastqsanger"/>
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.fastqsanger\.bz2" directory="output" visible="true" format="fastqsanger.bz2"/>
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.fastqsanger\.gz" directory="output" visible="true" format="fastqsanger.gz"/>
        </data>
    </outputs>
    <help><![CDATA[
**What it does?**

This tool extracts data (in fastq_ format) from the Short Read Archive (SRA) at the National Center for Biotechnology Information (NCBI). It is based on the fasterq-dump_ utility of the SRA Toolkit.

**How to use it?**

There are two ways in which you can download data:

 1. Data for single accession
 2. Extract data from already uploaded SRA dataset

.. _fastq: https://en.wikipedia.org/wiki/FASTQ_format
.. _fasterq-dump: https://github.com/ncbi/sra-tools/wiki/HowTo:-fasterq-dump

]]>
    </help>
    <expand macro="citation"/>
  </tool>
