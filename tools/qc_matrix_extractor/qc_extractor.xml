<tool id="multiqc_qc_matrix_extractor" name="QC Matrix Extractor" version="@TOOL_VERSION@@VERSION_SUFFIX@" profile="21.05">
  <description>Generate QC matrix and pass/fail decisions from MultiQC summary</description>

  <macros>
    <import>macros.xml</import>
  </macros>

  <expand macro="requirements"/>
  <version_command>echo @TOOL_VERSION@</version_command>

  <command detect_errors="exit_code"><![CDATA[
    python '${__tool_directory__}/qc_matrix_extractor.py'
      --input '$input_file'
      --attributes '$attributes'
      --thresholds "{\"Total_reads\": ${total_reads}, \"Coverage_gte_10x_pct\": ${Coverage_gte_10x_pct}, \"Contam_pct\": ${contam_max}}"
      --round '${round}'
      $derive_reads      
      --outdir .
  ]]></command>

  <inputs>
    <param name="input_file" type="data" format="tabular" label="Input summary file (.tabular)" />

    <param name="attributes" type="select" multiple="true" optional="true"
           label="QC metrics to include"
           help="Select which metrics to include in the output. Leave empty to include all.">
        <option value="Sample">Sample</option>
        <option value="Total_reads">Total reads</option>
        <option value="Mapped_reads">Mapped reads</option>
        <option value="Mapping_pct">Mapping %</option>
        <option value="Median_depth">Median depth</option>
        <option value="Coverage_gte_10x_pct">Coverage ≥10x %</option>
        <option value="GC_pct">GC %</option>
        <option value="Kraken_top1_pct">Kraken top1 %</option>
        <option value="Kraken_unclassified_pct">Kraken unclassified %</option>
        <option value="Contam_pct">Contamination %</option>
        <option value="QC_status">QC status</option>
        <option value="Total_reads_pass">Total reads pass</option>
        <option value="Coverage_gte_10x_pct_pass">Coverage at ≥10x pass</option>
        <option value="Contam_pct_pass">Contamination pass</option>
        <option value="MTB_reads">MTB reads</option>
        <option value="Unclassified_reads">Unclassified reads</option>
    </param>

    <param name="total_reads" type="float" value="1000000" label="Minimum total reads" />
    <param name="Coverage_gte_10x_pct" type="float" value="90" label="Minimum coverage pct at ≥10x depth" />
    <param name="contam_max" type="float" value="5" label="Maximum contamination %" />
    <param name="round" type="integer" value="2" label="Rounding precision" />
    <param name="derive_reads" type="boolean"
           truevalue="--derive_reads" falsevalue=""
           label="Derive MTB/unclassified reads" />
  </inputs>

  <outputs>
    <data name="qc_matrix_tsv" format="tsv" label="QC Matrix (TSV)" from_work_dir="QC_matrix_multiqc.tsv" />
    <data name="qc_matrix_csv" format="csv" label="QC Matrix (CSV)" from_work_dir="QC_matrix_multiqc.csv" />
    <data name="log" format="txt" label="QC Tool Log" from_work_dir="qc_tool.log" />
  </outputs>

  <tests>
    <test expect_num_outputs="2">
      <param name="input_file" value="qc_matrix.tabular" ftype="tabular"/>
      <param name="attributes" value="Sample,Total_reads,Mapped_reads,Mapping_pct,Median_depth,Coverage_gte_10x_pct,GC_pct,Kraken_top1_pct,Kraken_unclassified_pct,Contam_pct,QC_status,Total_reads_pass,Coverage_gte_10x_pct_pass,Contam_pct_pass,MTB_reads,Unclassified_reads" />
      <param name="total_reads" value="1000000" />
      <param name="Coverage_gte_10x_pct" value="90" />
      <param name="contam_max" value="5" />
      <param name="round" value="2" />
      <param name="derive_reads" value="true" />
      <output name="qc_matrix_tsv" file="QC_matrix_multiqc.tsv"/>
      <output name="qc_matrix_csv" file="QC_matrix_multiqc.csv"/>
    </test>
  </tests>

  <help><![CDATA[
  **What it does**
  
  This tool extracts sequencing quality control (QC) metrics from a MultiQC tabular summary (.tabular) file and generates a consolidated QC matrix containing only the metrics of interest. 
  It summarizes key metrics including Total reads, Mapped reads, Coverage percentage, and Contamination. 
  Each sample is automatically evaluated against user-defined QC thresholds (provided as a JSON string) to assign a QC Pass/Fail status.

  **Input**
  - A MultiQC-generated .tabular file containing per-sample QC metrics
  - User-defined thresholds for Total reads, Coverage >=10x percentage, Maximum contamination percentage
  - You can specify which QC metrics to include in the output using the --attributes option (comma-separated list). If left empty, all available metrics will be included automatically

  **Available metrics / attributes**
  - Sample - unique identifier for each sample
  - Total_reads - total number of sequencing reads
  - Mapped_reads - reads mapped to the reference genome
  - Median_depth - median sequencing coverage across the genome
  - Coverage_gte_10x_pct - percentage of the genome covered at >=10x depth
  - GC_pct - GC content percentage of reads
  - Kraken_top1_pct - percentage of reads assigned to the top taxonomic hit by Kraken
  - Kraken_unclassified_pct - percentage of reads unclassified by Kraken
  - Contam_pct - estimated contamination percentage
  - QC_status - Pass/Fail status of the sample based on thresholds
  - MTB_reads (optional, derived if --derive_reads is selected) - reads assigned to the target organism
  - Unclassified_reads (optional, derived if --derive_reads is selected) - reads that could not be classified

  **Output**
  - A summarized QC matrix in TSV format
  - A summarized QC matrix in CSV format
  - Both outputs include Pass/Fail status for each sample based on the threshold evaluation

  **Threshold behavior**
  - Thresholds are provided as a JSON-formatted string. Example: {"Total_reads": 1000000, "Coverage_gte_10x_pct": 90, "Contam_pct": 5}

  **Additional Notes**
  - Read count fields (Total_reads, Mapped_reads) are automatically scaled if MultiQC reports them in millions (e.g., Qualimap output). No action is required
  - If no QC metric attributes are selected, the tool includes all available columns
  - Derived read metrics (MTB_reads, Unclassified_reads) are calculated only when the relevant option is enabled
  - Default thresholds: Total reads >= 1000000, Coverage >=10x percentage >= 90, Contamination percentage <= 5
  - Rounding precision for numeric metrics can be adjusted (default is 2 decimal places)
  - The tool generates a log file documenting the processing steps and any issues encountered

  ]]></help>

  <citations>
    <citation type="bibtex">
  @misc{bntozini2025,
    author = {Buhle Ntozini},
    year = {2025},
    title = {Galaxy QC Matrix Extractor: MultiQC tabular QC matrix extractor},
    publisher = {GitHub},
    journal = {GitHub repository},
    url = {https://github.com/buhlentozini}
  }
    </citation>
  </citations>

</tool>
