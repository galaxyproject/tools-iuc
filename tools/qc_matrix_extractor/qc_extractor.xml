<tool id="multiqc_qc_matrix_extractor" name="QC Matrix Extractor" version="1.0.4">
  <description>Generate QC matrix and pass/fail decisions from MultiQC summary</description>

  <requirements>
    <requirement type="package" version=">=1.5.0">pandas</requirement>
    <requirement type="package" version=">=3.9">python</requirement>
  </requirements>

  <command detect_errors="exit_code"><![CDATA[
    python '${__tool_directory__}/qc_matrix_extractor.py'
      --input '$input_file'
      --attributes '$attributes'
      --thresholds "{\"Total_reads\": ${total_reads}, \"Coverage_gte_10x_pct\": ${Coverage_gte_10x_pct}, \"Contam_pct\": ${contam_max}}"
      --round '${round}'
      $derive_reads      
      --outdir .
  ]]></command>

  <inputs>
    <param name="input_file" type="data" format="tabular" label="Input summary file (.tabular)" />

    <param name="attributes" type="select" multiple="true" optional="true"
           label="QC metrics to include"
           help="Select which metrics to include in the output. Leave empty to include all.">
        <option value="Sample">Sample</option>
        <option value="Total_reads">Total reads</option>
        <option value="Mapped_reads">Mapped reads</option>
        <option value="Mapping_pct">Mapping %</option>
        <option value="Median_depth">Median depth</option>
        <option value="Coverage_gte_10x_pct">Coverage ≥10x %</option>
        <option value="GC_pct">GC %</option>
        <option value="Kraken_top1_pct">Kraken top1 %</option>
        <option value="Kraken_unclassified_pct">Kraken unclassified %</option>
        <option value="Contam_pct">Contamination %</option>
        <option value="QC_status">QC status</option>
        <option value="Total_reads_pass">Total reads pass</option>
        <option value="Coverage_gte_10x_pct_pass">Coverage at ≥10x pass</option>
        <option value="Contam_pct_pass">Contamination pass</option>
        <option value="MTB_reads">MTB reads</option>
        <option value="Unclassified_reads">Unclassified reads</option>
    </param>

    <param name="total_reads" type="float" value="1000000" label="Minimum total reads" />
    <param name="Coverage_gte_10x_pct" type="float" value="90" label="Minimum coverage pct at ≥10x depth" />
    <param name="contam_max" type="float" value="5" label="Maximum contamination %" />
    <param name="round" type="integer" value="2" label="Rounding precision" />
    <param name="derive_reads" type="boolean"
           truevalue="--derive_reads" falsevalue=""
           label="Derive MTB/unclassified reads" />
  </inputs>

  <outputs>
    <data name="qc_matrix_tsv" format="tsv" label="QC Matrix (TSV)" from_work_dir="QC_matrix_multiqc.tsv" />
    <data name="qc_matrix_csv" format="csv" label="QC Matrix (CSV)" from_work_dir="QC_matrix_multiqc.csv" />
    <data name="log" format="txt" label="QC Tool Log" from_work_dir="qc_tool.log" />
  </outputs>

  <tests>
    <test>
      <param name="input_file" value="qc_matrix.tabular" ftype="tabular"/>
      <param name="attributes" value="Sample,Total_reads,Mapped_reads,Mapping_pct,Median_depth,Coverage_gte_10x_pct,GC_pct,Kraken_top1_pct,Kraken_unclassified_pct,Contam_pct,QC_status,Total_reads_pass,Coverage_gte_10x_pct_pass,Contam_pct_pass,MTB_reads,Unclassified_reads" />
      <param name="total_reads" value="1000000" />
      <param name="Coverage_gte_10x_pct" value="90" />
      <param name="contam_max" value="5" />
      <param name="round" value="2" />
      <param name="derive_reads" value="true" />
      <output name="qc_matrix_tsv" file="QC_matrix_multiqc.tsv"/>
      <output name="qc_matrix_csv" file="QC_matrix_multiqc.csv"/>
    </test>
  </tests>

  <help><![CDATA[
  This tool parses MultiQC tabular output and generates a QC matrix summarizing key metrics such as total reads, mapping %, coverage, and contamination.
  It also flags samples as Pass/Fail based on user-defined thresholds.

  Notes:

  - Read counts (Total_reads / Mapped_reads) are automatically scaled if detected in millions (Qualimap output). No extra user option is needed.
  - Leave QC metrics empty to include all available columns.
  - Derived reads (MTB_reads / Unclassified_reads) are calculated only if "Derive MTB/unclassified reads" is selected.
  - Default thresholds:
  - Total reads ≥ 1,000,000
  - Coverage % at ≥ 10x depth ≥ 90
  - Contamination % ≤ 5
  ]]></help>


  <citations>
    <citation type="bibtex">@misc{planemo2025, title={Galaxy QC Matrix Tool}, year={2025}}</citation>
  </citations>
</tool>
