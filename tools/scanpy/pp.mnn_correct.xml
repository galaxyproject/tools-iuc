<tool id="pp.mnn_correct" name="pp.mnn_correct" version="1.3.1+galaxy1">
    <description>Correct batch effects by matching mutual nearest neighbors</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
            python $script_file
    ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
import scanpy.api as sc

sc.pp.mnn_correct(
   datas = '$datas',
   var_index = '$var_index',
   var_subset = '$var_subset',
   batch_key = '$batch_key',
   index_unique = '$index_unique',
   batch_categories = '$batch_categories',
   k = '$k',
   sigma = '$sigma',
   cos_norm_in = '$cos_norm_in',
   cos_norm_out = '$cos_norm_out',
   svd_dim = '$svd_dim',
   var_adj = '$var_adj',
   compute_angle = '$compute_angle',
   mnn_order = '$mnn_order',
   svd_mode = '$svd_mode',
   do_concatenate = '$do_concatenate',
   save_raw = '$save_raw',
   n_jobs = '$n_jobs',
   kwargs = '$kwargs',)
]]></configfile>
    </configfiles>
    <inputs>
        <param name="datas" type="numpy.ndarray" value="" label="datas" help="    Expression matrices or AnnData objects. Matrices should be shaped like    n_obs * n_vars (n_cell * n_gene) and have consistent number of    columns. AnnData objects should have same number of variables."/>
        <param name="var_index" type="list" value="" optional="true" label="var_index" help="    The index (list of str) of vars (genes). Necessary when using only a    subset of vars to perform MNN correction, and should be supplied with    var_subset. When datas are AnnData objects, var_index is ignored."/>
        <param name="var_subset" type="list" value="" optional="true" label="var_subset" help="    The subset of vars (list of str) to be used when performing MNN    correction. Typically, a list of highly variable genes (HVGs). When set    to None, uses all vars."/>
        <param name="batch_key" type="str" value="" optional="true" label="batch_key" help="    The batch_key for AnnData.concatenate. Only valid when do_concatenate    and supplying AnnData objects."/>
        <param name="index_unique" type="str" value="" optional="true" label="index_unique" help="    The index_unique for AnnData.concatenate. Only valid when do_concatenate    and supplying AnnData objects."/>
        <param name="batch_categories" type="list" value="" optional="true" label="batch_categories" help="    The batch_categories for AnnData.concatenate. Only valid when    do_concatenate and supplying AnnData objects."/>
        <param name="k" type="int" value="" optional="true" label="k" help="    Number of mutual nearest neighbors."/>
        <param name="sigma" type="float" value="" optional="true" label="sigma" help="    The bandwidth of the Gaussian smoothing kernel used to compute the    correction vectors. Default is 1."/>
        <param name="cos_norm_in" type="bool" value="" optional="true" label="cos_norm_in" help="    Whether cosine normalization should be performed on the input data prior    to calculating distances between cells."/>
        <param name="cos_norm_out" type="bool" value="" optional="true" label="cos_norm_out" help="    Whether cosine normalization should be performed prior to computing corrected expression values."/>
        <param name="svd_dim" type="int" value="" optional="true" label="svd_dim" help="    The number of dimensions to use for summarizing biological substructure    within each batch. If None, biological components will not be removed    from the correction vectors."/>
        <param name="var_adj" type="bool" value="" optional="true" label="var_adj" help="    Whether to adjust variance of the correction vectors. Note this step    takes most computing time."/>
        <param name="compute_angle" type="bool" value="" optional="true" label="compute_angle" help="    Whether to compute the angle between each cell’s correction vector and    the biological subspace of the reference batch."/>
        <param name="mnn_order" type="list" value="" optional="true" label="mnn_order" help="    The order in which batches are to be corrected. When set to None, datas    are corrected sequentially."/>
        <param name="svd_mode" type="str" value="" optional="true" label="svd_mode" help="    One of 'svd', 'rsvd', and 'irlb'. 'svd' computes SVD using a    non-randomized SVD-via-ID algorithm, while 'rsvd' uses a randomized    version. 'irlb' performes truncated SVD by implicitly restarted Lanczos    bidiagonalization (forked from https://github.com/airysen/irlbpy)."/>
        <param name="do_concatenate" type="bool" value="" optional="true" label="do_concatenate" help="    Whether to concatenate the corrected matrices or AnnData objects. Default is True."/>
        <param name="save_raw" type="bool" value="" optional="true" label="save_raw" help="    Whether to save the original expression data in the .raw attribute of AnnData objects."/>
        <param name="n_jobs" type="int" value="" optional="true" label="n_jobs" help="    The number of jobs. When set to None, automatically uses the number of cores."/>
        <param name="kwargs" type="dict" value="" optional="true" label="kwargs" help="    optional keyword arguments for irlb."/>
        </inputs>
    <outputs>
        <data name="datas" type="numpy.ndarray" label="${tool.name} on ${on_string}: datas"/>
        <data name="mnn_list" type="list" label="${tool.name} on ${on_string}: mnn_list"/>
        <data name="angle_list" type="list" label="${tool.name} on ${on_string}: angle_list"/>
        </outputs>
    <tests>
        <test>
        <param name="datas" value=""/>
        <param name="var_index" value=""/>
        <param name="var_subset" value=""/>
        <param name="batch_key" value=""/>
        <param name="index_unique" value=""/>
        <param name="batch_categories" value=""/>
        <param name="k" value=""/>
        <param name="sigma" value=""/>
        <param name="cos_norm_in" value=""/>
        <param name="cos_norm_out" value=""/>
        <param name="svd_dim" value=""/>
        <param name="var_adj" value=""/>
        <param name="compute_angle" value=""/>
        <param name="mnn_order" value=""/>
        <param name="svd_mode" value=""/>
        <param name="do_concatenate" value=""/>
        <param name="save_raw" value=""/>
        <param name="n_jobs" value=""/>
        <param name="kwargs" value=""/>
        <output name="datas" file=""/>
        <output name="mnn_list" file=""/>
        <output name="angle_list" file=""/>
        </test>
    </tests>
    <help><![CDATA[
        Correct batch effects by matching mutual nearest neighbors [Haghverdi18]_ [Kang18]_.

This uses the implementatino of `mnnpy
<https://github.com/chriscainx/mnnpy>`__ [Kang18]_.

Depending on `do_concatenate`, returns matrices or `AnnData` objects in the
original order containing corrected expression values or a concatenated
matrix or AnnData object.

Be reminded that it is not advised to use the corrected data matrices for
differential expression testing.

More information and bug reports `here <https://github.com/chriscainx/mnnpy>`__.

Parameters
----------
datas : `numpy.ndarray` or :class:`~anndata.AnnData`
    Expression matrices or AnnData objects. Matrices should be shaped like
    n_obs * n_vars (n_cell * n_gene) and have consistent number of
    columns. AnnData objects should have same number of variables.
var_index : `list` or `None`, optional (default: None)
    The index (list of str) of vars (genes). Necessary when using only a
    subset of vars to perform MNN correction, and should be supplied with
    var_subset. When datas are AnnData objects, var_index is ignored.
var_subset : `list` or `None`, optional (default: None)
    The subset of vars (list of str) to be used when performing MNN
    correction. Typically, a list of highly variable genes (HVGs). When set
    to None, uses all vars.
batch_key : `str`, optional (default: 'batch')
    The batch_key for AnnData.concatenate. Only valid when do_concatenate
    and supplying AnnData objects.
index_unique : `str`, optional (default: '-')
    The index_unique for AnnData.concatenate. Only valid when do_concatenate
    and supplying AnnData objects.
batch_categories : `list` or `None`, optional (default: None)
    The batch_categories for AnnData.concatenate. Only valid when
    do_concatenate and supplying AnnData objects.
k : `int`, optional (default: 20)
    Number of mutual nearest neighbors.
sigma : `float`, optional (default: 1)
    The bandwidth of the Gaussian smoothing kernel used to compute the
    correction vectors. Default is 1.
cos_norm_in : `bool`, optional (default: True)
    Whether cosine normalization should be performed on the input data prior
    to calculating distances between cells.
cos_norm_out : `bool`, optional (default: True)
    Whether cosine normalization should be performed prior to computing corrected expression values.
svd_dim : `int` or `None`, optional (default: None)
    The number of dimensions to use for summarizing biological substructure
    within each batch. If None, biological components will not be removed
    from the correction vectors.
var_adj : `bool`, optional (default: True)
    Whether to adjust variance of the correction vectors. Note this step
    takes most computing time.
compute_angle : `bool`, optional (default: False)
    Whether to compute the angle between each cell’s correction vector and
    the biological subspace of the reference batch.
mnn_order : `list` or `None`, optional (default: None)
    The order in which batches are to be corrected. When set to None, datas
    are corrected sequentially.
svd_mode : `str`, optional (default: 'rsvd')
    One of 'svd', 'rsvd', and 'irlb'. 'svd' computes SVD using a
    non-randomized SVD-via-ID algorithm, while 'rsvd' uses a randomized
    version. 'irlb' performes truncated SVD by implicitly restarted Lanczos
    bidiagonalization (forked from https://github.com/airysen/irlbpy).
do_concatenate : `bool`, optional (default: True)
    Whether to concatenate the corrected matrices or AnnData objects. Default is True.
save_raw : `bool`, optional (default: False)
    Whether to save the original expression data in the .raw attribute of AnnData objects.
n_jobs : `int` or `None`, optional (default: None)
    The number of jobs. When set to None, automatically uses the number of cores.
kwargs : `dict` or `None`, optional (default: None)
    optional keyword arguments for irlb.

Returns
-------
datas : `numpy.ndarray` or :class:`~anndata.AnnData`
    Corrected matrix/matrices or AnnData object/objects, depending on the
    input type and `do_concatenate`.
mnn_list : `list`
    A list containing MNN pairing information as DataFrames in each iteration step.
angle_list : `list`
    A list containing angles of each batch.
    ]]></help>
    <expand macro="citations"/>
</tool>
