<tool id="pl.highest_expr_genes" name="pl.highest_expr_genes" version="1.3.1+galaxy1">
    <description>Plot the fraction of counts assigned to each gene over all cells.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
          python $script_file
    ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
import scanpy.api as sc
sc.settings.figdir = '.'
@CMD_read_inputs@

sc.pl.highest_expr_genes(
    adata = adata,
    n_top = $n_top,
    show=False,
    save='.$format',
#if $setseaborn_boxplot.color
    color='$setseaborn_boxplot.color',
#end if
#if $setseaborn_boxplot.palette
    palette='$setseaborn_boxplot.palette',
#end if
    saturation=$setseaborn_boxplot.saturation
)
]]>
        </configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <param argument="n_top" type="integer" value="30" optional="true" label="Number of top genes" help=""/>
        <param name="format" type="select" label="Format for saving figures">
          <option value="png">png</option>
          <option value="pdf">pdf</option>
          <option value="svg">svg</option>
        </param>
        <section name="setseaborn_boxplot" title="Plot settings" expanded="false">
            <param argument="color" type="text" value="" optional="true" label="Color for all of the elements, or seed for a gradient palette" help=""/>
            <param argument="palette" type="select" optional="true" label="Colors to use for the different levels of the hue variable" help="See https://seaborn.pydata.org/tutorial/color_palettes.html for more details.">
                <expand macro="seaborn_color_palette_options"/>
            </param>
            <param argument="saturation" type="float" value="1" label="Proportion of the original saturation to draw colors at" help="Large patches often look better with slightly desaturated colors, but set this to 1 if you want the plot colors to perfectly match the input color spec."/>            
        </section>
    </inputs>
    <outputs>
        <data name="out_png" format="png" from_work_dir="highest_expr_genes.png" label="${tool.name} on ${on_string}">
            <filter>format == 'png'</filter>
        </data>
        <data name="out_pdf" format="pdf" from_work_dir="highest_expr_genes.pdf" label="${tool.name} on ${on_string}">
            <filter>format == 'pdf'</filter>
        </data>
        <data name="out_svg" format="svg" from_work_dir="highest_expr_genes.svg" label="${tool.name} on ${on_string}">
            <filter>format == 'svg'</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="krumsiek11.h5ad" />
            </conditional>
            <param name="n_top" value="30"/>
            <param name="format" value="png"/>
            <section name="setseaborn_boxplot">
                <param name="color" value="blue"/>
                <param name="saturation" value="0.5"/>
            </section>
            <output name="out_png" file="pl.highest_expr_genes.krumsiek11.png" ftype="png" compare="sim_size"/>
        </test>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="krumsiek11.h5ad" />
            </conditional>
            <param name="n_top" value="30"/>
            <param name="format" value="pdf"/>
            <section name="setseaborn_boxplot">
                <param name="palette" value="Blues"/>
                <param name="saturation" value="1.0"/>
            </section>
            <output name="out_pdf" file="pl.highest_expr_genes.krumsiek11.pdf" ftype="pdf" compare="sim_size"/>
        </test>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="krumsiek11.h5ad" />
            </conditional>
            <param name="n_top" value="30"/>
            <param name="format" value="svg"/>
            <section name="setseaborn_boxplot">
                <param name="saturation" value="1.0"/>
            </section>
            <output name="out_svg" file="pl.highest_expr_genes.krumsiek11.svg" ftype="svg" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
Plot the fraction of counts assigned to each gene over all cells.

Computes, for each gene, the fraction of counts assigned to that gene within
a cell. The `n_top` genes with the highest mean fraction over all cells are
plotted as boxplots.

This plot is similar to the `scater` package function `plotHighestExprs(type= "highest-expression")`, see `here
<https://bioconductor.org/packages/devel/bioc/vignettes/scater/inst/doc/vignette-qc.html>`__.
-- Davis McCarthy and Aaron Lun

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.pl.highest_expr_genes.html#scanpy.api.pl.highest_expr_genes>`__

]]>
    </help>
    <expand macro="citations"/>
</tool>
