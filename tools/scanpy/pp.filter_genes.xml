<tool id="pp.filter_genes" name="pp.filter_genes" version="1.3.1+galaxy1">
    <description>Filter genes based on number of cells or counts</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
            python $script_file
        ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@

res = sc.pp.filter_genes(
    #if $modify_anndata.modify_anndata == 'true'
    adata,
    #else
    adata.X,
    #end if
    #if $filter.filter == 'min_counts'
    min_counts=$filter.min_counts,
    #elif $filter.filter == 'max_counts'
    max_counts=$filter.max_counts,
    #elif $filter.filter == 'min_cells'
    min_cells=$filter.min_cells,
    #elif $filter.filter == 'max_cells'
    max_cells=$filter.max_cells,
    #end if
    copy=False)

@CMD_anndata_write_modify_outputs@

#if $modify_anndata.modify_anndata == 'true'
df = adata.var
#else
df = pd.DataFrame(data=dict(gene_subset=res[0], number_per_gene=res[1]))
#end if

#if $filter.filter == 'min_counts' or $filter.filter == 'max_counts'
df.to_csv('$counts_per_gene', sep='\t')
#elif $filter.filter == 'min_cells' or $filter.filter == 'max_cells'
df.to_csv('$cells_per_gene', sep='\t')
#end if
    ]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <conditional name="filter">
            <param argument="filter" type="select" label="Filter">
                <option value="min_counts">Minimum number of counts</option>
                <option value="max_counts">Maximum number of counts</option>
                <option value="min_cells">Minimum number of cells expressed</option>
                <option value="max_cells">Maximum number of cells expressed</option>
            </param>
            <when value="min_counts">
                <param argument="min_counts" type="integer" value="" label="Minimum number of counts required for a gene to pass filtering" help=""/>
            </when>
            <when value="max_counts">
                <param argument="max_counts" type="integer" value="" label="Maximum number of counts required for a gene to pass filtering" help=""/>
            </when>
            <when value="min_cells">
                <param argument="min_cells" type="integer" value="" label="Minimum number of cells expressed required for a gene to pass filtering" help=""/>
            </when>    
            <when value="max_cells">
                <param argument="max_cells" type="integer" value="" label="Maximum number of cells expressed required for a gene to pass filtering" help=""/>
            </when>
        </conditional>
        <expand macro="anndata_modify_output_input"/>
    </inputs>
    <outputs>
        <expand macro="anndata_modify_outputs"/>
        <data name="counts_per_gene" format="tabular" label="${tool.name} on ${on_string}: Counts per genes after filtering">
            <filter>filter['filter'] == 'min_counts' or filter['filter'] == 'max_counts'</filter>
        </data>
        <data name="cells_per_gene" format="tabular" label="${tool.name} on ${on_string}: Number of cells per genes after filtering">
            <filter>filter['filter'] == 'min_cells' or filter['filter'] == 'max_cells'</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="krumsiek11.h5ad" />
            </conditional>
            <conditional name="filter">
                <param name="filter" value="min_counts"/>
                <param name="min_counts" value="3"/>
            </conditional>
            <conditional name="modify_anndata">
                <param name="modify_anndata" value="true"/>
                <param name="anndata_output_format" value="h5ad" />
            </conditional>
            <output name="anndata_out_h5ad" file="pp.filter_genes.krumsiek11-min_counts.h5ad" ftype="h5" compare="sim_size"/>
            <output name="counts_per_gene" file="pp.filter_genes.number_per_gene.krumsiek11-min_counts.tabular"/>
        </test>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="pbmc68k_reduced.h5ad"/>
            </conditional>
            <conditional name="filter">
                <param name="filter" value="max_cells"/>
                <param name="max_cells" value="500"/>
            </conditional>
            <conditional name="modify_anndata">
                <param name="modify_anndata" value="false"/>
            </conditional>
            <output name="cells_per_gene" file="pp.filter_genes.number_per_gene.pbmc68k_reduced-max_cells.tabular"/>
        </test>
    </tests>
    <help><![CDATA[
Filter genes based on number of cells or counts

Keep genes that have at least `min_counts` counts or are expressed in at
least `min_cells` cells or have at most `max_counts` counts or are expressed
in at most `max_cells` cells.

Only provide one of the optional parameters `min_counts`, `min_cells`,
`max_counts`, `max_cells` per call.

Return
------

number_per_gene : Number per genes (either `n_counts` or `n_genes` per cell)

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.pp.filter_genes.html#scanpy.api.pp.filter_genes>`__
    ]]></help>
    <expand macro="citations"/>
</tool>
