<tool id="pl.paga_path" name="pl.paga_path" version="1.3.1+galaxy1">
    <description>Gene expression and annotation changes along paths in the abstracted graph</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
            python $script_file
        ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@
sc.settings.figdir = '.'

nodes=[]
#for $i, $s in enumerate($nodes)
nodes.append('$s.node')
#end for

keys=[]
#for $i, $s in enumerate($color_map_keys)
keys.append('$s.key')
#end for

annotations=[]
color_maps_annotations={}
#for $i, $s in enumerate($annotations)
annotations.append('$s.annotation')
color_maps_annotations['$s.annotation']='$s.color_map'
#end for
if len(annotations) == 0:
    annotations=[]
    color_maps_annotations={}

sc.pl.paga_path(
    adata=adata,
    nodes=nodes,
    keys=keys,
    use_raw=$use_raw,
    annotations=annotations,
    color_map='$color_map',
    color_maps_annotations=color_maps_annotations,
    n_avg=$n_avg,
#if $groups_key
    groups_key='$groups_key',
#end if
    as_heatmap=$as_heatmap,
    show_node_names=$show_node_names,
    show_colorbar=$show_colorbar,
    show_yticks=$show_yticks,
    normalize_to_zero_one=$normalize_to_zero_one,
    show=False,
    save='.$format')
]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <repeat name="nodes" title="Group name" help="A path through nodes of the abstracted graph, that is, names or indices (within .categories) of groups that have been used to run PAGA.">
            <param name="node" type="text" value="" label="Group name" help=""/>
        </repeat>
        <repeat name="color_map_keys" title="Key" help="They are plotted using color_map">
            <param name="key" type="text" value="" label="Key" help="Either variables in adata.var_names or annotations in adata.obs"/>
        </repeat>
        <expand macro="param_use_raw"/>
        <repeat name="annotations" title="Annotation" help="Plot these keys with color_maps_annotations.">
            <param name="annotation" type="text" value="" label="Key for adata.obs" help=""/>
            <param name="color_map" type="select" label="Color map for plotting the key" help="">
                <expand macro="matplotlib_pyplot_colormap"/>
            </param>
        </repeat>
        <param name="color_map" type="select" label="Color map for plotting key" help="">
            <expand macro="matplotlib_pyplot_colormap"/>
        </param>
        <param argument="n_avg" type="integer" value="1" label="Number of data points to include in computation of running average" help=""/>
        <param argument="groups_key" type="text" value="" optional="true" label="Key of the grouping used to run PAGA" help="If not set, defaults to `adata.uns['paga']['groups']`."/>
        <param argument="as_heatmap" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Plot the timeseries as heatmap?" help="If not plotting as heatmap, `annotations` have no effect."/>
        <param argument="show_node_names" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Plot the node names on the nodes bar?" help=""/>
        <param argument="show_colorbar" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Show the colorbar?" help=""/>
        <param argument="show_yticks" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Show the y ticks?" help=""/>
        <param argument="normalize_to_zero_one" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Shift and scale the running average to [0, 1] per gene?" help=""/>
        <expand macro="param_plot_format"/>
    </inputs>
    <outputs>
        <expand macro="plot_output"/>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="tl.paga.neighbors.paul15_gauss_braycurtis.h5ad" />
            </conditional>
            <repeat name="nodes">
                <param name="node" value="1Ery"/>
            </repeat>
            <repeat name="nodes">
                <param name="node" value="3Ery"/>
            </repeat>
            <repeat name="nodes">
                <param name="node" value="12Baso"/>
            </repeat>
            <repeat name="nodes">
                <param name="node" value="16Neu"/>
            </repeat>
            <repeat name="nodes">
                <param name="node" value="19Lymph"/>
            </repeat>
            <repeat name="color_map_keys">
                <param name="key" value="0610009O20Rik"/>
            </repeat>
            <repeat name="color_map_keys">
                <param name="key" value="1110007C09Rik"/>
            </repeat>
            <repeat name="color_map_keys">
                <param name="key" value="mKIAA0621"/>
            </repeat>
            <param name="use_raw" value="False"/>
            <repeat name="annotations">
                <param name="annotation" value="paul15_clusters"/>
                <param name="color_map" value="viridis"/>
            </repeat>
            <param name="color_map" value="viridis"/>
            <param name="n_avg" value="1"/>
            <param name="as_heatmap" value="True"/>
            <param name="show_node_names" value="True"/>
            <param name="show_colorbar" value="True"/>
            <param name="show_yticks" value="True"/>
            <param name="normalize_to_zero_one" value="True"/>
            <param name="format" value="png"/>
            <output name="out_png" file="pl.paga_path.paul15_gauss_braycurtis.png" ftype="png" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
Gene expression and annotation changes along paths in the abstracted graph.

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.pl.paga_path.html#scanpy.api.pl.paga_path>`__
    ]]></help>
  <expand macro="citations"/>
</tool>
