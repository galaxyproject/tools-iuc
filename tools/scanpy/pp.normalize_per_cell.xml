<tool id="pp.normalize_per_cell" name="pp.normalize_per_cell" version="1.3.1+galaxy1">
    <description>Normalize total counts per cell</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
          python $script_file
      ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@

sc.pp.normalize_per_cell(
    data=adata,
    #if $counts_per_cell_after
    counts_per_cell_after=$counts_per_cell_after,
    #end if
    #if $counts_per_cell
    counts_per_cell=np.loadtxt('$counts_per_cell'),
    #end if
    key_n_counts='$key_n_counts',
    copy=False)

@CMD_anndata_write_outputs@
adata.obs.to_csv('$anndata_obs', sep='\t')
]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <param argument="counts_per_cell_after" type="float" value="" optional="true" label="Counts per cell after" help="If not provided, after normalization, each cell has a total count equal to the median of the *counts_per_cell* before normalization."/>
        <param argument="counts_per_cell" type="data" format="tabular,txt" optional="true" label="Precomputed counts per cell" help=""/>
        <param argument="key_n_counts" type="text" value="n_counts" label="Name of the field in `adata.obs` where the total counts per cell will be stored" help=""/>
        <expand macro="anndata_output_format"/>
    </inputs>
    <outputs>
        <expand macro="anndata_outputs"/>
        <data name="anndata_obs" format="tabular" label="${tool.name} on ${on_string}: Annotation of observations"/>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="krumsiek11.h5ad" />
            </conditional>
            <param name="counts_per_cell_after" value="2"/>
            <param name="counts_per_cell" value="krumsiek11_counts_per_cell"/>
            <param name="key_n_counts" value="n_counts2"/>
            <param name="anndata_output_format" value="h5ad" />
            <output name="anndata_out_h5ad" file="pp.normalize_per_cell.krumsiek11.h5ad" ftype="h5" compare="sim_size"/>
            <output name="anndata_obs" file="pp.normalize_per_cell.obs.krumsiek11.tabular"/>
        </test>
    </tests>
    <help><![CDATA[
Normalize each cell by total counts over all genes, so that every cell has
the same total count after normalization.

Similar functions are used, for example, by Seurat, Cell Ranger or SPRING.

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.pp.normalize_per_cell.html#scanpy.api.pp.normalize_per_cell>`__

    ]]></help>
    <expand macro="citations"/>
</tool>
