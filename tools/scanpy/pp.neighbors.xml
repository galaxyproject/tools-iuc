<tool id="pp.neighbors" name="pp.neighbors" version="1.3.1+galaxy1">
    <description>Compute a neighborhood graph of observations</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
            python $script_file
        ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@

sc.pp.neighbors(
   adata=adata,
   n_neighbors=$n_neighbors,
   #if $n_pcs
   n_pcs=$n_pcs,
   #end if
   knn=$knn,
   random_state=$random_state,
   method='$method',
   metric='$metric',
   copy=False)

@CMD_anndata_write_outputs@
]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <param argument="n_neighbors" type="integer" value="15" label="The size of local neighborhood (in terms of number of neighboring data points) used for manifold approximation" help="Larger values result in more global views of the manifold, while smaller values result in more local data being preserved. In general values should be in the range 2 to 100. If `knn` is `True`, number of nearest neighbors to be searched. If `knn` is `False`, a Gaussian kernel width is set to the distance of the `n_neighbors` neighbor."/>
        <param argument="n_pcs" type="integer" value="" optional="true" label="Number of PCs to use" help=""/>
        <param argument="knn" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Use a hard threshold to restrict the number of neighbors to n_neighbors?" help="If true, it considers a knn graph. Otherwise, it uses a Gaussian Kernel to assign low weights to neighbors more distant than the `n_neighbors` nearest neighbor."/>
        <param argument="random_state" type="integer" value="0" label="Numpy random seed" help=""/>
        <param argument="method" type="select" label="Method for computing connectivities" help="">
            <option value="umap">umap (McInnes et al, 2018)</option>
            <option value="gauss">gauss: Gauss kernel following (Coifman et al 2005) with adaptive width (Haghverdi et al 2016)</option>
        </param>
        <param argument="metric" type="select" label="Distance metric" help="">
            <expand macro="distance_metric_options"/>
        </param>
        <expand macro="anndata_output_format"/>
    </inputs>
    <outputs>
        <expand macro="anndata_outputs"/>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="paul15.h5ad" />
            </conditional>
            <param name="n_neighbors" value="15"/>
            <param name="knn" value="True"/>
            <param name="method" value="umap"/>
            <param name="metric" value="euclidean"/>
            <param name="anndata_output_format" value="h5ad" />
            <output name="anndata_out_h5ad" file="pp.neighbors.paul15_umap_euclidean.h5ad" ftype="h5" compare="sim_size"/>
        </test>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="paul15.h5ad" />
            </conditional>
            <param name="n_neighbors" value="15"/>
            <param name="knn" value="True"/>
            <param name="method" value="gauss"/>
            <param name="metric" value="braycurtis"/>
            <param name="anndata_output_format" value="h5ad" />
            <output name="anndata_out_h5ad" file="pp.neighbors.paul15_gauss_braycurtis.h5ad" ftype="h5" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
Compute a neighborhood graph of observations.

The neighbor search efficiency of this heavily relies on UMAP (McInnes et al, 2018),
which also provides a method for estimating connectivities of data points -
the connectivity of the manifold (`method=='umap'`). If `method=='diffmap'`,
connectivities are computed according to Coifman et al (2005), in the adaption of
Haghverdi et al (2016).

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.pp.neighbors.html#scanpy.api.pp.neighbors>`__
    ]]></help>
    <expand macro="citations"/>
</tool>
