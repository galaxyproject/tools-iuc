<tool id="genome_uploader" name="Genome-uploader" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Python script to upload bins and MAGs in fasta format to ENA</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code">
        <![CDATA[

            mkdir outputs genome_contigs &&

            echo -e 'ENA_WEBIN=\$ENA_WEBIN_ACCOUNT_NAME}\nENA_WEBIN_PASSWORD=\$ENA_WEBIN_PASSWORD' > '.env' &&

            #for $file in $contigs:
                ln -s '$file' 'genome_contigs/${file.element_identifier}' &&
            #end for

            genome_upload
            -u '$study'
            --genome_info '$genome_info'
            --out outputs
            #if $type == 'bin':
                --bins
            #else
                --mags
            #end if
            ${live}
            #if '$centre_name':
                --centre_name '$centre_name'
            #end if
            ${tpa}
            ${private}


        ]]>
    </command>
    <inputs>
        <param name="study" type="text" label="Study accession"
            help="In format ERPxxxxxx or PRJEBxxxxxx where x stands for a number">
            <validator type="regex">^(?:ERP\d{6}|PRJEB\d{6})$</validator>
        </param>
        <param argument="--genome_info" type="data" format="tabular" label="Input genomes metadata file (tsv file)"
            help="To see an example how the tsv file should look like have a look into the help section an the bottom of the tool!"/>
        <param name="contigs" type="data" format="fasta,fasta.gz" multiple="true" label="Input genome contigs"/>
        <param name="type" type="select" label="What will be uploaded"
            help="Refer to the ENA definition in the help section at the bottom of the tool if you have doubt!">
            <option value="bin">Bins</option>
            <option value="mag">MAGs</option>
        </param>
        <!-- PLEASE READ THE COMMENT DOWN BELOW THIS PARAMETER -->
        <param argument="--live" type="boolean" truevalue="--live" falsevalue="" label="Upload to ENA live server"
            help="WARNING: only use this option if you want to upload the data to the live ENA server. If you want to TEST your uplaod dint use this option then!"/>
        <!-- DO NOT USE THIS PARAMETER IN ANY TEST CASES SINCE THE TEST DATA SHOULD NOT BE UPLOADED TO THE LIVE ENA SERVER. IGNORE THIS PARAMETER FOR ANY TEST THEN! -->
        <param argument="--private" type="boolean" truevalue="--private" falsevalue="" label="Use when data are private"/>
        <param argument="--centre_name" type="text" label="Enter name of the centre generating and uploading genomes"/>
        <param argument="--tpa" type="boolean" truevalue="--tpa" falsevalue="" label="Third party generated genome(s)?"
            help="toggle if the genomes uploaded are third party generated genome(s)"/>
    </inputs> 
    <outputs>
        <data name="samples" format="tabular" from_work_dir="outputs/bin_upload/genome_samples.xml" label="${tool.name}: GENOME SAMPLE FILE"/>
        <data name="submission" format="tabular" from_work_dir="outputs/bin_upload/submission.xml" label="${tool.name}: SUBMISSION FILE"/>
        <collection name="manifests_files" type="list" format="tabular" label="${tool.name}: MANIFEST FILES">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.manifest" directory="outputs/bin_upload/manifests"/>
            <filter>live == True</filter>
        </collection>
        <collection name="manifests_files_test" type="list" format="tabular" label="${tool.name}: MANIFEST TEST FILES">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.manifest" directory="outputs/bin_upload/manifests_test"/>
            <filter>live == False</filter>
        </collection>
        <collection name="registered_files" type="list" format="tabular" label="${tool.name}: REGISTERED GENOME">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.tsv" directory="outputs/bin_upload/registered_bins"/>
            <filter>live == True</filter>
        </collection>
        <collection name="registered_files_test" type="list" format="tabular" label="${tool.name}: REGISTERED GENOME TEST">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.tsv" directory="outputs/bin_upload/registered_bins"/>
            <filter>live == False</filter>
        </collection>
    </outputs>
    <tests>
       <!-- It might happen that the test might run again but at some point it 
        happen if ENA service are down so the test might not work --> 
        <test expect_failure="true" expect_exit_code="1"> <!-- expect_num_outputs="4" -->
            <param name="study" value="ERP159782"/>
            <param name="genome_info" ftype="tabular" value="input_fixture.tsv"/>
            <param name="contigs" ftype="fasta.gz" value="ERR6769700_bin.1.fa.gz"/>
            <param name="type" value="bin"/>
            <param name="centre_name" value="EMG"/>
            <assert_command>
                <has_text text="--centre_name 'EMG'"/>
                <has_text text="echo -e 'ENA_WEBIN=$ENA_WEBIN_ACCOUNT_NAME}\nENA_WEBIN_PASSWORD=$ENA_WEBIN_PASSWORD' > '.env'"/>
            </assert_command>
            <assert_stderr>
                <has_text text="403 Client Error"/>
            </assert_stderr>
        </test>
        <test expect_failure="true" expect_exit_code="1"><!-- expect_num_outputs="4" -->
            <param name="study" value="ERP159782"/>
            <param name="genome_info" ftype="tabular" value="input_with_registrered_fixture.tsv"/>
            <param name="contigs" ftype="fasta.gz" value="ERR6769700_bin.1.fa.gz,ERR6769769_bin.1.fa.gz,ERR6769701_bin.1.fa.gz"/>
            <param name="type" value="bin"/>
            <param name="centre_name" value="EMG"/>
            <assert_command>
                <has_text text="--centre_name 'EMG'"/>
                <has_text text="echo -e 'ENA_WEBIN=$ENA_WEBIN_ACCOUNT_NAME}\nENA_WEBIN_PASSWORD=$ENA_WEBIN_PASSWORD' > '.env'"/>
            </assert_command>
            <assert_stderr>
                <has_text text="403 Client Error"/>
            </assert_stderr>
        </test>
    </tests>
    <help>
        <![CDATA[

            **Note**

            This tool might fail because the ENA service might be offline just for your notice!

            For the definition of either using Bins or MAGs please check out the ENA `definition <https://ena-docs.readthedocs.io/en/latest/submit/assembly/metagenome.html>`_ .

            **Input**

            - a TSV file which contain multiple information's. Here a an example how the file should look like:

            ::
             
             genome_name	genome_path	accessions	assembly_software	binning_software	binning_parameters	stats_generation_software	completeness	contamination	genome_coverage	metagenome	co-assembly	broad_environment	local_environment	environmental_medium	rRNA_presence	NCBI_lineage
             ERR6769769_bin.1	./genome_contigs/ERR6769769_bin.1.fa.gz	ERR6769769	megahit_v1.2.9	MGnify-genomes-generation-pipeline_v1.0.0	default	CheckM2_v1.0.1	90.81314	0.59	14.2	chicken gut metagenome	False	chicken	gut	mucosa	True	d__Bacteria;p__Firmicutes;c__Bacilli;o__Lactobacillales;f__Lactobacillaceae;g__Lactobacillus;s__Lactobacillus crispatus
             ERR6769700_bin.1	./genome_contigs/fixtures/ERR6769700_bin.1.fa.gz	ERR6769700	megahit_v1.2.9	MGnify-genomes-generation-pipeline_v1.0.0	default	CheckM2_v1.0.1	90.81314	0.59	14.2	chicken gut metagenome	False	chicken	gut	mucosa	True	d__Bacteria;p__Firmicutes;c__Bacilli;o__Lactobacillales;f__Lactobacillaceae;g__Lactobacillus;s__Lactobacillus crispatus
             ERR6769701_bin.1	./genome_contigs/ERR6769701_bin.1.fa.gz	ERR6769701	megahit_v1.2.9	MGnify-genomes-generation-pipeline_v1.0.0	default	CheckM2_v1.0.1	90.81314	0.59	14.2	chicken gut metagenome	False	chicken	gut	mucosa	True	d__Bacteria;p__Firmicutes;c__Bacilli;o__Lactobacillales;f__Lactobacillaceae;g__Lactobacillus;s__Lactobacillus crispatus

            NOTE: Please always use this structure!
            IMPORTANT: As prefix for the genome_path column use './genome_contigs/' always! after this the filename which was uploaded should be stated otherwise this tool can not function!

            - Multiple contig files which should be either uploaded to the test ENA server or to the live ENA serve

            **IMPORTANT**

            DONT USE THE LIVE OPTION IF YOU WANT TO TEST IF YOUR DATA CAN BE UPLOADED! USE THE LIVE OPTION ONLY WHEN YOU WANT TO UPLOAD YOUR DATA TO THE LIVE SERVER WHICH THEN CAN BE COMMITTED WITH THE 'ena-webin-cli' TOOL!
            
            More information about this tool can be found on the `Genome-Upload GitHub <https://github.com/EBI-Metagenomics/genome_uploader>`_ page.
            
        ]]>
    </help>
    <expand macro="citations"/>
</tool>
