<tool id="liana_misty" name="Liana MISTy" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>learn spatial relationships with multi-view modelling</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio_tools"/>
    <expand macro="requirements">
        <requirement type="package" version="0.3.1">mudata</requirement>
        <requirement type="package" version="1.10.2">scanpy</requirement>
    </expand>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
cp '$adata' 'anndata.h5ad' &&
#if $advanced_common.show_log:
cat '$script_file' > '$hidden_output' &&
python '$script_file' >> '$hidden_output' 2>&1 &&
ls . >> '$hidden_output'
#else:
python '$script_file' 2>&1
#end if
    ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_IMPORTS@
@CMD_READ_INPUTS@

#if str($method.method) == 'genericMistyData'
misty = li.method.genericMistyData(
    intra=adata,
    intra_use_raw=$method.intra_use_raw,
#if str($method.intra_layer) != ''
    intra_layer='$method.intra_layer',
#end if
    extra_use_raw=$method.extra_use_raw,
#if str($method.extra_layer) != ''
    extra_layer='$method.extra_layer',
#end if
    nz_threshold=$method.nz_threshold,
    add_para=$method.add_para,
    spatial_key='$method.spatial_key',
    set_diag=$method.set_diag,
    kernel='$method.kernel',
    bandwidth=$method.bandwidth,
    zoi=$method.zoi,
    cutoff=$method.cutoff,
    add_juxta=$method.add_juxta,
    n_neighs=$method.n_neighs,
    max_neighs=$method.max_neighs,
    verbose=$method.verbose)
misty(model=li.method.sp.$method.model, bypass_intra=$method.bypass_intra, seed=$method.seed, verbose=$method.verbose)
misty.write_h5mu('misty_results.h5mu')

#else if str($method.method) == 'lrMistyData'
#if str($method.resource_selection.resource_type) == 'resource'
resource = pd.read_csv('$method.resource_selection.resource', sep='\t')
misty = li.method.lrMistyData(
    adata,
    resource=resource,
#else
misty = li.method.lrMistyData(
    adata,
    resource_name='$method.resource_selection.resource_name',
#end if
    nz_threshold=$method.nz_threshold,
    use_raw=$method.use_raw,
    spatial_key='$method.spatial_key',
    set_diag=$method.set_diag,
    kernel='$method.kernel',
    bandwidth=$method.bandwidth,
    zoi=$method.zoi,
    cutoff=$method.cutoff,
    verbose=$method.verbose)
misty(model=li.method.sp.$method.model, bypass_intra=$method.bypass_intra, seed=$method.seed, verbose=$method.verbose)
misty.write_h5mu('misty_results.h5mu')

#end if
        ]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <conditional name="method">
            <param name="method" type="select" label="Method">
                <option value="genericMistyData" selected="true">genericMistyData - Generic multi-view spatial modelling</option>
                <option value="lrMistyData">lrMistyData - Ligand-receptor multi-view spatial modelling</option>
            </param>
            <when value="genericMistyData">
                <expand macro="param_intra_use_raw"/>
                <expand macro="param_intra_layer"/>
                <expand macro="param_extra_use_raw"/>
                <expand macro="param_extra_layer"/>
                <expand macro="param_nz_threshold"/>
                <expand macro="param_add_para"/>
                <expand macro="param_spatial_key"/>
                <expand macro="param_set_diag"/>
                <expand macro="param_kernel"/>
                <expand macro="param_bandwidth"/>
                <expand macro="param_zoi"/>
                <expand macro="param_cutoff"/>
                <expand macro="param_add_juxta"/>
                <expand macro="param_n_neighs"/>
                <expand macro="param_max_neighs"/>
                <expand macro="param_model"/>
                <expand macro="param_bypass_intra"/>
                <expand macro="param_seed"/>
                <expand macro="param_verbose"/>
            </when>
            <when value="lrMistyData">
                <expand macro="param_resource_selection"/>
                <expand macro="param_nz_threshold"/>
                <expand macro="param_use_raw"/>
                <expand macro="param_spatial_key"/>
                <expand macro="param_set_diag"/>
                <expand macro="param_kernel"/>
                <expand macro="param_bandwidth"/>
                <expand macro="param_zoi"/>
                <expand macro="param_cutoff"/>
                <expand macro="param_model"/>
                <expand macro="param_bypass_intra"/>
                <expand macro="param_seed"/>
                <expand macro="param_verbose"/>
            </when>
        </conditional>
        <expand macro="inputs_common_advanced"/>
    </inputs>
    <outputs>
        <data name="misty_out" format="h5mu" from_work_dir="misty_results.h5mu" label="${tool.name} (${method.method}) on ${on_string}: MISTy results"/>
        <data name="hidden_output" format="txt" label="Log file">
            <filter>advanced_common['show_log']</filter>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: genericMistyData with RandomForestModel -->
        <test expect_num_outputs="2">
            <param name="adata" value="misty_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="genericMistyData"/>
                <param name="intra_use_raw" value="false"/>
                <param name="extra_use_raw" value="false"/>
                <param name="nz_threshold" value="0.1"/>
                <param name="add_para" value="true"/>
                <param name="spatial_key" value="spatial"/>
                <param name="set_diag" value="false"/>
                <param name="kernel" value="misty_rbf"/>
                <param name="bandwidth" value="100"/>
                <param name="zoi" value="0"/>
                <param name="cutoff" value="0.1"/>
                <param name="add_juxta" value="true"/>
                <param name="n_neighs" value="6"/>
                <param name="max_neighs" value="18"/>
                <param name="model" value="RandomForestModel"/>
                <param name="bypass_intra" value="false"/>
                <param name="seed" value="1337"/>
                <param name="verbose" value="false"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="misty_out" file="genericMistyData_rf.h5mu" ftype="h5mu" compare="sim_size" delta="100000">
                <assert_contents>
                    <has_size min="1000"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.genericMistyData"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: genericMistyData with LinearModel -->
        <test expect_num_outputs="2">
            <param name="adata" value="misty_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="genericMistyData"/>
                <param name="intra_use_raw" value="false"/>
                <param name="extra_use_raw" value="false"/>
                <param name="nz_threshold" value="0.1"/>
                <param name="add_para" value="true"/>
                <param name="spatial_key" value="spatial"/>
                <param name="set_diag" value="false"/>
                <param name="kernel" value="gaussian"/>
                <param name="bandwidth" value="150"/>
                <param name="zoi" value="0"/>
                <param name="cutoff" value="0.1"/>
                <param name="add_juxta" value="false"/>
                <param name="n_neighs" value="6"/>
                <param name="max_neighs" value="18"/>
                <param name="model" value="LinearModel"/>
                <param name="bypass_intra" value="false"/>
                <param name="seed" value="42"/>
                <param name="verbose" value="false"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="misty_out" file="genericMistyData_linear.h5mu" ftype="h5mu" compare="sim_size" delta="100000">
                <assert_contents>
                    <has_size min="1000"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.genericMistyData"/>
                    <has_text_matching expression="kernel='gaussian'"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: genericMistyData with RobustLinearModel -->
        <test expect_num_outputs="2">
            <param name="adata" value="misty_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="genericMistyData"/>
                <param name="intra_use_raw" value="false"/>
                <param name="extra_use_raw" value="false"/>
                <param name="nz_threshold" value="0.1"/>
                <param name="add_para" value="true"/>
                <param name="spatial_key" value="spatial"/>
                <param name="set_diag" value="false"/>
                <param name="kernel" value="exponential"/>
                <param name="bandwidth" value="120"/>
                <param name="zoi" value="0"/>
                <param name="cutoff" value="0.1"/>
                <param name="add_juxta" value="true"/>
                <param name="n_neighs" value="6"/>
                <param name="max_neighs" value="18"/>
                <param name="model" value="RobustLinearModel"/>
                <param name="bypass_intra" value="false"/>
                <param name="seed" value="123"/>
                <param name="verbose" value="false"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="misty_out" file="genericMistyData_robust.h5mu" ftype="h5mu" compare="sim_size" delta="100000">
                <assert_contents>
                    <has_size min="1000"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.genericMistyData"/>
                    <has_text_matching expression="kernel='exponential'"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 4: lrMistyData with RandomForestModel -->
        <test expect_num_outputs="2">
            <param name="adata" value="misty_lr_test.h5ad"/>
            <conditional name="method">
                <param name="method" value="lrMistyData"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="nz_threshold" value="0.1"/>
                <param name="use_raw" value="false"/>
                <param name="spatial_key" value="spatial"/>
                <param name="set_diag" value="false"/>
                <param name="kernel" value="misty_rbf"/>
                <param name="bandwidth" value="100"/>
                <param name="zoi" value="0"/>
                <param name="cutoff" value="0.1"/>
                <param name="model" value="RandomForestModel"/>
                <param name="bypass_intra" value="false"/>
                <param name="seed" value="1337"/>
                <param name="verbose" value="false"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="misty_out" file="lrMistyData_rf.h5mu" ftype="h5mu" compare="sim_size" delta="100000">
                <assert_contents>
                    <has_size min="1000"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.lrMistyData"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 5: lrMistyData with LinearModel -->
        <test expect_num_outputs="2">
            <param name="adata" value="misty_lr_test.h5ad"/>
            <conditional name="method">
                <param name="method" value="lrMistyData"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="nz_threshold" value="0.1"/>
                <param name="use_raw" value="false"/>
                <param name="spatial_key" value="spatial"/>
                <param name="set_diag" value="false"/>
                <param name="kernel" value="gaussian"/>
                <param name="bandwidth" value="150"/>
                <param name="zoi" value="0"/>
                <param name="cutoff" value="0.1"/>
                <param name="model" value="LinearModel"/>
                <param name="bypass_intra" value="false"/>
                <param name="seed" value="42"/>
                <param name="verbose" value="false"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="misty_out" file="lrMistyData_linear.h5mu" ftype="h5mu" compare="sim_size" delta="100000">
                <assert_contents>
                    <has_size min="1000"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.lrMistyData"/>
                    <has_text_matching expression="kernel='gaussian'"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

This tool performs multi-view spatial relationship learning using MISTy (Multi-view Intercellular SpaTial modeling framework).

MISTy uses machine learning to model how the expression of each target gene is influenced by:

1. **Intraview**: The expression of other genes within the same cell
2. **Paraview**: The weighted expression of genes in neighboring cells (using a spatial kernel)
3. **Juxtaview**: The expression of genes in immediately adjacent cells

**Methods**

- **genericMistyData**: Creates a generic MISTy model from any AnnData with spatial coordinates
- **lrMistyData**: Creates a MISTy model specifically for ligand-receptor analysis using known L-R resources

**Models**

- **RandomForestModel**: Uses Random Forest regression with out-of-bag predictions
- **LinearModel**: Uses linear regression with cross-validation
- **RobustLinearModel**: Uses robust linear regression

**Outputs**

The tool outputs a MuData (h5mu) file containing:

- The fitted MISTy model results
- Target metrics (RÂ² improvement from each view)
- Feature importances for each view
- Interaction coefficients

**References**

- Tanevski, J., Flores, R.O.R., Gabor, A. et al. Explainable multiview framework for dissecting spatial relationships from highly multiplexed data. Genome Biol 23, 97 (2022).
- https://liana-py.readthedocs.io/en/latest/notebooks/misty.html
    ]]></help>
    <expand macro="citations"/>
</tool>
