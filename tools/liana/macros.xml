<macros>
    <token name="@TOOL_VERSION@">1.7.0</token>
    <token name="@VERSION_SUFFIX@">0</token>
    <token name="@PROFILE@">21.09</token>
    <xml name="requirements">
        <requirements>
            <requirement type="package" version="@TOOL_VERSION@">liana</requirement>
            <yield />
        </requirements>
    </xml>
    <xml name="bio_tools">
        <xrefs>
            <xref type="bio.tools">liana+</xref>
        </xrefs>
    </xml>
    <xml name="creators">
        <creator>
            <person givenName="Khaled" familyName="Jum'ah" url="https://github.com/khaled196" />
            <person givenName="Katarzyna" familyName="Kamieniecka" url="https://github.com/kkamieniecka" />
            <person givenName="Krzysztof" familyName="Poterlowicz" url="https://github.com/poterlowicz-lab" />
            <organization name="poterlowicz-lab" url="https://github.com/poterlowicz-lab" />
        </creator>
    </xml>
    <xml name="citations">
        <citations>
            <citation type="doi">10.1038/s41467-022-30755-0</citation>
        </citations>
    </xml>

    <!-- param macros -->
    <xml name="sanitize_query" token_validinitial="string.printable">
        <sanitizer>
            <valid initial="@VALIDINITIAL@">
                <remove value="&apos;"/>
            </valid>
       </sanitizer>
    </xml>
    <xml name="inputs_anndata">
        <param name="adata" type="data" format="h5ad" label="Annotated data matrix"/>
    </xml>
    <xml name="inputs_common_advanced">
        <section name="advanced_common" title="Advanced Options" expanded="false">
            <param name="show_log" type="boolean" checked="false" label="Output Log?"/>
            <yield />
        </section>
    </xml>
    <xml name="anndata_outputs">
        <data name="anndata_out" format="h5ad" from_work_dir="anndata.h5ad" label="${tool.name} (${method.method}) on ${on_string}: Annotated data matrix">
            <yield />
        </data>
        <data name="hidden_output" format="txt" label="Log file" >
            <filter>advanced_common['show_log']</filter>
        </data>
    </xml>

    <!-- Liana-specific parameter macros -->
    <xml name="param_groupby">
        <param argument="groupby" type="text" value="" label="Key for grouping cells" help="Key in adata.obs to be used for grouping cells (e.g., cell type annotation). Required parameter.">
            <expand macro="sanitize_query"/>
            <validator type="empty_field" message="groupby is required"/>
        </param>
    </xml>
    <!-- Simple resource name parameter -->
    <xml name="param_resource_name">
        <param argument="resource_name" type="select" label="Built-in ligand-receptor resource" help="Name of the resource to be used for ligand-receptor inference.">
            <option value="consensus" selected="true">consensus (default - combines multiple resources)</option>
            <option value="baccin2019">baccin2019</option>
            <option value="cellcall">cellcall</option>
            <option value="cellchatdb">cellchatdb</option>
            <option value="cellinker">cellinker</option>
            <option value="cellphonedb">cellphonedb</option>
            <option value="celltalkdb">celltalkdb</option>
            <option value="connectomedb2020">connectomedb2020</option>
            <option value="embrace">embrace</option>
            <option value="guide2pharma">guide2pharma</option>
            <option value="hpmr">hpmr</option>
            <option value="icellnet">icellnet</option>
            <option value="italk">italk</option>
            <option value="kirouac2010">kirouac2010</option>
            <option value="lrdb">lrdb</option>
            <option value="mouseconsensus">mouseconsensus (for mouse data)</option>
            <option value="ramilowski2015">ramilowski2015</option>
        </param>
    </xml>
    <!-- Resource selection with hierarchy: interactions > resource > resource_name -->
    <xml name="param_resource_selection">
        <conditional name="resource_selection">
            <param name="resource_type" type="select" label="Ligand-receptor resource source" help="Choose how to specify ligand-receptor pairs. Priority: interactions list > custom resource file > built-in resource name.">
                <option value="resource_name" selected="true">Use built-in resource by name</option>
                <option value="resource">Provide custom resource file (tabular with ligand/receptor columns)</option>
                <option value="interactions">Provide specific interaction pairs (list of ligand-receptor tuples)</option>
            </param>
            <when value="resource_name">
                <param argument="resource_name" type="select" label="Built-in ligand-receptor resource" help="Name of the resource to be used for ligand-receptor inference.">
                    <option value="consensus" selected="true">consensus (default - combines multiple resources)</option>
                    <option value="baccin2019">baccin2019</option>
                    <option value="cellcall">cellcall</option>
                    <option value="cellchatdb">cellchatdb</option>
                    <option value="cellinker">cellinker</option>
                    <option value="cellphonedb">cellphonedb</option>
                    <option value="celltalkdb">celltalkdb</option>
                    <option value="connectomedb2020">connectomedb2020</option>
                    <option value="embrace">embrace</option>
                    <option value="guide2pharma">guide2pharma</option>
                    <option value="hpmr">hpmr</option>
                    <option value="icellnet">icellnet</option>
                    <option value="italk">italk</option>
                    <option value="kirouac2010">kirouac2010</option>
                    <option value="lrdb">lrdb</option>
                    <option value="mouseconsensus">mouseconsensus (for mouse data)</option>
                    <option value="ramilowski2015">ramilowski2015</option>
                </param>
            </when>
            <when value="resource">
                <param argument="resource" type="data" format="tabular" label="Custom resource file" help="A tabular file with 'ligand' and 'receptor' columns. This overrides the built-in resource_name."/>
            </when>
            <when value="interactions">
                <param argument="interactions" type="text" area="true" label="Interaction pairs" help="List of ligand-receptor pairs, one per line in format: ligand,receptor (e.g., 'TGFB1,TGFBR1'). This overrides both resource and resource_name.">
                    <expand macro="sanitize_query"/>
                </param>
            </when>
        </conditional>
    </xml>
    <xml name="param_expr_prop">
        <param argument="expr_prop" type="float" value="0.1" min="0" max="1" label="Minimum expression proportion" help="Minimum expression proportion for the ligands and receptors (+ their subunits) in the corresponding cell identities. Set to 0 to return unfiltered results."/>
    </xml>
    <xml name="param_min_cells">
        <param argument="min_cells" type="integer" value="5" min="1" label="Minimum cells" help="Minimum cells (per cell identity if grouped by groupby) to be considered for downstream analysis."/>
    </xml>
    <xml name="param_groupby_pairs">
        <conditional name="groupby_pairs">
            <param name="groupby_pairs_selector" type="select" label="Subset cell type pairs">
                <option value="all" selected="true">Use all possible combinations</option>
                <option value="custom">Provide custom pairs</option>
            </param>
            <when value="all"/>
            <when value="custom">
                <param name="pairs_file" type="data" format="tabular" label="Cell type pairs file" help="A tabular file with 'source' and 'target' columns to subset interacting cell types."/>
            </when>
        </conditional>
    </xml>
    <xml name="param_return_all_lrs">
        <param argument="return_all_lrs" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Return all ligand-receptor pairs" help="Whether to return all ligand-receptor pairs, or only those that surpass the expr_prop threshold."/>
    </xml>
    <xml name="param_key_added">
        <param argument="key_added" type="text" value="liana_res" label="Key for storing results" help="Key under which the results will be stored in adata.uns.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_use_raw">
        <param argument="use_raw" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Use raw attribute" help="Use raw attribute of adata if present."/>
    </xml>
    <xml name="param_layer">
        <param argument="layer" type="text" value="" optional="true" label="Layer to use" help="Layer in adata.layers to use. If not provided, uses adata.X.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_de_method">
        <param argument="de_method" type="select" label="Differential expression method" help="Differential expression method used by scanpy.tl.rank_genes_groups for 1vsRest ranking.">
            <option value="t-test" selected="true">t-test</option>
            <option value="t-test_overestim_var">t-test with overestimated variance</option>
            <option value="wilcoxon">Wilcoxon rank-sum test</option>
            <option value="logreg">Logistic regression</option>
        </param>
    </xml>
    <xml name="param_n_perms">
        <param argument="n_perms" type="integer" value="1000" min="0" optional="true" label="Number of permutations" help="Number of permutations for the permutation test. Relevant only for permutation-based methods (e.g., CellPhoneDB). Set to 0 or leave empty to skip permutation testing."/>
    </xml>
    <xml name="param_seed">
        <param argument="seed" type="integer" value="1337" label="Random seed" help="Random seed for reproducibility."/>
    </xml>
    <xml name="param_verbose">
        <param argument="verbose" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Verbose output" help="Enable verbose output during computation."/>
    </xml>
    <xml name="param_base">
        <param argument="base" type="float" value="2.718281828459045" optional="true" label="Exponent base" help="Exponent base used to reverse the log-transformation of the matrix. Default is e (Euler's number)."/>
    </xml>

    <!-- Grouped parameter macros for cleaner code -->
    <xml name="params_common_basic">
        <expand macro="param_groupby"/>
        <expand macro="param_resource_selection"/>
        <expand macro="param_expr_prop"/>
        <expand macro="param_min_cells"/>
    </xml>
    <xml name="params_common_output">
        <expand macro="param_return_all_lrs"/>
        <expand macro="param_key_added"/>
        <expand macro="param_use_raw"/>
        <expand macro="param_layer"/>
    </xml>
    <xml name="params_common_advanced">
        <expand macro="param_de_method"/>
        <expand macro="param_seed"/>
        <expand macro="param_verbose"/>
    </xml>
    <xml name="params_common_advanced_with_perms">
        <expand macro="param_de_method"/>
        <expand macro="param_n_perms"/>
        <expand macro="param_seed"/>
        <expand macro="param_verbose"/>
    </xml>
    <!-- Combined common params for methods without permutations -->
    <xml name="params_lr_method_basic">
        <expand macro="params_common_basic"/>
        <expand macro="params_common_output"/>
        <expand macro="params_common_advanced"/>
    </xml>
    <!-- Combined common params for methods with permutations -->
    <xml name="params_lr_method_with_perms">
        <expand macro="params_common_basic"/>
        <expand macro="params_common_output"/>
        <expand macro="params_common_advanced_with_perms"/>
    </xml>

    <!-- Spatial-specific parameter macros -->
    <xml name="param_bivariate_local_name">
        <param argument="local_name" type="select" label="Local bivariate metric" help="Name of the local function to use for the analysis. Passing None will return only the Global scores.">
            <option value="cosine" selected="true">cosine - weighted Cosine similarity</option>
            <option value="jaccard">jaccard - weighted Jaccard similarity</option>
            <option value="pearson">pearson - weighted Pearson correlation</option>
            <option value="spearman">spearman - weighted Spearman correlation</option>
            <option value="masked_spearman">masked_spearman - masked and weighted Spearman correlation</option>
            <option value="product">product - simple weighted product</option>
            <option value="norm_product">norm_product - normalized weighted product</option>
            <option value="morans">morans - Moran's R</option>
            <option value="None">None - Only compute global scores</option>
        </param>
    </xml>
    <xml name="param_bivariate_global_name">
        <param argument="global_name" type="select" label="Global bivariate metric" help="Name of the global function to use for the analysis. Passing None will not calculate any global scores.">
            <option value="None" selected="true">None - Do not compute global scores</option>
            <option value="morans">morans - Moran's I (global spatial autocorrelation)</option>
            <option value="lee">lee - Lee's L (bivariate spatial association)</option>
        </param>
    </xml>
    <xml name="param_mask_negatives">
        <param argument="mask_negatives" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Mask negatives" help="Whether to mask negative-negative (low-low) or uncategorized interactions."/>
    </xml>
    <xml name="param_add_categories">
        <param argument="add_categories" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Add categories" help="Whether to add categories about the local scores."/>
    </xml>
    <xml name="param_nz_prop">
        <param argument="nz_prop" type="float" value="0.05" min="0" max="1" label="Non-zero proportion" help="Minimum proportion of non-zero values for each feature."/>
    </xml>
    <xml name="param_connectivity_key">
        <param argument="connectivity_key" type="text" value="spatial_connectivities" label="Connectivity key" help="Key in adata.obsp that contains the spatial connectivity matrix.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_spatial_key">
        <param argument="spatial_key" type="text" value="spatial" label="Spatial key" help="Key in adata.obsm where the spatial coordinates are stored.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_nz_threshold">
        <param argument="nz_threshold" type="float" value="0.1" min="0" max="1" label="Non-zero threshold" help="The threshold for the proportion of non-zero entries in each view."/>
    </xml>
    <xml name="param_set_diag">
        <param argument="set_diag" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Set diagonal" help="Whether to set the diagonal of the connectivity matrix to 1."/>
    </xml>
    <xml name="param_kernel">
        <param argument="kernel" type="select" label="Kernel function" help="Radial basis function kernel for the connectivity matrix.">
            <option value="misty_rbf" selected="true">misty_rbf - MISTy RBF kernel (Gaussian derivative)</option>
            <option value="gaussian">gaussian - Gaussian kernel</option>
            <option value="exponential">exponential - Exponential kernel</option>
            <option value="linear">linear - Linear kernel</option>
        </param>
    </xml>
    <xml name="param_bandwidth">
        <param argument="bandwidth" type="float" value="100" min="0" label="Bandwidth" help="The bandwidth of the kernel."/>
    </xml>
    <xml name="param_zoi">
        <param argument="zoi" type="float" value="0" min="0" label="Zone of indifference" help="The kernel is set to 0 for distances smaller than this value."/>
    </xml>
    <xml name="param_cutoff">
        <param argument="cutoff" type="float" value="0.1" min="0" max="1" label="Cutoff" help="The minimum value cutoff for the connectivity matrix."/>
    </xml>
    <xml name="param_add_para">
        <param argument="add_para" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Add paraview" help="Whether to add the paraview (broader spatial context)."/>
    </xml>
    <xml name="param_max_neighs">
        <param argument="max_neighs" type="integer" value="18" min="1" label="Maximum neighbors (paraview)" help="Maximum number of neighbors to consider for the paraview."/>
    </xml>
    <xml name="param_add_juxta">
        <param argument="add_juxta" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Add juxtaview" help="Whether to add the juxtaview (immediate neighbors only)."/>
    </xml>
    <xml name="param_n_neighs">
        <param argument="n_neighs" type="integer" value="6" min="1" label="Number of neighbors (juxtaview)" help="Number of nearest neighbors for the juxtaview."/>
    </xml>
    <xml name="param_model">
        <param argument="model" type="select" label="MISTy model" help="The model to use for MISTy analysis.">
            <option value="RandomForestModel" selected="true">RandomForestModel - Random Forest (uses out-of-bag predictions)</option>
            <option value="LinearModel">LinearModel - Linear regression (uses cross-validation)</option>
            <option value="RobustLinearModel">RobustLinearModel - Robust linear regression</option>
        </param>
    </xml>
    <xml name="param_bypass_intra">
        <param argument="bypass_intra" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Bypass intra-view" help="Whether to bypass the intra-view in the model."/>
    </xml>

    <!-- Grouped spatial parameter macros -->
    <xml name="params_bivariate_metrics">
        <expand macro="param_bivariate_local_name"/>
        <expand macro="param_bivariate_global_name"/>
    </xml>
    <xml name="params_bivariate_options">
        <expand macro="param_mask_negatives"/>
        <expand macro="param_add_categories"/>
        <expand macro="param_n_perms"/>
        <expand macro="param_seed"/>
        <expand macro="param_nz_prop"/>
        <expand macro="param_verbose"/>
    </xml>
    <xml name="param_intra_use_raw">
        <param argument="intra_use_raw" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Use raw data for intra-view" help="Whether to use the raw data of the intraview."/>
    </xml>
    <xml name="param_intra_layer">
        <param argument="intra_layer" type="text" value="" optional="true" label="Intra-view layer" help="The layer of the intraview to use. Leave empty for adata.X.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_extra_use_raw">
        <param argument="extra_use_raw" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Use raw data for extra-view" help="Whether to use the raw data of the extraview."/>
    </xml>
    <xml name="param_extra_layer">
        <param argument="extra_layer" type="text" value="" optional="true" label="Extra-view layer" help="The layer of the extraview(s) to use. Leave empty for adata.X.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="params_misty_intra_extra">
        <section name="intra_settings" title="Intra-view settings" expanded="true">
            <expand macro="param_intra_use_raw"/>
            <expand macro="param_intra_layer"/>
        </section>
        <section name="extra_settings" title="Extra-view settings" expanded="false">
            <expand macro="param_extra_use_raw"/>
            <expand macro="param_extra_layer"/>
        </section>
    </xml>
    <xml name="params_misty_spatial">
        <expand macro="param_spatial_key"/>
        <expand macro="param_set_diag"/>
    </xml>
    <xml name="params_misty_kernel">
        <expand macro="param_kernel"/>
        <expand macro="param_bandwidth"/>
        <expand macro="param_zoi"/>
        <expand macro="param_cutoff"/>
    </xml>
    <xml name="params_misty_para">
        <expand macro="param_add_para"/>
        <expand macro="params_misty_kernel"/>
        <expand macro="param_max_neighs"/>
    </xml>
    <xml name="params_misty_juxta">
        <expand macro="param_add_juxta"/>
        <expand macro="param_n_neighs"/>
    </xml>
    <xml name="params_misty_model">
        <expand macro="param_model"/>
        <expand macro="param_bypass_intra"/>
        <expand macro="param_seed"/>
        <expand macro="param_verbose"/>
    </xml>

    <!-- Command tokens for spatial methods -->
    <token name="@CMD_BIVARIATE_METRICS@"><![CDATA[
    #if str($method.local_name) != 'None':
    local_name='$method.local_name',
    #else:
    local_name=None,
    #end if
    #if str($method.global_name) != 'None':
    global_name='$method.global_name',
    #else:
    global_name=None,
    #end if
    ]]>
    </token>
    <token name="@CMD_BIVARIATE_OPTIONS@"><![CDATA[
    mask_negatives=$method.mask_negatives,
    add_categories=$method.add_categories,
    #if str($method.n_perms) != '':
    n_perms=$method.n_perms,
    #end if
    seed=$method.seed,
    nz_prop=$method.nz_prop,
    verbose=$method.verbose
    ]]>
    </token>
    <token name="@CMD_MISTY_SPATIAL@"><![CDATA[
    spatial_key='$method.spatial_key',
    set_diag=$method.set_diag,
    ]]>
    </token>
    <token name="@CMD_MISTY_KERNEL@"><![CDATA[
    kernel='$method.kernel',
    bandwidth=$method.bandwidth,
    zoi=$method.zoi,
    cutoff=$method.cutoff,
    ]]>
    </token>
    <token name="@CMD_MISTY_MODEL@"><![CDATA[
misty(model='$method.model', bypass_intra=$method.bypass_intra, seed=$method.seed, verbose=$method.verbose)
    ]]>
    </token>

    <!-- Plotting-specific parameter macros -->
    <xml name="param_uns_key">
        <param argument="uns_key" type="text" value="liana_res" label="Key for LIANA results" help="Key in adata.uns that contains the LIANA results.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_misty_key">
        <param name="misty_key" type="text" value="misty" label="Key for MISTy results" help="Key in adata.uns that contains the MISTy modelling results.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_plot_colour">
        <param argument="colour" type="text" value="" optional="true" label="Colour column" help="Column in liana_res to define the colours of the dots (e.g., 'magnitude_rank', 'specificity_rank', 'lr_means').">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_plot_size">
        <param argument="size" type="text" value="" optional="true" label="Size column" help="Column in liana_res to define the size of the dots (e.g., 'magnitude_rank', 'specificity_rank').">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_source_labels">
        <param argument="source_labels" type="text" value="" optional="true" label="Source labels" help="Comma-separated list of labels to use as source. The rest are filtered out.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_target_labels">
        <param argument="target_labels" type="text" value="" optional="true" label="Target labels" help="Comma-separated list of labels to use as target. The rest are filtered out.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_ligand_complex">
        <param argument="ligand_complex" type="text" value="" optional="true" label="Ligand complexes" help="Comma-separated list of ligand complexes to filter the interactions to be plotted.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_receptor_complex">
        <param argument="receptor_complex" type="text" value="" optional="true" label="Receptor complexes" help="Comma-separated list of receptor complexes to filter the interactions to be plotted.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_top_n">
        <param argument="top_n" type="integer" value="" optional="true" min="1" label="Top N interactions" help="Number of top interactions to plot. Leave empty to plot all."/>
    </xml>
    <xml name="param_orderby">
        <param argument="orderby" type="text" value="" optional="true" label="Order by column" help="If top_n is set, order the interactions by this column.">
            <expand macro="sanitize_query"/>
        </param>
    </xml>
    <xml name="param_orderby_ascending">
        <param argument="orderby_ascending" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Order ascending" help="If top_n is set, specify how to order the interactions."/>
    </xml>
    <xml name="param_orderby_absolute">
        <param argument="orderby_absolute" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Order by absolute value" help="If top_n is set, whether to order by the absolute value of the orderby column."/>
    </xml>
    <xml name="param_inverse_colour">
        <param argument="inverse_colour" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Inverse colour (-log10)" help="Whether to -log10 transform the colour column for plotting."/>
    </xml>
    <xml name="param_inverse_size">
        <param argument="inverse_size" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Inverse size (-log10)" help="Whether to -log10 transform the size column for plotting."/>
    </xml>
    <xml name="param_cmap">
        <param argument="cmap" type="select" label="Colormap">
            <option value="viridis" selected="true">viridis</option>
            <option value="plasma">plasma</option>
            <option value="inferno">inferno</option>
            <option value="magma">magma</option>
            <option value="cividis">cividis</option>
            <option value="Greys">Greys</option>
            <option value="Blues">Blues</option>
            <option value="Greens">Greens</option>
            <option value="Oranges">Oranges</option>
            <option value="Reds">Reds</option>
            <option value="YlOrBr">YlOrBr</option>
            <option value="YlOrRd">YlOrRd</option>
            <option value="OrRd">OrRd</option>
            <option value="PuRd">PuRd</option>
            <option value="RdPu">RdPu</option>
            <option value="BuPu">BuPu</option>
            <option value="GnBu">GnBu</option>
            <option value="PuBu">PuBu</option>
            <option value="YlGnBu">YlGnBu</option>
            <option value="PuBuGn">PuBuGn</option>
            <option value="BuGn">BuGn</option>
            <option value="YlGn">YlGn</option>
            <option value="PiYG">PiYG</option>
            <option value="PRGn">PRGn</option>
            <option value="BrBG">BrBG</option>
            <option value="PuOr">PuOr</option>
            <option value="RdGy">RdGy</option>
            <option value="RdBu">RdBu</option>
            <option value="RdBu_r">RdBu_r</option>
            <option value="RdYlBu">RdYlBu</option>
            <option value="RdYlGn">RdYlGn</option>
            <option value="Spectral">Spectral</option>
            <option value="coolwarm">coolwarm</option>
            <option value="bwr">bwr</option>
            <option value="seismic">seismic</option>
        </param>
    </xml>
    <xml name="param_size_range">
        <param name="size_range_min" type="integer" value="2" min="1" label="Size range minimum" help="Minimum dot size."/>
        <param name="size_range_max" type="integer" value="9" min="1" label="Size range maximum" help="Maximum dot size."/>
    </xml>
    <xml name="param_figure_size" token_width="8" token_height="6">
        <param name="figure_size_width" type="float" value="@WIDTH@" min="1" label="Figure width" help="Figure width in inches."/>
        <param name="figure_size_height" type="float" value="@HEIGHT@" min="1" label="Figure height" help="Figure height in inches."/>
    </xml>

    <!-- Plotting command tokens -->
    <token name="@CMD_PLOT_SOURCE_TARGET_LABELS@"><![CDATA[
    #if str($method.source_labels) != '':
    source_labels=[x.strip() for x in '$method.source_labels'.split(',')],
    #end if
    #if str($method.target_labels) != '':
    target_labels=[x.strip() for x in '$method.target_labels'.split(',')],
    #end if
    ]]>
    </token>
    <token name="@CMD_PLOT_LIGAND_RECEPTOR_COMPLEX@"><![CDATA[
    #if str($method.ligand_complex) != '':
    ligand_complex=[x.strip() for x in '$method.ligand_complex'.split(',')],
    #end if
    #if str($method.receptor_complex) != '':
    receptor_complex=[x.strip() for x in '$method.receptor_complex'.split(',')],
    #end if
    ]]>
    </token>
    <token name="@CMD_PLOT_TOP_N_ORDERBY@"><![CDATA[
    #if str($method.top_n) != '':
    top_n=$method.top_n,
    #end if
    #if str($method.orderby) != '':
    orderby='$method.orderby',
    #end if
    orderby_ascending=$method.orderby_ascending,
    orderby_absolute=$method.orderby_absolute,
    ]]>
    </token>

    <!-- command macros -->
    <xml name="version_command">
        <version_command><![CDATA[python -c "import liana as li;print('liana version: %s' % li.__version__)"]]></version_command>
    </xml>
    <token name="@CMD_PRETTIFY_STDOUT@"><![CDATA[
| sed -r '1 s|AnnData object with (.+) = (.*)\\s*|\\1: \\2|g' | sed "s|'||g"  | sed -r 's|^\\s*(.*):\\s(.*)|[\\1]\\n-    \\2|g' | sed 's|, |\\n-    |g'
    ]]>
    </token>
    <token name="@CMD_READ_INPUTS@"><![CDATA[
adata = sc.read_h5ad('anndata.h5ad')
    ]]>
    </token>
    <!-- ln -s doesn't work here because the output is overwritten to the same file -->
    <token name="@CMD@"><![CDATA[
cp '$adata' 'anndata.h5ad' &&
cat '$script_file' > '$hidden_output' &&
python '$script_file' >> '$hidden_output' &&
ls . >> '$hidden_output' &&
touch 'anndata_info.txt' &&
cat 'anndata_info.txt' @CMD_PRETTIFY_STDOUT@
    ]]>
    </token>
    <token name="@CMD_IMPORTS@"><![CDATA[
import liana as li
import scanpy as sc
import pandas as pd
    ]]>
    </token>
    <token name="@CMD_ANNDATA_WRITE_OUTPUTS@"><![CDATA[
adata.write_h5ad('anndata.h5ad', compression='gzip')
with open('anndata_info.txt','w', encoding='utf-8') as ainfo:
    print(adata, file=ainfo)
    ]]>
    </token>
</macros>
