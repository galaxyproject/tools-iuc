<tool id="liana_methods" name="Liana methods" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Ligand_receptor inference and local bivariate spatial metrics for single-cell or spatial data</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio_tools"/>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
@CMD@
      ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_IMPORTS@
@CMD_READ_INPUTS@

#if str($method.method) == 'rank_aggregate':
li.method.rank_aggregate(
    adata=adata,
    groupby='$method.groupby',
    #if str($method.resource_selection.resource_type) == 'interactions':
    interactions=[tuple(x.strip().split(',')) for x in '''$method.resource_selection.interactions'''.strip().split('\n') if x.strip()],
    #else if str($method.resource_selection.resource_type) == 'resource':
    resource=pd.read_csv('$method.resource_selection.resource', sep='\t'),
    #else:
    resource_name='$method.resource_selection.resource_name',
    #end if
    expr_prop=$method.expr_prop,
    min_cells=$method.min_cells,
    #if str($method.groupby_pairs.groupby_pairs_selector) == 'custom':
    groupby_pairs=pd.read_csv('$method.groupby_pairs.pairs_file', sep='\t'),
    #end if
    #if str($method.base) != '':
    base=$method.base,
    #end if
    aggregate_method='$method.aggregate_method',
    #if str($method.consensus_opts.consensus_opts_selector) == 'custom':
    consensus_opts=$method.consensus_opts.opts,
    #end if
    return_all_lrs=$method.return_all_lrs,
    #if str($method.key_added) != '':
    key_added='$method.key_added',
    #end if
    use_raw=$method.use_raw,
    #if str($method.layer) != '':
    layer='$method.layer',
    #end if
    de_method='$method.de_method',
    #if str($method.n_perms) != '':
    n_perms=$method.n_perms,
    #end if
    seed=$method.seed,
    verbose=False,
    inplace=True)

#else if str($method.method) == 'cellchat':
li.method.cellchat(
    adata=adata,
    groupby='$method.groupby',
    #if str($method.resource_selection.resource_type) == 'interactions':
    interactions=[tuple(x.strip().split(',')) for x in '''$method.resource_selection.interactions'''.strip().split('\n') if x.strip()],
    #else if str($method.resource_selection.resource_type) == 'resource':
    resource=pd.read_csv('$method.resource_selection.resource', sep='\t'),
    #else:
    resource_name='$method.resource_selection.resource_name',
    #end if
    expr_prop=$method.expr_prop,
    min_cells=$method.min_cells,
    return_all_lrs=$method.return_all_lrs,
    #if str($method.key_added) != '':
    key_added='$method.key_added',
    #end if
    use_raw=$method.use_raw,
    #if str($method.layer) != '':
    layer='$method.layer',
    #end if
    de_method='$method.de_method',
    #if str($method.n_perms) != '':
    n_perms=$method.n_perms,
    #end if
    seed=$method.seed,
    verbose=False,
    inplace=True)

#else if str($method.method) == 'cellphonedb':
li.method.cellphonedb(
    adata=adata,
    groupby='$method.groupby',
    #if str($method.resource_selection.resource_type) == 'interactions':
    interactions=[tuple(x.strip().split(',')) for x in '''$method.resource_selection.interactions'''.strip().split('\n') if x.strip()],
    #else if str($method.resource_selection.resource_type) == 'resource':
    resource=pd.read_csv('$method.resource_selection.resource', sep='\t'),
    #else:
    resource_name='$method.resource_selection.resource_name',
    #end if
    expr_prop=$method.expr_prop,
    min_cells=$method.min_cells,
    return_all_lrs=$method.return_all_lrs,
    #if str($method.key_added) != '':
    key_added='$method.key_added',
    #end if
    use_raw=$method.use_raw,
    #if str($method.layer) != '':
    layer='$method.layer',
    #end if
    de_method='$method.de_method',
    #if str($method.n_perms) != '':
    n_perms=$method.n_perms,
    #end if
    seed=$method.seed,
    verbose=False,
    inplace=True)

#else if str($method.method) == 'connectome':
li.method.connectome(
    adata=adata,
    groupby='$method.groupby',
    #if str($method.resource_selection.resource_type) == 'interactions':
    interactions=[tuple(x.strip().split(',')) for x in '''$method.resource_selection.interactions'''.strip().split('\n') if x.strip()],
    #else if str($method.resource_selection.resource_type) == 'resource':
    resource=pd.read_csv('$method.resource_selection.resource', sep='\t'),
    #else:
    resource_name='$method.resource_selection.resource_name',
    #end if
    expr_prop=$method.expr_prop,
    min_cells=$method.min_cells,
    return_all_lrs=$method.return_all_lrs,
    #if str($method.key_added) != '':
    key_added='$method.key_added',
    #end if
    use_raw=$method.use_raw,
    #if str($method.layer) != '':
    layer='$method.layer',
    #end if
    de_method='$method.de_method',
    seed=$method.seed,
    verbose=False,
    inplace=True)

#else if str($method.method) == 'natmi':
li.method.natmi(
    adata=adata,
    groupby='$method.groupby',
    #if str($method.resource_selection.resource_type) == 'interactions':
    interactions=[tuple(x.strip().split(',')) for x in '''$method.resource_selection.interactions'''.strip().split('\n') if x.strip()],
    #else if str($method.resource_selection.resource_type) == 'resource':
    resource=pd.read_csv('$method.resource_selection.resource', sep='\t'),
    #else:
    resource_name='$method.resource_selection.resource_name',
    #end if
    expr_prop=$method.expr_prop,
    min_cells=$method.min_cells,
    return_all_lrs=$method.return_all_lrs,
    #if str($method.key_added) != '':
    key_added='$method.key_added',
    #end if
    use_raw=$method.use_raw,
    #if str($method.layer) != '':
    layer='$method.layer',
    #end if
    de_method='$method.de_method',
    seed=$method.seed,
    verbose=False,
    inplace=True)

#else if str($method.method) == 'logfc':
li.method.logfc(
    adata=adata,
    groupby='$method.groupby',
    #if str($method.resource_selection.resource_type) == 'interactions':
    interactions=[tuple(x.strip().split(',')) for x in '''$method.resource_selection.interactions'''.strip().split('\n') if x.strip()],
    #else if str($method.resource_selection.resource_type) == 'resource':
    resource=pd.read_csv('$method.resource_selection.resource', sep='\t'),
    #else:
    resource_name='$method.resource_selection.resource_name',
    #end if
    expr_prop=$method.expr_prop,
    min_cells=$method.min_cells,
    #if str($method.base) != '':
    base=$method.base,
    #end if
    return_all_lrs=$method.return_all_lrs,
    #if str($method.key_added) != '':
    key_added='$method.key_added',
    #end if
    use_raw=$method.use_raw,
    #if str($method.layer) != '':
    layer='$method.layer',
    #end if
    de_method='$method.de_method',
    seed=$method.seed,
    verbose=False,
    inplace=True)

#else if str($method.method) == 'singlecellsignalr':
li.method.singlecellsignalr(
    adata=adata,
    groupby='$method.groupby',
    #if str($method.resource_selection.resource_type) == 'interactions':
    interactions=[tuple(x.strip().split(',')) for x in '''$method.resource_selection.interactions'''.strip().split('\n') if x.strip()],
    #else if str($method.resource_selection.resource_type) == 'resource':
    resource=pd.read_csv('$method.resource_selection.resource', sep='\t'),
    #else:
    resource_name='$method.resource_selection.resource_name',
    #end if
    expr_prop=$method.expr_prop,
    min_cells=$method.min_cells,
    return_all_lrs=$method.return_all_lrs,
    #if str($method.key_added) != '':
    key_added='$method.key_added',
    #end if
    use_raw=$method.use_raw,
    #if str($method.layer) != '':
    layer='$method.layer',
    #end if
    de_method='$method.de_method',
    seed=$method.seed,
    verbose=False,
    inplace=True)

#else if str($method.method) == 'geometric_mean':
li.method.geometric_mean(
    adata=adata,
    groupby='$method.groupby',
    #if str($method.resource_selection.resource_type) == 'interactions':
    interactions=[tuple(x.strip().split(',')) for x in '''$method.resource_selection.interactions'''.strip().split('\n') if x.strip()],
    #else if str($method.resource_selection.resource_type) == 'resource':
    resource=pd.read_csv('$method.resource_selection.resource', sep='\t'),
    #else:
    resource_name='$method.resource_selection.resource_name',
    #end if
    expr_prop=$method.expr_prop,
    min_cells=$method.min_cells,
    return_all_lrs=$method.return_all_lrs,
    #if str($method.key_added) != '':
    key_added='$method.key_added',
    #end if
    use_raw=$method.use_raw,
    #if str($method.layer) != '':
    layer='$method.layer',
    #end if
    de_method='$method.de_method',
    seed=$method.seed,
    verbose=False,
    inplace=True)
#end if

#if str($method.method) == 'bivariate':
result = li.method.bivariate(
    adata,
    #if str($method.local_name) != 'None':
    local_name='$method.local_name',
    #else:
    local_name=None,
    #end if
    #if str($method.global_name) != 'None':
    global_name='$method.global_name',
    #else:
    global_name=None,
    #end if
    #if str($method.resource_selection.resource_type) == 'interactions':
    interactions=[tuple(x.strip().split(',')) for x in '''$method.resource_selection.interactions'''.strip().split('\n') if x.strip()],
    #else if str($method.resource_selection.resource_type) == 'resource':
    resource=pd.read_csv('$method.resource_selection.resource', sep='\t'),
    #else:
    resource_name='$method.resource_selection.resource_name',
    #end if
    connectivity_key='$method.connectivity_key',
    mask_negatives=$method.mask_negatives,
    add_categories=$method.add_categories,
    #if str($method.n_perms) != '':
    n_perms=$method.n_perms,
    #end if
    use_raw=$method.use_raw,
    seed=$method.seed,
    nz_prop=$method.nz_prop,
    verbose=False)
if result is not None:
    adata.uns['liana_bivariate'] = result
#end if

@CMD_ANNDATA_WRITE_OUTPUTS@
        ]]>
        </configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <conditional name="method">
            <param argument="method" type="select" label="Method for ligand-receptor inference">
                <option value="cellchat">CellChat method (cellchat)</option>
                <option value="cellphonedb">CellPhoneDB method (cellphonedb)</option>
                <option value="connectome">Connectome method (connectome)</option>
                <option value="natmi">NATMI method (natmi)</option>
                <option value="logfc">Log fold change method (logfc)</option>
                <option value="singlecellsignalr">SingleCellSignalR method (singlecellsignalr)</option>
                <option value="geometric_mean">Geometric mean method (geometric_mean)</option>
                <option value="rank_aggregate">Aggregate ligand-receptor scores from multiple methods (rank_aggregate)</option>
                <option value="bivariate">A method for bivariate local spatial metrics</option>
            </param>
            <when value="rank_aggregate">
                <expand macro="params_common_basic"/>
                <conditional name="groupby_pairs">
                    <param name="groupby_pairs_selector" type="select" label="Subset cell type pairs">
                        <option value="all" selected="true">Use all possible combinations</option>
                        <option value="custom">Provide custom pairs</option>
                    </param>
                    <when value="all"/>
                    <when value="custom">
                        <param name="pairs_file" type="data" format="tabular" label="Cell type pairs file" help="A tabular file with 'source' and 'target' columns to subset interacting cell types."/>
                    </when>
                </conditional>
                <expand macro="param_base"/>
                <param argument="aggregate_method" type="select" label="Aggregation method">
                    <option value="rra" selected="true">RobustRankAggregate (rra)</option>
                    <option value="mean">Mean rank (mean)</option>
                </param>
                <conditional name="consensus_opts">
                    <param name="consensus_opts_selector" type="select" label="Consensus options">
                        <option value="default" selected="true">Default (Specificity and Magnitude)</option>
                        <option value="custom">Custom</option>
                    </param>
                    <when value="default"/>
                    <when value="custom">
                        <param name="opts" type="select" multiple="true" label="Strategies to aggregate interactions">
                            <option value="Specificity">Specificity</option>
                            <option value="Magnitude">Magnitude</option>
                        </param>
                    </when>
                </conditional>
                <expand macro="params_common_output"/>
                <expand macro="param_de_method"/>
                <expand macro="param_n_perms"/>
                <expand macro="param_seed"/>
            </when>
            <when value="cellchat">
                <expand macro="params_lr_method_with_perms"/>
            </when>
            <when value="cellphonedb">
                <expand macro="params_lr_method_with_perms"/>
            </when>
            <when value="connectome">
                <expand macro="params_lr_method_basic"/>
            </when>
            <when value="natmi">
                <expand macro="params_lr_method_basic"/>
            </when>
            <when value="logfc">
                <expand macro="params_common_basic"/>
                <expand macro="param_base"/>
                <expand macro="params_common_output"/>
                <expand macro="param_de_method"/>
                <expand macro="param_seed"/>
            </when>
            <when value="singlecellsignalr">
                <expand macro="params_lr_method_basic"/>
            </when>
            <when value="geometric_mean">
                <expand macro="params_lr_method_basic"/>
            </when>
            <when value="bivariate">
                <param argument="local_name" type="select" label="Local spatial metric" help="Metric for computing local (cell/spot-level) spatial associations with weighted neighbors. cosine: directional similarity; pearson/spearman: correlation-based; morans: spatial autocorrelation. None: skip local metrics.">
                    <option value="cosine" selected="true">cosine - Directional similarity</option>
                    <option value="jaccard">jaccard - Overlap-based similarity</option>
                    <option value="pearson">pearson - Correlation (parametric)</option>
                    <option value="spearman">spearman - Correlation (non-parametric)</option>
                    <option value="masked_spearman">masked_spearman - Robust Spearman</option>
                    <option value="product">product - Simple weighted product</option>
                    <option value="norm_product">norm_product - Normalized product</option>
                    <option value="morans">morans - Moran's I (spatial autocorrelation)</option>
                    <option value="None">None - Only global metrics</option>
                </param>
                <param argument="global_name" type="select" label="Global spatial metric" help="Tissue-level metric for overall spatial association. Moran's I: univariate spatial clustering; Lee's L: bivariate L-R association. None: skip global metrics (faster).">
                    <option value="None" selected="true">None - Skip global metrics</option>
                    <option value="morans">morans - Moran's I (spatial clustering)</option>
                    <option value="lee">lee - Lee's L (bivariate association)</option>
                </param>
                <expand macro="param_resource_selection"/>
                <param argument="connectivity_key" type="text" value="spatial_connectivities" label="Spatial connectivity matrix key" help="Key in adata.obsp containing the spatial connectivity/adjacency matrix. Usually created by scanpy.pp.neighbors with spatial coordinates. Default: 'spatial_connectivities'.">
                    <expand macro="sanitize_query"/>
                </param>
                <param argument="use_raw" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Use raw counts" help="If enabled: use adata.raw.X (raw/unprocessed counts). If disabled: use adata.X (processed/normalized expression). Default: enabled."/>
                <param argument="mask_negatives" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Exclude negative interactions" help="If enabled: mask low-low scores and uncategorized interactions. Useful for focusing on positive spatial associations."/>
                <param argument="add_categories" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Add spatial categories" help="If enabled: add categorical scores (e.g., high-high, high-low) based on local bivariate statistics for easier interpretation."/>
                <expand macro="param_n_perms"/>
                <expand macro="param_seed"/>
                <param argument="nz_prop" type="float" value="0.05" min="0" max="1" label="Minimum non-zero proportion" help="Minimum fraction of cells where both ligand and receptor are non-zero (0-1). Default: 0.05 (5%). Filters out sparse L-R pairs."/>
            </when>
        </conditional>
        <expand macro="inputs_common_advanced"/>
    </inputs>
    <outputs>
        <expand macro="anndata_outputs"/>
    </outputs>
    <tests>
        <!-- Test 1: rank_aggregate with default parameters -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/pbmc_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="rank_aggregate"/>
                <param name="groupby" value="louvain"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="expr_prop" value="0.1"/>
                <param name="min_cells" value="5"/>
                <param name="aggregate_method" value="rra"/>
                <param name="return_all_lrs" value="false"/>
                <param name="use_raw" value="false"/>
                <param name="de_method" value="t-test"/>
                <param name="n_perms" value="10"/>
                <param name="seed" value="1337"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.rank_aggregate"/>
                    <has_text_matching expression="groupby='louvain'"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="1400000" delta="100000"/>
                    <has_h5_keys keys="uns/liana_res"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: cellphonedb method -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/pbmc_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="cellphonedb"/>
                <param name="groupby" value="louvain"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="expr_prop" value="0.1"/>
                <param name="min_cells" value="5"/>
                <param name="return_all_lrs" value="false"/>
                <param name="use_raw" value="false"/>
                <param name="de_method" value="t-test"/>
                <param name="n_perms" value="10"/>
                <param name="seed" value="1337"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.cellphonedb"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="1500000" delta="100000"/>
                    <has_h5_keys keys="uns/liana_res"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: natmi method -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/pbmc_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="natmi"/>
                <param name="groupby" value="louvain"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="expr_prop" value="0.1"/>
                <param name="min_cells" value="5"/>
                <param name="return_all_lrs" value="false"/>
                <param name="use_raw" value="false"/>
                <param name="de_method" value="t-test"/>
                <param name="seed" value="1337"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.natmi"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="1500000" delta="100000"/>
                    <has_h5_keys keys="uns/liana_res"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 4: connectome method -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/pbmc_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="connectome"/>
                <param name="groupby" value="louvain"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="expr_prop" value="0.1"/>
                <param name="min_cells" value="5"/>
                <param name="return_all_lrs" value="false"/>
                <param name="use_raw" value="false"/>
                <param name="de_method" value="t-test"/>
                <param name="seed" value="1337"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.connectome"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="1500000" delta="100000"/>
                    <has_h5_keys keys="uns/liana_res"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 5: logfc method -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/pbmc_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="logfc"/>
                <param name="groupby" value="louvain"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="expr_prop" value="0.1"/>
                <param name="min_cells" value="5"/>
                <param name="return_all_lrs" value="false"/>
                <param name="use_raw" value="false"/>
                <param name="de_method" value="t-test"/>
                <param name="seed" value="1337"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.logfc"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="1500000" delta="100000"/>
                    <has_h5_keys keys="uns/liana_res"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 6: singlecellsignalr method -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/pbmc_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="singlecellsignalr"/>
                <param name="groupby" value="louvain"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="expr_prop" value="0.1"/>
                <param name="min_cells" value="5"/>
                <param name="return_all_lrs" value="false"/>
                <param name="use_raw" value="false"/>
                <param name="de_method" value="t-test"/>
                <param name="seed" value="1337"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.singlecellsignalr"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="1500000" delta="100000"/>
                    <has_h5_keys keys="uns/liana_res"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 7: geometric_mean method -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/pbmc_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="geometric_mean"/>
                <param name="groupby" value="louvain"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="expr_prop" value="0.1"/>
                <param name="min_cells" value="5"/>
                <param name="return_all_lrs" value="false"/>
                <param name="use_raw" value="false"/>
                <param name="de_method" value="t-test"/>
                <param name="seed" value="1337"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.geometric_mean"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="1500000" delta="100000"/>
                    <has_h5_keys keys="uns/liana_res"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 8: cellchat method -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/pbmc_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="cellchat"/>
                <param name="groupby" value="louvain"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="expr_prop" value="0.1"/>
                <param name="min_cells" value="5"/>
                <param name="return_all_lrs" value="false"/>
                <param name="use_raw" value="false"/>
                <param name="de_method" value="t-test"/>
                <param name="n_perms" value="10"/>
                <param name="seed" value="1337"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.cellchat"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="1500000" delta="300000"/>
                    <has_h5_keys keys="uns/liana_res"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 9: rank_aggregate with custom key_added -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/pbmc_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="rank_aggregate"/>
                <param name="groupby" value="louvain"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="cellphonedb"/>
                </conditional>
                <param name="expr_prop" value="0.05"/>
                <param name="min_cells" value="3"/>
                <param name="aggregate_method" value="mean"/>
                <param name="return_all_lrs" value="true"/>
                <param name="key_added" value="custom_liana"/>
                <param name="use_raw" value="false"/>
                <param name="de_method" value="wilcoxon"/>
                <param name="n_perms" value="5"/>
                <param name="seed" value="42"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.rank_aggregate"/>
                    <has_text_matching expression="key_added='custom_liana'"/>
                    <has_text_matching expression="aggregate_method='mean'"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="896900" delta="100000"/>
                    <has_h5_keys keys="uns/custom_liana"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 10: bivariate with cosine local metric -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/spatial_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="bivariate"/>
                <param name="local_name" value="cosine"/>
                <param name="global_name" value="None"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="connectivity_key" value="spatial_connectivities"/>
                <param name="use_raw" value="false"/>
                <param name="mask_negatives" value="false"/>
                <param name="add_categories" value="false"/>
                <param name="seed" value="1337"/>
                <param name="nz_prop" value="0.05"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.bivariate"/>
                    <has_text_matching expression="local_name='cosine'"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="260600" delta="200000"/>
                    <has_h5_keys keys="obsm/spatial"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 11: bivariate with pearson local metric and morans global -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/spatial_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="bivariate"/>
                <param name="local_name" value="pearson"/>
                <param name="global_name" value="morans"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="connectivity_key" value="spatial_connectivities"/>
                <param name="use_raw" value="false"/>
                <param name="mask_negatives" value="false"/>
                <param name="add_categories" value="true"/>
                <param name="n_perms" value="5"/>
                <param name="seed" value="42"/>
                <param name="nz_prop" value="0.1"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.bivariate"/>
                    <has_text_matching expression="local_name='pearson'"/>
                    <has_text_matching expression="global_name='morans'"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="275300" delta="100000"/>
                    <has_h5_keys keys="obsm/spatial"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 12: bivariate with jaccard metric -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/spatial_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="bivariate"/>
                <param name="local_name" value="jaccard"/>
                <param name="global_name" value="None"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="connectivity_key" value="spatial_connectivities"/>
                <param name="use_raw" value="false"/>
                <param name="mask_negatives" value="true"/>
                <param name="add_categories" value="false"/>
                <param name="seed" value="1337"/>
                <param name="nz_prop" value="0.05"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.bivariate"/>
                    <has_text_matching expression="local_name='jaccard'"/>
                    <has_text_matching expression="mask_negatives=True"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad" >
                <assert_contents>
                    <has_size size="252100" delta="100000"/>
                    <has_h5_keys keys="obsm/spatial"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 13: bivariate with product metric -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/spatial_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="bivariate"/>
                <param name="local_name" value="product"/>
                <param name="global_name" value="lee"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="connectivity_key" value="spatial_connectivities"/>
                <param name="use_raw" value="false"/>
                <param name="mask_negatives" value="false"/>
                <param name="add_categories" value="false"/>
                <param name="seed" value="1337"/>
                <param name="nz_prop" value="0.05"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.bivariate"/>
                    <has_text_matching expression="local_name='product'"/>
                    <has_text_matching expression="global_name='lee'"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="266000" delta="100000"/>
                    <has_h5_keys keys="obsm/spatial"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 14: bivariate with spearman metric -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/spatial_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="bivariate"/>
                <param name="local_name" value="spearman"/>
                <param name="global_name" value="None"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="connectivity_key" value="spatial_connectivities"/>
                <param name="use_raw" value="false"/>
                <param name="mask_negatives" value="false"/>
                <param name="add_categories" value="false"/>
                <param name="seed" value="1337"/>
                <param name="nz_prop" value="0.05"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.bivariate"/>
                    <has_text_matching expression="local_name='spearman'"/>
                </assert_contents>
            </output>
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_size size="262900" delta="100000"/>
                    <has_h5_keys keys="obsm/spatial"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
Liana Single Cell Ligand-Receptor Methods
=========================================

This tool wraps the single-cell ligand-receptor inference methods from LIANA (LIgand-receptor ANalysis frAmework).

Available Methods
-----------------

**rank_aggregate**
    Get an aggregate of ligand-receptor scores from multiple methods using RobustRankAggregate or mean rank.

**cellchat**
    Run the CellChat ligand-receptor method.

**cellphonedb**
    Run the CellPhoneDB ligand-receptor method with permutation testing.

**connectome**
    Run the Connectome ligand-receptor method.

**natmi**
    Run the NATMI (Network Analysis Toolkit for Multicellular Interactions) method.

**logfc**
    Run the log fold change ligand-receptor method.

**singlecellsignalr**
    Run the SingleCellSignalR ligand-receptor method.

**geometric_mean**
    Run the geometric mean ligand-receptor method.

**bivariate**
    Compute local bivariate metrics for spatial ligand-receptor analysis.
    Supports various local metrics (cosine, jaccard, pearson, spearman, product)
    and global metrics (Moran's I, Geary's C, Lee's L).


Common Parameters
-----------------

**groupby**
    Key in adata.obs to be used for grouping cells (e.g., cell type annotation).

**Resource Selection (hierarchy: interactions > resource > resource_name)**
    There are three ways to specify ligand-receptor pairs, with the following priority:
    
    1. **interactions** (highest priority): Provide specific ligand-receptor pairs as a list.
       Format: one pair per line as "ligand,receptor" (e.g., "TGFB1,TGFBR1").
       If provided, this overrides both resource and resource_name.
    
    2. **resource** (medium priority): Provide a custom tabular file with 'ligand' and 'receptor' columns.
       If provided, this overrides resource_name.
    
    3. **resource_name** (lowest priority, default): Use a built-in resource by name.
       Default is 'consensus'. Use `li.rs.show_resources()` to see available resources.

**expr_prop**
    Minimum expression proportion for ligands and receptors in corresponding cell identities.
    Set to 0 to return unfiltered results.

**min_cells**
    Minimum number of cells per cell identity to be considered for analysis.

**use_raw**
    Whether to use the raw attribute of adata if present.

**layer**
    Layer in adata.layers to use. If None, uses adata.X.

**de_method**
    Differential expression method for ranking genes. Default is 't-test'.

**n_perms**
    Number of permutations for permutation testing (relevant for CellPhoneDB-like methods).

**seed**
    Random seed for reproducibility.

Output
------

Results are stored in `adata.uns['liana_res']` (or custom key_added) as a DataFrame with ligand-receptor interaction scores.

    ]]></help>
    <expand macro="citations"/>
</tool>
