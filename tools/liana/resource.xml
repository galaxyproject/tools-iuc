<tool id="liana_resource" name="Liana Resource" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>prior knowledge and ligand-receptor resources</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio_tools"/>
    <expand macro="creators"/>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
cat '$script_file' > '$hidden_output' &&
python '$script_file' >> '$hidden_output' 2>&1
    ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_IMPORTS@

#if str($method.method) == 'select_resource'
#if str($method.resource_api_cached.resource_source_selector) == 'cached'
# Cached: read from Data Manager path (path is directory, file is path/value.tsv)
import os
resource_path = '$method.resource_api_cached.resource_cached.fields.path'
resource_value = '$method.resource_api_cached.resource_cached.fields.value'
tsv_path = os.path.join(resource_path, resource_value + '.tsv')
resource = pd.read_csv(tsv_path, sep='\t')
#else
resource = li.resource.select_resource(resource_name='$method.resource_api_cached.resource_name')
#end if
resource.to_csv('resource_output.tsv', sep='\t', index=False)

#else if str($method.method) == 'show_resources'
resources = li.resource.show_resources()
with open('resources_list.txt', 'w') as f:
    for r in resources:
        f.write(r + '\n')

#else if str($method.method) == 'get_metalinks'
metalinks = li.resource.get_metalinks(
#if str($method.biospecimen_location) != ''
    biospecimen_location='$method.biospecimen_location'.split(','),
#end if
#if str($method.source) != ''
    source='$method.source'.split(','),
#end if
    hmdb=$method.hmdb,
    uniprot=$method.uniprot)
metalinks.to_csv('metalinks.tsv', sep='\t', index=False)

#else if str($method.method) == 'get_hcop_orthologs'
#if str($method.url) == 'custom':
hcop_url = '$method.custom_url'
#else:
hcop_url = '$method.url'
#end if
orthologs = li.resource.get_hcop_orthologs(
    url=hcop_url,
    min_evidence=$method.min_evidence)
orthologs.to_csv('orthologs.tsv', sep='\t', index=False)

#else if str($method.method) == 'translate_resource'
#if str($method.resource_input.resource_source) == 'builtin':
#if str($method.resource_input.resource_api_cached.resource_source_selector) == 'cached'
import os
resource_path = '$method.resource_input.resource_api_cached.resource_cached.fields.path'
resource_value = '$method.resource_input.resource_api_cached.resource_cached.fields.value'
tsv_path = os.path.join(resource_path, resource_value + '.tsv')
resource = pd.read_csv(tsv_path, sep='\t')
#else
resource = li.resource.select_resource(resource_name='$method.resource_input.resource_api_cached.resource_name')
#end if
#else:
resource = pd.read_csv('$method.resource_input.resource_file', sep='\t')
#end if
map_df = pd.read_csv('$method.map_df', sep='\t')
translated = li.resource.translate_resource(
    resource=resource,
    map_df=map_df,
    columns='$method.columns'.split(',') if '$method.columns' else None)
translated.to_csv('translated_resource.tsv', sep='\t', index=False)

#end if
        ]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="method">
            <param name="method" type="select" label="Method">
                <option value="select_resource" selected="true">select_resource - Get ligand-receptor resource</option>
                <option value="show_resources">show_resources - List available resources</option>
                <option value="get_metalinks">get_metalinks - Get metabolite-protein interactions</option>
                <option value="get_hcop_orthologs">get_hcop_orthologs - Get ortholog mappings from HCOP</option>
                <option value="translate_resource">translate_resource - Translate resource to another species</option>
            </param>
            <when value="select_resource">
                <expand macro="param_resource_select_cached"/>
            </when>
            <when value="show_resources">
                <!-- No parameters needed -->
            </when>
            <when value="get_metalinks">
                <param argument="biospecimen_location" type="text" value="" optional="true" label="Biospecimen locations" help="Comma-separated biospecimen types to filter (e.g., Blood,Urine,Plasma). Empty = all locations. Limits metabolite-protein interactions by tissue/sample origin.">
                    <expand macro="sanitize_query"/>
                </param>
                <param argument="source" type="text" value="" optional="true" label="Source databases" help="Comma-separated database names to filter metabolite annotations (e.g., HMDB,Drugbank). Empty = all sources.">
                    <expand macro="sanitize_query"/>
                </param>
                <param argument="hmdb" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Include HMDB IDs" help="If enabled: include HMDB metabolite identifiers in output."/>
                <param argument="uniprot" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Include UniProt IDs" help="If enabled: include UniProt protein identifiers in output."/>
            </when>
            <when value="get_hcop_orthologs">
                <param argument="url" type="select" label="Species mapping">
                    <option value="https://ftp.ebi.ac.uk/pub/databases/genenames/hcop/human_mouse_hcop_fifteen_column.txt.gz" selected="true">Human to Mouse</option>
                    <option value="https://ftp.ebi.ac.uk/pub/databases/genenames/hcop/human_rat_hcop_fifteen_column.txt.gz">Human to Rat</option>
                    <option value="https://ftp.ebi.ac.uk/pub/databases/genenames/hcop/human_chicken_hcop_fifteen_column.txt.gz">Human to Chicken</option>
                    <option value="https://ftp.ebi.ac.uk/pub/databases/genenames/hcop/human_zebrafish_hcop_fifteen_column.txt.gz">Human to Zebrafish</option>
                    <option value="custom">Custom URL</option>
                </param>
                <param name="custom_url" type="text" value="" optional="true" label="Custom HCOP URL" help="Only used if 'Custom URL' is selected above. See https://ftp.ebi.ac.uk/pub/databases/genenames/hcop/ for available files.">
                    <expand macro="sanitize_query"/>
                </param>
                <param argument="min_evidence" type="integer" value="3" min="1" label="Minimum evidence" help="Minimum number of orthology resources supporting the interaction."/>
            </when>
            <when value="translate_resource">
                <conditional name="resource_input">
                    <param name="resource_source" type="select" label="Resource source">
                        <option value="builtin" selected="true">Built-in resource</option>
                        <option value="file">Custom resource file</option>
                    </param>
                    <when value="builtin">
                        <expand macro="param_resource_select_cached"/>
                    </when>
                    <when value="file">
                        <param name="resource_file" type="data" format="tabular" label="Resource file" help="Tabular file with ligand and receptor columns"/>
                    </when>
                </conditional>
                <param name="map_df" type="data" format="tabular" label="Ortholog mapping file" help="Tabular file with 'source' and 'target' columns for ortholog mappings. Can be generated with get_hcop_orthologs."/>
                <param argument="columns" type="text" value="ligand,receptor" label="Columns to translate" help="Comma-separated list of column names to translate (e.g., ligand,receptor).">
                    <expand macro="sanitize_query"/>
                </param>
            </when>
        </conditional>
        <expand macro="inputs_common_advanced"/>
    </inputs>
    <outputs>
        <data name="resource_out" format="tabular" from_work_dir="resource_output.tsv" label="${tool.name} (${method.method}) on ${on_string}: Resource">
            <filter>method['method'] == 'select_resource'</filter>
        </data>
        <data name="resources_list_out" format="txt" from_work_dir="resources_list.txt" label="${tool.name} (${method.method}): Available resources">
            <filter>method['method'] == 'show_resources'</filter>
        </data>
        <data name="metalinks_out" format="tabular" from_work_dir="metalinks.tsv" label="${tool.name} (${method.method}): Metalinks">
            <filter>method['method'] == 'get_metalinks'</filter>
        </data>
        <data name="orthologs_out" format="tabular" from_work_dir="orthologs.tsv" label="${tool.name} (${method.method}): Ortholog mappings">
            <filter>method['method'] == 'get_hcop_orthologs'</filter>
        </data>
        <data name="translated_out" format="tabular" from_work_dir="translated_resource.tsv" label="${tool.name} (${method.method}): Translated resource">
            <filter>method['method'] == 'translate_resource'</filter>
        </data>
        <data name="hidden_output" format="txt" label="Log file">
            <filter>advanced_common['show_log']</filter>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: select_resource with cached DB (no download) -->
        <test expect_num_outputs="2">
            <conditional name="method">
                <param name="method" value="select_resource"/>
                <conditional name="resource_api_cached">
                    <param name="resource_source_selector" value="cached"/>
                    <param name="resource_cached" value="consensus"/>
                </conditional>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="resource_out" ftype="tabular">
                <assert_contents>
                    <has_text text="ligand"/>
                    <has_text text="receptor"/>
                    <has_n_columns n="2"/>
                    <has_text_matching expression="LGALS9\s+PTPRC" />
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="pd.read_csv"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: select_resource from LIANA API (downloads) -->
        <test expect_num_outputs="2">
            <conditional name="method">
                <param name="method" value="select_resource"/>
                <conditional name="resource_api_cached">
                    <param name="resource_source_selector" value="builtin"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="resource_out" location="https://zenodo.org/records/18388645/files/resource_consensus.tsv" ftype="tabular">
                <assert_contents>
                    <has_text text="ligand"/>
                    <has_text text="receptor"/>
                    <has_n_columns n="2"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.resource.select_resource"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: show_resources -->
        <test expect_num_outputs="2">
            <conditional name="method">
                <param name="method" value="show_resources"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="resources_list_out" location="https://zenodo.org/records/18388645/files/resources_list.txt" ftype="txt">
                <assert_contents>
                    <has_text text="consensus"/>
                    <has_text text="cellphonedb"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.resource.show_resources"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 4: get_hcop_orthologs -->
        <test expect_num_outputs="2">
            <conditional name="method">
                <param name="method" value="get_hcop_orthologs"/>
                <param name="url" value="https://ftp.ebi.ac.uk/pub/databases/genenames/hcop/human_mouse_hcop_fifteen_column.txt.gz"/>
                <param name="min_evidence" value="3"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="orthologs_out" ftype="tabular">
                <assert_contents>
                    <has_text text="human_symbol"/>
                    <has_n_columns min="2"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.resource.get_hcop_orthologs"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 5: translate_resource with cached resource -->
        <test expect_num_outputs="2">
            <conditional name="method">
                <param name="method" value="translate_resource"/>
                <conditional name="resource_input">
                    <param name="resource_source" value="builtin"/>
                    <conditional name="resource_api_cached">
                        <param name="resource_source_selector" value="cached"/>
                        <param name="resource_cached" value="consensus"/>
                    </conditional>
                </conditional>
                <param name="map_df" value="ortholog_map.tsv" ftype="tabular"/>
                <param name="columns" value="ligand,receptor"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="translated_out" ftype="tabular">
                <assert_contents>
                    <has_text text="ligand"/>
                    <has_text text="receptor"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="translate_resource"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 6: translate_resource with built-in (downloads) -->
        <test expect_num_outputs="2">
            <conditional name="method">
                <param name="method" value="translate_resource"/>
                <conditional name="resource_input">
                    <param name="resource_source" value="builtin"/>
                    <conditional name="resource_api_cached">
                        <param name="resource_source_selector" value="builtin"/>
                        <param name="resource_name" value="consensus"/>
                    </conditional>
                </conditional>
                <param name="map_df" location="https://zenodo.org/records/18388645/files/ortholog_map.tsv"/>
                <param name="columns" value="ligand,receptor"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="translated_out" ftype="tabular">
                <assert_contents>
                    <has_text text="ligand"/>
                    <has_text text="receptor"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.resource.translate_resource"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

This tool provides access to prior knowledge resources from LIANA+ for ligand-receptor interaction analysis.

**Methods**

- **select_resource**: Load a pre-defined ligand-receptor resource. Available resources include consensus, cellphonedb, cellchat, connectome, and more.

- **show_resources**: List all available built-in ligand-receptor resources.

- **generate_lr_geneset**: Generate a gene set from ligand-receptor pairs for use in enrichment analysis.

- **get_metalinks**: Retrieve metabolite-protein interaction data from the Metalinks database. Useful for metabolite-mediated cell-cell communication analysis.

- **get_hcop_orthologs**: Download ortholog mappings from the HCOP (HGNC Comparison of Orthology Predictions) database. Supports human-mouse, human-rat, human-chicken, and human-zebrafish mappings. Use this to translate human resources to other species.

- **translate_resource**: Translate a ligand-receptor resource from one species to another using ortholog mappings. Requires an ortholog mapping file (can be generated with get_hcop_orthologs).

**Available Resources**

The following ligand-receptor resources are available:
- consensus (default): Consensus resource combining multiple databases
- cellphonedb: CellPhoneDB resource
- cellchat: CellChat resource
- connectome: Connectome resource
- natmi: NATMI resource
- And more...

**Outputs**

- Tabular files with ligand-receptor pairs or resource information
- Text file listing available resources (for show_resources)
    ]]></help>
    <expand macro="citations"/>
</tool>
