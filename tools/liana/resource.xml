<tool id="liana_resource" name="Liana Resource" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>prior knowledge and ligand-receptor resources</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio_tools"/>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
@CMD@
    ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_IMPORTS@

#if str($method.method) == 'select_resource'
resource = li.resource.select_resource(resource_name='$method.resource_name')
resource.to_csv('resource_output.tsv', sep='\t', index=False)

#else if str($method.method) == 'show_resources'
resources = li.resource.show_resources()
with open('resources_list.txt', 'w') as f:
    for r in resources:
        f.write(r + '\n')

#else if str($method.method) == 'generate_lr_geneset'
geneset = li.resource.generate_lr_geneset(
    resource_name='$method.resource_name',
    lr_sep='$method.lr_sep')
geneset.to_csv('lr_geneset.tsv', sep='\t', index=False)

#else if str($method.method) == 'explode_complexes'
#if str($method.resource_input.resource_source) == 'builtin'
resource = li.resource.select_resource(resource_name='$method.resource_input.resource_name')
#else
resource = pd.read_csv('$method.resource_input.resource_file', sep='\t')
#end if
exploded = li.resource.explode_complexes(
    resource=resource,
    SOURCE='$method.source_col',
    TARGET='$method.target_col')
exploded.to_csv('exploded_resource.tsv', sep='\t', index=False)

#else if str($method.method) == 'get_metalinks'
metalinks = li.resource.get_metalinks(
#if str($method.biospecimen_location) != ''
    biospecimen_location='$method.biospecimen_location'.split(','),
#end if
#if str($method.source) != ''
    source='$method.source'.split(','),
#end if
    hmdb=$method.hmdb,
    uniprot=$method.uniprot)
metalinks.to_csv('metalinks.tsv', sep='\t', index=False)

#else if str($method.method) == 'describe_metalinks'
description = li.resource.describe_metalinks()
description.to_csv('metalinks_description.tsv', sep='\t', index=True)

#end if
        ]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="method">
            <param name="method" type="select" label="Method">
                <option value="select_resource" selected="true">select_resource - Get ligand-receptor resource</option>
                <option value="show_resources">show_resources - List available resources</option>
                <option value="generate_lr_geneset">generate_lr_geneset - Generate LR gene set</option>
                <option value="explode_complexes">explode_complexes - Explode LR complexes to subunits</option>
                <option value="get_metalinks">get_metalinks - Get metabolite-protein interactions</option>
                <option value="describe_metalinks">describe_metalinks - Describe metalinks database</option>
            </param>
            <when value="select_resource">
                <expand macro="param_resource_name"/>
            </when>
            <when value="show_resources">
                <!-- No parameters needed -->
            </when>
            <when value="generate_lr_geneset">
                <expand macro="param_resource_name"/>
                <param argument="lr_sep" type="text" value="^" label="Ligand-receptor separator" help="Character separating ligand and receptor names in gene set identifiers">
                    <expand macro="sanitize_query"/>
                </param>
            </when>
            <when value="explode_complexes">
                <conditional name="resource_input">
                    <param name="resource_source" type="select" label="Resource source">
                        <option value="builtin" selected="true">Built-in resource</option>
                        <option value="file">Custom resource file</option>
                    </param>
                    <when value="builtin">
                        <expand macro="param_resource_name"/>
                    </when>
                    <when value="file">
                        <param name="resource_file" type="data" format="tabular" label="Resource file" help="Tabular file with ligand and receptor columns"/>
                    </when>
                </conditional>
                <param argument="source_col" type="text" value="ligand" label="Ligand column name" help="Column in resource containing ligand/source names">
                    <expand macro="sanitize_query"/>
                </param>
                <param argument="target_col" type="text" value="receptor" label="Receptor column name" help="Column in resource containing receptor/target names">
                    <expand macro="sanitize_query"/>
                </param>
            </when>
            <when value="get_metalinks">
                <param argument="biospecimen_location" type="text" value="" optional="true" label="Biospecimen locations" help="Comma-separated biospecimen types to filter (e.g., Blood,Urine,Plasma). Empty = all locations. Limits metabolite-protein interactions by tissue/sample origin.">
                    <expand macro="sanitize_query"/>
                </param>
                <param argument="source" type="text" value="" optional="true" label="Source databases" help="Comma-separated database names to filter metabolite annotations (e.g., HMDB,Drugbank). Empty = all sources.">
                    <expand macro="sanitize_query"/>
                </param>
                <param argument="hmdb" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Include HMDB IDs" help="If enabled: include HMDB metabolite identifiers in output."/>
                <param argument="uniprot" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Include UniProt IDs" help="If enabled: include UniProt protein identifiers in output."/>
            </when>
            <when value="describe_metalinks">
                <!-- No parameters needed -->
            </when>
        </conditional>
        <expand macro="inputs_common_advanced"/>
    </inputs>
    <outputs>
        <data name="resource_out" format="tabular" from_work_dir="resource_output.tsv" label="${tool.name} (${method.method}) on ${on_string}: Resource">
            <filter>method['method'] == 'select_resource'</filter>
        </data>
        <data name="resources_list_out" format="txt" from_work_dir="resources_list.txt" label="${tool.name} (${method.method}): Available resources">
            <filter>method['method'] == 'show_resources'</filter>
        </data>
        <data name="geneset_out" format="tabular" from_work_dir="lr_geneset.tsv" label="${tool.name} (${method.method}) on ${on_string}: LR gene set">
            <filter>method['method'] == 'generate_lr_geneset'</filter>
        </data>
        <data name="exploded_out" format="tabular" from_work_dir="exploded_resource.tsv" label="${tool.name} (${method.method}) on ${on_string}: Exploded resource">
            <filter>method['method'] == 'explode_complexes'</filter>
        </data>
        <data name="metalinks_out" format="tabular" from_work_dir="metalinks.tsv" label="${tool.name} (${method.method}): Metalinks">
            <filter>method['method'] == 'get_metalinks'</filter>
        </data>
        <data name="metalinks_desc_out" format="tabular" from_work_dir="metalinks_description.tsv" label="${tool.name} (${method.method}): Metalinks description">
            <filter>method['method'] == 'describe_metalinks'</filter>
        </data>
        <data name="hidden_output" format="txt" label="Log file">
            <filter>advanced_common['show_log']</filter>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: select_resource -->
        <test expect_num_outputs="2">
            <conditional name="method">
                <param name="method" value="select_resource"/>
                <param name="resource_name" value="consensus"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="resource_out" location="https://zenodo.org/records/18388645/files/resource_consensus.tsv" ftype="tabular">
                <assert_contents>
                    <has_text text="ligand"/>
                    <has_text text="receptor"/>
                    <has_n_columns n="2"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.resource.select_resource"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: show_resources -->
        <test expect_num_outputs="2">
            <conditional name="method">
                <param name="method" value="show_resources"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="resources_list_out" location="https://zenodo.org/records/18388645/files/resources_list.txt" ftype="txt">
                <assert_contents>
                    <has_text text="consensus"/>
                    <has_text text="cellphonedb"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.resource.show_resources"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: explode_complexes -->
        <test expect_num_outputs="2">
            <conditional name="method">
                <param name="method" value="explode_complexes"/>
                <conditional name="resource_input">
                    <param name="resource_source" value="builtin"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="source_col" value="ligand"/>
                <param name="target_col" value="receptor"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="exploded_out" location="https://zenodo.org/records/18388645/files/resource_exploded.tsv" ftype="tabular">
                <assert_contents>
                    <has_text text="ligand"/>
                    <has_text text="receptor"/>
                </assert_contents>
            </output>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.resource.explode_complexes"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

This tool provides access to prior knowledge resources from LIANA+ for ligand-receptor interaction analysis.

**Methods**

- **select_resource**: Load a pre-defined ligand-receptor resource. Available resources include consensus, cellphonedb, cellchat, connectome, and more.

- **show_resources**: List all available built-in ligand-receptor resources.

- **generate_lr_geneset**: Generate a gene set from ligand-receptor pairs for use in enrichment analysis.

- **explode_complexes**: Expand protein complexes into their individual subunits. Useful when you need to work with individual genes rather than complex names.

- **get_metalinks**: Retrieve metabolite-protein interaction data from the Metalinks database. Useful for metabolite-mediated cell-cell communication analysis.

- **describe_metalinks**: Get a description of the Metalinks database contents and statistics.

**Available Resources**

The following ligand-receptor resources are available:
- consensus (default): Consensus resource combining multiple databases
- cellphonedb: CellPhoneDB resource
- cellchat: CellChat resource
- connectome: Connectome resource
- natmi: NATMI resource
- And more...

**Outputs**

- Tabular files with ligand-receptor pairs or resource information
- Text file listing available resources (for show_resources)
    ]]></help>
    <expand macro="citations"/>
</tool>
