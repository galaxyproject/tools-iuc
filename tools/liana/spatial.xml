<tool id="liana_spatial" name="Liana spatial methods" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>for spatial ligand-receptor analysis and MISTy modelling</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio_tools"/>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
@CMD@
      ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_IMPORTS@
@CMD_READ_INPUTS@

#if str($method.method) == 'bivariate':
result = li.method.bivariate(
    adata,
    #if str($method.local_name) != 'None':
    local_name='$method.local_name',
    #else:
    local_name=None,
    #end if
    #if str($method.global_name) != 'None':
    global_name='$method.global_name',
    #else:
    global_name=None,
    #end if
    #if str($method.resource_selection.resource_type) == 'interactions':
    interactions=[tuple(x.strip().split(',')) for x in '''$method.resource_selection.interactions'''.strip().split('\n') if x.strip()],
    #else if str($method.resource_selection.resource_type) == 'resource':
    resource=pd.read_csv('$method.resource_selection.resource', sep='\t'),
    #else:
    resource_name='$method.resource_selection.resource_name',
    #end if
    connectivity_key='$method.connectivity_key',
    mask_negatives=$method.mask_negatives,
    add_categories=$method.add_categories,
    #if str($method.n_perms) != '':
    n_perms=$method.n_perms,
    #end if
    use_raw=$method.use_raw,
    seed=$method.seed,
    nz_prop=$method.nz_prop,
    verbose=$method.verbose)
## Store bivariate results in adata.uns
if result is not None:
    adata.uns['liana_bivariate'] = result

#else if str($method.method) == 'genericMistyData':
misty = li.method.genericMistyData(
    intra=adata,
    intra_use_raw=$method.intra_use_raw,
    #if str($method.intra_layer) != '':
    intra_layer='$method.intra_layer',
    #else:
    intra_layer=None,
    #end if
    extra=None,
    extra_use_raw=$method.extra_use_raw,
    #if str($method.extra_layer) != '':
    extra_layer='$method.extra_layer',
    #else:
    extra_layer=None,
    #end if
    nz_threshold=$method.nz_threshold,
    add_para=$method.add_para,
    spatial_key='$method.spatial_key',
    set_diag=$method.set_diag,
    kernel='$method.kernel',
    bandwidth=$method.bandwidth,
    zoi=$method.zoi,
    cutoff=$method.cutoff,
    add_juxta=$method.add_juxta,
    n_neighs=$method.n_neighs,
    max_neighs=$method.max_neighs,
    verbose=$method.verbose)
## Run MISTy model
misty(model=li.method.sp.$method.model, bypass_intra=$method.bypass_intra, seed=$method.seed, verbose=$method.verbose)
## Store results in adata.uns
adata.uns['misty'] = misty

#else if str($method.method) == 'lrMistyData':
misty = li.method.lrMistyData(
    adata,
    #if str($method.resource_selection.resource_type) == 'interactions':
    interactions=[tuple(x.strip().split(',')) for x in '''$method.resource_selection.interactions'''.strip().split('\n') if x.strip()],
    #else if str($method.resource_selection.resource_type) == 'resource':
    resource=pd.read_csv('$method.resource_selection.resource', sep='\t'),
    #else:
    resource_name='$method.resource_selection.resource_name',
    #end if
    nz_threshold=$method.nz_threshold,
    use_raw=$method.use_raw,
    #if str($method.layer) != '':
    layer='$method.layer',
    #else:
    layer=None,
    #end if
    spatial_key='$method.spatial_key',
    set_diag=$method.set_diag,
    kernel='$method.kernel',
    bandwidth=$method.bandwidth,
    zoi=$method.zoi,
    cutoff=$method.cutoff,
    verbose=$method.verbose)
## Run MISTy model
misty(model=li.method.sp.$method.model, bypass_intra=$method.bypass_intra, seed=$method.seed, verbose=$method.verbose)
## Store results in adata.uns
adata.uns['misty'] = misty
#end if

@CMD_ANNDATA_WRITE_OUTPUTS@
        ]]>
        </configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <conditional name="method">
            <param argument="method" type="select" label="Spatial analysis method">
                <option value="bivariate">Bivariate local spatial metrics (bivariate)</option>
                <option value="genericMistyData">Generic MISTy multi-view modelling (genericMistyData)</option>
                <option value="lrMistyData">Ligand-receptor MISTy modelling (lrMistyData)</option>
            </param>
            <when value="bivariate">
                <expand macro="params_bivariate_metrics"/>
                <expand macro="param_resource_selection"/>
                <expand macro="param_connectivity_key"/>
                <expand macro="param_use_raw"/>
                <expand macro="params_bivariate_options"/>
            </when>
            <when value="genericMistyData">
                <expand macro="params_misty_intra_extra"/>
                <expand macro="param_nz_threshold"/>
                <expand macro="params_misty_spatial"/>
                <expand macro="params_misty_para"/>
                <expand macro="params_misty_juxta"/>
                <expand macro="params_misty_model"/>
            </when>
            <when value="lrMistyData">
                <expand macro="param_resource_selection"/>
                <expand macro="param_nz_threshold"/>
                <expand macro="param_use_raw"/>
                <expand macro="param_layer"/>
                <expand macro="params_misty_spatial"/>
                <expand macro="params_misty_kernel"/>
                <expand macro="params_misty_model"/>
            </when>
        </conditional>
        <expand macro="inputs_common_advanced"/>
    </inputs>
    <outputs>
        <expand macro="anndata_outputs"/>
    </outputs>
    <tests>
        <!-- Test 1: bivariate with cosine local metric -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/spatial_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="bivariate"/>
                <param name="local_name" value="cosine"/>
                <param name="global_name" value="None"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="connectivity_key" value="spatial_connectivities"/>
                <param name="use_raw" value="false"/>
                <param name="mask_negatives" value="false"/>
                <param name="add_categories" value="false"/>
                <param name="seed" value="1337"/>
                <param name="nz_prop" value="0.05"/>
                <param name="verbose" value="false"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.bivariate"/>
                    <has_text_matching expression="local_name='cosine'"/>
                </assert_contents>
            </output>
            <output name="anndata_out" location="https://zenodo.org/records/18388645/files/bivariate_cosine.h5ad" ftype="h5ad" compare="sim_size" delta="200000">
                <assert_contents>
                    <has_h5_keys keys="obsm/spatial"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: bivariate with pearson local metric and morans global -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/spatial_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="bivariate"/>
                <param name="local_name" value="pearson"/>
                <param name="global_name" value="morans"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="connectivity_key" value="spatial_connectivities"/>
                <param name="use_raw" value="false"/>
                <param name="mask_negatives" value="false"/>
                <param name="add_categories" value="true"/>
                <param name="n_perms" value="5"/>
                <param name="seed" value="42"/>
                <param name="nz_prop" value="0.1"/>
                <param name="verbose" value="false"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.bivariate"/>
                    <has_text_matching expression="local_name='pearson'"/>
                    <has_text_matching expression="global_name='morans'"/>
                </assert_contents>
            </output>
            <output name="anndata_out" location="https://zenodo.org/records/18388645/files/bivariate_pearson_morans.h5ad" ftype="h5ad" compare="sim_size" delta="200000">
                <assert_contents>
                    <has_h5_keys keys="obsm/spatial"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 3: bivariate with jaccard metric -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/spatial_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="bivariate"/>
                <param name="local_name" value="jaccard"/>
                <param name="global_name" value="None"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="connectivity_key" value="spatial_connectivities"/>
                <param name="use_raw" value="false"/>
                <param name="mask_negatives" value="true"/>
                <param name="add_categories" value="false"/>
                <param name="seed" value="1337"/>
                <param name="nz_prop" value="0.05"/>
                <param name="verbose" value="false"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.bivariate"/>
                    <has_text_matching expression="local_name='jaccard'"/>
                    <has_text_matching expression="mask_negatives=True"/>
                </assert_contents>
            </output>
            <output name="anndata_out" location="https://zenodo.org/records/18388645/files/bivariate_jaccard.h5ad" ftype="h5ad" compare="sim_size" delta="200000">
                <assert_contents>
                    <has_h5_keys keys="obsm/spatial"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 4: bivariate with product metric -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/spatial_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="bivariate"/>
                <param name="local_name" value="product"/>
                <param name="global_name" value="lee"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="connectivity_key" value="spatial_connectivities"/>
                <param name="use_raw" value="false"/>
                <param name="mask_negatives" value="false"/>
                <param name="add_categories" value="false"/>
                <param name="seed" value="1337"/>
                <param name="nz_prop" value="0.05"/>
                <param name="verbose" value="false"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.bivariate"/>
                    <has_text_matching expression="local_name='product'"/>
                    <has_text_matching expression="global_name='lee'"/>
                </assert_contents>
            </output>
            <output name="anndata_out" location="https://zenodo.org/records/18388645/files/bivariate_product_lee.h5ad" ftype="h5ad" compare="sim_size" delta="100000">
                <assert_contents>
                    <has_h5_keys keys="obsm/spatial"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 5: bivariate with spearman metric -->
        <test expect_num_outputs="2">
            <param name="adata" location="https://zenodo.org/records/18388645/files/spatial_small.h5ad"/>
            <conditional name="method">
                <param name="method" value="bivariate"/>
                <param name="local_name" value="spearman"/>
                <param name="global_name" value="None"/>
                <conditional name="resource_selection">
                    <param name="resource_type" value="resource_name"/>
                    <param name="resource_name" value="consensus"/>
                </conditional>
                <param name="connectivity_key" value="spatial_connectivities"/>
                <param name="use_raw" value="false"/>
                <param name="mask_negatives" value="false"/>
                <param name="add_categories" value="false"/>
                <param name="seed" value="1337"/>
                <param name="nz_prop" value="0.05"/>
                <param name="verbose" value="false"/>
            </conditional>
            <section name="advanced_common">
                <param name="show_log" value="true"/>
            </section>
            <output name="hidden_output">
                <assert_contents>
                    <has_text_matching expression="li.method.bivariate"/>
                    <has_text_matching expression="local_name='spearman'"/>
                </assert_contents>
            </output>
            <output name="anndata_out" location="https://zenodo.org/records/18388645/files/bivariate_spearman.h5ad" ftype="h5ad" compare="sim_size" delta="100000">
                <assert_contents>
                    <has_h5_keys keys="obsm/spatial"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
Liana Spatial Analysis Methods
==============================

This tool provides spatial analysis methods from LIANA for ligand-receptor inference
in spatially-resolved data.

Available Methods
-----------------

**bivariate**
    Compute local bivariate metrics for spatial ligand-receptor analysis.
    Supports various local metrics (cosine, jaccard, pearson, spearman, product)
    and global metrics (Moran's I, Geary's C, Lee's L).

**genericMistyData**
    Construct a MistyData object from an AnnData object with views as presented
    in the MISTy manuscript. Creates intra, para (paraview), and juxta (juxtaview)
    views for multi-view spatial modelling.

**lrMistyData**
    Generate a MistyData object from an AnnData object in ligand-receptor format.
    Creates views with receptors in the intra view and ligands in the extra view.

Bivariate Metrics
-----------------

**Local metrics** (computed per cell/spot):
    - cosine: Cosine similarity
    - jaccard: Jaccard index
    - pearson: Pearson correlation
    - spearman: Spearman correlation
    - product: Product of values
    - norm_product: Normalized product

**Global metrics** (computed across all cells/spots):
    - morans: Moran's I (spatial autocorrelation)
    - gearys: Geary's C (spatial autocorrelation)
    - lee: Lee's L (bivariate spatial association)

MISTy Views
-----------

**Intra-view**: Expression within each cell/spot (intrinsic view)

**Para-view**: Weighted expression from surrounding cells using a radial basis
function kernel (paraview - captures broader spatial context)

**Juxta-view**: Expression from immediate neighbors only (juxtaview - captures
local cell-cell interactions)

MISTy Models
------------

**linear**: Linear regression model
**rf**: Random Forest model (default)

Output
------

Results are stored in adata.uns:
- bivariate: 'liana_bivariate'
- MISTy methods: 'misty' (contains MistyData object with model results)

More details on the `LIANA documentation <https://liana-py.readthedocs.io/>`__
    ]]></help>
    <expand macro="citations"/>
</tool>
