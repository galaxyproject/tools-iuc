<tool id="mudata_import" name="Create MuData from AnnData" version="0.1.0">
    <requirements>
        <requirement type="package" version="1.7.0">scanpy</requirement>
        <requirement type="package" version="0.1.2">muon</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        python '$script_file'
]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[import scanpy as sc
import muon as mu
rna_data = sc.read_h5ad('$rna_input')
atac_data = sc.read_h5ad('$atac_input')
#if $second_modality == 'prot'
mdata = mu.MuData({'$first_modality.rna_name': rna_data, '$second_modality.protein_name': atac_data})
#else
mdata = mu.MuData({'$first_modality.rna_name': rna_data, '$second_modality.atac_name': atac_data})
#end if
mu.pp.intersect_obs(mdata)
mdata.write("rna_atac.h5mu")
]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="first_modality">
            <param argument="first_modality" type="select" label="First Modality" help="Key name of the first modality file">
                    <option value="rna">RNA</option>
                    <option value="atac">ATAC</option>
                    <option value="protein">Protein</option>
            </param>
            <when value="rna">
                <param argument="rna_name" type="text" label="RNA Modality Name" value="rna"
                       help="Name to give for the rna modality in the MuData file"/>
            </when>
            <when value="atac">
                <param argument="atac_name" type="text" label="ATAC Modality Name" value="atac"
                       help="Name to give for the atac modality in the MuData file"/>
            </when>
            <when value="protein">
                <param argument="protein_name" type="text" label="Protein Modality Name" value="prot"
                       help="Name to give for the protein modality in the MuData file"/>
            </when>
        </conditional>
        <param name="rna_input" type="data" format="h5ad" label="RNA h5ad Matrix"/>
        <conditional name="second_modality">
            <param argument="second_modality" type="select" label="Second Modality" help="Key name of the second modality file">
                    <option value="rna">RNA</option>
                    <option value="atac">ATAC</option>
                    <option value="protein">Protein</option>
            </param>
            <when value="rna">
                <param argument="rna_name" type="text" label="RNA Modality Name" value="rna"
                       help="Name to give for the rna modality in the MuData file"/>
            </when>
            <when value="atac">
                <param argument="atac_name" type="text" label="ATAC Modality Name" value="atac"
                       help="Name to give for the atac modality in the MuData file"/>
            </when>
            <when value="protein">
                <param argument="protein_name" type="text" label="Protein Modality Name" value="prot"
                       help="Name to give for the protein modality in the MuData file"/>
            </when>
        </conditional>
        <param name="atac_input" type="data" format="h5ad" label="ATAC h5ad Matrix"/>
    </inputs>
    <outputs>
        <data name="rna_atac" format="h5mu" label="MuData" from_work_dir="rna_atac.h5mu"/>
    </outputs>
    <tests>
        <test>
            <!--Test for RNA and ATAC modalities integration-->
            <param name="rna_input" value="rna_data.h5ad"/>
            <param name="first_modality" value="rna"/>
            <param name="rna_name" value="rna"/>
            <param name="second_modality" value="atac"/>
            <param name="atac_name" value="atac"/>
            <param name="atac_input" value="atac_data.h5ad"/>
            <output name="rna_atac" file="rna_atac.h5mu"/>
        </test>
    </tests>
    <help><![CDATA[
    **What it does**
        Create MuData from AnnData is a tool that allows creating a muon.MuData object out of two AnnData objects
        for multimodal omics factorial analysis. The multimodal data is created by combining two AnnData objects as
        h5ad files into a MuData object as a h5mu file using muon.
        Furthermore, it runs pp.intersect_obs to keep only entries present in both modalities (AnnData objects) in the
        final MuData file.
    ]]></help>
    <citations>
        <citation type="doi">10.1186/s13059-021-02577-8</citation>
    </citations>
</tool>