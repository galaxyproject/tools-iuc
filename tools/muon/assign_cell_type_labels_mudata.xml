<tool id="assign_cell_type_labels_mudata" name="Assign Cell Type Labels for MuData" version="0.1.0">
    <requirements>
        <requirement type="package" version="1.7.0">scanpy</requirement>
        <requirement type="package" version="0.1.2">muon</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    python '$script_file'
]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[import scanpy as sc
import muon as mu
import numpy as np
import matplotlib
from matplotlib import pyplot as plt
mdata = mu.read_h5mu('$rna_atac_input')

new_cluster_names_keys = str('$new_cluster_names_keys')
new_cluster_names_keys = new_cluster_names_keys.strip().split(",")
new_cluster_names_values = str('$new_cluster_names_values')
new_cluster_names_values = new_cluster_names_values.strip().split(",")
new_cluster_names = dict(zip(new_cluster_names_keys, new_cluster_names_values))
mdata.obs['celltype'] = mdata.obs['$key_added_leiden'].astype("str")
mdata.obs.celltype = mdata.obs.celltype.map(new_cluster_names).astype("category")

reorder_cat_list = str('$reorder_cat_list')
reorder_cat_list = reorder_cat_list.split(",")
mdata.obs.celltype.cat.reorder_categories(reorder_cat_list, inplace=True)

cmap = plt.get_cmap('$get_cmap_name')
colors = cmap(np.linspace(0, 1, len(mdata.obs.celltype.cat.categories)))
mdata.uns["celltype_colors"] = list(map(matplotlib.colors.to_hex, colors))

umap_plot = mu.pl.umap(
    mdata,
    color='$umap_color',
    legend_loc='$umap_legend_loc',
    frameon=$umap_frame_on,
    return_fig=True
)
umap_plot.savefig("celltype_umap_plot.png")
mdata.write("rna_atac_assigned_celltype_labels.h5mu")
]]></configfile>
    </configfiles>
    <inputs>
        <param name="rna_atac_input" type="data" format="h5mu" label="RNA ATAC Data Matrix"/>
        <param name="new_cluster_names_keys" type="text" label="New Cluster Names Keys" help="Add the keys of the new clsuter names as numbers separated by commas" value="0,8,22,1,6,17,2,5,20,10,11,19,12,16,15,3,7,9,14,4,13,18,21"/>
        <param name="new_cluster_names_values" type="text" label="New Cluster Names Values" help="Add the corresponding values to the previously added keys (in the same order and for every key added)" value="CD4+ naïve T, CD4+ naïve T, CD4+ naïve T, CD4+ memory T, CD4+ memory T, CD4+ memory T, CD8+ naïve T, CD8+ naïve T, CD8+ naïve T, CD8+ cytotoxic effector T, CD8+ transitional effector T, MAIT, NK, naïve B, memory B, classical mono, classical mono, classical mono, classical mono, intermediate mono, non-classical mono, mDC, pDC"/>
        <param name="reorder_cat_list" type="text" label="Categories to reorder" help="Add the names of the categories to reorder, ensuring the same names as previously defined are used." value="CD4+ naïve T,CD4+ memory T,CD8+ naïve T, CD8+ transitional effector T, CD8+ cytotoxic effector T,MAIT, NK,naïve B, memory B,classical mono,intermediate mono, non-classical mono,mDC, pDC"/>
        <param name="key_added_leiden" type="text" label="Key used in leiden embeddings" help="(key_added when performed leiden clustering as saved in .obs)" value="leiden_joint"/>
        <param name="get_cmap_name" type="text" label="Name of the colormap instance" help="(name in matplotlib.cm.get_cmap()" value="rainbow"/>
        <param name="umap_color" type="text" label="Keys for annotations of observations/cells or variables/genes" help="(color in muon.pl.umap())" value="celltype"/>
        <param name="umap_legend_loc" type="text" label="Location of legend" help="(legend_loc in muon.pl.umap())" value="on data"/>
        <param name="umap_frame_on" type="boolean" label="Draw a frame around the scatter plot" help="(frameon in muon.pl.umap())" checked="true" truevalue="True" falsevalue="False"/>
    </inputs>
    <outputs>
        <data name="celltype_umap_plot" format="png" label="RNA ATAC Celltype UMAP Plot"
              from_work_dir="celltype_umap_plot.png"/>
        <data name="rna_atac_assigned_celltype_labels" format="h5mu" label="RNA ATAC with Assigned Celltype Labels"
              from_work_dir="rna_atac_assigned_celltype_labels.h5mu"/>
    </outputs>
    <tests>
        <test>
            <param name="rna_atac_input" value="assign_celltype_labels_mudata_in.h5mu"/>
            <param name="new_cluster_names_keys" value="0,8,22,1,17"/>
            <param name="new_cluster_names_values" value="CD4+ naïve T, CD4+ naïve T, CD4+ naïve T, CD4+ memory T, CD4+ memory T"/>
            <param name="reorder_cat_list" value="CD4+ naïve T, CD4+ memory T"/>
            <param name="key_added_leiden" value="leiden_joint"/>
            <param name="get_cmap_name" value="rainbow"/>
            <param name="umap_color" value="celltype"/>
            <param name="umap_legend_loc" value="on data"/>
            <param name="umap_frame_on" value="True"/>
            <output name="rna_atac_assigned_celltype_labels" value="rna_atac_assigned_celltype_labels.h5mu"/>
            <output name="celltype_umap_plot" value="celltype_umap_plot.png"/>
        </test>
    </tests>
    <help><![CDATA[
    **What it does**
        This tool takes Multimodal data that has been clustered and then assigns new cluster names to it, re-orders
        its categories and then plots as a UMAP, using muon.pl.umap().

        Returns the UMAP plot as a png file and the MuData object after processing as a h5mu file.
    ]]></help>
    <citations>
        <citation type="bibtex">
}</citation>
    </citations>
</tool>