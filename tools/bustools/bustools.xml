<tool id="bustools" name="Bustools" version="@VERSION@">
    <description>Working with bus files</description>
    <macros>
        <import>busmacros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
#if $commandselect.commandtype == "sort":
    @SORT@
#else if $commandselect.commandtype == "text":
    @TEXT@
#else if $commandselect.commandtype == "correct":
    @CORRECT@
#else if $commandselect.commandtype == "count":
    @COUNT@
#else if $commandselect.commandtype == "capture":
    @CAPTURE@
#end if
    ]]></command>
    <inputs>
        <param name="file" type="data" label="Data file" format="bus"/>
        <conditional name="commandselect">
            <param name="commandtype" type="select" label="Bustool function">
                <option value="sort">Sort bus file by barcodes and UMI</option>
                <option value="text">Output as tab separated text file</option>
                <option value="correct">Error correct bus files</option>
                <option value="count">Generate count matrices from bus file</option>
                <option value="capture">Capture reads mapping to a transcript capture list</option>
            </param>
            <when value="sort"/>
            <when value="text"/>
            <when value="correct">
                <param name="whitelist" type="data" format="txt" help="Required: File of whitelisted barcodes to correct to"/>
            </when>
            <when value="count">
                <param name="genemap" type="data" format="txt" label="Gene map" optional="true" help="File for mapping transcripts to genes"/>
                <param name="ecmap" type="data" format="ec" label="Ec map" optional="true" help=".ec file for mapping equivalence classes to transcripts"/>
                <param name="txtnames" type="data" format="txt" label="Text names" optional="true" help="File with names of transcripts"/>
                <param name="genecounts" type="boolean" truevalue="Yes" falsevalue="No" label="Gene counts" help="Aggregate counts to genes only?"/>
                <param name="multimapping" type="boolean" truevalue="Yes" falsevalue="No" label="Multimapping" help="Include bus records that pseudoalign to multiple genes"/>
            </when>
            <when value="capture">
                <param name="capture" type="data" format="txt" optional="true" label="Capture" help="List of transcripts to capture"/>
                <param name="ecmap" type="data" format="txt" optional="true" label="EC map" help=".ec file for mapping equivalence classes to transcripts"/>
                <param name="txtnames" type="data" format="txt" optional="true" label= "Txt names" help="File with names of transcripts"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="bussort" format="bus" from_work_dir="out.sorted.bus" label="Sorted bus on ${on_string}">
            <filter>commandselect['commandtype'] == 'sort'</filter>
        </data>
        <data name="bustext" format="tsv" from_work_dir="out.text.tsv" label="Text bus on ${on_string}">
            <filter>commandselect['commandtype'] == 'text'</filter>
        </data>
        <data name="buscorr" format="bus" from_work_dir="out.corrected.bus" label="Corrected bus on ${on_string}">
            <filter>commandselect['commandtype'] == 'correct'</filter>
        </data>
        <data name="buscount" format="bus" from_work_dir="out.count.bus" label="Counted bus on ${on_string}">
            <filter>commandselect['commandtype'] == 'count'</filter>
        </data>
        <collection name="buscap" type="list" label="Captured bus output">
            <discover_datasets pattern="__designation__" format="ec" directory="out.capture" visible="false"/>
            <filter>commandselect['commandtype'] == 'capture'</filter>
            <discover_datasets pattern="__designation__" format="bus" directory="out.capture" visible="false"/>
            <filter>commandselect['commandtype'] == 'capture'</filter>
        </collection>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="file" value="testbus.bus"/>
            <param name="commandtype" value="text"/>
            <output name="bustext" value="text.test.tsv" ftype="tsv"/>
        </test>
        <test expect_num_outputs="1">
            <param name="file" value="testbus.bus"/>
            <param name="commandtype" value="sort"/>
            <output name="bussort" value="sort.test.bus" ftype="bus" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <param name="file" value="testbus.bus"/>
            <param name="commandtype" value="correct"/>
            <param name="whitelist" value="whitelist.txt"/>
            <output name="buscorr" value="corr.test.bus" ftype="bus" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
@help@
    ]]></help>
    <expand macro="citations"/>
</tool>
