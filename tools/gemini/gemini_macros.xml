<macros>
    <!-- gemini version to be used -->
    <token name="@VERSION@">0.20.1</token>
    <!-- minimal annotation files version required by this version of gemini -->
    <token name="@DB_VERSION@">200</token>

    <xml name="requirements">
        <requirements>
            <requirement type="package" version="@VERSION@">gemini</requirement>
            <yield />
        </requirements>
    </xml>

    <xml name="version_command">
        <version_command>gemini --version</version_command>
    </xml>

    <xml name="stdio">
        <stdio>
            <exit_code range="1:" />
            <exit_code range=":-1" />
            <regex match="Error:" />
            <regex match="Exception:" />
        </stdio>
    </xml>

    <xml name="annotation_dir">
        <param name="annotation_databases" type="select" label="Choose a gemini annotation source">
            <options from_data_table="gemini_versioned_databases">
                <filter type="sort_by" column="0" />
                <filter type="static_value" column="2" value="@DB_VERSION@" />
            </options>
        </param>
    </xml>

    <xml name="add_header_column">
        <param argument="--header" name="header" type="boolean" truevalue="--header" falsevalue="" checked="True" 
        label="Add a header of column names to the output" />
    </xml>

    <xml name="radius">
        <param name="radius" type="integer" value="3" label="Set filter for Breadth-first search (BFS) in the Protein-Protein Interaction network" help="(-r)" >
            <validator type="in_range" min="0"/>
        </param>
    </xml>
    <xml name="variant_mode">
        <param name="variant_mode" type="boolean" truevalue="--var" falsevalue="" checked="False" 
            label="Returns variant info (e.g. impact, biotype) for interacting genes" help="(--var)"/>
    </xml>

    <xml name="column_filter" token_help="" token_minimalset="variant_id, gene">
        <conditional name="report">
            <param name="report_selector" type="select"
            label="Set of columns to include in the variant report table"
            help="@HELP@">
                <option value="minimal">Minimal (report only a preconfigured minimal set of columns)</option>
                <option value="full">Full (report all columns defined in the GEMINI database variants table)</option>
                <option value="custom">Custom (report user-specified columns)</option>
            </param>
            <when value="full" />
            <when value="minimal">
                <param name="columns" type="hidden" value="@MINIMALSET@" />
                <param name="extra_cols" type="hidden" value="" />
            </when>
            <when value="custom">
                <param name="columns" type="select" display="checkboxes" multiple="true" optional="true"
                label="Choose columns to include in the report" help="(--columns)">
                    <option value="gene">gene</option>
                    <option value="chrom">chrom</option>
                    <option value="start">start</option>
                    <option value="end">end</option>
                    <option value="ref">ref</option>
                    <option value="alt">alt</option>
                    <option value="impact">impact</option>
                    <option value="impact_severity">impact_severity</option>
                    <option value="max_aaf_all">alternative allele frequency</option>
                </param>
                <param name="extra_cols" type="text"
                label="Additional columns (comma-separated)" help="">
                    <expand macro="sanitize_query" />
                </param>
            </when>
        </conditional>
    </xml>

    <xml name="filter" token_argument="--filter">
        <param argument="@ARGUMENT@" name="filter" type="text"
        label="Additional constraints expressed in SQL syntax"
        help="Constraints defined here will become the WHERE clause of the SQL query issued to the GEMINI database. E.g. alt='G' or impact_severity = 'HIGH'.">
            <expand macro="sanitize_query" />
        </param>
    </xml>

    <xml name="sanitize_query">
        <sanitizer invalid_char="">
            <valid initial="string.printable">
                <remove value="&apos;" />
            </valid>
            <mapping initial="none">
                <add source="&apos;" target="&apos;&quot;&apos;&quot;&apos;" />
            </mapping>
       </sanitizer>
    </xml>

    <token name="@PROVIDE_ANNO_DATA@"><![CDATA[
        mkdir gemini &&
        ln -s "${annotation_databases.fields.path}/gemini/data" gemini/data &&
        export GEMINI_CONFIG="${annotation_databases.fields.path}" &&
    ]]></token>

    <token name="@MULTILN_SQL_EXPR_TO_CMDLN@">
        #set $sql_expr = str($multiline_sql_expr).strip()
        #if str($sql_expr):
            #set $sql_expr = $sql_expr.replace('\r\n', '\n')
            #set $sql_expr = $sql_expr.replace('\r', '\n')
            #set $sql_expr = $sql_expr.replace('\\\n', ' ')
            $cmdln_param '$sql_expr'
        #end if
    </token>

    <token name="@CMDLN_SQL_FILTER_FILTER_OPTION@">
        #if str($filter).strip():
            --filter '$filter'
        #end if
    </token>

    <token name="@SET_COLS@">
        #if str($report.report_selector) == 'full':
            #set cols = "*"
        #else:
            #if $report.columns and str($report.columns) != '':
                #set $cols = str($report.columns)
            #else
                #set $cols = ''
            #end if
            #if str($report.extra_cols).strip():
                #if $cols:
                    #set $cols = $cols + ', ' + str($report.extra_cols)
                #else:
                    #set $cols = str($report.extra_cols)
                #end if
            #end if
            #if not $cols:
                #set $cols = "variant_id, gene"
            #end if
        #end if
    </token>

    <token name="@COLUMN_SELECT@">
        @SET_COLS@
        #if $cols != "*"
            --columns '$cols'
        #end if
    </token>

    <xml name="lenient" token_argument="--lenient" token_truevalue="--lenient" token_help="The exact consequence of this setting depends on the type of inheritance pattern you are looking for (see the tool help below).">
        <param argument="@ARGUMENT@" name="lenient" type="boolean" truevalue="@TRUEVALUE@" falsevalue="" checked="False"
        label="Include hits with less convincing inheritance patterns"
        help= "@HELP@" />
    </xml>

    <xml name="unaffected">
        <param argument="--allow-unaffected" name="allow_unaffected" type="boolean" truevalue="--allow-unaffected" falsevalue="" checked="False"
        label="Report candidates shared by unaffected samples"
        help="Activating this option will enable the reporting of variants as candidate causative even if they are shared by unaffected samples in the family tree. The default will only report variants that are unique to affected samples."/>
    </xml>

    <xml name="min_kindreds">
        <param argument="--min-kindreds" name="min_kindreds" type="integer" value="1" min="1"
        label="Minimum number of families with a candidate variant for a gene to be reported"
        help="This is the number of families required to have a variant fitting the inheritance model in the same gene in order for the gene and its variants to be reported. For example, we may only be interested in candidates where at least 4 families have a variant (with a fitting inheritance pattern) in that gene." />
    </xml>

    <xml name="citations">
        <citations>
            <citation type="doi">10.1371/journal.pcbi.1003153</citation>
            <yield />
        </citations>
    </xml>

    <xml name="infile">
        <param name="infile" type="data" format="gemini.sqlite" label="GEMINI database" help="Only files with version @VERSION@ are accepted." >
            <options options_filter_attribute="metadata.gemini_version" >
                <filter type="add_value" value="@VERSION@" />
            </options>
        </param>
    </xml>

</macros>
