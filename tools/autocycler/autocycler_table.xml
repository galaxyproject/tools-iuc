<tool id="autocycler_table" name="AutoCycler Table" version="@TOOL_VERSION@+galaxy0" profile="@PROFILE@">
    <description>generate summary tables from AutoCycler results</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        #import re
        ### create table header
        autocycler table > metric.tsv &&

        mkdir autocycler_dir &&
        #if $subsample
            ln -s '$subsample' 'autocycler_dir/subsample.yaml' &&
        #end if
        #if $input_assemblies
            ln -s '$input_assemblies' 'autocycler_dir/input_assemblies.yaml' &&
        #end if
        #if $clustering
            mkdir -p autocycler_dir/clustering/ &&
            ln -s '$clustering' 'autocycler_dir/clustering/clustering.yaml' &&
        #end if
        #if $clustering_qc_pass
            mkdir -p autocycler_dir/clustering/qc_pass/ &&
            #for $cluster in $clustering_qc_pass
                #set $identifier = re.sub('[^\w\-_\.]', '_', $cluster.element_identifier)
                mkdir -p autocycler_dir/clustering/$identifier/ &&
                ln -s $cluster autocycler_dir/clustering/$identifier/1_untrimmed.yaml &&
            #end for
        #end if
        #if $trimmed
            #for $cluster in $trimmed
                #set $identifier = re.sub('[^\w\-_\.]', '_', $cluster.element_identifier)
                mkdir -p autocycler_dir/clustering/$identifier/ &&
                ln -s $cluster autocycler_dir/clustering/$identifier/2_trimmed.yaml &&
            #end for
        #end if

        #if $consensus
            ln -s '$consensus' 'autocycler_dir/consensus_assembly.yaml' &&
        #end if

        autocycler table 
        --autocycler_dir 'autocycler_dir/'
        #if $sigfigs:
            --sigfigs '$sigfigs'
        #end if
        --fields #echo ",".join($fields)
        >> metric.tsv

        ]]></command>
    <inputs>
        <param name="subsample" type="data" optional="true" format="yaml" label="Subsample YAML output" />
        <param name="input_assemblies" type="data" optional="true" format="yaml" label="Compress YAML output" />
        <param name="clustering" type="data" optional="true" format="yaml" label="Clustering YAML output" />
        <param name="clustering_qc_pass" type="data_collection" optional="true" format="yaml" label="Clustering YAML qc_pass output" />
        <param name="trimmed" type="data_collection" optional="true" format="yaml" label="Trimmed YAML output" />
        <param name="consensus" type="data" optional="true" format="yaml" label="Compress YAML output" />

        <param argument="--fields" type="select" multiple="true" label="Metrics">
            <option value="input_read_count" selected="true">Subsample: input_read_count</option>
            <option value="input_read_bases" selected="true">Subsample: input_read_bases</option>
            <option value="input_read_n50" selected="true">Subsample: input_read_n50</option>
            <option value="output_reads">Subsample: output_reads</option>

            <option value="input_assemblies_count">Input assembly: input_assemblies_count</option>
            <option value="input_assemblies_total_contigs">Input assembly: input_assemblies_total_contigs</option>
            <option value="input_assemblies_total_length">Input assembly: input_assemblies_total_length</option>
            <option value="compressed_unitig_count">Input assembly: compressed_unitig_count</option>
            <option value="compressed_unitig_total_length">Input assembly: compressed_unitig_total_length</option>
            <option value="input_assembly_details">Input assembly: input_assembly_details</option>

            <option value="pass_cluster_count" selected="true">Clustering: pass_cluster_count</option>
            <option value="fail_cluster_count" selected="true">Clustering: fail_cluster_count</option>
            <option value="pass_contig_count">Clustering: pass_contig_count</option>
            <option value="fail_contig_count">Clustering: fail_contig_count</option>
            <option value="pass_contig_fraction">Clustering: pass_contig_fraction</option>
            <option value="fail_contig_fraction">Clustering: fail_contig_fraction</option>
            <option value="cluster_balance_score">Clustering: cluster_balance_score</option>
            <option value="cluster_tightness_score">Clustering: cluster_tightness_score</option>
            <option value="overall_clustering_score" selected="true">Clustering: overall_clustering_score</option>

            <option value="untrimmed_cluster_size" selected="true">Untrimmed cluster: untrimmed_cluster_size</option>
            <option value="untrimmed_cluster_lengths">Untrimmed cluster: untrimmed_cluster_lengths</option>
            <option value="untrimmed_cluster_median">Untrimmed cluster: untrimmed_cluster_median</option>
            <option value="untrimmed_cluster_mad">Untrimmed cluster: untrimmed_cluster_mad</option>
            <option value="untrimmed_cluster_distance" selected="true">Untrimmed cluster: untrimmed_cluster_distance</option>

            <option value="trimmed_cluster_size" selected="true">Trimmed cluster: trimmed_cluster_size</option>
            <option value="trimmed_cluster_lengths">Trimmed cluster: trimmed_cluster_lengths</option>
            <option value="trimmed_cluster_median">Trimmed cluster: trimmed_cluster_median</option>
            <option value="trimmed_cluster_mad" selected="true">Trimmed cluster: trimmed_cluster_mad</option>
            
            <option value="consensus_assembly_bases" selected="true">Consensus assembly: consensus_assembly_bases</option>
            <option value="consensus_assembly_unitigs" selected="true">Consensus assembly: consensus_assembly_unitigs</option>
            <option value="consensus_assembly_fully_resolved" selected="true">Consensus assembly: consensus_assembly_fully_resolved</option>
            <option value="consensus_assembly_clusters">Consensus assembly: consensus_assembly_clusters</option>
        </param>
        <param argument="--sigfigs" type="integer" min="1" max="10" value="3" label="Significant figures" help="Number of significant digits for floating point values"/>
    </inputs>
    <outputs>
        <data name="output_table" format="tabular" from_work_dir="metric.tsv"/>
    </outputs>
    <tests>
        <test>
            <param name="subsample" value="subsample.yaml" ftype="yaml"/>
            <param name="clustering" value="clustering_test_1.yaml" ftype="yaml"/>
            <param name="clustering_qc_pass">
                <collection type="list" name="qc_pass">
                    <element name="cluster_003" value="qc_pass/cluster_003/1_untrimmed.yaml"/>
                    <element name="cluster_011" value="qc_pass/cluster_011/1_untrimmed.yaml"/>
                </collection>
            </param>
            <param name="trimmed">
                <collection type="list" name="trimmed">
                    <element name="cluster_003" value="qc_pass/cluster_003/2_trimmed.yaml"/>
                    <element name="cluster_011" value="qc_pass/cluster_011/2_trimmed.yaml"/>
                </collection>
            </param>

            <param name="consensus" value="consensus_assembly.yaml" ftype="yaml"/>
            <output name="output_table" ftype="tabular" file="metric.tsv"/>
        </test>
        <test>
            <param name="input_assemblies" value="input_assemblies.yaml" ftype="yaml"/>
            <param name="fields" value="input_assemblies_count,input_assemblies_total_contigs,input_assemblies_total_length,compressed_unitig_count,compressed_unitig_total_length,input_assembly_details"/>
            <output name="output_table" ftype="tabular" file="metric2.tsv"/>
        </test>

    </tests>
    <help><![CDATA[
**AutoCycler Table Tool**

The autocycler table command generates a TSV line from the various metrics stored in YAML files during an Autocycler assembly.
When conducting many automated Autocycler assemblies, you can use Autocycler cluster to build a TSV file containing metrics for each assembly. This can allow you to identify any samples which have assembled poorly and warrant further investigation.

**Inputs**

- Autocyler output (i.e collection)

**Parameters**

- Significant figures: Precision for numeric values (1-10)

**Outputs**

- Tab-delimited table with selected metrics

**Available Fields**

- input_read_count: Number of input reads
- input_read_bases: Total bases in input
- input_read_n50: N50 of input reads
- pass_cluster_count: Number of passing clusters
- fail_cluster_count: Number of failing clusters
- overall_clustering_score: Quality score for clustering
- untrimmed_cluster_size: Size before trimming
- untrimmed_cluster_distance: Distance between sequences
- trimmed_cluster_size: Size after trimming
- trimmed_cluster_median: Median length after trimming
- trimmed_cluster_mad: Length variability (MAD)
- consensus_assembly_bases: Total assembled bases
- consensus_assembly_unitigs: Number of unitigs
- consensus_assembly_fully_resolved: Fully resolved status

**Notes**

- Some fields will be in multiple files and will be combined into a list. For example, the trimmed_sequence_length_mad metric is stored in 2_trimmed.yaml files which are made for each cluster. Since a single assembly can have multiple clusters, there can be multiple trimmed_sequence_length_mad metrics for an assembly (one value per cluster).
- Some metrics contain nested metrics, e.g. input_assembly_details. This can be used with Autocycler table, but all of their nested data will be combined into a single string, which can be clunky in TSV format. Only top-level metrics can be used with Autocycler table. For example, the filename metric is nested under input_assembly_details so cannot be used with Autocycler table.
- If a YAML file is missing from the Autocycler directory, that's okay, but any metric from that file will be blank.
- Autocycler table will ignore any YAML files (e.g. 1_untrimmed.yaml) found in QC-fail clusters. This means that any per-cluster metrics (e.g. untrimmed_cluster_size) will only contain data from QC-pass clusters.

**Example output**

::

        name       input_read_count  input_read_bases  input_read_n50  pass_cluster_count  fail_cluster_count  overall_clustering_score  untrimmed_cluster_size  untrimmed_cluster_distance   trimmed_cluster_size  trimmed_cluster_median  trimmed_cluster_mad  consensus_assembly_bases  consensus_assembly_unitigs  consensus_assembly_fully_resolved
        wildtype   206111            1881436150        20927           3                   0                   0.858                     [24,12,9]               [0.000173,0.000676,0.00164]  [17,11,7]             [2879034,4439,3125]     [1,0,0]              2886598                   3                           true
        walKT389A  170651            975514879         16573           3                   3                   0.820                     [24,11,11]              [0.00155,0.00359,0.00547]    [18,9,10]             [2879034,4439,3125]     [1,0,0]              2886598                   3                           true
        IMAL014    304441            1863791162        18223           3                   2                   0.841                     [24,11,12]              [0.00239,0.000676,0.000989]  [16,10,10]            [2879035,4439,3125]     [1,0,0]              2886599                   3                           true
        IMAL031    212199            1814081856        19308           3                   0                   0.857                     [24,13,10]              [0.00396,0.00161,0.00]       [17,11,10]            [2879034,4439,3125]     [0,0,0]              2886598                   3                           true
        IMAL058    105653            1057335967        24664           3                   2                   0.827                     [24,11,9]               [0.000550,0.00669,0.00260]   [16,9,7]              [2879033,4439,3125]     [1,0,0]              2886597                   3                           true
        IMAL065    198975            2093837921        20387           3                   1                   0.843                     [24,7,8]                [0.000405,0.00184,0.00128]   [17,5,7]              [2879034,4439,3125]     [0,0,0]              2886598                   3                           true
        IMAL070    76391             697918832         20037           3                   3                   0.832                     [24,13,8]               [0.00180,0.00207,0.00128]    [16,10,7]             [2879033,4439,3125]     [1,0,0]              2886598                   3                           true


**IMPORTANT**

The output table's columns and structure will change depending on your inputs. 

.. class:: infomark

**More Information**

- `Autocycler table`: https://github.com/rrwick/Autocycler/wiki/Autocycler-table

**Citations**


    ]]></help>
    <expand macro="citations"/>
</tool>
