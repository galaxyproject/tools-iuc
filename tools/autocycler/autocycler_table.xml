<tool id="autocycler_table" name="AutoCycler Table" version="@TOOL_VERSION@+galaxy0" profile="@PROFILE@">
    <description>generate summary tables from AutoCycler results</description>
    <macros>
          <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
	#import re
	#set cluster_directory = 'cluster_directory'
	mkdir $cluster_directory &&
	#for $value, $input_file in enumerate($autocycler_dir)
   		#if $input_file.is_of_type("yaml")
        		#set input_id = $input_file.element_identifier
        		#set renamed_id = re.sub(r'_yaml(?=(\.[^.]+)?$)', '', input_id)
        		#if not renamed_id.endswith('.yaml')
            			#set renamed_id = f"{renamed_id}.yaml"
        		#end if
        		ln -s $input_file '$cluster_directory/${renamed_id}' &&
    		#end if
	#end for

	### create table header
	autocycler table > metric.tsv &&

	autocycler table 
	--autocycler_dir cluster_directory/
	--name ${renamed_id}
	#if $sigfigs:
            --sigfigs '$sigfigs'
        #end if
	>> metric.tsv
	&& mv metric.tsv '$output_table' 2>&1
    ]]></command>
    <inputs>
	<param name="autocycler_dir" type="data_collection" collection_type="list" label="assembled sequences"
		help="collection containing AutoCycler yaml file"/>

        <param name="sigfigs" type="integer" min="1" max="10" value="3" label="Significant figures"
               help="Number of significant digits for floating point values"/>
    </inputs>
    <outputs>
        <data name="output_table" format="tabular" label="${tool.name} on ${on_string}: summary table"/>
    </outputs>
    <tests>
	<test>
	    <param name="autocycler_dir">
                <collection type="list">
                    <element name="assemblies" value="input_assemblies_yaml.yaml" ftype="yaml"/>
                </collection>
	    </param>
	    <output name="output_table" ftype="tabular" compare="diff" lines_diff="3" file="metric.tsv"/>
        </test>
    </tests>
    <help><![CDATA[
**AutoCycler Table Tool**

The autocycler table command generates a TSV line from the various metrics stored in YAML files during an Autocycler assembly.
When conducting many automated Autocycler assemblies, you can use Autocycler cluster to build a TSV file containing metrics for each assembly. This can allow you to identify any samples which have assembled poorly and warrant further investigation.

**Inputs**
	    
- Autocyler output (i.e collection)

**Parameters**
	    
- Significant figures: Precision for numeric values (1-10)

**Outputs**
	    
- Tab-delimited table with selected metrics

**Available Fields**
	    
- input_read_count: Number of input reads
- input_read_bases: Total bases in input
- input_read_n50: N50 of input reads
- pass_cluster_count: Number of passing clusters
- fail_cluster_count: Number of failing clusters
- overall_clustering_score: Quality score for clustering
- untrimmed_cluster_size: Size before trimming
- untrimmed_cluster_distance: Distance between sequences
- trimmed_cluster_size: Size after trimming
- trimmed_cluster_median: Median length after trimming
- trimmed_cluster_mad: Length variability (MAD)
- consensus_assembly_bases: Total assembled bases
- consensus_assembly_unitigs: Number of unitigs
- consensus_assembly_fully_resolved: Fully resolved status

**Notes**

- Some fields will be in multiple files and will be combined into a list. For example, the trimmed_sequence_length_mad metric is stored in 2_trimmed.yaml files which are made for each cluster. Since a single assembly can have multiple clusters, there can be multiple trimmed_sequence_length_mad metrics for an assembly (one value per cluster).
- Some metrics contain nested metrics, e.g. input_assembly_details. This can be used with Autocycler table, but all of their nested data will be combined into a single string, which can be clunky in TSV format. Only top-level metrics can be used with Autocycler table. For example, the filename metric is nested under input_assembly_details so cannot be used with Autocycler table.
- If a YAML file is missing from the Autocycler directory, that's okay, but any metric from that file will be blank.
- Autocycler table will ignore any YAML files (e.g. 1_untrimmed.yaml) found in QC-fail clusters. This means that any per-cluster metrics (e.g. untrimmed_cluster_size) will only contain data from QC-pass clusters.

**Example output**

::

	name       input_read_count  input_read_bases  input_read_n50  pass_cluster_count  fail_cluster_count  overall_clustering_score  untrimmed_cluster_size  untrimmed_cluster_distance   trimmed_cluster_size  trimmed_cluster_median  trimmed_cluster_mad  consensus_assembly_bases  consensus_assembly_unitigs  consensus_assembly_fully_resolved
	wildtype   206111            1881436150        20927           3                   0                   0.858                     [24,12,9]               [0.000173,0.000676,0.00164]  [17,11,7]             [2879034,4439,3125]     [1,0,0]              2886598                   3                           true
	walKT389A  170651            975514879         16573           3                   3                   0.820                     [24,11,11]              [0.00155,0.00359,0.00547]    [18,9,10]             [2879034,4439,3125]     [1,0,0]              2886598                   3                           true
	IMAL014    304441            1863791162        18223           3                   2                   0.841                     [24,11,12]              [0.00239,0.000676,0.000989]  [16,10,10]            [2879035,4439,3125]     [1,0,0]              2886599                   3                           true
	IMAL031    212199            1814081856        19308           3                   0                   0.857                     [24,13,10]              [0.00396,0.00161,0.00]       [17,11,10]            [2879034,4439,3125]     [0,0,0]              2886598                   3                           true
	IMAL058    105653            1057335967        24664           3                   2                   0.827                     [24,11,9]               [0.000550,0.00669,0.00260]   [16,9,7]              [2879033,4439,3125]     [1,0,0]              2886597                   3                           true
	IMAL065    198975            2093837921        20387           3                   1                   0.843                     [24,7,8]                [0.000405,0.00184,0.00128]   [17,5,7]              [2879034,4439,3125]     [0,0,0]              2886598                   3                           true
	IMAL070    76391             697918832         20037           3                   3                   0.832                     [24,13,8]               [0.00180,0.00207,0.00128]    [16,10,7]             [2879033,4439,3125]     [1,0,0]              2886598                   3                           true

**IMPORTANT**

The output table's columns and structure will change depending on your inputs. 

.. class:: infomark

**More Information**

- `Autocycler table`: https://github.com/rrwick/Autocycler/wiki/Autocycler-table

**Citations**


    ]]></help>
	    <expand macro="citations"/>
</tool>
