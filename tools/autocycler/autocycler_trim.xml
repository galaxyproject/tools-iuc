<tool id="autocycler_trim" name="AutoCycler Trim" version="@TOOL_VERSION@+galaxy0" profile="@PROFILE@">
    <description>trim assemblies within clusters based on alignment</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        mkdir cluster_dir &&
        ln -s '$cluster_dir' 'cluster_dir/1_untrimmed.gfa' &&
        autocycler trim
        --cluster_dir 'cluster_dir/'
        --min_identity '$min_identity'
        --max_unitigs '$max_unitigs'
        --mad '$mad'
        --threads "\${GALAXY_SLOTS:-2}"
        ]]></command>
    <inputs>
        <param argument="--cluster_dir" type="data" format="gfa1" label="Cluster" help="A cluster from cluster step"/>
        <param argument="--min_identity" type="float" min="0" max="1" value="0.75" label="Minimum alignment identity" help="Minimum identity for trimming alignments (0-1)"/>
        <param argument="--max_unitigs" type="integer" min="0" value="5000" label="Maximum unitigs for alignment" help="Set to 0 to disable trimming (default: 5000)"/>
        <param argument="--mad" type="float" min="0" value="5.0" label="Allowed length variability (MAD)" help="Median absolute deviations for length outliers (0 to disable)"/>    
    </inputs>
    <outputs>
        <data name="trimmed_gfa" format="gfa1" from_work_dir="cluster_dir/2_trimmed.gfa"/>
        <data name="trimmed_yaml" format="yaml" from_work_dir="cluster_dir/2_trimmed.yaml" label="${tool.name} on ${on_string}: yaml"/>
    </outputs>
    <tests>
        <test>
            <param name="cluster_dir" value="1_untrimmed.gfa" ftype="gfa1"/>
            <param name="min_identity" value="0.75"/>
            <param name="max_unitigs" value="5000"/>
            <param name="mad" value="5.0"/>
            <output name="trimmed_gfa" file="2_trimmed.gfa" ftype="gfa1" compare="diff"/>
            <output name="trimmed_yaml" file="2_trimmed.yaml" ftype="yaml"/>
        </test>
        
        <test>
            <param name="cluster_dir" value="qc_pass/cluster_003/1_untrimmed.gfa" ftype="gfa1"/>
            <output name="trimmed_gfa" file="qc_pass/cluster_003/2_trimmed.gfa" ftype="gfa1"/>
            <output name="trimmed_yaml" file="qc_pass/cluster_003/2_trimmed.yaml" ftype="yaml"/>
        </test>

        <test>
            <param name="cluster_dir" value="qc_pass/cluster_011/1_untrimmed.gfa" ftype="gfa1"/>
            <output name="trimmed_gfa" file="qc_pass/cluster_011/2_trimmed.gfa" ftype="gfa1"/>
            <output name="trimmed_yaml" file="qc_pass/cluster_011/2_trimmed.yaml" ftype="yaml"/>
        </test>
    </tests>
    <help><![CDATA[
**AutoCycler Trim Tool**

Long-read contigs sometimes contain excess sequence which needs to be trimmed off. This often occurs with circular sequences (typical for bacteria) where there is overlap between the start and end of a contig. For small plasmids, this can sometimes involve the entire sequence being duplicated (or more) in a single contig. Linear sequences with hairpin ends can also create excess sequence which needs to be trimmed. This tool will trim assemblies within clusters based on alignment information.

**Inputs**

- A cluster (from cluster step)

**Parameters**

- Minimum identity: Alignment identity threshold for trimming (0-1, default: 0.75)
- Maximum unitigs: Limit for unitigs used in alignment (0 disables trimming, default: 5000)
- Length variability (MAD): Allowed size variation in median absolute deviations (0 disables, default: 5.0)

**Outputs**

- A trimmed GFA file
- A report in yaml format

**Notes**

- --max_unitigs 0 will turn off trimming. This is appropriate if you manually trimmed the sequences before running Autocycler.
- Using --mad 0 will turn off outlier exclusion, so all contigs will be included in the output 2_trimmed.gfa file.
- Autocycler trim cannot distinguish between artifactual and genuine duplications. E.g. if a plasmid really is doubled, Autocycler trim will still cut it down to a single copy.
- The 2_trimmed.gfa graph made by Autocycler trim contains GFA path lines for the trimmed input contigs, so it can be used with Autocycler decompress.
- The median absolute deviation is a good measure of how well trimming went. Ideally, this will be low (<50 bp or so). If it's high (e.g. 1000 bp), that suggests a lot of inconsistency in the contigs, which is a red flag.
- Since identity is calculated using unitigs not bases (see implementation below), the default value for --min_identity of 0.75 represents a relatively strong alignment. That parameter can be reduced to much lower levels (e.g. --min_identity 0.25) to find weaker alignments.

.. class:: infomark

**More Information**

- `Autocycler trim`: https://github.com/rrwick/Autocycler/wiki/Autocycler-trim

**Citations**


    ]]></help>
    <expand macro="citations"/>
</tool>
