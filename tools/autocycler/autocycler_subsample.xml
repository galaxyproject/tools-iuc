<tool id="autocycler_subsample" name="AutoCycler Subsample" version="@TOOL_VERSION@+galaxy0" profile="@PROFILE@">
    <description>subsample long reads for downstream assembly</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        mkdir -p out_dir &&
        autocycler subsample
        --reads '$reads'
        --out_dir out_dir
        --genome_size '$genome_size'
        --count '$count'
        --min_read_depth '$min_read_depth'
        --seed '$seed'
        ## - subsample does output plain text even if the input is zipped
        ## - Galaxy can't format_source for collections, so we rename them for discovery
        && mkdir fastq_out
        #if $reads.ext.endswith(".gz")
            && for i in out_dir/*fastq; do gzip -c "\$i" > fastq_out/\$(basename \$i .fastq).$reads.ext; done
        #else
            && for i in out_dir/*fastq; do mv "\$i" fastq_out/\$(basename \$i .fastq).$reads.ext; done
        #end if
        ]]></command>
    <inputs>
        <param argument="--reads" type="data" format="fastqsanger,fastqillumina,fastqsanger.gz,fastqillumina.gz" label="Input long reads (FASTQ)" help="Input long reads in FASTQ format"/>
        <param argument="--genome_size" type="text" label="Estimated genome size" help="Estimated genome size in bp (e.g., 5m for 5 megabases)"/> 
        <param argument="--count" type="integer" min="1" value="4" label="Number of subsampled read sets"
            help="Number of subsampled read sets to output"/>
        <param argument="--min_read_depth" type="float" min="0" value="25.0" label="Minimum read depth"
            help="Minimum allowed read depth for subsampling"/>
        <param argument="--seed" type="integer" optional="true" label="Random seed"
            help="Seed for random number generator (leave empty for random)"/>
    </inputs>
    <outputs>
        <collection name="subsampled_reads" type="list">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.(?P&lt;ext&gt;fastq(sanger|illumina)(\.gz)?)" directory="fastq_out"/>
        </collection>
        <data name="yaml" format="yaml" label="${tool.name} on ${on_string}: yaml" from_work_dir="out_dir/subsample.yaml"/>
    </outputs>
    <tests>
        <test>
            <param name="reads" value="SRR11550236_1_100.fq.gz" ftype="fastqsanger.gz"/>
            <param name="genome_size" value="5.5m"/>
            <param name="count" value="4"/>
            <param name="min_read_depth" value="0.01"/>
            <param name="seed" value="0"/>
            <output_collection name="subsampled_reads" type="list" count="4">
                <element name="sample_01" ftype="fastqsanger.gz" decompress="true">
                    <assert_contents>
                        <has_n_lines n="120"/>
                        <has_text text="@SRR11550236.4 4/1"/>
                        <has_size value="284330" delta="500"/>
                    </assert_contents>
                </element>
                <element name="sample_02" ftype="fastqsanger.gz" decompress="true">
                    <assert_contents>
                        <has_n_lines n="120"/>
                        <has_text text="@SRR11550236.2 2/1"/>
                        <has_size value="233372" delta="500"/>
                    </assert_contents>
                </element>
                <element name="sample_03" ftype="fastqsanger.gz" decompress="true">
                    <assert_contents>
                        <has_n_lines n="120"/>
                        <has_text text="@SRR11550236.3 3/1"/>
                        <has_size value="304218" delta="500"/>
                    </assert_contents>
                </element>
                <element name="sample_04" ftype="fastqsanger.gz" decompress="true">
                    <assert_contents>
                        <has_n_lines n="120"/>
                        <has_text text="@SRR11550236.1 1/1"/>
                        <has_size value="285428" delta="500"/>
                    </assert_contents>
                </element>        
            </output_collection>
            <output name="yaml" value="subsample.yaml">
                <assert_contents>
                    <has_n_lines n="16"/>
                    <has_text text="input_read_count: 100"/>
                    <has_text text="input_read_bases: 469110"/>
                    <has_text text="input_read_n50: 5978"/>
                    <has_text text="count: 30"/>
                    <has_text text="n50: 6383"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**AutoCycler Subsampling Tool**

This tool subsamples long reads for downstream assembly using AutoCycler.

**Inputs**
        
- Input long reads in FASTQ format
- Estimated genome size (e.g., "5m" for 5 megabases)
- Output directory name

**Parameters**
        
- Number of subsampled read sets: How many different subsampled sets to create (default: 4)
- Minimum read depth: Minimum coverage depth to maintain (default: 25x)
- Random seed: Seed for reproducible results (default: 0 for random)

**Outputs**
        
- A collection of subsampled FASTQ files
    ]]></help>
    <expand macro="citations"/>
</tool>
