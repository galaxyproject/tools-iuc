<?xml version="1.0"?>
<tool id="mags_visualization" name="MAGs visualization" version="0.0.2+galaxy0" profile="22.05">
  <description>Plots and dashboards for MAG evaluation outputs</description>

  <requirements>
    <requirement type="package" version="0.0.2">mags-visualization</requirement>
  </requirements>

  <version_command><![CDATA[mags-visualization --version]]></version_command>

  <command detect_errors="exit_code"><![CDATA[
mags-visualization
  --output out
#if $infiles.coverm:
  --coverm "$infiles.coverm"
#end if
#if $infiles.checkm:
  --checkm "$infiles.checkm"
#end if
#if $infiles.checkm2:
  --checkm2 "$infiles.checkm2"
#end if
#if $infiles.gtdb:
  --gtdb "$infiles.gtdb"
#end if
#if $infiles.drep:
  --drep "$infiles.drep"
#end if
#if $infiles.quast:
  --quast "$infiles.quast"
#end if
#if $infiles.bakta:
  --bakta "$infiles.bakta"
#end if
#if $infiles.metadata:
  --metadata "$infiles.metadata"
#end if
  --format "$basic.format"
  --rank "$basic.rank"
  --top_n "$basic.top_n"
#if $basic.color_by:
  --color_by "$basic.color_by"
#end if
#if $basic.tax_level:
  --tax_level "$basic.tax_level"
#end if
#if $basic.max_col:
  --max_col "$basic.max_col"
#end if
#if $basic.no_log:
  --no_log
#end if
#if $meta.meta_col:
  --meta_col "$meta.meta_col"
#end if
#if $meta.meta_bin_width:
  --meta_bin_width "$meta.meta_bin_width"
#end if
#if $meta.meta_cols and len($meta.meta_cols) > 0:
  --meta_cols
#for $mc in $meta.meta_cols:
  "$mc.col"
#end for
#end if
#if $drep.tax_levels and len($drep.tax_levels) > 0:
  --tax_levels
#for $tl in $drep.tax_levels:
  "$tl.level"
#end for
#end if
#if $quast.column_choice and len($quast.column_choice) > 0:
  --column_choice
#for $c in $quast.column_choice:
  "$c.metric"
#end for
#end if
#if $bakta.bakta_metrics and len($bakta.bakta_metrics) > 0:
  --bakta_metrics
#for $bm in $bakta.bakta_metrics:
  "$bm.metric"
#end for
#end if
#if $bakta.ratio:
  --ratio
#end if
  --top_bar_spacer "$layout.top_bar_spacer"
  --spacer_meta "$layout.spacer_meta"
  --top_bar_height "$layout.top_bar_height"
  --fig_height_per_row "$layout.fig_height_per_row"
  --fig_base_height "$layout.fig_base_height"
  --hspace "$layout.hspace"
  --heatmap_width "$layout.heatmap_width"
  --meta_bar_thickness "$layout.meta_bar_thickness"
  --title_y "$layout.title_y"
  --spacer_legend "$layout.spacer_legend"
  --spacer_heatmap "$layout.spacer_heatmap"
  --legend "$layout.legend"
  --meta_bar_add "$layout.meta_bar_add"
  ]]></command>


  <inputs>
    <section name="infiles" title="Inputs" expanded="true">
      <param name="coverm" type="data" format="tabular,tsv" optional="true" label="CoverM table"/>
      <param name="checkm" type="data" format="tabular,tsv" optional="true" label="CheckM table"/>
      <param name="checkm2" type="data" format="tabular,tsv" optional="true" label="CheckM2 table"/>
      <param name="gtdb" type="data" format="tabular,tsv" optional="true" label="GTDB table"/>
      <param name="drep" type="data" format="csv,tabular,tsv" optional="true" label="dRep table"/>
      <param name="quast" type="data" format="tabular,tsv" optional="true" label="QUAST table"/>
      <param name="bakta" type="data" format="tabular,tsv" optional="true" label="Bakta table"/>
      <param name="metadata" type="data" format="tabular,tsv" optional="true" label="Metadata table"/>
    </section>

    <section name="basic" title="Basic options" expanded="true">
      <param name="format" type="select" label="Output image format">
        <option value="png" selected="true">png</option>
        <option value="pdf">pdf</option>
        <option value="svg">svg</option>
      </param>

      <param name="rank" type="select" label="Rank for rank-sankey">
        <option value="domain">domain</option>
        <option value="phylum" selected="true">phylum</option>
        <option value="class">class</option>
        <option value="order">order</option>
        <option value="family">family</option>
        <option value="genus">genus</option>
        <option value="species">species</option>
      </param>

      <param name="top_n" type="integer" value="30" min="1" label="Top N for rank distribution"/>
      <param name="color_by" type="select" optional="true" label="Color points by (assembly quality plots)">
        <option value="quality">quality</option>
        <option value="tax" selected="true">tax</option>
        <option value="meta">meta</option>
      </param>

      <param name="tax_level" type="select" optional="true" label="Taxonomic level for taxonomy-colored plots">
        <option value="domain">domain</option>
        <option value="phylum" selected="true">phylum</option>
        <option value="class">class</option>
        <option value="order">order</option>
        <option value="family">family</option>
        <option value="genus">genus</option>
        <option value="species">species</option>
      </param>

      <param name="max_col" type="integer" optional="true" value="10" min="1" label="Max shown taxonomy names (max_col)"/>

      <param name="no_log" type="boolean" checked="false" label="Disable log10 scaling for MAGs/rank bar plot (--no_log)"/>
    </section>

    <section name="meta" title="Metadata options" expanded="false">
      <param name="meta_col" type="text" optional="true" label="Metadata column to color by (--meta_col)"/>
      <param name="meta_bin_width" type="float" optional="true" value="5.0" label="Bin width for numeric metadata (--meta_bin_width)"/>

      <repeat name="meta_cols" title="List of metadata columns (--meta_cols ...)" min="0">
        <param name="col" type="text" label="Metadata column name"/>
      </repeat>
    </section>

    <section name="drep" title="dRep options" expanded="false">
      <repeat name="tax_levels" title="Taxonomy levels for dRep cluster plot (--tax_levels ...)" min="0">
        <param name="level" type="select" label="Tax level">
          <option value="domain">domain</option>
          <option value="phylum" selected="true">phylum</option>
          <option value="class">class</option>
          <option value="order">order</option>
          <option value="family">family</option>
          <option value="genus" selected="true">genus</option>
          <option value="species">species</option>
        </param>
      </repeat>
    </section>

    <section name="quast" title="QUAST dashboard options" expanded="false">
      <repeat name="column_choice" title="QUAST metrics to plot (--column_choice ...)" min="0">
        <param name="metric" type="text" label="Exact QUAST metric name (e.g. N50, GC, # contigs)"/>
      </repeat>
    </section>

    <section name="bakta" title="Bakta options" expanded="false">
      <repeat name="bakta_metrics" title="Bakta metrics to plot (--bakta_metrics ...)" min="0">
        <param name="metric" type="text" label="Exact Bakta metric name (e.g. CDSs, hypotheticals)"/>
      </repeat>
      <param name="ratio" type="boolean" checked="false" label="Plot feature/CDS ratios (--ratio)"/>
    </section>

    <section name="layout" title="Heatmap layout options (advanced)" expanded="false">
      <param name="top_bar_spacer" type="float" value="0.0" label="Space between top histogram title (--top_bar_spacer)"/>
      <param name="spacer_meta" type="float" value="2.0" label="Spacer between meta bars and heatmap (--spacer_meta)"/>
      <param name="top_bar_height" type="float" value="0.7" label="Relative height of top histogram (--top_bar_height)"/>

      <param name="fig_height_per_row" type="float" value="0.5" label="Height per sample row (--fig_height_per_row)"/>
      <param name="fig_base_height" type="float" value="2.5" label="Base height for margins (--fig_base_height)"/>
      <param name="hspace" type="float" value="0.25" label="Vertical spacing between top and heatmap (--hspace)"/>
      <param name="heatmap_width" type="float" value="11.0" label="Heatmap width ratio (--heatmap_width)"/>

      <param name="meta_bar_thickness" type="float" value="0.8" label="Thickness of metadata bars (--meta_bar_thickness)"/>
      <param name="title_y" type="float" value="0.95" label="Vertical position of title (--title_y)"/>
      <param name="spacer_legend" type="float" value="0.3" label="Spacer between legend and meta bars (--spacer_legend)"/>
      <param name="spacer_heatmap" type="float" value="0.1" label="Spacer between heatmap and histogram (--spacer_heatmap)"/>
      <param name="legend" type="float" value="2.5" label="Legend width (--legend)"/>
      <param name="meta_bar_add" type="float" value="1.5" label="Additional width for meta bars (--meta_bar_add)"/>
    </section>
  </inputs>

  <outputs>
    <collection name="plots" type="list" label="MAGs visualization outputs">
      <discover_datasets
        directory="out"
        pattern="(?P&lt;designation&gt;.+)\.(?P&lt;ext&gt;png|pdf|svg|html)$"
        visible="true"/>
    </collection>
  </outputs>

  <tests>
    <test>
      <param name="infiles|checkm" value="checkm.tsv"/>
      <param name="infiles|checkm2" value="checkm2.tsv"/>
      <param name="infiles|drep" value="drep.csv"/>
      <param name="infiles|gtdb" value="gtdb.tsv"/>
      <param name="infiles|metadata" value="metadata.tsv"/>
      <param name="infiles|coverm" value="coverm.tsv"/>
      <param name="infiles|quast"  value="quast.tsv"/>
      <param name="infiles|bakta"  value="bakta.tsv"/>
      
      <param name="basic|format" value="png"/>
      <param name="basic|top_n" value="30"/>
      <param name="basic|color_by" value="tax"/>
      <param name="basic|tax_level" value="phylum"/>
      <param name="basic|no_log" value="false"/>

      <param name="layout|top_bar_spacer" value="-0.5"/>
      <param name="layout|spacer_meta" value="2.5"/>

      <output_collection name="plots" type="list">
        <element name="comp_conta_marginals_checkm">
          <assert_contents><has_size min="1"/></assert_contents>
        </element>
        <element name="comp_conta_marginals_checkm2">
          <assert_contents><has_size min="1"/></assert_contents>
        </element>
        <element name="sankey_plot">
          <assert_contents><has_size min="1"/></assert_contents>
        </element>
        <element name="sankey_plot_rank_filtered">
          <assert_contents><has_size min="1"/></assert_contents>
        </element>
      </output_collection>
    </test>
  </tests>


  <help><![CDATA[
MAGs visualization creates multiple plots and HTML dashboards from common MAG
evaluation tables such as CheckM/CheckM2, dRep, GTDB, QUAST, Bakta, CoverM and metadata.

All generated plots are returned as a collection.
  ]]></help>

  <citations>
    <citation type="bibtex">
@misc{mags_visualization,
  author = {Alexandra H. and contributors},
  title = {MAGs-visualization},
  year = {2026},
  howpublished = {\url{https://github.com/alexandrah1704/MAGs-visualization}},
}
    </citation>
  </citations>

</tool>