<tool id="hal_maf2hal" name="maf2hal" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>imports MAF into HAL database</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive">
        <![CDATA[
        #if $mode.append:
            ## If an input HAL file is provided to append to, ensure that it is not modified.
            cp '$mode.input_hal' writable_hal.hal
            && 
        #end if

        maf2hal
            #if $inputFormat.type == "mmap":
                --format 'mmap'
                --mmapFileSize $inputFormat.mmapFileSize
            #end if
            #if $refGenome:
                --refGenome '$refGenome'
            #end if
            #if $targetGenomes:
                --targetGenomes '$targetGenomes'
            #end if
            #if $mode.append:
                --append
            #end if
            '$input_maf' writable_hal.hal 
    ]]></command>
    <inputs>
        <param name="input_maf" type="data" format="maf" label="MAF file"/>
        <param argument="--refGenome" type="text" value="" optional="true" label="Reference genome" help="Name of the reference genome in the MAF file (first found if empty)">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_trim"/>
        </param> 
        <param argument="--targetGenomes" type="text" value="" optional="true" label="Target genomes" help="Comma-separated (no spaces) list of genomes to target (others are excluded) (vist all if empty)">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_comma_list"/>   
        </param>    
        <conditional name="mode">
            <param name="append" type="boolean" checked="false" label="Append to existing HAL file" help="Append MAF as subtree to an existing alignment. Reference genome must already be present in HAL file as a leaf (--append)"/>
            <when value="true">
                <expand macro="input_hal"/>
            </when>
            <when value="false"/>
        </conditional>
        <expand macro="hal_backend_format_extended"/>   
    </inputs>
    <outputs>
        <data name="ouput_hal" format="hal" label="${tool.name} on ${on_string}: HAL file" from_work_dir="writable_hal.hal"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_maf" value="maf2halTest.maf"/>
            <assert_stdout>
                <has_text text="Total Number of blocks in maf"/>
            </assert_stdout>
        </test>
        <test expect_num_outputs="1">
            <param name="input_maf" value="maf2halTestAppend.maf"/>
            <conditional name="mode">
                <param name="append" value="true"/>
                <param name="input_hal" value="maf2halTestAppend.hal"/>
            </conditional>
            <assert_stdout>
                <has_text text="Total Number of blocks in maf"/>
            </assert_stdout>
        </test>
    </tests>
    <help><![CDATA[
maf2hal takes a MAF alignment as input and produces a HAL database as output.
It can build a new HAL file or attach the MAF as a subtree if the reference genome already exists as a leaf. 
You can specify the reference genome and limit import to selected target genomes. 
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>