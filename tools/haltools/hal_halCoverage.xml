<tool id="hal_halCoverage" name="halCoverage" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>calculates coverage by sampling bases</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive"><![CDATA[
        halCoverage
            --numSamples $numSamples
            --seed $seed
            $bySequence
            '$input_hal' '$refGenome' 
            ## If lines with "Coverage" can be found, format them to support csv style to maintain structure
            | sed '/^Coverage on/ s/.*/"&",,,,,/' > '$out_file'
    ]]></command>
    <inputs>
        <expand macro="input_hal"/>
        <expand macro="params_refGenome"/>
        <expand macro="params_numSamples"/>
        <expand macro="params_seed"/>
        <param argument="--bySequence" type="boolean" truevalue="--bySequence" falsevalue="" checked="false" label="Coverage breakdown by sequence" help="Provide coverage breakdown by sequence in reference genome"/>
    </inputs>
    <outputs>
        <data name="out_file" format="csv" label="${tool.name} on ${on_string}: ${refGenome}"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="refGenome" value="Genome_1"/>
            <param name="seed" value="100"/>
            <output name="out_file" ftype="csv">
                <assert_contents>
                    <has_line line="Genome_2, 856475, 482343, 482343, 214021, 0"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="refGenome" value="Genome_1"/>
            <param name="numSamples" value="1000"/>
            <param name="seed" value="100"/>
            <output name="out_file" ftype="csv">
                <assert_contents>
                    <has_line line="Genome_3, 839, 839, 623, 512, 147"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="refGenome" value="Genome_1"/>
            <param name="bySequence" value="true"/>
            <param name="seed" value="100"/>
            <output name="out_file" ftype="csv">
                <assert_contents>
                    <has_line line="Genome_3, 856475, 856475, 641988, 540381, 160470"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
halCoverage estimates how well a reference genome is represented in a HAL alignment by randomly sampling bases. 
It takes a HAL file and a reference genome name as input and produces a csv file summarizing the result. 
A random seed can be adjusted for reproducibility.

Use it for assessing alignment completeness and identifying underrepresented regions in a genome alignment.

-----

.. class:: warningmark

Running the tool on a HAL file in mmap format may fail or run infinite if 'Coverage breakdown by sequence' is enabled, while the HDF5 format can run successfully. It is recommended to convert the input to HDF5 format first using halExtract.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>