<tool id="hal_halliftover" name="halLiftover" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>maps BED genome interval coordinates between two genomes</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive"><![CDATA[
        #if $mode.append == 'true':
            ## If an input BED file is provided to append to, ensure that it is not modified.
            cp '$tgtBed' writable_tgtBed.bed && 
        #end if
        halLiftover
            #if $coalescenceLimit:
                --coalescenceLimit '$coalescenceLimit'
            #end if
            #if $columns.num == 'true':
                --bedType $columns.bedType
            #end if
            #if $mode.append == 'true':
                --append
            #end if
            #if $output.format == 'PSL':
                --outPSL
                $output.outPSLWithName
            #end if
            $noDupes
            '$input_hal' '$srcGenome' '$srcBed' '$tgtGenome' writable_tgtBed.bed
    ]]></command>
    <inputs>
        <expand macro="input_hal"/>
        <param name="srcBed" type="data" format="bed" optional="false" label="BED file"/>
        <expand macro="params_srcGenome"/>
        <expand macro="params_tgtGenome"/>
        <expand macro="params_noDupes"/>
        <param argument="--coalescenceLimit" type="text" value="" optional="true" label="Coalescence limit genome" help="Genome name at or above the MRCA of the source and target genome where the search for homologies stops (default: MRCA)">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_trim"/>
        </param>
        <conditional name="columns">
            <param name="num" type="select" label="Specify number of standard columns" help="This only needs to be set if the BED file has less than the standard 12 columns, and if non-standard extra columns appear within the standard column range, to indicate where the standard columns end">
                <option value="false" selected="true">No, use default number of standard columns (default)</option>
                <option value="true">Yes, specify number of standard columns (--bedType)</option>
            </param>
            <when value="true">  
                <param name="bedType" type="integer" min="3" max="12" value="3" label="Number of standard columns" help="Valid range is from 3 to 12. Columns beyond this number are passed through to the output"/>
            </when>
            <when value="false"/>
        </conditional>
        <conditional name="mode">
            <param name="append" type="select" label="Append results to an existing BED or PSL file">
                <option value="false" selected="true">No, create a new file (default)</option>
                <option value="true">Yes, append to an existing file (--append)</option>
            </param>
            <when value="true">
                <param name="tgtBed" type="data" format="bed,psl" optional="false" label="Target BED or PSL file" help="Note that the file format should match with 'Output format' below; otherwise, formats may be mixed"/>
            </when>
            <when value="false"/>
        </conditional>
        <conditional name="output">
            <param name="format" type="select" label="Output format">
                <option value="BED" selected="true">BED (default)</option>
                <option value="PSL">PSL (--outPSL)</option>
            </param>
            <when value="BED"/>
            <when value="PSL">      
                <param argument="--outPSLWithName" type="boolean" truevalue="--outPSLWithName" falsevalue="" checked="false" label="Prepend BED name" help="Prepends the BED name (standard column 4 from BED file, blank used if missing) to the PSL line"/>
            </when>
        </conditional>
   </inputs>
    <outputs>
        <data name="output_file" format="bed" label="${tool.name} on ${on_string}" from_work_dir="writable_tgtBed.bed">
            <change_format>
                <when input="output.format" value="PSL" format="psl"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="srcGenome" value="Genome_0"/>
            <param name="srcBed" value="halLiftover.bed"/>
            <param name="tgtGenome" value="Genome_1"/>
            <output name="output_file" ftype="bed">
                <assert_contents>
                    <has_n_lines n="9"/>
                    <has_line line="Genome_1_seq&#009;0&#009;243&#009;Region_A"/>
                    <has_line line="Genome_1_seq&#009;2637&#009;2930&#009;Region_B"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="srcGenome" value="Genome_0"/>
            <param name="srcBed" value="halLiftover.bed"/>
            <param name="tgtGenome" value="Genome_1"/>
            <conditional name="output">
                <param name="format" value="PSL"/>
            </conditional>
            <output name="output_file" ftype="psl">
                <assert_contents>
                    <has_n_lines n="8"/>
                    <has_line line="243&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;++&#009;Genome_0_seq&#009;1758&#009;0&#009;243&#009;Genome_1_seq&#009;5472&#009;0&#009;243&#009;1&#009;243,&#009;0,&#009;0,"/>
                    <has_line line="343&#009;0&#009;0&#009;0&#009;0&#009;0&#009;1&#009;586&#009;++&#009;Genome_0_seq&#009;1758&#009;243&#009;586&#009;Genome_1_seq&#009;5472&#009;2001&#009;2930&#009;2&#009;50,293,&#009;243,293,&#009;2001,2637,"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="srcGenome" value="Genome_0"/>
            <param name="srcBed" value="halLiftover.bed"/>
            <param name="tgtGenome" value="Genome_1"/>
            <conditional name="output">
                <param name="format" value="PSL"/>
                <param name="outPSLWithName" value="true"/>
            </conditional>
            <output name="output_file" ftype="psl">
                <assert_contents>
                    <has_n_lines n="8"/>
                    <has_line line="Region_A&#009;243&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;++&#009;Genome_0_seq&#009;1758&#009;0&#009;243&#009;Genome_1_seq&#009;5472&#009;0&#009;243&#009;1&#009;243,&#009;0,&#009;0,"/>
                    <has_line line="Region_B&#009;343&#009;0&#009;0&#009;0&#009;0&#009;0&#009;1&#009;586&#009;++&#009;Genome_0_seq&#009;1758&#009;243&#009;586&#009;Genome_1_seq&#009;5472&#009;2001&#009;2930&#009;2&#009;50,293,&#009;243,293,&#009;2001,2637,"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="srcGenome" value="Genome_0"/>
            <param name="srcBed" value="halLiftover.bed"/>
            <param name="tgtGenome" value="Genome_1"/>
            <param name="noDupes" value="true"/>
            <output name="output_file" ftype="bed">
                <assert_contents>
                    <has_n_lines n="3"/>
                    <has_line line="Genome_1_seq&#009;0&#009;243&#009;Region_A"/>
                    <has_line line="Genome_1_seq&#009;4223&#009;4323&#009;Region_C"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="srcGenome" value="Genome_0"/>
            <param name="srcBed" value="halLiftover.bed"/>
            <param name="tgtGenome" value="Genome_1"/>
            <conditional name="mode">
                <param name="append" value="true"/>
                <param name="tgtBed" value="halLiftover_append.bed"/>
            </conditional>
            <output name="output_file" ftype="bed">
                <assert_contents>
                    <has_n_lines n="18"/>
                    <has_line line="Genome_1_seq&#009;0&#009;243&#009;Region_A"/>
                    <has_line line="Genome_1_seq&#009;4223&#009;4323&#009;Region_C"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
halLiftover maps genomic intervals from one genome to another using a HAL multiple alignment.
It takes a BED file (with SequenceName, StartPosition, and LastPosition+1) that contains coordinates from the source genome and maps those to a specified target genome. 
The outputs are written to a new BED file or appended to an existing one.

The tool does a base-by-base mapping between any two sequences in the alignment (following paralogy relations as well). 
It can handle extra columns in the BED file, avoid duplication based mappings, or change the coalescence limit used when searching for homologies. 

Use it when you need accurate cross species coordinate transfer for annotations, features, or any BED style intervals.

.. class:: infomark

Annotations in Wiggle format can be mapped using halWiggleLiftover.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>