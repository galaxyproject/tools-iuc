<tool id="hal_halLiftover" name="halLiftover" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>maps BED or PSL genome interval coordinates between two genomes</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive"><![CDATA[
        #if $mode.append:
            cp '$tgtBed' writable_tgtBed.bed
            && chmod u+rw writable_tgtBed.bed
            && 
        #end if

        halLiftover
            #if $inputFormat == "mmap":
                --format 'mmap'
            #end if
            #if $coalescenceLimit:
                --coalescenceLimit '$coalescenceLimit'
            #end if
            #if $columns.num:
                --bedType $columns.bedType
            #end if
            #if $mode.append:
                --append
            #end if
            #if $output.format == "PSL":
                --outPSL
                $output.outPSLWithName
            #end if
            $noDupes
            '$input_hal' '$srcGenome' '$srcBed' '$tgtGenome' writable_tgtBed.bed
    ]]></command>
    <inputs>
        <expand macro="input_hal"/>
        <expand macro="hal_backend_format"/>
        <param name="srcBed" type="data" format="bed" optional="false" label="BED file"/>
        <param name="srcGenome" type="text" optional="false" label="Source genome" help="Source genome name present in the HAL and BED file from which coordinates should be mapped">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_trim"/>
        </param>
        <param name="tgtGenome" type="text" optional="false" label="Target genome" help="Target genome name present in the HAL file to which coordinates should be mapped">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_trim"/>
        </param>
        <param argument="--noDupes" type="boolean" truevalue="--noDupes" falsevalue="" checked="false" label="No duplicates" help="Do not map between duplications in graph"/>
        <param argument="--coalescenceLimit" type="text" value="" optional="true" label="Coalescence limit genome" help="Genome name at or above the MRCA of the source and target genome where the search for homologies stops (default: MRCA)">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_trim"/>
        </param>
        <conditional name="columns">
            <param name="num" type="boolean" checked="false" label="Specify number of standard columns" help="This only needs to be enabled if the BED file has less than the standard 12 columns, and if non-standard extra columns appear within the standard column range, to indicate where the standard columns end"/>
            <when value="true">  
                <param argument="--bedType" type="integer" min="3" max="12" value="3" label="Number of standard columns" help="Valid range is from 3 to 12. Columns beyond this number are passed through to the output"/>
            </when>
            <when value="false"/>
        </conditional>
        <conditional name="mode">
            <param name="append" type="boolean" checked="false" label="Append results to an existing BED or PSL file" help="Note that the file format should match with 'Output format' below; otherwise, formats may be mixed (--append)"/>
            <when value="true">
                <param name="tgtBed" type="data" format="bed,psl" optional="false" label="Target BED or PSL file"/>
            </when>
            <when value="false"/>
        </conditional>
        <conditional name="output">
            <param name="format" type="select" label="Output format">
                <option value="BED" selected="true">BED (default)</option>
                <option value="PSL">PSL (--outPSL)</option>
            </param>
            <when value="BED"/>
            <when value="PSL">      
                <param argument="--outPSLWithName" type="boolean" truevalue="--outPSLWithName" falsevalue="" checked="false" label="Prepend BED name" help="Prepends the BED name (standard column 4 from BED file, blank used if missing) to the PSL line"/>
            </when>
        </conditional>
   </inputs>
    <outputs>
        <data name="output_file" format="bed" label="${tool.name} on ${on_string}: ${srcGenome} -> ${tgtGenome} ${noDupes}" from_work_dir="writable_tgtBed.bed" >
            <change_format>
                <when input="output.format" value="PSL" format="psl"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="srcGenome" value="Genome_0"/>
            <param name="srcBed" value="halLiftover.bed"/>
            <param name="tgtGenome" value="Genome_1"/>
            <output name="output_file" ftype="bed" file="halLiftover_output.bed"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="srcGenome" value="Genome_0"/>
            <param name="srcBed" value="halLiftover.bed"/>
            <param name="tgtGenome" value="Genome_1"/>
            <conditional name="output">
                <param name="format" value="PSL"/>
            </conditional>
            <output name="output_file" ftype="psl" file="halLiftover_output.psl"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="srcGenome" value="Genome_0"/>
            <param name="srcBed" value="halLiftover.bed"/>
            <param name="tgtGenome" value="Genome_1"/>
            <conditional name="output">
                <param name="format" value="PSL"/>
                <param name="outPSLWithName" value="true"/>
            </conditional>
            <output name="output_file" ftype="psl" file="halLiftover_outPSLWithName_output.psl"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="srcGenome" value="Genome_0"/>
            <param name="srcBed" value="halLiftover.bed"/>
            <param name="tgtGenome" value="Genome_1"/>
            <param name="noDupes" value="true"/>
            <output name="output_file" ftype="bed" file="halLiftover_noDupes_output.bed"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="srcGenome" value="Genome_0"/>
            <param name="srcBed" value="halLiftover.bed"/>
            <param name="tgtGenome" value="Genome_1"/>
            <conditional name="mode">
                <param name="append" value="true"/>
                <param name="tgtBed" value="halLiftover_append.bed"/>
            </conditional>
            <output name="output_file" ftype="bed" file="halLiftover_append_output.bed"/>
        </test>
    </tests>
    <help><![CDATA[
halLiftover transfers genomic intervals from one genome to another using a HAL multiple alignment.
It takes a BED file (with SequenceName, StartPosition, and LastPosition+1) that contains coordinates from the source genome and maps those to a specified target genome. 
The outputs are written to a new BED file or appended to an existing one, and can also be output in PSL format if requested.

The tool does a base-by-base mapping between any two sequences in the alignment (following paralogy relations as well). 
It can handle extra columns in the BED file, avoid duplication based mappings, or change the coalescence limit used when searching for homologies. 

Use it when you need accurate cross species coordinate transfer for annotations, features, or any BED style intervals.

.. class:: infomark

Annotations in Wiggle format can be mapped using halWiggleLiftover.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>