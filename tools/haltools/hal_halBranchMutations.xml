<tool id="hal_halbranchmutations" name="halBranchMutations" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>identifies mutations on a branch between given genome and its parent</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive"><![CDATA[
        halBranchMutations
            #if $support.file == 'true':
                --refTargets '$support.refTargets'
            #end if
            #if $mode.export == 'sequence':
                --refSequence '$mode.sequence'
            #end if
            --start $start
            --length $length
            --maxGap $maxGap
            --maxNFraction $maxNFraction
            --refFile stdout
            --snpFile stdout
            --delBreakFile stdout
            --parentFile '$output_parentFile'
            '$input_hal' '$refGenome' > '$output_file'
    ]]></command>
    <inputs>
        <expand macro="input_hal"/>
        <param name="refGenome" type="text" value="" label="Reference genome" help="To be analyzed branch and its according parent. Must denote bottom node in a branch, and therefore cannot be the root itself">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_trim"/>
        </param> 
        <conditional name="support">
            <param name="file" type="select" label="Use a BED file for coordinates" help="Use a BED file to define intervals in the reference genome to process">
                <option value="false" selected="true">No, don't use a BED file (default)</option>
                <option value="true">Yes, use a BED file (--refTargets)</option>
            </param>
            <when value="false"/>
            <when value="true">
                <param name="refTargets" type="data" format="bed" label="BED file"/>
            </when>
        </conditional>
        <conditional name="mode">
            <param name="export" type="select" label="Sequence process options">
                <option value="default" selected="true">Process all sequences (default)</option>
                <option value="sequence">Process a reference sequence (--refSequence)</option>
            </param>
            <when value="default"/>
            <when value="sequence">
                <expand macro="params_sequence"/>
            </when>
        </conditional>
        <expand macro="params_start"/>
        <expand macro="params_length"/>
        <expand macro="params_maxGap"/>
        <expand macro="params_maxNFraction"/>
    </inputs>
    <outputs>
        <data name="output_file" format="bed" label="${tool.name} on ${on_string}"/>
        <data name="output_parentFile" format="bed" label="${tool.name} on ${on_string}: Rearrangements in reference's parent genome"/>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="input_hal" value="halTest.hal"/>
            <param name="refGenome" value="Genome_1"/>
            <output name="output_file" ftype="bed">
                <assert_contents>
                    <has_line line="#Sequence&#009;Start&#009;End&#009;MutationID&#009;ParentGenome&#009;ChildGenome"/>
                    <has_line line="Genome_1_seq&#009;1465&#009;1758&#009;I&#009;Genome_0&#009;Genome_1"/>
                    <has_line line="Genome_1_seq&#009;4395&#009;4688&#009;P&#009;Genome_0&#009;Genome_1"/>
                    <has_n_lines n="5"/>
                </assert_contents>
            </output>
            <output name="output_parentFile" ftype="bed">
                <assert_contents>
                    <has_line line="#Sequence&#009;Start&#009;End&#009;MutationID&#009;ParentGenome&#009;ChildGenome"/>
                    <has_line line="Genome_0_seq&#009;293&#009;879&#009;U&#009;Genome_0&#009;Genome_1"/>
                    <has_line line="Genome_0_seq&#009;586&#009;879&#009;U&#009;Genome_0&#009;Genome_1"/>
                    <has_n_lines n="13"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="2">
            <param name="input_hal" value="halTest.hal"/>
            <param name="refGenome" value="Genome_1"/>
            <param name="start" value="10"/>
            <param name="length" value="500"/>
            <output name="output_file" ftype="bed">
                <assert_contents>
                    <has_line line="#Sequence&#009;Start&#009;End&#009;MutationID&#009;ParentGenome&#009;ChildGenome"/>
                    <has_n_lines n="2"/>
                </assert_contents>
            </output>
            <output name="output_parentFile" ftype="bed">
                <assert_contents>
                    <has_line line="#Sequence&#009;Start&#009;End&#009;MutationID&#009;ParentGenome&#009;ChildGenome"/>
                    <has_line line="Genome_0_seq&#009;293&#009;879&#009;U&#009;Genome_0&#009;Genome_1"/>
                    <has_n_lines n="3"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="2">
            <param name="input_hal" value="halTest.hal"/>
            <param name="refGenome" value="Genome_1"/>
            <conditional name="mode">
                <param name="export" value="sequence"/>
                <param name="sequence" value="Genome_1_seq"/>
            </conditional>
            <output name="output_file" ftype="bed">
                <assert_contents>
                    <has_line line="#Sequence&#009;Start&#009;End&#009;MutationID&#009;ParentGenome&#009;ChildGenome"/>
                    <has_line line="Genome_1_seq&#009;1465&#009;1758&#009;I&#009;Genome_0&#009;Genome_1"/>
                    <has_line line="Genome_1_seq&#009;4395&#009;4688&#009;P&#009;Genome_0&#009;Genome_1"/>
                    <has_n_lines n="5"/>
                </assert_contents>
            </output>
            <output name="output_parentFile" ftype="bed">
                <assert_contents>
                    <has_line line="#Sequence&#009;Start&#009;End&#009;MutationID&#009;ParentGenome&#009;ChildGenome"/>
                    <has_line line="Genome_0_seq&#009;293&#009;879&#009;U&#009;Genome_0&#009;Genome_1"/>
                    <has_line line="Genome_0_seq&#009;586&#009;879&#009;U&#009;Genome_0&#009;Genome_1"/>
                    <has_n_lines n="13"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="2">
            <param name="input_hal" value="halTest.hal"/>
            <param name="refGenome" value="Genome_1"/>
            <conditional name="support">
                <param name="file" value="true"/>
                <param name="refTargets" value="halBranchMutations.bed"/>
            </conditional>
            <output name="output_file" ftype="bed">
                <assert_contents>
                    <has_line line="#Sequence&#009;Start&#009;End&#009;MutationID&#009;ParentGenome&#009;ChildGenome"/>
                    <has_line line="Genome_1_seq&#009;1465&#009;1758&#009;I&#009;Genome_0&#009;Genome_1"/>
                    <has_line line="Genome_1_seq&#009;4395&#009;4688&#009;P&#009;Genome_0&#009;Genome_1"/>
                    <has_n_lines n="5"/>
                </assert_contents>
            </output>
            <output name="output_parentFile" ftype="bed">
                <assert_contents>
                    <has_line line="#Sequence&#009;Start&#009;End&#009;MutationID&#009;ParentGenome&#009;ChildGenome"/>
                    <has_line line="Genome_0_seq&#009;586&#009;879&#009;U&#009;Genome_0&#009;Genome_1"/>
                    <has_line line="Genome_0_seq&#009;1172&#009;1465&#009;U&#009;Genome_0&#009;Genome_1"/>
                    <has_n_lines n="13"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
halBranchMutations detects mutations that occurred on the branch between a chosen genome and its parent in a HAL alignment. 
It reports point mutations, deletions, duplications, and other structural changes in an output BED file. 
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>