<tool id="hal_hal2fasta" name="hal2fasta" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>exports sequences to FASTA file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive"><![CDATA[
        hal2fasta 
            #if $inputFormat == "mmap":
                --format 'mmap'
            #end if
            #if $mode.export == "default":
                --start $start
                --length $length
            #else if $mode.export == "sequence":
                --sequence '$sequence'
                --start $start
                --length $length
            #else if $mode.export == "subtree":
                --subtree
            #end if
            --lineWidth $lineWidth
            $upper
            $ucscSequenceNames
            '$input_hal' '$genome' > '$out_file'
    ]]></command>
    <inputs>
        <expand macro="input_hal"/>        
        <expand macro="hal_backend_format"/>      
        <param name="genome" type="text" value="" optional="false" label="Reference genome" help="Reference genome present in HAL file">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_trim"/>
        </param>       
        <conditional name="mode">
            <param name="export" type="select" label="Export options">
                <option value="default" selected="true">Export all sequences (default)</option>
                <option value="sequence">Export a specific sequence (--sequence)</option>
                <option value="subtree">Export only sequences in subtree of the reference genome (--subtree)</option>
            </param>
            <when value="default">
                <param argument="--start" type="integer" min="0" value="0" optional="true" label="Start coordinate" help="Coordinate within reference genome to start at"/>
                <param argument="--length" type="integer" min="0" value="0" optional="true" label="Length to convert" help="Length of the reference genome to convert. If set to 0, the entire genome is converted"/>
            </when>
            <when value="subtree"/>
            <when value="sequence">
                <param name="sequence" type="text" value="" label="Sequence name" help="Sequence name in reference genome to export">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
                <param argument="--start" type="integer" min="0" value="0" optional="true" label="Start coordinate" help="Coordinate within sequence to start at"/>
                <param argument="--length" type="integer" min="0" value="0" optional="true" label="Length to convert" help="Length of the sequence to convert. If set to 0, the entire sequence is converted"/>
            </when>
        </conditional>
        <param argument="--upper" type="boolean" truevalue="--upper" falsevalue="" checked="false" label="Upper" help="Convert all bases to uppercase"/>
        <param argument="--ucscSequenceNames" type="boolean" truevalue="--ucscSequenceNames" falsevalue="" checked="false" label="Use UCSC convention" help="Use the UCSC convention of Genome.Sequence for names. By default, only sequence names are used"/>
        <param argument="--lineWidth" type="integer" min="1" value="80" label="Line width" help="Line width for output"/>
    </inputs>
    <outputs>
        <data name="out_file" format="fasta" label="${tool.name} on ${on_string}: FASTA of ${genome}"/>
    </outputs>
    <tests>
        <test>
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_0"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_0_seq"/>
                    <has_line line="CCCGTAACCCAATCCACGGTGCCGGCGGCGAGATGTATTGTCTGGGCGCAAAGCCATTTCGCCACCACATGCTGCGCGAC"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_0"/>
            <param name="lineWidth" value="40"/>
            <param name="upper" value="true"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_0_seq"/>
                    <has_line line="TGCCGCGCGTGAGGTTGACACTCCGTTCGTGTTACATGTC"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_0"/>
            <conditional name="mode">
                <param name="export" value="sequence"/>
                <param name="sequence" value="Genome_0_seq"/>
            </conditional>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_0_seq"/>
                    <has_line line="CCCGTAACCCAATCCACGGTGCCGGCGGCGAGATGTATTGTCTGGGCGCAAAGCCATTTCGCCACCACATGCTGCGCGAC"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_0"/>
            <conditional name="mode">
                <param name="export" value="subtree"/>
            </conditional>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_0_seq"/>
                    <has_line line=">Genome_1_seq"/>
                    <has_line line=">Genome_2_seq"/>
                    <has_line line=">Genome_3_seq"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_2"/>
            <conditional name="mode">
                <param name="export" value="sequence"/>
                <param name="sequence" value="Genome_2_seq"/>
                <param name="start" value="50"/>
                <param name="length" value="10"/>
            </conditional>
            <param name="ucscSequenceNames" value="true"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_2.Genome_2_seq"/>
                    <has_line line="GAGGTTGACA"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_0"/>
            <conditional name="mode">
                <param name="export" value="default"/>
                <param name="start" value="50"/>
                <param name="length" value="10"/>
            </conditional>
            <param name="ucscSequenceNames" value="true"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_0.Genome_0_seq"/>
                    <has_line line="GAGGTTGACA"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
hal2fasta exports sequence data from an input HAL file to an output FASTA file. 
It can export all sequences of a genome, a single specific sequence of that genome, or all sequences in the entire subtree rooted at that genome.
When exporting all sequences or a single sequence of that genome, extraction can be limited using start and length.
The tool also allows optional uppercase conversion, UCSC style sequence names, and custom line width for FASTA output.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>