<tool id="hal_hal2fasta" name="hal2fasta" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>exports sequences from HAL to FASTA</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive"><![CDATA[
        hal2fasta 
            #if $inputFormat == "mmap":
                --format 'mmap'
            #end if
            #if $mode.export == "default":
                --start $mode.start
                --length $mode.length
            #else if $mode.export == "--sequence":
                --sequence '$sequence'
                --start $mode.start
                --length $mode.length
            #else if $mode.export == "--subtree":
                --subtree
            #end if
            --lineWidth $lineWidth
            $upper
            $ucscSequenceNames
            '$input_hal' '$genome' > '$out_file'
    ]]></command>
    <inputs>
        <expand macro="input_hal"/>        
        <expand macro="hal_backend_format"/>      
        <param name="genome" type="text" value="" optional="false" label="Reference genome" help="Reference genome name to export">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_trim"/>
        </param>       
        <conditional name="mode">
            <param name="export" type="select" label="Export options">
                <option value="default" selected="true">Export full reference genome (default)</option>
                <option value="--sequence">Export a reference sequence (--sequence)</option>
                <option value="--subtree">Export all genomes in the reference genome subtree (--subtree)</option>
            </param>
            <when value="default">
                <param argument="--start" type="integer" min="0" value="0" optional="true" label="Start coordinate" help="Coordinate within reference genome to start at"/>
                <param argument="--length" type="integer" min="0" value="0" optional="true" label="Length to export" help="Length of the reference genome to export. If set to 0, the entire genome is exported"/>
            </when>
            <when value="--subtree"/>
            <when value="--sequence">
                <param name="sequence" type="text" value="" label="Reference sequence" help="Sequence name in reference genome to export">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
                <param argument="--start" type="integer" min="0" value="0" optional="true" label="Start coordinate" help="Coordinate within reference sequence to start at"/>
                <param argument="--length" type="integer" min="0" value="0" optional="true" label="Length to export" help="Length of the reference sequence to export. If set to 0, the entire sequence is exported"/>
            </when>
        </conditional>
        <param argument="--upper" type="boolean" truevalue="--upper" falsevalue="" checked="false" label="Uppercase bases" help="Convert all bases to uppercase"/>
        <param argument="--ucscSequenceNames" type="boolean" truevalue="--ucscSequenceNames" falsevalue="" checked="false" label="Use UCSC convention" help="Use the UCSC convention of Genome.Sequence for names. By default, only sequence names are used"/>
        <param argument="--lineWidth" type="integer" min="1" value="80" label="Line width" help="Line width for output"/>
    </inputs>
    <outputs>
        <data name="out_file" format="fasta" label="${tool.name} on ${on_string}: Genome FASTA"/>
    </outputs>
    <tests>
        <test expect_num_outputs="0">
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_0"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_0_seq"/>
                    <has_line line="CCCGTAACCCAATCCACGGTGCCGGCGGCGAGATGTATTGTCTGGGCGCAAAGCCATTTCGCCACCACATGCTGCGCGAC"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="0">
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_0"/>
            <param name="lineWidth" value="40"/>
            <param name="upper" value="true"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_0_seq"/>
                    <has_line line="TGCCGCGCGTGAGGTTGACACTCCGTTCGTGTTACATGTC"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="0">
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_0"/>
            <conditional name="mode">
                <param name="export" value="--sequence"/>
                <param name="sequence" value="Genome_0_seq"/>
            </conditional>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_0_seq"/>
                    <has_line line="CCCGTAACCCAATCCACGGTGCCGGCGGCGAGATGTATTGTCTGGGCGCAAAGCCATTTCGCCACCACATGCTGCGCGAC"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="0">
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_0"/>
            <conditional name="mode">
                <param name="export" value="--subtree"/>
            </conditional>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_0_seq"/>
                    <has_line line=">Genome_1_seq"/>
                    <has_line line=">Genome_2_seq"/>
                    <has_line line=">Genome_3_seq"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="0">
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_2"/>
            <conditional name="mode">
                <param name="export" value="--sequence"/>
                <param name="sequence" value="Genome_2_seq"/>
                <param name="start" value="50"/>
                <param name="length" value="10"/>
            </conditional>
            <param name="ucscSequenceNames" value="true"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_2.Genome_2_seq"/>
                    <has_line line="GAGGTTGACA"/>
                </assert_contents>
            </output>
        </test>
        <!-- 
        Does not pass currently due to a bug - that was fixed but not pinned as release
        https://github.com/ComparativeGenomicsToolkit/hal/issues/324

        <test expect_num_outputs="0">
            <param name="input_hal" value="halTest.hal"/>
            <param name="genome" value="Genome_0"/>
            <conditional name="mode">
                <param name="export" value="default"/>
                <param name="start" value="50"/>
                <param name="length" value="10"/>
            </conditional>
            <param name="ucscSequenceNames" value="true"/>
            <output name="out_file" ftype="fasta">
                <assert_contents>
                    <has_line line=">Genome_0.Genome_0_seq"/>
                    <has_line line="GAGGTTGACA"/>
                </assert_contents>
            </output>
        </test>
        -->
    </tests>
    <help><![CDATA[
hal2fasta exports sequence data from an input HAL file to an output FASTA file. 
It can export a full genome, a single sequence of that genome, or all genomes in the entire subtree rooted of that genome.
When exporting the full genome or a single sequence of that genome, the exported range can be limited using start and length.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>