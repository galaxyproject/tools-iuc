<tool id="hal_halstats" name="halStats" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>retrieve basic statistics from a HAL file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <command detect_errors="aggressive"><![CDATA[
        (
        #if $mode.option == "--baseComp":
            echo -e "fraction_of_As\tfraction_of_Gs\tfraction_of_Cs\tfraction_of_Ts";
        #else if $mode.option == "--numSegments":
            echo "numTopSegments numBottomSegments";
        #end if
        
        halStats 
            #if $inputFormat == "mmap":
                --format 'mmap'
            #end if
            #if $mode.option == "--allCoverage":
                $mode.allCoverage
            #else if $mode.option == "--branches":
                $mode.branches
            #else if $mode.option == "--genomes":
                $mode.genomes
            #else if $mode.option == "--metaData":
                $mode.metaData
            #else if $mode.option == "--root":
                $mode.root
            #else if $mode.option == "--tree":
                $mode.tree
            #else if $mode.option == "--baseComp":
                --baseComp '$mode.baseComp'
            #else if $mode.option == "--bedSequences":
                --bedSequences '$mode.bedSequences'
            #else if $mode.option == "--bottomSegments":
                --bottomSegments '$mode.bottomSegments'
            #else if $mode.option == "--branchLength":
                --branchLength '$mode.branchLength'
            #else if $mode.option == "--children":
                --children '$mode.children'
            #else if $mode.option == "--chromSizes":
                --chromSizes '$mode.chromSizes'
            #else if $mode.option == "--coverage":
                --coverage '$mode.coverage'
            #else if $mode.option == "--genomeMetaData":
                --genomeMetaData '$mode.genomeMetaData'
            #else if $mode.option == "--numSegments":
                --numSegments '$mode.numSegments'
            #else if $mode.option == "--parent":
                --parent '$mode.parent'
            #else if $mode.option == "--percentID":
                --percentID '$mode.percentID'
            #else if $mode.option == "--sequenceStats":
                --sequenceStats '$mode.sequenceStats'
            #else if $mode.option == "--sequences":
                --sequences '$mode.sequences'
            #else if $mode.option == "--span":
                --span '$mode.span'
            #else if $mode.option == "--spanRoot":
                --spanRoot '$mode.spanRoot'
            #else if $mode.option == "--topSegments":
                --topSegments '$mode.topSegments'
            #end if
            '$input_hal'
        ) > '$out_file'
    ]]></command>
    <inputs>
        <expand macro="input_hal"/>
        <expand macro="params_inputFormat"/>
        <conditional name="mode">
            <param name="option" type="select" label="Select a print option" help="Select a print option from the drop down to display its description and options">
                <option value="" selected="true">Default</option>
                <option value="--allCoverage">All Coverage (--allCoverage)</option>
                <option value="--branches">List of branches (--branches)</option>
                <option value="--sequences">List of sequences (--sequences)</option>
                <option value="--genomes">List of genomes (--genomes)</option>
                <option value="--baseComp">Base composition (--baseComp)</option>
                <option value="--bedSequences">Bed sequences (--bedSequences)</option>
                <option value="--sequenceStats">Stats for each sequence (--sequenceStats)</option>
                <option value="--topSegments">Top segments (--topSegments)</option>
                <option value="--bottomSegments">Bottom segments (--bottomSegments)</option>
                <option value="--numSegments">Number of segments (--numSegments)</option>
                <option value="--branchLength">Branch length (--branchLength)</option>
                <option value="--parent">Parent name (--parent)</option>
                <option value="--root">Root genome name (--root)</option>
                <option value="--children">Names of children (--children)</option>
                <option value="--chromSizes">Chrom sizes (--chromSizes)</option>
                <option value="--coverage">Histogram of coverage (--coverage)</option>
                <option value="--metaData">Metadata for alignment (--metaData)</option>
                <option value="--genomeMetaData">Metadata for given genome (--genomeMetaData)</option>
                <option value="--percentID">Percent ID (--percentID)</option>
                <option value="--span">Span (--span)</option>
                <option value="--spanRoot">Span root (--spanRoot)</option>
                <option value="--tree">NEWICK tree (--tree)</option>
            </param>
            <when value="--allCoverage">
                <param name="allCoverage" type="boolean" truevalue="--allCoverage" falsevalue="" checked="false" label="All Coverage" help="Print histogram of coverage from all genomes to all genomes" />
            </when>
            <when value="--baseComp">
                <param name="baseComp" type="text" value="" optional="true" label="Base composition" help="Print base composition for given genome by sampling every step bases. Parameter value is of the form genome,step. Ex: human,1000">
                    <expand macro="sanitizer_default"/>
                    <validator type="regex" message="Please enter as genome,step without leading or trailing spaces">^[^\s,](?:[^,]*[^\s,])?,[0-9]+$</validator>
                </param>
            </when>
            <when value="--bedSequences">
                <param name="bedSequences" type="text" value="" optional="true" label="Bed sequences" help="Print sequences of given genome in BED format">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--topSegments">
                <param name="topSegments" type="text" value="" optional="true" label="Top segments" help="Print coordinates of all top segments of given genome in BED format">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--bottomSegments">
                <param name="bottomSegments" type="text" value="" optional="true" label="Bottom segments" help="Print coordinates of all bottom segments of given genome in BED format">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--branchLength">
                <param name="branchLength" type="text" value="" optional="true" label="Branch length" help="Print branch length between given genome and its parent in the tree">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--branches">
                <param name="branches" type="boolean" truevalue="--branches" falsevalue="" checked="false" label="List of branches" help="Print list of branches. Each branch is specified by the child genome" />
            </when>
            <when value="--children">
                <param name="children" type="text" value="" optional="true" label="Names of children" help="Print names of children of given genome">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--chromSizes">
                <param name="chromSizes" type="text" value="" optional="true" label="Chrom sizes" help="Print the name and length of each sequence in a given genome. This is a subset of the information returned by --sequenceStats but is useful because it is in the format used by wigToBigWig">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--coverage">
                <param name="coverage" type="text" value="" optional="true" label="Histogram of coverage" help="Print histogram of coverage of a genome with all genomes">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--genomeMetaData">
                <param name="genomeMetaData" type="text" value="" optional="true" label="Metadata for given genome" help="Print metadata for given genome, one entry per line, tab-seperated">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--genomes">
                <param name="genomes" type="boolean" truevalue="--genomes" falsevalue="" checked="false" label="List of genomes" help="Print only a list of genomes in alignment" />
            </when>
            <when value="--metaData">
                <param name="metaData" type="boolean" truevalue="--metaData" falsevalue="" checked="false" label="Metadata for alignment" help="Print metadata for the entire alignment" />
            </when>
            <when value="--numSegments">
                <param name="numSegments" type="text" value="" optional="true" label="Number of segments" help="Print number of top and number of bottom segments for given genome">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--parent">
                <param name="parent" type="text" value="" optional="true" label="Parent name" help="Print name of parent of given genome">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--percentID">
                <param name="percentID" type="text" value="" optional="true" label="Percent ID" help="Print % ID of a genome with all other genomes. Only non-duplicated and unambiguous sites are considered">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--root">
                <param name="root" type="boolean" truevalue="--root" falsevalue="" checked="false" label="Root genome name" help="Print root genome name" />
            </when>
            <when value="--sequenceStats">
                <param name="sequenceStats" type="text" value="" optional="true" label="Stats for each sequence" help="Print stats for each sequence in given genome">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--sequences">
                <param name="sequences" type="text" value="" optional="true" label="List of sequence" help="Print list of sequences in given genome">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
            <when value="--span">
                <param name="span" type="text" value="" optional="true" label="Span" help="Print branches on path (or spanning tree) between comma separated list of genomes">
                    <expand macro="sanitizer_default"/>
                    <validator type="regex" message="Enter a genome or a comma separated list of genomes, without leading or trailing spaces">^\S(?:[^,]*\S)?(?:,\S(?:[^,]*\S)?)*$</validator>
                </param>
            </when>
            <when value="--spanRoot">
                <param name="spanRoot" type="text" value="" optional="true" label="Span root" help="Print genomes on path (or spanning tree) between comma separated list of genomes. Different from --span in that the spanning tree root is also given">
                    <expand macro="sanitizer_default"/>
                    <validator type="regex" message="Enter a genome or a comma separated list of genomes, without leading or trailing spaces">^\S(?:[^,]*\S)?(?:,\S(?:[^,]*\S)?)*$</validator>
                </param>
            </when>
            <when value="--tree">
                <param name="tree" type="boolean" truevalue="--tree" falsevalue="" checked="false" label="NEWICK tree" help="Print only the NEWICK tree" />
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="out_file" format="txt" label="${tool.name} on ${on_string}: Stats">
            <change_format>
                <when input="mode.option" value="--allCoverage" format="csv" />
                <when input="mode.option" value="--sequenceStats" format="csv" />
                <when input="mode.option" value="--percentID" format="csv" />
                <when input="mode.option" value="--coverage" format="csv" />
                <when input="mode.option" value="--chromSizes" format="tsv" />
                <when input="mode.option" value="--baseComp" format="tsv" />
                <when input="mode.option" value="--bedSequences" format="bed" />
                <when input="mode.option" value="--topSegments" format="bed" />
                <when input="mode.option" value="--bottomSegments" format="bed" />
            </change_format>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <output name="out_file" file="halStats_output.txt"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--allCoverage"/>
                <param name="allCoverage" value="true"/>
            </conditional>
            <output name="out_file" file="halStats_allCoverage_output.csv"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--bedSequences"/>
                <param name="bedSequences" value="Genome_0"/>
            </conditional>
            <output name="out_file" file="halStats_bedSequences_output.bed"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--topSegments"/>
                <param name="topSegments" value="Genome_1"/>
            </conditional>
            <output name="out_file" file="halStats_topSegments_output.bed"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--bottomSegments"/>
                <param name="bottomSegments" value="Genome_0"/>
            </conditional>
            <output name="out_file" file="halStats_bottomSegments_output.bed"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--tree"/>
                <param name="tree" value="true"/>
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text="(Genome_1:1,Genome_2:1,Genome_3:1)Genome_0;"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--spanRoot"/>
                <param name="spanRoot" value="Genome_0,Genome_1"/>
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text="Genome_0 Genome_1"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--sequences"/>
                <param name="sequences" value="Genome_0"/>
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text="Genome_0_seq"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--sequenceStats"/>
                <param name="sequenceStats" value="Genome_0"/>
            </conditional>
            <output name="out_file" file="halStats_sequenceStats_output.csv"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--root"/>
                <param name="root" value="true"/>
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text="Genome_0"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--parent"/>
                <param name="parent" value="Genome_1"/>
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text="Genome_0"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--percentID"/>
                <param name="percentID" value="Genome_0"/>
            </conditional>
            <output name="out_file" file="halStats_percentID_output.csv"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--numSegments"/>
                <param name="numSegments" value="Genome_1"/>
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text="28 0"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--genomes"/>
                <param name="genomes" value="true"/>
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text="Genome_0 Genome_1 Genome_2 Genome_3"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--children"/>
                <param name="children" value="Genome_0"/>
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text="Genome_1 Genome_2 Genome_3"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--chromSizes"/>
                <param name="chromSizes" value="Genome_1"/>
            </conditional>
            <output name="out_file" file="halStats_chromSizes_output.tsv"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--branches"/>
                <param name="branches" value="true"/>
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text="Genome_1 Genome_2 Genome_3"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--branchLength"/>
                <param name="branchLength" value="Genome_1"/>
            </conditional>
            <output name="out_file">
                <assert_contents>
                    <has_text text="1"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="option" value="--baseComp"/>
                <param name="baseComp" value="Genome_0,1000"/>
            </conditional>
            <output name="out_file" file="halStats_baseComp_output.tsv"/>
        </test>
    </tests>
    <help><![CDATA[
halStats lets you inspect the contents of a HAL database and pull out essential details about genomes, sequences, coverage, identity, and alignment structure. It provides quick checks on genome relationships, segment layout, metadata, and sequence level stats. 

This tool is useful for verifying alignment quality, exploring genome organization, and extracting BED formatted data from any genome in the HAL file.
    ]]></help>
    <expand macro="citation" />
    <expand macro="creator" />
</tool>