<tool id="hal_halsynteny" name="halSynteny" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>converts alignments into synteny blocks</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive"><![CDATA[
        halSynteny
            --minBlockSize $minBlockSize
            --maxAnchorDistance $maxAnchorDistance
            --queryGenome '$queryGenome'
            --targetGenome '$targetGenome'
            #if $queryChromosome:
                --queryChromosome '$queryChromosome'
            #end if
            #if $selection.input == 'hal':
                '$selection.input_hal'
            #else:
                --alignmentIsPsl
                '$selection.input_psl'
            #end if 
            '$output_file'
    ]]></command>
    <inputs>
        <conditional name="selection">
            <param name="input" type="select" label="Input alignment file format">
                <option value="hal" selected="true">Input HAL file</option>
                <option value="psl">Input PSL file</option>
            </param>
            <when value="hal">
                <expand macro="input_hal"/>
            </when>
            <when value="psl">
                <param name="input_psl" type="data" format="psl" label="PSL file"/>
            </when>
        </conditional> 
        <param argument="--queryGenome" type="text" value="" label="Query genome" help="Specify the genome to query from which the synteny is inferred">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_trim"/>
        </param>  
        <param argument="--targetGenome" type="text" value="" label="Target genome" help="Specify the target genome against which the query genome is compared. Must be different to 'Query genome'">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_trim"/>
        </param>  
        <param argument="--queryChromosome" type="text" optional="true" value="" label="Query chromosome" help="Limit synteny detection to a specific chromosome (or sequence) from the query genome (if empty, whole genome is used) ">
            <expand macro="sanitizer_default"/>
            <expand macro="validator_trim"/>
        </param>  
        <param argument="--maxAnchorDistance" type="integer" min="0" value="5000" label="Max anchor distance" help="Set the maximum allowed distance between adjacent alignment anchors to be considered part of the same synteny block"/>
        <param argument="--minBlockSize" type="integer" min="0" value="5000" label="Min block size" help="Set the minimum length of a synteny block to process. Blocks shorter than this threshold are ignored"/>
    </inputs>
    <outputs>
        <data name="output_file" format="psl" label="${tool.name} on ${on_string}: Synteny blocks"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <conditional name="selection">
                <param name="input" value="hal"/>
                <param name="input_hal" value="halTest.hal"/>
            </conditional>
            <param name="queryGenome" value="Genome_0"/>
            <param name="targetGenome" value="Genome_1"/>
            <param name="minBlockSize" value="100"/>
            <output name="output_file" ftype="psl">
                <assert_contents>
                    <has_line line="1465&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;++&#009;Genome_0_seq&#009;1758&#009;0&#009;1465&#009;Genome_1_seq&#009;5472&#009;0&#009;1465&#009;1&#009;1465,&#009;0,&#009;0,"/>   
                    <has_line line="879&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;++&#009;Genome_0_seq&#009;1758&#009;586&#009;1465&#009;Genome_1_seq&#009;5472&#009;3809&#009;4688&#009;1&#009;879,&#009;586,&#009;3809,"/>    
                    <has_line line="293&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;++&#009;Genome_0_seq&#009;1758&#009;879&#009;1172&#009;Genome_1_seq&#009;5472&#009;4981&#009;5274&#009;1&#009;293,&#009;879,&#009;4981,"/>
                    <has_n_lines n="6"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <conditional name="selection">
                <param name="input" value="hal"/>
                <param name="input_hal" value="halTest.hal"/>
            </conditional>
            <param name="queryGenome" value="Genome_0"/>
            <param name="targetGenome" value="Genome_1"/>
            <param name="minBlockSize" value="100"/>
            <param name="maxAnchorDistance" value="500"/>
            <output name="output_file" ftype="psl">
                <assert_contents>
                    <has_line line="1465&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;++&#009;Genome_0_seq&#009;1758&#009;0&#009;1465&#009;Genome_1_seq&#009;5472&#009;0&#009;1465&#009;1&#009;1465,&#009;0,&#009;0,"/>   
                    <has_line line="293&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;++&#009;Genome_0_seq&#009;1758&#009;1172&#009;1465&#009;Genome_1_seq&#009;5472&#009;4688&#009;4981&#009;1&#009;293,&#009;1172,&#009;4688,"/>    
                    <has_line line="293&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;0&#009;++&#009;Genome_0_seq&#009;1758&#009;0&#009;293&#009;Genome_1_seq&#009;5472&#009;1758&#009;2051&#009;1&#009;293,&#009;0,&#009;1758,"/>
                    <has_n_lines n="8"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <conditional name="selection">
                <param name="input" value="psl"/>
                <param name="input_psl" value="halSynteny.psl"/>
            </conditional>
            <param name="queryGenome" value="Genome_0"/>
            <param name="targetGenome" value="Genome_1"/>
            <param name="minBlockSize" value="500"/>
            <output name="output_file" ftype="psl">
                <assert_contents>
                    <has_line line="686&#009;0&#009;0&#009;0&#009;1&#009;414&#009;1&#009;4516&#009;++&#009;Genome_0_seq&#009;1758&#009;0&#009;1100&#009;Genome_1_seq&#009;5472&#009;0&#009;5202&#009;3&#009;243,343,100,&#009;0,243,1000,&#009;0,243,5102,"/>   
                    <has_line line="686&#009;0&#009;0&#009;0&#009;1&#009;414&#009;2&#009;1879&#009;++&#009;Genome_0_seq&#009;1758&#009;0&#009;1100&#009;Genome_1_seq&#009;5472&#009;1758&#009;4323&#009;4&#009;243,50,293,100,&#009;0,243,293,1000,&#009;1758,2001,2637,4223,"/>
                    <has_n_lines n="2"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
halSynteny converts genome alignments into synteny blocks, outputting them in PSL format. 
It accepts input in either HAL or PSL format and identifies conserved blocks between a source and reference genome. 

The tool is useful for studying genome structure, rearrangements, and conserved regions across species.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>