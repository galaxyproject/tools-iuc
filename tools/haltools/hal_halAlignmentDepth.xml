<tool id="hal_halAlignmentDepth" name="halAlignmentDepth" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>makes a alignment depth wiggle plot for a genome</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive"><![CDATA[
        halAlignmentDepth
            #if $inputFormat == "mmap":
                --format 'mmap'
            #end if
            #if $genome.reference == "custom":
                $genome.noAncestors
            #end if 
            #if $mode.export == "sequence":
                --refSequence '$sequence'
            #end if
            --start $start
            --length $length
            --step $step
            #if $filter.option == "--targetGenomes":
                --targetGenomes '$filter.targetGenomes'
            #else if $filter.option == "--rootGenome":
                --rootGenome '$filter.rootGenome'
            #end if 
            $countDupes
            '$input_hal' 
            #if $genome.reference == "custom":
                '$genome.refGenome'
            #else
                "\"\""  ## Defaults to input HAL file's tree root
            #end if 
            > '$out_file'
    ]]></command>
    <inputs>        
        <expand macro="input_hal"/>
        <expand macro="hal_backend_format"/>   
        <conditional name="genome">
            <param name="reference" type="select" label="Reference genome" help="Select the genome to use as reference">
                <option value="" selected="true">Use HAL tree root</option>
                <option value="custom">Specific reference genome</option>
            </param>
            <when value=""/>
            <when value="custom">
                <param name="refGenome" type="text" value="" label="Reference genome">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param> 
                <param argument="--noAncestors" type="boolean" truevalue="--noAncestors" falsevalue="" checked="false" label="Exclude ancestors" help="Should only be enabled when the chosen reference genome is a non-ancestral genome"/>
            </when>
        </conditional>
        <conditional name="mode">
            <param name="export" type="select" label="Convert options">
                <option value="default" selected="true">Convert full reference genome (default)</option>
                <option value="sequence">Convert a reference sequence (--sequence)</option>
            </param>
            <when value="default"/>
            <when value="sequence">
                <param name="sequence" type="text" value="" label="Reference sequence" help="Sequence name in reference genome to convert">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
        </conditional>
        <param argument="--start" type="integer" min="0" value="0" optional="true" label="Start coordinate" help="Coordinate within reference genome (or reference sequence) to start at"/>
        <param argument="--length" type="integer" min="0" value="0" optional="true" label="Length to convert" help="Length of the reference genome (or reference sequence) to convert. If set to 0, the entire thing is converted"/>
        <param argument="--step" type="integer" min="1" value="1" label="Step size" help="Measure depth every N bases instead of at every position. Use this to downsample the output for large genomes"/>
        <conditional name="filter">
            <param name="option" type="select" label="Genomes to include in the output">
                <option value="" selected="true">All genomes (default)</option>
                <option value="--targetGenomes">Specific target genomes (--targetGenomes)</option>
                <option value="--rootGenome">Only genomes in the subtree to a root (--rootGenome)</option>
            </param>
            <when value=""/>
            <when value="--targetGenomes">
                <param name="targetGenomes" type="text" value="" label="List of genomes" help="Enter a comma-separated (no spaces) list of genomes to include in the output (others are excluded)">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_comma_list"/>
                </param>
            </when>
            <when value="--rootGenome">
                <param name="rootGenome" type="text" value="" label="Root genome" help="Process only genomes belonging to the subtree rooted at the root genome">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
        </conditional>
        <param argument="--countDupes" type="boolean" truevalue="--countDupes" falsevalue="" checked="false" label="Count duplicates" help="Count every aligned position instead of counting unique genomes. This includes paralogous matches, so a genome can be counted multiple times. This will give the height of the MAF column created with hal2maf"/>
    </inputs>
    <outputs>
        <data name="out_file" format="wig" label="${tool.name} on ${on_string}"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <output name="out_file" md5="978205489932156dc5067d179e6dc168" ftype="wig"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="mode">
                <param name="export" value="sequence"/>
                <param name="sequence" value="Genome_0_seq"/>
            </conditional>
            <param name="start" value="10"/>
            <param name="length" value="50"/>
            <output name="out_file" md5="b38f702427172f473abf11ad0df9cd65" ftype="wig"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="countDupes" value="true"/>
            <output name="out_file" md5="5cc2a9e4320fc1089313861fa852c2a2" ftype="wig"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="filter">
                <param name="option" value="--targetGenomes"/>
                <param name="targetGenomes" value="Genome_1,Genome_2"/>
            </conditional>
            <output name="out_file" md5="87fe956338fb2f411e0e5aa68ca57ece" ftype="wig"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="genome">
                <param name="reference" value="custom"/>
                <param name="refGenome" value="Genome_1"/>
                <param name="noAncestors" value="true"/>
            </conditional>
            <output name="out_file" md5="bd034ac3ef9ebb9e71940818bc79892d" ftype="wig"/>
        </test>
    </tests>
    <help><![CDATA[
halAlignmentDepth computes alignment depth across a reference genome from a HAL alignment. 
The tool reports, for each base, how many genomes it aligns to. 
By default, each genome is counted once per position, including ancestral genomes. 
The result is written as a wiggle track.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>