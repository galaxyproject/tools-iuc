<tool id="hal_halReplaceGenome" name="halReplaceGenome" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>replaces a genome in a HAL file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive"><![CDATA[
        ## Copy input HAL to ensure that it is not modified.
        cp '$input_hal' writable_hal.hal && 
        halReplaceGenome
            #if $replaceTop.useTopAlignment:
                --topAlignmentFile '$replaceTop.topAlignmentFile'
            #else:
                --noTopAlignment
            #end if
            #if $replaceBottom.useBottomAlignment:
                --bottomAlignmentFile '$replaceBottom.bottomAlignmentFile'
            #else:
                --noBottomAlignment
            #end if
            $noMarkAncestors
            writable_hal.hal '$refGenome' &&
        ## echo 'ok' to check it with assert_stdout.
        echo 'ok'
    ]]></command>
    <inputs>
        <expand macro="input_hal"/>
        <expand macro="params_refGenome"/>
        <conditional name="replaceTop">
            <param name="useTopAlignment" type="boolean" checked="true" label="Replace top alignment" help="Required for a non-root reference genome. If set to false, all top segments are removed even for a non-root reference genome. This produces an invalid HAL file, at least temporarily"/>
            <when value="true">
                <param name="topAlignmentFile" type="data" format="hal" label="Top alignment file" help="HAL file containing an alignment of the reference genome, its parent, and its siblings (--topAlignmentFile)"/>
            </when>
            <when value="false"/>
        </conditional>
        <conditional name="replaceBottom">
            <param name="useBottomAlignment" type="boolean" checked="true" label="Replace bottom alignment" help="Required for a non-leaf reference genome. If set to false, all bottom segments are removed even for a non-leaf reference genome. This produces an invalid HAL file, at least temporarily"/>
            <when value="true">
                <param name="bottomAlignmentFile" type="data" format="hal" label="Bottom alignment file" help="HAL file containing an alignment of the reference genome and its children (--bottomAlignmentFile)"/>
            </when>
            <when value="false"/>
        </conditional>
        <expand macro="params_noMarkAncestors"/>
    </inputs>
    <outputs>
        <data name="out_file" format="hal" label="${tool.name} on ${on_string}" from_work_dir="writable_hal.hal"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="refGenome" value="Genome_2"/>
            <conditional name="replaceTop">
                <param name="useTopAlignment" value="true"/>
                <param name="topAlignmentFile" value="halReplaceGenome_top_input.hal"/>
            </conditional>
            <conditional name="replaceBottom">
                <param name="useBottomAlignment" value="false"/>
            </conditional>
            <assert_stdout>
                <has_line line="ok"/>
            </assert_stdout>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTestExtended.hal"/>
            <param name="refGenome" value="Insert"/>
            <conditional name="replaceTop">
                <param name="useTopAlignment" value="true"/>
                <param name="topAlignmentFile" value="halReplaceGenome2_top_input.hal"/>
            </conditional>
            <conditional name="replaceBottom">
                <param name="useBottomAlignment" value="true"/>
                <param name="bottomAlignmentFile" value="halReplaceGenome2_bot_input.hal"/>
            </conditional>
            <param name="noMarkAncestors" value="true"/>
            <assert_stdout>
                <has_line line="ok"/>
            </assert_stdout>
        </test>
    </tests>
    <help><![CDATA[
halReplaceGenome replaces an existing genome from an input HAL file while keeping the overall tree topology intact. 
Depending on whether the genome is a root, leaf, or internal node, separate top and bottom alignment files may be required to reconnect the genome correctly to its parent and children.
Options exist to remove top or bottom alignment segments explicitly.
By default, ancestor nodes are marked for update to ensure consistency of the alignment after replacement. 
This behavior can be disabled when ancestor updates are not required.

A new HAL file is created as output instead of modifying the input file.

-----

.. class:: warningmark

Running the tool on a HAL file in mmap format may fail or generate an invalid new HAL file, while the HDF5 format can run successfully. It is recommended to convert the input to HDF5 format first using halExtract.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>