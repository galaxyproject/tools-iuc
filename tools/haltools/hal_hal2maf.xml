<tool id="hal_hal2maf" name="hal2maf" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>converts HAL to MAF</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/> 
    <expand macro="stdio"/>
    <command detect_errors="aggressive"><![CDATA[
        #if $file.append:
            ## If an input MAF file is provided to append to, ensure that it is not modified.
            cp '$input_maf' writable_maf.maf
            && 
        #end if

        hal2maf
            #if $inputFormat == "mmap":
                --format 'mmap'
            #end if
            #if $file.append:
                --append
            #end if 
            #if $genome.reference == "custom":
                --refGenome '$genome.refGenome'
                $genome.noAncestors
            #end if 
            #if $filter.option == "--targetGenomes":
                --targetGenomes '$filter.targetGenomes'
            #else if $filter.option == "--rootGenome":
                --rootGenome '$filter.rootGenome'
            #end if 
            #if $convert.mode == "sequence":
                --refSequence '$convert.refSequence'
                --start $convert.start
                --length $convert.length
            #else if $convert.mode == "target":
                --refTargets '$convert.refTargets'
            #else if $convert.mode == "global":
                --global
            #end if 
            --maxRefGap $maxRefGap
            --maxBlockLen $maxBlockLen
            $noDupes
            $onlySequenceNames
            $unique
            $printTree
            $onlyOrthologs
            $keepEmptyRefBlocks
            '$input_hal' writable_maf.maf
    ]]></command>
    <inputs>
        <expand macro="input_hal"/>
        <expand macro="hal_backend_format"/>
        <conditional name="genome">
            <param name="reference" type="select" label="Reference genome" help="Select the genome to use as reference">
                <option value="" selected="true">Use HAL tree root (default)</option>
                <option value="custom">Specific reference genome (--refGenome)</option>
            </param>
            <when value=""/>
            <when value="custom">
                <param name="refGenome" type="text" value="" label="Reference genome">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param> 
                <param argument="--noAncestors" type="boolean" truevalue="--noAncestors" falsevalue="" checked="false" label="Exclude ancestors" help="Should only be enabled when the chosen reference genome is a non-ancestral genome"/>
            </when>
        </conditional>
        <conditional name="filter">
            <param name="option" type="select" label="Genomes to include in the output">
                <option value="" selected="true">All genomes (default)</option>
                <option value="--targetGenomes">Specific target genomes (--targetGenomes)</option>
                <option value="--rootGenome">Only genomes in the subtree to a root (--rootGenome)</option>
            </param>
            <when value=""/>
            <when value="--targetGenomes">
                <param name="targetGenomes" type="text" value="" label="List of genomes" help="Enter a comma-separated (no spaces) list of genomes to include in the output (others are excluded)">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_comma_list"/>
                </param>
            </when>
            <when value="--rootGenome">
                <param name="rootGenome" type="text" value="" label="Root genome" help="Include only genomes belonging to the subtree rooted at the root genome">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
            </when>
        </conditional>
        <conditional name="convert">
            <param name="mode" type="select" label="Convert options">
                <option value="" selected="true">All sequences (default)</option>
                <option value="sequence">A reference sequence (--refSequence)</option>
                <option value="target">Using reference intervals from a BED file (--refTargets)</option>
                <option value="global">All columns in alignment, ignoring reference-based filters (--global)</option>
            </param>
            <when value=""/>
            <when value="sequence">
                <param name="refSequence" type="text" value="" label="Reference sequence" help="Sequence name present in the reference genome">
                    <expand macro="sanitizer_default"/>
                    <expand macro="validator_trim"/>
                </param>
                <param argument="--start" type="integer" min="0" value="0" optional="true" label="Start coordinate" help="Coordinate within reference sequence to start at"/>
                <param argument="--length" type="integer" min="0" value="0" optional="true" label="Length to convert" help="Length of the reference sequence to convert. If set to 0, the entire sequence is converted"/>
            </when>
            <when value="target">
                <param name="refTargets" type="data" format="bed" label="BED file" help="BED file with reference genome intervals to convert. Only alignment columns overlapping these intervals are included"/>
            </when>
            <when value="global"/>
        </conditional>
        <conditional name="file">
            <param name="append" type="boolean" checked="false" label="Append to an existing MAF file" help="Add new alignment data to an existing MAF file instead of creating a new (--append)"/>
            <when value="true">
                <param name="input_maf" type="data" format="maf" label="MAF file"/>
            </when>
            <when value="false"/>
        </conditional>
        <param argument="--maxRefGap" type="integer" min="0" value="0" label="Maximum gap length" help="Maximum gap length in reference genome"/>
        <param argument="--maxBlockLen" type="integer" min="0" value="1000" label="Maximum block length" help="Maximum length of MAF block in output"/>
        <param argument="--noDupes" type="boolean" truevalue="--noDupes" falsevalue="" checked="false" label="Ignore paralogy edges" help="Ignore paralogy edges"/>
        <param argument="--onlySequenceNames" type="boolean" truevalue="--onlySequenceNames" falsevalue="" checked="false" label="Only sequence names" help="Use only sequence names for output names. By default, the UCSC convention of Genome.Sequence is used"/>
        <param argument="--unique" type="boolean" truevalue="--unique" falsevalue="" checked="false" label="Unique" help="Only write column whose left-most reference coordinate is in the specified range. This is used to ensure that the same column isn't sampled twice (due to duplications) by MAFs generated on distinct ranges"/>
        <param argument="--printTree" type="boolean" truevalue="--printTree" falsevalue="" checked="false" label="Print Tree" help="Print a gene tree for every block"/>
        <param argument="--onlyOrthologs" type="boolean" truevalue="--onlyOrthologs" falsevalue="" checked="false" label="Only Orthologs" help="Make only orthologs to the reference appear in the MAF blocks"/>
        <param argument="--keepEmptyRefBlocks" type="boolean" truevalue="--global" falsevalue="" checked="false" label="Keep empty reference blocks" help="Keep blocks that contain no reference sequence"/>
    </inputs>
    <outputs>
        <data name="output_file" format="maf" label="${tool.name} on ${on_string}: MAF file" from_work_dir="writable_maf.maf"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="filter">
                <param name="option" value="--rootGenome"/>
                <param name="rootGenome" value="Genome_1"/>
            </conditional>
            <param name="printTree" value="true"/>
            <param name="onlySequenceNames" value="true"/>
            <output name="output_file" md5="4f85f1b6fa5a701abc19385197dced22" ftype="maf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <param name="maxBlockLen" value="200"/>
            <param name="noDupes" value="true"/>
            <output name="output_file" md5="9142a30895f4fae4cbe7d28f2d45a18a" ftype="maf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="genome">
                <param name="reference" value="custom"/>
                <param name="refGenome" value="Genome_1"/>
                <param name="noAncestors" value="true"/>
            </conditional>
            <param name="onlyOrthologs" value="true"/>
            <output name="output_file" md5="247070af243bacef317ad33a56abbf69" ftype="maf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="genome">
                <param name="reference" value="custom"/>
                <param name="refGenome" value="Genome_1"/>
            </conditional>
            <param name="unique" value="true"/>
            <output name="output_file" md5="84a3fb5581626197ebf35dbdc5daca18" ftype="maf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="genome">
                <param name="reference" value="custom"/>
                <param name="refGenome" value="Genome_1"/>
            </conditional>
            <param name="maxRefGap" value="2000"/>
            <output name="output_file" md5="1e1ec73169f6c66498463d2a6f06f858" ftype="maf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="convert">
                <param name="mode" value="sequence"/>
                <param name="refSequence" value="Genome_0_seq"/>
                <param name="start" value="4"/>
                <param name="length" value="10"/>
            </conditional>
            <output name="output_file" md5="aa8c61b33273b3cb6b29d4cec032df04" ftype="maf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="file">
                <param name="append" value="true"/>
                <param name="input_maf" value="hal2maf_append.maf"/>
            </conditional>
            <conditional name="filter">
                <param name="option" value="--targetGenomes"/>
                <param name="targetGenomes" value="Genome_2,Genome_3"/>
            </conditional>
            <output name="output_file" md5="77a9ab0a90080648d0130708bdd82df7" ftype="maf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="convert">
                <param name="mode" value="global"/>
            </conditional>
            <output name="output_file" md5="9b8d0fca7235338e29ab31d959d4034c" ftype="maf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input_hal" value="halTest.hal"/>
            <conditional name="convert">
                <param name="mode" value="target"/>
                <param name="refTargets" value="hal2maf.bed"/>
            </conditional>
            <output name="output_file" md5="c679e17ae6d20a2c5e80418068cace3e" ftype="maf"/>
        </test>
    </tests>
    <help><![CDATA[
hal2maf converts an input HAL alignment into a MAF file as output. 
The tool supports converting the full alignment or restricting output to a selected reference genome, reference sequence, a set of target genomes, or only genomes belonging to the subtree rooted at a root genome.

Additional controls allow filtering for orthologs, excluding ancestral sequences, keeping empty reference blocks, limiting block size, and controlling reference gaps. 
MAF blocks can also include gene tree annotations if requested.

Use this tool when a MAF representation of a HAL alignment is required for downstream comparative genomics workflows.
    ]]></help>
    <expand macro="citation"/>
    <expand macro="creator"/>
</tool>