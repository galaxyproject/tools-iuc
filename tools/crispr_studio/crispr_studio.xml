<?xml version="1.0"?>
<tool id="crispr_studio" name="CRISPR Studio" version="1+galaxy0">
    <description>
        facilitate and accelerate CRISPR array visualization from a GFF3 file generated with CRISPRDetect
    </description>
    <requirements>
        <requirement type="package" version="1">crispr_studio</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
        ln -s '${input_data}' ./infile &&

        #if $rerun.r:
            ln -s '${rerun.prev_final}' in.fasta_fasta36.spacermatch.mcl.final &&
            ln -s '${rerun.prev_svg}' in.fasta_fasta36.spacermatch.mcl.svg &&
        #end if

        CRISPR_Studio

        #if $adv.isolate_list:
            -l '${adv.isolate_list}'
        #end if

        #if not $adv.isolate_list:
            #if $adv.s:
                -s '${adv.s}'
            #end if
        #end if

        $f
        $adv.n
        $gU
        $gS
        $rerun.r

        #if $cut_off:
            -c '${cut_off}'
        #end if

        -i ./infile
    ]]></command>
    <inputs>
        <param format="gff" label="Input sequences" name="input_data" type="data" help="gff (GFF3) files are valid"/>

        <section name="adv" title="Advanced output customizations" expanded="false">
            <param name="isolate_list" type="data" format="txt" optional="true" label="List of Isolates to show" help="Generate the figure with the subset of isolates listed in the file"/>
            <param argument="-s" type="data" format="txt" optional="true" label="The order of the isolates in the figure" help="The order of the isolates in the figure: Available option: CRISPRDetect, DistMatrix or File providing a list of the isolates in the desired order. CRISPRDetect = order in the gff file. DistMatrix = Order extracted from a distance matrix based on the similarity of the arrays in the isolates. File = Order privided in a single column file with the isolates names as the should appear in the figure. The option list of Isolates to show will override this option (Default: DistMatrix)"/>
            <param argument="-n" truevalue="-n" falsevalue="" type="boolean" label="Show the size of the spacers over the boxed diamonds?" help="We recommend to use this option only for experimental analysis of the data"/>
        </section>

        <param argument="-f" truevalue="-f" falsevalue="" type="boolean" label="Skip the verification of the fasta file generated from the GFF file?" help="The verification is mainly based on the length of the spacer sequences. If a spacer is 1.5 time shorter or longer than the average spacer size of the dataset, a warning is raised and the script stops (Verification is ran by default)."/>
        <param name="cut_off" type="integer" optional="true" label="Score cutoff for pairing of the spacers"/>
        <param argument="-gU" truevalue="-gU" falsevalue="" type="boolean" label="Gray out unique?" help="The unique spacers will be grayed"/>
        <param argument="-gS" truevalue="-gS" falsevalue="" type="boolean" label="Gray out similar?" help="The conserved spacers will be grayed"/>

        <conditional name="rerun">
            <param argument="-r" truevalue="-r" falsevalue="" type="boolean" label="Don't change spacer colour?" help="Use this option to keep the same color attributed to the spacer during a previous analysis"/>
            <when value="-r">
                <param format="tabular" label="Previous spacer.mcl.final" name="prev_final" type="data" help="Input a previous .final file you want to retain the colour from"/>
                <param format="svg" label="Previous SVG" name="prev_svg" type="data" help="Input a previous .svg file you want to retain the colour from"/>
            </when>
            <when value="">
            </when>
        </conditional>
        <param name="all_outputs" type="boolean" optional="true" label="Output everything?" help="Hidden outputs are: .fasta_fasta36, .fasta_fasta36.spacermatch, .fasta_fasta36.spacermatch.mcl, .fasta_fasta36.spacermatch.mcl.col"/>
    </inputs>
    <outputs>
        <data name="out1" format="tabular" label="${tool.name} on ${on_string}: fasta output" from_work_dir="in.fasta"/>
        <data name="out2" format="tabular" label="${tool.name} on ${on_string}: fasta_fast36 output" from_work_dir="in.fasta_fasta36">
            <filter>(all_outputs)</filter>
        </data>
        <data name="out3" format="tabular" label="${tool.name} on ${on_string}: spacermatch output" from_work_dir="in.fasta_fasta36.spacermatch">
            <filter>(all_outputs)</filter>
        </data>
        <data name="out4" format="tabular" label="${tool.name} on ${on_string}: spacermatch.mcl output" from_work_dir="in.fasta_fasta36.spacermatch.mcl">
            <filter>(all_outputs)</filter>
        </data>
        <data name="out5" format="tabular" label="${tool.name} on ${on_string}: spacermatch.mcl.col output" from_work_dir="in.fasta_fasta36.spacermatch.mcl.col">
            <filter>(all_outputs)</filter>
        </data>
        <data name="out6" format="tabular" label="${tool.name} on ${on_string}: spacematch.mcl.final output" from_work_dir="in.fasta_fasta36.spacermatch.mcl.final"/>
        <data name="out7" format="svg" label="${tool.name} on ${on_string}: SVG output" from_work_dir="in.fasta_fasta36.spacermatch.mcl.svg"/>
    </outputs>
    <tests>    
        <test>
            <param name="input_data" value="crispr_test.gff" ftype="gff"/>
            <param name="all_outputs" value="true"/>
            <output name="out1" file="crispr_test.gff.fasta"/>
            <output name="out2">
                <assert_contents>
                    <has_text text="NC_010473"/>
                </assert_contents>
            </output>
            <output name="out3" file="crispr_test.gff.fasta_fasta36.spacermatch"/>
            <output name="out4" file="crispr_test.gff.fasta_fasta36.spacermatch.mcl"/>
            <output name="out5">
                <assert_contents>
                    <has_text text="NC_010473"/>
                </assert_contents>
            </output>
            <output name="out6">
                <assert_contents>
                    <has_text text="NC_010473"/>
                </assert_contents>
            </output>
            <output name="out7">
                <assert_contents>
                    <has_text text="svg"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="input_data" value="crispr_test_adv.gff" ftype="gff"/>
            <param name="isolate_list" value="test_isolates.txt" ftype="txt"/>
            <param name="n" value="true"/>    
            <output name="out1" file="crispr_test_adv.gff.fasta"/>
            <output name="out6">
                <assert_contents>
                    <has_text text="NC_010473"/>
                </assert_contents>
            </output>
            <output name="out7">
                <assert_contents>
                    <has_text text="svg"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
        <![CDATA[
**What it does**
CRISPRStudio is a program developed to facilitate and accelerate CRISPR array visualization. It works by first comparing spacers sequence homology in a dataset, then assigning a two-color-code to each cluster of spacers and finally writing an svg file, which can be opened in graphics vector editor.
        ]]>
    </help>
    <citations>
        <citation type="bibtex">
@UNPUBLISHED{moineaulab2018,
author = {moineaulab},
title = {CRISPRStudio: Program developed to facilitate and accelerate CRISPR array visualization},
year = {2018},
url = {https://github.com/moineaulab/CRISPRStudio},
}
        </citation>
    </citations>
</tool>
