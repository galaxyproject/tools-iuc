<?xml version="1.0"?>
<tool id="crispr_studio" name="CRISPR Studio" version="1+galaxy0">
    <description>
        facilitate and accelerate CRISPR array visualization
    </description>
    <requirements>
        <requirement type="package" version="1">crispr_studio</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
        ln -s '${input_data}' in && 
        CRISPR_Studio

        #if $adv.isolate_list:
            -l '${adv.isolate_list}'
        #end if

        #if not $adv.isolate_list:
            #if $adv.sort:
                -s '${adv.sort}'
            #end if
        #end if

        #if $adv.spacer_size:
            -n
        #end if

        #if $gray_unique:
            -gU
        #end if
        
        #if $gray_similar:
            -gS
        #end if

        #if $rerun:
            -r
        #end if

        #if $cut_off:
            -c '${cut_off}'
        #end if
	
	-i in
    ]]></command>
    <inputs>
        <param format="gff" label="Input sequences" name="input_data" type="data" help="gff (GFF3) files are valid"/>

        <section name="adv" title="Advanced output customizations" expanded="false">
            <param format="txt" label="List of Isolates to show" name="isolate_list" type="data" optional="true" help="Generate the figure with the subset of isolates listed in the file"/>

            <param format="txt" label="The order of the isolates in the figure" name="sort" type="data" optional="true" help="The order of the isolates in the figure: Available option: CRISPRDetect, DistMatrix or File providing a list of the isolates in the desired order. CRISPRDetect = order in the gff file. DistMatrix = Order extracted from a distance matrix based on the similarity of the arrays in the isolates. File = Order privided in a single column file with the isolates names as the should appear in the figure. The option list of Isolates to show will override this option (Default: DistMatrix)"/>

            <param name="spacer_size" type="boolean" label="Show the size of the spacers over the boxed diamonds?" help="We recommend to use this option only for experimental analysis of the data"/>
        </section>
        <param name="check_fasta" type="boolean" label="Skip the verification of the fasta file generated from the GFF file?" help="The verification is mainly based on the length of the spacer sequences. If a spacer is 1.5 time shorter or longer than the average spacer size of the dataset, a warning is raised and the script stops (Verification is ran by default)."/>

        <param name="cut_off" type="integer" optional="true" label="Score cutoff for pairing of the spacers"/>

        <param name="gray_unique" type="boolean" label="Gray out unique?" help="The unique spacers will be grayed"/>

        <param name="gray_similar" type="boolean" label="Gray out similar?" help="The conserved spacers will be grayed"/>

        <param name="rerun" type="boolean" label="Don't change spacer colour?" help="Use this option to keep the same color attributed to the spacer during a previous analysis"/>

    </inputs>
    <outputs>
        <data name="out1" format="tabular" label="${tool.name} on ${on_string}: fasta output" from_work_dir="in.fasta"/>
        <data name="out2" format="tabular" label="${tool.name} on ${on_string}: fasta_fast36 output" from_work_dir="in.fasta_fasta36"/>
        <data name="out3" format="tabular" label="${tool.name} on ${on_string}: spacermatch output" from_work_dir="in.fasta_fasta36.spacermatch"/>
        <data name="out4" format="tabular" label="${tool.name} on ${on_string}: spacermatch.mcl output" from_work_dir="in.fasta_fasta36.spacermatch.mcl"/>    
        <data name="out5" format="tabular" label="${tool.name} on ${on_string}: spacermatch.mcl.col output" from_work_dir="in.fasta_fasta36.spacermatch.mcl.col"/>
        <data name="out6" format="tabular" label="${tool.name} on ${on_string}: spacematch.mcl.final output" from_work_dir="in.fasta_fasta36.spacermatch.mcl.final"/>
        <data name="out7" format="svg" label="${tool.name} on ${on_string}: SVG output" from_work_dir="in.fasta_fasta36.spacermatch.mcl.svg"/>
    </outputs>
    <tests>    
        <test>
            <param name="input_data" value="crispr_test.gff" ftype="gff"/>
            <output name="out1" file="crispr_test.gff.fasta"/>
            <output name="out2">
                <assert_contents>
                    <has_text text="NC_010473||CRISPR1_SPACER5_2994850_2994882:32"/>
                </assert_contents>
            </output>
            <output name="out3" file="crispr_test.gff.fasta_fasta36.spacermatch"/>
            <output name="out4" file="crispr_test.gff.fasta_fasta36.spacermatch.mcl"/>
            <output name="out5" file="crispr_test.gff.fasta_fasta36.spacermatch.mcl.col"/>
            <output name="out6" file="crispr_test.gff.fasta_fasta36.spacermatch.mcl.final"/>	
            <output name="out7">
                <assert_contents>
                    <has_text text="svg"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
        <![CDATA[
**What it does**
CRISPRStudio is a program developed to facilitate and accelerate CRISPR array visualization. It works by first comparing spacers sequence homology in a dataset, then assigning a two-color-code to each cluster of spacers and finally writing an svg file, which can be opened in graphics vector editor.
        ]]>
    </help>
    <citations>
        <citation type="bibtex">
@UNPUBLISHED{moineaulab2018,
author = {moineaulab},
title = {CRISPRStudio: Program developed to facilitate and accelerate CRISPR array visualization},
year = {2018},
url = {https://github.com/moineaulab/CRISPRStudio},
}
        </citation>
    </citations>
</tool>
