<tool id="drawrnajs" name="DrawRNAjs" version="1.2.6-0">
    <description>Draw RNA 2D Structures</description>

    <command><![CDATA[
        cp '$html_template' '$output' ;
        sed -i.bak 's@__UID_PLACEHOLDER__@${__app__.security.encode_id($input.id)}@g' '$output' ;
        
        mkdir -p '${output.files_path}' ;
            
        ln -s '$__tool_directory__/static/bootstrap.css' '${output.files_path}/' ;
        ln -s '$__tool_directory__/static/spectrum.css' '${output.files_path}/' ;
        ln -s '$__tool_directory__/static/style.css' '${output.files_path}/' ;
        ln -s '$__tool_directory__/static/drawrnajs@1.2.6' '${output.files_path}/drawrnajs.js' ;
        ln -s '$__tool_directory__/static/galaxy_handshake_utils.js' '${output.files_path}/galaxy_handshake_utils.js' ;
    ]]></command>
    <configfiles>
        <configfile name="html_template"><![CDATA[
        <meta charset="UTF-8">
        <head>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

            <link type="text/css" rel="stylesheet" href="bootstrap.css">
            <link type="text/css" rel="stylesheet" href="spectrum.css">
            <link type="text/css" rel="stylesheet" href="style.css">
            
            <script src="drawrnajs.js"></script>
            <script src="galaxy_handshake_utils.js"></script>
        </head>
        <body>
            The server was not configured to disable HTML santization for this particular tool. Please ask the Galaxy administrator to do so.
            
            <div class="input"/>
            <div id='snippetDiv'/>

            <script>
                yourDiv = document.getElementById('snippetDiv');
                var Rna = require("drawrnajs");
                var url = '/api/histories/__UID_PLACEHOLDER__/contents/__UID_PLACEHOLDER__/display';
                
                \$( document ).ready(function() {
                        
                        // Remove error message that sanitization was not disabled
                        var textNode = \$("body").contents().first();
                        textNode.replaceWith("");
                        
                        \$.ajax(url,
                        {
                            success: function(dotbracket_file)
                            {
                                idx = get_dotbracket_index(dotbracket_file);
                                draw_sequence_selector(idx);
                                
                                app = new Rna({
                                    el: yourDiv,
                                    seq: idx[Object.keys(idx)[0]]['sequence'],
                                    dotbr: idx[Object.keys(idx)[0]]['structure'],
                                    layout: "naview",
                                    seqpanel: true,
                                    optspanel: true,
                                    resindex: true
                                });
                                app.render();
                            }
                        });
                });
            </script>
        </body>
    ]]></configfile>
    </configfiles>

    <inputs>
        <param name="input"
               type="data"
               format="dbn"
               label="Select RNA 2D structure" />
    </inputs>

    <outputs>
        <data format="html" name="output" label="DrawRNAjs on $on_string"/>
    </outputs>
    
    <tests>
        <test>
            <param name="input" value="u85.dbn" />
            
            <output name="output" value="u85.dbn.html" lines_diff="2" />
        </test>
        <test>
            <param name="input" value="gggaaaccc.dbn" />
            
            <output name="output" value="gggaaaccc.dbn.html" lines_diff="2" />
        </test>
    </tests>
    
    <help>
        Visualized DotBracket files (DBN) interactively using DrawRNAjs
    </help>
    <citations>
        <citation type="bibtex">
            @unpublished{DrawRNAjs,
            author = {Rauscher, Benedikt},
            title = {DrawRNAjs},
            year = {2015},
            eprint = {},
            url = {https://www.npmjs.com/package/drawrnajs}
        }</citation>
    </citations>
</tool>