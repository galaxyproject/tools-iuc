<tool id="isoformswitchanalyzer" name="IsoformSwitchAnalyzeR" version="@TOOL_VERSION@+galaxy@SUFFIX_VERSION@">
    <description>statistical identification of isoform switching</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro='xrefs'/>
    <expand macro='requirements'/>
    <stdio>
        <regex match="Execution halted"
           source="both"
           level="fatal"
           description="Execution halted." />
        <regex match="Error in"
           source="both"
           level="fatal"
           description="An undefined error occurred, please check your input carefully and contact your administrator." />
        <regex match="Fatal error"
           source="both"
           level="fatal"
           description="An undefined error occurred, please check your input carefully and contact your administrator." />
    </stdio>
    <command><![CDATA[
            mk -p 'input_files' &&
            #if $function_mode.tool_selector == 'stringtie'
                #set $filename = 't_data.ctab'
            #else
                #set $filename = 't_data.ctab' ################ NEEDS TO BE RENAMED
            #end if
            #for $index,$factor in enumerate($select_data.factorLevel):
                #set $outdir = './input_files/${factor}${index}/'
                mkdir $outdir &&
                ln -s $select_data.trans_counts[$index] '${outdir}${filename}' &&
            #end for
            Rscript '${__tool_directory__}/IsoformSwitchAnalyzerR.R'

    ]]></command>
    <inputs>
        <conditional name="function_mode">
            <param name="selector" type="select" label="Tool function mode" 
                help="The first step of a IsoformSwitchAnalyzeR workflow is to import and integrate the isoform quantification 
                    with its basic annotation. Once you have all the relevant data imported into R (IsoformSwitchAnalyzeR will 
                    also help you with that), the workflow for identification and analysis of isoform switches with functional 
                    consequences can be divided into two parts.">
                <option value="data_import">Analysis part 1: Import data</option>
                <option value="first_step">Analysis part 2: Extract isoform switches and their sequences</option>
                <option value="second_step">Analysis part 3: Plot all isoform switches and their annotation</option>
            </param>
            <when value="data_import">
                <param name="tool_selector" type="select" label="Quantification data source" help="IsoformSwitchAnalyzeR has different functions for importing data">
                    <option value="stringtie">StringTie</option>
                    <option value="salmon">Salmon/Kallisto</option>
                </param>
                <repeat name="rep_factorLevel" title="Factor level" min="2" default="2">
                    <param name="factorLevel" type="text" value="FactorLevel" label="Specify a factor level, typical values could be 'tumor' or 'treated'"
                        help="Only letters, numbers and underscores will be retained in this field">
                        <sanitizer>
                            <valid initial="string.letters,string.digits"><add value="_" /></valid>
                        </sanitizer>
                    </param>
                    <param name="trans_counts" type="data" format="tabular" multiple="true" 
                        label="Transcript-level expression measurements" help="It is generate by Stringtie with the -B option." /> 
                </repeat>
                <param name="genome_annotation" type="data" format="gtf,gtf.gz" label="Genome annotation (GTF)" 
                    help="It is used to integrate the coding sequence (CDS) regions from in the GTF file as the ORF regions used by IsoformSwitchAnalyzeR." />
                <param name="transcriptome" type="data" format="fasta,fasta.gz" label="Transcriptome" 
                    help="Please note this different from a fasta file with the sequences of the entire genome." />
                <param name="fixed_quantification" type="boolean" truevalue="true" falsevalue="false" checked="true" 
                    label="Fix StringTie annotation problem" help="This option will automatically try and correct some of the annoation problems created when 
                        doing transcript assembly (unassigned transcripts and merged genes)." />
            </when>
            <when value="first_step">
                <param name="robject" type="data" format="" label="IsoformSwitchAnalyzeR R object" help="It is generated when running the analysis part 1." />
                <section name="prefilter" title="Pre-filter parameters" help="SwitchAnalyzeR will remove genes/isoforms with the aim of allowing faster
                    processing time as well as more trustworthy results.">
                    <param argument="geneExpressionCutoff" type="float" min="0" value="1" label="Gene expression cutoff" help="The expression cutoff (most 
                        likely in TPM/RPKM/FPKM) which the average expression in BOTH condisions must be higher than." />
                    <param argument="isoformExpressionCutoff" type="float" min="0" value="0" label="Isoform expresion cutoff" help="The expression cutoff (most 
                        likely in RPKM/FPKM) which isoforms must be expressed more than, in at least one conditions of a comparison. Default is 0 (which removes 
                        completely unused isoforms)." /> 
                    <param argument="IFcutoff" type="float" min="0" value="0.01" max="1" label="IFcutoff" help="The cutoff on isoform usage (measured as Isoform
                        Fraction, see details) which isoforms must be used more than in at least one conditions of a comparison." />
                    <param argument="acceptedGeneBiotype" type="text" value="" optional="true" label="Accepted gene biotypes" help="TODO">
                        <sanitizer invalid_char="">
                            <valid initial="string.letters,string.digits">
                                <add value="_" />
                            </valid>
                        </sanitizer>
                        <validator type="regex">[0-9a-zA-Z_]+</validator>
                    </param>
                    <param argument="acceptedIsoforClassCode" type="text" value="" label="Accepted isoform class code" help="TODO">
                        <sanitizer invalid_char="">
                            <valid initial="string.letters,string.digits">
                                <add value="_" />
                            </valid>
                        </sanitizer>
                        <validator type="regex">[0-9a-zA-Z_]+</validator>
                    </param>
                    <param argument="removeSingleIsformGenes" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Remove single isoform genes" 
                        help="TODO" />
                    <param argument="reduceToSwitchingGenes" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Reduce to switching genes"
                        help="TODO" />
                    <param argument="reduceFurtherToGenesWithConsequencePotential" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Reduce 
                        to genes with consequence potential" help="TODO" />
                    <param argument="keepIsoformInAllConditions" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Keep isoforms in all conditions" help="TODO" />
                    <expand macro="macro_alpha_difcutoff"/>
                    <expand macro="macro_onlysigisoforms"/>
                </section>
                <section name="dexseq" title="DEXseq parameters" help="DEXSeq is used to test isoforms (isoform resolution) for differential isoform usage." expanded="true">
                    <expand macro="macro_alpha_difcutoff"/>
<param argument="correctForConfoundingFactors" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Correct for confounding factors" 
                        help="A logic indicating whether IsoformSwitchAnalyzeR to use limma to correct for any confounding effects (e.g. batch effects) as indicated in the
                         design matrix (as additional columns (apart from the two default columns)) " />
                    <param argument="overwriteIFvalues" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Overwrite IF values" help="It indicates 
                        whether to overwrite the IF and dIF stored in the switchAnalyzeRlist with the corrected IF and dIF values - if no confounding effects are
                        present in the design matrix this will not change anything" />
                    <param argument="reduceToSwitchingGenes" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Reduce to switch genes" help="TODO" />
                    <param argument="reduceToSwitchingGenes" type="boolean" truevalue="true" falsevalue="" checked="false" label="Reduce to genes with consequence potential" 
                        help="TODO" />
                    <expand macro="macro_onlysigisoforms"/>
                    <param argument="keepIsoformInAllConditions" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Keep isoforms in all conditions" 
                        help="TODO" />
                </section>    
                <section name="novel_isoform" title="Novel isoform analysis parameters" help="For the subset of isoforms not already annotated with ORFs this 
                    function predicts the most likely Open Reading Frame (ORF) and the NMD sensitivity. This function is made to help annotate
                    isoforms if you have performed (guided) de-novo isoform reconstruction (isoform deconvolution).">
                    <param argument="minORFlength" type="integer" min="0" value="100" label="Minimum ORF length" help="The minimum size (in nucleotides) an 
                        ORF must be to be considered (and reported). Please note that we recommend using CPAT to predict coding potential
                        instead of this cutoff. Default is 100 nucleotides, which around 97.5% of Gencode coding isoforms in both human and mouse have." />
                    <param argument="minORFlength" type="integer" min="0" value="100" label="Minimum ORF length" help="TODO" />
                    <param argument="orfMethod" type="select" label="ORF identification method" help="TODO">
                        <option value="longest.AnnotatedWhenPossible">Longest and annotated when possible</option>
                        <option value="longest">Longest</option>
                        <option value="mostUpstream">Most upstream</option>
                        <option value="longestAnnotated">Longest annotated</option>
                        <option value="mostUpstreamAnnoated">Most upstream annotated</option>
                    </param>
                    <param argument="PTCDistance" type="integer" min="0" value="50" label="Maximal allowed premature termination codon-distance" help="The minimum 
                        distance (number of nucleotides) from the STOP codon to the final exon-exon junction. If the distance from the STOP to the final exon-exon
                        junction is larger than this the isoform to be marked as NMD-sensitive. " />
                </section>         
                <section name="extract_sequence" title="Sequence extraction parameters" help="switchAnalyzeR will extracts the nucleotide (NT) sequence of transcripts by 
                    extracting and concatenating the sequences of a reference genome corresponding to the genomic coordinates of the isoforms. ">
                    <expand macro="macro_alpha_difcutoff"/>
                    <param argument="dIFcutoff" type="float" min="0" max="1" value="0.1" label="dIFcutoff" help="The cutoff which the changes in (absolute) isoform usage
                        must be larger than before an isoform is considered switching. This cutoff can remove cases where isoforms with (very) low dIF values are deemed 
                        significant and thereby included in the downstream analysis. This cutoff is analogous to having a cutoff on log2 fold change in a normal 
                        differential expression analysis of genes to ensure the genes have a certain effect size. Default is 0.1 (10%)." />
                    <param argument="removeShortAAseq" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Remove short aminoacid sequences" help="This 
                        option exist to allows for easier usage of the Pfam and SignalP web servers which both currently have restrictions on allowed sequence lengths. If 
                        enabled AA sequences are filtered to be > 5 AA. This will only affect the sequences written to the FASTA file not the sequences added to the switchAnalyzeRlist" />
                    <param argument="removeLongAAseq" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Remove long aminoacid sequences" help="A 
                        logical indicating whether to removesequences based on their length. This option exist to allows for easier usage of the Pfam and SignalP web servers
                        which both currently have restrictions on allowed sequence lengths. If enabled AA sequences are filtered to be smaller 1000 AA. This will only affect the 
                        sequences written to the fasta file (if writeToFile=TRUE) not the sequences added to the switchAnalyzeRlist. " />
                    <param argument="alsoSplitFastaFile" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Split FASTA File" help="A subset of the 
                        web based analysis tools currently supported by IsoformSwitchAnalyzeR have restrictions on the number of sequences in each submission (currently 
                        PFAM and to a less extend SignalP). To enable easy use of those web tool this parameter was implemented. By setting this parameter to TRUE a number 
                        of amino acid FASTA files will ALSO be generated each only containing the number of sequences allow (currently max 500 for some tools) thereby enabling
                        easy analysis of the data in multiple web-based submissions" />
                    <param argument="removeORFwithStop" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Remove ORFs containint STOP codons" help="ORFs 
                        containing stop codons, defined as * when the ORF nucleotide sequences is translated to the amino acid sequence, should be A) removed from the ORF 
                        annotation in the switchAnalyzeRlist and B) removed from the sequences added to the switchAnalyzeRlist and/or written to FASTA files. This is only 
                        necessary if you are analyzing quantified known annotated data where you supplied a GTF file to the import function" />
                </section>            
                <section name="summary" title="Summary generation parameters">
                    <param argument="filterForConsequences" type="boolean" truevalue="true" falsevalue="false" checked="false" 
                        label="Filter for consquences" help="Filter for genes with functional consequences. Requires that 
                            analyzeSwitchConsequences() have been run on the switchAnalyzeRlist. The output will then be the number of significant genes 
                            and isoforms originating from genes with predicted consequences" />
                    <expand macro="macro_alpha_difcutoff"/>
                    <expand macro="macro_onlysigisoforms"/>
                </section>
            </when>
            <when value="second_step">
                <param name="robject" type="data" format="" label="IsoformSwitchAnalyzeR R object" help="It is generated when running the analysis part 1." />
                <conditional name="plot_mode">
                    <param name="selector" type="select" label="Analysis mode" help="This selector allows so specify if you want to analyze a specific gene or 
                        the (top) switching genes/isoforms ">
                        <option value="single">Analyze specific gene</option>
                        <option value="top" selected="true">Analyze top isoform switches</option>
                    </param>
                    <when value="top">
                        <param argument="n" type="integer" min="0" value="10" label="Number of switching features (genes/isoforms) to analyze" help="Use 0 to return
                            all significant results" />
                        <section name="top_advanced" title="Analysis mode advanced options">
                            <expand macro="macro_alpha_difcutoff"/>
                            <expand macro="macro_onlysigisoforms"/>
                            <param argument="sortByQvals" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Sorting mode" help="A logic indicating 
                                whether to the top n features are sorted by decreasing significance (increasing q-values) (if TRUE) or decreasing switch size 
                                (absolute dIF, which are still significant as defined by alpha) (if FALSE). The dIF values for genes are considered as the total 
                                change within the gene calculated as sum(abs(dIF)) for each gene" />
                        </section>
                    </when>
                    <when value="single">
                        <param argument="gene" type="text" value="" label="Gene name" help="Either the gene_id or the gene name of the gene to plot">
                            <sanitizer invalid_char="">
                                <valid initial="string.letters,string.digits">
                                    <add value="_" />
                                    <add value="-" />
                                </valid>
                            </sanitizer>
                            <validator type="regex">[0-9a-zA-Z_-]+</validator>
                        </param>
                        <section name="gene_advanced" title="Analysis mode advanced options">
                            <param argument="IFcutoff" type="float" min="0" max="1" value="0.05" label="IFcutoff" help="The cutoff used for the minimum 
                                contribution to gene expression (in at least one condition) for an isoforms must have to be plotted (measured as Isoform
                                Fraction (IF) values)." />
                            <param argument="dIFcutoff" type="float" min="0" max="1" value="0.1" label="dIFcutoff" help="The dIF cutoff used to add usage 
                                to the transcript plot" />
                            <param argument="rescaleTranscripts" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Rescale transcripts" 
                                help="All the isoforms should be resealed to the square root of their original sizes. This feature is implemented because 
                                    introns usually are much larger than exons making it difficult to see structural changes. This is very useful for structural 
                                    visualization but the scaling might distort actual intron and exon sizes" />
                            <param argument="reverseMinus" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Isoforms on minus strand 
                                should be inverted" help="Isoforms on minus strand should be inverted so they are visualized as going from left to right 
                                instead of right to left" />
                            <param argument="addErrorbars" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Add error bars" help="Error 
                                bars should be added to the expression plots to show uncertainty in estimates" />
                        </section>
                    </when>
                </conditional>
                <conditional name="coding_potential">
                    <param name="selector" type="select" label="Include prediction of coding potential information" 
                        help="Integrate in the analysis de output from CPAT or CPC2.">
                        <option value="disabled">Disabled</option>
                        <option value="cpat">CPAT</option>
                        <option value="cpc2">CPC2</option>
                    </param>
                    <when value="disabled"/>
                    <when value="cpat">
                        <param argument="analyzeCPAT" type="data" format="txt" label="CPAT result file" 
                            help=" Use default parameters and the nucleotide fasta file (_nt.fasta). If the webserver was used, download the tab-delimited 
                                result file (available at the bottom of the result page). If a stand-alone version was used, just supply the path to the result file" />
                        <param argument="codingCutoff" type="float" min="0" max="1" value="0.725" label="Coding cutoff" help="cutoff used by CPAT for distinguishing between 
                            coding and non-coding transcripts. The cutoff is dependent on species analyzed. IsoformSwitchAnalyzerR developers suggest that the optimal cutoff 
                            for overlapping coding and noncoding isoforms are 0.725 for human and 0.721 for mouse. However the suggested cutoffs from the CPAT develpers 
                            derived by comparing known genes to random non-coding regions of the genome is 0.364 for human and 0.44 for mouse" />
                    </when>
                    <when value="cpc2">
                        <param argument="analyzeCPC2" type="data" format="txt" label="CPC2 result file" 
                            help="Use default parameters and if required select the most similar species. If the webserver (batch submission) was used, 
                                download the tab-delimited result file (via the “Download the result” button). If a stand-alone version was just just supply the path to the result file" />
                        <param argument="removeNoncodingORFs" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Remove non-coding ORFs" help="Remove ORF information 
                            from the isoforms which the CPC2 analysis classifies as non-coding. This can be particular useful if the isoform (and ORF) was predicted de-novo but is not 
                            recommended if ORFs was imported from a GTF file" />
                        <param argument="codingCutoff" type="float" min="0" max="1" value="0.5" label="Coding cutoff" help="Numeric indicating the cutoff used by CPC2 for distinguishing 
                            between coding and non-coding transcripts. The cutoff appears to be species independent." />
                    </when>
                </conditional>
                <param argument="analyzePFAM" type="data" format="txt" multiple="true" optional="true" label="Include Pfam results (sequence analysis of protein domains)" help="Use default 
                    parameters and the amino acid fasta file (_AA.fasta). If the webserver is used you need to copy/paste the result part of the mail you receive into an empty plain text 
                    document (notepad, sublimetext, TextEdit or similar (not Word)) and save that to a plain text (txt) file. The path to that file should be supplied. If a stand-alone 
                    version was used, just supply the path to the result file" />
                <conditional name="signal_peptides">
                    <param name="selector" type="select" label="Include SignalP results" help="Integration of the result of SignalP (external sequence analysis of signal peptides)">
                        <option value="disabled">Disabled</option>
                        <option value="enabled">Enabled</option>
                    </param>
                    <when value="disabled"/>
                    <when value="enabled">
                        <param argument="analyzeSignalP" type="data" format="txt" multiple="true" optional="true" label="SignalP" help="Use the amino acid fasta file (_AA.fasta). If using the webserver SignalP 
                            should be run with the parameter 'Short output (no figures)' under 'Output format' and one should select the appropriate 'Organism group'. When 
                            using a stand-alone version SignalP should be run with the '-f summary' option. If using the webserver the results can be downloaded using the 
                            'Downloads' button in the top-right corner where the user should select 'Prediction summary' and supply the path to the resulting file to the 
                            'pathToSignalPresultFile' argument. If a stand-alone version was just supply the path to the summary result file." />
                        <param argument="minSignalPeptideProbability" type="float" min="0" max="1" value="0.5" label="Minimum probability for calling a signal peptide"/>
                    </when>
                </conditional>

                <conditional name="disordered_regions">
                    <param name="selector" type="select" label="Include prediction of intrinsically disordered Regions (IDR) information" 
                        help="Integrate in the analysis de output from CPAT or CPC2.">
                        <option value="disabled">Disabled</option>
                        <option value="iupred2a">IUPred2A</option>
                        <option value="netsurfp">NetSurfP-2</option>
                    </param>
                    <when value="disabled"/>
                    <when value="iupred2a">
                        <param argument="AanalyzeIUPred2A" type="data" format="txt" label="IUPred2A result file" help="Can be gziped. If
                            multiple result files were created (multiple web-server runs) just supply all of them." />
                        <expand macro="macro_disordered_regions"/>
                        <param argument="annotateBindingSites" type="boolean" truevalue="true" falsevalue="value" checked="true" label="Annotate binding sites" 
                            help="Integrate the ANCHOR2 prediction of Intrinsically Disordered Binding Regions (IDBRs)" />
                        <param argument="minIdrBindingSize" type="integer" min="0" value="15" label="Minimum IDBR binding size" help="How long a stretch of 
                            binding site the region part of the Intrinsically Disordered Binding Regions (IDBR)" />
                        <param argument="minIdrBindingOverlapFrac" type="float" min="0" value="0.8" label="Minimum fraction of a predicted IDBR" help="Minimum 
                            fraction of a predicted IDBR must also be within a IDR before the IDR is considered as a an IDR with a binding region" />
                    </when>
                    <when value="netsurfp">
                        <param argument="analyzeNetSurfP2" type="data" format="txt,gz" multiple="true" label="NetSurfP-2 result file" help="Can be gziped. If
                            multiple result files were created (multiple web-server runs) just supply all of them." />
                        <expand macro="macro_disordered_regions"/>
                    </when>
                </conditional>
                <section name="analyzeAlternativeSplicing" title="Analyze alternative splicing parameteres">
                    
                </section>
                <section name="analyzeIntronRetention" title="Analyze intron retention parameteres">
                    
                </section>
                <section name="analyzeSwitchConsequences" title="Analyze switch consequences parameters">
                    
                </section>
                <section name="extractConsequenceSummary" title="Extract consequences summary parameters">
                    
                </section>
            </when>
        </conditional>
    </inputs>
    <outputs>

    </outputs>

    <tests>
        <test expect_num_outputs="2">
            <!--TODO: auto-generated test case. Please fill in the required values-->
            <conditional name="function_mode">
                <param name="selector" value="data_import"/>
                <param name="tool_selector" value="stringtie"/>
                <param name="genome_annotation" value=""/>
                <param name="transcriptome" value=""/>
                <param name="fixed_quantification" value="true"/>
                <repeat name="rep_factorLevel">
                    <param name="factorLevel" value="FactorLevel"/>
                    <param name="trans_counts" value=""/>
                </repeat>
                <repeat name="rep_factorLevel">
                    <param name="factorLevel" value="FactorLevel"/>
                    <param name="trans_counts" value=""/>
                </repeat>
            </conditional>
        </test>
    </tests>
    <help><![CDATA[

.. class:: infomark

**Purpose**

IsoformSwitchAnalyzeR is an easy-to use-R package that enables statistical identification of isoform switching from RNA-seq derived quantification 
of novel and/or annotated full-length isoforms. IsoformSwitchAnalyzeR facilitates integration of many sources of (predicted) annotation such as Open 
Reading Frame (ORF/CDS), protein domains (via Pfam), signal peptides (via SignalP), Intrinsically Disordered Regions (IDR, via NetSurfP-2 or IUPred2A), 
coding potential (via CPAT or CPC2) and sensitivity to Non-sense Mediated Decay (NMD) and more. The combination of identified isoform switches and 
their annotation enables IsoformSwitchAnalyzeR to predict potential functional consequences of the identified isoform switches — such as loss of 
protein domains — thereby identifying isoform switches of particular interest. Lastly, IsoformSwitchAnalyzeR provides article-ready visualization 
methods for isoform switches for individual genes as well as both summary statistics and visualization of the genome-wide changes/consequences of 
isoform switches, their consequences and the associated alternative splicing.

-----

.. class:: infomark

**Differential isoform expression (DIE) and differential isoform usage (DIU)**

Differential isoform expression (DIE) and differential isoform usage (DIU) are related but distinct concepts. DIE assesses the difference of 
absolute expression in isoform level. In contrast, DIU assesses the difference of relative expression in isoform level. For example, if the 
expression of two isoforms of one gene are 10 and 20 in control and 50 and 100 in case, then there is DIE but no DIU because the relative 
expression of the first isoform is 1/3 in both case and control. 

    ]]></help>
    <expand macro="citations" />
</tool>
