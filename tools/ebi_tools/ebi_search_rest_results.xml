<tool id="ebi_search_rest_results" name="Get all the results for a query" version="@WRAPPER_VERSION@.0">
    <description>on a specific domain in EBI database</description>
    <macros>
        <import>macros.xml</import>
        <import>search_macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version"/>
    <command detect_errors="aggressive"><![CDATA[
#if $searched_domain.query.type == "free"
    #set $queries=$searched_domain.query.query
#else if $searched_domain.query.type == "constrained"
    #set $queries=''
    #set $sep=''
    #for $i, $s in enumerate( $searched_domain.query.queries )
        #if $sep == ''
            #set $sep = str($s.combination_operation)
        #else
            #set $sep = str($s.combination_operation)
            #set $queries += ' %s ' % ($sep)
        #end if
        #set $queries += '%s:' % (str($s.query_field))
        #if str($s.comp_operation.operation) == 'equal'
            #set $queries += '(%s)' % (str($s.comp_operation.query_text))
        #else if str($s.comp_operation.operation) == 'not'
            #set $queries += '(%s NOT %s)' % (str($s.comp_operation.query_text), str($s.comp_operation.not_query_text))
        #else if str($s.comp_operation.operation) == 'range'
            #set $queries += '[%s TO %s]' % (str($s.comp_operation.min), str($s.comp_operation.max))
        #end if
    #end for
#end if

ebisearch
    get_query_results
    --domain '$searched_domain.domain'
    --query '$queries'
    #for $i, $s in enumerate( $searched_domain.fields )
        --field '$s.field'
    #end for
    @SORTING@
    $field_url
    $view_url
    --file '$entry_output'
    ]]></command>
    <inputs>
        <expand macro="inputs"/>
        <param argument="--field_url" type="boolean" truevalue="--field_url" falsevalue="" label="Include the field links"/>
        <param argument="--view_url" type="boolean" truevalue="--view_url" falsevalue="" label="Include the other view links"/>
    </inputs>
    <outputs>
        <data name="entry_output" format="tabular" label="${tool.name} on ${on_string}"/>
    </outputs>
    <tests>
        <test>
            <conditional name="searched_domain">
                <param name="domain" value="metagenomics_runs"/>
                <conditional name="query">
                    <param name="type" value="constrained"/>
                    <repeat name="queries">
                        <param name="combination_operation" value="AND"/>
                        <param name="query_field" value="experiment_type"/>
                        <conditional name="comp_operation">
                            <param name="operation" value="equal"/>
                            <param name="query_text" value="metagenomic"/>
                        </conditional>
                    </repeat>
                    <repeat name="queries">
                        <param name="combination_operation" value="AND"/>
                        <param name="query_field" value="pipeline_version"/>
                        <conditional name="comp_operation">
                            <param name="operation" value="equal"/>
                            <param name="query_text" value="3.0"/>
                        </conditional>
                    </repeat>
                </conditional>
                <repeat name="fields">
                    <param name="field" value="id"/>
                </repeat>
                <repeat name="fields">
                    <param name="field" value="experiment_type"/>
                </repeat>
            </conditional>
            <param name="field_url" value=""/>
            <param name="view_url" value=""/>
            <output name="entry_output">
                <assert_contents>
                    <has_text text="ERR1297851"/>
                    <has_text text="ERR1135712"/>
                    <has_text text="ERR209566"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <conditional name="searched_domain">
                <param name="domain" value="metagenomics_runs"/>
                <conditional name="query">
                    <param name="type" value="free"/>
                    <param name="query" value="experiment_type:(metagenomic) AND pipeline_version:(3.0)"/>
                </conditional>
                <repeat name="fields">
                    <param name="field" value="id"/>
                </repeat>
                <repeat name="fields">
                    <param name="field" value="experiment_type"/>
                </repeat>
            </conditional>
            <param name="field_url" value=""/>
            <param name="view_url" value=""/>
            <output name="entry_output">
                <assert_contents>
                    <has_text text="ERR1297851"/>
                    <has_text text="ERR1135712"/>
                    <has_text text="ERR209566"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <conditional name="searched_domain">
                <param name="domain" value="enzymeportal"/>
                <conditional name="query">
                    <param name="type" value="free"/>
                    <param name="query" value="disease_name:(Anemia sideroblastic 1)"/>
                </conditional>
                <repeat name="fields">
                    <param name="field" value="name"/>
                </repeat>
                <repeat name="fields">
                    <param name="field" value="description"/>
                </repeat>
                <repeat name="fields">
                    <param name="field" value="id"/>
                </repeat>
                <repeat name="fields">
                    <param name="field" value="status"/>
                </repeat>
                <conditional name="sort">
                    <param name="selection" value="simple"/>
                    <param name="sort_field" value="status"/>
                    <param name="order" value="ascending"/>
                </conditional>
            </conditional>
            <param name="field_url" value=""/>
            <param name="view_url" value=""/>
            <output name="entry_output">
                <assert_contents>
                    <has_text text="HEM0_HUMAN"/>
                    <has_text text="TRUA_HUMAN"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <conditional name="searched_domain">
                <param name="domain" value="enzymeportal"/>
                <conditional name="query">
                    <param name="type" value="free"/>
                    <param name="query" value="disease_name:(Anemia sideroblastic 1)"/>
                </conditional>
                <repeat name="fields">
                    <param name="field" value="name"/>
                </repeat>
                <repeat name="fields">
                    <param name="field" value="description"/>
                </repeat>
                <repeat name="fields">
                    <param name="field" value="id"/>
                </repeat>
                <repeat name="fields">
                    <param name="field" value="status"/>
                </repeat>
                <conditional name="sort">
                    <param name="selection" value="complex"/>
                    <repeat name="complex_sort">
                        <param name="field" value="status"/>
                        <param name="order" value="ascending"/>
                    </repeat>
                </conditional>
            </conditional>
            <param name="field_url" value=""/>
            <param name="view_url" value=""/>
            <output name="entry_output">
                <assert_contents>
                    <has_text text="HEM0_HUMAN"/>
                    <has_text text="TRUA_HUMAN"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

This tool returns the content of entries on a specific domain in EBI database
    ]]></help>
    <expand macro="citations"/>
</tool>
