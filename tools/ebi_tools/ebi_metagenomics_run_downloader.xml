<tool id="ebi_metagenomics_run_downloader" name="Download data" version="@WRAPPER_VERSION@.0">
    <description>for a EBI Metagenomics run</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version"/>
    <command detect_errors="aggressive"><![CDATA[
ebi_metagenomics
    download_run_data
    --run '$run'
    --data '$data.data'
    #if $data.section == 'sequence' or $data.data == 'InterProScan'
        --file 'output_file.gz'
    #else
        --file '$run_data'
    #end if

#if $data.section == 'sequence' or $data.data == 'InterProScan'
    &&
    gunzip 'output_file.gz'
    &&
    mv 'output_file' '$run_data'
#end if
    ]]></command>
    <inputs>
        <param argument="--run" type="text" label="Identifier of a run in EBI Metagenomics" />
        <conditional name="data">
            <param name="section" type="select" label="Type of information to download">
                <option value="sequence">Sequence data</option>
                <option value="qc-stats">Quality control</option>
                <option value="function">Functional analysis (not available for amplicon runs)</option>
                <option value="taxonomy">Taxonomic analysis</option>
            </param>
            <when value="sequence">
                <param name="data" type="select" label="Sequences to download">
                    <option value="ProcessedReads">Processed nucleotide reads</option>
                    <option value="ReadsWithPredictedCDS">Processed reads with pCDS</option>
                    <option value="ReadsWithMatches">Processed reads with annotation</option>
                    <option value="ReadsWithoutMatches">Processed reads without annotation</option>
                    <option value="PredictedCDS">Predicted CDS (not for version 3.0 of EBI Metagenomics pipeline)</option>
                    <option value="PredictedCDSWithAnnotation">Predicted CDS with annotation (only for version 3.0 of EBI Metagenomics pipeline)</option>
                    <option value="PredictedCDSWithoutAnnotation">Predicted CDS without annotation</option>
                    <option value="PredictedORFWithoutAnnotation">Predicted ORF without annotation</option>
                    <option value="ncRNA-tRNA-FASTA">Predicted tRNAs  (only for version 3.0 of EBI Metagenomics pipeline)</option>
                </param>
            </when>
            <when value="qc-stats">
                <param name="data" type="select" label="Quality control statistics to download">
                    <option value="summary">Number of sequence reads per quality control step</option>
                    <option value="stats">Quality control statistics (only for version 3.0 of EBI Metagenomics pipeline)</option>
                    <option value="length">Read length distribution (only for version 3.0 of EBI Metagenomics pipeline)</option>
                    <option value="gc_bin">Read GC distribution (only for version 3.0 of EBI Metagenomics pipeline)</option>
                    <option value="base">Nucleotide position distribution (only for version 3.0 of EBI Metagenomics pipeline)</option>
                </param>
            </when>
            <when value="function">
                <param name="data" type="select" label="Functional analysis result to download">
                    <option value="InterProScan">InterPro matches</option>
                    <option value="GOAnnotations">Complete GO annotation</option>
                    <option value="GOSlimAnnotations">GO slim annotation</option>
                </param>
            </when>
            <when value="taxonomy">
                <param name="data" type="select" label="Taxonomic analysis result to download">
                    <option value="5S-rRNA-FASTA">Reads encoding 5S rRNA</option>
                    <option value="16S-rRNA-FASTA">Reads encoding 16S rRNA</option>
                    <option value="23S-rRNA-FASTA">Reads encoding 23S rRNA</option>
                    <option value="OTU-TSV">OTUs, reads and taxonomic assignments (TSV)</option>
                    <option value="OTU-BIOM">OTUs, reads and taxonomic assignments (BIOM, only for version 1.0 of EBI Metagenomics pipeline)</option>
                    <option value="OTU-table-JSON-BIOM">OTUs, reads and taxonomic assignments (BIOM, not for version 1.0 of EBI Metagenomics pipeline)</option>
                    <option value="NewickPrunedTree">Phylogenetic tree (not for version 1.0 of EBI Metagenomics pipeline)</option>
                    <option value="NewickTree">Phylogenetic tree (only for version 1.0 of EBI Metagenomics pipeline)</option>
                </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="run_data" format="txt" label="Download ${data.data} for ${run}">
            <change_format>
                <when input="data.data" value="ProcessedReads" format="fasta" />
                <when input="data.data" value="ReadsWithPredictedCDS" format="fasta" />
                <when input="data.data" value="ReadsWithMatches" format="fasta" />
                <when input="data.data" value="ReadsWithoutMatches" format="fasta" />
                <when input="data.data" value="PredictedCDS" format="fasta" />
                <when input="data.data" value="PredictedCDSWithAnnotation" format="fasta" />
                <when input="data.data" value="PredictedCDSWithoutAnnotation" format="fasta" />
                <when input="data.data" value="PredictedORFWithoutAnnotation" format="fasta" />
                <when input="data.data" value="ncRNA-tRNA-FASTA" format="fasta" />
                <when input="data.data" value="length" format="tabular" />
                <when input="data.data" value="gc_bin" format="tabular" />
                <when input="data.data" value="base" format="tabular" />
                <when input="data.data" value="InterProScan" format="tabular" />
                <when input="data.data" value="GOAnnotations" format="csv" />
                <when input="data.data" value="GOSlimAnnotations" format="csv" />
                <when input="data.data" value="5S-rRNA-FASTA" format="fasta" />
                <when input="data.data" value="23S-rRNA-FASTA" format="fasta" />
                <when input="data.data" value="16S-rRNA-FASTA" format="fasta" />
                <when input="data.data" value="OTU-TSV" format="tabular" />
                <when input="data.data" value="OTU-BIOM" format="biom1" />
                <when input="data.data" value="OTU-table-JSON-BIOM" format="biom1" />
                <when input="data.data" value="NewickPrunedTree" format="nhx" />
                <when input="data.data" value="NewickTree" format="nhx" />
            </change_format>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="run" value="ERR451594"/>
            <conditional name="data">
                <param name="section" value="sequence"/>
                <param name="data" value="PredictedCDSWithAnnotation" />
            </conditional>
            <output name="run_data" ftype="fasta">
                <assert_contents>
                    <has_text text="ERR451594.635-ICYCNML02HRVT5-3_1_106_+"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="run" value="ERR451594"/>
            <conditional name="data">
                <param name="section" value="qc-stats"/>
                <param name="data" value="length" />
            </conditional>
            <output name="run_data" ftype="tabular" md5="7677d04ac8fbf87e9904759eb0a6b4ba"/>
        </test>
        <test>
            <param name="run" value="ERR1664679"/>
            <conditional name="data">
                <param name="section" value="function"/>
                <param name="data" value="GOSlimAnnotations" />
            </conditional>
            <output name="run_data" ftype="csv">
                <assert_contents>
                    <has_text text="GO:0045454"/>
                    <has_text text="GO:0046718"/>
                    <has_text text="GO:0004871"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="run" value="ERR451594"/>
            <conditional name="data">
                <param name="section" value="taxonomy"/>
                <param name="data" value="NewickPrunedTree" />
            </conditional>
            <output name="run_data" ftype="nhx">
                <assert_contents>
                    <has_text text="165179:0.35618"/>
                    <has_text text="581667:0.0368"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="run" value="ERR260160"/>
            <conditional name="data">
                <param name="section" value="taxonomy"/>
                <param name="data" value="OTU-BIOM" />
            </conditional>
            <output name="run_data" ftype="biom1">
                <assert_contents>
                    <has_text text="k__Bacteria"/>
                    <has_text text="o__Clostridiales"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="run" value="ERR260160"/>
            <conditional name="data">
                <param name="section" value="taxonomy"/>
                <param name="data" value="NewickTree" />
            </conditional>
            <output name="run_data" ftype="nhx">
                <assert_contents>
                    <has_text text="1404:0.00014"/>
                    <has_text text="3350:0.00014"/>
                    <has_text text="322:0.0"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

This tool returns the content of entries on a specific domain in EBI database
    ]]></help>
    <expand macro="citations"/>
</tool>