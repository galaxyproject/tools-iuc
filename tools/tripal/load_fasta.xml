<tool id="load_fasta" name="Load a Fasta file" version="@WRAPPER_VERSION@.0">
    <description></description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command><![CDATA[
        tripal load_fasta

            --organism '${organism}'

            --analysis '${analysis}'

            --sequence-type '${sequence_type}'

            --method '${loading.method}'

            --match-type '${loading.match_type}'

            #if str($naming.re_name):
                --re-name '${naming.re_name}'
            #end if

            #if str($naming.re_uniquename):
                --re-uniquename '${naming.re_uniquename}'
            #end if

            #if str($relationships.rel_type) != "none":
                --rel-type '${relationships.rel_type}'
                --rel-subject-re '${relationships.rel_subject_re}'
                --rel-subject-type '${relationships.rel_subject_type}'
            #end if

            #if str($ext_db.db_ext_id):
                --db-ext-id '${ext_db.db_ext_id}'
            #end if

            #if str($ext_db.re_accession):
                --re-accession '${ext_db.re_accession}'
            #end if

            @AUTH@

            '${fasta}'

            > $output_log
    ]]></command>
    <inputs>
        <param name="fasta"
               type="text"
               label="Path to Fasta file"
               help="the path must be accessibe from the Tripal server" />

        <param name="organism"
               argument="--organism"
               type="text"
               label="Organism name"
               help="abbreviation or common name as created with the 'Create Organism' tool" />

        <param name="analysis"
               argument="--analysis"
               type="text"
               label="Analysis name"
               help="as named in the 'Create Analysis' tool" />

        <param name="sequence_type"
               argument="--sequence-type"
               type="text"
               label="Sequence type"
               value="contig"
               help="this should be a Sequence Ontology term" />

        <conditional name="loading">
            <param name="method"
                   argument="--method"
                   type="select"
                   label="Loading method"
                   help="select wether you expect feature to be already existing or not">
                <option value="Insert and update" selected="true">Insert and update</option>
                <option value="Insert only">Insert only</option>
                <option value="Update only">Update only</option>
            </param>
            <when value="Insert and update">
                <expand macro="match_type" />
            </when>
            <when value="Insert only"/>
            <when value="Update only">
                <expand macro="match_type" />
            </when>
        </conditional>

        <section name="naming" title="Feature naming">
            <param name="re_name"
                   argument="--re-name"
                   type="text"
                   optional="true"
                   label="Regular expression to extract feature name"
                   help="this regex will be applied on the fasta definition line to generate the feature name" />

            <param name="re_uniquename"
                   argument="--re-uniquename"
                   type="text"
                   optional="true"
                   label="Regular expression to extract feature uniquename"
                   help="this regex will be applied on the fasta definition line to generate the feature uniquename" />
        </section>

        <conditional name="relationships">
            <param name="rel_type"
                   argument="--rel-type"
                   type="select"
                   label="Relationship type"
                   help="Use this when inserting features that should be associated to other already existing features">
                <option value="none" selected="true">No relationship</option>
                <option value="part_of">Part of (for CDS sequences)</option>
                <option value="derives_from">Derives from (for peptide sequences)</option>
            </param>
            <when value="none"/>
            <when value="part_of">
                <expand macro="feature_rel" />
            </when>
            <when value="derives_from">
                <expand macro="feature_rel" />
            </when>
        </conditional>

        <section name="ext_db" title="Cross references to external database">
            <param name="db_ext_id"
                   argument="--db-ext-id"
                   type="integer"
                   optional="true"
                   label="External Database ID"
                   help="Numeric ID from the Chado database" />

            <param name="re_accession"
                   argument="--re-accession"
                   type="text"
                   optional="true"
                   label="Regular expression to extract the accession from external DB"
                   help="this regex will be applied on the fasta definition line to generate the accession from external DB" />
        </section>

        <expand macro="tripal_auth" />
    </inputs>
    <outputs>
        <data format="txt" name="output_log" label="Load Fasta into Tripal" />
    </outputs>
    <tests>
        <test expect_failure="true" expect_exit_code="1">
            <param name="fasta" value="/some/path/to/seq.fasta" />
            <param name="organism" value="Testus testus" />
            <param name="analysis" value="Annotation xx" />
            <param name="sequence_type" value="mRNA" />
            <conditional name="loading">
                <param name="method" value="Insert and update" />
                <param name="match_type" value="Unique name" />
            </conditional>
            <section name="naming">
                <param name="re_name" value="([a-z]{4}[0-9]+)_suffix" />
                <param name="re_uniquename" value="([a-z]{4}[0-9]+_suffix)" />
            </section>

            <expand macro="test_auth" />

            <assert_stderr>
                <has_text text="Name or service not known" />
            </assert_stderr>
        </test>
    </tests>
    <help><![CDATA[
        @HELP_OVERVIEW@

        **Load Fasta**

        With this tool, you can load sequences from a Fasta file into the Tripal/Chado database.

        Corresponding features can be created if needed.

        @HELP_JOB@

        @HELP@
    ]]></help>
    <expand macro="citation"/>
</tool>
