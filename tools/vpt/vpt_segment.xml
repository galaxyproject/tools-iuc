<tool id="vpt_segment" name="Vizgen Post-processing Tool - Segment Cells" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Reprocess and refine the single-cell results of MERSCOPE experiments</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        mkdir -p 'input' 'output'
        vpt \
        <expand macro="common_args" />
        --segmentation-algorithm 'input/vpt_config' \
        --input-images 'input/images/' \
        --input-micron-to-mosaice 'input/micron_to_mosaic.csv' \
        --output-path 'output/' \
        --tile-size $tile_size \
        --tile-overlap $tile_overlap \
        #if $max_row_group_size:
            --max-row-group-size $max_row_group_size \
        #end if
    ]]></command>
    <configfiles>
        <configfile name="vpt_config">
            {
                "experiment_properties": {
                    "all_z_indexes": [0, 1, 2, ... ],
                    "z_positions_um": [1.5, 3, 4.5, ... ]
                },
                "segmentation_tasks": [
                    {
                    "task_id": 0,
                    "segmentation_family": "Cellpose2",
                    "entity_types_detected": [ ... ],
                    "z_layers": [ ... ],
                    "segmentation_properties": {
                        "model": "cyto2",
                        "model_dimensions": "2D",
                        "custom_weights": { ... }
                        "version": "latest",
                    },
                    "task_input_data": [ ... ] ,
                    "segmentation_parameters": { ... },
                    "polygon_parameters": { ... },
                    },
                ],
                "segmentation_task_fusion": { ... },
                "output_files": [
                    {
                    "entity_types_output": [ ... ],
                    "files": { ... }
                    }
                ]
            }
        </configfile>
    </configfiles>
    <inputs>
        <param argument="--input_images" type="data" format="tiff" multiple="true" label="MEROSCOPE tiff images"/>
        <param argument="--input_micron_to_mosaic" type="data" format="csv" label="Micron to mosaic mapping file"/>
        <param argument="--tile_size" type="integer" min="0" value="4096" label="Number of pixels for the width and height of each tile"/>
        <param argument="--tile_overlap" type="integer" min="0" max="100" value="10" label="Overlap between adjacent tiles" help="Default: 10% of tile size"/>
        <param argument="--max_row_group_size" type="integer" min="1000" value="" optional="true" label="Maximum number of rows in row groups inside output parquet files"/>
        <section name="vpt_config" title="Segmentation configuration file">
            <section name="experiment_properties" title="Experiment properties" help="Specify the z-indexes and z-positions in the data. It is used to apply 2D segmentation to 3D data and calculate distances on the z-axis.">
                <param argument="--all_z_indexes" type="text" value="0, 1, 2, 3, 4, 5, 6" optional="false" label="z-layer indeces">
                    <expand macro="sanitize_digits"/>
                </param>
                <param argument="--z_positions_um" type="text" value="1.5, 3, 4.5, 6, 7.5, 9, 10.5" optional="false" label="z-layer positions in um">
                    <expand macro="sanitize_digits"/>
                </param>
            </section>
            <section name="segmentation_tasks" title="Segmentation tasks" help="A list of segmentation tasks to perform sequentially. The VPT only supports 9 tasks in a single segmentation algorithm. If more tasks are needed, users are encouraged to run vpt multiple times and combine the segmentation outputs post hoc.">
                <repeat name="segmentation_task" min="1" max="9" title="Segmentation tasks">
                    <param argument="--entity_types_detected" type="select" label="detect cell or nucleus?">
                        <option value="cell">cell</option>
                        <option value="nucleus">nucleus</option>
                    </param>
                    <param argument="--z_layers" type="text" value="" optional="true" label="comma-separated list of z-index images to segment." help="2D segmentation is applied to all z-layers in the experiment by default without needing to explicitly specify the behavior.">
                        <expand macro="sanitize_digits"/>
                    </param>
                    <section name="segmentation_properties" title="Segmentation properties">
                        <param argument="--model" type="select" label="Cellpose model">
                            <option value="cyto2">cyto2</option>
                            <option value="nuclei">nuclei</option>
                            <option value="null">null</option>
                        </param>
                        <param argument="--model_dimensions" type="select" label="Model dimensions" help="2D applies the 2D Cellpose model to all z-planes specified in the z_layers list seperately and the results are combined into a 3D output. 3D applies the native-3D Cellpose model to all z-planes specified in the z_layers list.">
                            <option value="2D">2D</option>
                            <option value="3D">3D</option>
                        </param>
                        <param argument="--custom_weights" type="data" format="data" optional="true" label="custom Cellpose weights file"/>
                        <section name="channel_map" title="Channel map">
                            <param name="greyscale" type="text" value="" optional="true" label="greyscale"/>
                            <param name="red" type="text" value="" optional="true" label="red"/>
                            <param name="green" type="text" value="" optional="true" label="green"/>
                            <param name="blue" type="text" value="" optional="true" label="blue"/>
                        </section>
                    </section>
                    <section name="segmentation_parameters" title="Segmentation parameters">
                        <param name="nuclear_channel" type="text" value="" optional="true" label="nuclear channel"/>
                        <param name="entity_fill_channel" type="text" value="" optional="true" label="entity fill channel"/>
                        <param name="diameter" type="integer" min="0" value="0" label="diameter" help="Default 0 value will let Cellpose to automatically estimate the diameter. Too small diameter leads to fragmented cells and Too big one leads to over-merged cells"/>
                        <param name="resample" type="boolean" falsevalue="False" truevalue="True" checked="true" label="resample" help="Interpolated flows at the true image size. This option will create smoother ROIs when the cells are large but will be slower in case" />
                        <param name="flow_threshold" type="float" min="0" max="1" value="0.4" label="flow threshold" help="Maximum allowed error of the flows for each mask. Increase if cellpose is not returning as many ROIs as you’d expect, and decrease if cellpose is returning too many ill-shaped ROIs"/>
                        <param name="cellprob_threshold" type="float" min="-6" max="+6" value="0.0" label="cellprobe threshold" help="Decrease this threshold if cellpose is not returning as many ROIs as you’d expect. Similarly, increase this threshold if cellpose is returning too ROIs particularly from dim areas."/>
                        <param name="niter" type="integer" min="0" value="0" label="Number of iterations" help="The default 0 sets the number of iterations to be proportional to the ROI diameter. For longer ROIs, more iterations might be needed."/>
                    </section>
                    <section name="task_input_data" title="Task input data" help="A list of image channels and per-channel pre-processing steps. This allows the application of intensity normalization, down-sampling, and/or blurring before performing cell segmentation.">
                        <repeat name="task_input" min="1" max="4" title="Task input data">
                            <param name="image_channel" type="text" value="" label="image channel"/>
                            <repeat name="image_preprocessing" min="1" max="3" title="Image preprocessing">
                                <conditional name="preprocess_conditional" label="Select preprocessing steps">
                                    <param name="preprocess" type="select" label="preprocess">
                                        <option value="normalize">normalize</option>
                                        <option value="blur">blur</option>
                                        <option value="downsample">downsample</option>
                                    </param>
                                    <when value="normalize">
                                        <conditional name="normalize_conditional" label="Select normalization method">
                                            <param name="normalization" type="select" label="normalization">
                                                <option value="default">default (min-max range normalization)</option>
                                                <option value="CLAHE">CLAHE (Contrast Limited Adaptive Histogram Equalization)</option>
                                            </param>
                                            <when value="default"/>
                                            <when value="CLAHE">
                                                <param name="clip_limit" type="float" min="0" max="1" value="0.01" label="clip limit" help="higher values give more contrast"/>
                                                <param name="filter_size" type="integer" min="1" value="" label="tile grid size" help="If not specified, 1/8 of image height and width is used"/>
                                            </when>
                                        </conditional>
                                    </when>
                                    <when value="blur">
                                        <param name="blur_options" type="select" label="blur options">
                                            <option value="average">average</option>
                                            <option value="median">median</option>
                                            <option value="gaussian">gaussian</option>
                                        </param>
                                        <param name="kernel_size" type="integer" min="0" value="5" label="kernel size in pixel"/>
                                    </when>
                                    <when value="downsample">
                                        <param name="scale" type="integer" min="0" value="2" label="downsample" help="Reduces the size of the images during segmentation to decrease processing time" />
                                    </when>
                                </conditional>
                            </repeat>
                        </repeat>
                    </section>
                    <section name="polygon_parameters" title="Polygon parameters">
                        <param name="simplification_tol" type="integer" min="0" label="simplification tolerance" help="The acceptable loss of precision when simplifying cell boundaries. Even a small amount of simplification (2 px) dramatically improves processing time" />
                        <param name="smoothing_radius" type="integer" min="0" label="smoothing radius" help="The size of a smoothing operation comparable to morphologically closing and then opening the cell mask using the same structuring element" />
                        <param name="minimum_final_area" type="integer" min="0" label="minimum final area" help="Minimum area of a polygon to retain the cell. Used to filter spurious detections." />
                    </section>


                </repeat>
            </section>
            <section name="segmentation_task_fusion" title="Segmentation task fusion" help="Specify how the geometries produced by each segmentation task should be combined">

            </section>
        </section> 
    </inputs>
    <outputs>

    </outputs>
    <tests>

    </tests>
    <help>

    </help>
    <expand macro="citations" />
</tool>