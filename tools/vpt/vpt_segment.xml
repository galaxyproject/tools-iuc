<tool id="vpt_segment" name="Vizgen Post-processing Tool - Segment Cells" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Reprocess and refine the single-cell results of MERSCOPE experiments</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        mkdir -p 'input' 'output'
        vpt \
        <expand macro="common_args" />
        --segmentation-algorithm 'input/vpt_config' \
        --input-images 'input/images/' \
        --input-micron-to-mosaice 'input/micron_to_mosaic.csv' \
        --output-path 'output/' \
        --tile-size $tile_size \
        --tile-overlap $tile_overlap \
        #if $max_row_group_size:
            --max-row-group-size $max_row_group_size \
        #end if
    ]]></command>
    <configfiles>
        <configfile name="vpt_config">
            {
                "experiment_properties": {
                    "all_z_indexes": [0, 1, 2, ... ],
                    "z_positions_um": [1.5, 3, 4.5, ... ]
                },
                "segmentation_tasks": [
                    {
                    "task_id": 0,
                    "segmentation_family": "Cellpose2",
                    "entity_types_detected": [ ... ],
                    "z_layers": [ ... ],
                    "segmentation_properties": {
                        "model": "cyto2",
                        "model_dimensions": "2D",
                        "custom_weights": { ... }
                        "version": "latest",
                    },
                    "task_input_data": [ ... ] ,
                    "segmentation_parameters": { ... },
                    "polygon_parameters": { ... },
                    },
                ],
                "segmentation_task_fusion": { ... },
                "output_files": [
                    {
                    "entity_types_output": [ ... ],
                    "files": { ... }
                    }
                ]
            }
        </configfile>
    </configfiles>
    <inputs>
        <param argument="--input_images" type="data" format="tiff" multiple="true" label="MEROSCOPE tiff images"/>
        <param argument="--input_micron_to_mosaic" type="data" format="csv" label="Micron to mosaic mapping file"/>
        <param argument="--tile_size" type="integer" min="0" value="4096" label="Number of pixels for the width and height of each tile"/>
        <param argument="--tile_overlap" type="integer" min="0" max="100" value="10" label="Overlap between adjacent tiles" help="Default: 10% of tile size"/>
        <param argument="--max_row_group_size" type="integer" min="1000" value="" optional="true" label="Maximum number of rows in row groups inside output parquet files"/>
        <section name="vpt_config" title="Segmentation configuration file">
            <section name="experiment_properties" title="Experiment properties" help="Specify the z-indexes and z-positions in the data. It is used to apply 2D segmentation to 3D data and calculate distances on the z-axis.">
                <param argument="--all_z_indexes" type="text" value="0, 1, 2, 3, 4, 5, 6" optional="false" label="z-layer indeces">
                    <expand macro="sanitize_digits"/>
                </param>
                <param argument="--z_positions_um" type="text" value="1.5, 3, 4.5, 6, 7.5, 9, 10.5" optional="false" label="z-layer positions in um">
                    <expand macro="sanitize_digits"/>
                </param>
            </section>
            <section name="segmentation_tasks" title="Segmentation tasks" help="A list of segmentation tasks to perform sequentially. The VPT only supports 9 tasks in a single segmentation algorithm. If more tasks are needed, users are encouraged to run vpt multiple times and combine the segmentation outputs post hoc.">
                <repeat name="segmentation_task" min="1" max="9" title="Segmentation tasks">
                    <param argument="--entity_types_detected" type="select" label="detect cell or nucleus?">
                        <option value="cell">cell</option>
                        <option value="nucleus">nucleus</option>
                    </param>
                    <param argument="--z_layers" type="text" value="" optional="true" label="comma-separated list of z-index images to segment." help="2D segmentation is applied to all z-layers in the experiment by default without needing to explicitly specify the behavior.">
                        <expand macro="sanitize_digits"/>
                    </param>
                    <section name="segmentation_properties" title="Segmentation properties">
                        <param argument="--model" type="select" label="Cellpose model">
                            <option value="cyto2">cyto2</option>
                            <option value="nuclei">nuclei</option>
                            <option value="null">null</option>
                        </param>
                        <param argument="--model_dimensions" type="select" label="Model dimensions" help="2D applies the 2D Cellpose model to all z-planes specified in the z_layers list seperately and the results are combined into a 3D output. 3D applies the native-3D Cellpose model to all z-planes specified in the z_layers list.">
                            <option value="2D">2D</option>
                            <option value="3D">3D</option>
                        </param>
                        <param argument="--custom_weights" type="data" format="data" optional="true" label="custom Cellpose weights file"/>
                        <section name="channel_map" title="Channel map">
                            <param name="greyscale" type="text" value="" optional="true" label="greyscale"/>
                            <param name="red" type="text" value="" optional="true" label="red"/>
                            <param name="green" type="text" value="" optional="true" label="green"/>
                            <param name="blue" type="text" value="" optional="true" label="blue"/>
                        </section>
                    </section>
                    <section name="segmentation_parameters" title="Segmentation parameters">
                        
                    </section>




                </repeat>
            </section>
            <section name="segmentation_task_fusion" title="Segmentation task fusion" help="Specify how the geometries produced by each segmentation task should be combined">

            </section>
        </section> 
    </inputs>
    <outputs>

    </outputs>
    <tests>

    </tests>
    <help>

    </help>
    <expand macro="citations" />
</tool>