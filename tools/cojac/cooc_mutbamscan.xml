<tool id="cooc_mutbamscan" name="Cojac: mutbamscan" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@"
      profile="@PROFILE@">
    <description>
        scan an alignment file for mutation co-occurrences
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements">
        <requirement type="package" version="1.15.1">samtools</requirement>
    </expand>
    <expand macro="version"/>
    <command detect_errors="exit_code"><![CDATA[
ln -s '$bed_file' 'bed_file' &&
@VOCDIR_COMMAND@
    ln -s '$bam_file' '${bam_file.element_identifier}.sorted.bam' &&
    samtools index '${bam_file.element_identifier}.sorted.bam' '${bam_file.element_identifier}.bam.bai' &&
    mv '${bam_file.element_identifier}.sorted.bam' '${bam_file.element_identifier}.bam' &&

cooc-mutbamscan
    -a *.bam
    -b 'bed_file'
    -m '$vocdir'
    -y cooc.yaml
    -j cooc.json
    #if $amplicons_file.choice == 'build'
        -A amplicons.yaml
    #else
        -Q '$amplicons_file.in_amp'
    #end if
	-t cooc.tsv
	#if $batchname
        -/ '$batchname'
    #end if
	--cooc '$cooc'
    ]]></command>
    <inputs>
        <expand macro="vocdir_input"/>
        <param name="bed_file" type="data" format="bed"
               label="BED file defining the amplicons"/>
        <param name="bam_file" type="data" format="bam,cram,sam"
               label="Alignment BAM/CRAM/SAM file"/>
        <param argument="--batchname" type="text" optional="true"
               label="Batch name"
               help="Split samplename/batchname (as in samples tsv)"/>
        <param argument="--cooc" type="integer" min="1" value="2"
               label="Minimum number of cooccurence mutations on the same amplicon"/>
        <conditional name="amplicons_file">
            <param name="choice" type="select" label="Source of amplicons YAML file">
                <option value="build">Build from BED + set of YAMLs for variants of concern</option>
                <option value="custom">From history</option>
            </param>
            <when value="build"/>
            <when value="custom">
                <param name="in_amp" type="data" format="yaml"
                       label="YAML file to query amplicons"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="cooc_yaml" format="yaml"
              label="${tool.name} on ${on_string}: Mutation cooccurrence (yaml)"
              from_work_dir="cooc.yaml">
        </data>
        <data name="cooc_json" format="json"
              label="${tool.name} on ${on_string}: Mutation cooccurrence (json)"
              from_work_dir="cooc.json">
        </data>
        <data name="cooc_tsv" format="tabular"
              label="${tool.name} on ${on_string}: Mutation cooccurrence (tsv)"
              from_work_dir="cooc.tsv">
        </data>
        <data name="amplicons" format="yaml"
              label="${tool.name} on ${on_string}: Amplicons (yaml)"
              from_work_dir="amplicons.yaml">
            <filter>amplicons_file['choice'] == 'build'</filter>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: build yaml for amplicons from bed and voc/ -->
        <test expect_num_outputs="4">
            <conditional name="vocdir_option">
                <param name="choice" value="custom"/>
                <param name="voc_file" value="omicron_ba1_mutations.yaml"/>
            </conditional>
            <param name="bam_file" value="tbam11.bam"/>
            <param name="bed_file" value="nCoV-2019.insert.V3.bed"/>
            <conditional name="amplicons_file">
                <param name="choice" value="build"/>
            </conditional>
            <output name="cooc_yaml" ftype="yaml">
                <assert_contents>
                    <has_text text="76_om1"/>
                    <has_text text="81_om1"/>
                </assert_contents>
            </output>
            <output name="cooc_json" ftype="json">
                <assert_contents>
                    <has_text text="76_om1"/>
                    <has_text text="81_om1"/>
                </assert_contents>
            </output>
            <output name="cooc_tsv" ftype="tabular">
                <assert_contents>
                    <has_text text="76_om1"/>
                    <has_text text="81_om1"/>
                </assert_contents>
            </output>
            <output name="amplicons" ftype="yaml">
                <assert_contents>
                    <has_text text="76_om1"/>
                    <has_text text="81_om1"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 2: supply yaml for amplicons and voc/ from cache -->
        <test expect_num_outputs="3">
            <conditional name="vocdir_option">
                <param name="choice" value="cache"/>
            </conditional>
            <param name="bam_file" value="tbam11.bam"/>
            <param name="bed_file" value="nCoV-2019.insert.V3.bed"/>
            <conditional name="amplicons_file">
                <param name="choice" value="custom"/>
                <param name="in_amp" value="amplicons111.yaml"/>
            </conditional>
            <output name="cooc_yaml" ftype="yaml">
                <assert_contents>
                    <has_text text="76_om1"/>
                    <has_text text="81_om1"/>
                </assert_contents>
            </output>
            <output name="cooc_json" ftype="json">
                <assert_contents>
                    <has_text text="76_om1"/>
                    <has_text text="81_om1"/>
                </assert_contents>
            </output>
            <output name="cooc_tsv" ftype="tabular">
                <assert_contents>
                    <has_text text="76_om1"/>
                    <has_text text="81_om1"/>
                </assert_contents>
            </output>
        </test>

    </tests>
    <help><![CDATA[
@HELP_HEADER@

Information about **cooc-mutbamscan** method
============================================

The method scans an alignment BAM/CRAM/SAM file for mutation co-occurrences and output a JSON or YAML file.

    ]]></help>
    <expand macro="citations"/>
</tool>
