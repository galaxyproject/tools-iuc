<tool id="kallistobus" name="Kallisto-Bus" version="0.1.0">
    <description>Generate BUS files for single-cell sequencing</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="0.46.0">kallisto</requirement>
        <requirement type="package" version="0.39.3">bustools</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        kallisto bus -i '${index}'
        -x '${techselect.tech}'
        -o output_bus
        '${file1}' '${file2}'
        #if $techselect.tech == "10xv1":
            '${techselect.file3}'
        #end if
        ]]>
    </command>
    <inputs>
        <param name="file1" type="data" format="fastq" label="Input FASTQ 1"/>
        <param name="file2" type="data" format="fastq" label="Input FASTQ 2"/>
        <param name="index" type="data" format="kallisto.idx" label="Index file for pseudoalignment"/>
        <conditional name="techselect">
            <param name="tech" type="select" label="Sequencing technology" help="SIngle-cell technology used">
                <!--Current version of kallisto returns a segmentation fault when running 10xv1 data. Once the issue is fixed, uncomment and the program will run.-->
                <!--<option value="10xv1">10x version 1 chemistry</option>-->
                <option value="10xv2">10x version 2 chemistry</option>
                <option value="10xv3">10x version 3 chemistry</option>
                <option value="CELSeq">Cel-Seq</option>
                <option value="CELSeq2">Cel-Seq2</option>
                <option value="DropSeq">DropSeq</option>
                <option value="inDrops">inDrops</option>
                <option value="SCRBSeq">SCRB-Seq</option>
                <option value="SureCell">SureCell for ddSeq</option>
            </param>
            <when value="10xv1">
                <!--<param name="file3" type="data" format="fastq" optional="true" label="Input FASTQ 3"/>-->
            </when>
            <when value="10xv2"/>
            <when value="10xv3"/>
            <when value="CELSeq"/>
            <when value="CELSeq2"/>
            <when value="DropSeq"/>
            <when value="inDrops"/>
            <when value="SCRBSeq"/>
            <when value="SureCell"/>
        </conditional>
    </inputs>
    <outputs>
        <collection name="kallistobus" type="list" label="Kallisto bus output on ${on_string}">
            <data name="matrix.ec" format="kallisto.ec" from_work_dir="output_bus/matrix.ec"/>
            <data name="output.bus" format="bus" from_work_dir="output_bus/output.bus"/>
            <data name="run_info.json" format="json" from_work_dir="output_bus/run_info.json"/>
            <data name="transcripts.txt" format="txt" from_work_dir="output_bus/transcripts.txt"/>
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="file1" value="R1.head.fastq.gz"/>
            <param name="file2" value="R2.head.fastq.gz"/>
            <param name="index" value="index.idx"/>
            <param name="tech" value="10xv2"/>
            <output_collection name="kallistobus" type="list">
                <element name="matrix.ec" file="test.ec" ftype="kallisto.ec" compare="sim_size"/>
                <element name="output.bus" file="test.bus" ftype="bus" compare="sim_size"/>
                <element name="transcripts.txt" file="test.txt" ftype="txt"/>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
`kallisto <https://pachterlab.github.io/kallisto/manual>`__ is a program for quantifying abundances of transcripts from RNA-Seq data, or more generally of target sequences using high-throughput sequencing reads. It is based on the novel idea of pseudoalignment for rapidly determining the compatibility of reads with targets, without the need for alignment.
    ]]></help>
    <expand macro="citations"/>
</tool>
