<tool id='ragtag' name='RagTag' version='@TOOL_VERSION@+galaxy@VERSION_SUFFIX@' profile='20.01'>
    <description>reference-guided scaffolding of draft genomes</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro='xrefs' />
    <expand macro='requirements' />
    <command detect_errors='exit_code'><![CDATA[
    ragtag.py $mode_conditional.mode_option -u
    #if $mode_conditional.mode_option == 'correct'
        $mode_conditional.reference
        $mode_conditional.query
        #if $mode_conditional.validation_conditional.validation_option == 'true'
            -R '${mode_conditional.validation_conditional.R}'
            -T $mode_conditional.validation_conditional.read_type
            -v $mode_conditional.validation_conditional.v 
            --max-cov $mode_conditional.validation_conditional.max_cov
            --min-cov $mode_conditional.validation_conditional.min_cov
        #end if
        --aligner $mode_conditional.advanced_options.mapping_conditional.mapping_option 
        #if $mode_conditional.advanced_options.mapping_conditional.mapping_option == 'nucmer'
            --nucmer-params '${mode_conditional.advanced_options.nucmer_params}'
        #else if $mode_conditional.advanced_options.mapping_conditional.mapping_option == 'unimap'
            --unimap-params '${mode_conditional.advanced_options.unimap_params}'
        #else
            --mm2-params '${mode_conditional.advanced_options.mapping_conditional.mm2_params}'
        #end if
        #if $mode_conditional.advanced_options.e 
            -e '${mode_conditional.advanced_options.e}'
        #end if
        #if $mode_conditional.advanced_options.j
            -j '${mode_conditional.advanced_options.j}'
        #end if 
        -f $mode_conditional.advanced_options.f 
        --remove-small $mode_conditional.advanced_options.remove_small 
        -q $mode_conditional.advanced_options.q
        -d $mode_conditional.advanced_options.d
        -b $mode_conditional.advanced_options.b
        #if $mode_conditional.advanced_options.missasembly_break
            $mode_conditional.advanced_options.missasembly_break
        #end if
        #if $mode_conditional.advanced_options.gff 
            --gff '${mode_conditional.advanced_options.gff}'
        #end if
        --read-aligner 'minimap2' ## it is the only allowed
    #else if $mode_conditional.mode_option == 'scaffold'
        #if $mode_conditional.advanced_options.unplaced_conditional.unplaced_option == 'true'
            -C
            #if $mode_conditional.advanced_options.unplaced_conditional.J 
                -J '${mode_conditional.advanced_options.unplaced_conditional.J}'
            #end if
        #end if
    #end if
    -o ./
    -t \${GALAXY_SLOTS:-2}
     && ls -lah
    ]]>    </command>
    <inputs>
        <conditional name="mode_conditional">
            <param name="mode_option" type="select" label="Operation mode">
                <option value="correct">Correct: homology-based missasembly correction</option>
                <option value="scaffold">Scaffold: homology-based assebly scaffolding</option>
                <option value="patch">Patch: homology-based assembly patching</option>
                <option value="merge">Merge: scaffolding merging</option>
            </param>
            <when value="correct">
                <expand macro="input_options"/>
                <conditional name="validation_conditional">
                    <param name="validation_option" type="select" label="Use validation reads">
                        <option value="true">Enabled</option>
                        <option value="false" selected="true">Disabled</option>
                    </param>
                    <when value="true">
                        <param argument="-R" type="data" format="fasta, fasta.gz" optional="true" label="Validation reads" />
                        <param name="read_type" type="select" label="Read type">
                            <option value="sr">Illumina</option>
                            <option value="ont">Nanopore</option>
                            <option value="corr">Error corrected long-reads</option>
                        </param>
                        <param argument="-v" type="integer" min="0" value="10000" label="Coverage validation window size" />
                        <param argument="--max-cov" type="integer" min="0" value="" optional="true" label="Break sequences at regions at or above this coverage level"/>
                        <param argument="--min-cov" type="integer" min="0" value="" optional="true" label="Break sequences at regions at or below this coverage level"/>
                    </when>
                    <when value="false"/>
                </conditional>
                <section name="advanced_options" title="Advanced options">
                    <expand macro="mapping_macros"/>
                    <expand macro="common_options"/>
                    <param argument="-b" type="integer" min="0" value="5000" label="Minimum break distance from contig ends"/>
                    <param name="missasembly_break" type="select" optional="true" label="Break misassebly option">
                        <option value="--inter">Only break misassemblies between reference sequences (--inter)</option>
                        <option value="--intra">Only break missasemblies within reference sequences (--intra)</option>
                    </param>
                    <param argument="--gff" type="data" format="gff" optional="true" label="Don't break sequences within GFF intervals"/>
                </section>
            </when>
            <when value="scaffold">
                <expand macro="input_options"/>
                <section name="advanced_options" title="advanced options">
                    <expand macro="mapping_macros"/>
                    <expand macro="common_options"/>
                    <param argument="-i" type="float" min="0" max="1" value="0.2" label="Minimum grouping confidence score"/>
                    <param argument="-a" type="float" min="0" max="1" value="0" label="Minimum location confidence score"/>
                    <param argument="-s" type="float" min="0" max="1" value="0" label="Minimum orientation confidence score"/>
                    <conditional name="gap_conditional">
                        <param name="gap_option" type="select" label="Infer gap sizes" help="When disabled, all gaps are 100 bp (-r)">
                            <option value="true" selected="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </param>
                        <when value="true">
                            <param argument="--g" type="integer" min="0" value="100" label="Minimum infered gap size" />
                            <param argument="-m" type="integer" min="0" value="100000" label="Maximum inferred gap size"/>
                        </when>
                        <when value="false"/>
                    </conditional>
                    <conditional name="unplaced_conditional">
                        <param name="unplaced_option" type="select" label="Concatenate unplaced contigs and make 'chr0'">
                            <option value="true">Enabled</option>
                            <option value="false" selected="true">Disabled</option>
                        </param>
                        <when value="true">
                            <param argument="-J" type="data" format="txt" optional="true" label="List of query headers to leave unplaceds and exclude form 'chr0'"/>
                        </when>
                        <when value="false"/>
                    </conditional>
                </section>
            </when>
            <when value="patch">
                <expand macro="input_options"/>
                <section name="advanced_options" title="advanced options">
                    <expand macro="mapping_macros"/>
                    <expand macro="common_options"/>
                    <param argument="-s" type="integer" min="0" value="50000" label="Minimum merged alignment length"/>
                    <param argument="-i" type="float" min="0" max="1" value="0.05" label="Maximum merged alignment distance" help="Maximum merged alignment distance from sequence terminus as fraction of the sequence length"/>
                    <param name="patching_mode" type="select" optional="true" label="Patching mode">
                        <option value="--fill-only">Only fill existing target gaps. Do not join target sequences</option>
                        <option value="--join_only">Only join and patch target sequences. DO not fill existing gaps</option>
                    </param>
                </section>
            </when>
            <when value="merge">
                <param name="assembly_fasta" type="data" format="fasta" label="Assembly FASTA file"/>
                <param name="scaffold_files" type="data" format="agp" multiple="true" optional="true" label="Scaffold AGP files"/>
                <section name="merging_options" title="Merging options">
                    <param argument="-f" type="data" format="csv" optional="true" label="CSV list of (AGP file,weight)"/>
                    <param argument="-j" type="data" format="txt" label="List of query headers to leave unplaced"/>
                    <param argument="-l" type="integer" min="0" value="100000" label="Minimum assembly sequence length"/>
                    <param argument="-e" type="float" min="0" value="0" label="Minimum edge weight"/>
                    <param name="function_merging" type="select" label="Function for merging gap lengths">
                        <option value="min" selected="true">Min</option>
                        <option value="max">Max</option>
                        <option value="mean">Mean</option>
                    </param>
                </section>
                <section name="hic_options" title="HI-C options">
                    <param argument="-b" type="data" format="bam" label="Hi-C alignments" help="Sorted by read name"/>
                    <param argument="-r" type="text" value="" label="Restriction enzymes/sites or 'DNase'" help="List of restrction enzimes/sites or 'DNase', separated by comma. E.g. GATC,GACC">
                        <sanitizer invalid_char="">
                            <valid initial="string.letters,string.digits">
                                <add value="," />
                                <add value="[" />
                                <add value="]" />
                            </valid>
                        </sanitizer>
                        <validator type="regex">[0-9a-zA-Z,\]\[]+</validator>
                    </param>
                    <param argument="-p" type="float" min="0" max="1" value="1" label="Portion of the sequence termini to consider for links"/>
                </section>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format="paf" name="output_paf" from_work_dir="ragtag.correct.asm.paf" label="${tool.name} on ${on_string}: PAF"/>
        <data format="tabular" name="output_agp" from_work_dir="ragtag.correct.agp" label="${tool.name} on ${on_string}: AGP"/>
        <data format="fasta" name="output_fasta" from_work_dir="ragtag.correct.fasta" label="${tool.name} on ${on_string}: FASTA"/>
        <data format="txt" name="output_log" from_work_dir="ragtag.correct.asm.paf.log" label="${tool.name} on ${on_string}: log"/>
    </outputs>
    <tests>
    </tests>
    <help><![CDATA[
.. class:: infomark

**Purpose**

Hello!

----

.. class:: infomark

**List of accepted restriction enzymes**

    Below is a list of all accepted restriction enzymes and
    their restriction sites:

        HindIII: AAGCTT
        Sau3AI: GATC
        MboI: GATC
        DpnII: GATC
        HinfI: GA[ATCG]TC
        DdeI: CT[ATCG]AG
        MseI: TTAA

    For RagTag, use a comma separated list of enzymes or
    sites (or a mix). For example:
    
    -- Arima Hi-C v1.0
        'Sau3AI,HinfI' or 'GATC,GA[ATCG]TC'.
    
    -- Arima Hi-C v2.0 ("Arima High Coverage Hi-C")
        'Sau3AI,HinfI,DdeI,MseI' or 'GATC,GA[ATCG]TC,CT[ATCG]AG,TTAA'.
 
    Note that for restriction sites, wildcards are
    represented with python regex syntax, not IUPAC
    ambiguity codes. e.g. '[ATCG]' instead of 'N'.
    
    Restriction enzymes are not necessarily the enzyme
    used for sample prep. Each is only a enzyme that
    cuts at the corresponding restriction site.

    Please contact the developers if you would like to add
    more enzymes/sites.

    ]]>    </help>
    <expand macro="citations" />
</tool>