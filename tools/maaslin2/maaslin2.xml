<tool id="maaslin2" name="MaAsLin 2" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Next Generation of MaAsLin (Microbiome Multivariable Association with Linear Models)</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="edam_ontology"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
ln -s '$input_data' 'input_data.tsv'
&&
ln -s '$input_metadata' 'input_metadata.tsv'
&&   
Maaslin2.R
#if $min_abundance   
    --min_abundance '$min_abundance'
#end if
#if $min_prevalence
    --min_prevalence '$min_prevalence'
#end if
#if $max_significance
    --max_significance '$max_significance'
#end if
#if $normalization
    --normalization '$normalization'
#end if
#if $transform
    --transform '$transform'
#end if
#if $analysis_method
    --analysis_method '$analysis_method'
#end if
#if $random_effects
    --random_effects '$random_effects'
#end if
#if $fixed_effects
    --fixed_effects '$fixed_effects'
#end if
#if $correction
    --correction '$correction'
#end if
#if $standardize
    --standardize '$standardize'
#end if
#if $output.plot_heatmap
    --plot_heatmap '$output.plot_heatmap'
#end if
#if $output.heatmap_first_n
    --heatmap_first_n '$output.heatmap_first_n'
#end if
#if $output.plot_scatter
    --plot_scatter '$output.plot_scatter'
#end if
#if $cores
    --cores '$cores'
#end if
    'input_data.tsv'
    'input_metadata.tsv'
    'outputFolder'
&&
cd outputFolder &&  mkdir -p figures/ && cp *.pdf figures
    ]]></command>
    <inputs>
        <param name="input_data" type="data" format="tsv" label="Data (or features) file"/>
        <param name="input_metadata" type="data" format="tsv" label="Metadata file"/>
        <param argument="--min_abundance" type="integer" value="0" optional="true" label="Minimum abundance" help="The minimum abundance for each feature"/>
        <param argument="--min_prevalence" type="float" value="0.1" optional="true" label="Minimum prevalence" help="The minimum percent of samples for which a feature is detected at minimum abundance"/>
        <param argument="--max_significance" type="float" value="0.25" optional="true" label="Maximum significance" help="The q-value threshold for significance"/>
        <param argument="--normalization" type="select" optional="true" label="The normalization method to apply">
            <option value="TSS" selected="true">TSS</option>
            <option value="CLR">CLR</option>
            <option value="CSS">CSS</option>
            <option value="NONE">NONE</option>
            <option value="TMM">TMM</option>
        </param>
        <param argument="--transform" type="select" optional="true" label="The transform to apply">
            <option value="LOG" selected="true">LOG</option>
            <option value="LOGIT">LOGIT</option>
            <option value="AST">AST</option>
            <option value="NONE">NONE</option>
        </param>
        <param argument="--analysis_method" type="select" optional="true" label="The analysis method to apply">
            <option value="LM" selected="true">LM</option>
            <option value="CPLM">CPLM</option>
            <option value="NEGBIN">NEGBIN</option>
            <option value="ZINB">ZINB</option>
        </param>
        <param argument="--random_effects" type="text" multiple="true" optional="true" label="Random effects" help="The random effects for the model,  comma-delimited for multiple effects"/>
        <param argument="--fixed_effects" type="text" multiple="true" value="all" optional="true" label="Fixed effects" help="The fixed effects for the model,  comma-delimited for multiple effects"/>
        <param argument="--correction" type="text" value="BH" optional="true" label="Correction" help="The correction method for computing  the q-value"/>
        <param argument="--standardize" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true" label="Apply z-score so continuous metadata are on  the same scale"/>
        <section name="output" title="Set Plotting Output" expanded="true">
            <param argument="--plot_heatmap" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true" label="Generate a heatmap for the significant  associations"/>
            <param argument="--heatmap_first_n" type="integer" value="50" optional="true" label="Heatmap plot first N" help="In heatmap, plot top N features with significant associations"/>
            <param argument="--plot_scatter" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true" label="Generate scatter plots for the significant associations"/>    
        </section>   
        <param argument="--cores" type="integer" value="1" optional="true" label="Cores" help="The number of R processes to run in parallel"/>
   </inputs>
   <outputs>    
        <data name="all_results" format="tsv" from_work_dir="outputFolder/all_results.tsv" label="All results ordered by increasing q-value"/>
        <data name="significant_results" format="tsv" from_work_dir="outputFolder/significant_results.tsv" label="q-values smaller than or equal to the threshold"/>
        <collection name="figures_pdfs" type="list" label="Plots" >
            <discover_datasets pattern="(?P&lt;designation&gt;.+)" directory="outputFolder/figures/" format="pdf"/>
            <filter>(output['plot_heatmap'] is True or output['plot_scatter'] is True)</filter>
        </collection>
    </outputs>
    <tests>
    <test expect_num_outputs="3">
        <!--TODO: auto-generated test case. Please fill in the required values-->
        <param name="input_data" value="HMP2_taxonomy.tsv"/>
        <param name="input_metadata" value="HMP2_metadata.tsv"/>
        <param name="min_abundance" value="0"/>
        <param name="min_prevalence" value="0.1"/>
        <param name="max_significance" value="0.25"/>
        <param name="normalization" value="NONE"/>
        <param name="transform" value="AST"/>
        <param name="analysis_method" value="LM"/>
        <param name="random_effects" value="site,subject"/>
        <param name="fixed_effects" value="diagnosis,dysbiosisnonIBD,dysbiosisUC,dysbiosisCD,antibiotics,age"/>
        <param name="correction" value="BH"/>
        <param name="standardize" value="false"/>
        <param name="cores" value="1"/>
        <section name="output">
            <param name="plot_heatmap" value="true"/>
            <param name="heatmap_first_n" value="50"/>
            <param name="plot_scatter" value="true"/>
        </section>
        <output name="all_results">
            <assert_contents>
                <has_text text="feature"/>
                <has_n_lines n="610"/>
                <has_n_columns n="9"/>
            </assert_contents>
        </output>
        <output name="significant_results">
            <assert_contents>
                <has_text text="dysbiosisCD"/>
                <has_n_lines n="202"/>
                <has_n_columns n="9"/>
            </assert_contents>
        </output>
        <output_collection name="figures_pdfs" type="list">
            <element name="heatmap.pdf" ftype="pdf">
                <assert_contents>
                    <has_size value="7491" delta="100" />
                </assert_contents>
            </element>
            <element name="age.pdf" ftype="pdf">
                <assert_contents>
                    <has_size value="836608" delta="1000" />
                </assert_contents>
            </element>
            <element name="antibiotics.pdf" ftype="pdf">
                <assert_contents>
                    <has_size value="3052481" delta="10000" />
                </assert_contents>
            </element>
            <element name="diagnosis.pdf" ftype="pdf">
                <assert_contents>
                    <has_size value="2306867" delta="10000" />
                </assert_contents>
            </element>
            <element name="dysbiosisCD.pdf" ftype="pdf">
                <assert_contents>
                    <has_size value="4581060" delta="10000" />
                </assert_contents>
            </element>
            <element name="dysbiosisnonIBD.pdf" ftype="pdf">
                <assert_contents>
                    <has_size value="2126343" delta="10000" />
                </assert_contents>
            </element>
            <element name="dysbiosisUC.pdf" ftype="pdf">
                <assert_contents>
                    <has_size value="2546741" delta="10000" />
                </assert_contents>
            </element>                                                                        
        </output_collection>
    </test>
    
    </tests>

    <help><![CDATA[
@HELP_HEADER@
MaAsLin 2
=========
MaAsLin2 is the next generation of MaAsLin (Microbiome Multivariable Association with Linear Models).

MaAsLin2 is comprehensive R package for efficiently determining multivariable association between clinical metadata and microbial meta-omics features. 

MaAsLin2 relies on general linear models to accommodate most modern epidemiological study designs, including cross-sectional and longitudinal, along with a variety of filtering, normalization, and transform methods.

Note
====
If running MaAsLin2 as a function, the data and metadata inputs can be of type data.frame instead of a path to a file.

Input
=====
MaAsLin2 requires two input files:

    - Data (or features) file
        - This file is tab-delimited.
        - Formatted with features as columns and samples as rows.
        - The transpose of this format is also okay.
        - Possible features in this file include taxonomy or genes.
    - Metadata file
        - This file is tab-delimited.
        - Formatted with features as columns and samples as rows.
        - The transpose of this format is also okay.
        - Possible metadata in this file include gender or age.

The data file can contain samples not included in the metadata file (along with the reverse case). For both cases, those samples not included in both files will be removed from the analysis. Also the samples do not need to be in the same order in the two files.

Output
======
1- Data output files
    - all_results.tsv
        - This includes the same data as the data.frame returned.
        - This file contains all results ordered by increasing q-value.
        - The first columns are the metadata and feature names.
        - The next two columns are the value and coefficient from the model.
        - The next column is the standard deviation from the model.
        - The N column is the total number of data points.
        - The N.not.zero column is the total of non-zero data points.
        - The pvalue from the calculation is the second to last column.
        - The qvalue is computed with p.adjust with the correction method.
    - significant_results.tsv
        - This file is a subset of the results in the first file.
        - It only includes associations with q-values <= to the threshold.
    - residuals.rds
        - This file contains a data frame with residuals for each feature.
    - fitted.rds
        - This file contains a data frame with fitted values for each feature.
    - ranef.rds
        - This file contains a data frame with extracted random effects for each feature (if random effects are specified).
2- Visualization output files
    - heatmap.pdf
        - This file contains a heatmap of the significant associations.
    - [a-z/0-9]+.pdf
        - A plot is generated for each significant association.
        - Scatter plots are used for continuous metadata.
        - Box plots are for categorical data.
        - Data points plotted are after normalization, filtering, and transform.

    ]]></help> 
    <citations>
        <citation type="doi">10.1101/2021.01.20.427420</citation>
    </citations>
 </tool>