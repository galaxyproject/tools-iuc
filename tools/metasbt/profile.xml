<?xml version="1.0"?>
<tool name="profile" id="metasbt_profile" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@" profile="@PROFILE@" license="MIT">
    <description>genomes with MetaSBT to infer their taxonomic</description>

    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="creator"/>
    <expand macro="requirements"/>

    <command detect_errors="exit_code"><![CDATA[
#set input_dir = "./genomes"

mkdir -p "${input_dir}" &&

#for $genome in $genomes:
    genome_name="\$(echo '${genome.element_identifier}' | sed 's/[^[:alnum:]_.-]/_/g')" &&
    target_fna="${input_dir}/\${genome_name}.fna" &&

    #if $genome.ext.endswith("gz"):
        gzip -dc '${genome}' > "\${target_fna}" &&
    #else
        ln -s '${genome}' "\${target_fna}" &&
    #end if

    echo -e "\${target_fna}" >> "${input_dir}/genomes.txt" &&
#end for

#if $database_selection.source == "cvmfs":
    ln -s '${database_selection.db_tarball.fields.path}' "./MetaSBT-Database.tar.gz" &&
#else:
    ln -s '${database_selection.db_tarball}' "./MetaSBT-Database.tar.gz" &&
#end if

metasbt unpack --workdir "."
               --database "Database"
               --tarball "./MetaSBT-Database.tar.gz" &&

metasbt profile --workdir "."
                --database "Database"
                --genomes "${input_dir}/genomes.txt"
                --uncertainty '${advanced.uncertainty}'
                --pruning-threshold '${advanced.pruning_threshold}'
                --nproc "\${GALAXY_SLOTS:-4}" &&

mkdir -p output

#for $genome in $genomes:
    && genome_name="\$(echo '${genome.element_identifier}' | sed 's/[^[:alnum:]_.-]/_/g')"
    && sed 's/^# *//' "./tmp/profiles/\${genome_name}.txt" > "./output/\${genome_name}.tsv"
#end for
]]></command>

    <inputs>
        <param name="genomes" format="fasta,fasta.gz" multiple="true" type="data"
               label="Input genomes"
               help="Select the genomes to be profiled with MetaSBT." />

        <expand macro="database"/>

        <section name="advanced" expanded="false" title="Advanced options">
            <param name="uncertainty" type="float" value="20.0" min="0.0" max="100.0"
                   label="Uncertainty percentage"
                   help="Include all best hits within this percentage from the top hit." />

            <param name="pruning_threshold" type="float" value="0.0" min="0.0" max="1.0"
                   label="Pruning threshold"
                   help="Filter out paths in the Sequence Bloom Tree below this pruning threshold." />
        </section>
    </inputs>

    <outputs>
        <collection name="profiles" type="list" label="${tool.name} on ${on_string}: taxonomic profiles">
            <discover_datasets pattern="(?P&lt;name&gt;.+)\.tsv" directory="output" ext="tabular" visible="false" />
        </collection>
    </outputs>

    <tests>
        <test>
            <param name="genomes" value="genome_1.fna.gz,genome_2.fna.gz,genome_3.fna.gz,genome_4.fna.gz,genome_5.fna.gz,genome_6.fna.gz" ftype="fasta.gz" />

            <param name="database_selection|source" value="history" />
            <param name="database_selection|db_tarball" ftype="tar" value="MetaSBT-Test-20250620.1.tar.gz" />

            <output_collection name="profiles" type="list" count="6">
                <element name="genome_1.fna.gz" md5="5d8767be213232275a1a8c4e67dcc3dd" ftype="tabular" file="genome_1.tsv" />
                <element name="genome_2.fna.gz" md5="4cd8f7ce75c3f02798acf8df6c538b95" ftype="tabular" file="genome_2.tsv" />
                <element name="genome_3.fna.gz" md5="d6f8e82123f1e5c356e59ddf2b74d12c" ftype="tabular" file="genome_3.tsv" />
                <element name="genome_4.fna.gz" md5="b6a8be2ac5782cb0370b0e5e1cda0f36" ftype="tabular" file="genome_4.tsv" />
                <element name="genome_5.fna.gz" md5="d7cb6465007b0637dd9914ff84a34c95" ftype="tabular" file="genome_5.tsv" />
                <element name="genome_6.fna.gz" md5="63bce914e93753d892ae60215d536122" ftype="tabular" file="genome_6.tsv" />
            </output_collection>
        </test>

        <test>
            <param name="genomes" value="genome_1.fna.gz,genome_2.fna.gz,genome_3.fna.gz,genome_4.fna.gz,genome_5.fna.gz,genome_6.fna.gz" ftype="fasta.gz" />

            <param name="database_selection|source" value="cvmfs" />
            <param name="database_selection|db_tarball" value="test_db" />

            <output_collection name="profiles" type="list" count="6">
                <element name="genome_1.fna.gz" md5="5d8767be213232275a1a8c4e67dcc3dd" ftype="tabular" file="genome_1.tsv" />
                <element name="genome_2.fna.gz" md5="4cd8f7ce75c3f02798acf8df6c538b95" ftype="tabular" file="genome_2.tsv" />
                <element name="genome_3.fna.gz" md5="d6f8e82123f1e5c356e59ddf2b74d12c" ftype="tabular" file="genome_3.tsv" />
                <element name="genome_4.fna.gz" md5="b6a8be2ac5782cb0370b0e5e1cda0f36" ftype="tabular" file="genome_4.tsv" />
                <element name="genome_5.fna.gz" md5="d7cb6465007b0637dd9914ff84a34c95" ftype="tabular" file="genome_5.tsv" />
                <element name="genome_6.fna.gz" md5="63bce914e93753d892ae60215d536122" ftype="tabular" file="genome_6.tsv" />
            </output_collection>
        </test>
    </tests>

    <help>
<![CDATA[
**What it does**

This tool wraps the `profile` subcommand of MetaSBT to infer the closest taxonomic assignments for a set of genomes using a MetaSBT database.

**Input**  
A list of genomes in FASTA or compressed format.

**Output**  
A collection of 3-column tables (level, closest, ANI) per input genome.

Each table reports the most likely taxonomic assignments at different levels (e.g., kingdom, phylum), with their estimated Average Nucleotide Identity (ANI).

-----

.. class:: infomark

Please visit the official GitHub repository_ for additional information about MetaSBT.
Public MetaSBT Databases are available at the official MetaSBT-DBs_ repository.

.. _repository: https://github.com/cumbof/MetaSBT
.. _MetaSBT-DBs: https://github.com/cumbof/MetaSBT-DBs
]]>
    </help>

    <expand macro="citations"/>
</tool>
