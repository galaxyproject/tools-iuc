<tool id="kleborate" name="Kleborate" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>screen genome assemblies of Klebsiella pneumoniae</description>
    <macros>
        <token name="@TOOL_VERSION@">2.2.0</token>
        <token name="@VERSION_SUFFIX@">1</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">kleborate</requirement>
        <requirement type="package" version="2.0.0">kaptive</requirement>
    </requirements>
    <command detect_errors="aggressive"><![CDATA[

## Symlink input files for human-readable names output table'
#for $a in $assemblies
  ln -s '$a' '$a.element_identifier' &&
#end for

kleborate
    $resistance
    -o '$outfile'
    #if $kaptive_k
        $kaptive_k
        --kaptive_k_outfile '$kaptive_k_outfile'
    #end if
    #if $kaptive_o
        $kaptive_o
        --kaptive_o_outfile '$kaptive_o_outfile'
    #end if
    #if $min_identity
        --min_identity $min_identity
    #end if
    #if $min_coverage
        --min_coverage $min_coverage
    #end if
    #if $min_spurious_identity
        --min_spurious_identity $min_spurious_identity
    #end if
    #if $min_spurious_coverage
        --min_spurious_coverage $min_spurious_coverage
    #end if
    --assemblies
    #for $a in $assemblies
    '$a.element_identifier'
    #end for
    1> '$concise'
    ]]></command>

    <inputs>
        <param argument="--assemblies" type="data" format="fasta" multiple="true" label="FASTA file(s) of assemblies" help="you may provide multiple assemblies to screen"/>

        <param argument="--resistance" type="select" label="Turn on resistance genes screening?">
            <option value="" selected="true">no</option>
            <option value="--resistance">yes</option>
        </param>

        <param argument="--kaptive_k" type="boolean" truevalue="--kaptive_k" falsevalue="" checked="false" label="Turn on screening of K loci?" help="Screen for capsule synthesis loci (K-loci) using the 'Kaptive' tool"/>
        <param argument="--kaptive_o" type="boolean" truevalue="--kaptive_o" falsevalue="" checked="false" label="Turn on screening of O loci?" help="Screen for lipopolysaccharide loci (O-loci) using the 'Kaptive' tool" />

        <param argument="--min_identity" type="integer" min="0" max="100" optional="true" label="Minimum alignment percent identity for main results"/>
        <param argument="--min_coverage" type="integer" min="0" max="100" optional="true" label="Minimum alignment percent coverage for main results"/>
        <param argument="--min_spurious_identity" type="integer" min="0" max="100" optional="true" label="Minimum alignment percent identity for spurious results"/>
        <param argument="--min_spurious_coverage" type="integer" min="0" max="100" optional="true" label="Minimum alignment percent coverage for spurious results"/>
    </inputs>

    <outputs>
        <data name="concise" format="tabular" label="${tool.name} on ${on_string}: Concise Results" />
        <data name="outfile" format="tabular" label="${tool.name} on ${on_string}: Full Results" />
        <data name="kaptive_k_outfile" format="tabular" label="${tool.name} on ${on_string}: K-loci screening results" >
            <filter>kaptive_k</filter>
        </data>
        <data name="kaptive_o_outfile" format="tabular" label="${tool.name} on ${on_string}: Kaptive O results" >
            <filter>kaptive_o</filter>
        </data>
    </outputs>

    <tests>
        <test><!-- test with resistance, kaptive k and kaptive o outputs -->
            <param name="assemblies" value="KP011_S63.scfd.fasta,KP012_S64.scfd.fasta" />
            <param name="resistance" value="--resistance"/>
            <param name="kaptive_k" value="--kaptive_k"/>
            <param name="kaptive_o" value="--kaptive_o"/>
            <output name="concise" ftype="tabular" file="Kleborate_concise_results.txt" />
            <output name="outfile" ftype="tabular" file="Kleborate_results.txt" />
            <output name="kaptive_k_outfile" ftype="tabular" file="Kleborate_kaptive_k_results.txt" />
            <output name="kaptive_o_outfile" ftype="tabular" file="Kleborate_kaptive_o_results.txt" />
        </test>
    </tests>

    <help><![CDATA[

Kleborate is a tool to screen genome assemblies of Klebsiella pneumoniae and the Klebsiella pneumoniae species complex (KpSC) for:

- MLST sequence type
- species (e.g. K. pneumoniae, K. quasipneumoniae, K. variicola, etc.)
- ICEKp associated virulence loci: yersiniabactin (ybt), colibactin (clb), salmochelin (iro), hypermucoidy (rmpA)
- virulence plasmid associated loci: salmochelin (iro), aerobactin (iuc), hypermucoidy (rmpA, rmpA2)
- antimicrobial resistance determinants: acquired genes, SNPs, gene truncations and intrinsic Î²-lactamases
- K (capsule) and O antigen (LPS) serotype prediction, via wzi alleles and Kaptive

For Klebsiella species outside of the KpSC, Kleborate will accurately determine the species and will report the presence of any accessory genes detected (AMR, virulence, K & O types); however species-focused markers (mutational resistance, MLST) and divergent forms of the virulence, K and O loci will not be reported.

More information can be found on the Kleborate `wiki`_.

.. _wiki: https://github.com/katholt/Kleborate/wiki

    ]]></help>

    <citations>
        <citation type="doi">10.1038/s41467-021-24448-3</citation> <!-- Kleborate publication -->
        <citation type="doi">10.1099/mgen.0.000102</citation><!-- Kaptive publication -->
    </citations>
</tool>
