<tool id="hicexplorer_hicinterintratad" name="@BINARY@" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>computes the ratio of inter TAD-scores vs. intra TADs</description>
    <macros>
        <token name="@BINARY@">hicInterIntraTAD</token>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        ln -s '$matrix_h5_cooler' 'matrix.$matrix_h5_cooler.ext' &&

       @BINARY@
            --matrix 'matrix.$matrix_h5_cooler.ext'
            --tadDomains $tadDomains

            #if $fontSize:
                --fontSize $fontSize
            #end if

            #if $dpi:
                --dpi $dpi
            #end if

            --outFileName output_interintra.txt
            --outFileNameRatioPlot plot.$image_file_format
            --threads @THREADS@

            && mv plot.$image_file_format plot
            
    ]]>    </command>
    <inputs>
        <expand macro='matrix_h5_cooler_macro' />
        <param name="tadDomains" type="data" format='bed' label="Bed file with TAD domains coordinates" help="Bed file with domains coordinates: instead of evaluating the distance vs. Hi-C counts for intra chromosomal counts, compute it for intra-domains." />

        <expand macro="dpi" />
        <param name="fontSize" type="integer" min="5" optional="True" label="Font size" help="Font size for the plot"/>
        
        <param name="image_file_format" type="select" label="Image output format">
            <option value="png" selected="True">png</option>
            <option value="svg">svg</option>
            <option value="pdf">pdf</option>
        </param>
        
    </inputs>
    <outputs>
       <data name='output_txt' from_work_dir='output_interintra.txt' format='txt' label='Intra Inter TAD ratios'/>

       <data name='output_plot' from_work_dir='plot' format='png' label='Plot SVL'>
            <change_format>
                <when input="image_file_format" value="svg" format="svg" />
                <when input="image_file_format" value="pdf" format="pdf" />
            </change_format>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="matrix_h5_cooler" value="hicInterIntraTAD/matrix.cool" />
            <param name="tadDomains" value="hicInterIntraTAD/untreated_R1_domains_chr1_chr2.bed" />
            
            <output name="output_txt" file="hicInterIntraTAD/output.txt" ftype="txt" />
            
            <output name="output_plot" file="hicInterIntraTAD/plot.png" ftype="png" />
            
        </test>
      
    </tests>
    <help><![CDATA[

Calculate Topologic Associated Domains
======================================

Toplogical domains (TADs) are large mainly self-interacting domains. Chromatin interactions occur with higher frequency within a TAD as between TADs. More information_.

_________________

Usage
-----

This tool must be used on unmerged matrices (restiction enzyme resolution) produced by ``hicBuildMatrix`` and corrected by ``hicCorrectMatrix``.

_________________

Computation details
-------------------

**hicFindTADs** computes the TAD regions in two steps: in a first step it computes a TAD-separation score based on a z-score matrix for all bins. The z-score is defined as:

  “The absolute value of z represents the distance between the raw score and the population mean in
  units of the standard deviation. z is negative when the raw score is below the mean, positive when above.”
  [Source_].

.. image:: $PATH_TO_IMAGES/z-score.svg
   :width: 100

`Source of image <https://wikimedia.org/api/rest_v1/media/math/render/svg/5ceed701c4042bb34618535c9a902ca1a937a351>`_

In our case the distribution describes the counts per bin of a genomic distance. In a second step the local minima of the TAD-separation score is evaluated with respect to the surrounding bins to assign a p-value. Two multiple testing corrections can be applied to filter the results: `Bonferroni <https://en.wikipedia.org/wiki/Bonferroni_correction>`_ or the `false discovery rate <https://en.wikipedia.org/wiki/False_discovery_rate>`_.

_________________

Output
------

**hicFindTADs** produces multiple outputs:

- TAD boundaries positions as a BED file and TAD separation score.
- TAD boundaries positions with delta, p-value and TAD separation score as GFF.
- TAD domains as a BED file.
- TAD seperation score as bigwig (bw), bedgraph and numpy array (npz) format. These files can be used to plot the so-called TAD insulation score or TAD separation score along the genome or at specific regions. This score is much more reliable across samples than the number of TADs or the TADs width that can vary depending on the sequencing depth because of the lack of information at certain bins, and depending on the parameters used with this tool.
- Matrix with multi-scale TAD scores as a bed-matrix (bm) file that can be plotted inside ``pyGenomeTracks`` to nicely display TAD insulation score alongside Hi-C heatmap and other datasets.
- Z-score matrix in h5 format that is useful to quickly test the --thresholdComparisons, --delta and --correctForMultipleTesting parameters by using the --TAD_sep_score_prefix option pointing to this zscore_matrix.h5 file (will be added in a future update).

_________________

Usage hints
-----------

It is mandatory to test multiple parameters of TAD calling with **hicFindTADs** before making conclusions about the number of TADs in a given sample or before comparing TAD calling between multiple conditions. In order to compare numerous TAD calling parameters at once, it is recommended to use ``pyGenomeTracks``, below you can find a plot where multiple TAD calling parameters are displayed for *Drosophila melanogaster* embryos:

.. image:: $PATH_TO_IMAGES/hicFindTADs_TAD_calling_comparison.png
   :width: 65 %

We can see that the fourth set of **hicFindTADs** parameters with a threshold of 0.001 gives the best results in terms of TAD calling compared to the corrected Hi-C counts distribution and compared to the enrichment of H3K36me3, which is known to be enriched at TAD boundaries in *Drosophila melanogaster*.

_________________

For more information about HiCExplorer please consider our documentation on readthedocs.io_

.. _readthedocs.io: http://hicexplorer.readthedocs.io/en/latest/index.html
.. _Source: https://en.wikipedia.org/wiki/Standard_score#Calculation_from_raw_score
.. _information: https://en.wikipedia.org/wiki/Topologically_associating_domain_
]]>    </help>
    <expand macro="citations" />
</tool>
