<tool id="hicexplorer_hicconvertformat" name="@BINARY@" version="@WRAPPER_VERSION@.0">
    <description>Convert between different file formats</description>
    <macros>
        <token name="@BINARY@">hicConvertFormat</token>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[

        @BINARY@ --matrices '$matrix_h5_cooler'

        #if $chromosomes:
                --chromosomes #echo "' '".join([ "'%s'" % $chrom.chromosome for $chrom in $chromosomes ])#
        #end if
        --outputFileName pca1.$outputFormat pca2.$outputFormat
        --format $outputFormat

        #if #norm:
            $norm
        #end if

        #if $geneTrack:
            --geneTrack $geneTrack
        #end if

        #if $pearsonMatrix:
            --pearsonMatrix pearson.cool
        #end if

        #if $obsexpMatrix:
            --obsexpMatrix obsexp.cool
        #end if

        && mv pca1.$outputFormat pca1
        && mv pca2.$outputFormat pca2

]]>
    </command>
    <inputs>
        <conditional name="inputFormat_conditional">
            <param name="inputFormat_selector" type="select" label="Choose input file type">
                <option value="optionCool" selected="True">cool</option>
                <option value="optionH5">h5</option>
                <option value="optionHic">hic</option>
                <option value="optionHomer">Homer</option>
                <option value="optionHicpro">HiCPro</option>
            </param>
            <when value="optionCool">
                <expand macro='matrix_h5_cooler_macro' />
                <param name='correctionName' type='text' label='Correction factors column name'/>
                <param name='correctionDivision' type='text' label='Apply correction factors with a division instead multiplication'/>
                <param name='chromosome' type='text' label='Load only one chromosome'/>
                <param name='loadRawValues' type='text' label='Load raw data'/>

            </when>
            <when value="optionH5">
                <expand macro='matrix_h5_cooler_macro' />
            </when>
            <when value="optionHic">
                <param name='matrixHic' type='data' format='hic' label='.hic matrix'/>
                <param name='resolutions' type='text' label='List of resolutions'/>
            </when>

            <when value="optionHomer">
                <param name='matrixHomer' type='data' format='txt' label='Homer interaction matrix'/>
            </when>

            <when value="optionHicpro">
                <param name='matrixHicpro' type='data' format='txt' label='.hic matrix'/>
                <param name='bedHicpro' type='data' format='bed' label='HicPro bed file'/>
            </when>
        </conditional>

        <conditional name="outputFormat_conditional">
            <param name="outputFormat_selector" type="select" label="Choose output file type">
                <option value="optionCool" selected="True">cool</option>
                <option value="optionH5">h5</option>
                <option value="optionHomer">Homer</option>
                <option value="optionGinteractions">ginteractions</option>
                <option value="optionMcool">mcool</option>

            </param>
            <when value="optionCool">
                <param name='storeAppliedCorrection' type='text' label='Store applied correction factors in column count'/>
                <param name='enforceInteger' type='text' label='Enforce integer for count column'/>

            </when>
            <when value="optionMCool">
                <param name='resolutions' type='text' label='To be stored resolutions'/>
                <param name='storeAppliedCorrection' type='text' label='Store applied correction factors in column count'/>
                <param name='enforceInteger' type='text' label='Enforce integer for count column'/>
            </when>
            
        </conditional>
       
    </inputs>
    <outputs>

        <data name="pca1" from_work_dir="pca1" format="bigwig" label="${tool.name} on ${matrix_h5_cooler.name} [${on_string}]: PC1">
            <filter>outputFormat == 'bigwig'</filter>
            <change_format>
                <when input="outputFormat" value="bedgraph" format="bedgraph" />
            </change_format>
        </data>
        <data name="pca2" from_work_dir="pca2" format="bigwig"  label="${tool.name} on ${matrix_h5_cooler.name} [${on_string}]: PC2">
            <change_format>
                <when input="outputFormat" value="bedgraph" format="bedgraph" />
            </change_format>
        </data>

        <data name="pearson_outfile" from_work_dir="pearson.cool" format="cool">
            <filter>pearsonMatrix</filter>
        </data>
        <data name="obsexp_outfile" from_work_dir="obsexp.cool" format="cool">
            <filter>obsexpMatrix</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="matrix_h5_cooler" value="small_test_matrix_50kb_res.h5"/>
            <param name="outputFormat" value="bedgraph" />
            <output name="pca1" file="pca1.bedgraph" ftype="bedgraph" compare="sim_size"/>
            <output name="pca2" file="pca2.bedgraph" ftype="bedgraph" compare="sim_size"/>
        </test>
        <test>
            <param name="matrix_h5_cooler" value="small_test_matrix_50kb_res.h5"/>

            <param name="outputFormat" value="bigwig" />
            <output name="pca1" file="pca1.bw" ftype="bigwig" compare="sim_size"/>
            <output name="pca2" file="pca2.bw" ftype="bigwig" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
Principal component analysis
============================

`Lieberman-Aiden et al. (2009)`_ demonstrated that open and closed chromatin domains throughout the genome occupy different spatial compartments in the nucleus, defined as A (activate) and B (inactive) compartments.

**hicPCA** computes two eigenvector files based on the input matrix for an A / B compartment analysis following the computation steps detailed by `Lieberman-Aiden et al. (2009)`_: the transformation of the contact matrix
into an observed vs. expected matrix and consecutively a Pearson correlation matrix shows a plaid pattern. These plaid pattern are called A and B. Applying a PCA on the Pearson correlation matrix gives the eigenvectors
and Lieberman-Aiden shows that the values of the eigenvectors correspond to the distribution of genes and with features of open and closed chromatin. In some cases the first principal component corresponds to the two
chromosomes arms and the second eigenvector to the plaid pattern. Therefore always the first two principal components needs to be returned and investigated.

_________________

Usage
-----

This tool must be used on Hi-C contact matrices with large bins (over 20kb) using ``hicMergeMatrixBins`` and corrected with ``hicCorrectMatrix``. Using matrices with a too high resolution (small bins or at restriction enzyme resolution) might take several days to run (even with over 100 CPU) or will fail due to memory limitations.

_________________

Output
------
Two files are outputed by **hicPCA**, one with the first (pca1) and one with the second (pca2) eigenvector as bigwig or bedgraph. These files can be plotted alongside Hi-C heatmaps, gene density or external datasets such as open chromatin or histone marks enrichment using ``hicPlotTADs`` or ``hicPlotMatrix``.

For example, below you can find a ``hicPlotMatrix`` of the Pearson correlation matrix derived from a contact matrix for chromosome 6 in mouse computed with ``hicTransform`` (which is part of A/B compartments computation). The optional data track at the bottom shows the first eigenvector for A/B compartment obtained using **hicPCA**.

.. image:: $PATH_TO_IMAGES/hicPCA.png
   :scale: 35 %

_________________

| For more information about HiCExplorer please consider our documentation on readthedocs.io_

.. _readthedocs.io: http://hicexplorer.readthedocs.io/en/latest/index.html
.. _`Lieberman-Aiden et al. (2009)`: https://doi.org/10.1126%2Fscience.1181369
]]></help>
    <expand macro="citations" />
</tool>
