<tool id="hicexplorer_chicplotviewpoint" name="@BINARY@" version="@WRAPPER_VERSION@.0">
    <description>creates plots for viewpoints.</description>
    <macros>
        <token name="@BINARY@">chicPlotViewpoint</token>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        mkdir interactionFiles &&
        mkdir differentialFolder &&
        mkdir significantFolder &&


        #for $file in $interactionFiles:
            ln -s '$file' interactionFiles/${file.name} &&
        #end for

        #for $file in $differentialFiles:
            ln -s '$file' differentialFolder/${file.name} &&
        #end for

        #for $file in $significantFiles:
            ln -s '$file' significantFolder/${file.name} &&
        #end for

        #if $batchmode_conditional.batchmode_selector == 'optionSinglemode':
            #set $interactonfileslist = ' '.join([ 'interactionFiles/%s' % $file.name for $file in $interactionFiles ])
            #set $differentialfileslist = ' '.join([ 'differentialFolder/%s' % $file.name for $file in $differentialFiles ])
            #set $significantfileslist = ' '.join([ 'significantFolder/%s' % $file.name for $file in $significantFiles ])
        
        #end if

        @BINARY@
            #if $batchmode_conditional.batchmode_selector == 'optionSinglemode':
                --interactionFile $interactonfileslist
                #if $differentialFiles:
                    --differentialTestResult $differentialfileslist
                #end if

                #if $significantFiles:
                    --significantInteractions $significantfileslist 
                #end if
            #else:
                --interactionFile $batchmode_conditional.interactionFilesOrderFile
                --interactionFileFolder interactionFiles
                #if $batchmode_conditional.differentialFilesOrderFile:
                    --differentialTestResult $batchmode_conditional.differentialFilesOrderFile
                #end if
                #if $batchmode_conditional.significantInteractionFilesOrderFile:
                    --significantInteractions $batchmode_conditional.significantInteractionFilesOrderFile
                #end if

                --batchMode
            #end if

            --range $rangeUpstream $rangeDownstream
            --backgroundModelFile $backgroundModelFile

            #if $dpi:
                --dpi $dpi
            #end if 

            --outputFormat $image_file_format
            #if $maxPValue:
                --maxPValue $maxPValue
            #end if

            #if $minPValue:
                --minPValue $minPValue
            #end if
            --threads @THREADS@
    ]]></command>
    <inputs>
        <param name='interactionFiles' type="data" format="tabular" label="Interaction files" multiple="true"/>
        <param name='differentialFiles' type="data" format="tabular" label="Interaction files" multiple="true"/>
        <param name='significantFiles' type="data" format="tabular" label="Interaction files" multiple="true"/>
        
        <param name="rangeUpstream" type="integer" value="500000"  label="Upstream range" help='Defines the region upstream of a reference point which should be considered in the analysis.' />
        <param name="rangeDownstream" type="integer" value="500000"  label="Downstream range" help='Defines the region upstream of a reference point which should be considered in the analysis.' />   
        <param argument="--backgroundModelFile" type="data" format='tabular'
                        label="Background model"
                        help="The background file computed by chicViewpointBackgroundModel" />
     
        <conditional name="batchmode_conditional">
            <param name="batchmode_selector" type="select" label="Compute files individually or in batch mode">
                <option value="optionBatchmode">Batch processing</option>
                <option value="optionSinglemode" selected="True">Single file processing</option>
            </param>
            <when value="optionBatchmode">
                <param name='interactionFilesOrderFile' type="data" format="tabular" label="Interaction file order"/> 
                <param name='differentialFilesOrderFile' type="data" format="tabular" label="Interaction file order"/>
                <param name='significantInteractionFilesOrderFile' type="data" format="tabular" label="Significant file order"/>

            </when>
            <when value="optionSinglemode">              
            </when>
        </conditional>
        <param argument="--maxPValue" type="float" optional="true" label="max p-value" help="Maximum value of the plotted p-value."/>
        <param argument="--minPValue" type="float" optional="true" label="min p-value" help="Minimum value of the plotted p-value."/>

        <param name="image_file_format" type="select" label="Image output format">
            <option value="png" selected="True">png</option>
            <option value="svg">svg</option>
            <option value="pdf">pdf</option>
        </param>
        <param name='dpi' type='integer' label='DPI for image' help='Change the default resolution of the plot.' optional='true'/>
    
    </inputs>
    <outputs>
        <collection name="differentialFolderCollection" type="list" label="Differential test files">
            <discover_datasets pattern="__name_and_ext__" directory="differentialFolder" />
        </collection>
        <data name="rejectedFileNames" from_work_dir="rejected_H0.txt" format="txt" label="${tool.name} rejected H0">
            <filter>batchmode_conditional.batchmode_selector == 'optionBatchmode'</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="interactionFiles" value="cHi-C/chicAggregateStatistic/batch_mode/FL-E13-5_chr1_chr1_14300280_14300280_Eya1_aggregated.bed,cHi-C/chicAggregateStatistic/batch_mode/MB-E10-5_chr1_chr1_14300280_14300280_Eya1_aggregated.bed,cHi-C/chicAggregateStatistic/batch_mode/FL-E13-5_chr1_chr1_4487435_4487435_Sox17_aggregated.bed,cHi-C/chicAggregateStatistic/batch_mode/MB-E10-5_chr1_chr1_4487435_4487435_Sox17_aggregated.bed,cHi-C/chicAggregateStatistic/batch_mode/FL-E13-5_chr1_chr1_19093103_19093103_Tfap2d_aggregated.bed,cHi-C/chicAggregateStatistic/batch_mode/MB-E10-5_chr1_chr1_19093103_19093103_Tfap2d_aggregated.bed"/>
            
            <conditional name="batchmode_conditional">
                <param name="batchmode_selector" value='optionBatchmode'/>
                <param name="interactionFilesOrderFile" value='cHi-C/chicAggregateStatistic/batch_mode_file_names.txt'/>
            </conditional>
            <param name="statisticTest_selector" value='chi2'/>
            <param name="alpha" value='0.5'/>
            <output_collection name="differentialFolderCollection" type="list" count="9">
                <element name="FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_H0_accepted" file="cHi-C/chicDifferentialTest/batch_mode_chi2/FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_H0_accepted.bed" ftype="bed" lines_diff="4"/>
                <element name="FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_H0_rejected" file="cHi-C/chicDifferentialTest/batch_mode_chi2/FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_H0_rejected.bed" ftype="bed" lines_diff="4"/>
                <element name="FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_results" file="cHi-C/chicDifferentialTest/batch_mode_chi2/FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_results.bed" ftype="bed" lines_diff="4"/>


                <element name="FL-E13-5_MB-E10-5_chr1_chr1_19093103_19093103_Tfap2d_H0_accepted" file="cHi-C/chicDifferentialTest/batch_mode_chi2/FL-E13-5_MB-E10-5_chr1_chr1_19093103_19093103_Tfap2d_H0_accepted.bed" ftype="bed" lines_diff="4"/>
                <element name="FL-E13-5_MB-E10-5_chr1_chr1_19093103_19093103_Tfap2d_H0_rejected" file="cHi-C/chicDifferentialTest/batch_mode_chi2/FL-E13-5_MB-E10-5_chr1_chr1_19093103_19093103_Tfap2d_H0_rejected.bed" ftype="bed" lines_diff="4"/>
                <element name="FL-E13-5_MB-E10-5_chr1_chr1_19093103_19093103_Tfap2d_results" file="cHi-C/chicDifferentialTest/batch_mode_chi2/FL-E13-5_MB-E10-5_chr1_chr1_19093103_19093103_Tfap2d_results.bed" ftype="bed" lines_diff="4"/>
               
                <element name="FL-E13-5_MB-E10-5_chr1_chr1_4487435_4487435_Sox17_H0_accepted" file="cHi-C/chicDifferentialTest/batch_mode_chi2/FL-E13-5_MB-E10-5_chr1_chr1_4487435_4487435_Sox17_H0_accepted.bed" ftype="bed" lines_diff="4"/>
                <element name="FL-E13-5_MB-E10-5_chr1_chr1_4487435_4487435_Sox17_H0_rejected" file="cHi-C/chicDifferentialTest/batch_mode_chi2/FL-E13-5_MB-E10-5_chr1_chr1_4487435_4487435_Sox17_H0_rejected.bed" ftype="bed" lines_diff="4"/>
                <element name="FL-E13-5_MB-E10-5_chr1_chr1_4487435_4487435_Sox17_results" file="cHi-C/chicDifferentialTest/batch_mode_chi2/FL-E13-5_MB-E10-5_chr1_chr1_4487435_4487435_Sox17_results.bed" ftype="bed" lines_diff="4"/>
            
            </output_collection>

            <output name="rejectedFileNames" file="cHi-C/chicDifferentialTest/rejectedFilesList.txt" ftype="txt" compare="sim_size" delta='40000'/>
        </test>
        <test>
            <param name="interactionFiles" value="cHi-C/chicAggregateStatistic/batch_mode/FL-E13-5_chr1_chr1_14300280_14300280_Eya1_aggregated.bed,cHi-C/chicAggregateStatistic/batch_mode/MB-E10-5_chr1_chr1_14300280_14300280_Eya1_aggregated.bed"/>
            
            <conditional name="batchmode_conditional">
                <param name="batchmode_selector" value='optionSinglemode'/>
            </conditional>
            <param name="statisticTest_selector" value='fisher'/>
            <param name="alpha" value='0.5'/>

            <output_collection name="differentialFolderCollection" type="list" count="3">
                <element name="FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_H0_accepted" file="cHi-C/chicDifferentialTest/regular_mode_fisher/FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_H0_accepted.bed" ftype="bed" lines_diff="4"/>
                <element name="FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_H0_rejected" file="cHi-C/chicDifferentialTest/regular_mode_fisher/FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_H0_rejected.bed" ftype="bed" lines_diff="4"/>
                <element name="FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_results" file="cHi-C/chicDifferentialTest/regular_mode_fisher/FL-E13-5_MB-E10-5_chr1_chr1_14300280_14300280_Eya1_results.bed" ftype="bed" lines_diff="4"/>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[

Differential testing of two viewpoints
======================================

chicDifferentialTest tests if two locations under consideration of the reference point have a different interaction count. For this either Fisher's test or chi2 contingency test can be used.
The files that are accepted for this test can be created with `chicAggregateStatistic`. H0 is assuming the interactions are not different. Therefore the differential interaction counts are all where H0 was rejected.


For more information about HiCExplorer please consider our documentation on readthedocs.io_

.. _readthedocs.io: http://hicexplorer.readthedocs.io/en/latest/index.html
]]></help>
    <expand macro="citations" />
</tool>
