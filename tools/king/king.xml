<?xml version="1.0" encoding="utf-8"?>
<tool id="king" name="KING" version="@VERSION+0">
    <description>Kinship-based INference for Gwas alias KING is a sequencing project</description>
    <macros>
	<token name="@VERSION">2.2.4</token>
    </macros>
    <requirements>
	<requirement type="package" version="@VERSION">king</requirement>
    </requirements>
    <version_command>
	king | head -1 | cut -d' ' -f 2
    </version_command>
    <command detect_errors="exit_code"><![CDATA[
    ln -s '$genotype' input.bed &&
    ln -s '$family' input.fam &&
    ln -s '$map' input.bim &&
    
    king -b input.bed --fam input.fam --bim input.bim

    '$related'

    '$duplicate'

    '$kinship'

    '$ibdseg'

    '$ibs'

    '$homog'

    #if $degree
    --degree $degree
    #end if

    #if $projection
    --projection $projection
    #end if

    '$unrelated'

    '$build'

    '$cluster'

    '$rplot'
    
    > '$kingoutput'
    ]]></command>
    <inputs>
	<param name="genotype" type="data" format="pbed" help="Binary genotype File" />
	<param name="family" type="data" format="lped" help="Family File" />
	<param name="map" type="data" format="tabular" help="Map File" />
	<!-- Beginning of the optional paramters -->
	<param argument="related" type="boolean" truevalue="--related" falsevalue="" label="Relatedness" />
	<param name="duplicate" type="boolean" truevalue="--duplicate" falsevalue="" label="Duplicates" />
	<param name="kinship" type="boolean" truevalue="--kinship" falsevalue="" label="Kinship" />
	<param name="ibdseg" type="boolean" truevalue="--ibdseg" falsevalue="" label="IBDSeg" />
	<param name="ibs" type="boolean" truevalue="--ibs" falsevalue="" label="IBS" />
	<param name="homog" type="boolean" truevalue="--homog" falsevalue="" label="Homog" />
	<param name="degree" type="integer" min="0" optional="true" label="Degree" />
	<param name="projection" type="integer" min="0" optional="true" label="Projection" />
	<param name="unrelated" type="boolean" truevalue="--unrelated" falsevalue="" label="Unrelated" />
	<param name="build" type="boolean" truevalue="--build" falsevalue="" label="Build" />
	<param name="cluster" type="boolean" truevalue="--cluster" falsevalue="" label="Cluster" />
	<param name="rplot" type="boolean" truevalue="--rplot" falsevalue="" label="Plot" />
    </inputs>
    <outputs>
	<data name="kingoutput" format="txt" />
    </outputs>
    <tests>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="related" value="true" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB"/>
		<has_text text="Information of these chromosomal segments can be found in file kingallsegs.txt" />
		<has_text text="--related" />
		<has_text text="Relationship summary (total relatives: 200 by pedigree, 200 by inference)" />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="related" value="true" />
	    <param name="degree" value="2" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB"/>
		<has_text text="Information of these chromosomal segments can be found in file kingallsegs.txt" />
		<has_text text="--related" />
		<has_text text="--degree 2" />
		<has_text text="Relationship summary (total relatives: 0 by pedigree, 7 by inference)" />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="related" value="true" />
	    <param name="degree" value="2" />
	    <param name="rplot" value="true" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="Autosome genotypes stored in 286 words for each of 332 individuals."/>
		<has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB" />
		<has_text text="--related" />
		<has_text text="--degree 2" />
		<has_text text="--rplot" />
		<has_text text="(with 18290 SNPs): 10 pairs of relatives are detected (with kinship > 0.0625)" />
		<has_text text="Relationship summary (total relatives: 0 by pedigree, 7 by inference)" />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="duplicate" value="true" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="Autosome genotypes stored in 286 words for each of 332 individuals."/>
		<has_text text="--duplicate" />
		<has_text text="No duplicates are found with heterozygote concordance rate > 80%." />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="kinship" value="true" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="Autosome genotypes stored in 286 words for each of 332 individuals."/>
		<has_text text="--kinship" />
		<has_text text="Relationship summary (total relatives: 200 by pedigree, 200 by inference)" />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="related" value="true" />
	    <param name="projection" value="100000" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="Autosome genotypes stored in 286 words for each of 332 individuals."/>
		<has_text text="--related" />
		<has_text text="Relationship summary (total relatives: 200 by pedigree, 200 by inference)" />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="ibdseg" value="true" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="--ibdseg" />
		<has_text text="Individual pairs with no long IBD segments (>10Mb) are excluded." />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="ibdseg" value="true" />
	    <param name="degree" value="3" />
	    <param name="rplot" value="true" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="--ibdseg" />
		<has_text text="--rplot" />
		<has_text text="--degree 3" />
		<has_text text="Individual pairs with no long IBD segments (>10Mb) are excluded." />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="ibs" value="true" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="Autosome genotypes stored in 286 words for each of 332 individuals." />
		<has_text text="--ibs" />
		<has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
		<has_text text="Within-family IBS data saved in file king.ibs" />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="homog" value="true" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="Autosome genotypes stored in 1144 words for each of 332 individuals." />
		<has_text text="--homo" />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="unrelated" value="true" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="--unrelated" />
		<has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
		<has_text text="Y028,Y117" />
		<has_text text="An alternative list of 108 to-be-removed individuals saved in file kingunrelated_toberemoved.txt" />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="unrelated" value="true" />
	    <param name="degree" value="2" />
	    <output name="kingoutput" >
	    <assert_contents>
		<has_text text="--unrelated" />
		<has_text text="--degree 2" />
		<has_text text="Autosome genotypes stored in 286 words for each of 332 individuals." />
		<has_text text="An alternative list of 108 to-be-removed individuals saved in file kingunrelated_toberemoved.txt" />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="build" value="true" />
	    <output name="kingoutput" >
	    <assert_contents>
		<has_text text="--build" />
		<has_text text="Autosome genotypes stored in 286 words for each of 332 individuals." />
		<has_text text="Update-ID information is saved in file kingupdateids.txt" />
		<has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="build" value="true" />
	    <param name="degree" value="2" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="--build" />
		<has_text text="--degree 2" />
		<has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
		<has_text text="Update-parent information is saved in file kingupdateparents.txt" />
	    </assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="cluster" value="true" />
	    <output name="kingoutput">
	    <assert_contents>
		<has_text text="--cluster" />
		<has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
		<has_text text="Pair-wise relatedness in newly clustered families saved in kingcluster.kin." />
	    </assert_contents>
	    </output>
	</test>
    </tests>
	    <help><![CDATA[`KING is a toolset that makes use of high-throughput SNP data typically seen in a genome-wide association study (GWAS) or a sequencing project. Applications of KING include family relationship inference and pedigree error checking, quality control, population substructure identification, forensics, gene mapping, etc. <http://people.virginia.edu/~wc9c/KING/>`_]]></help>
    <citations>
	<citation type="doi">10.1093/bioinformatics/btq559</citation>
    </citations>
</tool>
