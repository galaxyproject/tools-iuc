<?xml version="1.0" encoding="utf-8"?>
<tool id="king" name="KING" version="@VERSION+0">
    <description>Kinship-based INference for Gwas alias KING</description>
    <macros>
        <token name="@VERSION">2.2.4</token>
    </macros>
    <requirements>
        <requirement type="package" version="@VERSION">king</requirement>
	<requirement type="package" version="1.6.4">r-kinship2</requirement>
	<requirement type="package" version="1.2.2">r-igraph</requirement>
    </requirements>
    <version_command>
        king | head -1 | cut -d' ' -f 2
    </version_command>
    <command detect_errors="exit_code"><![CDATA[
    ln -s '$genotype' input.bed &&
    ln -s '$family' input.fam &&
    ln -s '$map' input.bim &&
    
    king -b input.bed --fam input.fam --bim input.bim
    $related
    $duplicate
    $kinship
    $ibdseg
    $ibs
    $homog
    #if str($degree):
        --degree $degree
    #end if
    #if str($projection):
        --projection $projection
    #end if
    $unrelated
    $build
    $cluster
    $rplot
    
    > '$kingoutput'
    ]]></command>
    <inputs>
        <param name="genotype" type="data" format="pbed" label="Binary Genotype File" />
        <param name="family" type="data" format="lped" label="Family File" />
        <param name="map" type="data" format="tabular" label="Map File" />
        <!-- Beginning of the optional paramters -->
        <param argument="--related" type="boolean" truevalue="--related" falsevalue="" label="Relationship Inference" help="Implements the fastest and integrated relationship inference." />
        <param argument="--duplicate" type="boolean" truevalue="--duplicate" falsevalue="" label="Duplicate Analysis" help="Implements the fastest (and accurate) algorithm to identify duplicates or MZ twins" />
        <param argument="--kinship" type="boolean" truevalue="--kinship" falsevalue="" label="Kinship Inference" help="Estimates pair-wise kinship coefficients" />
        <param argument="--ibdseg" type="boolean" truevalue="--ibdseg" falsevalue="" label="IBD Segment Analysis" help="IBD segment analysis determines all IBD (IBD1 and IBD2) segments shared between relatives" />
        <param argument="--ibs" type="boolean" truevalue="--ibs" falsevalue="" label="IBS Summary Statistics" help="Counts and average of IBS" />
        <param argument="--homog" type="boolean" truevalue="--homog" falsevalue="" label="Homogeneous Population" help="Estimates pair-wise kinship coefficients assuming a homogeneous population." />
        <param argument="--degree" type="integer" min="0" optional="true" label="Degrees of relatedness" help="Filters relative pairs based on kinship coefficients." />
        <param argument="--projection" type="integer" min="0" optional="true" label="Projection N" help="Includes the first N samples of a subset." />
        <param argument="--unrelated" type="boolean" truevalue="--unrelated" falsevalue="" label="Unrelated Option" help="Extract a list of unrelated individuals." />
        <param argument="--build" type="boolean" truevalue="--build" falsevalue="" label="Reconstruct Pedigree" help="Reconstructs pedigrees using SNP data" />
        <param argument="--cluster" type="boolean" truevalue="--cluster" falsevalue="" label="Cluster Parameter" help="Clusters relatives into families by generating an updateid file." />
        <param argument="--rplot" type="boolean" truevalue="--rplot" falsevalue="" label="R Code and Plots" help="Generates R code first and then calls R program to make plots in a PDF file." />
    </inputs>
    <outputs>
        <data format="txt" name="kingoutput">
	    <discover_datasets pattern="(?P&lt;designation&gt;.+)\.seg" format="tabular" visible="true" />
	    <discover_datasets pattern="(?P&lt;designation&gt;.+)\.ibs" format="tabular" visible="true" />
	    <discover_datasets pattern="(?P&lt;designation&gt;([A-Z-])\w+)\.ibs0" format="tabular" visible="true" />
	    <discover_datasets pattern="(?P&lt;designation&gt;.+)\.kin" format="tabular" visible="true" />
	    <discover_datasets pattern="(?P&lt;designation&gt;([A-Z-])\w+)\.kin0" format="tabular" visible="true" />
	    <discover_datasets pattern="__designation_and_ext__" format="pdf" visible="true" />
	    <discover_datasets pattern="(?P&lt;designation&gt;.+)\.R" format="tabular" visible="true" />
	</data>
    </outputs>
    <tests>
        <test>
            <param name="genotype" value="ex.bed"/>
            <param name="family" value="ex.fam"/>
            <param name="map" value="ex.bim"/>
            <param name="related" value="true" />
            <output name="kingoutput">
                <assert_contents>
                    <has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB"/>
                    <has_text text="Information of these chromosomal segments can be found in file kingallsegs.txt" />
                    <has_text text="--related" />
                    <has_text text="Relationship summary (total relatives: 200 by pedigree, 200 by inference)" />
                </assert_contents>
		<discovered_dataset designation="kingoutput" ftype="tabular">
		    <assert_contents>
			<has_line line="--related" />
			<has_line line="Within-family kinship data saved in file king.kin" />
		    </assert_contents>
		</discovered_dataset>
		<discovered_dataset designation="kingresult" ftype="tabular">
		    <assert_contents>
			<has_line line="Specifying '--degree 2' if a higher degree relationship inference is needed." />
			<has_line line="Relationship summary (total relatives: 0 by pedigree, 2 by inference)" />
		    </assert_contents>
		</discovered_dataset>
            </output>
        </test>
        <test>
            <param name="genotype" value="ex.bed"/>
            <param name="family" value="ex.fam"/>
            <param name="map" value="ex.bim"/>
            <param name="related" value="true" />
            <param name="degree" value="2" />
            <output name="kingoutput">
                <assert_contents>
                    <has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB"/>
                    <has_text text="Information of these chromosomal segments can be found in file kingallsegs.txt" />
                    <has_text text="--related" />
                    <has_text text="--degree 2" />
                    <has_text text="Relationship summary (total relatives: 0 by pedigree, 7 by inference)" />
                </assert_contents>
		<discovered_dataset designation="kingoutput" ftype="tabular">
		    <assert_contents>
			<has_line line="--related" />
			<has_line line="--degree 2" />
		    </assert_contents>
		</discovered_dataset>
		<discovered_dataset designation="kingresult" ftype="tabular">
		    <assert_contents>
			<has_line line="Relationship summary (total relatives: 200 by pedigree, 200 by inference)" />
			<has_line line="Relationship summary (total relatives: 0 by pedigree, 7 by inference)" />
		    </assert_contents>
		</discovered_dataset>
            </output>
        </test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="related" value="true" />
	    <param name="degree" value="2" />
	    <param name="rplot" value="true" />
	    <output name="kingoutput">
		<assert_contents>
		    <has_text text="Autosome genotypes stored in 286 words for each of 332 individuals."/>
		    <has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB" />
		    <has_text text="--related" />
		    <has_text text="--degree 2" />
		    <has_text text="--rplot" />
		    <has_text text="(with 18290 SNPs): 10 pairs of relatives are detected (with kinship > 0.0625)" />
		    <has_text text="Relationship summary (total relatives: 0 by pedigree, 7 by inference)" />
		</assert_contents>
		<discovered_dataset designation="kingoutput" ftype="tabular">
		    <assert_contents>
			<has_line line="--related" />
			<has_line line="--degree 2" />
			<has_line line="--rplot" />
		    </assert_contents>
		</discovered_dataset>
		<discovered_dataset designation="kingresult" ftype="tabular">
		    <assert_contents>
			<has_line line="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
			<has_line line="Information of these chromosomal segments can be found in file kingallsegs.txt" />
		    </assert_contents>
		</discovered_dataset>
		<discovered_dataset designation="kingreport" ftype="pdf" />
		<discovered_dataset designation="kingplot" ftype="txt">
		    <assert_contents>
			<has_line line="Relationship plot is generated in king_relplot.pdf" />
			<has_line line="MI error plots are generated in king_MIerrorplot.pdf" />
			<has_line line="Unique family plot is generated in king_uniqfam0plot.pdf" />
		    </assert_contents>
		</discovered_dataset>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="duplicate" value="true" />
	    <output name="kingoutput">
		<assert_contents>
		    <has_text text="Autosome genotypes stored in 286 words for each of 332 individuals."/>
		    <has_text text="--duplicate" />
		    <has_text text="No duplicates are found with heterozygote concordance rate > 80%." />
		</assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="kinship" value="true" />
	    <output name="kingoutput">
		<assert_contents>
		    <has_text text="Autosome genotypes stored in 286 words for each of 332 individuals."/>
		    <has_text text="--kinship" />
		    <has_text text="Relationship summary (total relatives: 200 by pedigree, 200 by inference)" />
		</assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="related" value="true" />
	    <param name="projection" value="100000" />
	    <output name="kingoutput">
		<assert_contents>
		    <has_text text="Autosome genotypes stored in 286 words for each of 332 individuals."/>
		    <has_text text="--related" />
		    <has_text text="Relationship summary (total relatives: 200 by pedigree, 200 by inference)" />
		</assert_contents>
		<discovered_dataset designation="kingoutput" ftype="tabular">
		    <assert_contents>
			<has_line line="PLINK pedigrees loaded: 332 samples" />
			<has_line line="PLINK maps loaded: 18290 SNPs" />
			<has_line line="Autosome genotypes stored in 286 words for each of 332 individuals." />
		    </assert_contents>
		</discovered_dataset>
		<discovered_dataset designation="kingresult" ftype="tabular">
		    <assert_contents>
			<has_line line="--related" />
			<has_line line="Within-family kinship data saved in file king.kin" />
			<has_line line="Relationship summary (total relatives: 200 by pedigree, 200 by inference)" />
			<has_line line="Specifying '--degree 2' if a higher degree relationship inference is needed." />
		    </assert_contents>
		</discovered_dataset>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="ibdseg" value="true" />
	    <output name="kingoutput">
		<assert_contents>
		    <has_text text="--ibdseg" />
		    <has_text text="Individual pairs with no long IBD segments (>10Mb) are excluded." />
		</assert_contents>
		<discovered_dataset designation="kingoutput" ftype="tabular">
		    <assert_contents>
			<has_line line="--ibdseg" />
			<has_line line="IBD segments saved in a gzipped file king.segments.gz" />
			<has_line line="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
		    </assert_contents>
		</discovered_dataset>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="ibdseg" value="true" />
	    <param name="degree" value="3" />
	    <param name="rplot" value="true" />
	    <output name="kingoutput">
		<assert_contents>
		    <has_text text="--ibdseg" />
		    <has_text text="--rplot" />
		    <has_text text="--degree 3" />
		    <has_text text="Individual pairs with no long IBD segments (>10Mb) are excluded." />
		</assert_contents>
		<discovered_dataset designation="kingoutput" ftype="tabular">
		    <assert_contents>
			<has_line line="--ibdseg" />
			<has_line line="--degree 3" />
			<has_line line="--rplot" />
		    </assert_contents>
		</discovered_dataset>
		<discovered_dataset designation="kingreport" ftype="pdf">
		    <assert_contents>
			<has_line line="king_ibd1vsibd2.pdf" />
			<has_line line="king_uniqfamplot.pdf" />
		    </assert_contents>
		</discovered_dataset>
		<discovered_dataset designation="kingplot" ftype="txt">
		    <assert_contents>
			<has_line line="Summary statistics of IBD segments for individual pairs saved in file king.seg" />
			<has_line line="IBD segments saved in a gzipped file king.segments.gz" />
		    </assert_contents>
		</discovered_dataset>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="ibs" value="true" />
	    <output name="kingoutput">
		<assert_contents>
		    <has_text text="Autosome genotypes stored in 286 words for each of 332 individuals." />
		    <has_text text="--ibs" />
		    <has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
		    <has_text text="Within-family IBS data saved in file king.ibs" />
		</assert_contents>
		<discovered_dataset designation="kingoutput" ftype="tabular">
		    <assert_contents>
			<has_line line="--ibs" />
			<has_line line="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
			<has_line line="Information of these chromosomal segments can be found in file kingallsegs.txt" />
		    </assert_contents>
		</discovered_dataset>
		<discovered_dataset designation="kingresult" ftype="tabular">
		    <assert_contents>
			<has_line line="Between-family IBS data saved in file king.ibs0" />
			<has_line line="Relationship summary (total relatives: 200 by pedigree, 200 by inference)" />
		    </assert_contents>
		</discovered_dataset>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="homog" value="true" />
	    <output name="kingoutput">
		<assert_contents>
		    <has_text text="Autosome genotypes stored in 1144 words for each of 332 individuals." />
		    <has_text text="--homo" />
		</assert_contents>
		<discovered_dataset designation="kingoutput" ftype="tabular">
		    <assert_contents>
			<has_line line="--homo" />
			<has_line line="Within-family kinship data saved in file king.kin" />
		    </assert_contents>
		</discovered_dataset>
		<discovered_dataset designation="kingresult" ftype="tabular">
		    <assert_contents>
			<has_line line="Genotype data consist of 18290 autosome SNPs" />
			<has_line line="IBD segments saved in a gzipped file king.segments.gz" />
		    </assert_contents>
		</discovered_dataset>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="unrelated" value="true" />
	    <output name="kingoutput">
		<assert_contents>
		    <has_text text="--unrelated" />
		    <has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
		    <has_text text="Y028,Y117" />
		    <has_text text="An alternative list of 108 to-be-removed individuals saved in file kingunrelated_toberemoved.txt" />
		</assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="unrelated" value="true" />
	    <param name="degree" value="2" />
	    <output name="kingoutput" >
		<assert_contents>
		    <has_text text="--unrelated" />
		    <has_text text="--degree 2" />
		    <has_text text="Autosome genotypes stored in 286 words for each of 332 individuals." />
		    <has_text text="An alternative list of 108 to-be-removed individuals saved in file kingunrelated_toberemoved.txt" />
		</assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="build" value="true" />
	    <output name="kingoutput" >
		<assert_contents>
		    <has_text text="--build" />
		    <has_text text="Autosome genotypes stored in 286 words for each of 332 individuals." />
		    <has_text text="Update-ID information is saved in file kingupdateids.txt" />
		    <has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
		</assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="build" value="true" />
	    <param name="degree" value="2" />
	    <output name="kingoutput">
		<assert_contents>
		    <has_text text="--build" />
		    <has_text text="--degree 2" />
		    <has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
		    <has_text text="Update-parent information is saved in file kingupdateparents.txt" />
		</assert_contents>
	    </output>
	</test>
	<test>
	    <param name="genotype" value="ex.bed"/>
	    <param name="family" value="ex.fam"/>
	    <param name="map" value="ex.bim"/>
	    <param name="cluster" value="true" />
	    <output name="kingoutput">
		<assert_contents>
		    <has_text text="--cluster" />
		    <has_text text="Total length of 20 chromosomal segments usable for IBD segment analysis is 1432.2 MB." />
		    <has_text text="Pair-wise relatedness in newly clustered families saved in kingcluster.kin." />
		</assert_contents>
	    </output>
	</test>
    </tests>
    <help><![CDATA[

`KING <http://people.virginia.edu/~wc9c/KING/>`_ is a toolset that makes use of high-throughput SNP data typically seen in a genome-wide association study (GWAS)
or a sequencing project. Applications of KING include family relationship inference and pedigree error checking,
quality control, population substructure identification, forensics, gene mapping, etc. 

        ]]>
    </help>
    <citations>
        <citation type="doi">10.1093/bioinformatics/btq559</citation>
    </citations>
</tool>
