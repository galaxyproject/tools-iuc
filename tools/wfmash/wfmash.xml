<tool id="wfmash" name="wfmash" version="@TOOL_VERSION@+galaxy0">
    <description>pangenome-scale aligner</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
set -euo pipefail
# Workaround for the if/else logic 
prepare_input() {
    local input="\$1"
    local output="\$2"
    if gunzip -c "\$input" > "\$output" 2>/dev/null; then
        : 
    else
        ln -s -f "\$input" "\$output"
    fi
}

reference_fasta_filename="reference.fa"
prepare_input "\${reference}" "\${reference_fasta_filename}"
samtools faidx "\${reference_fasta_filename}" 2>&1 || echo "Error running samtools faidx for reference" >&2

query_fasta_filename="query.fa"
prepare_input "\${query}" "\${query_fasta_filename}"
samtools faidx "\${query_fasta_filename}" 2>&1 || echo "Error running samtools faidx for query" >&2

set -- --threads="\${GALAXY_SLOTS:-1}"

#if $segment_length:
set -- "\$@" -s "$segment_length"
#end if

#if $pct_identity:
set -- "\$@" -p "$pct_identity"
#end if

#if $approx_mapping:
set -- "\$@" -m
#end if

#if $no_split:
set -- "\$@" -N "$no_split"
#end if

wfmash "\$@" "\${reference_fasta_filename}" "\${query_fasta_filename}" > "$output_paf"
    ]]></command>
    <inputs>
        <param name="reference" type="data" format="fasta,fasta.gz" label="Reference sequence" help="FASTA format" />
        <param name="query" type="data" format="fasta,fasta.gz" label="Query sequence" help="FASTA format"/>
        <param name="segment_length" type="integer" optional="true" label="Segment Length" help="Minimum seed length. (Default: 5000)"/>
        <param name="pct_identity" type="float" optional="true" min="0" max="100" label="Minimum Identity %" help="Percent identity in the mashmap step (Default: 90)"/>
        <param name="approx_mapping" type="boolean" truevalue="true" falsevalue="false" label="Approximate mapping" help="Skip base-level alignment"/>
        <param name="no_split" type="integer" optional="true" label="No split" help="Disable splitting of input sequences during mapping (Default: enabled)"/>
    </inputs>
    
    <outputs>
        <data name="output_paf" format="paf" label="${tool.name} on ${on_string}: PAF"/>
    </outputs>
    
    <tests>
        <test>
            <param name="reference" ftype="fasta.gz" value="reference.fa.gz"/> 
            <param name="query" ftype="fasta.gz" value="query.fa.gz"/>        
            <param name="segment_length" value="10"/>
            <param name="pct_identity" value="70"/>
            <output name="output_paf" file="output_test.paf"/>
        </test>
    </tests>
    
    <help><![CDATA[
wfmash is designed to make whole genome alignment easy. It can handle high sequence divergence, with average nucleotide identity between input sequences as low as 70%.

By default, wfmash automatically determines an appropriate identity threshold based on the ANI (Average Nucleotide Identity) distribution of your input sequences.
    ]]></help>
    
    <expand macro="citations"/>
</tool>
