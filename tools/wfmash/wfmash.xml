<tool id="wfmash" name="wfmash" version="@TOOL_VERSION@+galaxy0">
    <description>pangenome-scale aligner</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
#set $reference_fasta_filename = "reference.fa"
#set $query_fasta_filename = "query.fa"

#if str($reference.ext).endswith('gz')
gunzip -c '${reference}' > '${reference_fasta_filename}' &&
#else
ln -s -f '${reference}' '${reference_fasta_filename}' &&
#end if
samtools faidx '${reference_fasta_filename}' 2>&1 || echo "Error running samtools faidx for reference" >&2 &&

#if str($query.ext).endswith('gz')
gunzip -c '${query}' > '${query_fasta_filename}' &&
#else
ln -s -f '${query}' '${query_fasta_filename}' &&
#end if
samtools faidx '${query_fasta_filename}' 2>&1 || echo "Error running samtools faidx for query" >&2 &&

wfmash
    --threads="\${GALAXY_SLOTS:-1}"
#if $segment_length
    -s $segment_length
#end if
#if $pct_identity
    -p $pct_identity
#end if
#if $approx_mapping
    -m
#end if
#if $no_split
    -N $no_split
#end if
    '${reference_fasta_filename}'
    '${query_fasta_filename}'
    > '${output_paf}'
    ]]></command>
    <inputs>
        <param name="reference" type="data" format="fasta,fasta.gz" label="Reference sequence" help="FASTA format" />
        <param name="query" type="data" format="fasta,fasta.gz" label="Query sequence" help="FASTA format"/>
        <param name="segment_length" type="integer" optional="true" min="100" label="Segment Length" help="Minimum seed length, must be >= 100 bp.  (Default: 5000)"/>
        <param name="pct_identity" type="float" optional="true" min="0" max="100" label="Minimum Identity %" help="Percent identity in the mashmap step (Default: 90)"/>
        <param name="approx_mapping" type="boolean" truevalue="true" falsevalue="false" label="Approximate mapping" help="Skip base-level alignment"/>
        <param name="no_split" type="integer" optional="true" label="No split" help="Disable splitting of input sequences during mapping (Default: enabled)"/>
    </inputs>
    
    <outputs>
        <data name="output_paf" format="paf" label="${tool.name} on ${on_string}:  PAF"/>
    </outputs>

    <tests>
        <test>
            <param name="reference" ftype="fasta" value="ecoli_k12.fa"/> 
            <param name="query" ftype="fasta" value="ecoli_o157.fa"/>        
            <param name="pct_identity" value="70"/>
            <output name="output_paf" file="expected_output_ecoli.paf"/>
        </test>
    </tests>
    
    <help><![CDATA[
wfmash is designed to make whole genome alignment easy. It can handle high sequence divergence, with average nucleotide identity between input sequences as low as 70%. 

By default, wfmash automatically determines an appropriate identity threshold based on the ANI (Average Nucleotide Identity) distribution of your input sequences. 
    ]]></help>
    
    <expand macro="citations"/>
</tool>
