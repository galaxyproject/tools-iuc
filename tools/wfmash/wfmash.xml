<tool id="wfmash" name="wfmash" version="@TOOL_VERSION@+galaxy0">
    <description>pangenome-scale aligner</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
set -euo pipefail

reference_fasta_filename="reference.fa"
query_fasta_filename="query.fa"

# Notice the backslash \ before $ for local bash variables
if gunzip -c "${reference}" > "\${reference_fasta_filename}" 2>/dev/null; then
    :
else
    ln -s -f "${reference}" "\${reference_fasta_filename}"
fi

samtools faidx "\${reference_fasta_filename}" 2>&1 || echo "Error running samtools faidx for wfmash reference" >&2

if gunzip -c "${query}" > "\${query_fasta_filename}" 2>/dev/null; then
    :
else
    ln -s -f "${query}" "\${query_fasta_filename}"
fi

samtools faidx "\${query_fasta_filename}" 2>&1 || echo "Error running samtools faidx for wfmash query" >&2

set -- --threads="\${GALAXY_SLOTS:-1}"

#if $segment_length:
set -- "$@" -s "$segment_length"
#end if


#if $pct_identity:
set -- "$@" -p "$pct_identity"
#end if

#if $approx_mapping:
set -- "$@" -m "$approx_mapping"
#end if

#if $no_split:
set -- "$@" -N "$no_split"
#end if

wfmash "$@" "\${reference_fasta_filename}" "\${query_fasta_filename}" > "$output_paf"    
    ]]></command>
    <inputs>
        <param name="reference" type="data" format="fasta" label="Reference sequence" help="FASTA format" />
        <param name="query" type="data" format="fasta" label="Query sequence" help="FASTA format"/>

        <param name="segment_length" type="integer" optional="true" label="Segment Length" help="Minimum seed length. (Default: 5000)"/>
        <param name="pct_identity" type="float" optional="true" min="0" max="100" label="Minimum Identity" help="Percent identity in the mashmap step (Default: 90)"/>
        <param name="approx_mapping" type="boolean" truevalue="true" falsevalue="false" label="Approximate mapping" help="Skip base-level alignment"/>
        <param name="no_split" type="integer" optional="true" label="No split" help="Disable splitting of input sequences during mapping (Default: enabled)"/>
    </inputs>

    <outputs>
        <data name="output_paf" format="paf" label="${tool.name} on ${on_string}: PAF"/>
    </outputs>


     <tests>
        <test>
            <param name="reference" ftype="fasta,fa,fa.gz,fasta.gz" value="reference.fa"/> 
            <param name="query" ftype="fasta,fa,fa.gz,fasta.gz" value="query.fa"/>
        
            <param name="segment_length" value="10"/>
            <!-- Change 0 to something valid like 70 -->
            <param name="pct_identity" value="70"/>
            
            <output name="output_paf">
                <assert_contents>
                    <!-- Now you can check for file content again -->
                    <has_size value="0" min_difference="1" />
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
wfmash is designed to make whole genome alignment easy. It can handle high sequence divergence, with average nucleotide identity between input sequences as low as 70%.

By default, wfmash automatically determines an appropriate identity threshold based on the ANI (Average Nucleotide Identity) distribution of your input sequences.
    ]]></help>

    <expand macro="citations"/>
</tool>