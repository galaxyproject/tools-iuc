<tool id="moabs" name="MOABS" profile="16.04" version="@VERSION@">
	<description>MOdel based Analysis of Bisulfite Sequencing data</description>
	<macros>
		<import>macros.xml</import>
	</macros>
	<expand macro="requirements"/>
	<command detect_errors="exit_code">
		<![CDATA[
		moabs --cf '$cfg_file' &&
		mv -f dmr_M3_g1.G.bed_vs_g2.G.bed.txt.dmr '$output1'
		]]></command>
	<configfiles>
		<configfile name="cfg_file">
			[INPUT]
			#for $i, $s in enumerate( $g1_fastq )
			#if $s.fastq_input.selector == 'paired':
			s1_r${i+1}_1='$s.fastq_input.input1'
			s1_r${i+1}_2='$s.fastq_input.input2'
			#else:
			s1_r${i+1}='$s.fastq_input.input'
			#end if
			#end for
			#for $i, $s in enumerate( $g2_fastq )
			#if $s.fastq_input.selector == 'paired':
			s2_r${i+1}_1='$s.fastq_input.input1'
			s2_r${i+1}_2='$s.fastq_input.input2'
			#else:
			s2_r${i+1}='$s.fastq_input.input'
			#end if
			#end for

			[TASK]
			Program=MMAP
			Label=g1,g2
			Parallel=THREAD

			[MMAP]
			Path=bsmap
			p=4
			d='$input3'

			[MCALL]
			Path=mcall
			r='$input3'
			p=4

			[MCOMP]
			Path=mcomp
			reference='$input3'
		</configfile>
	</configfiles>

	<inputs>
		<repeat name="g1_fastq" title="Group1: fastq files">
			<conditional name="fastq_input">
				<param name="selector" type="select" label="Single or paired-end reads?">
					<option value="single">Single-end</option>
					<option value="paired">Paired-end</option>
				</param>
				<when value="single">
					<param name="input" type="data" format="fastq" label="Single reads" />
				</when>
				<when value="paired">
					<param name="input1" type="data" format="fastq" label="Forward reads" />
					<param name="input2" type="data" format="fastq" label="Reverse reads" />
				</when>
			</conditional>
		</repeat>
		<repeat name="g2_fastq" title="Group2: fastq files">
			<conditional name="fastq_input">
				<param name="selector" type="select" label="Single or paired-end reads?">
					<option value="single">Single-end</option>
					<option value="paired">Paired-end</option>
				</param>
				<when value="single">
					<param name="input" type="data" format="fastq" label="Single reads" />
				</when>
				<when value="paired">
					<param name="input1" type="data" format="fastq" label="Forward reads" />
					<param name="input2" type="data" format="fastq" label="Reverse reads" />
				</when>
			</conditional>
		</repeat>
		<param type="data" name="input3" format="fasta" label="Reference FASTA file" help="Can be uploaded in the history" />
	</inputs>
	<outputs>
		<data name="output1" format="txt" label="${tool.name} on ${on_string} (.txt)" />
	</outputs>
	<tests>
		<test>
			<repeat name="g1_fastq">
				<conditional name="fastq_input">
					<param name="selector" value="single"/>
					<param name="input" value="s1_r1.fq"/>
				</conditional>
			</repeat>
			<repeat name="g1_fastq">
				<conditional name="fastq_input">
					<param name="selector" value="paired"/>
					<param name="input1" value="s1_r2_1.fq"/>
					<param name="input2" value="s1_r2_2.fq"/>
				</conditional>
			</repeat>
			<repeat name="g2_fastq">
				<conditional name="fastq_input">
					<param name="selector" value="single"/>
					<param name="input" value="ko_r1.fq"/>
				</conditional>
			</repeat>
			<repeat name="g2_fastq">
				<conditional name="fastq_input">
					<param name="selector" value="paired"/>
					<param name="input1" value="ko_r2_1.fq"/>
					<param name="input2" value="ko_r2_2.fq"/>
				</conditional>
			</repeat>
			<param name="input3" value="chr2.fa"/>
			<output name="output1" file="dmr_M3_g1.G.bed_vs_g2.G.bed.txt.dmr" ftype="txt" lines_diff="6"/>
		</test>
	</tests>
	<help>
		<![CDATA[
		**MOABS: MOdel based Analysis of Bisulfite Sequencing data**

		MOABS is a comprehensive, accurate and efficient solution for analysis of large scale base-resolution DNA methylation data, bisulfite sequencing or single molecule direct sequencing.

		MOABS seamlessly integrates alignment, methylation calling, identification of hypomethylation for one sample and differential methylation for multiple samples, and other downstream analysis.

		For more information, check https://github.com/sunnyisgalaxy/moabs. 
		]]>
	</help>
	<expand macro="citations"/>
</tool>
