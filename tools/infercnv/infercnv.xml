<tool id="infercnv" name="InferCNV" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Infer Copy Number Variation from Single-Cell RNA-Seq Data</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
 


    ]]></command>
    <configfiles>
        <configfile name="infercnv.R">
            # InferCNV configuration file
            # This file is used to specify the parameters for the InferCNV tool
            
            # load library
            library(infercnv)

            # create the infercnv object
            infercnv_obj = CreateInfercnvObject(
                                                raw_counts_matrix='$raw_mtx', # the matrix of genes (rows) vs. cells (columns) containing the raw counts
                                                gene_order_file='$gene_order', # data file containing the positions of each gene along each chromosome in the genome.
                                                annotations_file='$cell_annotations', # a description of the cells, indicating the cell type classifications
                                                ref_group_names=c($ref_group), # a vector containing the classifications of the reference (normal) cells to use for infering cnv
                                                delim="\t",
                                                
                                                max_cells_per_group = $max_cell, #maximun number of cells to use per group. Default=NULL, using all cells defined in the annotations_file. 
                                                min_max_counts_per_cell = c($min_count, $max_count), # minimum and maximum counts allowed per cell. Any cells outside this range will be removed from the counts matrix. 
                                                chr_exclude = c($chr_exclude) # chromosomes to exclude from the analysis
                                                )

            # perform infercnv operations to reveal cnv signal
            infercnv_obj = infercnv::run(
                                infercnv_obj,
                                cutoff= $cutoff,
                                min_cells_per_gene = $min_cells_per_gene,
                                out_dir="output",
                                num_ref_groups = NULL, # keep this as default
                                ref_subtract_use_mean_bounds = TRUE, # keep this as default

                                ## Smoothing params
                                window_length = $window_length,
                                smooth_method = $smooth_method,

                                ## Clustering params
                                cluster_by_groups = $cluster_by_groups,
                                cluster_references = $cluster_references,
                                k_obs_groups = $k_obs_groups, 
                                hclust_method = $hclust_method,
                                max_centered_threshold = 3, # keep this as default
                                scale_data = $scale_data, 

                                ## HMM params
                                HMM= $HMM,
                                HMM_transition_prob = 1e-06, # keep this as default
                                HMM_report_by = $HMM_report_by,
                                HMM_type = $HMM_type,
                                HMM_i3_pval = 0.05, # keep this as default
                                HMM_i3_use_KS = FALSE, # keep this as default
                                BayesMaxPNormal = $BayesMaxPNormal,
                                sim_method = "meanvar", # keep this as default
                                sim_foreground = FALSE, # keep this as default
                                reassignCNVs = TRUE, # keep this as default

                                ## Tumor subclustering params
                                analysis_mode = $analysis_mode,
                                tumor_subcluster_partition_method = $tumor_subcluster_partition_method,
                                tumor_subcluster_pval = 0.1, # keep this as default
                                k_nn = $k_nn,
                                leiden_method = $leiden_method,
                                leiden_function = $leiden_function,
                                leiden_resolution = $leiden_resolution,
                                leiden_method_per_chr = $leiden_method_per_chr,
                                leiden_function_per_chr = $leiden_function_per_chr,
                                leiden_resolution_per_chr = $leiden_resolution_per_chr,
                                per_chr_hmm_subclusters = $per_chr_hmm_subclusters,
                                per_chr_hmm_subclusters_references = $per_chr_hmm_subclusters_references,
                                z_score_filter = 0.8,

                                ## de-noising parameters
                                denoise= $denoise,
                                noise_filter = NA, # keep this as default
                                sd_amplifier = $sd_amplifier,
                                noise_logistic = FALSE, # keep this as default

                                ## Outlier parameters
                                outlier_method_bound = "average_bound", # keep this as default
                                outlier_lower_bound = NA, # keep this as default
                                outlier_upper_bound = NA, # keep this as default

                                ## Plotting parameters
                                final_scale_limits = NULL, # keep this as default
                                final_center_val = NULL, # keep this as default
                                debug = FALSE, # keep this as default
                                plot_steps = FALSE, # keep this as default
                                inspect_subclusters = TRUE, # keep this as default
                                resume_mode = TRUE, # keep this as default
                                png_res = $png_res, 
                                plot_probabilities = TRUE, # keep this as default
                                save_rds = FALSE, # set to FALSE
                                save_final_rds = FALSE, # set to FALSE
                                diagnostics = $diagnostics,

                                ## Experimental options
                                remove_genes_at_chr_ends = FALSE, # keep this as default
                                prune_outliers = FALSE, # keep this as default
                                mask_nonDE_genes = FALSE, # keep this as default
                                mask_nonDE_pval = 0.05, # keep this as default
                                test.use = "wilcoxon", # keep this as default
                                require_DE_all_normals = "any", # keep this as default
                                hspike_aggregate_normals = FALSE, # keep this as default
                                no_plot = FALSE, # keep this as default
                                no_prelim_plot = FALSE, # keep this as default
                                write_expr_matrix = FALSE, # keep this as default
                                write_phylo = FALSE, # keep this as default
                                output_format = "png", # keep this as default
                                plot_chr_scale = FALSE, # keep this as default
                                chr_lengths = NULL, # keep this as default
                                useRaster = TRUE, # keep this as default
                                up_to_step = 100 # keep this as default
                                )



        </configfile>
    </configfiles>
    <inputs>
        <param name="raw_mtx" type="data" format="tabular" label="Raw counts matrix" help="The matrix of genes (rows) vs. cells (columns) containing the raw counts" />
        <param name="gene_order" type="data" format="tabular" label="Gene order file" help="Tabular file containing the positions of each gene along each chromosome in the genome." />
        <param name="cell_annotations" type="data" format="tabular" label="Cell annotations file" help="A description of the cells, indicating the cell type classifications" />
        <param name="ref_group" type="text" label="Reference group names" optional="true" help="A vector containing the classifications of the reference (normal) cells to use for infering cnv" />
        
        <section name="advanced" title="Advanced parameters">
            <param name="max_cell" type="integer" min="0" optional="true" label="Maximun number of cells to use per group."/>
            <param name="min_count" type="integer" min="0" value="100" optional="true" label="Minimum counts allowed per cell."/>
            <param name="max_count" type="integer" min="0" optional="true" label="Maximum counts allowed per cell."/>
            <param name="chr_exclude" type="text" value="'chrX', 'chrY', 'chrM'" label="Chromosomes to exclude" optional="true" help="Chromosomes to exclude from the analysis" />
    
        </section>

    </inputs>
    <outputs>

    </outputs>
    <tests>

    </tests>
    <help>
        
    </help>
    <expand macro="citations" />
</tool>