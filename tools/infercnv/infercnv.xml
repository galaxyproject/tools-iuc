<tool id="infercnv" name="InferCNV" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Infer Copy Number Variation from Single-Cell RNA-Seq Data</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
 


    ]]></command>
    <configfiles>
        <configfile name="infercnv.R">
            # InferCNV configuration file
            # This file is used to specify the parameters for the InferCNV tool
            
            # load library
            library(infercnv)

            # create the infercnv object
            infercnv_obj = CreateInfercnvObject(
                                                raw_counts_matrix='$raw_mtx', # the matrix of genes (rows) vs. cells (columns) containing the raw counts
                                                gene_order_file='$gene_order', # data file containing the positions of each gene along each chromosome in the genome.
                                                annotations_file='$cell_annotations', # a description of the cells, indicating the cell type classifications
                                                ref_group_names=c($ref_group), # a vector containing the classifications of the reference (normal) cells to use for infering cnv
                                                delim="\t",
                                                
                                                max_cells_per_group = $max_cell, #maximun number of cells to use per group. Default=NULL, using all cells defined in the annotations_file. 
                                                min_max_counts_per_cell = c($min_count, $max_count), # minimum and maximum counts allowed per cell. Any cells outside this range will be removed from the counts matrix. 
                                                chr_exclude = c($chr_exclude) # chromosomes to exclude from the analysis
                                                )

            # perform infercnv operations to reveal cnv signal
            infercnv_obj = infercnv::run(
                                infercnv_obj,
                                cutoff= $cutoff,
                                min_cells_per_gene = $min_cells_per_gene,
                                out_dir="output",
                                num_ref_groups = NULL, # keep this as default
                                ref_subtract_use_mean_bounds = TRUE, # keep this as default

                                ## Smoothing params
                                window_length = $window_length,
                                smooth_method = $smooth_method,

                                ## Clustering params
                                cluster_by_groups = $cluster_by_groups,
                                cluster_references = $cluster_references,
                                k_obs_groups = $k_obs_groups, 
                                hclust_method = $hclust_method,
                                max_centered_threshold = 3, # keep this as default
                                scale_data = $scale_data, 

                                ## HMM params
                                HMM= $HMM,
                                HMM_transition_prob = 1e-06, # keep this as default
                                HMM_report_by = $HMM_report_by,
                                HMM_type = $HMM_type,
                                HMM_i3_pval = 0.05, # keep this as default
                                HMM_i3_use_KS = FALSE, # keep this as default
                                BayesMaxPNormal = $BayesMaxPNormal,
                                sim_method = "meanvar", # keep this as default
                                sim_foreground = FALSE, # keep this as default
                                reassignCNVs = TRUE, # keep this as default

                                ## Tumor subclustering params
                                analysis_mode = $analysis_mode,
                                tumor_subcluster_partition_method = $tumor_subcluster_partition_method,
                                tumor_subcluster_pval = 0.1, # keep this as default
                                k_nn = $k_nn,
                                leiden_method = $leiden_method,
                                leiden_function = $leiden_function,
                                leiden_resolution = "auto", # keep this as default
                                leiden_method_per_chr = $leiden_method_per_chr,
                                leiden_function_per_chr = $leiden_function_per_chr,
                                leiden_resolution_per_chr = $leiden_resolution_per_chr,
                                per_chr_hmm_subclusters = $per_chr_hmm_subclusters,
                                per_chr_hmm_subclusters_references = $per_chr_hmm_subclusters_references,
                                z_score_filter = $z_score_filter,

                                ## de-noising parameters
                                denoise= $denoise,
                                noise_filter = NA, # keep this as default
                                sd_amplifier = $sd_amplifier,
                                noise_logistic = FALSE, # keep this as default

                                ## Outlier parameters
                                outlier_method_bound = "average_bound", # keep this as default
                                outlier_lower_bound = NA, # keep this as default
                                outlier_upper_bound = NA, # keep this as default

                                ## Plotting parameters
                                final_scale_limits = NULL, # keep this as default
                                final_center_val = NULL, # keep this as default
                                debug = FALSE, # keep this as default
                                plot_steps = FALSE, # keep this as default
                                inspect_subclusters = TRUE, # keep this as default
                                resume_mode = TRUE, # keep this as default
                                png_res = $png_res, 
                                plot_probabilities = TRUE, # keep this as default
                                save_rds = FALSE, # set to FALSE
                                save_final_rds = FALSE, # set to FALSE
                                diagnostics = $diagnostics,

                                ## Experimental options
                                remove_genes_at_chr_ends = FALSE, # keep this as default
                                prune_outliers = FALSE, # keep this as default
                                mask_nonDE_genes = FALSE, # keep this as default
                                mask_nonDE_pval = 0.05, # keep this as default
                                test.use = "wilcoxon", # keep this as default
                                require_DE_all_normals = "any", # keep this as default
                                hspike_aggregate_normals = FALSE, # keep this as default
                                no_plot = FALSE, # keep this as default
                                no_prelim_plot = FALSE, # keep this as default
                                write_expr_matrix = FALSE, # keep this as default
                                write_phylo = FALSE, # keep this as default
                                output_format = "png", # keep this as default
                                plot_chr_scale = FALSE, # keep this as default
                                chr_lengths = NULL, # keep this as default
                                useRaster = TRUE, # keep this as default
                                up_to_step = 100 # keep this as default
                                )
        </configfile>
    </configfiles>
    <inputs>
        <param name="raw_mtx" type="data" format="tabular" label="Raw counts matrix" help="The matrix of genes (rows) vs. cells (columns) containing the raw counts" />
        <param name="gene_order" type="data" format="tabular" label="Gene order file" help="Tabular file containing the positions of each gene along each chromosome in the genome." />
        <param name="cell_annotations" type="data" format="tabular" label="Cell annotations file" help="A description of the cells, indicating the cell type classifications" />
        <param name="ref_group" type="text" label="Reference group names" optional="true" help="A vector containing the classifications of the reference (normal) cells to use for infering cnv" />
        
        <section name="advanced" title="Advanced parameters">
            <param name="max_cell" type="integer" min="0" optional="true" label="Maximun number of cells to use per group."/>
            <param name="min_count" type="integer" min="0" value="100" optional="true" label="Minimum counts allowed per cell."/>
            <param name="max_count" type="integer" min="0" optional="true" label="Maximum counts allowed per cell."/>
            <param name="chr_exclude" type="text" value="'chrX', 'chrY', 'chrM'" label="Chromosomes to exclude" optional="true" help="Chromosomes to exclude from the analysis" />
            <param name="cutoff" type="float" min="0" max="1" value="1" label="Cutoff" help="The cutoff value to use for infercnv" />
            <param name="min_cells_per_gene" type="integer" min="0" value="3" label="Minimum cells per gene" help="minimum number of reference cells requiring expression measurements to include the corresponding gene." />
            <section name="smoothing" title="Smoothing parameters">
                <param name="window_length" type="integer" min="0" value="101" label="Window length" help="Length of the window for the moving average (smoothing). Should be an odd integer." />
                <param name="smooth_method" type="select" label="Smoothing method" help="The method to use for smoothing" >
                    <option value="pyramidinal">pyramidinal</option>
                    <option value="runmeans">runmeans</option>
                    <option value="coordinates">coordinates</option>
                </param>
            </section>
            <section name="clustering" title="Clustering parameters">
                <param name="cluster_by_groups" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Cluster by groups" help="Whether to cluster by groups" />
                <param name="cluster_references" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true" label="Cluster references" help="Whether to cluster references within their annotations or not" />
                <param name="k_obs_groups" type="integer" min="0" value="3" label="K obs groups" help="Number of groups in which to break the observations" />
                <param name="hclust_method" type="select" label="Hclust method" help="Method used for hierarchical clustering of cells." >
                    <option value="ward.D2">ward.D2</option>
                    <option value="ward.D">ward.D</option>
                    <option value="single">single</option>
                    <option value="complete">complete</option>
                    <option value="average">average</option>
                    <option value="mcquitty">mcquitty</option>
                    <option value="median">median</option>
                    <option value="centroid">centroid</option>
                </param>
                <param argument="scale_data" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Scale data" help="Whether to scale the data" />
            </section>
            <section name="HMM" title="HMM parameters">
                <param name="HMM" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="HMM" help="Whether to run HMM to predict CNV level" />
                <param name="HMM_report_by" type="select" label="HMM report by" help="Note, reporting is performed entirely separately from the HMM prediction. So, you can predict on subclusters, but get per-cell level reporting (more voluminous output" >
                    <option value="subcluster">subcluster</option>
                    <option value="cell">cell</option>
                    <option value="consensus">consensus</option>
                </param>
                <param name="HMM_type" type="select" label="HMM model type" help="The type of HMM to use" >
                    <option value="i6">i6</option>
                    <option value="i3">i3</option>
                </param>
                <param name="BayesMaxPNormal" type="float" min="0" max="1" value="0.05" label="Bayes max p normal" help="Maximum P(Normal) allowed for a CNV prediction according to BayesNet. (zero turns it off)" />
            </section>

            <section name="tumor_subclustering" title="Tumor subclustering parameters">
                <param name="analysis_mode" type="select" label="Analysis mode" help="Grouping level for image filtering or HMM predictions. default: samples (fastest, but subclusters is ideal)" >
                    <option value="samples">samples</option>
                    <option value="subclusters">subclusters</option>
                    <option value="cells">cells</option>
                </param>
                <param name="tumor_subcluster_partition_method" type="select" label="Tumor subcluster partition method" help="Method for defining tumor subclusters." >
                    <option value="leiden">leiden</option>
                    <option value="random_trees">random_trees</option>
                    <option value="qnorm">qnorm</option>
                </param>
                <param name="k_nn" type="integer" min="0" value="20" label="KNN" help="number k of nearest neighbors to search for when using the Leiden partition method for subclustering" />
                <param name="leiden_method" type="select" label="Leiden method" help="Method used to generate the graph on which the Leiden algorithm is applied" >
                    <option value="PCA">PCA</option>
                    <option value="simple">simple</option>
                </param>
                <param name="leiden_function" type="select" label="Leiden function" help="Whether to use the Constant Potts Model (CPM) or modularity in igraph." >
                    <option value="CPM">CPM</option>
                    <option value="modularity">modularity</option>
                </param>
                <param name="leiden_method_per_chr" type="select" label="Leiden method per chr" help="Method used to generate the graph on which the Leiden algorithm is applied for the per chromosome subclustering." >
                    <option value="simple">simple</option>
                    <option value="PCA">PCA</option>
                </param>
                <param name="leiden_function_per_chr" type="select" label="Leiden function per chr" help="Whether to use the Constant Potts Model (CPM) or modularity in igraph for the per chromosome subclustering." >
                    <option value="modularity">modularity</option>
                    <option value="CPM">CPM</option>
                </param>
                <param name="leiden_resolution_per_chr" type="integer" min="0" value="1" label="Leiden resolution per chr" help="esolution parameter for the Leiden algorithm for the per chromosome subclustering." />
                <param name="per_chr_hmm_subclusters" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Per chr HMM subclusters" help="Run subclustering per chromosome over all cells combined to run the HMM on those subclusters instead. Only applicable when using leiden subclustering." />
                <param name="per_chr_hmm_subclusters_references" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Per chr HMM subclusters references" help="Whether the per chromosome subclustering should also be done on references" />
                <param name="z_score_filter" type="integer" min="0" max="1" value="0.8" label="Z score treshold" help="Z-score used as a treshold to filter genes used for subclustering. Applied to remove genes with high expression variability such as MHC genes. " />
            </section>
            <section name="denoise" title="Denoising parameters">
                <param name="denoise" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Denoise" help="Whether to denoise the data" />
                <param name="sd_amplifier" type="float" min="0" value="1.5" label="SD amplifier" help="Noise is defined as mean(reference_cells) +- sdev(reference_cells) * sd_amplifier" />
            </section>
            <section name="plotting" title="Plotting parameters">
                <param name="png_res" type="integer" min="0" value="300" label="PNG resolution" help="Resolution of the PNG files" />
                <param name="diagnostics" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Diagnostics" help="Create diagnostic plots after running the Bayesian model" />
            </section>
        </section>
    </inputs>
    <outputs>

    </outputs>
    <tests>

    </tests>
    <help>
        
    </help>
    <expand macro="citations" />
</tool>