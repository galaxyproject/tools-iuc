<macros>
    <token name="@TOOL_VERSION@">2.9.10</token>

    <token name="@DESCRIPTION@">small variant caller</token>

    <xml name="requirements">
        <requirements>
            <requirement type="package" version="@TOOL_VERSION@">strelka</requirement>
            <requirement type="package" version="1.9">samtools</requirement>
            <yield/>
        </requirements>
    </xml>

	<xml name="citations">
        <citations>
            <citation type="doi">10.1038/s41592-018-0051-x</citation>
        </citations>
    </xml>    

    <!-- initialize: strelka config parameters -->
    <token name="@INIT_STRELKA@"><![CDATA[
        echo "maxIndelSize" = $strelka.maxIndelSize >> config.ini &&
    ]]></token>

    <!-- initialize: required parameters -->
    <token name="@INIT_REQUIRED@"><![CDATA[
        ln -s '$referenceFasta' ./input_ref.fasta &&
        samtools faidx ./input_ref.fasta &&
    ]]></token>

    <!-- initialize: advanced parameters -->
    <token name="@INIT_ADVANCED@"><![CDATA[
        #if $advanced.indelCandidates
            ln -s '$advanced.indelCandidates' ./input_indelcandidates.vcf &&
        #end if
        #if $advanced.forcedGT
            ln -s '$advanced.forcedGT' ./input_forcedgt.vcf &&
        #end if
        #if $advanced.callRegions
            ln -s '$advanced.callRegions' ./input_callregions.bgzip &&
        #end if
    ]]></token>

    <!-- initialize: workflow -->
    <token name="@INIT_WORKFLOW@"><![CDATA[
        --config=config.ini
        $advanced.exome
        $advanced.targeted
        #if $advanced.forcedGT
            --forcedGT ./input_forcedgt.vcf
        #end if
        #if $advanced.indelCandidates
            --indelCandidates ./input_indelcandidates.vcf
        #end if
        #if $advanced.callRegions
            --callRegions ./input_callregions.bgzip
        #end if
        --referenceFasta ./input_ref.fasta
        --runDir ./results &&
    ]]></token>

    <!-- run: workflow -->
    <token name="@RUN_WORKFLOW@"><![CDATA[
        ./results/runWorkflow.py
            -m local
            -j \${GALAXY_SLOTS:-2}
            -g \${GALAXY_MEMORY_GB:-8}        
    ]]></token>

    <!-- input: required parameters -->
    <xml name="input_required">
        <param argument="--referenceFasta" type="data" format="fasta" label="Reference file" help="" />
    </xml>

    <!-- input: advanced parameters -->
    <xml name="input_advanced">
        <param argument="--indelCandidates" type="data" format="vcf" optional="true" label="File with candidate indel alleles" help=""/>
        <param argument="--forcedGT" type="data" format="vcf" optional="true" label="File with candidate alleles" help=""/>
        <param argument="--callRegions" type="data" format="bgzip" optional="true" label="File containing a set of regions to call" help=""/>
        <param argument="--rna" type="boolean" checked="false" truevalue="--rna" falsevalue="" label="Set options for RNA-Seq input" help="" />
        <param argument="--targeted" type="boolean" checked="false" truevalue="--targeted" falsevalue="" label="Set options for other targeted input" help="" />
        <param argument="--exome" type="boolean" checked="false" truevalue="--exome" falsevalue="" label="Set options for exome input" help="" />
    </xml>

    <!-- input: strelka config file -->
    <xml name="input_strelka">
        <param argument="maxIndelSize" name="maxIndelSize" type="integer" value="49" label="maxIndelSize" help="" />
    </xml>

    <token name="@HELP_HEADER@">
Strelka2 is a fast and accurate small variant caller optimized for analysis of germline variation in small cohorts (Strelka Germline) and somatic variation in tumor/normal sample pairs (Strelka Somatic). The germline caller employs an efficient tiered haplotype model to improve accuracy and provide read-backed phasing, adaptively selecting between assembly and a faster alignment-based haplotyping approach at each variant locus. The germline caller also analyzes input sequencing data using a mixture-model indel error estimation method to improve robustness to indel noise. The somatic calling model improves on the original Strelka method for liquid and late-stage tumor analysis by accounting for possible tumor cell contamination in the normal sample. A final empirical variant re-scoring step using random forest models trained on various call quality features has been added to both callers to further improve precision.

More information are available on https://github.com/Illumina/strelka.
    </token>
    <token name="@HELP_PARAMETER_REQUIRED@">
--referenceFasta    samtools-indexed reference fasta file
    </token>

    <token name="@HELP_PARAMETER_ADVANCED@">
--indelCandidates   Specify a VCF of candidate indel alleles. These alleles are always evaluated but only reported in the output when they are inferred to exist in the sample. The VCF must be tabix indexed. All indel alleles must be left-shifted/normalized, any unnormalized alleles will be ignored. This option may be specified more than once, multiple input VCFs will be merged.
--forcedGT  Specify a VCF of candidate alleles. These alleles are always evaluated and reported even if they are unlikely to exist in the sample. The VCF must be tabix indexed. All indel alleles must be left- shifted/normalized, any unnormalized allele will trigger a runtime error. This option may be specified more than once, multiple input VCFs will be merged. Note that for any SNVs provided in the VCF, the SNV site will be reported (and for gVCF, excluded from block compression), but the specific SNV alleles are ignored.
--exome     Set options for exome input: note in particular that this flag turns off high-depth filters
--targeted  Set options for other targeted input: note in particular that this flag turns off high-depth filters
--callRegions   Optionally provide a bgzip-compressed/tabix-indexed BED file containing the set of regions to call. No VCF output will be provided outside of these regions. The full genome will still be used to estimate statistics from the input (such as expected depth per chromosome). Only one BED file may be specified.  
    </token>

    <token name="@HELP_PARAMETER_STRELKA@">
- **maxIndelSize**: Maximum reported indel size
    </token>
</macros>