<?xml version="1.0"?>
<tool id="strelka_germline" name="Strelka Germline" version="@TOOL_VERSION@+galaxy1">
    <description>@DESCRIPTION@ for germline variation in small cohorts</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        ## initialize: required parameters
        #for $i, $s in enumerate($bam)
            #if $s.is_of_type('bam')
                ln -s '$s' ./input_sample_${i}.bam &&               
                ln -s '$s.metadata.bam_index' ./input_sample_${i}.bam.bai &&
            #elif $s.is_of_type('cram')
                ln -s '$s' ./input_sample_${i}.cram &&               
                ln -s '$s.metadata.cram_index' ./input_sample_${i}.cram.crai &&
            #end if
        #end for
        @INIT_REQUIRED@

        ## initialize: advanced parameters
        #if $advanced.ploidy
            ln -s '$advanced.ploidy' ./input_ploidy.vcf &&
        #end if
        #if $advanced.noCompress
            ln -s '$advanced.noCompress' ./input_nocompress.bgzip &&
        #end if
        @INIT_ADVANCED@

        ## initialize: workflow
        configureStrelkaGermlineWorkflow.py
            #for $i, $s in enumerate($bam)
                --bam ./input_sample_${i}.bam
            #end for
            #if $advanced.callContinuousVf != 'none'
                --callContinuousVf $advanced.callContinuousVf
            #end if
            #if $advanced.ploidy
                --ploidy ./input_ploidy.vcf
            #end if
            #if $advanced.noCompress
                --noCompress ./input_nocompress.bgzip
            #end if
            $advanced.rna 
            --disableSequenceErrorEstimation ## demo datasets causes warnings
            @INIT_WORKFLOW@

        ## run: workflow
        @RUN_WORKFLOW@

        ## run: decompress results
        && bgzip -d results/results/variants/variants.vcf.gz
    ]]></command>
    
    <configfiles>
        <configfile name="config_file">
## parser cannot handle indents
[StrelkaSomatic]
minMapq = $strelka.minMapq
@INIT_STRELKA@
        </configfile>
    </configfiles>

    <inputs>
        <!-- required parameters -->
        <param argument="--bam" type="data" format="bam, cram" multiple="true" label="Sample files" help="" />
        <expand macro="input_required" />
        
        <!-- advanced parameters -->
        <section name="advanced" title="Advanced Options" expanded="false">
            <param argument="--ploidy" type="data" format="vcf" optional="true" label="Ploidy file" help="" />
            <param argument="--noCompress" type="data" format="bgzip" optional="true" label="File of regions where gVCF block compression is not allowed" help="" />
            <param argument="--callContinuousVf" type="select" label="Chromosome to Call variants on" help="">    
                <option value="none" selected="true">None</option>
                <option value="Chr1">Chr1</option>
                <option value="Chr2">Chr2</option>
                <option value="Chr3">Chr3</option>
                <option value="Chr4">Chr4</option>
                <option value="Chr5">Chr5</option>
                <option value="Chr6">Chr6</option>
                <option value="Chr7">Chr7</option>
                <option value="Chr8">Chr8</option>
                <option value="Chr9">Chr9</option>
                <option value="Chr10">Chr10</option>
                <option value="Chr11">Chr11</option>
                <option value="Chr12">Chr12</option>
                <option value="Chr13">Chr13</option>
                <option value="Chr14">Chr14</option>
                <option value="Chr15">Chr15</option>
                <option value="Chr16">Chr16</option>
                <option value="Chr17">Chr17</option>
                <option value="Chr18">Chr18</option>
                <option value="Chr19">Chr19</option>
                <option value="Chr20">Chr20</option>
                <option value="Chr21">Chr21</option>
                <option value="Chr22">Chr22</option>
                <option value="ChrX">ChrX</option>
                <option value="ChrY">ChrY</option>
            </param>
            <param argument="--rna" type="boolean" checked="false" truevalue="--rna" falsevalue="" label="Set options for RNA-Seq input" help="" />
            <expand macro="input_advanced" />
        </section>

        <!-- strelka config parameters -->
        <section name="strelka" title="Strelka Options" expanded="false">            
            <param argument="minMapq" name="minMapq" type="integer" value="20" label="minMapq" help=""/>
            <expand macro="input_strelka"/>
        </section>
    </inputs>
    <outputs>
        <data name="output_variants" format="vcf" from_work_dir="results/results/variants/variants.vcf"/>
   </outputs>
    <tests>
        <!-- #1: strelka: germline workflow demo -->
        <test>
            <param name="bam" value="sample1.bam,sample2.bam"/>
            <param name="referenceFasta" value="hg98.fa"/>
            <!-- different fileDate and startTime -->
            <output name="output_variants" file="variants.vcf"  compare="sim_size" delta="1000"/>
        </test>
        <!-- #2: with advanced parameters -->
        <!-- #3: with config file parameters -->
    </tests>
    <help><![CDATA[
What it does
============
@HELP_HEADER@

Parameter
=========
--bam   Sample BAM or CRAM file. May be specified more than once, multiple inputs will be treated as each BAM file representing a different sample.
@HELP_PARAMETER_REQUIRED@

Advanced
--------
--ploidy    Provide ploidy file in VCF. The VCF should include one sample column per input sample labeled with the same sample names found in the input BAM/CRAM RG header sections. Ploidy should be provided in records using the FORMAT/CN field, which are interpreted to span the range [POS+1, INFO/END]. Any CN value besides 1 or 0 will be treated as 2. File must be tabix indexed.
--noCompress    Provide BED file of regions where gVCF block compression is not allowed. File must be bgzip-compressed/tabix-indexed.
--callContinuousVf  Call variants on CHROM without a ploidy prior assumption, issuing calls with continuous variant frequencies.
--rna   Set options for RNA-Seq input.
@HELP_PARAMETER_ADVANCED@

Strelka Config File
-------------------
- **minMapq**: Don't use reads with MAPQ less than this value for variant calling
@HELP_PARAMETER_STRELKA@
    ]]></help>
    <expand macro="citations" />
</tool>