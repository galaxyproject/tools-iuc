<tool id="strelka_somatic" name="Strelka Somatic" version="@TOOL_VERSION@+galaxy1">
    <description>@DESCRIPTION@ for somatic variation in tumor/normal sample pairs</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        ## initialize: strelka config file 
        ## /src/python/bin/configureStrelkaSomaticWorkflow.py.ini
        touch config.ini &&
        echo "[StrelkaSomatic]" > config.ini &&
        echo "depthFilterMultiple" = $strelka.depthFilterMultiple >> config.ini &&
        echo "snvMaxFilteredBasecallFrac" = $strelka.snvMaxFilteredBasecallFrac >> config.ini &&
        echo "snvMaxSpanningDeletionFrac" = $strelka.snvMaxSpanningDeletionFrac >> config.ini &&
        echo "indelMaxWindowFilteredBasecallFrac" = $strelka.indelMaxWindowFilteredBasecallFrac >> config.ini &&
        echo "ssnvPrior" = $strelka.ssnvPrior >> config.ini &&
        echo "sindelPrior" = $strelka.sindelPrior >> config.ini &&
        echo "ssnvNoise" = $strelka.ssnvNoise >> config.ini &&
        echo "sindelNoiseFactor" = $strelka.sindelNoiseFactor >> config.ini &&
        echo "ssnvNoiseStrandBiasFrac" = $strelka.ssnvNoiseStrandBiasFrac >> config.ini &&
        echo "minTier1Mapq" = $strelka.minTier1Mapq >> config.ini &&
        echo "minTier2Mapq" = $strelka.minTier2Mapq >> config.ini &&
        echo "ssnvQuality_LowerBound" = $strelka.ssnvQuality_LowerBound >> config.ini &&
        echo "sindelQuality_LowerBound" = $strelka.sindelQuality_LowerBound >> config.ini &&
        echo "ssnvContamTolerance" = $strelka.ssnvContamTolerance >> config.ini &&
        echo "indelContamTolerance" = $strelka.indelContamTolerance >> config.ini &&
        @INIT_STRELKA@
        
        ## initialize: required parameters
        ln -s '$normalBam' ./input_normal.bam &&
        samtools index ./input_normal.bam &&
        ln -s '$tumorBam' ./input_tumor.bam &&
        samtools index ./input_tumor.bam &&
        @INIT_REQUIRED@
        
        ## initialize: advanced parameters
        @INIT_ADVANCED@

        ## initialize: workflow
        configureStrelkaSomaticWorkflow.py
            --normalBam ./input_normal.bam
            --tumorBam ./input_tumor.bam
            $advanced.outputCallableRegions
            @INIT_WORKFLOW@

        ## run: workflow        
        @RUN_WORKFLOW@        
    ]]></command>
    <inputs>
        <param argument="--normalBam" type="data" format="bam" multiple="false" label="Normal sample file" help=""/>
        <param argument="--tumorBam" type="data" format="bam" multiple="false" label="Tumor sample file" help=""/>
        <expand macro="input_required" />

        <section name="advanced" title="Advanced Options" expanded="false">            
            <param argument="--outputCallableRegions" type="boolean" checked="false" truevalue="--outputCallableRegions" falsevalue="" label="Generate bed file describing somatic callable regions of the genome" help="" />
            <expand macro="input_advanced" />
        </section>
        
        <section name="strelka" title="Strelka Options" expanded="false">            
            <param argument="depthFilterMultiple" name="depthFilterMultiple" type="float" value="3.0" label="depthFilterMultiple" help="" />
            <param argument="snvMaxFilteredBasecallFrac" name="snvMaxFilteredBasecallFrac" type="float" value="0.4" min="0.0" max="1.0" label="snvMaxFilteredBasecallFrac" help="" />
            <param argument="snvMaxSpanningDeletionFrac" name="snvMaxSpanningDeletionFrac" type="float" value="0.75" min="0.0" max="1.0" label="" help="" />
            <param argument="indelMaxWindowFilteredBasecallFrac" name="indelMaxWindowFilteredBasecallFrac" type="float" value="0.3" min="0.0" max="1.0" label="indelMaxWindowFilteredBasecallFrac" help="" />
            <param argument="ssnvPrior" name="ssnvPrior" type="float" value="0.0001" min="0.0" label="ssnvPrior" help="" />
            <param argument="sindelPrior" name="sindelPrior" type="float" value="0.000001" min="0.0" label="sindelPrior" help="" />
            <param argument="ssnvNoise" name="ssnvNoise" type="float" value="0.0000000005" min="0.0" label="ssnvNoise" help="" />
            <param argument="sindelNoiseFactor" name="sindelNoiseFactor" type="float" value="2.2" label="sindelNoiseFactor" help="" />
            <param argument="ssnvNoiseStrandBiasFrac" name="ssnvNoiseStrandBiasFrac" type="float" value="0.0" min="0.0" max="1.0" label="ssnvNoiseStrandBiasFrac" help="" />
            <param argument="minTier1Mapq" name="minTier1Mapq" type="integer" value="20" label="minTier1Mapq" help="" />
            <param argument="minTier2Mapq" name="minTier2Mapq" type="integer" value="0" label="minTier2Mapq" help="" />
            <param argument="ssnvQuality_LowerBound" name="ssnvQuality_LowerBound" type="integer" value="15" label="ssnvQuality_LowerBound" help="" />
            <param argument="sindelQuality_LowerBound" name="sindelQuality_LowerBound" type="integer" value="40" label="sindelQuality_LowerBound" help="" />
            <param argument="ssnvContamTolerance" name="ssnvContamTolerance" type="float" value="0.15" min="0.0" max="1.0" label="ssnvContamTolerance" help="" />
            <param argument="indelContamTolerance" name="indelContamTolerance" type="float" value="0.15" min="0.0" max="1.0" label="indelContamTolerance" help="" />
            <expand macro="input_strelka"/>
        </section>
    </inputs>
    <outputs>
        <data name="output_indels" format="data" from_work_dir="results/results/variants/somatic.indels.vcf.gz" label="Indels"/>
        <data name="output_snvs" format="data" from_work_dir="results/results/variants/somatic.snvs.vcf.gz" label="SNVS"/>
        <data name="output_callable" format="data" from_work_dir="results/results/regions/somatic.callable.regions.bed.gz" label="Callable regions">
            <filter>advanced['outputCallableRegions']</filter>
        </data>
   </outputs>
    <tests>
        <!-- #1: strelka: somatic workflow demo -->
        <test>
            <param name="normalBam" value="sample1.bam" ftype="bam"/>
            <param name="tumorBam" value="sample2.bam" ftype="bam"/>
            <param name="referenceFasta" value="hg98.fa" ftype="fasta"/>
            <!-- different fileDate and startTime -->
            <output name="output_indels" file="somatic.indels.vcf.gz" compare="sim_size" delta="100"/>
            <output name="output_snvs" file="somatic.snvs.vcf.gz" compare="sim_size" delta="100"/>
        </test>
        <!-- #2: with advanced parameters -->
        <test>
            <param name="normalBam" value="sample1.bam" ftype="bam"/>
            <param name="tumorBam" value="sample2.bam" ftype="bam"/>
            <param name="referenceFasta" value="hg98.fa" ftype="fasta"/>
            <section name="advanced">
                <param name="outputCallableRegions" value="true"/>
            </section>
            <!-- different fileDate and startTime -->
            <output name="output_indels" file="somatic.indels.vcf.gz" compare="sim_size" delta="1000"/>
            <output name="output_snvs" file="somatic.snvs.vcf.gz" compare="sim_size" delta="100"/>
            <output name="output_callable" file="somatic.callable.regions.bed.gz" compare="sim_size" delta="100"/>
        </test>
        <!-- #3: with config file parameters -->
    </tests>
    <help><![CDATA[
What it does
============
@HELP_HEADER@

Parameter
=========
--normalBam     Normal sample BAM or CRAM file.
--tumorBam      Tumor sample BAM or CRAM file.
@HELP_PARAMETER_REQUIRED@

Advanced
--------
--outputCallableRegions Output a bed file describing somatic callable regions of the genome
@HELP_PARAMETER_ADVANCED@

Strelka Config File
-------------------
- **depthFilterMultiple**: If the depth filter is not skipped, all variants which occur at a depth greater than depthFilterMultiple*chromosome mean depth will be filtered out.
- **snvMaxFilteredBasecallFrac**: Somatic SNV calls are filtered at sites where greater than this fraction of basecalls have been removed by the mismatch density filter in either sample.
- **snvMaxSpanningDeletionFrac**: Somatic SNV calls are filtered at sites where greater than this fraction of overlapping reads contain deletions which span the SNV call site.
- **indelMaxWindowFilteredBasecallFrac**: Somatic indel calls are filtered if greater than this fraction of basecalls in a window extending 50 bases to each side of an indel's call position have been removed by the mismatch density filter.
- **ssnvPrior**: prior probability of a somatic snv or indel
- **sindelPrior**: prior probability of a somatic snv or indel
- **ssnvNoise**: probability of an snv or indel noise allele NB: in the calling model a noise allele is shared in tumor and normal samples, but occurs at any frequency.
- **sindelNoiseFactor**: somatic indel noise factor
- **ssnvNoiseStrandBiasFrac**: Fraction of snv noise attributed to strand-bias. It is not recommended to change this setting. However, if it is essential to turn the strand bias penalization off, the following is recommended: Assuming the current value of ssnvNoiseStrandBiasFrac is 0.5, (1) set ssnvNoiseStrandBiasFrac = 0 (2) divide the current ssnvNoise value by 2
- **minTier1Mapq**: minimum MAPQ score for reads at tier1
- **minTier2Mapq**: minimum MAPQ score for reads at tier2
- **ssnvQuality_LowerBound**: Somatic quality score (QSS_NT, NT=ref) below which somatic SNVs are marked as filtered
- **sindelQuality_LowerBound**: Somatic quality score (QSI_NT, NT=ref) below which somatic indels are marked as filtered
- **ssnvContamTolerance**: Tolerance of tumor contamination in the normal sample
- **indelContamTolerance**: Tolerance of tumor contamination in the normal sample
@HELP_PARAMETER_STRELKA@
    ]]></help>
    <expand macro="citations" />
</tool>