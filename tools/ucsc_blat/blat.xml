<?xml version="1.0"?>
<tool id="ucsc_blat" name="UCSC BLAT Alignment Tool" version="35-0">
    <description>Standalone blat sequence search command line tool</description>
    <requirements>
        <requirement type="package" version="35">blat</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
      #if str($reference_source.reference_source_selector) == "history":
            #set $reference_fasta_filename = "localref.fa"
            ln -s '${reference_source.database}' '${reference_fasta_filename}' &&
      #else:
            #set $reference_fasta_filename = str($reference_source.database.fields.path)
      #end if
      blat
            #if $noHead == "yes"
            -noHead
            #end if
            -q=$query_type
            -t=$database_type
            -mask=$mask
            '$reference_fasta_filename'
            '${query}'
            output
      && sort -k 10,10 -k 12,12n output > '${output_sorted}'
]]></command>
      <inputs>
            <conditional name="reference_source">
                  <param name="reference_source_selector" type="select" label="Choose the source for the database">
                        <option value="cached">Locally cached</option>
                        <option value="history">History</option>
                  </param>
                  <when value="cached">
                        <param name="database" type="select" label="Select database">
                              <options from_data_table="all_fasta">
                                    <filter type="sort_by" column="2" />
                              </options>
                              <validator type="no_options" message="A built-in database is not available" />
                        </param>
                  </when>
                  <when value="history">
                        <param name="database" type="data" format="fasta" label="Using database file" />
                  </when>
            </conditional>
            <param type="data" name="query" format="fasta" />
            <param type="select" name="database_type" format="text" multiple="false" label="database type" help="Choose your database type, the default is dnax" argument="-t">
                  <option value="dna">dna - DNA sequence</option>
                  <option value="prot">prot - protein sequence</option>
                  <option value="dnax" selected="true">dnax - DNA sequence translated in six frames to protein</option>
            </param>
            <param type="select" name="query_type" format="text" multiple="false" label="query type" help="Choose your query type, the default is rnax" argument="-q">
                  <option value="dna">dna - DNA sequence </option>
                  <option value="rna">rna - RNA sequence</option>
                  <option value="prot">prot - protein sequence</option>
                  <option value="dnax">dnax - DNA sequence translated in six frames to protein</option>
                  <option value="rnax" selected="true">rnax - DNA sequence translated in three frames to protein</option>
            </param>
            <param type="select" name="noHead" format="text" label="Suppresses .psl header (so it's just a tab-separated file)." >
                  <option value="yes" selected="true">Yes, suppresses .psl header</option>
                  <option value="no">No, do not suppresses .psl header</option>
            </param>
            <param name="mask" type="select" label="Mask out repeats" help="Alignments won't be started in masked region
                  but may extend through it in nucleotide searches.  Masked areas
                  are ignored entirely in protein or translated searches. Default is lower" argument="-mask">
                  <option value="lower" selected="true">lower - mask out lower-cased sequence</option>
                  <option value="upper">upper - mask out upper-cased sequence</option>
                  <option value="out">out - mask according to database.out RepeatMasker .out file</option>
                  <option value="file.out">file.out - mask database according to RepeatMasker file.out</option>
            </param>
      </inputs>
      <outputs>
            <data format="psl" name="output_sorted" label="${tool.name} on ${on_string}"></data>
      </outputs>
    <tests>
        <test>
            <param name="reference_source_selector" value="history" />
            <param name="database" value="amaVit1_Gallus/amaVit1.fa" />
            <param name="query" value="amaVit1_Gallus/Gallus_gallus_RefSeq.fa" />
            <param name="database_type" value="dnax" />
            <param name="query_type" value="rnax" />
            <param name="noHead" value="yes" />
            <param name="mask" value="lower" />
            <output name="output_sorted" value="amaVit1_Gallus/amaVit1_Gallus_gallus.psl" />
        </test>
        <test>
            <param name="reference_source_selector" value="history" />
            <param name="database" value="dbia3/dbia3.fa" />
            <param name="query" value="dbia3/dmel-all-transcript-r6.13.fasta" />
            <param name="database_type" value="dnax" />
            <param name="query_type" value="rnax" />
            <param name="noHead" value="yes" />
            <param name="mask" value="lower" />
            <output name="output_sorted" value="dbia3/dbia3.sorted.psl" />
        </test>
        <!-- testing 'cached' is not (yet?) possible with planemo
        <test>
            <param name="reference_source_selector" value="cached" />
            <param name="database" value="dbia3" />
            <param name="query" value="dbia3/dmel-all-transcript-r6.13.fasta" />
            <param name="database_type" value="dnax" />
            <param name="query_type" value="rnax" />
            <param name="noHead" value="yes" />
            <param name="mask" value="lower" />
            <output name="output_sorted" value="dbia3/dbia3.sorted.psl" />
        </test>
        -->
  </tests>
  <help><![CDATA[
BLAT
====
BLAT is a bioinformatics software a tool which performs rapid mRNA/DNA and cross-species protein alignments.

blat (version: v340)- Standalone blat sequence search command line tool.
-------------------------------------------------------------------------

usage:
++++++

  $ blat database query [-ooc=11.ooc] output.psl

where:
   database and query are each either a .fa, .nib or .2bit file,
   or a list of these files with one file name per line.
   -ooc=11.ooc tells the program to load over-occurring 11-mers from
   an external file.  This will increase the speed
   by a factor of 40 in many cases, but is not required.
   output.psl is the name of the output file.

documentation:
++++++++++++++

See Blat documentation (http://genome.ucsc.edu/goldenPath/help/blatSpec.html)

Source code:
++++++++++++

http://hgdownload.cse.ucsc.edu/admin/exe/

]]></help>
    <citations>
        <citation type="doi">10.1101/gr.229202</citation>
    </citations>
</tool>
