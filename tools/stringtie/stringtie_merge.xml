<tool id="stringtie_merge" name="StringTie merge" version="@TOOL_VERSION@">
    <description>transcripts</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="stdio" />
    <expand macro="version_command" />
    <command><![CDATA[
        #if str($guide.use_guide) == 'yes':
            #if $guide.guide_source.guide_gff_select == "history":
                ln -s '$guide.guide_source.ref_hist' guide.gff &&
            #elif $guide.guide_source.guide_gff_select == "cached":
            ln -s '$guide.guide_source.ref_builtin.fields.path' guide.gff &&
            #end if
        #end if
        
        stringtie --merge
        -p \${GALAXY_SLOTS:-1}
        
        #if str($guide.use_guide) == 'yes':
            -G guide.gff
        #end if
        
        -m $min_len
        -c $min_cov
        -F $min_fpkm
        -T $min_tpm
        -f $min_iso
        -g $gap_len
        $keep_introns
        #set inputs = "' '".join(str($input_gtf).split(','))
        -o '$out_gtf' '$inputs'
    ]]></command>
    <inputs>
        <param name="input_gtf" type="data" format="gtf,gff3" multiple="true" label="Transcripts" help="In GTF or GFF3 format" />
        <conditional name="guide">
            <param name="use_guide" argument="-G" type="select" label="Reference annotation to include in the merging">
                <option value="yes">Use reference GTF/GFF3</option>
                <option value="no" selected="true" >Do not use reference GTF/GFF3</option>
            </param>
            <when value="no" />
            <when value="yes">
                <conditional name="guide_source">
                    <param name="guide_gff_select" type="select" label="Reference file">
                        <option value="cached" selected="true">Use a built-in file</option>
                        <option value="history">Use a file from history</option>
                    </param>
                    <when value="cached">
                        <param name="ref_builtin" type="select" label="Use a built-in GTF" help="If the GTF file for your transcriptome of interest is not listed, contact your Galaxy administrator">
                            <options from_data_table="gene_sets">
                                <filter type="sort_by" column="2" />
                                <validator type="no_options" message="No GTF file is available." />
                            </options>
                        </param>
                    </when>
                    <when value="history">
                        <param name="ref_hist" type="data" format="gtf,gff3" label="GTF/GFF3 dataset to guide assembly" />
                    </when>
                </conditional>
            </when>
        </conditional>
        <param name="min_len" argument="-m" type="integer" value="50" label="Minimum input transcript length to include in the merge" />
        <param name="min_cov" argument="-c" type="integer" value="0" label="Minimum input transcript coverage to include in the merge" />
        <param name="min_fpkm" argument="-F" type="float" value="1.0" label="Minimum input transcript FPKM to include in the merge" />
        <param name="min_tpm" argument="-T" type="float" value="1.0" label="Minimum input transcript TPM to include in the merge" />
        <param name="min_iso" argument="-f" type="float" value="0.01" label="Minimum isoform fraction" />
        <param name="gap_len" argument="-g" type="integer" value="250" label="Gap between transcripts to merge together" />
        <param name="keep_introns" argument="-i" type="boolean" truevalue="-i" falsevalue="" label="Keep merged transcripts with retained introns" help="By default these are not kept unless there is strong evidence for them" />
    </inputs>
    <outputs>
        <data name="out_gtf" format="gtf" />
    </outputs>
    <tests>
        <test>
            <param name="input_gtf" ftype="gtf" value="stringtie_out1.gtf,stringtie_out2.gtf,stringtie_out3.gtf,stringtie_out4.gtf" />
            <param name="use_guide" value="yes"/>
            <param name="guide_gff_select" value="history"/>
            <param name="ref_hist" ftype="gtf" value="stringtie_in.gtf" />
            <output name="out_gtf" file="stringtie_merge_out1.gtf" ftype="gtf" lines_diff="4" />
        </test>
        <test>
            <param name="input_gtf" ftype="gtf" value="stringtie_merge_in1.gtf,stringtie_merge_in2.gtf" />
            <param name="use_guide" value="yes"/>
            <param name="guide_gff_select" value="history"/>
            <param name="ref_hist" ftype="gtf" value="stringtie_merge_in3.gtf" />
            <output name="out_gtf" file="stringtie_merge_out2.gtf" ftype="gtf" lines_diff="4" />
        </test>
        <test>
            <param name="input_gtf" ftype="gtf" value="stringtie_merge_in1.gtf,stringtie_merge_in2.gtf" />
            <output name="out_gtf" ftype="gtf">
                <assert_contents>
                    <has_text text="stringtie --merge" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
    <![CDATA[
**What it does?**

This is a special usage mode of StringTie_, distinct from the assembly usage mode. In the merge mode, StringTie takes as input a list of GTF/GFF files and merges/assembles these transcripts into a non-redundant set of transcripts. This mode is used in the new differential analysis pipeline to generate a global, unified set of transcripts (isoforms) across multiple RNA-Seq samples.

If a reference annotation is provided, StringTie will assemble the transfrags from the input GTF files with the reference transcripts.

.. _StringTie: http://ccb.jhu.edu/software/stringtie/
    ]]></help>
    <expand macro="citations" />
</tool>
