<tool id="samestr_compare" name="SameStr Compare" version="0.1.0+galaxy0" python_template_version="3.5" profile="21.05">
    <description>Convert metagenomic alignments to nucleotide variant profiles for SameStr analysis</description>
    <requirements>
        <requirement type="package" version="1.2025.111">samestr</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    mkdir -p out_compare/ &&

    #for $i, $file in enumerate($input_files):
        #if str($file.ext) in ['npz','npy']:
            cp '$file' '$file.element_identifier' &&
        #else if str($file.ext) == 'npy.gz':
            cp '$file' '$file.element_identifier' &&
        #end if
    #end for

    #for $name_file in $input_names:
        cp '$name_file' '$name_file.element_identifier' &&
    #end for
    
    samestr compare
    --marker-dir '$database.fields.path'
    --input-files
    #for $file in $input_files:
        '$file.element_identifier'
    #end for
    --input-names
    #for $name_file in $input_names:
        '$name_file.element_identifier'
    #end for
    --output-dir out_compare/
    $variant_comparison_settings.dominant_variants
    $variant_comparison_settings.dominant_variants_added
    $variant_comparison_settings.dominant_variants_msa
    ]]></command>
    <inputs>
        <param name="input_files" type="data" format="npz,npy" multiple="true" label="Input SNV profiles" help="NPZ/NPY files from samestr merge."/>
        <param name="input_names" type="data" format="txt" multiple="true" label="Sample identifiers" help="Text files listing the sample/gene identifiers."/>

        <param name="database" type="select" label="Marker database" help="MetaPhlAn clade marker database.">
            <options from_data_table="metaphlan_database_versioned">
                <filter type="sort_by" column="2" />
            </options>
        </param>

        <section name="variant_comparison_settings" title="Variant comparison settings">
            <param argument="--dominant-variants" type="boolean" truevalue="--dominant-variants" falsevalue="" label="Compare only dominant variants" help="Compare only dominant variants as obtained from consensus call (default: False)." />
            <param argument="--dominant-variants-added" type="boolean" truevalue="--dominant-variants-added" falsevalue="" label="Include dominant variants as additional entries" help="Add dominant variants as additional entries to data (default: False)." />
            <param argument="--dominant-variants-msa" type="boolean" truevalue="--dominant-variants-msa" falsevalue="" label="Output dominant variant alignments" help="Generate FASTA alignments of dominant variants for each clade (default: False)." />
        </section>
    </inputs>
    <outputs>
        <data name="command_log" format="json" from_work_dir="out_compare/command_log.json" label="${tool.name} on ${on_string}: Command log"/>

        <collection name="overlap_files" type="list" label="${tool.name} on ${on_string}: Coverage overlap">
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.overlap\.txt)$" directory="out_compare" format="tabular"/>
        </collection>

        <collection name="close_files" type="list" label="${tool.name} on ${on_string}: Closest distance">
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.closest\.txt)$" directory="out_compare" format="tabular"/>
        </collection>

        <collection name="fraction_files" type="list" label="${tool.name} on ${on_string}: Similarity fraction">
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.fraction\.txt)$" directory="out_compare" format="tabular"/>
        </collection>

        <collection name="msa_files" type="list" label="${tool.name} on ${on_string}: Dominant variant alignments">
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.msa\.fa)$" directory="out_compare" format="fasta"/>
        </collection>

    </outputs>
    <tests>
        <test expect_num_outputs="5">
            <param name="input_files" value="t__SGB7985.npz" ftype="npz" />
            <param name="input_names" value="t__SGB7985.names.txt" ftype="txt" />
            <param name="database" value="mpa_vJan21_TOY_CHOCOPhlAnSGB" />
            <section name="variant_comparison_settings">
                <param name="dominant_variants_msa" value="false" />
            </section>    
            <output name="command_log" ftype="json">
                <assert_contents>
                    <has_text text="command"/>
                    <has_text text="date-start"/>
                    <has_text text="date-end"/>
                </assert_contents>
            </output>
            <output_collection name="overlap_files" type="list" count="1">
                <element name="t__SGB7985.overlap.txt" ftype="tabular">
                    <assert_contents>
                        <has_text text="28C" />
                        <has_text text="29A" />
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="close_files" type="list" count="1">
                <element name="t__SGB7985.closest.txt" ftype="tabular">
                    <assert_contents>
                        <has_text text="28C" />
                        <has_text text="29A" />
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="fraction_files" type="list" count="1">
                <element name="t__SGB7985.fraction.txt" ftype="tabular">
                    <assert_contents>
                        <has_text text="28C" />
                        <has_text text="29A" />
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="msa_files" type="list" count="0" />
        </test>
         <test expect_num_outputs="5">
            <param name="input_files" value="t__SGB7985.npz" ftype="npz" />
            <param name="input_names" value="t__SGB7985.names.txt" ftype="txt" />
            <param name="database" value="mpa_vJan21_TOY_CHOCOPhlAnSGB" />

            <section name="variant_comparison_settings">
                <param name="dominant_variants" value="true" />
                <param name="dominant_variants_added" value="true" />
                <param name="dominant_variants_msa" value="true" />
            </section>
            <output name="command_log" ftype="json">
                <assert_contents>
                    <has_text text="command"/>
                    <has_text text="date-start"/>
                    <has_text text="date-end"/>
                </assert_contents>
            </output>
            <output_collection name="overlap_files" type="list" count="1">
                <element name="t__SGB7985.overlap.txt" ftype="tabular">
                    <assert_contents>
                        <has_text text="28C" />
                        <has_text text="29A" />
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="close_files" type="list" count="1">
                <element name="t__SGB7985.closest.txt" ftype="tabular">
                    <assert_contents>
                        <has_text text="28C" />
                        <has_text text="29A" />
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="fraction_files" type="list" count="1">
                <element name="t__SGB7985.fraction.txt" ftype="tabular">
                    <assert_contents>
                        <has_text text="28C" />
                        <has_text text="29A" />
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="msa_files" type="list" count="1">
                <element name="t__SGB7985.msa.fa" ftype="fasta">
                    <assert_contents>
                        <has_text text="28C" />
                        <has_text text="29A" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
    **SameStr Compare**

    SameStr Compare performs pairwise clade-specific alignment comparisons to identify shared strains between samples.
    It calculates similarity metrics between variant profiles to detect when the same bacterial strain is present 
    across different samples.

    **Input Requirements**

    SameStr Compare analyzes filtered SNV profiles from samestr filter. For each analysis, the following inputs must be provided:
    - One or more SNV profile files in NPZ/NPY format (.npz, .npy, or .npy.gz).
    - Corresponding sample identifier files in text format (.txt).
    - The MetaPhlAn clade marker database that matches the database used throughout the workflow.

    **Parameters**

    - Compare only dominant variants: Focus on dominant variants only, ignoring minority variants.
    - Include dominant variants as additional entries: Add dominant variant comparisons alongside all-variant comparisons.
    - Output dominant variant alignments: Generate FASTA alignments of dominant variants for each clade.

    **Results and Outputs**

    The tool generates teh following outputs per clade:
    - Command log (JSON format). Detailed execution log of the cimpare process.
    - Coverage overlap. Number of overlapping marker positions between sample pairs (.overlap.txt) .
    - Clostest distance. Distance metric based on variant differences between samples (.closest.txt) .
    - Similarity fraction. Normalized similarity scores (.fraction.txt) . 
    - Dominant variant alignments in FASTA format (.msa.fasta). Multiple sequence alignments of dominant variants. This output is only generated when the "Output dominant variant alignments" is enabled.  
    ]]></help>
    <citations>
        <citation type="bibtex">
        @software{samestr,
        title = {SameStr},
        author = {Podlesny, Daniel and Fricke, W. Florian},
        year = {2022},
        url = {https://github.com/danielpodlesny/samestr},
        license = {GNU Affero General Public License v3.0},
        }</citation>
    </citations>
</tool>