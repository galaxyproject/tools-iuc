<tool id="samestr_filter" name="SameStr Filter" version="0.1.0+galaxy0" python_template_version="3.5" profile="21.05">
    <description>SameStr Filter filters nucleotide variant profiles using coverage, sample, marker, and position-based criteria</description>
    <requirements>
        <requirement type="package" version="1.2025.111">samestr</requirement>
        <requirement type="package" version="2.10.1">blast</requirement>
        <requirement type="package" version="3.9">python</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    mkdir -p out_filter/ &&

    #for $i, $file in enumerate($input_files):
        #if str($file.ext) in ['npz','npy']:
            cp '$file' '$file.element_identifier' &&
        #else if str($file.ext) == 'npy.gz':
            cp '$file' '$file.element_identifier' &&
        #end if
    #end for

    #for $name_file in $input_names:
        cp '$name_file' '$name_file.element_identifier' &&
    #end for

    samestr filter
    --marker-dir '$database.fields.path'
    --output-dir out_filter/
    --input-files
    #for $file in $input_files:
        '$file.element_identifier'
    #end for
    --input-names
    #for $name_file in $input_names:
        '$name_file.element_identifier'
    #end for
    $keep_poly
    $keep_mono
    $delete_pos
    #if $clade:
    --clade '$clade'
    #end if
    --clade-min-samples '$clade_min_samples'
    #if $marker_remove:
        --marker-remove '$marker_remove'
    #end if
    #if $marker_keep:
        --marker-keep '$marker_keep'
    #end if
    --marker-trunc-len '$marker_trunc_len'
    --sample-var-min-n-vcov '$sample_var_min_n_vcov'
    --sample-var-min-f-vcov '$sample_var_min_f_vcov'
    --sample-pos-min-n-vcov '$sample_pos_min_n_vcov'
    --sample-pos-min-sd-vcov '$sample_pos_min_sd_vcov'
    #if $samples_select:
        --samples-select
        #for $select_file in $samples_select:
            '$select_file'
        #end for
    #end if
    --samples-min-n-hcov '$samples_min_n_hcov'
    #if $samples_min_f_hcov:
        --samples-min-f-hcov '$samples_min_f_hcov'
    #end if
    #if $samples_min_m_vcov:
        --samples-min-m-vcov '$samples_min_m_vcov'
    #end if
    --global-pos-min-n-vcov '$global_pos_min_n_vcov'
    #if $global_pos_min_f_vcov:
        --global-pos-min-f-vcov '$global_pos_min_f_vcov'
    #end if
    ]]></command>
    <inputs>
        <param name="input_files" type="data" format="npz,npy" multiple="true" label="Input SNV profiles" help="NPZ/NPY files from samestr merge."/>
        <param name="input_names" type="data" format="txt" multiple="true" label="Sample identifiers" help="Text files listing the sample/gene identifiers."/>

        <param name="database" type="select" label="Marker database" help="MetaPhlAn or mOTUs clade marker database.">
            <options from_data_table="metaphlan_database_versioned">
                <filter type="sort_by" column="2" />
            </options>
        </param>

        <section name="output_settings" title="Output file settings">
            <param argument="--keep-poly" type="boolean" truevalue="--keep-poly" falsevalue="" label="Keep polymorphic positions only" help="Keep only positions that are polymorphic in at least one sample (default: False)." />
            <param argument="--keep-mono" type="boolean" truevalue="--keep-mono" falsevalue="" label="Keep monomorphic positions only" help="Keep only positions that are monomorphic in all samples (default: False)." />
            <param argument="--delete-pos" type="boolean" truevalue="--delete-pos" falsevalue="" label="Delete global positions" help="Delete masked marker and global positions from array instead of np.nan (default: False)." />
        </section>

        <section name="clade_settings" title="Clade settings">
            <param name="clade" type="text" label="Clades to process." optional="true" help="Processing all if not specified. Names must correspond to the taxonomy of the respective database [e.g. t__SGB10068 for MetaPhlAn or ref_mOTU_v3_00095 for mOTUs]"/>
            <param name="clade_min_samples" type="integer" value="2" min="0" label="Minimum samples per clade" help="Skip clades with fewer than this number of samples (default: 2)" />
            <param name="marker_remove" type="text" label="Markers to exclude." optional="true" help="List of Markers to remove for selected clade. Requires clade to be specified."/>
            <param name="marker_keep" type="text" label="Markers to include." optional="true" help="List of Markers to keep for selected clade. Requires clade to be specified. Overrides Markers to remove from clade."/>
            <param name="marker_trunc_len" type="integer" value="50" min="0" label="Marker truncation length" help="Number of nucleotides to trim from each end of a marker sequence. (default: 50)" />
        </section>

        <section name="sample_variant_filtering" title="Sample Variant Filtering">
            <param name="sample_var_min_n_vcov" type="integer" value="2" min="0" label="Minimum variant coverage (nucleotides)" help="Remove variants with nucleotide coverage below this threshold (default: 2)." />
            <param name="sample_var_min_f_vcov" type="float" value="0.05" min="0" max="1" label="Minimum variant coverage (fraction)" help="Remove variants with coverage below this fraction (default: 0.05)." />
        </section>

        <section name="sample_position_filtering" title="Sample Position Filtering">
            <param name="sample_pos_min_n_vcov" type="integer" value="1" min="0" label="Minimum position coverage (nucleotides)" help="Remove positions with nucleotide coverage below this threshold (default: 1)." />
            <param name="sample_pos_min_sd_vcov" type="float" value="3.0" min="0" label="Position coverage standard deviation cutoff" help="Remove positions with coverage outside mean Â± this standard deviation (default: 3.0)." />
        </section>

        <section name="sample_filtering" title="Sample Filtering">
            <param name="samples_select" type="data" format="txt" multiple="true" optional="true" label="Subset of samples" help="Files containing names of samples to include." />
            <param name="samples_min_n_hcov" type="integer" value="5000" min="0"  label="Minimum horizontal coverage (nucleotides)" help="Remove samples with horizontal coverage below this nucleotide count (default: 5000)." />
            <param name="samples_min_f_hcov" type="float" value="0" min="0" max="1" optional="true" label="Minimum horizontal coverage (fraction)" help="Remove samples with horizontal coverage below this fraction (default: None). " />
            <param name="samples_min_m_vcov" type="float" value="0" min="0" optional="true" label="Minimum mean vertical coverage" help="Remove samples with mean vertical coverage below this value (default: None) ." />
        </section>

        <section name="global_position_filtering" title="Global Position Filtering">
            <param name="global_pos_min_n_vcov" type="integer" value="2" min="0" label="Minimum sample coverage per position (count)" help="Remove positions covered by fewer than this number of samples (default: 2). Overrides fraction-based filtering." />
            <param name="global_pos_min_f_vcov" type="float" value="0" min="0" max="1" optional="true" label="Minimum sample coverage per position (fraction)" help="Remove positions covered by fewer than this fraction of samples (default: None). "/>
        </section>

    </inputs>
    <outputs>
        <data name="command_log" format="json" from_work_dir="out_filter/command_log.json" label="${tool.name} on ${on_string}: Command log"/>

        <collection name="npz_files" type="list" label="${tool.name} on ${on_string}: Filtered NPZ files">
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.npz)$" directory="out_filter" format="npz"/>
        </collection>

        <collection name="sample_name" type="list" label="${tool.name} on ${on_string}: Sample identifiers">
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.names\.txt)$" directory="out_filter" format="txt"/>
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="input_files" value="t__SGB7985.npz" ftype="npz" />
            <param name="input_names" value="t__SGB7985.names.txt" ftype="txt" />
            <param name="database" value="mpa_vJan21_TOY_CHOCOPhlAnSGB" />
            <section name="clade_settings">
                <param name="clade_min_samples" value="1" />
            </section>
            
            <section name="sample_filtering">
                <param name="samples_min_n_hcov" value="1" />
            </section>
            
            <section name="sample_variant_filtering">
                <param name="sample_var_min_n_vcov" value="1" />
                <param name="sample_var_min_f_vcov" value="0" />
            </section>
            
            <section name="sample_position_filtering">
                <param name="sample_pos_min_n_vcov" value="1" />
            </section>
            
            <section name="global_position_filtering">
                <param name="global_pos_min_n_vcov" value="1" />
            </section>
            <output name="command_log" ftype="json">
                <assert_contents>
                    <has_text text="command"/>
                    <has_text text="date-start"/>
                    <has_text text="date-end"/>
                </assert_contents>
            </output>
            <output_collection name="npz_files" type="list" count="1">
                <element name="t__SGB7985.npz" ftype="npz">
                    <assert_contents>
                        <has_size value="53447" delta="100" />
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="sample_name" type="list" count="1">
                <element name="t__SGB7985.names.txt" ftype="txt">
                    <assert_contents>
                        <has_text text="28C" />
                        <has_text text="29A" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
    **SameStr Filter**
    
    SameStr Filter applies quality control and filtering to nucleotide variant profiles obtained from multiple metagenomic samples. This tool 
    removes low-quality variants, positions, and samples to prepare clean data for downstream strain comparison analysis.

    **Input Requirements**

    For each analysis, the following inputs must be provided:
    - One or more SNV profile files in NPZ/NPY format (.npz, .npy, or .npy.gz) generated by samestr merge.
    - Sample identifier files in text format (.names.txt) generated by samestr merge.
    - The MetaPhlAn or mOTUs clade marker database that matches the database used throughout the workflow.

    **Filtering Parameters: Output file settings**
    - Keep polymorphic positions only: Retain only positions that show variation in at least one sample.
    - Keep monomorphic positions only: Retain only positions that are identical across all samples.
    - Delete global positions: Remove masked positions entirely instead of marking them as missing values.

    **Filtering Parameters: Clade settings**
    - Clades to process: Filter specific clades only. If unspecified, all clades are processed.
    - Minimum samples per clade: Skip clades with fewer than the specified number of samples.
    - Markers to exclude/include: Selectively remove or keep specific markers for targeted analysis.
    - Marker truncation length: Trim nucleotides from marker ends to avoid alignment edge effects.

    **Filtering Parameters: Sample variant filtering**
    - Minimum variant coverage (nucleotides/fraction): Remove variants with insufficient read coverage.
    
    **Filtering Parameters: Sample position filtering**
    - Minimum position coverage (nucleotides): Remove positions with inadequate coverage.
    - Position coverage standard deviation cutoff: Remove positions with extreme coverage deviations.

    **Filtering Parameters: Sample filtering**
    - Subset of samples: Select specific samples for analysis using external name files.
    - Minimum horizontal coverage (nucleotides/fraction): Remove samples with insufficient breadth of coverage.
    - Minimum mean vertical coverage: Remove samples with insufficient depth of coverage.

    **Filtering Parameters: Global position filtering**
    - Minimum sample coverage per position (count/fraction): Remove positions covered by too few samples.

    **Results and Outputs**

    The tool generates three main outputs:
    - Command log (JSON format). A detailed execution log of the filtering process.
    - Filtered NPZ files. Cleaned nucleotide variant profiles ready for strain comparison analysis.
    - Sample identifiers. Updated text files listing samples that passed all filtering criteria.
    ]]></help>
    <citations>
        <citation type="bibtex">
        @software{samestr,
        title = {SameStr},
        author = {Podlesny, Daniel and Fricke, W. Florian},
        year = {2022},
        url = {https://github.com/danielpodlesny/samestr},
        license = {GNU Affero General Public License v3.0},
        }</citation>
    </citations>
</tool>