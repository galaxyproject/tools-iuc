<tool id='samestr_stats' name='SameStr Stats' version='0.1.0+galaxy0' python_template_version='3.5' profile='21.05'>
    <description>Generate statistics for SameStr variant profiles including coverage and diversity metrics</description>
    <requirements>
        <requirement type='package' version='1.2025.111'>samestr</requirement>
    </requirements>
    <command detect_errors='exit_code'><![CDATA[
    mkdir -p out_stats/ &&

    #for $i, $file in enumerate($input_files):
        #if str($file.ext) in ['npz','npy']:
            cp '$file' '$file.element_identifier' &&
        #else if str($file.ext) == 'npy.gz':
            cp '$file' '$file.element_identifier' &&
        #end if
    #end for

    #for $name_file in $input_names:
        cp '$name_file' '$name_file.element_identifier' &&
    #end for

    samestr stats
    --marker-dir '$database.fields.path'
    --input-files
    #for $file in $input_files:
        '$file.element_identifier'
    #end for
    --input-names
    #for $name_file in $input_names:
        '$name_file.element_identifier'
    #end for
    --output-dir out_stats/
    $dominant_variants
    ]]></command>
    <inputs>
        <param name='input_files' type='data' format='npz,npy' multiple='true' label='Input SNV profiles' help='NPZ/NPY files from samestr merge.'/>
        <param name='input_names' type='data' format='txt' multiple='true' label='Sample identifiers' help='Text files listing the sample/gene identifiers.'/>

        <param name='database' type='select' label='Marker database' help='MetaPhlAn or mOTUs clade marker database.'>
            <options from_data_table='metaphlan_database_versioned'>
                <filter type='sort_by' column='2' />
            </options>
        </param>

        <param argument='--dominant-variants' type='boolean' truevalue='--dominant-variants' falsevalue='' label='Report statistics only for dominant variants' help='Calculate statistics based on consensus/dominant variants only, ignoring minority variants (default: False).' />

    </inputs>
    <outputs>
        <data name='command_log' format='json' from_work_dir='out_stats/command_log.json' label='${tool.name} on ${on_string}: Command log'/>

        <collection name='stats_files' type='list' label='${tool.name} on ${on_string}: Alignment statistics'>
            <discover_datasets pattern='(?P&lt;designation&gt;.+\.aln_stats\.txt)$' directory='out_stats' format='tabular'/>
        </collection>

    </outputs>
    <tests>
        <test>
            <param name='input_files' value='t__SGB7985.npz' ftype='npz' />
            <param name='input_names' value='t__SGB7985.names.txt' ftype='txt' />
            <param name='database' value='mpa_vJan21_TOY_CHOCOPhlAnSGB' />
            <param name='dominant_variants' value='true' />
            <output name='command_log' ftype='json'>
                <assert_contents>
                    <has_text text='command'/>
                    <has_text text='date-start'/>
                    <has_text text='date-end'/>
                </assert_contents>
            </output>
            <output_collection name='stats_files' type='list' count='1'>
                <element name='t__SGB7985.aln_stats.txt' ftype='tabular'>
                    <assert_contents>
                        <has_text text='Sample' />
                        <has_text text='28C' />
                        <has_text text='29A' />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
    **SameStr Stats**

    SameStr Stats generates statistics for nucleotide variant profiles, including coverage metrics, nucleotide diversity, and filtering 
    summaries.

    **Input Requirements**

    SameStr Stats analyzes merged or filtered SNV profile files. For each analysis, the following inputs must be provided:
    - One or more SNV profile files in NPZ/NPY format (.npz, .npy, or .npy.gz) generated by samestr filter.
    - Corresponding sample identifier files in text format (.names.txt) generated by samestr filter.
    - The MetaPhlAn or mOTUs clade marker database that matches the database used throughout the workflow.

    **Parameters**

    - Report statistics only for dominant variants: Calculate metrics based on consensus/dominant variants only, ignoring minority variants.

    **Results and Outputs**

    - Command log (JSON format). A detailed execution log of the statistics process.
    - Alignment statistics files. Statistical summaries for each clade, providing per-sample metrics.
    ]]></help>
    <citations>
        <citation type='bibtex'>
        @software{samestr,
        title = {SameStr},
        author = {Podlesny, Daniel and Fricke, W. Florian},
        year = {2022},
        url = {https://github.com/danielpodlesny/samestr},
        license = {GNU Affero General Public License v3.0},
        }</citation>
    </citations>
</tool>