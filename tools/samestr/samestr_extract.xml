<tool id="samestr_extract" name="SameStr Extract" version="0.1.0+galaxy0" python_template_version="3.5" profile="21.05">
    <description>Extract MetaPhlAn marker sequences from reference genomes using BLASTN</description>
    <requirements>
        <requirement type="package" version="1.2025.111">samestr</requirement>
        <requirement type="package" version="1.5.5">zstd</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    mkdir -p out_extract/ &&

    #for $i, $genome in enumerate($reference_genomes):
        #if str($genome.ext) in ['fasta', 'fa', 'fna']:
            cp '$genome' '$genome.element_identifier' &&
        #else if str($genome.ext) == 'fasta.gz':
            cp '$genome' '$genome.element_identifier' &&
        #end if
    #end for

    samestr extract
    --input-files
    #for $genome in $reference_genomes:
        '$genome.element_identifier'
    #end for
    --clade '$clade'
    --marker-dir '$database.fields.path'
    --output-dir out_extract/
    --aln-program '$alignment.alignment_program'
    --marker-trunc-len '$alignment.truncate_marker'
    $save_marker_aln
    ]]></command>
    <inputs>
        <param name="reference_genomes" type="data" format="fasta,fasta.gz" multiple="true" label="Reference genomes" help="Reference genome sequences in FASTA format."/>

        <param name="clade" type="text" label="Clade to process from input files." help="Names must correspond to the taxonomy of the respective database [e.g. t__SGB10068 for MetaPhlAn]">
            <validator type="empty_field" message="Please enter a clade name."/>
        </param>
        <param name="database" type="select" label="Marker database" help="MetaPhlAn clade marker database.">
            <options from_data_table="metaphlan_database_versioned">
                <filter type="sort_by" column="2" />
            </options>
        </param>

        <param argument="--save-marker-aln" type="boolean" truevalue="--save-marker-aln" falsevalue="" label="Save alignment files" help="Keep alignment files for individual markers." />

        <section name="alignment" title="Alignment Parameters">
            <param name="alignment_program" type="select" label="Alignment program" help="Program to use for alignment of marker sequences.">
                <option value="muscle" selected="true">MUSCLE</option> 
                <option value="mafft">MAFFT</option> 
            </param>
            <param name="truncate_marker" type="integer" value="0" min="0" label="Marker truncation length" help="Number of Nucleotides to be cut from each side of a marker"/>       
        </section>

    </inputs>
    <outputs>
        <data name="command_log" format="json" from_work_dir="out_extract/command_log.json" label="${tool.name} on ${on_string}: Command log"/>

        <collection name="npz_files" type="list" label="${tool.name} on ${on_string}: Extracted NPZ files">
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.npz)$" directory="out_extract" format="npz"/>
        </collection>

        <collection name="marker_alignments" type="list" label="${tool.name} on ${on_string}: Marker alignments">
            <filter>save_marker_aln</filter>
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.marker_aligned\.fasta)$" directory="out_extract" format="fasta"/>
        </collection>
        
        <collection name="msa_files" type="list" label="${tool.name} on ${on_string}: MSA files">
            <filter>save_marker_aln</filter>
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.msa\.fa)$" directory="out_extract" format="fasta"/>
        </collection>

    </outputs>
    <tests>
        <test expect_num_outputs="2">

            <param name="reference_genomes" value="test_bacteria.fna" ftype="fasta"/>
            <param name="clade" value="t__GCA_000177055" />
            <param name="database" value="mpa_vJan21_TOY_CHOCOPhlAnSGB"/>
            <param name="save_marker_aln" value="false"/>
            <section name="alignment">
                <param name="alignment_program" value="muscle"/>
                <param name="truncate_marker" value="0"/>
            </section>
            
            <output name="command_log" ftype="json">
                <assert_contents>
                    <has_text text="command"/>
                    <has_text text="date-start"/>
                    <has_text text="date-end"/>
                </assert_contents>
            </output>

            
            <output_collection name="npz_files" type="list">
                <element name="t__GCA_000177055.test_bacteria.npz" ftype="npz">
                    <assert_contents>
                        <has_size value="1311" delta="100"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>

          <test expect_num_outputs="4">
            <param name="reference_genomes" value="test_bacteria.fna" ftype="fasta"/>
            <param name="clade" value="t__GCA_000177055"/>
            <param name="database" value="mpa_vJan21_TOY_CHOCOPhlAnSGB"/>
            <param name="save_marker_aln" value="true"/>
            <section name="alignment">
                <param name="alignment_program" value="mafft"/>
                <param name="truncate_marker" value="0"/>
            </section>
            
            <output name="command_log" ftype="json">
                <assert_contents>
                    <has_text text="command"/>
                    <has_text text="date-start"/>
                    <has_text text="date-end"/>
                </assert_contents>
            </output>
            
            <output_collection name="npz_files" type="list">
                <element name="t__GCA_000177055.test_bacteria.npz" ftype="npz">
                    <assert_contents>
                        <has_size value="467" delta="100"/>
                    </assert_contents>
                </element>
            </output_collection>

            <output_collection name="marker_alignments" type="list" count="1"/>

            <output_collection name="msa_files" type="list">
                <element name="t__GCA_000177055.msa.fa" ftype="fasta">
                    <assert_contents>
                        <has_text text=">"/>
                        <has_size value="514" delta="100"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
       
    </tests>
    <help><![CDATA[
    **SameStr Extract**

    SameStr Extract obtains MetaPhlAn marker sequences from reference genomes using BLASTN. It extracts clade-specific marker 
    sequences for strain-level analysis. The resulting variant profiles can be used in downstream SameStr workflow steps.

    **Input Requirements**

    Samestr Extract can process multiple reference genomes simultaneously. For each analysis, the following inputs must be provided:
    - One or more files in FASTA format (.fasta, .fa, .fna or gzipped versions .fasta.gz, .fa.gz, .fna.gz) containing complete bacterial genomes.
    - The exact clade identifier corresponding to the taxonomic group of interest in the selected database.

    It is not possible to enter multiple bacterial genome files if the file extensions are different. 

    **Alignment parameters**

    - Alignment program. Can be chosen between MUSCLE (default) or MAFFT for multiple sequence alignment of marker sequences.
    - Marker truncation length: Number of nucleotides to trim from each side of marker sequences to remove poorly aligned regions.

    **Additional Parameters**

    - Marker database. The MetaPhlAn clade marker database must be selected. This database must be regenerated with samestr db.
    - Clade to extract. The exact taxonomic identifier for the clade to process. Must match an identifier present in the selected database.
    - Save alignment files. Optionally keep multiple sequence alignment files for individual markers.


    **Results and Outputs**

    The tool generates three main outputs:
    - Command log (JSON format). A detailed execution log of the extraction process.
    - Extracted NPZ files. These are compressed NumPy files (.npz) containing nucleotide variant profiles for the specified clade from each input genome.
    - MSA files. Multiple sequence alignment files in FASTA format (.msa.fa), generated optionally with "Save alignment files".
    ]]></help>
    <citations>
        <citation type="bibtex">
        @software{samestr,
        title = {SameStr},
        author = {Podlesny, Daniel and Fricke, W. Florian},
        year = {2022},
        url = {https://github.com/danielpodlesny/samestr},
        license = {GNU Affero General Public License v3.0},
        }</citation>
    </citations>
</tool>