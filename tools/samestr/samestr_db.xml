<tool id="samestr_db" name="SameStr Database Builder" version="0.1.0+galaxy0" python_template_version="3.5" profile="21.05">
    <description>Build SameStr database from MetaPhlAn markers</description>
    <requirements>
        <requirement type="package" version="1.2025.111">samestr</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        mkdir -p out_db/ &&

        samestr db
        --markers-info "${database.fields.path}/${database.fields.dbkey}.pkl"
        --markers-fasta "${database.fields.path}/${database.fields.dbkey}.fasta"
        --db-version "${database.fields.path}/mpa_latest"
        #if $clade
            --clade '$clade'
        #end if
        --output-dir out_db/
    ]]></command>
    <inputs>

        <param name="database" type="select" label="Marker database" help="MetaPhlAn clade marker database.">
            <options from_data_table="metaphlan_database_versioned">
                <filter type="sort_by" column="2" />
            </options>
        </param>


        <param name="clade" type="text" optional="true" label="Clade selection." help="Names must correspond to the taxonomy of the respective database [e.g. t__SGB10068 for MetaPhlAn]"/>
        
    </inputs>
    <outputs>
        <data name="taxonomy" format="tsv" from_work_dir="out_db/db_taxonomy.tsv" label="${tool.name} on ${on_string}: Db taxonomy"/>
        <data name="command_log" format="json" from_work_dir="out_db/command_log.json" label="${tool.name} on ${on_string}: Command log"/>
        <data name="clades_json" format="json" from_work_dir="out_db/db_clades.json" label="${tool.name} on ${on_string}: Clades log"/>
        <data name="manifest_json" format="json" from_work_dir="out_db/db_manifest.json" label="${tool.name} on ${on_string}: Manifest log"/> 
        <collection name="db_marker_files" type="list" label="${tool.name}: Marker files">
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.(fa|txt|txt\.gz|fa\.gz))$" directory="out_db/db_markers" recurse="true" format="txt"/>
        </collection>

    </outputs>
    <tests>
        <test>
            <param name="database" value="test-db-20210409"/>
            <output name="taxonomy">
                <assert_contents>
                    <has_text text="kingdom"/>
                    <has_text text="phylum"/>
                </assert_contents>
            </output>

            <output name="command_log">
               <assert_contents>
                    <has_text text="command"/>
                    <has_text text="date-start"/>
                    <has_text text="date-end"/>
                </assert_contents>
            </output>

            <output name="clades_json">
                <assert_contents>
                    <has_text text="records"/>
                </assert_contents>
            </output>

            <output name="manifest_json">
                <assert_contents>
                    <has_text text="database"/>
                </assert_contents>
            </output>

            <output_collection name="db_marker_files" type="list"  count="144"/>
        </test>

    </tests>

    <help><![CDATA[
    **SameStr Database Builder**

    SameStr Database Builder constructs a database from MetaPhlAn marker alignments for strain-level comparison analysis.

    **Input Requirements**

    The tool requires MetaPhlAn marker database files as input:
    - Marker information file (.pkl). Contains marker metadata and taxonomy information.
    - Marker sequences file (.fasta). Contains marker nucleotide sequences.
    - Database version file (mpa_latest). Specifies the MetaPhlAn database version.

    **Optional Parameters**
    
    - Clade selection. The exact taxonomic identifier for the clade to process. Must match an identifier present in the selected database.

    **Results and Outputs**

    - Database manifest (db_manifest.json). Metadata and configuration information.
    - Clade information (db_clades.json). Taxonomy and clade-specific data.
    - Marker taxonomy (db_taxonomy.tsv). Taxonomic classification of markers.
    
    - Marker database files. It contains the following files for each clade:

    Marker sequences (.markers.fa.gz): Nucleotide sequences of clade-specific markers in FASTA format.
    Gene Information (.gene_file.txt.gz): Gene annotation data for each marker. 
    Position data (.positions.txt.gz): Genomic positions of variant sites within markers. 
    Contig mapping (.contig_map.txt.gz):  Mapping between markers and reference contigs.  

    ]]></help>
    <citations>
        <citation type="bibtex">
        @software{samestr,
        title = {SameStr},
        author = {Podlesny, Daniel and Fricke, W. Florian},
        year = {2022},
        url = {https://github.com/danielpodlesny/samestr},
        license = {GNU Affero General Public License v3.0},
        }</citation>
    </citations>
</tool>
