<tool id='samestr_summarize' name='SameStr Summarize' version='0.1.0+galaxy0' python_template_version='3.5' profile='21.05'>
    <description>Identify and summarize shared bacterial strains across samples using variant profile similarity</description>
    <requirements>
        <requirement type='package' version='1.2025.111'>samestr</requirement>
    </requirements>
    <command detect_errors='exit_code'><![CDATA[
    mkdir -p out_summarize/ tax_profiles/ out_compare/ &&

    #for $file in $tax_profiles:
        cp '$file' tax_profiles/'$file.element_identifier' &&
    #end for

    #for $input_file in $input_dir:
        cp '$input_file' out_compare/'$input_file.element_identifier' &&
    #end for

    samestr summarize
    --marker-dir '$database.fields.path'
    --input-dir out_compare/
    --output-dir out_summarize/
    --tax-profiles-dir tax_profiles/
    #if $tax_profiles_extension
        --tax-profiles-extension '$tax_profiles_extension'
    #end if
    --aln-pair-min-overlap '$aln_pair_min_overlap'
    --aln-pair-min-similarity '$aln_pair_min_similarity'
    ]]></command>
    <inputs>
        <param name='database' type='select' label='Marker database' help='MetaPhlAn or mOTUs clade marker database.'>
            <options from_data_table='metaphlan_database_versioned'>
                <filter type='sort_by' column='2' />
            </options>
        </param>

        <param name='input_dir' type='data_collection' collection_type='list' format='tabular' label='Samestr compare outputs' help='Add the output directory from samestr compare. Must contain pairwise comparison of alignment files (.fraction.txt, .overlap.txt)'/>
        <param name='tax_profiles' type='data_collection' collection_type='list' format='txt' label='Taxonomic profiles' help='Collection of MetaPhlAn or mOTUs .profile.txt files'/>
        <param name='tax_profiles_extension' type='text' value='.profile.txt' label='Taxonomic profile extension' optional='true' help='File extension of taxonomic profiles (default: .profile.txt)'/>

        <section name='arguments' title='Summary threshold arguments'>
            <param name='aln_pair_min_overlap' type='integer' value='5000' min='0' label='Minimum overlap for comparison' help='Minimum number of overlapping positions required in both alignments to evaluate similarity (default: 5000).' />
            <param name='aln_pair_min_similarity' type='float' value='0.999' min='0' max='1' label='Minimum similarity for shared strains' help='Minimum pairwise alignment similarity to call shared strains (default: 0.999).' />
        </section>

    </inputs>
    <outputs>
        <data name='command_log' format='json' from_work_dir='out_summarize/command_log.json' label='${tool.name} on ${on_string}: Command log'/>
        <data name='cooccurrences' format='tsv' from_work_dir='out_summarize/sstr_cooccurrences.tsv' label='${tool.name} on ${on_string}: Strain co-occurrences'/>
        <data name='strain_events' format='tsv' from_work_dir='out_summarize/sstr_strain_events.tsv' label='${tool.name} on ${on_string}: Strain events'/>
        <data name='taxon_counts' format='tsv' from_work_dir='out_summarize/taxon_counts.tsv' label='${tool.name} on ${on_string}: Taxon counts'/>
    </outputs>
    <tests>
        <test>
            <param name='database' value='mpa_vJan21_TOY_CHOCOPhlAnSGB' />
            <param name='input_dir'>
                <collection type='list'>
                    <element name='t__SGB7985.fraction.txt' value='t__SGB7985.fraction.txt'/>
                    <element name='t__SGB7985.overlap.txt' value='t__SGB7985.overlap.txt'/>
                    <element name='t__SGB7985.closest.txt' value='t__SGB7985.closest.txt'/>
                </collection>
            </param>
            <param name='tax_profiles'>
                <collection type='list'>
                    <element name='29A.profile.txt' value='29A.profile.txt' ftype='txt'/>
                    <element name='28C.profile.txt' value='28C.profile.txt' ftype='txt'/>
                </collection>
            </param>
            
            <section name='arguments'>
                <param name='aln_pair_min_overlap' value='5000' />
                <param name='aln_pair_min_similarity' value='0.999' />
            </section>
            
            <output name='command_log' ftype='json'>
                <assert_contents>
                    <has_text text='command' />
                    <has_text text='date-start' />
                    <has_text text='date-end' />
                </assert_contents>
            </output>
            
            <output name='cooccurrences' ftype='tsv'>
                <assert_contents>
                    <has_text text='row' />
                    <has_text text='col' />
                    <has_text text='shared_kingdom' />
                    <has_text text='shared_phylum' />
                </assert_contents>
            </output>
            
            <output name='strain_events' ftype='tsv'>
                <assert_contents>
                    <has_text text='row' />
                    <has_text text='col' />
                    <has_text text='clade' />
                    <has_text text='similarity' />
                    <has_text text='overlap' />
                </assert_contents>
            </output>
            
            <output name='taxon_counts' ftype='tsv'>
                <assert_contents>
                    <has_text text='Name' />
                    <has_text text='count_kingdom' />
                    <has_text text='count_phylum' />
                    <has_text text='count_class' />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
    **SameStr Summarize**

    SameStr Summarize identifies and summarizes shared bacterial strains across samples based on variant profile similarity. 
    This module generates taxonomic co-occurrence tables at multiple taxonomic levels and provides strain sharing events.

    **Input Requirements**

    The following inputs must be provided:
    - Samestr compare outputs (.fraction.txt, .overlap.txt, .closest.txt) generated by samestr compare, containing pairwise similarity matrices.
    - Taxonomic profile files (.profile.txt) from MetaPhlAn or mOTUs, containing relative abundance data for each sample.
    - The MetaPhlAn or mOTUs clade marker database that matches the database used throughout the workflow.

    **Parameters**

    - Minimum overlap for comparison. Minimum number of overlapping positions which have to be covered in both alignments to evaluate alignment similarity.
    - Minimum similarity for shared strains. Minimum pairwise alignment similarity required to call strains as shared.
    - Taxonomic profile extension (default: .profile.txt). File extension for taxonomic profiles.

    **Results and Outputs**

    - Command log (JSON format). A detailed execution log of the summarize process.
    - Strain co-occurrences (TSV format). Taxonomic co-occurrence counts across different taxonomic levels. Shows how many taxonomic groups are shared between each sample pair.
    - Strain events (TSV format). Detailed strain sharing events between sample pairs.
    - Taxon counts (TSV format). Taxon counts per sample at different taxonomic levels. 
    ]]></help>
    <citations>
        <citation type='bibtex'>
        @software{samestr,
        title = {SameStr},
        author = {Podlesny, Daniel and Fricke, W. Florian},
        year = {2022},
        url = {https://github.com/danielpodlesny/samestr},
        license = {GNU Affero General Public License v3.0},
        }</citation>
    </citations>
</tool>