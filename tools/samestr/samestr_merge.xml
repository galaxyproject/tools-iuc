<tool id="samestr_merge" name="SameStr Merge" version="0.1.0+galaxy0" python_template_version="3.5" profile="21.05">
    <description>Merge nucleotide variant profiles obtained from metagenomic samples for filtering and pairwise comparisons</description>
    <requirements>
        <requirement type="package" version="1.2025.111">samestr</requirement>
        <requirement type="package" version="2.10.1">blast</requirement>
        <requirement type="package" version="3.9">python</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    mkdir -p out_merge/ &&

    #for $i, $file in enumerate($input_files):
        #if str($file.ext) in ['npz','npy']:
            cp '$file' '$file.element_identifier' &&
        #else if str($file.ext) == 'npy.gz':
            cp '$file' '$file.element_identifier' &&
        #end if
    #end for

    samestr merge
    --marker-dir '$database.fields.path'
    --output-dir out_merge/
    --input-files
    #for $file in $input_files:
        '$file.element_identifier'
    #end for
    #if $clade:
        --clade '$clade'
    #end if
    ]]></command>
    <inputs>
        <param name="input_files" type="data" format="npz,npy" multiple="true" label="Input SNV profiles" help="NPZ/NPY files from samestr convert or extract. Select multiple files to merge."/>

        <param name="database" type="select" label="Marker database" help="MetaPhlAn or mOTUs clade marker database.">
            <options from_data_table="metaphlan_database_versioned">
                <filter type="sort_by" column="2" />
            </options>
        </param>

        <param name="clade" type="text" label="Clade to process from input files." optional="true" help="Processing all if not specified. Names must correspond to the taxonomy of the respective database [e.g. t__SGB10068 for MetaPhlAn or ref_mOTU_v3_00095 for mOTUs]"/>

    </inputs>
    <outputs>
        <data name="command_log" format="json" from_work_dir="out_merge/command_log.json" label="${tool.name} on ${on_string}: Command log"/>

        <collection name="npz_files" type="list" label="${tool.name} on ${on_string}: Merged NPZ files">
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.npz)$" directory="out_merge" format="npz"/>
        </collection>

        <collection name="sample_name" type="list" label="${tool.name} on ${on_string}: Sample identifiers">
            <discover_datasets pattern="(?P&lt;designation&gt;.+\.names\.txt)$" directory="out_merge" format="txt"/>
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="input_files" value="t__SGB7985.28C.npz,t__SGB7985.29A.npz" ftype="npz" />
            <param name="database" value="mpa_vJan21_TOY_CHOCOPhlAnSGB" />
            <output name="command_log" ftype="json">
                <assert_contents>
                    <has_text text="command"/>
                    <has_text text="date-start"/>
                    <has_text text="date-end"/>
                </assert_contents>
            </output>
            <output_collection name="npz_files" type="list" count="1">
                <element name="t__SGB7985.npz" ftype="npz">
                    <assert_contents>
                        <has_size value="47473" delta="100" />
                    </assert_contents>
                </element>
            </output_collection>
            <output_collection name="sample_name" type="list" count="1">
                <element name="t__SGB7985.names.txt" ftype="txt">
                    <assert_contents>
                        <has_text text="28C" />
                        <has_text text="29A" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
    **SameStr Merge**

    SameStr Merge combines nucleotide variant profiles obtained from multiple metagenomic samples created by samestr convert,  and/or reference genomes 
    created by samestr extract for subsequent filtering and pairwise strain comparisons.

    **Input Requirements**

    SameStr Merge processes multiple SNV profile files simultaneously. For each analysis, the following inputs must be provided:
    - One or more SNV profile files in NPZ/NPY format (.npz, .npy, or .npy.gz) generated by samestr convert or samestr extract.
    - The MetaPhlAn or mOTUs clade marker database that matches the database used to generate the input files.

    **Parameters**

    - Clade to process. Specify a particular clade to merge. If no clade is specified, samestr merge will process all clades. 

    **Results and Outputs**

    The tool generates three main outputs:
    - Command log (JSON format). A detailed execution log of the merging process.
    - Merged NPZ files. Compressed NumPy files (.npz) containing merged nucleotide variant profiles, one file per clade. Each file contains SNV data from all input samples for that specific clade.
    - Sample identifiers. Text files (.names.txt) listing the sample/gene identifiers included in each merged clade file, with one identifier per line.
    ]]></help>
    <citations>
        <citation type="bibtex">
        @software{samestr,
        title = {SameStr},
        author = {Podlesny, Daniel and Fricke, W. Florian},
        year = {2022},
        url = {https://github.com/danielpodlesny/samestr},
        license = {GNU Affero General Public License v3.0},
        }</citation>
    </citations>
</tool>