<tool id="samestr_convert" name="SameStr Convert" version="0.1.0+galaxy0" python_template_version="3.5" profile="21.05">
    <description>Convert MetaPhlAn marker alignments to nucleotide variant profiles</description>
    <requirements>
        <requirement type="package" version="1.2025.111">samestr</requirement>
        <requirement type="package" version="0.1.19">samtools</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    mkdir -p out_convert/ tax_profiles_dir/ &&

    #for $i, $input in enumerate($input_file): 
        #if str($input.alignment.ext) == 'sam':
            bzip2 -c '$input.alignment' > 'file_${i}.sam.bz2' &&
            cp '$input.profile' 'file_${i}.profile.txt' &&
        #else if str($input.alignment.ext) == 'bam':
            cp '$input.alignment' 'file_${i}.bam' &&
            cp '$input.profile' 'file_${i}.profile.txt' &&
        #end if
    #end for

    samestr convert         
    --input-files
    #for $i, $input in enumerate($input_file): 
        #if str($input.alignment.ext) == 'sam':
            'file_${i}.sam.bz2'
        #else if str($input.alignment.ext) == 'bam':
            'file_${i}.bam'
        #end if
    #end for
    --marker-dir '$database.fields.path'
    --output-dir out_convert/
    --min-vcov '$alignment.min_vcov'
    --min-aln-identity '$alignment.min_aln_identity'
    --min-aln-len '$alignment.min_aln_len'
    --min-base-qual '$alignment.min_base_qual'
    --min-aln-qual '$alignment.min_aln_qual'

    #for $profile in $tax_profiles:
        cp '$profile' tax_profiles_dir/'$profile.element_identifier' &&
    #end for
    #if $tax_profiles_extension
        --tax-profiles-extension '$tax_profiles_extension'
    #end if
    $db_force

    ]]></command>
    <inputs>

        <repeat name="input_file" title="Samples" min="1">
            <param name="alignment" type="data" format="sam,bam" label="Alignment file" help="MetaPhlAn marker alignment."/>
            <param name="profile" type="data" format="txt" label="Taxonomic profile" help="MetaPhlAn taxonomic profile."/>
        </repeat>
        
        <param name="database" type="select" label="Marker database" help="MetaPhlAn clade marker database.">
            <options from_data_table="metaphlan_database_versioned">
                <filter type="sort_by" column="2" />
            </options>
        </param>
        
        <section name="alignment" title="Alignment Parameters">
            <param name="min_aln_identity" type="float" value="0.9" min="0" max="1" label="Percent identity" help="Minimum percent identity in alignment." />
            <param name="min_aln_len" type="integer" value="40" label="Minimum alignment length" help="Minimum alignment length." />
            <param name="min_base_qual" type="integer" value="20" label="Minimum base quality" help="Minimum base call quality." />
            <param name="min_aln_qual" type="integer" value="0" label="Minimum alignment quality" help="Increasing this threshold can drastically reduce the number of considered variants." />
            <param name="min_vcov" type="integer" value="3" label="Minimum vertical coverage" help="Minimum vertical coverage." />
        </section>

        <param name="tax_profiles" type="data_collection" collection_type="list" optional="true" format="txt" label="Taxonomic profiles" help="Collection of MetaPhlAn .profile.txt files"/>
        <param name="tax_profiles_extension" type="text" value=".profile.txt" label="Taxonomic profile extension" help="File extension of taxonomic profiles (default: .profile.txt)"/>

        <param argument="--db-force" type="boolean" truevalue="--db-force" falsevalue="" label="Force database compatibility" help="Force execution, even when database version is not an exact match." />

    </inputs>
    <outputs>
        <data name="command_log" format="json" from_work_dir="out_convert/command_log.json" label="${tool.name} on ${on_string}: Command log"/>
        <data name="stats_file" format="tabular" from_work_dir="out_convert/*/*.aln_stats.txt" label="${tool.name} on ${on_string}:Alignment statistics"/>
        
        <collection name="npz_files" type="list" label="${tool.name} on ${on_string}: Clade NPZ files">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.npz$" directory="out_convert" recurse="true" format="npz"/>
        </collection>
    </outputs>
    <tests>
        <test>
            <repeat name="input_file">
                <param name="alignment" value="test_reads.sam" ftype="sam"/>
                <param name="profile" value="test_reads.profile.txt" ftype="txt"/>
            </repeat>
            <param name="database" value="mpa_vJan21_TOY_CHOCOPhlAnSGB"/>
            <section name="alignment">
                <param name="min_vcov" value="1"/>
                <param name="min_aln_identity" value="0.9"/>
                <param name="min_aln_len" value="40"/>
                <param name="min_base_qual" value="20"/>
                <param name="min_aln_qual" value="0"/>
            </section>
            
            <output name="command_log">
                <assert_contents>
                    <has_text text="command"/>
                    <has_text text="date-start"/>
                    <has_text text="date-end"/>
                </assert_contents>
            </output>

            <output name="stats_file">
                <assert_contents>
                    <has_text text="alignment"/>
                    <has_text text="genome"/>
                    <has_text text="mean_cov"/>
                    <has_text text="n_sites"/>
                    <has_text text="f_covered"/>
                </assert_contents>
            </output>

            <output_collection name="npz_files" type="list" count="1" />


        </test>
        <test>
            <repeat name="input_file">
                <param name="alignment" value="test_reads.bam" ftype="bam"/>
                <param name="profile" value="test_reads.profile.txt" ftype="txt"/>
            </repeat>
            <param name="database" value="mpa_vJan21_TOY_CHOCOPhlAnSGB"/>
            <section name="alignment">
                <param name="min_vcov" value="1"/>
                <param name="min_aln_identity" value="0.9"/>
                <param name="min_aln_len" value="40"/>
                <param name="min_base_qual" value="20"/>
                <param name="min_aln_qual" value="0"/>
            </section>
            
            <output name="command_log">
                <assert_contents>
                    <has_text text="command"/>
                    <has_text text="date-start"/>
                    <has_text text="date-end"/>
                </assert_contents>
            </output>
            <output name="stats_file">
                <assert_contents>
                    <has_text text="alignment"/>
                    <has_text text="genome"/>
                    <has_text text="mean_cov"/>
                    <has_text text="n_sites"/>
                    <has_text text="f_covered"/>
                </assert_contents>
            </output>
            
            <output_collection name="npz_files" type="list" count="1" />
        </test>

        <test>
            <repeat name="input_file">
                <param name="alignment" value="test_reads.sam.bz2" ftype="sam"/>
                <param name="profile" value="test_reads.profile.txt" ftype="txt"/>
            </repeat>
            <param name="database" value="mpa_vJan21_TOY_CHOCOPhlAnSGB"/>
            <section name="alignment">
                <param name="min_vcov" value="1"/>
                <param name="min_aln_identity" value="0.9"/>
                <param name="min_aln_len" value="40"/>
                <param name="min_base_qual" value="20"/>
                <param name="min_aln_qual" value="0"/>
            </section>
            
            <output name="command_log">
                <assert_contents>
                    <has_text text="command"/>
                    <has_text text="date-start"/>
                    <has_text text="date-end"/>
                </assert_contents>
            </output>
            <output name="stats_file">
                <assert_contents>
                    <has_text text="alignment"/>
                    <has_text text="genome"/>
                    <has_text text="mean_cov"/>
                    <has_text text="n_sites"/>
                    <has_text text="f_covered"/>
                </assert_contents>
            </output>
            <output_collection name="npz_files" type="list" count="1" />

        </test>
    </tests>

    <help><![CDATA[
    **SameStr Convert**
    
    SameStr Convert processes marker gene alignments from taxonomic profiling tools (MetaPhlAn) to nucleotide variant profiles 
    for strain-level analysis. It outputs per-clade variant profiles that can be used in downstream SameStr workflow steps. 

    **Input Requirements**

    Samestr Convert can process multiple samples simultaneously. For each sample the following files must be provided:
    - A file in SAM (.sam), compressed SAM (.sam.bz2), or BAM (.bam) format containing marker alignments generated by MetaPhlAn.
    - A taxonomic profile file (.profile.txt) corresponding to the alignment.
    
    It is not possible to enter multiple samples if the file extensions of the taxonomic profiles are different. 

    **Alignment Parameters**

    - Marker database. A MetaPhlAn clade marker database which matches the version used to generate the input alignments must be selected. 
    - Percent identity. Minimum percent identity between read and marker sequence. Alignments with lower identity are filtered out. 
    - Minimum alignment length. Minimum number of aligned bases required. Shorter alignments are discarded.
    
    **Additional Parameters**
    
    - Taxonomic profile directory (.profile.txt) from MetaPhlAn, containing relative abundance data for each sample. When not specified, will look for profiles in "input-files" directory.
    - Force database compatibility. Force execution, even when database version is not an exact match. 

    **Results and Outputs**

    The tool generates three main outputs:
    - Command log (JSON format). A detailed execution log of the conversion process.
    - Alignment statistics (".aln_stats.txt"). Contains a summary table with statistics for each processed alignment.
    - Clade NPZ files. A collection of compressed NumPy files (.npz). Each file contains the nucleotide variant profile for a specific clade.
    ]]></help>
    <citations>
        <citation type="bibtex">
        @software{samestr,
        title = {SameStr},
        author = {Podlesny, Daniel and Fricke, W. Florian},
        year = {2022},
        url = {https://github.com/danielpodlesny/samestr},
        license = {GNU Affero General Public License v3.0},
        }</citation>
    </citations>
</tool>