<tool id="deacon_index" name="Deacon Index" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>deacon index building tool for deacon filter</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code">
        <![CDATA[

        #if $operation.is_select == "build"
            @DEACON_BUILD@
        #else if $operation.is_select == "union" 
            @DEACON_UNION@
        #else if $operation.is_select == "intersect"
            @DEACON_INTERSECT@
        #else if $operation.is_select == "diff"
            @DEACON_DIFF@
        #else
            @DEACON_DUMP@
        #end if
        
        ]]>
    </command>
    <inputs>
        <conditional name="operation">
            <param name="is_select" type="select" label="Select which operation you want to use">
                <option value="build">Build index file form fasta/fastq file</option>
                <option value="union">Union index files</option>
                <option value="intersect">Intersect index files</option>
                <option value="diff">Subtract minimizers in one index file</option>
                <option value="dump">Dump minimizer index to fasta</option>
            </param>
            <when value="build">
                <expand macro="deacon_build"/>
            </when>
            <when value="union">
                <expand macro="deacon_union"/>
            </when>
            <when value="intersect">
                <expand macro="deacon_intersect"/>
            </when>
            <when value="diff">
                <expand macro="deacon_diff"/>
            </when>
            <when value="dump">
                <expand macro="deacon_dump"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="index_output" format="deacon.idx" label="${tool.name} on ${on_string}: Create new index file">
            <filter>operation['is_select'] != 'dump'</filter>
        </data>
        <data name="fasta_output" format="fasta" label="${tool.name} on ${on_string}: Dump index into fasta">
            <filter>operation['is_select'] == 'dump'</filter>
        </data>
    </outputs>
    <tests>
    <!-- TEST FOR DEACON BUILD -->
       <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="is_select" value="build"/>
                <param name="input" value="Test.fastq.gz" ftype="fastq.gz"/>  
                <param name="k" value="5"/>
                <param name="w" value="3"/>
                <param name="e" value="0.1"/>
            </conditional>
            <output name="index_output" value="Test_option.deacon.idx" ftype="deacon.idx"/> 
       </test> 
       <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="is_select" value="build"/>
                <param name="input" value="Test.fastq.gz" ftype="fastq.gz"/>
            </conditional>
            <output name="index_output" value="Test_fastq_gz.deacon.idx" ftype="deacon.idx"/> 
       </test>
    <!-- TEST FOR DEACON BUILD END -->
    <!-- TEST FOR DEACON UNION -->
       <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="is_select" value="union"/>
                <repeat name="deacon_repeat">
                    <conditional name="file_input">
                        <param name="is_select" value="own"/>
                        <param name="file" value="A1_forward.deacon.idx" ftype="deacon.idx"/>
                    </conditional>
                </repeat>
                <repeat name="deacon_repeat">
                    <conditional name="file_input">
                        <param name="is_select" value="own"/>
                        <param name="file" value="A1_reverse.deacon.idx" ftype="deacon.idx"/>
                    </conditional>
                </repeat>
            </conditional>
            <output name="index_output" value="A1.deacon.idx" ftype="deacon.idx"/>
       </test>
       <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="is_select" value="union"/>
                <repeat name="deacon_repeat">
                    <conditional name="file_input">
                        <param name="is_select" value="dm"/>
                        <param name="from_dm" value="test_index"/>
                    </conditional>
                </repeat>
                <repeat name="deacon_repeat">
                    <conditional name="file_input">
                        <param name="is_select" value="own"/>
                        <param name="file" value="A1_reverse.deacon.idx" ftype="deacon.idx"/>
                    </conditional>
                </repeat>
            </conditional>
            <output name="index_output" value="A1.deacon.idx" ftype="deacon.idx"/>
       </test>
    <!-- TEST FOR DEACON UNION END -->
    <!-- TEST FOR DEACON INTERSECT -->
       <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="is_select" value="intersect"/>
                <repeat name="deacon_repeat">
                    <conditional name="file_input">
                        <param name="is_select" value="own"/>
                        <param name="file" value="A1.deacon.idx" ftype="deacon.idx"/>
                    </conditional>
                </repeat>
                <repeat name="deacon_repeat">
                    <conditional name="file_input">
                        <param name="is_select" value="own"/>
                        <param name="file" value="A1_forward.deacon.idx" ftype="deacon.idx"/>
                    </conditional>
                </repeat>
            </conditional>
            <output name="index_output" value="A1_forward.deacon.idx" ftype="deacon.idx"/>
       </test>
       <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="is_select" value="intersect"/>
                <repeat name="deacon_repeat">
                    <conditional name="file_input">
                        <param name="is_select" value="dm"/>
                        <param name="from_dm" value="test_index"/>
                    </conditional>
                </repeat>
                <repeat name="deacon_repeat">
                    <conditional name="file_input">
                        <param name="is_select" value="own"/>
                        <param name="file" value="A1_forward.deacon.idx" ftype="deacon.idx"/>
                    </conditional>
                </repeat>
            </conditional>
            <output name="index_output" value="A1_forward.deacon.idx" ftype="deacon.idx"/>
        </test>
    <!-- TEST FOR DEACON INTERSECT END -->
    <!-- TEST FOR DEACON DIFF -->
        <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="is_select" value="diff"/>
                <conditional name="first_file">
                    <param name="is_select" value="own"/>
                    <param name="file" value="A1.deacon.idx" ftype="deacon.idx"/>
                </conditional>
                <conditional name="second_file">
                    <param name="is_select" value="index"/>
                    <conditional name="file_input">
                        <param name="is_select" value="own"/>
                        <param name="file" value="A1_forward.deacon.idx" ftype="deacon.idx"/>
                    </conditional>
                </conditional>
            </conditional>
            <output name="index_output" value="A1_reverse.deacon.idx" ftype="deacon.idx"/>
        </test>
        <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="is_select" value="diff"/>
                <conditional name="first_file">
                    <param name="is_select" value="dm"/>
                    <param name="from_dm" value="test_index"/>
                </conditional>
                <conditional name="second_file">
                    <param name="is_select" value="index"/>
                    <conditional name="file_input">
                        <param name="is_select" value="own"/>
                        <param name="file" value="A1_forward.deacon.idx" ftype="deacon.idx"/>
                    </conditional>
                </conditional>
            </conditional>
            <output name="index_output" value="A1_reverse.deacon.idx" ftype="deacon.idx"/>
        </test>
        <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="is_select" value="diff"/>
                <conditional name="first_file">
                    <param name="is_select" value="own"/>
                    <param name="file" value="A1.deacon.idx" ftype="deacon.idx"/>
                </conditional>
                <conditional name="second_file">
                    <param name="is_select" value="fastx"/>
                    <param name="fastx_file" value="A1_forward.fastq.gz" ftype="fastq.gz"/>
                    <param name="k" value="31"/>
                    <param name="w" value="15"/> 
                </conditional>
            </conditional>
            <output name="index_output" value="A1_plus_reverse.deacon.idx" ftype="deacon.idx"/>
        </test>
    <!-- TEST FOR DEACON DIFF END -->
    <!-- TEST FOR DEACON DUMP -->
        <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="is_select" value="dump"/>
                <conditional name="file_input">
                    <param name="is_select" value="own"/>
                    <param name="file" value="A1.deacon.idx" ftype="deacon.idx"/>
                </conditional>
            </conditional>
            <output name="fasta_output" value="A1_index.fasta" ftype="fasta"/>
        </test>
        <test expect_num_outputs="1">
            <conditional name="operation">
                <param name="is_select" value="dump"/>
                <conditional name="file_input">
                    <param name="is_select" value="dm"/>
                    <param name="from_dm" value="test_index"/>
                </conditional>
            </conditional>
            <output name="fasta_output" value="A1_index.fasta" ftype="fasta"/>
        </test>
    <!-- TEST FOR DEACON DUMP END -->
    </tests>
    <help>
        <![CDATA[
        
            **WHAT DOES THIS TOOL**

            This tool creates index files which will be used for Deacon filter. This tool also allowed to have different operation with index files like create an union index file.

            **OPERATION WHICH CAN BE USED**

            ============== ======================================== =================================== ==========
            Operation name What it does                             Input                               Output
            ______________ ________________________________________ ___________________________________ __________
            build          build index file from a fasta/fastq file fasta/fastq file                    index file
            union          union 2 or more index files              index files                         index file
            intersect      intersect 2 or more index files          index files                         index file
            diff           check difference from a index file       index file + index/fasta/fastq file index file
            dump           dump index file content into fasta file  index file                          fasta file
            ============== ======================================== =================================== ==========


        ]]>
    </help>
    <expand macro="citation"/>
</tool>