<tool id="tracy_decompose" name="tracy decompose" version="@TOOL_VERSION@+galaxy0" profile="20.09" python_template_version="3.5">
    <description>Deconvolute heterozygous mutations (and call variants)</description>
    <macros>
        <import>macros.xml</import>
    </macros>    
    <expand macro="requirements" /> 
    <expand macro="version_command" />
    <command detect_errors="exit_code"><![CDATA[
        tracy decompose 
          --genome '$genome'
          $callVariants
          --pratio $pratio 
          --kmer $kmer.kmer 
          --support $kmer.support 
          --maxindel $maxindel 
          --trim $trim.trim 
          --trimLeft $trim.trimLeft 
          --trimRight $trim.trimRight 
          --linelimit $linelimit 
          --gapopen $alignment.gapopen
          --gapext $alignment.gapext
          --match $alignment.match
          --mismatch $alignment.mismatch
          '$tracefile'
    ]]></command>
    <inputs>
        <param argument="--genome" type="data" format="fasta,fasta.gz,ab1" label="FASTA or ABI format genome" />
        <param name="tracefile" type="data" format="ab1" label="Sanger chromatogram tracefile to align" />
        <param argument="--callVariants" type="boolean" truevalue="--callVariants" falsevalue="" label="Call variants in chromatogram" />
        <!-- annotate option is not yet supported -->
        <expand macro="common_options" />
        <expand macro="kmer_options" />
        <expand macro="alignment_options" />
        <expand macro="trim_options" />
    </inputs>
    <outputs>
        <data name="out_json" format="json" from_work_dir="out.json" label="tracy decompose JSON on ${on_string}" />
        <data name="out_fasta1" format="fasta" from_work_dir="out.align1" label="tracy decompose allele1 on ${on_string}" />
        <data name="out_fasta2" format="fasta" from_work_dir="out.align2" label="tracy decompose allele2 on ${on_string}" />
        <data name="out_fasta3" format="fasta" from_work_dir="out.align3" label="tracy decompose both alleles on ${on_string}" />
        <data name="out_stats" format="tabular" from_work_dir="out.abif" label="tracy decompose stats on ${on_string}">
            <actions>
                <action name="column_names" type="metadata" default="pos,peakA,peakC,peakG,peakT,basenum,primary,secondary,consensus,qual,trim" />
            </actions>
        </data>
        <data name="out_bcf" format="bcf" from_work_dir="out.bcf" label="tracy decompose variants on ${on_string}">
            <filter>callVariants</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="genome" value="reference1.fasta" ftype="fasta" />
            <param name="tracefile" value="input1.ab1" ftype="ab1" />
            <!-- removed because file is too large -->
            <!-- <output name="out_json" value="out2.json" ftype="json" lines_diff="2" /> -->
            <!-- <output name="out_stats" value="out1.tabular" ftype="tabular" /> -->
            <output name="out_fasta1" value="out1.align1.fasta" ftype="fasta" />    
            <output name="out_fasta2" value="out1.align2.fasta" ftype="fasta" />    
            <output name="out_fasta3" value="out1.align3.fasta" ftype="fasta" />    
        </test>
        <test>
            <param name="genome" value="reference1.fasta" ftype="fasta" />
            <param name="tracefile" value="input1.ab1" ftype="ab1" />
            <param name="callVariants" value="true" />
            <!-- removed because file is too large -->
            <!-- <output name="out_json" value="out5.json" ftype="json" lines_diff="2" /> -->
            <!-- <output name="out_stats" value="out1.tabular" ftype="tabular" /> -->
            <output name="out_fasta1" value="out1.align1.fasta" ftype="fasta" />    
            <output name="out_fasta2" value="out1.align2.fasta" ftype="fasta" />    
            <output name="out_fasta3" value="out1.align3.fasta" ftype="fasta" />    
            <output name="out_bcf" compare="sim_size" value="out1.bcf" ftype="bcf" />
        </test>
    </tests>
    <help><![CDATA[
**What this does**

Double-peaks in a trace file can cause alignment issues. This tool uses tracy_ to decompose 
heterozygous variants in a trace file into two separate alleles. Each allele is then aligned
separately to the reference sequence.

Optionally, variants between the trace file and the reference are also output in BCF format.

@pratio@

@trim_options@

@alignment@

Read more here_.

.. _tracy: https://github.com/gear-genomics/tracy
.. _here: https://www.gear-genomics.com/docs/tracy/cli/#deconvolution-of-heterozygous-mutations
    ]]></help>
    <expand macro="citations" />
</tool>