<tool id="egsea" name="EGSEA" version="1.6.0.0">
    <description> easy and efficient ensemble gene set testing</description>
    <requirements>
        <requirement type="package" version="1.6.0">bioconductor-egsea</requirement>
    </requirements>
    <version_command><![CDATA[
echo $(R --version | grep version | grep -v GNU)", EGSEA version" $(R --vanilla --slave -e "library(EGSEA); cat(sessionInfo()\$otherPkgs\$EGSEA\$Version)" 2> /dev/null | grep -v -i "WARNING: ")
    ]]></version_command>
    <command detect_errors="exit_code"><![CDATA[
mkdir ./report_dir  &&
mkdir '$outReport.extra_files_path' &&

#if $advanced.rscriptOpt:
    cp '${egsea_script}' '${outRscript}' &&
#end if

Rscript '${egsea_script}' &&

cp ./report_dir/index.html '$outReport' &&
cp -r ./report_dir/* '$outReport.extra_files_path'

    ]]></command>
    <configfiles>
        <configfile name="egsea_script"><![CDATA[
options( show.error.messages=F, error = function () { cat( geterrmessage(), file=stderr() ); q( "no", 1, F ) } )

# we need that to not crash galaxy with an UTF8 error on German LC settings.
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

suppressPackageStartupMessages(library(EGSEA))

species <- "${species}"

base_methods <- "${base_methods}"
base_methods <- unlist(strsplit(base_methods, ","))

if ("${msigdb.msigdb_gsets}" != "None") {
    msigdb_gsets <- "${msigdb.msigdb_gsets}"
    msigdb_gsets <- unlist(strsplit(msigdb_gsets, ","))
} else {
    msigdb_gsets <- "none"
}

if ("${keggdb.keggdb_gsets}" != "None") {
    keggdb_gsets <- "${keggdb.keggdb_gsets}"
    keggdb_gsets <- unlist(strsplit(keggdb_gsets, ","))
    kegg_all <- c("Metabolism"="keggmet", "Signaling"="keggsig", "Disease"="keggdis")
    kegg_exclude <- names(kegg_all[!(kegg_all %in% keggdb_gsets)])
} else {
    kegg_exclude <- "all"
}

if ("${gsdb.gsdb_gsets}" != "None") {
    gsdb_gsets <- "${gsdb.gsdb_gsets}"
    gsdb_gsets <- unlist(strsplit(gsdb_gsets, ","))
} else {
    gsdb_gsets <- "none"
}

display_top <- "${advanced.display_top}"
min_size <- "${advanced.min_size}"
fdr_cutoff <- "${advanced.fdr_cutoff}"
combine_method <- "${advanced.combine_method}"
sort_method <- "${advanced.sort_method}"

counts <- read.table('$counts', sep='\t', row.names=1, header=TRUE)
counts <- as.matrix(counts)
group <- read.table('$group', sep='\t')
group <- factor(group[,1])
genes <- read.table('$genes', sep='\t', header=TRUE)

## Index gene sets

gs.annots <- buildIdx(entrezIDs=rownames(counts), species=species, msigdb.gsets=msigdb_gsets, gsdb.gsets=gsdb_gsets, kegg.exclude=kegg_exclude)

## Run egsea.cnt

gsa <- egsea.cnt(counts=counts, group=group, gs.annots=gs.annots, symbolsMap=genes, baseGSEAs=base_methods, minSize=min_size, display.top=display_top, combineMethod=combine_method, sort.by=sort_method, report.dir='./report_dir', fdr.cutoff=fdr_cutoff, num.threads=2, report=TRUE)

# Output RData file

if (${advanced.rdaOpt}) {
    save.image(file = "EGSEA_analysis.RData")
}
        ]]></configfile>
    </configfiles>
    <inputs>
        <param name="counts" type="data" format="tabular" label="Counts Matrix"
         help="A count matrix with Entrez Gene IDs in the first column and raw RNA-seq counts for samples in the subsequent columns"/>

        <param name="group" type="data" format="tabular"
            label="Group file"
            help="A file of group names for the samples in the format shown in the Help section below. The order of the names must match the order of the samples in the columns of the count matrix."/>

        <param name="genes" type="data" format="tabular"
            label="Symbols Mapping file"
            help="A file of Entrez Gene IDs mapped to Gene symbols in the format shown in the Help section below."/>

        <param name="species" type="select" label="Species" help="Default: Human">
            <option value="human" selected="True">Human</option>
            <option value="mouse">Mouse</option>
            <option value="rat">Rat</option>
        </param>

        <param name="base_methods" type="select" display="checkboxes" multiple="True" min="3" label="Gene Set Testing Methods" help="Select at least 3 gene set testing methods">
            <option value="camera" selected="True">camera</option>
            <option value="safe">safe</option>
            <option value="gage">gage</option>
            <option value="zscore">zscore</option>
            <option value="gsva">gsva</option>
            <option value="globaltest" selected="True">globaltest</option>
            <option value="ora" selected="True">ora</option>
            <option value="ssgsea">ssgsea</option>
            <option value="padog">padog</option>
            <option value="plage">plage</option>
            <option value="fry">fry</option>
            <option value="roast">roast</option>
        </param>

        <section name="msigdb" title="MSigDB Gene Sets" expanded="True">
            <param name="msigdb_gsets" type="select" display="checkboxes" optional="True" multiple="True" label="MSigDB Gene Set Collections" help="Choose any MSigDB Gene Set Collections you want to use. Default: H: hallmark gene sets (human only)">
                <option value="h" selected="True">H: hallmark gene sets</option>
                <option value="c1">C1: positional gene sets</option>
                <option value="c2">C2: curated gene sets</option>
                <option value="c3">C3: motif gene sets</option>
                <option value="c4">C4: computational gene sets</option>
                <option value="c5">C5: GO gene sets</option>
                <option value="c6">C6: oncogenic gene sets</option>
                <option value="c7">C7: immunologic gene sets</option>
            </param>
        </section>

        <section name="keggdb" title="KEGG Pathways" expanded="True">
            <param name="keggdb_gsets" type="select" display="checkboxes" optional="True" multiple="True" label="KEGG Pathways" help="Choose any KEGG Pathways you want to use. Default: None">
                <option value="keggmet">Metabolism pathways</option>
                <option value="keggsig">Signalling pathways</option>
                <option value="keggdis">Disease pathways</option>
            </param>
        </section>

        <section name="gsdb" title="GeneSetDB Gene Sets" expanded="True">
            <param name="gsdb_gsets" type="select" display="checkboxes" optional="True" multiple="True" label="GeneSigDB Gene Set Collections" help="Choose any GeneSetDB Gene Set Collections you want to use. Default: None">
                <option value="gsdbpath">Pathway collection</option>
                <option value="gsdbdis">Disease/Phenotype collection</option>
                <option value="gsdbdrug">Drug/Chemical collection</option>
                <option value="gsdbreg">Gene Regulation collection</option>
                <option value="gsdbgo">Gene Ontology collection</option>
            </param>
        </section>

        <section name="advanced" title="Advanced Options">
            <param name="display_top" type="integer" value="5" min="1" max="20" label="Top Gene Sets to display" help="Set the number of top gene sets to display. Increasing this number increases the time to run, in order to generate the additional plots etc."/>
            <param name="min_size" type="integer" min="0" value="2" label="Minimum Size of Gene Set" help="Minimum size of a gene set to be included in the analysis. Default: 2" />
            <param name="fdr_cutoff" type="float" value="0.05" min="0" max="1" label="FDR cutoff" help="Cut-off threshold of differentially expressed genes used for the calculation of Significance Score and Regulation Direction. Default: 0.05"/>
            <param name="combine_method" type="select" label="Combine Method" help="Method to use to combine the p-values from the different gene set testing methods. Default: wilkinson">
                <option value="wilkinson" selected="True">wilkinson</option>
                <option value="fisher">fisher</option>
                <option value="average">average</option>
                <option value="logitp">logitp</option>
                <option value="sump">sump</option>
                <option value="sumz">sumz</option>
                <option value="votep">votep</option>
                <option value="median">median</option>
            </param>
            <param name="sort_method" type="select" label="Sort Method" help="Select method to sort the results. Any of EGSEA’s combined scores or the rankings from individual base methods can be used for sorting the results. Default: med.rank">
                <option value="p.adj">p.adj</option>
                <option value="p.value">p.value</option>
                <option value="vote.rank">vote.rank</option>
                <option value="avg.rank">avg.rank</option>
                <option value="med.rank" selected="True">med.rank</option>
                <option value="min.pvalue">min.pvalue</option>
                <option value="min.rank">min.rank</option>
                <option value="avg.logfc">avg.logfc</option>
                <option value="avg.logfc.dir">avg.logfc.dir</option>
                <option value="direction">direction</option>
                <option value="significance">significance</option>
                <option value="camera">camera</option>
                <option value="roast">roast</option>
                <option value="safe" >safe</option>
                <option value="gage">gage</option>
                <option value="padog">padog</option>
                <option value="plage">plage</option>
                <option value="zscore">zscore</option>
                <option value="gsva">gsva</option>
                <option value="ssgsea">ssgsea</option>
                <option value="globaltest">globaltest</option>
                <option value="ora">ora</option>
                <option value="fry">fry</option>
            </param>
            <param name="rscriptOpt" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="False" label="Output Rscript?" help="If this option is set to Yes, the Rscript used to annotate the IDs will be provided as a text file in the output. Default: No"/>
            <param name="rdaOpt" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="False" label="Output RData file?" help="Output all the data used by R to construct the tables and plots, can be loaded into R. Default: No" />
        </section>
    </inputs>

    <outputs>
        <data name="outReport" format="html" label="${tool.name} on ${on_string}: Report"/>
        <data name="outRscript" format="txt" from_work_dir="*.txt" label="${tool.name} on ${on_string}: Rscript">
            <filter>advanced['rscriptOpt'] is True</filter>
        </data>
        <data name="outRdata" format="rdata" from_work_dir="EGSEA_analysis.RData" label="${tool.name} on ${on_string}: RData file">
            <filter>advanced['rdaOpt'] is True</filter>
        </data>
    </outputs>

    <tests>
        <test>
            <param name="counts" ftype="tabular" value="il13.counts"/>
            <param name="genes" value="il13.genes"/>
            <param name="group" value="il13.group"/>
            <param name="rscriptOpt" value="TRUE"/>
            <output name="outReport" value="out_il13.html" compare="sim_size"/>
            <output name="outReport">
                <assert_contents>
                    <has_text text="Gene Set Testing Report" />
                </assert_contents>
            </output>
            <output name="outRscript" value="out_il13.txt" compare="sim_size"/>
        </test>
    </tests>

    <help><![CDATA[

.. class:: infomark

**What it does**

EGSEA_, an acronym for *Ensemble of Gene Set Enrichment Analyses*, is a `Bioconductor package`_ that utilizes the analysis results of eleven prominent GSE algorithms from the literature to calculate collective significance scores for gene sets. These methods are currently: **ora, globaltest, plage, safe, zscore, gage, ssgsea, roast, fry, padog, camera, gsva**. The ora, gage, camera and gsva methods depend on a competitive null hypothesis while the remaining seven methods are based on a self-contained hypothesis. EGSEA’s gene set database, the **EGSEAdata** Bioconductor package, contains around 25,000 gene sets from 16 collections from MSigDB_, KEGG_ and GeneSetDB_. Supported organisms are human, mouse and rat, however MSigDB is only available for human and mouse. An example `EGSEA workflow`_ is available at the Bioconductor workflows website.

Currently the **egsea.cnt** function is implemented in this tool. This function takes a raw RNA-Seq count matrix and uses **limma-voom** with TMM normalization to convert the RNA-seq counts into expression values for EGSEA analysis. EGSEA returns a HTML report of detailed analysis results for each contrast of interest and comparative analysis results.

.. _EGSEA: https://www.ncbi.nlm.nih.gov/pubmed/27694195
.. _Bioconductor package: https://bioconductor.org/packages/release/bioc/html/EGSEA.html
.. _MSigDB: http://software.broadinstitute.org/gsea/msigdb
.. _KEGG: http://www.genome.jp/kegg/
.. _GeneSetDB: http://genesetdb.auckland.ac.nz/haeremai.html
.. _EGSEA workflow: https://www.bioconductor.org/help/workflows/EGSEA123/

-----

**Inputs**

**Counts Matrix**

This tool requires a counts matrix (counts table) containing the raw RNA-seq read counts. The first column must contain Entrez Gene IDs that are unique (not repeated) within the counts file. Entrez IDs can be obtained from the **annotateMyIDs** Galaxy tool.

Example:

    =============== ========== ========== ========== ========= ========= =========
    Entrez Gene ID  **Ctl-1**  **Ctl-2**  **Ctl-3**  **Trt-1** **Trt-2** **Trt-3**
    =============== ========== ========== ========== ========= ========= =========
    1               71         73         69         36         22        28
    1000            3          4          2          4          0         1
    10000           2310       2142       2683       1683       2068      2172
    100009605       3          1          2          1          5         3
    100009613       9          11         4          13         6         10
    =============== ========== ========== ========== ========= ========= =========

**Symbols Mapping file**

A table containing the Gene Symbol for each Entrez Gene ID. The first column must be the Entrez Gene IDs and the second column must be the Gene Symbols. It is used for the heatmap visualization. The number of rows should match that of the Counts Matrix.

Example:

    ========= =========
    FeatureID Symbols
    ========= =========
    1         A1BG
    1000      CDH2
    10000     AKT3
    100009605 TRNAF1
    100009613 ANO1-AS2
    ========= =========

**Groups file**

A one-column file containing the group that the samples belongs to. The order must match the order of the samples in the columns of the counts table.

Example:

    +-------+
    | Ctl   |
    +-------+
    | Ctl   |
    +-------+
    | Ctl   |
    +-------+
    | Trt   |
    +-------+
    | Trt   |
    +-------+
    | Trt   |
    +-------+

-----

**Outputs**

The EGSEA report is an interactive HTML report that is generated to enable a swift navigation through the results of an EGSEA analysis. The pages below are generated for each gene set collection and contrast/comparison.

**Stats Table page**

The Stats Table page shows the detailed statistics of the EGSEA analysis for the top gene sets. It shows the EGSEA scores, individual rankings and additional annotation for each gene set. Hyperlinks to the source of each gene set can be seen in this table when they are available. The "Direction" column shows the regulation direction of a gene set which is calculated based on the logFC, which is either calculated from the limma differential expression analysis or provided by the user. The logFC cutoff and FDR cutoff are applied for this calculation. The calculations of the EGSEA scores can be seen in the references section. The method topSets can be used to generate custom Stats Table.

**Heatmaps page**

The Heatmaps page shows the heatmaps of the gene fold changes for the gene sets that are presented in the Stats Table page. Red indicates up-regulation while blue indicates down-regulation. Only genes that appear in the input expression/count matrix are visualized in the heat map. Gene names are coloured based on their statistical significance in the limma differential expression analysis. The "Interpret Results" link below each heat map allows the user to download the original heat map values along with additional statistics from limma DE analysis ( if available) so that they can be used to perform further analysis in R, e.g., customizing the heat map visualization. Additional heat maps can be generated and customized using the method plotHeatmap.

**Summary Plots page**

The Summary Plots page shows the methods ranking plot along with the summary plots of EGSEA analysis. The method plot uses multidimensional scaling (MDS) to visualize the ranking of individual methods on a given gene set collection. The summary plots are bubble plots that visualize the distribution of gene sets based on the EGSEA Significance Score and another EGSEA score (default, p-value). Two summary plots are generated: ranking and directional plots. Each gene set is reprersented with a bubble which is coloured based on the EGSEA ranking (in ranking plots ) or gene set regulation direction (in directional plots) and sized based on the gene set cardinality (in ranking plots) or EGSEA Significance score (in directional plots). Since the EGSEA "Significance Score" is proportional to the p-value and the absolute fold changes, it could be useful to highlight gene sets that have high Significance scores. The blue labels on the summary plot indicate gene sets that do not appear in the top 10 list of gene sets based on the "sort.by" argument (black labels) yet they appear in the top 5 list of gene sets based on the EGSEA "Significance Score". If two contrasts are provided, the rank is calculated based on the "comparison" analysis results and the "Significance Score" is calculated as the mean. If sort.by = NULL, the slot sort.by of the object is used to order gene sets. The method plotSummary can be used to customize the Summary plots by changing the x-axis score and filtering bubbles based on the values of the x-axis. The method plotMethods can be used to generate Methods plots.

**Pathways page**

The Pathways page shows the KEGG pathways for the gene sets that are presented in the Stats Table of a KEGG gene set collection. The gene fold changes are overlaid on the pathway maps and coloured based on the gene regulation direction: blue for down-regulation and red for up-regulation. The method plotPathway can be used to generate additional pathway maps. Note that this page only appears if a KEGG gene set collection is used in the EGSEA analysis.

**GO Graphs page**

The GO Graphs page shows the Gene Ontology graphs for top 5 GO terms in each of three GO categories: Biological Processes (BP), Molecular Functions (MF), and Cellular Components (CC). Nodes are coloured based on the default sort.by score where red indicates high significance and yellow indicates low significance. The method plotGOGraph can be used to customize GO graphs by changing the default sorting score and the number of significance nodes that can be visualized. It is recommended that a small number of nodes is selected. Note that this page only appears if a Gene Ontology gene set collection is used, i.e., for the c5 collection from MSigDB or the gsdbgo collection from GeneSetDB.

**Interpret Results link**

The Interpret Results hyperlink in the EGSEA report allows the user to download the fold changes and limma analysis results and thus improve the interpretation of the results.

.. class:: warningmark

Note that the running time of this tool depends on a number of things, including the number of samples and contrasts provided as input, and also the number of gene set testing methods and gene set collections chosen. For example, the `egsea.cnt example`_ in the EGSEA vignette was conducted with 8 samples and 2 contrasts, using the KEGG signaling and disease pathways, and 7 of the 12 gene set testing methods on a MacBook Pro machine that had a 2.8 GHz Intel Core i7 CPU and 16 GB of RAM. The execution time took 145.5 seconds using 16 threads.

.. _egsea.cnt example: https://bioconductor.org/packages/release/bioc/vignettes/EGSEA/inst/doc/EGSEA.pdf

-----

**More Information**

**MSigDB Gene Set Colletions**

The MSigDB_ gene sets are divided into 8 major collections:

* **H: hallmark gene sets**  are coherently expressed signatures derived by aggregating many MSigDB gene sets to represent well-defined biological states or processes.
* **C1: positional gene sets** for each human chromosome and cytogenetic band.
* **C2: curated gene sets** are from online pathway databases, publications in PubMed, and knowledge of domain experts.
* **C3: motif gene sets** are based on conserved cis-regulatory motifs from a comparative analysis of the human, mouse, rat, and dog genomes.
* **C4: computational gene sets** are defined by mining large collections of cancer-oriented microarray data.
* **C5: GO gene sets** consist of genes annotated by the same GO terms.
* **C6: oncogenic gene sets** are defined directly from microarray gene expression data from cancer gene perturbations.
* **C7: immunologic gene sets** are defined directly from microarray gene expression data from immunologic studies.

**GeneSetDB Gene Set Colletions**

GeneSetDB_ gene sets were obtained from `multiple source databases`_ (shown below) and were classified into five subclasses based on the database content: Pathway, Disease/Phenotype, Drug/Chemical, Genes Regulation and Gene Ontology.

**Pathway**

* Biocarta
* EHMN (Edinburgh Human Metabolic Network)
* HumnCyc
* INOH (Integrating Network Objects with Hierarchies)
* NetPath
* PID (Pathway Interaction Database)
* Reactome
* Wikipathways

**Disease/Phenotype**

* CancerGenes
* KEGG Disease
* HPO (Human Phenotype Ontology)
* MethCancerDB
* MethyCancer
* MPO (Mammalian Phenotype Ontology)
* SIDER (SIDe Effect Resource)

**Drug/Chemical**

* CTD (Comparative Toxicogenomics Database)
* DrugBank
* MATADOR (Manually Annotated Targets and Drugs Online Resource)
* SMPDB (Small Molecular Pathway DataBase)
* STITCH (Search Tool for Interactions of Chemicals)
* T3DB (Toxin and Toxin Target Database)

**Gene Regulation**

* MicroCosm Targets
* miRTarBase
* TFactS
* Rel/NF-kappaB target genes

**Gene Ontology**

* Gene Ontology


**KEGG Pathways**

TO DO

Please cite EGSEA_, MSigDB_, KEGG_ and GeneSetDB_ appropriately if you use them.

.. _multiple source databases: http://genesetdb.auckland.ac.nz/sourcedb.html


    ]]></help>
    <citations>
        <citation type="doi">10.1093/bioinformatics/btw623</citation>
    </citations>
</tool>
