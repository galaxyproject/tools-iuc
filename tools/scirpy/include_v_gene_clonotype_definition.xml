<tool id="include_v_gene_clonotype_definition" name="Include V-gene in clonotype definition" version="0.1.0">
    <requirements>
        <requirement type="package" version="1.7.0">scanpy</requirement>
        <requirement type="package" version="0.11.2">scirpy</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        python '$script_file'
]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[import scanpy as sc
import scirpy as ir
adata = sc.read_h5ad('$adata_in')
#set $list = ([x.strip() for x in str($list).split(',')])
ct_different_v = adata.obs.groupby("$groupby").apply(
    lambda x: x["$key_added"].nunique() > 1
)
ct_different_v = ct_different_v[ct_different_v].index.values.tolist()
adata.obs.loc[
    adata.obs["$groupby"].isin(ct_different_v),
    $list,
].sort_values("$groupby").drop_duplicates().reset_index(drop=True)
adata.write("adata_out.h5ad")
]]></configfile>
    </configfiles>
    <inputs>
        <param name="adata_in" label="Annotated data matrix" type="data" format="h5ad"/>
        <param name="groupby" label="Group by" type="text" value="cc_aa_alignment"/>
        <param name="key_added" type="text" label="Key under which clonal assignments were stored" value="cc_aa_alignment_same_v" help="(value of 'key_added' when running ir.tl.define_clonotype_clusters)"/>
        <param name="list" type="text" label="Names of clonotype clusters" value="cc_aa_alignment, cc_aa_alignment_same_v, IR_VJ_1_v_call, IR_VDJ_1_v_call" help="either single name or list of comma-separated values."/>
    </inputs>
    <outputs>
        <data name="adata_out" format="h5ad" label="${tool.name} on ${on_string}" from_work_dir="adata_out.h5ad"/>
    </outputs>
    <tests>
        <test>
            <param name="adata_in" value="include_v_gene_clonotype_definition_adata.h5ad"/>
            <param name="groupby" value="cc_aa_alignment"/>
            <param name="key_added" value="cc_aa_alignment_same_v" />
            <param name="list" value="cc_aa_alignment, cc_aa_alignment_same_v, IR_VJ_1_v_call, IR_VDJ_1_v_call"/>
            <output name="adata_out" file="include_v_gene_clonotype_definition_out.h5ad"/>
        </test>
    </tests>
    <help><![CDATA[
This tool requires first running the function Scirpy's 'ir.tl.define_clonotype_clusters' which can be done using the tool
'Define, Analyze, Process and Query Clonotypes and Clonal Diversity with Scirpy' (tools_scirpy).

This tool is used to enforce clonotypes (or clonotype clusters) to have the same V-gene, and therefore, the same CDR1
 and 2 regions.
    ]]></help>
    <citations>
        <citation type="bibtex">
}</citation>
    </citations>
</tool>