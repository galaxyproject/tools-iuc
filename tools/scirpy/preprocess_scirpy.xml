<tool id="preprocess_scirpy" name="Preprocess with Scirpy" version="0.1.0">
    <requirements>
        <requirement type="package" version="1.7.0">scanpy</requirement>
        <requirement type="package" version="0.11.2">scirpy</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        python '$script_file'
]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[import scanpy as sc
import scirpy as ir
#if $method.method == 'pp_merge_with_ir'
adata_ir = sc.read_h5ad('$method.adata_ir')
adata_tr = sc.read_h5ad('$method.adata_tr')
ir.pp.merge_with_ir(adata_tr, adata_ir)
adata_tr.write('pp_out.h5ad')

#else if $method.method == 'pp_merge_airr_chains'
merge_airr_chains_adata = sc.read_h5ad('$method.adata_1')
merge_airr_chains_adata2 = sc.read_h5ad('$method.adata_2')
ir.pp.merge_airr_chains(merge_airr_chains_adata, merge_airr_chains_adata2)
merge_airr_chains_adata.write('pp_out.h5ad')

#else if $method.method == 'pp_ir_dist'
ir_dist_adata = sc.read_h5ad('$method.ir_dist_adata')
#if $method.reference.reference == "True"
ir_dist_reference = sc.read_h5ad('$method.reference.ir_dist_reference')
#end if
ir.pp.ir_dist(
    ir_dist_adata,
    #if $method.reference.reference == "True"
    reference=ir_dist_reference,
    #else
    reference=None,
    #end if
    metric='$method.metric',
    cutoff=$method.cutoff,
    sequence='$method.sequence',
    key_added='$method.key_added'
)
ir_dist_adata.write('pp_out.h5ad')
#end if
]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="method">
            <param argument="method" type="select" label="Method to use for preprocessing">
                <option value="pp_merge_with_ir">Merge adaptive immune receptor (IR) data with transcriptomics data into a single AnnData object, using 'pp.merge_with_ir'</option>
                <option value="pp_merge_airr_chains">Merge two AnnData objects with IR information, using 'pp.merge_airr_chains'</option>
                <option value="pp_ir_dist">Computes a sequence-distance metric between all unique VJ CDR3 sequences and between all unique VDJ CDR3 sequences, using 'pp.ir_dist'</option>
            </param>
            <when value="pp_merge_with_ir">
                <param name="adata_tr" type="data" format="h5ad" label="AnnData with the transcriptomics data (will be modified inplace)"/>
                <param name="adata_ir" type="data" format="h5ad" label="AnnData with the adaptive immune receptor (IR) data"/>
            </when>
            <when value="pp_merge_airr_chains">
                <param name="adata_1" type="data" format="h5ad" label="First AnnData object containing IR information"/>
                <param name="adata_2" type="data" format="h5ad" label="Second AnnData object containing IR information"/>
            </when>
            <when value="pp_ir_dist">
                <param name="ir_dist_adata" type="data" format="h5ad" label="Annotated data matrix"/>
                <conditional name="reference">
                    <param argument="reference" type="select" label="Use a reference Anndata object?" help="If
                    specified, will compute distances between the sequences in first Anndata file and this one" value="False">
                        <option value="True">Yes</option>
                        <option value="False">No</option>
                    </param>
                    <when value="True">
                        <param name="ir_dist_reference" type="data" format="h5ad" label="Reference Anndata object"
                               help="(reference in scirpy.pp.ir_dist())"/>
                    </when>
                    <when value="False"/>
                </conditional>
                <param name="metric" type="select" label="Distance metric" help="(metric in scirpy.pp.ir_dist())"
                       value="identity">
                    <option value="alignment">alignment</option>
                    <option value="identity">identity</option>
                    <option value="levenshtein">levenshtein</option>
                    <option value="hamming">hamming</option>
                </param>
                <param name="cutoff" type="integer" label="Distances cutoff" help="All distances above the cutoff value
                will be replaced by 0 and eliminated from the matrix, (cutoff in scirpy.pp.ir_dist())" value="0"/>
                <param name="sequence" type="select" label="Sequence type to compute distance for"
                       help="(sequence in scirpy.pp.ir_dist())" value="nt">
                    <option value="nt">Nucleotide</option>
                    <option value="aa">Amino Acid</option>
                </param>
                <param name="key_added" type="text" label="Key under which results will be stored (in adata.uns)"
                       help="(key_added in scirpy.pp.ir_dist())" value="custom"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="pp_out" format="h5ad" label="${tool.name} (${method.method}) on ${on_string}" from_work_dir="pp_out.h5ad"/>
    </outputs>
    <tests>
        <test>
            <!--Test for pp_merge_with_ir_out-->
            <conditional name="method">
                <param name="method" value="pp_merge_with_ir"/>
                <param name="adata_tr" value="adata_tr_small.h5ad"/>
                <param name="adata_ir" value="adata_ir_small.h5ad"/>
            </conditional>
            <output name="pp_out" file="pp_merge_with_ir_out.h5ad"/>
        </test>
        <test>
            <!--Test for pp_merge_airr_chains-->
            <conditional name="method">
                <param name="method" value="pp_merge_airr_chains"/>
                <param name="adata_1" value="adata_tr_small.h5ad"/>
                <param name="adata_2" value="merge_airr_chains_adata2.h5ad"/>
            </conditional>
            <output name="pp_out" file="merge_airr_chains.h5ad"/>
        </test>
        <test>
            <!--Test for pp_ir_dist-->
            <conditional name="method">
                <param name="method" value="pp_ir_dist"/>
                <param name="ir_dist_adata" value="ir_dist_adata.h5ad"/>
                <conditional name="reference">
                    <param name="reference" value="True"/>
                    <param name="ir_dist_reference" value="merge_airr_chains_adata2.h5ad"/>
                </conditional>
                <param name="metric" value="identity"/>
                <param name="cutoff" value="0"/>
                <param name="sequence" value="nt"/>
                <param name="key_added" value="ir_dist_identity"/>
            </conditional>
            <output name="pp_out" file="ir_dist_out.h5ad"/>
        </test>
    </tests>
    <help><![CDATA[
Merge adaptive immune receptor (IR) data with transcriptomics data into a single AnnData object. (`pp.merge_with_ir`)
=====================================================================================================================
Reading in IR data results in an AnnData object with IR information stored in obs.
Use this function to merge it with another AnnData containing transcriptomics data.
More details on the `scirpy documentation
<https://scverse.org/scirpy/latest/generated/scirpy.pp.merge_with_ir.html>`__

Merge two AnnData objects with IR information. (`pp.merge_airr_chains`)
=======================================================================
Decomposes the IR information back into scirpy.io.AirrCell objects and
merges them on a chain-level.
More details on the `scirpy documentation
<https://scverse.org/scirpy/latest/generated/scirpy.pp.merge_airr_chains.html>`__

Compute sequence-distance metric between all unique VJ CDR3 sequences (`pp.ir_dist`)
====================================================================================
This is a required proprocessing step for clonotype definition and clonotype networks
and for querying reference databases. Calculates the full pairwise distance matrix.
More details on the `scirpy documentation
<https://scverse.org/scirpy/latest/generated/scirpy.pp.ir_dist.html>`__
    ]]></help>
    <citations>
        <citation type="bibtex">
}</citation>
    </citations>
</tool>