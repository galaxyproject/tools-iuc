<tool id="sceasy" name="SCEasy Converter" version="0.0.7+galaxy1" profile="22.05">
    <description>
        Convert between common single cell formats
    </description>
    <macros>
        <macro name="mac_main_layer">
            <param name="main_layer" type="text" value="" label="Main Layer"
                   help="Leave blank for default" />
        </macro>
        <macro name="mac_main_layer_names">
            <param name="main_layer_names" type="text" value="" label="Main Layer Names"
                   help="Leave blank for default" />
        </macro>
        <macro name="mac_obs_names">
            <param name="obs_names" type="text" value="" label="Obs Names"
                   help="Leave blank for default" />
        </macro>
        <macro name="mac_var_names">
            <param name="var_names" type="text" value="" label="Var Names"
                   help="Leave blank for default" />
        </macro>
        <macro name="mac_pca_name" >
            <param name="pca_name" type="text" value="" label="PCA Name"
                   help="Leave blank for default" />
        </macro>
        <macro name="mac_umap_name" >
            <param name="umap_name" type="text" value="" label="UMAP Name"
                   help="Leave blank for default" />
        </macro>
        <macro name="mac_assay">
            <param name="assay" type="text" value="" label="Assay Name"
                   help="Leave blank for default" />
        </macro>
        <macro name="mac_drop_single_values" >
            <param name="drop_single_values" type="boolean" checked="true" label="Drop Single Values?"
                   help="Leave blank for default" />
        </macro>
        <macro name="mac_transfer_layers" >
            <param name="transfer_layers" type="text" value="" label="Transfer Layer(s)"
                   help="Leave blank for default" />
        </macro>
        <macro name="mac_input_form" token_format="@FORMAT@" >
            <param name="input_object_file" type="data" format="@FORMAT@" label="Input object in @FORMAT@ format"/>
        </macro>
    </macros>
    <requirements>
        <requirement type="package" version="0.0.7">r-sceasy</requirement>
        <requirement type="package" version="3.0.6" >loompy</requirement>
        <requirement type="package" version="0.10.0" >anndata</requirement>
        <requirement type="package" version="3.10" >python</requirement>
        <requirement type="package" version="0.7.5.4" >r-anndata</requirement>
        <requirement type="package" version="1.32.0" >r-reticulate</requirement>
    </requirements>
    <command detect_errors="exit_code">
        ## export RETICULATE_PYTHON=$CONDA_PREFIX/bin/python3
        ## This doesn't work either...
        Rscript '$script_file'
    </command>
    <!-- <environment_variables> -->
    <!--  Nope, simply can't access the conda prefix... fine, we do this from within R -->
    <!--     <!-\- reticulate needs to be told to not use system python -\-> -->
    <!--     <!-\- <environment_variable name="RETICULATE_PYTHON">$CONDA_PREFIX/bin/python3</environment_variable> -\-> -->
    <!--     <!-\- <environment_variable name="RETICULATE_PYTHON">\$CONDA_PREFIX/bin/python3</environment_variable> -\-> -->
    <!--     <!-\- <environment_variable name="RETICULATE_PYTHON">$$CONDA_PREFIX/bin/python3</environment_variable> -\-> -->
    <!-- </environment_variables> -->
    <configfiles>
        <configfile name="script_file"><![CDATA[
direction='$conversion.direction'
tokens = unlist(strsplit(direction, split="2"))
format.from = tokens[1]
format.to = tokens[2]

library(sceasy)
library(reticulate)
## Hack to get CONDA prefix...
Sys.setenv(RETICULATE_PYTHON=file.path(Sys.getenv("CONDA_PREFIX"), "bin", "python3"))

loompy = reticulate::import('loompy')
infile = '$input_object_file'

outfile_ext_map=list(
    "anndata" = "h5ad",
    "seurat" = "rds",
    "sce" = "rds",
    "cds" = "rds",
    "loom" = "loom") ## this has to be a .loom ending for the export to work.

outfile = paste0("outfile.", outfile_ext_map[format.to])


## IDIOSYNCRACIES:
## Some input formats need be loaded first and then converted,
## and other formats need to be specified as filenames only,
## and some formats need to be objects, or stripped down objects,
## and probably more issues will be discovered in time.

do_infile_as_first_arg = as.logical(direction == "loom2sce")
do_filename_as_first_arg = as.logical(direction %in% c("anndata2cds", "anndata2seurat", "loom2anndata"))
do_dietseurat_in_first_arg = as.logical(direction == "seurat2sce")

if (do_infile_as_first_arg) {
   convertFormat(inFile = infile, from = format.from, to = format.to, outFile = outfile)
} else if (do_filename_as_first_arg) {
   convertFormat(infile, from = format.from, to = format.to, outFile = outfile)
} else {
   ## We need to physically load the object (either Seurat or SCE, both which should be
   ## of RDS input type)
   rds = readRDS(infile)

   if (do_dietseurat_in_first_arg){
      library(Seurat)
      rds = DietSeurat(rds)
   }
   convertFormat(rds, from = format.from, to = format.to, outFile = outfile)
}

        ]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="conversion" >
            <param name="direction" type="select" label="Convert From / To" >
                <option value="anndata2cds" >AnnData to CellDataSet</option>
                <option value="anndata2seurat" >AnnData to Seurat</option>
                <option value="loom2anndata" >Loom to AnnData</option>
                <option value="loom2sce">Loom to SingleCellexperiment</option>
                <option value="sce2anndata" >SingleCellexperiment to AnnData</option>
                <option value="sce2loom" >SingleCellexperiment to Loom</option>
                <option value="seurat2anndata">Seurat to AnnData</option>
                <option value="seurat2sce" >Seurat to SingleCellexperiment</option>
            </param>
            <when value="anndata2cds" >
                <expand macro="mac_input_form" token_format="h5ad" />
                <expand macro="mac_pca_name" />
                <expand macro="mac_umap_name" />
            </when>
            <when value="anndata2seurat" >
                <expand macro="mac_input_form" token_format="h5ad" />
                <expand macro="mac_main_layer" />
                <expand macro="mac_assay" />
            </when>
            <when value="loom2anndata">
                <expand macro="mac_input_form" token_format="h5" />
                <expand macro="mac_obs_names" />
                <expand macro="mac_var_names" />
            </when>
            <when value="loom2sce">
                <expand macro="mac_input_form" token_format="h5" />
                <expand macro="mac_main_layer" />
                <expand macro="mac_main_layer_names" />
            </when>
            <when value="sce2anndata">
                <expand macro="mac_input_form" token_format="sce" />
                <expand macro="mac_transfer_layers" />
                <expand macro="mac_drop_single_values" />
            </when>
            <when value="sce2loom">
                <expand macro="mac_input_form" token_format="sce" />
                <expand macro="mac_drop_single_values" />
            </when>
            <when value="seurat2anndata">
                <expand macro="mac_input_form" token_format="rds" />
                <expand macro="mac_transfer_layers" />
                <expand macro="mac_drop_single_values" />
            </when>
            <when value="seurat2sce">
                <expand macro="mac_input_form" token_format="rds" />
                <expand macro="mac_main_layer" />
                <expand macro="mac_assay" />
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="output_sce" format="rdata" from_work_dir="outfile.rds" label="${tool.name} on ${on_string}: SingleCellExperiment">
            <filter>
                conversion['direction'].endswith('sce')
            </filter>
        </data>
        <data name="output_cds" format="rdata" from_work_dir="outfile.rds" label="${tool.name} on ${on_string}: CellDataSet">
            <filter>
                conversion['direction'].endswith('cds')
            </filter>
        </data>
        <data name="output_loom" format="h5" from_work_dir="outfile.loom" label="${tool.name} on ${on_string}: Loom">
            <filter>
                conversion['direction'].endswith('loom')
            </filter>
        </data>
        <data name="output_anndata" format="h5" from_work_dir="outfile.h5ad" label="${tool.name} on ${on_string}: AnnData">
            <filter>
                conversion['direction'].endswith('anndata')
            </filter>
        </data>
        <data name="output_seurat" format="rdata" from_work_dir="outfile.rds" label="${tool.name} on ${on_string}: Seurat">
            <filter>
                conversion['direction'].endswith('seurat')
            </filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="direction" value="anndata2cds"/>
            <param name="input_object_file" value="test_anndata.h5ad"/>
            <output name="output_cds" file="ad2cds.rds" ftype="rdata" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <param name="direction" value="anndata2seurat"/>
            <param name="input_object_file" value="test_anndata.h5ad"/>
            <output name="output_seurat" file="ad2seurat.rds" ftype="rdata" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <param name="direction" value="loom2anndata"/>
            <param name="input_object_file" value="sce2loom.rds"/>
            <output name="output_anndata" file="loom2anndata.h5ad" ftype="h5" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <param name="direction" value="loom2sce"/>
            <param name="input_object_file" value="sce2loom.rds"/>
            <output name="output_sce" file="loom2sce.rds" ftype="rdata" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <param name="direction" value="sce2anndata"/>
            <param name="input_object_file" value="test_sce.rds"/>
            <output name="output_anndata" file="sce2anndata.h5ad" ftype="h5" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <param name="direction" value="sce2loom"/>
            <param name="input_object_file" value="test_sce.rds"/>
            <output name="output_loom" file="sce2loom.rds" ftype="h5" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <param name="direction" value="seurat2anndata"/>
            <param name="input_object_file" value="test_seurat.rds"/>
            <output name="output_seurat" file="test_anndata.h5ad" ftype="h5" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <param name="direction" value="seurat2sce"/>
            <param name="input_object_file" value="test_seurat.rds"/>
            <output name="output_sce" file="test_sce.rds" ftype="rdata" compare="sim_size"/>
        </test>
    </tests>
    <help>
SCeasy
======

        Convert scRNA data object between formats `sceasy::convertFormat()`

Supports the following conversion:

.. image:: $PATH_TO_IMAGES/conv.png
	:width: 80 %
	:align: center


    </help>
    <citations>
        <citation type="doi"> doi:10.1093/nargab/lqaa052</citation>
    </citations>
</tool>