<tool id="bwameth" name="bwameth" version="0.20">
  <description>Fast and accurate aligner of BS-Seq reads.</description>
  <requirements>
    <requirement type="package" version="0.4.6">toolshed</requirement>
    <requirement type="package" version="1.2">samtools</requirement>
    <requirement type="package" version="0.7.12">bwa</requirement>
  </requirements>
  <stdio>
    <exit_code range="1:" />
    <exit_code range=":-1" />
    <regex match="Error:" />
    <regex match="Exception:" />
    <regex match="Exception :" />
  </stdio>
  <command interpreter="python">
<![CDATA[
    bwameth_wrapper.py 
        -p "\${GALAXY_SLOTS:-4}"

    #if $referenceSource.source != "indexed":
        --makeIndex $referenceSource.reference
    #else
        --premadeIndex $referenceSource.index.fields.path
    #end if

    #if str($readGroup).strip() != "":
        --readGroup "${readGroup}"
    #end if

    #if $single_or_paired.single_or_paired_opts == 'single':
        $single_or_paired.input_singles
    #else:
        $single_or_paired.input_mate1 $single_or_paired.input_mate2
    #end if
]]>
  </command>
  <inputs>
    <conditional name="referenceSource">
      <param name="source" type="select" label="Select a genome reference from your history or a built-in index?">
        <option value="history" selected="True">Use one from the history</option>
        <option value="indexed">Use a built-in index</option>
      </param>
      <when value="history">
        <param name="reference" type="data" format="fasta" metadata_name="dbkey" label="Select a genome" help="in FASTA format" />
      </when>
      <when value="indexed">
        <param name="index" type="select" label="Select a reference genome" help="If your genome of interest is not listed, contact your Galaxy admin">
          <options from_data_table="bwameth_indexes">
            <filter type="sort_by" column="2"/>
              <validator type="no_options" message="No indexes are available for the selected input dataset"/>
          </options>
        </param>
      </when>
    </conditional>

    <conditional name="single_or_paired">
      <param name="single_or_paired_opts" type="select" label="Is this library mate-paired?">
        <option value="single">Single-end</option>
        <option value="paired">Paired-end</option>
      </param>
      <when value="single">
        <param name="input_singles" type="data" format="fastq" label="FASTQ" help="FASTQ file." />
      </when>
      <when value="paired">
        <param name="input_mate1" type="data" format="fastq" label="First read in pair" help="FASTQ file." />
        <param name="input_mate2" type="data" format="fastq" label="Second read in pair" help="FASTQ file." />
      </when>
    </conditional>
    <param name="readGroup" type="text" value="" label="Read group" help="If desired, you can manually add read group information to the resulting BAM file. To do so, you MUST manually specify the entire string, such as '@RG\tID:foo\tSM:bar'">
      <sanitizer sanitize="False"/>
    </param>
  </inputs>
  <outputs>
    <data name="output" format="bam" from_work_dir="output.bam" label="${tool.name} on ${on_string}" />
  </outputs>
  <tests>
    <test>
      <param name="referenceSource" value="history" />
      <param name="reference" value="ref.fa" />
      <param name="single_or_paired_opts" value="paired" />
      <param name="input_mate1" value="t_R1.fastq.gz" />
      <param name="input_mate2" value="t_R2.fastq.gz" />
      <output file="output.bam" ftype="bam" name="output" compare="sim_size" delta="10000"/>
    </test>
  </tests>
  <help>
<![CDATA[

**What it does**

BWA-meth performs alignment of reads in a bisulfite-sequencing experiment (e.g., RRBS or WGBS) to a genome. The methodology employed for this is similar to bismark, where both the reads and the reference genome are *in silico* converted prior to alignment. Methylation extraction on the resulting BAM file can be done with the PileOMeth tool.
]]>
  </help>
</tool>
