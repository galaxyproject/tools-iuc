<tool profile="16.07" id="mothur_remove_lineage" name="Remove.lineage" version="@TOOL_VERSION@.1">
    <description>Picks by taxon</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command><![CDATA[
@SHELL_OPTIONS@

#import re
## create symlinks to input datasets
ln -s '$file.taxonomy' file.taxonomy.dat &&
#if $file.filetype == "useconstaxonomy":
    ln -s '$file.shared' file.shared.dat &&
    ln -s '$file.list' file.list.dat &&
#end if
ln -s '$fasta_in' fasta_in.dat &&
ln -s '$group_in' group_in.dat &&
ln -s '$alignreport_in' alignreport_in.dat &&
ln -s '$list_in' list_in.dat &&
ln -s '$name_in' name_in.dat &&
ln -s '$count' count.dat &&

echo 'remove.lineage(
    #if $file.filetype == "usetaxonomy":
        taxonomy=file.taxonomy.dat
    #else
        constaxonomy=file.taxonomy.dat
        #if $file.shared:
            ,shared=file.shared.dat
        #end if
        #if $file.list:
            ,list=file.list.dat
        #end if
    #end if
    #set taxonstring = set()
    #if $file.taxons:
        #set taxonstring = str($file.taxons).split(",")
        ## readd semicolons which are removed by the multiple_splitter filter
        #set taxonstring = {x+";" for x in $taxonstring}
    #end if
    #if $taxon != "":
        #set taxonstring = { t + ";" if not t.endswith(";") else t for t in set(str($taxon).split("-")) }
    #end if
    #if $taxonstring != ""
        #set taxonstring = "-".join($taxonstring)
        ## add 1 to the confidence scores. For "taxon(x)" mothur removes 
        ## taxon if the confidence score is <x, this would work for the
        ## manually entered values (in $taxon), but not for the select that
        ## is constructed from the taxonomy file  
        #set taxonstring = re.sub("(\s|,)+", ",", $taxonstring)
        #for i in range(100, -1, -1)
            #set taxonstring = taxonstring.replace("(%d)" % i, "(%d)" % (i+1))
        #end for
        ,taxon=$taxonstring
    #end if
    #if $fasta_in:
        ,fasta=fasta_in.dat
    #end if
    #if $group_in:
        ,group=group_in.dat
    #end if
    #if $alignreport_in:
        ,alignreport=alignreport_in.dat
    #end if
    #if $list_in:
        ,list=list_in.dat
    #end if
    #if $name_in:
        ,name=name_in.dat
        ,dups=$dups
    #end if
    #if $count:
        ,count=count.dat
    #end if
)'
| sed 's/ //g'  ## mothur trips over whitespace
| mothur
| tee mothur.out.log
    ]]></command>
    <inputs>
        <conditional name="file">
            <param name="filetype" type="select" label="choose which file is used">
                <option value="usetaxonomy" selected="true">taxonomy</option>
                <option value="useconstaxonomy">constaxonomy</option>
            </param>
            <when value="usetaxonomy">
                <param name="taxonomy" type="data" format="mothur.seq.taxonomy" label="taxonomy - Taxonomy" help="please make sure your file has no quotation marks in it"/>
                <param name="taxons" type="select" size="120" optional="true" multiple="true" label="Browse Taxons from Taxonomy">
                    <options from_dataset="taxonomy">
                        <column name="name" index="1"/>
                        <column name="value" index="1"/>
                        <filter type="multiple_splitter" column="1" separator=";"/>
                        <filter type="sort_by" column="1"/>
                        <filter type="unique_value" column="1"/>
                    </options>
                    <sanitizer>
                        <valid initial="default">
                            <add preset="string.printable"/>
                            <add value=";"/>
                            <remove value="&quot;"/>
                            <remove value="&apos;"/>
                        </valid>
                    </sanitizer>
                </param>
            </when>
            <when value="useconstaxonomy">
                <param name="taxonomy" type="data" format="mothur.cons.taxonomy" label="constaxonomy - Constaxonomy file. Provide either a constaxonomy file or a taxonomy file" help="please make sure your file has no quotation marks in it"/>
                <param name="taxons" type="select" size="120" optional="true" multiple="true" label="Browse Taxons from Taxonomy">
                    <options from_dataset="taxonomy">
                        <column name="name" index="2"/>
                        <column name="value" index="2"/>
                        <filter type="multiple_splitter" column="2" separator=";"/>
                        <filter type="sort_by" column="2"/>
                        <filter type="unique_value" column="2"/>
                    </options>
                    <sanitizer>
                        <valid initial="default">
                            <add preset="string.printable"/>
                            <add value=";"/>
                            <remove value="&quot;"/>
                            <remove value="&apos;"/>
                        </valid>
                    </sanitizer>
                </param>
                <param name="shared" type="data" format="mothur.shared" label="shared - shared file" optional="true"/>
                <param name="list" type="data" format="mothur.list" label="list - list file" optional="true"/>
            </when>
        </conditional>
        <param name="taxon" type="text" area="True" size="5x120" label="taxon - Manually select Taxons for filtering" help="Enter 1 or more taxons separated by dashes here, e.g. Bacteria;Firmicutes;-Bacteria;Actinobacteria; ">
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value=";"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
        <param name="fasta_in" type="data" format="fasta" optional="true" label="fasta - Fasta Sequences"/>
        <param name="group_in" type="data" format="mothur.groups" optional="true" label="group - Groups"/>
        <param name="alignreport_in" type="data" format="mothur.align.report" optional="true" label="alignreport - Align Report"/>
        <param name="list_in" type="data" format="mothur.list" optional="true" label="list - OTU List"/>
        <param name="name_in" type="data" format="mothur.names" optional="true" label="name - Sequences Name reference"/>
        <param name="dups" type="boolean" truevalue="true" falsevalue="false" checked="true" label="dups - Apply to duplicate names"/>
        <param name="count" type="data" format="mothur.count_table" optional="true" help="The count file is similar to the name file in that it is used to represent the number of duplicate sequences for a given representative sequence. It can also contain group information"/>
        <expand macro="param-savelog"/>
    </inputs>
    <outputs>
        <expand macro="logfile-output"/>
        <data name="taxonomy_out" format="mothur.seq.taxonomy" from_work_dir="file.taxonomy*.pick.*" label="${tool.name} on ${on_string}: pick.taxonomy"/>
        <data format_source="fasta_in" name="fasta_out" from_work_dir="fasta_in*.pick.*" label="${tool.name} on ${on_string}: pick.fasta">
            <filter>fasta_in</filter>
        </data>
        <data name="group_out" format="mothur.groups" from_work_dir="group_in*.pick.*" label="${tool.name} on ${on_string}: pick.group">
            <filter>group_in</filter>
        </data>
        <data name="count_out" format="mothur.count_table" from_work_dir="count*.pick.*" label="${tool.name} on ${on_string}: pick.count_table">
            <filter>count</filter>
        </data>
        <collection name="list_out" type="list" label="${tool.name} on ${on_string}: pick.list">
            <filter>list_in</filter>
            <discover_datasets pattern="list_in.*?\.(?P&lt;designation&gt;.*)\.pick.*" format="mothur.list"/>
        </collection>
        <data name="name_out" format="mothur.names" from_work_dir="name_in*.pick.*" label="${tool.name} on ${on_string}: pick.name">
            <filter>name_in</filter>
        </data>
        <data name="alignreport_out" format="mothur.align.report" from_work_dir="alignreport_in*.pick.*" label="${tool.name} on ${on_string}: pick.align.report">
            <filter>alignreport_in</filter>
        </data>
    </outputs>
    <tests>
        <test><!-- test with defaults and single taxon -->
            <conditional name="file">
                <param name="filetype" value="usetaxonomy"/>
                <param name="taxonomy" value="abrecovery.pds.wang.taxonomy" ftype="mothur.seq.taxonomy"/>
                <param name="taxons" value="Firmicutes(100)"/>
            </conditional>
            <param name="count" value="amazon.count_table"/>
            <output name="taxonomy_out">
                <assert_contents>
                    <not_has_text text="Firmicutes"/>
                    <has_text text="Bacteroidetes"/>
                </assert_contents>
            </output>
            <output name="count_out" md5="6f89b3b99f337414d98f70fcda4b248e"/>
        </test>
        <test><!-- test with multiple taxons and all additional files -->
            <conditional name="file">
                <param name="filetype" value="usetaxonomy"/>
                <param name="taxonomy" value="abrecovery.pds.wang.taxonomy" ftype="mothur.seq.taxonomy"/>
                <param name="taxons" value="Firmicutes(100),Citrobacter(78)"/>
            </conditional>
            <param name="group_in" value="abrecovery.groups" ftype="mothur.groups"/>
            <param name="fasta_in" value="abrecovery.fasta" ftype="fasta"/>
            <param name="name_in" value="abrecovery.names" ftype="mothur.names"/>
            <param name="alignreport_in" value="Mock_S280_L001_R1_001_small.contigs.report" ftype="mothur.align.report"/>
            <param name="list_in" value="amazon.an.list" ftype="mothur.list"/>
            <output name="taxonomy_out">
                <assert_contents>
                    <not_has_text text="Firmicutes"/>
                    <not_has_text text="Citrobacter(78)"/>
                    <has_text text="Citrobacter(80)"/>
                    <has_text text="Bacteroidetes"/>
                </assert_contents>
            </output>
            <output name="group_out" md5="4be6a969c89e7f5e0af0fdb1c1ab2a9e" ftype="mothur.groups"/>
            <output name="fasta_out" md5="a41074cb9a64381e1f1c446452246a84" ftype="fasta"/>
            <output name="name_out" md5="2b612ca6cb2876420a063326e209d89f" ftype="mothur.names"/>
            <output name="alignreport_out" md5="d94be921c3ad1786db3e60dc23c3bc04" ftype="mothur.align.report"/>
            <output_collection name="list_out" count="36">
                <element name="0.05" md5="5d4195793e2fc50979b377df468c436a" ftype="mothur.list"/>
            </output_collection>
        </test>
        <test><!-- test with taxons from file -->
            <conditional name="file">
                <param name="filetype" value="usetaxonomy"/>
                <param name="taxonomy" value="abrecovery.pds.wang.taxonomy" ftype="mothur.seq.taxonomy"/>
                <param name="taxons" value="Firmicutes(100),Actinobacteria(100)"/>
            </conditional>
            <output name="taxonomy_out">
                <assert_contents>
                    <not_has_text text="Firmicutes"/>
                    <not_has_text text="Actinobacteria"/>
                    <has_text text="Bacteroidetes"/>
                </assert_contents>
            </output>
        </test>
        <test><!-- test with constaxonomy file -->
            <conditional name="file">
                <param name="filetype" value="useconstaxonomy"/>
                <param name="taxonomy" value="example.constaxonomy" ftype="mothur.cons.taxonomy"/>
                <param name="taxons" value="Firmicutes(100),Bacteroidetes(100)"/>
            </conditional>
            <output name="taxonomy_out">
                <assert_contents>
                    <not_has_text text="Firmicutes"/>
                    <not_has_text text="Bacteroidetes"/>
                    <has_text text="Actinobacteria"/>
                </assert_contents>
            </output>
        </test>
        <test><!-- test with constaxonomy file and taxons from file -->
            <conditional name="file">
                <param name="filetype" value="useconstaxonomy"/>
                <param name="taxonomy" value="example.constaxonomy" ftype="mothur.cons.taxonomy"/>
            </conditional>
            <!-- check that missing semicolon is added -->
            <param name="taxon" value="Firmicutes(100)-Bacteroidetes(100);"/>
            <output name="taxonomy_out">
                <assert_contents>
                    <not_has_text text="Firmicutes"/>
                    <not_has_text text="Bacteroidetes"/>
                    <has_text text="Actinobacteria"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[

@MOTHUR_OVERVIEW@

**Command Documentation**

The remove.lineage_ command reads a taxonomy_ file and a taxon and generates a
new file that contains only the sequences in the that are not from that taxon.

Taxons can be selected from *Browse Taxons from Taxonomy* or manually specified 
*taxon - Manually select Taxons for filtering* with. Taxa can be specified by
their name or by a semicolon separated lineage:

- Bacteria;Firmicutes;
- Firmicutes;

For each taxon a minimum confidence score can be given in parenthese:

- Bacteria(100);Firmicutes(90);
- Firmicutes(90);

Note that, for confidence value ``x`` all taxa with a confidence ``<= x`` (or more
precisely ``< x + 1``) are removed.

You may also include either a fasta, name_, group_, list_, or align.report_ file
to this command and mothur will generate new files for each of those containing
only the selected sequences.

.. _taxonomy: https://www.mothur.org/wiki/Taxonomy_outline
.. _name: https://www.mothur.org/wiki/Name_file
.. _group: https://www.mothur.org/wiki/Group_file
.. _list: https://www.mothur.org/wiki/List_file
.. _align.report: https://www.mothur.org/wiki/Align.seqs
.. _remove.lineage: https://www.mothur.org/wiki/Remove.lineage

    ]]></help>
    <expand macro="citations"/>
</tool>
