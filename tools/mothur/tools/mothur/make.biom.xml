<tool profile="16.07" id="mothur_make_biom" name="Make.biom" version="@WRAPPER_VERSION@.0">
    <description>Make biom files from a shared file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="aggressive"><![CDATA[
        echo 'make.biom(
            shared=$otu,
            #if $contaxonomy:
                constaxonomy=$contaxonomy,
            #end if
            #if $label:
                label=${ str($label).replace(",","-") },
            #end if
            #if $groups:
                groups=${ str($groups).replace(",","-") },
            #end if
            #if $metadata:
                metadata=$metadata,
            #end if
            #if $picrustc.use:
                picrust=$picrustc.picrust,
                reftaxonomy=$picrustc.reftax,
            #end if
            matrixtype=$matrixtype
        )'
        | sed 's/ //g'  ## mothur trips over whitespace
        | mothur &&

        ## move output files to correct destination
        prefix="$otu" &&
        mv mothur.*.logfile "$logfile" &&
        mv \${prefix%.dat}*.biom .
    ]]></command>
    <inputs>
        <param name="otu" type="data" format="mothur.shared" label="shared - OTU Shared file"/>
        <param name="contaxonomy" type="data" format="mothur.cons.taxonomy" label="contaxonomy - consensus taxonomy"
               help="The contaxonomy file is the taxonomy file outputted by classify.otu"
               optional="true"/>
        <param name="metadata" type="data" format="metadata" label="metadata" optional="true" help="You can add sample data support here."/>
        <conditional name="picrustc">
            <param name="use" type="boolean" truevalue="yes" falsevalue="no" checked="false" label="use picrust program"/>
            <when value="yes">
                <param name="picrust" type="data" format="otu_map" label="picrust" help="The picrust program requires green genes OTU IDs. The picrust parameter allows you to provide the OTU ID mapping table associated with your reference taxonomy."/>
                <param name="reftax" type="data" format="tax" label="reftaxonomy" help="The referencetax parameter is used with the picrust parameter. Picrust requires the greengenes OTU IDs to be in the biom file, and the referencetax parameter allows you to provide your reference taxonomy file you used when classifying your sequences."/>
            </when>
            <when value="no"/>
        </conditional>
        <param name="matrixtype" type="select" label="matrixtype - sparse or dense">
            <option value="sparse">sparse</option>
            <option value="dense">dense</option>
        </param>
        <param name="groups" type="select" label="groups - Groups to include" multiple="true"
            help="By default all are included if no selection is made.">
            <options>
                <filter type="data_meta" ref="otu" key="groups"/>
            </options>
        </param>
        <param name="label" type="select" optional="true" label="label - Select OTU Labels to include" multiple="true"
            help="By default all are included if no selection is made.">
            <expand macro="labeloptions"/>
        </param>
    </inputs>
    <outputs>
        <data name="logfile" format="txt" label="${tool.name} on ${on_string}: logfile"/>
        <collection name="biomfiles" type="list" label="calculators">
            <discover_datasets pattern=".*?\.(?P&lt;designation&gt;.*)\.biom" format="biom1"/>
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="otu" value="amazon.an.shared" ftype="mothur.shared"/>
            <output_collection name="biomfiles" count="36">
                <element name="0.36" ftype="biom1">
                    <assert_contents>
                        <has_text text="Biological Observation Matrix"/>
                        <has_text text="generated_by"/>
                        <has_text text="forest"/>
                        <has_text text="pasture"/>
                    </assert_contents>
                </element>
            </output_collection>
            <expand macro="logfile-test"/>
        </test>
        <test><!-- test with subset of labels and groups-->
            <param name="otu" value="amazon.an.shared" ftype="mothur.shared"/>
            <param name="label" value="0.36,0.38,0.41"/>
            <param name="groups" value="forest"/>
            <output_collection name="biomfiles" count="3">
                <element name="0.36">
                    <assert_contents>
                        <has_text text="Biological Observation Matrix"/>
                        <has_text text="generated_by"/>
                        <has_text text="forest"/>
                        <not_has_text text="pasture"/>
                    </assert_contents>
                </element>
            </output_collection>
            <expand macro="logfile-test"/>
        </test>
        <!-- TODO: test with picrust option (need file with greengenes OTU IDs) -->
    </tests>
    <help>
<![CDATA[

@MOTHUR_OVERVIEW@

**Command Documenation**

The make.biom command converts a shared_ shared file to biom_ files.
The output can be filtered by groups and labels.


.. _shared: http://www.mothur.org/wiki/Shared_file
.. _biom:  http://biom-format.org/documentation/biom_format.html
.. _make.biom: http://www.mothur.org/wiki/Make.biom
]]>
    </help>
    <expand macro="citations"/>
</tool>
