<tool id="mothur_get_lineage" name="Get.lineage" version="@WRAPPER_VERSION@.0">
    <description>Picks by taxon</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_command"/>

    <command><![CDATA[
        #import re
        echo 'get.lineage(
            #if $file.filetype == "usetaxonomy":
                taxonomy=$file.taxonomy
            #else
                constaxonomy=$file.constaxonomy
                ,shared=$file.shared
                ,list=$file.list
            #end if
            #if $file.taxons:
                ,taxon=${ str($file.taxons).replace(",","-") }
            #elif $taxon:
                ,taxon='"'$re.sub("(\s|,)+",",",$re.sub("\(\d+\)","", $taxon.value.__str__ ))'"'
            #end if
            #if $fasta_in:
                ,fasta=$fasta_in
            #end if
            #if $group_in:
                ,group=$group_in
            #end if
            #if $alignreport_in:
                ,alignreport=$alignreport_in
            #end if
            #if $list_in:
                ,list=$list_in
            #end if
            #if $name_in:
                ,name=$name_in
                ,dups=$dups
            #end if
            #if $count:
                ,count=$count
            #end if
        )'
        | sed 's/ //g'  ## mothur trips over whitespace
        | mothur &&

        ## move output files to correct destination
        prefix="$file.taxonomy" &&
        mv \${prefix%.dat}*.pick.* "$taxonomy_out" &&
        mv mothur.*.logfile "$logfile"
    ]]></command>
    <inputs>
        <conditional name="file">
            <param name="filetype" type="select" label="choose which file is used">
                <option value="usetaxonomy" selected="true">taxonomy</option>
                <option value="useconstaxonomy">constaxonomy</option>
            </param>
            <when value="usetaxonomy">
                <param name="taxonomy" type="data" format="mothur.seq.taxonomy" label="taxonomy - Taxonomy"/>
                <param name="taxons" type="select" size="120" optional="true" multiple="true" label="Browse Taxons from Taxonomy">
                    <options from_dataset="taxonomy">
                        <column name="name" index="1"/>
                        <column name="value" index="1"/>
                        <filter type="unique_value" name="unique_taxon" column="1"/>
                        <filter type="sort_by" name="sorted_taxon" column="1"/>
                    </options>
                </param>
            </when>
            <when value="useconstaxonomy">
                <param name="taxonomy" type="data" format="mothur.cons.taxonomy" label="constaxonomy - Constaxonomy file. Provide either a constaxonomy file or a taxonomy file"/>
                <param name="shared" type="data" format="mothur.shared" label="shared - shared file" optional="true"/>
                <param name="list" type="data" format="mothur.list" label="list - list file" optional="true"/>
            </when>
        </conditional>
        <param name="taxon" type="text" area="True" size="5x120" label="taxon - Manually select Taxons for filtering" help="If no taxons selected from file, Enter 1 or more taxons separated by dashes here, e.g. Bacteria;Firmicutes;-Bacteria;Actinobacteria; "/>
        <param name="fasta_in" type="data" format="fasta" optional="true" label="fasta - Fasta Sequences"/>
        <param name="group_in" type="data" format="mothur.groups" optional="true" label="group - Groups"/>
        <param name="alignreport_in" type="data" format="mothur.align.report" optional="true" label="alignreport - Align Report"/>
        <param name="list_in" type="data" format="mothur.list" optional="true" label="list - OTU List"/>
        <param name="name_in" type="data" format="mothur.names" optional="true" label="name - Sequences Name reference"/>
        <param name="dups" type="boolean" truevalue="" falsevalue="--dups=false" checked="true" label="dups - Apply to duplicate names"/>
        <param name="count" type="data" format="mothur.count_table" optional="true" help="The count file is similar to the name file in that it is used to represent the number of duplicate sequences for a given representative sequence. It can also contain group information"/>
    </inputs>
    <outputs>
        <data  name="logfile" format="txt" label="${tool.name} on ${on_string}: logfile"/>
        <data name="taxonomy_out" format="mothur.seq.taxonomy" label="${tool.name} on ${on_string}: pick.taxonomy"/>
        <data format_source="fasta_in" name="fasta_out" label="${tool.name} on ${on_string}: pick.fasta">
            <filter>fasta_in != None</filter>
        </data>
        <data format="mothur.groups" name="group_out" label="${tool.name} on ${on_string}: pick.group">
            <filter>group_in != None</filter>
        </data>
        <data format="mothur.list" name="list_out" label="${tool.name} on ${on_string}: pick.list">
            <filter>list_in != None</filter>
        </data>
        <data format="mothur.names" name="name_out" label="${tool.name} on ${on_string}: pick.name">
            <filter>name_in != None</filter>
        </data>
        <data format="mothur.align.report" name="alignreport_out" label="${tool.name} on ${on_string}: pick.align.report">
            <filter>alignreport_in != None</filter>
        </data>
    </outputs>
    <tests>
        <test><!-- test with single taxon -->
            <param name="filetype" value="usetaxonomy"/>
            <param name="taxonomy" value="abrecovery.pds.wang.taxonomy" ftype="mothur.seq.taxonomy"/>
            <param name="taxon" value="Bacteria;Firmicutes;"/>
            <output name="taxonomy_out" md5="aca21af84b6bbb6ab6cd7ab8643943d2"/>
        </test>
        <test><!-- test with multiple taxons -->
            <param name="filetype" value="usetaxonomy"/>
            <param name="taxonomy" value="abrecovery.pds.wang.taxonomy" ftype="mothur.seq.taxonomy"/>
            <param name="taxon" value="Bacteria;Firmicutes;-Bacteria;Actinobacteria;"/>
            <output name="taxonomy_out" md5="682af62c68e02244c1eb1c39fa295c63"/>
        </test>
    </tests>
    <help>
<![CDATA[

@MOTHUR_OVERVIEW@

**Command Documenation**

The get.lineage_ command reads a taxonomy_ file and a taxon and generates a new file that contains only the sequences in the that are from that taxon. You may also include either a fasta, name_, group_, list_, or align.report_ file to this command and mothur will generate new files for each of those containing only the selected sequences.

.. _taxonomy: http://www.mothur.org/wiki/Taxonomy_outline
.. _name: http://www.mothur.org/wiki/Name_file
.. _group: http://www.mothur.org/wiki/Group_file
.. _list: http://www.mothur.org/wiki/List_file
.. _align.report: http://www.mothur.org/wiki/Align.seqs
.. _get.lineage: http://www.mothur.org/wiki/Get.lineage

]]>
    </help>
    <expand macro="citations"/>
</tool>
