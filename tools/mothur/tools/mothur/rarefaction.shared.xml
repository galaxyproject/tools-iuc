<tool id="mothur_rarefaction_shared" name="Rarefaction.shared" version="@WRAPPER_VERSION@.0" force_history_refresh="True">
    <description>Generate inter-sample rarefaction curves for OTUs</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />

    <command><![CDATA[
        echo 'rarefaction.shared(
            shared=$otu,
            #if $label:
                label=${ str($label).replace(",","-") },
            #end if
            #if $groups
                groups=${ str($groups).replace(",","-") },
            #end if
            #if $designc.usedesign:
                design=$designc.design,
                #if $designc.sets:
                    sets=${ str($designc.sets).replace(",","-") },
                #end if
            #end if
            #if $subsample.usess:
                #if $subsample:
                    subsample=$subsample.subsample,
                #else
                    subsample=T,
                #end if
                #if $subsample.subsampleiters:
                    subsampleiters=$subsample.subsampleiters,
                #end if
            #end if
            calc=${ str($calc).replace(",","-") },
            iters=$iters,
            jumble=$jumble
        )'
        | sed 's/ //g'  ## mothur trips over whitespace
        | mothur &&

        ## move output files to correct destination
        prefix="$otu" &&
        #if 'sharedobserved' in $calc.__str__:
            mv \${prefix%.dat}*.rarefaction "$rarefaction" &&
        #end if
        #if 'sharednseqs' in $calc.__str__:
            mv \${prefix%.dat}*.r_nseqs "$rarefaction2" &&
        #end if
        mv mothur.*.logfile "$logfile"
    ]]></command>
    <inputs>
        <param name="otu" type="data" format="mothur.shared" label="shared - OTU Shared"/>
        <param name="label" type="select" label="label - OTU Labels" multiple="true">
            <expand macro="labeloptions"/>
        </param>
        <param name="groups" type="select" label="groups - Groups to analyze" multiple="true">
            <help>All groups will be analyzed by default if none are selected</help>
            <options>
                <filter type="data_meta" ref="otu" key="groups" />
                <!--
                <filter type="add_value" name="all" value="all" />
                -->
            </options>
        </param>
        <conditional name="designc">
                <param name="usedesign" type="boolean" truevalue="yes" falsevalue="no" checked="false" label="run on a per set basis using a design file"/>
                <when value="yes">
                <param name="design" type="data" format="mothur.design" label="design - assigns groups to sets"
                       help="design has 2 columns: group(col 1) and grouping(col 2) (separated by a TAB character) use make.design"/>
                <param name="sets" type="select" label="sets - group sets to analyze" multiple="true">
                    <options>
                        <filter type="data_meta" ref="design" key="groups" />
                    </options>
                </param>
                </when>
                <when value="no"/>
        </conditional>

        <param name="iters" type="integer" value="1000" min="0" label="iters - Number of randomizations"/>
        <param name="jumble" type="boolean" truevalue="true" falsevalue="false" checked="true" label="jumble"/>
        <param name="calc" type="select" label="calc - Calculators " multiple="true">
            <option value="sharedobserved" selected="true">sharedobserved - the number of sequences in two samples</option>
            <option value="sharednseqs">sharednseqs - the number of sequences in two samples</option>
        </param>
        <conditional name="subsample">
            <param name="usess" type="boolean" truevalue="yes" falsevalue="no" checked="false" label="produce subsample rarefactions"/>
            <when value="yes">
                <param name="subsample" type="integer" value="" optional="true" label="subsample - size pergroup of the sample"
                       help="Leave blank to use the size of your smallest group"/>
                <param name="subsampleiters" type="integer" value="0" optional="true" label="subsampleiters - Number of times to run the subsample"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format="txt" name="logfile" label="${tool.name} on ${on_string}: logfile" />
        <data format="tabular" name="rarefaction" label="${tool.name} on ${on_string}: shared.rarefaction" >
            <filter> 'sharedobserved' in calc.__str__ </filter>
        </data>
        <data format="tabular" name="rarefaction2" label="${tool.name} on ${on_string}: shared.r_nseqs" >
            <filter> 'sharednseqs' in calc.__str__ </filter>
        </data>
    </outputs>
    <tests>
        <test><!-- test with default values -->
            <param name="otu" value="amazon.an.shared" ftype="mothur.shared"/>
            <output name="rarefaction" >
                <assert_contents>
                    <has_text text="numsampled"/>
                    <has_text text="lci"/>
                    <has_text text="hci"/>
                    <has_text text="unique"/>
                    <has_text text="0.22"/>
                    <has_text text="0.33"/>
                    <has_text text="0.55"/>
                </assert_contents>
            </output>
            <expand macro="logfile-test" />
        </test>
        <test><!-- test with label, group and calc select -->
            <param name="otu" value="amazon.an.shared" ftype="mothur.shared"/>
            <param name="groups" value="forest,pasture" />
            <param name="label" value="0.22,0.55" />
            <param name="calc" value="sharedobserved,sharednseqs" />
            <output name="rarefaction" >
                <assert_contents>
                    <has_text text="numsampled"/>
                    <has_text text="lci"/>
                    <has_text text="hci"/>
                    <not_has_text text="unique"/>
                    <has_text text="0.22"/>
                    <not_has_text text="0.33"/>
                    <has_text text="0.55"/>
                </assert_contents>
            </output>
            <output name="rarefaction2" >
                <assert_contents>
                    <has_text text="numsampled"/>
                    <has_text text="lci"/>
                    <has_text text="hci"/>
                    <not_has_text text="unique"/>
                    <has_text text="0.22"/>
                    <not_has_text text="0.33"/>
                    <has_text text="0.55"/>
                </assert_contents>
            </output>
            <expand macro="logfile-test" />
        </test>
        <test><!-- test with design file -->
            <param name="otu" value="amazon.an.shared" ftype="mothur.shared"/>
            <param name="usedesign" value="yes" />
            <param name="design" value="toymothur.design2" ftype="mothur.design"/>
            <param name="sets" value="tardis,dalek" />
            <output name="rarefaction" >
                <assert_contents>
                    <has_text text="numsampled"/>
                    <has_text text="lci"/>
                    <has_text text="hci"/>
                    <has_text text="unique"/>
                    <has_text text="0.22"/>
                    <has_text text="0.33"/>
                    <has_text text="0.55"/>
                </assert_contents>
            </output>
            <expand macro="logfile-test" />
        </test>
        <!-- TODO: test with subsample settings -->
    </tests>
    <help>
<![CDATA[

@MOTHUR_OVERVIEW@

**Command Documenation**

The rarefaction.shared_ command generates inter-sample rarefaction curves using a re-sampling without replacement approach. The traditional way that ecologists use rarefaction is not to randomize the sampling order within a sample, rather between samples. For instance, if we wanted to know the number of OTUs in the human colon, we might sample from various sites within the colon, and sequence a bunch of 16S rRNA genes. By determining the number of OTUs in each sample and comparing the composition of those samples it is possible to determine how well you have sampled the biodiversity within the individual.  For calc parameter choices see: http://www.mothur.org/wiki/Calculators

.. _rarefaction.shared: http://www.mothur.org/wiki/Rarefaction.shared
]]>
    </help>
    <expand macro="citations" />
</tool>
