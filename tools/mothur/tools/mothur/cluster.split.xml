<tool id="mothur_cluster_split" name="Cluster.split" version="@WRAPPER_VERSION@.0">
    <description>Assign sequences to OTUs (Operational Taxonomic Unit) splits large matrices</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />

    <command interpreter="python"><![CDATA[
        mothur_wrapper.py 
        --cmd='cluster.split'
        --result='^mothur.\S+\.logfile$:'$logfile,'^\S+\.sabund$:'$sabund,'^\S+\.rabund$:'$rabund,'^\S+\.list$:'$otulist,'^\S+\.dist$:'$dist_out
        --outputdir='$logfile.extra_files_path'
        #if $splitby.splitmethod == "distance":
            #if $splitby.matrix.format == "column":
                --column="$splitby.matrix.dist"
                --name="$splitby.matrix.name"
            #elif $splitby.matrix.format == "phylip":
                --phylip="$splitby.matrix.dist"
                #if $splitby.matrix.name.__str__ != "None" and len($splitby.matrix.name.__str__) > 0:
                    --name="$splitby.matrix.name"
                #end if
            #end if
            --splitmethod="$splitby.splitmethod"
        #elif $splitby.splitmethod == "classify":
            --column="$splitby.dist"
            --name="$splitby.name"
            --taxonomy="$splitby.taxonomy"
            #if $splitby.taxlevel > 1:
                --taxlevel="$splitby.taxlevel"
            #end if
            --splitmethod="$splitby.splitmethod"
        #elif $splitby.splitmethod == "fasta":
            --fasta="$splitby.fasta"
            --name="$splitby.name"
            --taxonomy="$splitby.taxonomy"
            #if $splitby.taxlevel > 1:
                --taxlevel="$splitby.taxlevel"
            #end if
            --splitmethod="$splitby.splitmethod"
            "$splitby.classic"
        #end if
        #if $count.__str__ != "None" and len($count.__str__) > 0:
                --count="$count"
        #end if
        #if len($method.__str__) > 0:
            --method="$method"
        #end if
        #if float($cutoff.__str__) > 0.0:
            --cutoff="$cutoff"
        #end if
        "$hard"
        #if len($precision.__str__) > 0:
            --precision="$precision"
        #end if
        "$large"
        --processors=\${GALAXY_SLOTS:-8}
        "$cluster"
    ]]></command>
    <inputs>
        <conditional name="splitby">
            <param name="splitmethod" type="select" label="Split by" help="">
                <option value="distance">Distance</option>
                <option value="classify">Classification</option>
                <option value="fasta">Classification using fasta</option>
            </param>
            <when value="distance">
                <conditional name="matrix">
                    <param name="format" type="select" label="Select a Distance Matrix Format" help="">
                        <option value="column">Pairwise Column Matrix</option>
                        <option value="phylip">Phylip Distance Matrix</option>
                    </param>
                    <when value="column">
                        <param name="dist" type="data" format="mothur.pair.dist" label="column - Distance Matrix"/>
                        <param name="name" type="data" format="mothur.names" label="name - Sequences Name reference"/>
                    </when>
                    <when value="phylip">
                        <param name="dist" type="data" format="lower.dist,square.dist" label="phylip - Distance Matrix"/>
                        <param name="name" type="data" format="mothur.names" optional="true" label="name - Sequences Name reference"/>
                    </when>
                </conditional>
            </when>
            <when value="classify">
                <param name="dist" type="data" format="mothur.pair.dist" label="column - Distance Matrix"/>
                <param name="name" type="data" format="mothur.names" label="name - Sequences Name reference"/>
                <param name="taxonomy" type="data" format="mothur.seq.taxonomy" label="taxonomy - Taxonomy (from Classify.seqs)"/>
                <param name="taxlevel" type="integer" value="1" label="taxlevel - taxonomy level for split (default=1)" 
                                            help="taxonomy level you want to use to split the distance file, default=1, meaning use the first taxon in each list"/>
            </when>
            <when value="fasta">
                <param name="fasta" type="data" format="fasta" label="fasta - Sequences"/>
                <param name="name" type="data" format="mothur.names" label="name - Sequences Name reference"/>
                <param name="taxonomy" type="data" format="mothur.seq.taxonomy" label="taxonomy - Taxonomy (from Classify.seqs)"/>
                <param name="taxlevel" type="integer" value="3" label="taxlevel - taxonomy level for split (default=3)" 
                                            help="taxonomy level you want to use to split the distance file, default=1, meaning use the first taxon in each list"/>
                <param name="classic" type="boolean" checked="false" truevalue="--classic=true" falsevalue="" label="classic - Use cluster.classic"/>

            </when>
        </conditional> <!-- splitby -->
        <param name="count" type="data" format="mothur.count_table" optional="true" label="count - a count_table" help="generated by count.seqs"/>
        <param name="method" type="select" label="method - Select a Clustering Method" help="">
            <option value="furthest">Furthest neighbor</option>
            <option value="nearest">Nearest neighbor</option>
            <option value="average" selected="true">Average neighbor</option>
        </param>
        <param name="cutoff" type="float" value="0.0" label="cutoff - Distance Cutoff threshold - ignored if not > 0" 
                                                                    help="Ignore pairwise distances larger than this, a common value would be 0.25"/>
        <param name="hard" type="boolean" checked="true" truevalue="--hard=true" falsevalue="--hard=true" label="hard - Use hard cutoff instead of rounding" 
                                                                    help=""/>
        <param name="precision" type="select" optional="true" label="precision - Precision for rounding distance values"
                                                                    help="Set higher precision for longer genome scale sequence lengths">
            <option value="10">.1</option>
            <option value="100" selected="true">.01</option>
            <option value="1000">.001</option>
            <option value="10000">.0001</option>
            <option value="100000">.00001</option>
            <option value="1000000">.000001</option>
        </param>
        <param name="large" type="boolean" checked="false" truevalue="--large=true" falsevalue="" label="large - distance matrix is too large to fit in RAM" 
                                                                    help="If your job fails due to not enough memory error, set this to true to rerun"/>
        <param name="cluster" type="boolean" falsevalue="" truevalue="--cluster=true" checked="false" label="The cluster parameter allows you to indicate whether you want to run the clustering or just split the distance matrix, default=T. "/>


    </inputs>
    <outputs>
        <data format="html" name="logfile" label="${tool.name} on ${on_string}: logfile" />
        <data format="mothur.rabund" name="rabund" label="${tool.name} on ${on_string}: rabund (Rank Abundance)"/>
        <data format="mothur.sabund" name="sabund" label="${tool.name} on ${on_string}: sabund (Species Abundance)"/>
        <data format="mothur.list" name="otulist" label="${tool.name} on ${on_string}: list (OTU List)"/>
        <data format="mothur.pair.dist" name="dist_out" label="${tool.name} on ${on_string}: Column dist">
            <filter>splitby.splitmethod == 'fasta' </filter>
        </data>
    </outputs>
    <tests>
    </tests>
    <help>
<![CDATA[

@MOTHUR_OVERVIEW@


**Command Documenation**

The cluster.split_ command assign sequences to OTUs (Operational Taxonomy Unit). 

.. _cluster.split: http://www.mothur.org/wiki/Cluster.split

v1.28.0: Upgraded to Mothur 1.33, introduced cluster boolean.

]]>
    </help>
    <expand macro="citations" />
</tool>
