<tool id="mothur_pcr_seqs" name="Pcr.seqs" version="@WRAPPER_VERSION@.0">
    <description>Trim sequences</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />

    <command><![CDATA[
        echo "pcr.seqs(
        
        fasta=$fasta,
        
        #if $name_in:
            name=$name_in,
        #end if
        
        #if $group_in:
            group=$group_in,
        #end if
        
        #if $taxonomy_in:
            taxonomy=$taxonomy_in,
        #end if
        
        #if $trim.method == 'oligos': 
            oligos=$trim.oligos,
            nomatch=$trim.nomatch,
            $trim.keepprimer
        #elif $trim.method == 'reference': 
            ecoli=$trim.ecoli,
        #elif $trim.method == 'position': 
            start=$trim.start,
            
            #if $trim.end and int($trim.end) > 0:
                end=$trim.end,
            #end if
        #end if
        
        #if $pdiffs:
            pdiffs=$pdiffs,
        #end if
        
        $keepdots
        processors=\${GALAXY_SLOTS:-8}
        
        )"
        | sed 's/ //g'  ## mothur trips over whitespace
        | mothur &&
        
        
        ## move output files to correct destination
        prefix="$fasta" &&
        ls -alsh $fasta  && 
        mv mothur.*.logfile "$logfile" &&
        (mv \${prefix%.dat}*.pcr.scrap.dat "$scrap_fasta" 2> /dev/null || touch "$scrap_fasta" ) &&
        mv \${prefix%.dat}*.pcr.dat "$pcr_fasta"
        
        #if $name_in:
            && prefix="$name_in"
            && mv \${prefix%.dat}*.pcr.dat "$name_out"
        #end if
        
        #if $group_in:
            && prefix="$group_in"
            && mv \${prefix%.dat}*.pcr.dat "$group_out"
        #end if
        
        #if $taxonomy_in:
            && prefix="$taxonomy_in"
            && mv \${prefix%.dat}*.pcr.dat "$taxonomy_out"
        #end if
    ]]></command>
    
    <inputs>
        <param name="fasta" type="data" format="fasta" label="fasta - Candiate Sequences"/>
        
        <conditional name="trim">
            <param name="method" type="select" label="Trim with an oligos file?" help="">
                <option value="oligos">oligos</option>
                <option value="reference">reference sequence</option>
                <option value="position">start and end positions</option>
            </param>
            <when value="oligos">
                <param name="oligos"
                       type="data"
                       format="mothur.oligos"
                       optional="true"
                       label="oligos - barcodes and primers"
                       help="a file that can contain the sequences of the forward and reverse primers and barcodes and their sample identifier. 
                             Each line of the oligos file can start with the key words &quot;forward&quot;, &quot;reverse&quot;, 
                             and &quot;barcode&quot; or it can start with a &quot;#&quot; to tell mothur to ignore that line of the oligos file."/>
                
                <param name="nomatch"
                       type="select"
                       label="nomatch - action when no primer is found" 
                       help="">
                    <option value="reject" selected="true">reject (default)</option>
                    <option value="keep">keep</option>
                </param>
                
                <param name="keepprimer"
                       type="boolean"
                       falsevalue=""
                       truevalue="keepprimer=true,"
                       checked="false" 
                       label="keepprimer - keep the primer in the output sequence"/>
            </when>
            <when value="reference">
                <param name="ecoli"
                       type="data"
                       format="fasta"
                       optional="true"
                       label="ecoli - An aligned reference sequence for trimming"
                        help="The ecoli parameter is used to provide a fasta file containing a single reference sequence (e.g. for e. coli)
                              this must be aligned. Mothur will trim to the start and end positions of the reference sequence."/>
            </when>
            <when value="position">
                <param name="start"
                       type="integer"
                       min="0"
                       value="0"
                       optional="true"
                       label="start - a starting position to trim to" />
                
                <!-- Figure out if 'end' is optional - of so, use default as disabled -->
                <param name="end"
                       type="integer"
                       value=""
                       optional="true"
                       label="end - a ending position to trim from">
                    <validator type="in_range" message="Starting position can't be negative and should be " min="0"/>
                </param>
            </when>
        </conditional>
        <!-- trimtype -->

        <param name="keepdots"
               type="boolean"
               falsevalue="keepdots=false,"
               truevalue=""
               checked="true" 
               label="keepdots - keep the leading and trailing alignment dots in the output sequences"/>
        <param name="taxonomy_in"
               type="data"
               format="mothur.seq.taxonomy"
               optional="true"
               label="taxonomy - Sequence Taxonomy"/>
        <param name="name_in"
               type="data"
               format="mothur.names"
               optional="true"
               label="name - Sequence representative name list"/>
        <param name="group_in"
               type="data"
               format="mothur.groups"
               optional="true"
               label="group - Group file"/>
        <param name="pdiffs"
               type="integer"
               value="0"
               min="0"
               label="pdiffs - number of differences to allow in the primer (default 0)"/>
    </inputs>
    
    <outputs>
        <data name="logfile"     format="txt"   label="${tool.name} on ${on_string}: logfile" />
        <data name="pcr_fasta"   format="fasta" label="${tool.name} on ${on_string}: pcr.fasta" />
        <data name="scrap_fasta" format="fasta" label="${tool.name} on ${on_string}: pcr.scrap.fasta" />
        
        <data name="taxonomy_out" format="mothur.seq.taxonomy" label="${tool.name} on ${on_string}: tax.summary">
            <filter>taxonomy_in != None</filter>
        </data>
        <data name="group_out" format="mothur.groups" label="${tool.name} on ${on_string}: mothur.groups">
            <filter>group_in != None</filter>
        </data>
        <data name="name_out" format="mothur.names" label="${tool.name} on ${on_string}: mothur.names">
            <filter>name_in != None</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="fasta" value="Mock_S280_L001_R1_001_small.trim.contigs.good.shhh_seqs.fasta" />
            <param name="keepdots" value="" />
            
            <param name="method" value="position" />
            <param name="start" value="0" />
            <param name="end" value="0" />
            <!--
            <param name="taxonomy_in" value="" />
            <param name="name_in" value="" />
            <param name="group_in" value="" />
            -->
            <param name="pdiffs" value="0" />
            
            <expand macro="logfile-test" />
            <ouptut name="pcr_fasta"   file="pcr.seqs.pcr_fasta.txt" md5sum="1e78af5a460572e22ce199e522a70388"/>
            <output name="scrap_fasta" file="pcr.seqs.pcr_scrap_fasta.txt" md5sum="d41d8cd98f00b204e9800998ecf8427e"/>
        </test>

        <test>
            <param name="fasta" value="Mock_S280_L001_R1_001_small.trim.contigs.good.shhh_seqs.fasta" />
            <param name="keepdots" value="keepdots=false," />
            
            <param name="method" value="reference" />
            <param name="ecoli" value="Mock_S280_L001_R1_001_small.trim.contigs.good.shhh_seqs.fasta" />
            
            <!--
            <param name="taxonomy_in" value="" />
            <param name="group_in" value="" />
            -->
            <param name="name_in" value="Mock_S280_L001_R1_001_small.trim.contigs.good.shhh_seqs.names" />
            
            <param name="pdiffs" value="2" />
            
            <expand macro="logfile-test" />
            <ouptut name="pcr_fasta"   md5="1e78af5a460572e22ce199e522a70388"/>
            <output name="scrap_fasta" md5="d41d8cd98f00b204e9800998ecf8427e"/>
            <output name="name_out"    md5="f3bc939b899d91f7cf3b822c5a822805"/>
        </test>
    </tests>
    <help>
<![CDATA[

@MOTHUR_OVERVIEW@

**Command Documenation**

The pcr.seqs_ command assigns sequences to chosen taxonomy outline.

.. _pcr.seqs: http://www.mothur.org/wiki/Pcr.seqs

]]>
    </help>
    <expand macro="citations" />
</tool>
