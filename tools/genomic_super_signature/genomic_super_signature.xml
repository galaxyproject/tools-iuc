<tool id="genomic_super_signature" name="GenomicSuperSignature" version="0.1.0" profile="20.01">
    <requirements>
        <requirement type="package" version="1.2.0">bioconductor-genomicsupersignature</requirement>
        <requirement type="package" version="1.7.1">r-optparse</requirement>
        <requirement type="package" version="2.6">r-wordcloud</requirement>
        <requirement type="package" version="2.22.0">bioconductor-biocstyle</requirement>
        <requirement type="package" version="2.7.3">r-magick</requirement>
        <requirement type="package" version="2021d">tzdata</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        #set $model = $reference_source.model
        #if $str($reference_source.reference_source_selector) == 'cached':
            #set $model = $model.fields.path
        #end if
        mkdir out &&
        TMPDIR="\$PWD" Rscript '$__tool_directory__/gss.R' --input '$input' --model '$model' --method '$method'  --maxFrom '$maxFrom' --level '$level' --scale '$scale' --numOut $numOut --outDir out --toolDir '$__tool_directory__' --validate '$validate' --html '$html'
    ]]></command>
    <inputs>
        <param argument="--input" type="data" format="tabular,tsv" label="Tabular count matrix"/>
        <conditional name="reference_source">
            <param name="reference_source_selector" type="select" label="Will you select a RAVmodel from your history or use a built-in model?" >
                <option value="cached" selected="true">Use a built-in genome index</option>
                <option value="history">Use a genome from history and build index</option>
            </param>
            <when value="cached">
                <param argument="--model" type="select" label="Using RAVmodel" help="Select model from the list">
                    <options from_data_table="genomic_super_signature_ravmodels">
                        <filter type="data_meta" ref="input" key="dbkey" column="dbkey" />
                    </options>
                    <validator type="no_options" message="A built-in RAVmodel is not available for the build associated with the selected input file"/>
                </param>
            </when>
            <when value="history">
                <param argument="--model" type="data" format="rds" label="RAVmodel to apply" help="You can download a model using the GenomicSuperSingature Downloader tool"/>
            </when>
        </conditional>
        <param argument="--method" type="select" label="Select a correlation coefficient">
            <option value="pearson">Pearson</option>
            <option value="kendall">Kendall</option>
            <option value="spearman">Spearman</option>
        </param>
        <param argument="--maxFrom" type="select" label="Select whether to display the maximum value from dataset's PCs or avgLoadings" help="With Principal Component (PC), the maximum correlation coefficient from top 8 PCs for each avgLoading will be selected as an output. If you choose Average Loading, the Average Loading with the maximum correlation coefficient with each Principal Component will be in the output.">
            <option value="pc">Principal Components</option>
            <option value="avgLoading">Average Loading</option>
        </param>
        <param argument="--level" type="select" label="Output format of validated result" help="max will output the matrix containing only the maximum coefficient. To get the coefficient of all 8 PCs, set this argument to all.">
            <option value="max">Max</option>
            <option value="all">All</option>
        </param>
        <param argument="--scale" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Normalize rows of datasets?"/>
        <param argument="--numOut" type="integer" min="1" value="3" label="The number of top validated RAVs to check"/>
    </inputs>
    <outputs>
        <!-- <data name="plots" format="pdf" label="GenomicSuperSignature plots" from_work_dir="gss_outputs.pdf"/> -->
        <collection name="genesets" type="list" label="GenomicSuperSignature Genesets">
            <discover_datasets pattern=".*_genesets_(?P&lt;name&gt;.+)\.csv" format="csv" directory="out" />
        </collection>
        <collection name="literatures" type="list" label="GenomicSuperSignature Literatures">
            <discover_datasets pattern=".*_literatures_(?P&lt;name&gt;.+)\.csv" format="csv" directory="out" />
        </collection>
        <data name="validate" format="csv" label="GenomicSuperSignature validate.csv">
            <!-- assign_primary_output is broken
            <discover_datasets pattern=".*_(?P&lt;name&gt;.+)_validate\.csv" format="csv" visible="true" assign_primary_output="true" directory="out"/>
        -->
        </data>
        <data name="html" format="html" label="GenomicSuperSignature report.html">
            <!-- assign_primary_output is broken
            <discover_datasets pattern="GSS-(?P&lt;name&gt;.+)\.html" format="html" visible="true" assign_primary_output="true" directory="out"/>
        -->
        </data>
    </outputs>
    <tests>
        <test>
            <param name="input" value="bcellViperExpr_10C.tsv.gz" dbkey="hg38" ftype="tabular"/>
            <param name="reference_source|reference_source_selector" value="cached"/>
            <param name="reference_source|model" value="C2" dbkey="hg38"/>
            <param name="method" value="Pearson"/>
            <param name="maxFrom" value="Principal Components"/>
            <param name="level" value="Max"/>
            <param name="numOut" value="1"/>
            <output name="html" ftype="html">
                 <assert_contents>
                    <has_n_lines n="2843"/>
                 </assert_contents>
             </output>
            <output name="validate" value="GenomicSuperSignature validate.csv" ftype="csv"/>
        </test>
    </tests>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
</tool>
