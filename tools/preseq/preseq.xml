<tool id="preseq" name="Preseq" version="3.2.0+galaxy0" profile="25.1">
    <description>Library Complexity Analysis (c_curve &amp; lc_extrap)</description>
    
    <requirements>
        <requirement type="package" version="3.2.0">preseq</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        ## 1. File Preparation: Symlink the input BAM to a standard name
        ln -s '$input_bam' input.bam &&
        
        ## 2. Select Analysis Mode and Execute
        preseq $analysis_type.mode 
            
            ## Common Parameters
            -B input.bam
            
            #if $verbose:
                -v
            #end if

            ## Mode: c_curve Parameters
            #if $analysis_type.mode == "c_curve":
                -s $analysis_type.step_size
                #if $analysis_type.max_read_len:
                    -l $analysis_type.max_read_len
                #end if
            #end if
            
            ## Mode: lc_extrap Parameters
            #if $analysis_type.mode == "lc_extrap":
                -e $analysis_type.extrap_limit
                -s $analysis_type.step_size_extrap
            #end if

            ## Output File
            -o '$output_tsv' 
            
            ## Capture Stderr to Log File
            2> '$output_log'
    ]]></command>

    <inputs>
        <param name="input_bam" type="data" format="bam" label="Input BAM file" help="IMPORTANT: This BAM file must be sorted by coordinate!"/>
        
        <conditional name="analysis_type">
            <param name="mode" type="select" label="Select Analysis Mode">
                <option value="c_curve" selected="true">Complexity Curve (c_curve)</option>
                <option value="lc_extrap">Yield Extrapolation (lc_extrap)</option>
            </param>
            
            <when value="c_curve">
                <param argument="-s" name="step_size" type="integer" value="1000" min="100" label="Step Size" help="Step size for the calculation (Default: 1000)."/>
                <param argument="-l" name="max_read_len" type="integer" optional="true" label="Maximum Read Length" help="Leave empty to use default."/>
            </when>
            
            <when value="lc_extrap">
                <param argument="-e" name="extrap_limit" type="integer" value="10000000" label="Extrapolation Limit" help="Total number of reads to extrapolate to (Default: 10M)."/>
                <param argument="-s" name="step_size_extrap" type="integer" value="100000" label="Step Size" help="Step size for extrapolation."/>
            </when>
        </conditional>

        <param argument="-v" name="verbose" type="boolean" truevalue="-v" falsevalue="" checked="false" label="Verbose Output" help="Print more information to log."/>
    </inputs>

    <outputs>
        <data name="output_tsv" format="tsv" label="${tool.name} (${analysis_type.mode}) on ${on_string}: Output"/>
        <data name="output_log" format="txt" label="${tool.name} (${analysis_type.mode}) on ${on_string}: Log" hidden="true"/>
    </outputs>

    <tests>
        <test expect_num_outputs="2">
            <param name="input_bam" value="test.bam" ftype="bam"/>
            <conditional name="analysis_type">
                <param name="mode" value="c_curve"/>
                <param name="step_size" value="1000"/>
            </conditional>
            <output name="output_tsv" file="test_c_curve.tsv" ftype="tsv" lines_diff="4"/>
        </test>
    </tests>

    <help><![CDATA[
**Preseq: Library Complexity Analysis**

This tool estimates the complexity of a sequencing library. It wraps both `c_curve` and `lc_extrap` functions of the Preseq package.

**Modes:**

* **Complexity Curve (c_curve):** Plots the number of distinct reads against the number of total reads. Useful for seeing if you have sequenced enough.
* **Yield Extrapolation (lc_extrap):** Predicts the expected yield of distinct reads for future sequencing efforts (e.g., "If I sequence 100M more reads, how many unique molecules will I get?").

**Input:**
* A coordinate-sorted BAM file.

**Output:**
* A TSV file suitable for plotting (e.g., in MultiQC).
    ]]></help>
    <citations>
        <citation type="doi">10.1038/nmeth.2375</citation>
    </citations>
</tool>