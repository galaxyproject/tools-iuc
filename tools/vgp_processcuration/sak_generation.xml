<tool id="vgp_sak_generation" name="VGP SAK Generation" version="@TOOL_VERSION@+galaxy0" profile="@PROFILE@">
    <description>Generate gfastats SAK instructions for sequence reversal and renaming</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        sak_generation
            -1 '$hap1_mapping'
            -2 '$hap2_mapping'
            -r '$reference'
            -q '$query'
            -a '$agp'
            -m '$mashmap'
            -o './'

    ]]></command>
    <inputs>
        <param name="hap1_mapping" type="data" format="tabular" label="Haplotype 1 chromosome mapping"
            help="File from chromosome_assignment for Haplotype 1." />
        <param name="hap2_mapping" type="data" format="tabular" label="Haplotype 2 chromosome mapping"
            help="From chromosome_assignment for Haplotype 2." />
        <param name="agp" type="data" format="tabular" label="Corrected AGP file"
            help="Corrected AGP file from split_agp containing both Hap_1 and Hap_2 tags." />
        <param name="mashmap" type="data" format="tabular" label="MashMap Alignment"
            help="MashMap alignment output file comparing the two haplotypes." />

        <param name="query" type="select" label="Query haplotype"
            help="Haplotype used as query in MashMap alignment.">
            <option value="Hap_2" selected="true">Haplotype 2</option>
            <option value="Hap_1">Haplotype 1</option>
        </param>
        <param name="reference" type="select" label="Reference haplotype"
            help="Haplotype used as reference in MashMap alignment.">
            <option value="Hap_1" selected="true">Haplotype 1</option>
            <option value="Hap_2">Haplotype 2</option>
        </param>
    </inputs>
    <outputs>
        <data name="sak_file" format="tabular" from_work_dir="reversing_renaming.sak"
            label="${tool.name} on ${on_string}: SAK Instructions for gfastats processsing"/>
        <data name="orientation" format="tabular" from_work_dir="orientation.tsv"
            label="${tool.name} on ${on_string}: Orientation Table"/>
        <data name="missing" format="tabular" from_work_dir="missing.tsv"
            label="${tool.name} on ${on_string}: Missing Pairs">
            <filter>True</filter> <!-- Output if file exists -->
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="3">
            <param name="hap1_mapping" value="expected_hap1_inter_chr.tsv" ftype="tabular"/>
            <param name="hap2_mapping" value="expected_hap2_inter_chr.tsv" ftype="tabular"/>
            <param name="agp" value="expected_corrected.agp" ftype="tabular"/>
            <param name="mashmap" value="test_mashmap.out" ftype="tabular"/>
            <param name="query" value="Hap_2"/>
            <param name="reference" value="Hap_1"/>
            <output name="sak_file" file="expected_reversing_renaming.sak" ftype="tabular"/>
            <output name="orientation" file="expected_orientation.tsv" ftype="tabular"/>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

sak_generation processes MashMap alignment output to identify scaffold pairs between haplotypes, generating
instruction files for sequence reversal and renaming operations using gfastats SAK (Swiss Army Knife) format.

The tool analyzes alignments between two haplotypes and produces instructions to:

1. Reverse-complement sequences that are inverted relative to the reference haplotype
2. Rename FASTA headers to ensure consistent naming between haplotypes
3. Document orientation relationships between paired scaffolds
4. Identify curated pairs that are missing from the alignments

**Inputs**

- **Haplotype 1 chromosome mapping**: inter_chr.tsv file from chromosome_assignment for Hap1
- **Haplotype 2 chromosome mapping**: inter_chr.tsv file from chromosome_assignment for Hap2
- **Corrected AGP file**: Corrected AGP from split_agp containing both haplotype tags
- **MashMap output**: Alignment file from MashMap comparing the two chromosome-level haplotypes
- **Query haplotype**: Which haplotype was used as query in MashMap (default: Hap_2)
- **Reference haplotype**: Which haplotype was used as reference in MashMap (default: Hap_1)

**Outputs**

- **SAK Instructions (reversing_renaming.sak)**: Tab-separated file containing sequential commands for gfastats:

  - RVCP commands: Reverse-complement specified sequences
  - RENAME commands: Rename FASTA headers

- **Orientation Table (orientation.tsv)**: Shows the most frequent alignment orientation for each scaffold pair

- **Missing Pairs (missing.tsv)**: Lists curated scaffold pairs that were not found in MashMap alignments (for quality control)

**SAK File Format**

The SAK file contains tab-separated commands processed sequentially by gfastats:

- ``RVCP <sequence_name>`` - Reverse-complements a sequence in place
- ``RENAME <old_name> <new_name>`` - Renames a FASTA header

Example SAK file::

    RVCP    SUPER_5
    RENAME  SUPER_5 chr5
    RVCP    SUPER_X
    RENAME  SUPER_X chrX

**Workflow Context**

This tool is used after running chromosome_assignment on both haplotypes:

1. Run split_agp to separate haplotypes
2. Sort each haplotype with gfastats
3. Run chromosome_assignment on both haplotypes (produces inter_chr.tsv files)
4. Align haplotypes with MashMap
5. **Run sak_generation** (this tool) to create SAK instructions
6. Apply SAK instructions with gfastats to finalize the query haplotype

**Applying SAK Instructions**

After generating the SAK file, use gfastats to apply the instructions::

    gfastats input.fasta -k reversing_renaming.sak -o output.fasta

This will reverse-complement and rename sequences as specified in the SAK file.

.. class:: infomark

**More Information**

This tool is part of the VGP ProcessCuration pipeline for preparing curated genome assemblies for submission.

<expand macro="help_common"/>
    ]]></help>
    <expand macro="citations"/>
</tool>
