<tool id="nucmer" name="Nucmer" version="0.1.0">
    <requirements>
        <requirement type="package" version="4.0.0beta2">mummer4</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
        #set $query=""+"".join(str($query_sequence).split(','))+""
        nucmer 
            $anchoring
            -b $breaklen
            -c $mincluster
            -D $diagdiff
            -d $diagfactor
            $noextend
            $direction
            -g $maxgap
            -l $minmatch
            -L $minalign
            $nooptimize
            $nosimplify
            --threads \${GALAXY_SLOTS:-1}
            #if $options.advanced == 'enable':
                $banded
                $large
                $genome
                -M $max_chunk
            #end if
            -p '$prefix'
            '$reference_sequence' '$query' 
        ]]>   	
    </command> 
    <inputs>
        <param name="reference_sequence" type="data" format="fasta" label="Reference Sequence" />
        <param name="query_sequence" type="data" format="fasta" multiple="True" label="Query Sequence" />
        <param name="anchoring" type="select" label="Match anchoring strategy">
            <option value="">Use default</option>
            <option value="--mum">Unique matches only</option>
            <option value="--maxmatch">All matches</option>
        </param>
        <param name="breaklen" type="integer" argument="-b" value="200" label="Break Length" help="Set the distance an alignment extension will attempt to extend poor scoring regions before giving up" />
        <param name="mincluster" type="integer" argument="-c" value="65" label="Minumum Cluster Length" help="Sets the minimum length of a cluster of matches" />
        <param name="diagdiff" type="integer" argument="-D" value="5" label="Maximum Diagonal Difference" help="Set the maximum diagonal difference between two adjacent anchors in a cluster" />
        <param name="diagfactor" type="float" argument="-d" value="0.12" label="Maximum Diagonal Difference as Fraction" help="Set the maximum diagonal difference between two adjacent anchors in a cluster as a differential fraction of the gap length" />
        <param name="noextend" type="boolean" argument="--noextend" truevalue="--noextend" falsevalue="" label="No Extend" help="Do not perform cluster extension step" />
        <param name="direction" type="select" label="Direction of Query Sequence to Use">
            <option value="">Use foward and reverse sequences</option>
            <option value="-f">Use only forward sequence of query</option>
            <option value="--reverse">Use only reverese sequence of query</option>
        </param>
        <param name="maxgap" type="integer" argument="-g" value="90" label="Maximum Gap Distance" help="Set the maximum gap between two adjacent matches in a cluster" />
        <param name="minmatch" type="integer" argument="-l" value="20" label="Minimum Match Length" help="Set the minimum length of a single exact match" />
        <param name="minalign" type="integer" argument="-L" value="0" label="Minumum Alignment Length" help="Minimum length of an alignment, after clustering and extension" />
        <param name="nooptimize" type="boolean" argument="--nooptimize" truevalue="--nooptimize" falsevalue="" label="Alignment Score Optimization" help="No alignment score optimization, i.e. if an alignment extension reaches the end of a sequence, it will not backtrack to optimize the alignment score and instead terminate the alignment at the end of the sequence" />
        <param name="nosimplify" type="boolean" argument="--nosimplify" truevalue="--nosimplify" falsevalue="" label="Simplify Alignments" help="Don't simplify alignments by removing shadowed clusters. Use this option when aligning a sequence to itself to look for repeats" />
        <conditional name="options">
            <param name="advanced" type="select" label="Additional options">
                <option value="enable">Select additional options</option>
                <option value="defaults">Use defaults</option>
            </param>
            <when value="enable">
                <param name="banded" type="boolean" argument="--banded" truevalue="--banded" falsevalue="" label="Banding" help="Enforce absolute banding of dynamic programming matrix based on diagdiff parameter" />
                <param name="large" type="boolean" argument="--large" truevalue="--large" falsevalue="" label="Force the use of large offsets" help="" />
                <param name="genome" type="boolean" argument="-G" truevalue="-G" falsevalue="" label="Map genome to genome" help="For long query sequences" />
                <param name="max_chunk" type="integer" argument="-M" value="50000" label="Max Chunk" help="Stop adding sequence for a thread if more than MAX already." />
            </when>
            <when value="defaults" />
        </conditional>
        <param name="prefix" type="text" value="nucmer" label="File Prefix" help="Enter a file prefix or keep the default" />
    </inputs> 
    <outputs>
        <data name="output" format="txt" from_work_dir="test.txt" />
    </outputs>
    <tests>
        <test>
            <param name="advanced" value="defaults" />
            <param name="reference_sequence" ftype="fasta" value="K12.fasta"/>
            <param name="query_sequence" ftype="fasta" value="O157.fasta" />
            <output name="output" ftype="txt" compare="diff" lines_diff="4" value="test.txt"/>
        </test>
    </tests>
    <help><![CDATA[
        Nucmer generates nucleotide alignments between two mutli-FASTA input
        files. The output file lists the distance between insertions
        and deletions that produce maximal scoring alignments between each
        sequence.
    ]]></help>
    <citations>
        <citation type="bibtex">
            @misc{githubmummer,
            author = {Art Delcher, Stefan Kurtz, Adam Phillippy, Steven Salzberg},
            year = {2012},
            title = {mummer4},
            publisher = {GitHub},
            journal = {GitHub repository},
            url = {https://github.com/mummer4/mummer},
        }</citation>
    </citations>
</tool>