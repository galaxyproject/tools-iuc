<tool id="virAnnot_otu" name="virAnnot OTU" version="1.0.0+galaxy0" python_template_version="3.6" profile="21.05">
    <description>create viral OTUs based on RPS and Blast annotations</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements_converter" />
    <command detect_errors="aggressive"><![CDATA[

@HEADLESS@

'$__tool_directory__/otu.py'
    #if $blast_files
        #for $blast_file in $blast_files
            -b '$blast_file'
        #end for
    #end if 
    #for $rps_file in $rps_files
        -r '$rps_file'
    #end for
    #for $fasta_file in $fasta_files
        -f '$fasta_file'
    #end for
    -p '$percentage'
    -vp '$viral_portion'
    -mpl '$min_prot_length'
    -tp '$__tool_directory__/'
    -o otu_output

    && zip -r out.zip otu_output

    ]]></command>
    <inputs>
        <param type="data" name="blast_files" format="tsv" label="Blast results file with taxonomy" multiple="true" optional="true"
            help="Give one file per sample. If a file is missing, give none." />
        <param type="data" name="rps_files" format="tsv" label="RPS results file" multiple="true" />
        <param type="data" name="fasta_files" format="fasta" label="Contigs file" multiple="true" />
        <param type="select" name="percentage" label="Similarity threshold percentage for OTUs cutoff">
            <option value="70">70</option>
            <option value="80">80</option>
            <option value="90" selected="true">90</option>
            <option value="100">100</option>
        </param>
        <param type="select" name="viral_portion" label="Minimun portion of viral sequences in RPS domain to be included">
            <option value="0.1">0.1</option>
            <option value="0.2">0.2</option>
            <option value="0.3" selected="true">0.3</option>
            <option value="0.4">0.4</option>
            <option value="0.5">0.5</option>
        </param>
        <param type="select" name="min_prot_length" label="Minimum query protein length">
            <option value="50">50</option>
            <option value="80">80</option>
            <option value="100" selected="true">100</option>
            <option value="150">150</option>
            <option value="200">200</option>
        </param>
    </inputs>
    <outputs>
        <data format="xlsx" name="otu_table" label="${tool.name} on ${on_string}: otu_stats" from_work_dir="otu_output/otu_stats.xlsx" />
        <data format="zip" name="archive_output" label="${tool.name} on ${on_string}: zip of the complete output" from_work_dir="out.zip" />
    </outputs>
    <tests>
        <test>
            <param name="blast_files" value="otu_s1_tblastx.tab,otu_s2_tblastx.tab"/>
            <param name="rps_files" value="otu_s1_rps.tab,otu_s2_rps.tab"/>
            <param name="fasta_files" value="otu_s1.fa,otu_s2.fa"/>
            <param name="percentage" value="90"/>
            <param name="viral_portion" value="0.3"/>
            <param name="min_prot_length" value="100"/>
            <!-- check created zip -->
            <output name="archive_output">
                <assert_contents>
                    <has_archive_member path=".*\/index.html" />
                    <has_archive_member path=".*\/pfam00680_RdRP_1/seq_aligned.final_tree.fa" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[

    -b    tsv blast file from blast2tsv module [optional]
    -r    tsv rpsblast file from rps2tsv module
    -f    FASTA file with contigs
    -p    Percentage similarity threshold for OTUs cutoff, 90% is a good proxy for viral familly
    -vp   Minimun portion of viral sequences in RPS domain to be included
    -mpl  Minimum query protein length

If no blast file is given, OTUs will not have an associated taxonomy.
Files are processed in alphabetical order. Make sure that the files (blast, rps and contig) for a sample are named in the same way, otherwise they will be disassociated.

    ]]></help>
    <expand macro="citations" />
</tool>