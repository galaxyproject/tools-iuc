<tool id="nudup" name="NuGen nudup" version="0.1.1">
    <requirements>
        <requirement type="package" version="1.2">samtools</requirement>
        <requirement type="package" version="1.7">gzip</requirement>
        <requirement type="package" version="2.7.7">python</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command><![CDATA[
        ln -sf "$input2" "$input2".bam && python2.7 $__tool_directory__/nudup/nudup.py -f "$input1" -o out 
        #if $advanced.adv_boolean == "True":
          -s ${advanced.start}
          -l ${advanced.length}
        #end if
        $pairedend
        "$input2".bam
    ]]></command>
    <inputs>
        <param type="data" name="input1" label="Select FASTQ file" format="fastq" />
        <param type="data" name="input2" label="Select SAM/BAM file" format="bam,sam" />
        <param name="pairedend" type="boolean" checked="false" falsevalue="" truevalue="-2" label="Paired end?" />
        <param name="outputs" type="select" label="Output options" help="default output is a deleted duplicates bam file">
          <option value="deleted" selected="True" >deleted duplicates (bam file)</option>
          <option value="marked" >deleted duplicates and marked duplicates (bam file)</option>
        </param>
        <param name="logfile_bol" type="boolean" checked="false" falsevalue="" truevalue="log" label="Output logfile?" />
        <conditional name="advanced">
            <param name="adv_boolean" type="boolean" checked="false" falsevalue="False" truevalue="True" label="Select advanced options" />
            <when value="True">
                <param name="start" type="integer" value="6" label="Start" help="Position in index read where molecular tag sequence begins. This should be a 1-based value that counts in from the 3' END of the read. (default = 6)."/>
                <param name="length" type="integer" value="6" label="Length" help="Length of molecular tag sequence (default = 6)."/>
            </when>
            <when value="False">
            </when>
        </conditional> 
    </inputs>
    <outputs>
      <data format="bam" name="bam_file1" label="${tool.name} on ${on_string}: sorted.dedup.bam" from_work_dir="out.sorted.dedup.bam"/>
      <data format="bam" name="bam_file2" label="${tool.name} on ${on_string}: sorted.markdup.bam" from_work_dir="out.sorted.markdup.bam">
        <filter>outputs == 'marked'</filter>
      </data>
      <data format="txt" name="logfile" label="${tool.name} on ${on_string}: log" from_work_dir="out_dup_log.txt">
        <filter>logfile_bol</filter>
      </data>
    </outputs>
    <tests>
        <test>
            <param name="input1" value="index.fastq"/>
            <param name="input2" value="mappedreads.bam"/>
            <param name="pairedend" value="-2"/>
            <param name="outputs" value="deleted" />
            <param name="logfile_bol" value=""/>
            <conditional name="advanced">
              <param name="adv_boolean" value="False"/>
            </conditional>
            <output name="bam_file1" file="out.bam"/>
        </test>
    </tests>
    <help><![CDATA[
NUGEN nudup:
        
Marks/removes PCR introduced duplicate molecules based on the molecular tagging
technology used in NuGEN products.

For SINGLE END reads, duplicates are marked if they fulfill the following
criteria: a) start at the same genomic coordinate b) have the same strand
orientation c) have the same molecular tag sequence. The read with the
highest mapping quality is kept as the non-duplicate read.

For PAIRED END reads, duplicates are marked if they fulfill the following
criteria: a) start at the same genomic coordinate b) have the same template
length c) have the same molecular tag sequence. The read pair with the highest
mapping quality is kept as the non-duplicate read.

Here are the two cases for running this tool:

CASE 1 (Standard): User supplies two input files,

 1) SAM/BAM file that a) ends with .sam or .bam extension b) contains unique
    alignments only

 2) FASTQ file (ie: the Index FASTQ) that contains the molecular tag sequence
    for each read name in the corresponding SAM/BAM file as either a) the read
    sequence or b) in the FASTQ entry header name. If the index FASTQ read
    length is 6, 8, 12, 14, or 18nt long as expected for NuGEN products, the
    molecular tag sequence to be extracted from the read according to -s and -l
    parameters, otherwise the molecular tag will be extracted from the header
    of the FASTQ entry.

CASE 2 (Runtime Optimized): User supplies only one input file,

 1) SAM/BAM file that a) ends with .sam or .bam extension b) contains unique
    alignments only c) is sorted d) has a fixed length sequence containing the
    molecular tag appended to each read name.

Author: Anand Patel
Contact: NuGEN Technologies Inc., techserv@nugen.com

-- wrapped by Jochen Bick jochen.bick@usys.ethz.ch --

]]></help>
    <citations>
        <citation type="bibtex">
@misc{githubnudup,
  author = {Anand Patel, NuGEN Technologies Inc.},
  year = {2015},
  title = {NuGEN nudup},
  publisher = {GitHub},
  journal = {GitHub repository},
  url = {https://github.com/nugentechnologies/nudup},
}</citation>
    </citations>
</tool>
