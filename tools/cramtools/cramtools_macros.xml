<macros>
    <xml name="requirements">
        <requirements>
            <requirement type="package" version="3.0">cramtools</requirement>
            <requirement type="package" version="0.1.19">samtools</requirement>
        </requirements>
    </xml>

    <xml name="stdio">
        <stdio>
            <exit_code range="1:" />
            <exit_code range=":-1" />
        </stdio>
    </xml>
    
    <xml name="version_command">
        <version_command>java -jar $CRAMTOOLS_ROOT_DIR/jars/cramtools-3.0.jar | grep Version</version_command>
    </xml>

    <xml name="fasta_input">
        <conditional name="reference_source">
            <param name="reference_source_selector" type="select" label="Load reference genome from">
                <option value="cached">Local cache</option>
                <option value="history">History</option>
            </param>
            <when value="cached">
                <param name="input_reference" type="select" format="fasta" label="Genome reference FASTA file">
                    <options from_data_table="all_fasta">
                        <filter type="data_meta" ref="input_alignment" key="dbkey" column="1" />
                    </options>
                    <validator type="no_options" message="A built-in reference genome is not available for the build associated with the selected input file"/>
                </param>
            </when>
            <when value="history">
                <param name="input_reference" type="data" format="fasta" label="Genome reference FASTA file"/>
            </when>
        </conditional>
    </xml>
    
    <token name="@PREPROCESS_FASTA_FILE@"><![CDATA[
        ## Cramtools requires the fasta file to hava a certain extension
        ln -s $reference_source.input_reference "${reference_source.input_reference}.fa" &&
        
        ## Cramtools requires indexed fasta files but can't provide them itself
        samtools faidx "${reference_source.input_reference}.fa" &&
    ]]></token>
</macros>
