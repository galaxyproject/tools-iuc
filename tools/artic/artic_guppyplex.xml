<tool id="artic_guppyplex" name="ARTIC guppyplex" version="@PACKAGE_VERSION@+galaxy0" profile="20.09">
    <description>Filter Nanopore reads by read length and (optionally) quality</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="@PACKAGE_VERSION@">artic</requirement>
    </requirements>
    <command detect_errors="exit_code">
    <![CDATA[
        #if str($input_options.input_type) == 'collection'
            #for $input in $input_options.input_col
                ln -fs \$(realpath "$input") \$(echo \$(basename "$input") | cut -f 1 -d '.').fastq &&
            #end for
        #elif str($input_options.input_type) == 'single':
            ln -fs \$(realpath "$input_single") \$(echo \$(basename "$input_single") | cut -f 1 -d '.').fastq &&
        #end if
        artic guppyplex --min-length $min_length --max-length $max_length
            --directory 
            #if str($input_options.input_type) == 'collection'
                "\$(pwd \$(echo \$(basename "$input_options.input_col[0]") | cut -f 1 -d '.').fastq)"
            #elif str($input_options.input_type) == 'single':
                "\$(pwd \$(echo \$(basename "$input_single") | cut -f 1 -d '.').fastq)"
            #end if
            --prefix artic_guppyplex --output "$output1"   
    ]]>
    </command>
    <inputs>
        <conditional name="input_options">
            <param name="input_type" type="select" label="Select input type"
                    help="Select between paired and single end data">
                <option value="collection">Fastq collection</option>
                <option value="single">Single fastq</option>
            </param>
            <when value="collection">
                <param name="input_col" format="fastq" type="data_collection" collection_type="list" 
                    label="Select a fastq collection" help="See help section for an explanation of dataset collections"/>
            </when>
             <when value="single">
                <param name="input_single" type="data" format="fastq"
                    label="Select fastq dataset" help="Specify dataset with single reads"/>
            </when>
        </conditional>
        <param name="max_length" type="integer" label="Remove reads longer than" value="700" help="remove reads greater than this number of base pairs" />
        <param name="min_length" type="integer" label="Remove reads shorter than" value="400" help="remove reads less than this number of base pairs" />
        <param name="skip_quality_check" argument="--skip-quality-check" type="boolean" truevalue="--skip-quality-check" falsevalue="" checked="False" label="Do not filter on quality score (speeds up processing)" />
    </inputs>
    <outputs>
        <data name="output1" format="fastq" from_work_dir="run_name_.fastq" />
    </outputs>
    <tests>
        <test>
            <conditional name="input_options">
                <param name="input_type" value="single" />
                <param name="input_single" value="test.fastq"/>
            </conditional>
            <output name="output1" file="gupplyplex_output.fastq"/>
        </test>
    </tests>
    <help><![CDATA[
        The ARTIC_ guppyplex tool filters reads by length and (optionally) quality.
        This filter is typically used as a pre-processing step in the processing
        of amplicon sequencing Nanopore reads, where a size-based filter can
        be used to remove possibly-chimeric reads.
        
        The default paramters of the tool (minimum length of 400 and maximum of 700)
        are based on the ARTIC amplicon scheme. If used with a different amplicon
        scheme they should be adjusted to use the minimum length of an amplicon as
        the minimum length and the maximum length of an amplicon plus 200 as the
        maximum length.

        .. _ARTIC: https://artic.readthedocs.io/en/latest/
    ]]></help>
    <expand macro="citations" />
</tool>