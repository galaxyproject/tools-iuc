<tool id="alphagenome_sequence_predictor" name="AlphaGenome Sequence Predictor" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="23.0">
    <description>Predict regulatory tracks from DNA sequence</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements">
        <expand macro="credentials"/>
    </expand>

    <version_command>python '$__tool_directory__/alphagenome_sequence_predictor.py' --version</version_command>

    <command detect_errors="exit_code"><![CDATA[
        python '$__tool_directory__/alphagenome_sequence_predictor.py'
            --input '$input_fasta'
            --output '$output_tsv'
            --organism '$organism'
            --output-types
            #for $otype in $output_types
                '$otype'
            #end for
            --sequence-length '$sequence_length'
            --max-sequences $max_sequences
            --output-mode '$output_mode.mode'
            #if str($output_mode.mode) == "binned"
                --bin-size $output_mode.bin_size
            #end if
            #if str($ontology_terms).strip()
                --ontology-terms '$ontology_terms'
            #end if
            #if $test_fixture
                --test-fixture '$test_fixture'
            #end if
            #if $verbose
                --verbose
            #end if
    ]]></command>

    <inputs>
        <param name="input_fasta" type="data" format="fasta" label="Input FASTA file"
               help="DNA sequences to predict regulatory tracks for"/>

        <param name="organism" type="select" label="Organism">
            <option value="human" selected="true">Human (hg38)</option>
            <option value="mouse">Mouse (mm10)</option>
        </param>

        <param name="output_types" type="select" multiple="true" display="checkboxes"
               label="Output types to predict">
            <option value="RNA_SEQ" selected="true">RNA-seq</option>
            <option value="ATAC">ATAC-seq</option>
            <option value="CAGE">CAGE</option>
            <option value="DNASE">DNase</option>
            <option value="CHIP_HISTONE">ChIP-seq histone</option>
            <option value="CHIP_TF">ChIP-seq TF</option>
            <option value="SPLICE_SITES">Splice sites</option>
            <option value="PROCAP">PRO-cap</option>
            <validator type="no_options" message="Select at least one output type"/>
        </param>

        <param name="ontology_terms" type="text" value="" label="Ontology terms (optional)"
               help="Comma-separated UBERON/CL terms for tissue context, e.g. UBERON:0002107,CL:0000746"/>

        <param name="sequence_length" type="select" label="Prediction window size"
               help="Sequences shorter than the window are N-padded; longer sequences are center-trimmed">
            <option value="16KB" selected="true">16 KB (recommended for synbio)</option>
            <option value="128KB">128 KB</option>
            <option value="512KB">512 KB</option>
            <option value="1MB">1 MB</option>
        </param>

        <param name="max_sequences" type="integer" value="20" min="1" max="1000"
               label="Maximum sequences to process"
               help="API is rate-limited; start small to verify results"/>

        <conditional name="output_mode">
            <param name="mode" type="select" label="Output mode">
                <option value="summary" selected="true">Summary (one row per sequence x track)</option>
                <option value="binned">Binned (spatial resolution within sequences)</option>
            </param>
            <when value="summary"/>
            <when value="binned">
                <param name="bin_size" type="integer" value="128" min="1" max="4096"
                       label="Bin size (bp)"
                       help="Divide each sequence into bins of this width for spatial resolution"/>
            </when>
        </conditional>

        <param name="verbose" type="boolean" checked="false" truevalue="true" falsevalue="false"
               label="Verbose logging"/>

        <param name="test_fixture" type="data" format="json" optional="true"
               label="Test fixture (internal)" help="For automated testing only"/>
    </inputs>

    <outputs>
        <data name="output_tsv" format="tabular" label="${tool.name} on ${on_string}: Predictions"/>
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <param name="input_fasta" value="test_sequences.fa"/>
            <param name="organism" value="human"/>
            <param name="output_types" value="RNA_SEQ"/>
            <param name="sequence_length" value="16KB"/>
            <param name="max_sequences" value="2"/>
            <conditional name="output_mode">
                <param name="mode" value="summary"/>
            </conditional>
            <param name="test_fixture" value="fixture_sequence_predictor.json" ftype="json"/>
            <output name="output_tsv">
                <assert_contents>
                    <has_text text="sequence_id"/>
                    <has_text text="mean_signal"/>
                    <has_text text="max_signal"/>
                    <has_text text="test_promoter_1"/>
                    <has_text text="RNA_SEQ"/>
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**AlphaGenome Sequence Predictor**

Predicts regulatory tracks from raw DNA sequence using AlphaGenome's
``predict_sequence()`` API. No genomic coordinates needed — designed for
synthetic biology sequences, designed regulatory elements, and
non-reference assemblies.

-----

**What it does**

For each sequence in the input FASTA file:

1. Pads short sequences with N bases (centered) or center-trims long sequences
   to fit the prediction window size
2. Calls ``predict_sequence()`` for selected output types
3. Computes summary statistics over the actual sequence content (excluding N padding)
4. Reports per-track values in tabular format

-----

**Sequence handling**

- Sequences **shorter** than the window size are N-padded (centered). The model
  still makes predictions, and statistics are computed only over the real content.
- Sequences **longer** than the window are center-trimmed to fit.
- Sequences **equal** to the window size are used as-is.

For typical synbio applications (promoters, enhancers, etc.), the 16 KB window
is recommended as sequences are usually short.

-----

**Output modes**

- **Summary**: One row per sequence x track with mean and max signal.
- **Binned**: Divides each sequence into fixed-width bins (default 128bp) and
  reports mean signal per bin for spatial resolution.

-----

**Output columns — summary mode**

- ``sequence_id`` — FASTA header ID
- ``sequence_length`` — original sequence length before padding/trimming
- ``output_type`` — RNA_SEQ, ATAC, etc.
- ``track_name`` — specific experimental track
- ``ontology_curie`` — tissue/cell type ontology term
- ``mean_signal`` — mean predicted signal
- ``max_signal`` — maximum predicted signal

**Output columns — binned mode**

- ``sequence_id`` — FASTA header ID
- ``bin_start``, ``bin_end`` — bin coordinates within the sequence
- ``output_type``, ``track_name``, ``ontology_curie`` — as above
- ``mean_signal`` — mean predicted signal in the bin

-----

**Use cases**

- Evaluate designed promoter/enhancer sequences
- Predict splicing of synthetic gene constructs
- Characterize regulatory elements from non-reference genomes
- Compare predicted activity of sequence variants in synthetic biology

-----

**Citation**

Avsec et al. (2025). "Predicting the impact of genetic variants on chromatin,
genes, and RNA processing with a unified model." *Nature*.
DOI: 10.1038/s41586-025-10014-0
    ]]></help>

    <expand macro="citations"/>
</tool>
