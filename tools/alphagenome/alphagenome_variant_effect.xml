<tool id="alphagenome_variant_effect" name="AlphaGenome Variant Effect" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="23.0">
    <description>Predict variant effects using AlphaGenome</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements">
        <requirement type="package" version="0.30.24">cyvcf2</requirement>
        <expand macro="credentials"/>
    </expand>

    <version_command>python '$__tool_directory__/alphagenome_variant_effect.py' --version</version_command>

    <command detect_errors="exit_code"><![CDATA[
        python '$__tool_directory__/alphagenome_variant_effect.py'
            --input '$input_vcf'
            --output '$output_vcf'
            --organism '$organism'
            --output-types
            #for $otype in $output_types
                '$otype'
            #end for
            --sequence-length '$sequence_length'
            --max-variants $max_variants
            #if str($ontology_terms).strip()
                --ontology-terms '$ontology_terms'
            #end if
            #if $test_fixture
                --test-fixture '$test_fixture'
            #end if
            #if $verbose
                --verbose
            #end if
    ]]></command>

    <inputs>
        <param name="input_vcf" type="data" format="vcf" label="Input VCF file"
               help="VCF file containing variants to score"/>

        <param name="organism" type="select" label="Organism">
            <option value="human" selected="true">Human (hg38)</option>
            <option value="mouse">Mouse (mm10)</option>
        </param>

        <param name="output_types" type="select" multiple="true" display="checkboxes"
               label="Output types to predict">
            <option value="RNA_SEQ" selected="true">RNA-seq</option>
            <option value="ATAC">ATAC-seq</option>
            <option value="SPLICE_SITES">Splice sites</option>
            <option value="CAGE">CAGE</option>
            <option value="DNASE">DNase</option>
            <option value="CHIP_HISTONE">ChIP-seq histone</option>
            <option value="CHIP_TF">ChIP-seq TF</option>
            <validator type="no_options" message="Select at least one output type"/>
        </param>

        <param name="ontology_terms" type="text" value="" label="Ontology terms (optional)"
               help="Comma-separated UBERON/CL terms for tissue context, e.g. UBERON:0001157 (peyer's patch), UBERON:0002107 (liver), CL:0000746 (cardiac muscle cell)"/>

        <param name="sequence_length" type="select" label="Prediction window size">
            <option value="16KB">16 KB</option>
            <option value="128KB">128 KB</option>
            <option value="512KB">512 KB</option>
            <option value="1MB" selected="true">1 MB</option>
        </param>

        <param name="max_variants" type="integer" value="100" min="1" max="10000"
               label="Maximum variants to process"
               help="API is rate-limited; start small to verify results"/>

        <param name="verbose" type="boolean" checked="false" truevalue="true" falsevalue="false"
               label="Verbose logging"/>

        <param name="test_fixture" type="data" format="json" optional="true"
               label="Test fixture (internal)" help="For automated testing only"/>
    </inputs>

    <outputs>
        <data name="output_vcf" format="vcf" label="${tool.name} on ${on_string}: Scored VCF"/>
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <param name="input_vcf" value="test_input.vcf"/>
            <param name="organism" value="human"/>
            <param name="output_types" value="RNA_SEQ"/>
            <param name="sequence_length" value="128KB"/>
            <param name="max_variants" value="3"/>
            <param name="test_fixture" value="fixture_variant_effect.json" ftype="json"/>
            <output name="output_vcf">
                <assert_contents>
                    <has_text text="##fileformat=VCF"/>
                    <has_text text="AG_RNA_LFC"/>
                    <has_text text="AG_MAX_EFFECT"/>
                    <has_text text="chr22"/>
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**AlphaGenome Variant Effect Predictor**

Scores genetic variants using Google DeepMind's AlphaGenome model via
``predict_variant()``. For each variant in the input VCF, the tool predicts
reference and alternate genomic tracks and computes a max absolute
log-fold-change (LFC) score for each selected output type.

-----

**What it does**

For each variant the tool:

1. Creates a prediction window centered on the variant
2. Calls AlphaGenome ``predict_variant()`` to get reference and alternate track predictions
3. Computes max absolute log2(alt / ref) across the track as an effect score
4. Annotates the VCF INFO field with per-type scores and an overall max

-----

**Output INFO fields**

- ``AG_RNA_LFC`` — RNA-seq max absolute log-fold-change
- ``AG_ATAC_LFC`` — ATAC-seq max absolute log-fold-change
- ``AG_SPLICE_LFC`` — Splice sites max absolute log-fold-change
- ``AG_MAX_EFFECT`` — Overall max across all selected types

(Additional fields appear for each selected output type.)

-----

**Organisms**

- **Human (hg38)** — Homo sapiens
- **Mouse (mm10)** — Mus musculus

No reference genome file is needed; the API handles sequence context internally.

-----

**Ontology terms**

Optional tissue/cell type context for predictions. Common terms:

- ``UBERON:0001157`` — Peyer's patch
- ``UBERON:0002107`` — Liver
- ``UBERON:0000955`` — Brain
- ``CL:0000746`` — Cardiac muscle cell
- ``CL:0000540`` — Neuron

-----

**Prediction window sizes**

Larger windows capture more genomic context but cost more compute:

- **16 KB** — Fast, minimal context
- **128 KB** — Good for most variants
- **512 KB** — Extended regulatory context
- **1 MB** — Maximum context (default, recommended)

-----

**Citation**

Avsec et al. (2025). "Predicting the impact of genetic variants on chromatin,
genes, and RNA processing with a unified model." *Nature*.
DOI: 10.1038/s41586-025-10014-0
    ]]></help>

    <expand macro="citations"/>
</tool>
