<tool id="AlleleCall" name="ChewBBACA AlleleCall" version="@CHEW_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Determine the allelic profiles of a set of genomes</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        mkdir './input' &&
        mkdir './schema' &&
        #for $file in $input_file
        ln -sf $file './input/${file.element_identifier}' &&
        #end for
        unzip $input_schema -d './schema' &&
        chewBBACA.py AlleleCall
            #if str($training_file) != 'None'
                --ptf $training_file
            #end if            
            --bsr $blast_score_ratio
            --l $minimum_length
            --t $translation_table
            --st $size_threshold
            $no_inferred
            --pm $prodigal_mode
            --mode $mode
            --force-continue
            -i './input' -g './schema/schema_seed/' -o './output'
    ]]></command>
    <inputs>
        <param format="fasta" name="input_file" type="data" multiple="true" label="Genome assemblies in FASTA format"/>
        <param format="zip" name="input_schema" type="data" label="Schema Files in zip format" help="The schema directory contains the loci FASTA files and a folder named 'short' that contains the FASTA files with the loci representative alleles."/>
        <section name="advanced" title="Advanced options">
            <param argument="--training-file" type="data" format="binary" label="Prodigal training file" optional="true" />
            <param argument="--blast-score-ratio" type="float" min="0.0" max="1.0" value="0.6" label="BLAST Score Ratio value" /> 
            <param argument="--minimum-length" type="integer" min="0" value="201" label="Minimum sequence length value"/>
            <param argument="--translation-table" type="integer" min="0" value="11" label="Genetic code used to predict genes and to translate coding sequences"/>
            <param argument="--size-threshold" type="float" min="0" value="0.2" label="CDS size variation threshold"/>
            <param argument="--no-inferred" type="boolean" truevalue="--no-inferred" falsevalue="" checked="false" label="Add the sequences of inferred alleles (INF) to the schema" help="Use this parameter if the schema is being accessed by multiple processes/users simultaneously." />
            <param argument="--prodigal-mode" type="select" label="Prodigal Mode" help="single for finished genomes, reasonable quality draft genomes and big viruses. meta for metagenomes, low quality draft genomes, small viruses, and small plasmids">
                <option value="single" selected="true">
                        single
                    </option>
                    <option value="meta">
                        meta
                    </option>
            </param>
            <param argument="--mode" type="select" label="Execution mode" >
                <option value="1">Only exact matches at DNA level</option>
                <option value="2">Exact matches at DNA and Protein level </option>
                <option value="3">Exact matches and minimizer-based clustering to find similar alleles based on BSR+0.1 </option>
                <option value="4" selected="true">Exact matches and minimizer-based clustering to find similar alleles based on BSR+0.1 </option>
            </param>
        </section>
    </inputs>
    <outputs>
        <collection name="allelecall_results" type="list" label="${tool.name} on ${on_string}: AlleleCall Results">
            <discover_datasets pattern="(?P&lt;name&gt;.+)\.tsv$" format="tabular" directory="./output"/>
        </collection>
        <collection name="allelcall_log" type="list" label="${tool.name} on ${on_string}: AlleleCall Logs">
            <discover_datasets pattern="(?P&lt;name&gt;.+)\.txt$" format="txt" directory="./output"/>
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="input_file" value="GCA_000007265.1_ASM726v1_genomic.fna"/>
            <param name="input_schema" value="GCA_000007265.1_ASM726v1_schema_seed.zip"/>
            <output_collection name="allelecall_results" type="list">
                <element name="cds_coordinates" file="cds_coordinates.tsv" compare="sim_size"/>
                <element name="loci_summary_stats" file="loci_summary_stats.tsv" compare="sim_size"/>
                <element name="paralogous_loci" ftype="tabular">
                    <assert_contents>
                        <has_text_matching expression="Genome.*Loci.*CDS"/>
                    </assert_contents>
                </element>
                <element name="results_alleles" ftype="tabular">
                    <assert_contents>
                        <has_text_matching expression="1.*1.*NIPHEM.*1.*1"/>
                        <has_text_matching expression="GCA_000007265.*1"/>
                    </assert_contents>
                </element>
                <element name="results_alleles" file="results_alleles.tsv" compare="sim_size"/>
                <element name="results_statistics" file="results_statistics.tsv" compare="sim_size"/>
            </output_collection>
            <output_collection name="allelcall_log" type="list">
                <element name="logging_info" ftype="txt">
                    <assert_contents>
                        <has_text_matching expression="Used a BSR of: 0.6"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help>
chewBBACA is a software suite for the creation and evaluation of core genome and whole genome MultiLocus Sequence Typing (cg/wgMLST) schemas and results.

In chewBBACA, by default, an allele needs to be a CDS defined by Prodigal_. To ensure reproducibility of the CDS prediction, the same Prodigal training file for each bacterial species should be used and provided as input.

.. class:: infomark

**Important**

Although the use of a training file is optional, it is highly recommended to ensure consistent results.

.. _Prodigal: https://github.com/hyattpd/Prodigal
    </help>
    <expand macro="citations" />
</tool>