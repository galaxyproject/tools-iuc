<tool id="hyphy_annotate" name="Annotate" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>a newick tree with HyPhy</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        cp '$input_tree' input.nhx &&
        hyphy label-tree
            --tree input.nhx
            --output labeled_tree.nhx
            #if $selection_method.method == 'regexp':
                --regexp '$selection_method.regexp'
            #else:
                --list '$selection_method.list_file'
            #end if
            --label '$label'
            --reroot '$reroot'
            '$invert'
            --internal-nodes '$internal_nodes'
            --leaf-nodes '$leaf_nodes'
            > annotate_stdout.md 2>/dev/null
        @ERRORS@
        ]]></command>
    <inputs>
        <param name="input_tree" type="data" format="nhx" label="Input tree" help="The tree to annotate (Newick format)" />
        <conditional name="selection_method">
            <param name="method" type="select" label="Select branches by">
                <option value="regexp">Regular Expression</option>
                <option value="list">List of Sequences</option>
            </param>
            <when value="regexp">
                <param name="regexp" type="text" optional="false" label="Regular expression" help="Use the following regular expression to select a subset of leaves">
                    <expand macro="regex_sanitizer"/>
                </param>
            </when>
            <when value="list">
                <param name="list_file" type="data" format="txt" optional="false" label="List of sequences" help="Line list of sequences to include in the set"/>
            </when>
        </conditional>
        <param name="label" type="text" value="Foreground" label="Label for annotation" help="Use the following label for annotation" />
        <param name="reroot" type="text" value="None" label="Reroot the tree on this node" help="Reroot the tree on this node ('None' to skip rerooting)" />
        <param argument="--invert" type="boolean" truevalue="--invert Yes" falsevalue="--invert No" label="Invert selection" help="Invert selection" />
        <param name="internal_nodes" type="select" label="Strategy for labeling internal nodes" help="Strategy for labeling internal nodes">
            <option value="All descendants">All descendants</option>
            <option value="None">None</option>
            <option value="All descendants, no MRCA">All descendants, no MRCA</option>
            <option value="Some descendants">Some descendants</option>
            <option value="Parsimony">Parsimony</option>
        </param>
        <param name="leaf_nodes" type="select" label="Strategy for labeling selected leaves" help="Strategy for labeling selected leaves">
            <option value="Label">Label</option>
            <option value="Skip">Skip</option>
        </param>
    </inputs>
    <outputs>
        <data name="labeled_tree" format="nhx" from_work_dir="labeled_tree.nhx" label="${tool.name} on ${on_string}: Labeled tree" />
        <data name="annotate_md_report" format="markdown" from_work_dir="annotate_stdout.md" label="Annotate Report (Markdown) for ${tool.name} on ${on_string}" />
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="input_tree" ftype="nhx" value="annotate-in1.nhx"/>
            <conditional name="selection_method">
                <param name="method" value="regexp"/>
                <param name="regexp" value="_USA_"/>
            </conditional>
            <param name="label" value="Annotated"/>
            <param name="reroot" value="None"/>
            <param name="invert" value="No"/>
            <param name="internal_nodes" value="All descendants"/>
            <param name="leaf_nodes" value="Label"/>
            <output name="labeled_tree" file="annotate-out1-full.nhx" />
            <output name="annotate_md_report">
                <assert_contents>
                    <has_text text="Analysis Description"/>
                </assert_contents>
            </output>
            
        </test>
    </tests>
    <help><![CDATA[
HyPhy Annotate (label-tree)
===========================

Brief description
-----------------

This tool uses the `label-tree` function from HyPhy to annotate a phylogenetic tree. It allows users to select a subset of leaves using either a regular expression or a list of sequence names, and then apply a specified label to these selected branches. The tool also provides options for rerooting the tree, inverting the selection, and defining strategies for labeling internal and leaf nodes. This functionality is crucial for customizing tree visualizations and focusing on specific evolutionary events or clades.

Input
-----

1. A phylogenetic tree in Newick format.
2. A regular expression or a list of sequence names to define the subset of leaves for annotation.

Output
------

1. Labeled tree: A Newick file containing the annotated phylogenetic tree.
2. Annotate Report: A Markdown file with a summary of the analysis.

Tool options
------------
::

    --tree              The tree to annotate (Newick format).

    --regexp            Use the following regular expression to select a subset of leaves.

    --list              Line list of sequences to include in the set (required if --regexp is not supplied).

    --label             Use the following label for annotation.

    --reroot            Reroot the tree on this node ('None' to skip rerooting).

    --invert            Invert selection.

    --internal-nodes    Strategy for labeling internal nodes.
                        None: Do not label internal nodes.
                        All descendants: Label all descendants of the selected internal node.
                        All descendants, no MRCA: Label all descendants of the selected internal node, excluding the most recent common ancestor.
                        Some descendants: Label some descendants of the selected internal node.
                        Parsimony: Label internal nodes based on parsimony.

    --leaf-nodes        Strategy for labeling selected leaves.
                        Label: Apply the specified label to selected leaf nodes.
                        Skip: Do not label leaf nodes.
]]>
    </help>
    <expand macro="citations">
        <citation type="doi">10.1093/molbev/msv022</citation>
    </expand>
</tool>
