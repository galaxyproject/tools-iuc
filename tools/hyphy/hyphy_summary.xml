<?xml version="1.0"?>
<tool id="hyphy_summary" version="1.0.0" name="HyPhy-Summary">
    <description>generate summary report of HyPhy analyses</description>
    <requirements>
        <requirement type="package" version="0.19.7">python-bioext</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        python '$__tool_directory__/scripts/hyphy_summary.py' 
            --mode $mode_conditional.mode
            #if $mode_conditional.mode == 'summary':
                --combined '$mode_conditional.combined'
                --pvalue $mode_conditional.pvalue
                --gene '$mode_conditional.gene'
                --labels '$mode_conditional.labels'
                --default-tag '$mode_conditional.default_tag'
                --name '$mode_conditional.name'
                --relax '$mode_conditional.relax'
                --busted '$mode_conditional.busted'
                --slac '$mode_conditional.slac'
                --fel '$mode_conditional.fel'
                --cfel '$mode_conditional.cfel'
                --meme '$mode_conditional.meme'
                --meme-full '$mode_conditional.meme_full'
                --prime '$mode_conditional.prime'
                --fade '$mode_conditional.fade'
                --bgm '$mode_conditional.bgm'
            #else:
                --annotation-inputs '$mode_conditional.annotation_inputs'
                --summary-inputs '$mode_conditional.summary_inputs'
            #end if
            --annotation-output '$annotation'
            --summary-output '$summary'
    ]]></command>
    <inputs>
        <conditional name="mode_conditional">
            <param argument="--mode" type="select" label="Mode">
                <option value="summary">Generate gene summary</option>
                <option value="merge">Merge gene summaries for clade analysis</option>
            </param>
            <when value="summary">
                <param argument="--combined" type="data" format="fasta" label="Combined reference and query alignments from TN93-Filter" />
                <param argument="--pvalue" type="float" min="0" max="1" value="0.05" label="p-value to use" />
                <param argument="--gene" type="text" label="Name of the gene or sequence being analyzed">
                    <sanitizer invalid_char="">
                        <valid initial="string.ascii_letters,string.digits">
                            <add value="_" />
                            <add value="-" />
                        </valid>
                    </sanitizer>
                </param>
                <param argument="--default-tag" type="text" value="Reference" label="Default name for sequences that have no explicit label" />
                <param argument="--name" type="text" label="The sequence ID to highlight" />
                <param argument="--fade" type="data" format="json,hyphy_results.json" label="HyPhy-FADE output dataset" />
                <param argument="--prime" type="data" format="json,hyphy_results.json" label="HyPhy-PRIME output dataset" />
                <param argument="--relax" type="data" format="json,hyphy_results.json" label="HyPhy-RELAX output dataset" />
                <param argument="--meme" type="data" format="json,hyphy_results.json" label="HyPhy-MEME output dataset" />
                <param argument="--meme-full" type="data" format="json,hyphy_results.json" label="HyPhy-MEME-Full output dataset" />
                <param argument="--labels" type="data" format="json,hyphy_results.json" label="HyPhy-Annotate labels in JSON format" />
                <param argument="--busted" type="data" format="json,hyphy_results.json" label="HyPhy-BUSTED output dataset" />
                <param argument="--slac" type="data" format="json,hyphy_results.json" label="HyPhy-SLAC output dataset" />
                <param argument="--fel" type="data" format="json,hyphy_results.json" label="HyPhy-FEL output dataset" />
                <param argument="--cfel" type="data" format="json,hyphy_results.json" label="HyPhy-CFEL output dataset" />
                <param argument="--bgm" type="data" format="json,hyphy_results.json" label="HyPhy-BGM output dataset" />
            </when>
            <when value="merge">
                <param argument="--summary-inputs" type="data" format="hyphy_results.json" multiple="true" label="Segment annotations to merge" />
                <param argument="--annotation-inputs" type="data" format="hyphy_results.json" multiple="true" label="Site annotations to merge" />
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="summary" format="hyphy_results.json" label="${tool.name} on ${on_string} - Segment annotations" />
        <data name="annotation" format="hyphy_results.json" label="${tool.name} on ${on_string} - Site annotations" />
    </outputs>
    <tests>
        <test>
            <param name="mode" value="summary" />
            <param name="name" value="epi_isl_1009769" />
            <param name="gene" value="S" />
            <param name="combined" value="summary/summary-in-1.fa" />
            <param name="fade" value="summary/summary-in-fade-1.json" />
            <param name="prime" value="summary/summary-in-prime-1.json" />
            <param name="relax" value="summary/summary-in-relax-1.json" />
            <param name="meme" value="summary/summary-in-meme-1.json" />
            <param name="meme_full" value="summary/summary-in-meme-full-1.json" />
            <param name="labels" value="summary/summary-in-labels-1.json" />
            <param name="busted" value="summary/summary-in-busted-1.json" />
            <param name="slac" value="summary/summary-in-slac-1.json" />
            <param name="fel" value="summary/summary-in-fel-1.json" />
            <param name="cfel" value="summary/summary-in-cfel-1.json" />
            <param name="bgm" value="summary/summary-in-bgm-1.json" />
            <output name="summary" file="summary/summary-out-segment-1.json" compare="sim_size"/>
            <output name="annotation" file="summary/summary-out-site-1.json" compare="sim_size"/>
        </test>
        <test>
            <param name="mode" value="summary" />
            <param name="name" value="epi_isl_1009769" />
            <param name="gene" value="3C" />
            <param name="combined" value="summary/summary-in-2.fa" />
            <param name="fade" value="summary/summary-in-fade-2.json" />
            <param name="prime" value="summary/summary-in-prime-2.json" />
            <param name="relax" value="summary/summary-in-relax-2.json" />
            <param name="meme" value="summary/summary-in-meme-2.json" />
            <param name="meme_full" value="summary/summary-in-meme-full-2.json" />
            <param name="labels" value="summary/summary-in-labels-2.json" />
            <param name="busted" value="summary/summary-in-busted-2.json" />
            <param name="slac" value="summary/summary-in-slac-2.json" />
            <param name="fel" value="summary/summary-in-fel-2.json" />
            <param name="cfel" value="summary/summary-in-cfel-2.json" />
            <param name="bgm" value="summary/summary-in-bgm-2.json" />
            <output name="summary" file="summary/summary-out-segment-2.json" compare="sim_size"/>
            <output name="annotation" file="summary/summary-out-site-2.json" compare="sim_size"/>
        </test>
        <test>
            <param name="mode" value="merge" />
            <param name="summary_inputs" value="summary/summary-out-segment-1.json,summary/summary-out-segment-2.json" compare="sim_size" />
            <param name="annotation_inputs" value="summary/summary-out-site-1.json,summary/summary-out-site-2.json" compare="sim_size" />
            <output name="summary" file="summary/merge-out-segment-1.json" compare="sim_size"/>
            <output name="annotation" file="summary/merge-out-site-1.json" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
HyPhy-Summary
=============

This tool has two operation modes, summary and merge.

Summary
-------

Given a combined and filtered alignment from TN93-Filter, along with the
appropriate HyPhy analysis outputs, this mode will return two JSON files, one 
with segment annotations and the other with site annotations.

Analyses required for this mode:

- FADE
- PRIME
- RELAX
- MEME
- MEME-Full
- Annotate, with the labels in JSON format
- BUSTED
- SLAC
- FEL
- CFEL
- BGM

Merge
-----

This mode takes a set of segment and site annotations, one each per gene that
was analyzed, and returns a merged set of site and segment annotations.

]]></help>
    <citations>
        <citation type="doi">10.1093/bioinformatics/bti079</citation>
    </citations>
</tool>
