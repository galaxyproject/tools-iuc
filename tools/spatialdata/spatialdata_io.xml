<tool id="spatialdata_io" name="SpatialData" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>load common spatial omics formats into SpatialData</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        ## CosMX
        #if $method_condi.method == 'cosmx':
            mkdir -p 'input/CellComposite' 'input/CellLabels' 'output' &&
            #for $image in $method_condi.CellComposite:
                #if $image.element_identifier.endswith('.jpg'):
                    ln -s '$image' 'input/CellComposite/${image.element_identifier}' &&
                #else:
                    ln -s '$image' 'input/CellComposite/${image.element_identifier}.jpg' &&
                #end if
            #end for
            #for $image in $method_condi.CellLabels:
                #if $image.element_identifier.endswith('.tiff') or $image.element_identifier.endswith('.tif'):
                    ln -s '$image' 'input/CellLabels/${image.element_identifier}' &&
                #else:
                    ln -s '$image' 'input/CellLabels/${image.element_identifier}.tiff' &&
                #end if
            #end for
            #if $method_condi.exprMat_file.element_identifier.endswith('.csv'):
                ln -s '$method_condi.exprMat_file' 'input/${method_condi.exprMat_file.element_identifier}' &&
            #else:
                ln -s '$method_condi.exprMat_file' 'input/${method_condi.exprMat_file.element_identifier}.csv' &&
            #end if
            #if $method_condi.fov_positions_file.element_identifier.endswith('.csv'):
                ln -s '$method_condi.fov_positions_file' 'input/${method_condi.fov_positions_file.element_identifier}' &&
            #else:
                ln -s '$method_condi.fov_positions_file' 'input/${method_condi.fov_positions_file.element_identifier}.csv' &&
            #end if
            #if $method_condi.metadata_file.element_identifier.endswith('.csv'):
                ln -s '$method_condi.metadata_file' 'input/${method_condi.metadata_file.element_identifier}' &&
            #else:
                ln -s '$method_condi.metadata_file' 'input/${method_condi.metadata_file.element_identifier}.csv' &&
            #end if
            #if $method_condi.tx_file.element_identifier.endswith('.csv'):
                ln -s '$method_condi.tx_file' 'input/${method_condi.tx_file.element_identifier}' &&
            #else:
                ln -s '$method_condi.tx_file' 'input/${method_condi.tx_file.element_identifier}.csv' &&
            #end if
            ## for this it need to go inside input directoy
            cd input &&
            python3 -m spatialdata_io cosmx
                --transcripts $method_condi.transcripts_bool
                --dataset-id "$method_condi.dataset_id"
                -o '../output/spatialdata'
                -i './' &&
            cd .. &&

        ## DBIT
        #else if $method_condi.method == 'dbit':
            mkdir -p 'input/' 'output' &&
            ln -s '$method_condi.barcode_positions' 'input/${method_condi.dataset_id}_barcode_positions.tabular' &&
            ln -s '$method_condi.counts' 'input/${method_condi.dataset_id}_counts.h5ad' &&
            ln -s '$method_condi.tissue_lowres' 'input/${method_condi.dataset_id}_tissue_lowres.png' &&
            python3 -m spatialdata_io dbit
                --barcode-position 'input/${method_condi.dataset_id}_barcode_positions.tabular'
                --anndata-path 'input/${method_condi.dataset_id}_counts.h5ad'
                --image-path 'input/${method_condi.dataset_id}_tissue_lowres.png'
                --dataset-id "$method_condi.dataset_id"
                --border $method_condi.border
                --border-scale $method_condi.border_scale
                -o 'output/spatialdata'
                -i 'input/' &&

        ## MERSCOPE
        #else if $method_condi.method == 'merscope':
            mkdir -p 'input/region/images' 'input/region/vpt_outputs' 'output' &&
            #for $image in $method_condi.mosaic_images:
                #if $image.element_identifier.endswith('.tiff') or $image.element_identifier.endswith('.tif'):
                    ln -s '$image' 'input/region/images/${image.element_identifier}' &&
                #else:
                    ln -s '$image' 'input/region/images/${image.element_identifier}.tif' &&
                #end if
            #end for
            ln -s '$method_condi.input_micron_to_mosaic' 'input/region/images/micron_to_mosaic_pixel_transform.csv' &&
            ln -s '$method_condi.cell_by_gene' 'input/region/vpt_outputs/cell_by_gene.csv' &&
            ln -s '$method_condi.cell_meta' 'input/region/vpt_outputs/cell_metadata.csv' &&
            ## the tool checks the file name, so the name is hardcoded here, but it does not necessarily have to be from cellpose
            ln -s '$method_condi.cells_boundaries' 'input/region/vpt_outputs/cellpose_micron_space.parquet' &&
            ln -s '$method_condi.transcripts' 'input/region/detected_transcripts.csv' &&
            python3 -m spatialdata_io merscope
                --vpt-outputs 'input/region/vpt_outputs'
                --region-name 'region'
                --slide-name "slide_name"
                --backend 'rioxarray'
                --z-layers $method_condi.z_layers
                -o 'output/spatialdata'
                -i 'input/region/' &&

        ## Visium
        #else if $method_condi.method == 'visium':
            mkdir -p 'input/spatial' 'output' &&
            #if $method_condi.matrix_bool:
                ln -s '$method_condi.filtered_feature_bc_matrix' 'input/raw_feature_bc_matrix.h5' &&
            #else:
                ln -s '$method_condi.filtered_feature_bc_matrix' 'input/filtered_feature_bc_matrix.h5' &&
            #end if
            ln -s '$method_condi.scalefactors_json' 'input/scalefactors_json.json' &&
            ln -s '$method_condi.fullres_image_file' 'input/fullres_image.tif' &&
            ln -s '$method_condi.tissue_hires_image' 'input/spatial/tissue_hires_image.png' &&
            ln -s '$method_condi.tissue_lowres_image' 'input/spatial/tissue_lowres_image.png' &&
            ln -s '$method_condi.tissue_positions_list' 'input/tissue_positions_list.csv' &&
            ## for this it need to go inside input directoy
            cd input &&
            python3 -m spatialdata_io visium
                --dataset-id "$method_condi.dataset_id"
                #if $method_condi.matrix_bool:
                    --counts-file 'raw_feature_bc_matrix.h5'
                #else:
                    --counts-file 'filtered_feature_bc_matrix.h5'
                #end if
                --fullres-image-file 'fullres_image.tif'
                --tissue-positions-file 'tissue_positions_list.csv'
                --scalefactors-file 'scalefactors_json.json'
                -o '../output/spatialdata'
                -i './' &&
            cd .. &&

        ## XENIUM
        #else if $method_condi.method == 'xenium':
            mkdir -p 'input/region/morphology_focus/' 'output' &&
            ## ln -s does not work here.
            cp '$method_condi.cell_boundaries' 'input/region/cell_boundaries.parquet' &&
            cp '$method_condi.cell_feature_matrix' 'input/region/cell_feature_matrix.h5' &&
            cp '$method_condi.cells' 'input/region/cells.parquet' &&
            cp '$method_condi.cells_zarr' 'input/region/cells.zarr.zip' &&
            cp '$method_condi.experiment_xenium' 'input/region/experiment.xenium' &&
            #for $image in $method_condi.morphology_focus:
                #if $image.element_identifier.endswith('.tiff') or $image.element_identifier.endswith('.tif'):
                    cp '$image' 'input/region/morphology_focus/${image.element_identifier}' &&
                #else:
                    cp '$image' 'input/region/morphology_focus/${image.element_identifier}.tif' &&
                #end if
            #end for
            cp '$method_condi.nucleus_boundaries' 'input/region/nucleus_boundaries.parquet' &&
            cp '$method_condi.transcripts' 'input/region/transcripts.parquet' &&

            python3 -m spatialdata_io xenium
                --cells-boundaries True
                --nucleus-boundaries True
                --cells-as-circles False
                --cells-labels True
                --nucleus-labels True
                --transcripts True
                --morphology-mip True
                --morphology-focus True
                --aligned-images True
                --cells-table True
                --n-jobs "\${GALAXY_SLOTS:-4}"
                -o 'output/spatialdata'
                -i 'input/region/' &&
        #end if
        ## Final
        ## zip the output spatialdata folder
        cd output && zip -r ../spatialdata.spatialdata.zip spatialdata/ && cd .. &&
        ## print spatialdata contents to stdout
        echo "Verifying the output SpatialData object:" &&
        python -c "import spatialdata as sp; a = sp.read_zarr('output/spatialdata'); print(a)"
    ]]></command>
    <inputs>
        <conditional name="method_condi">
            <param name="method" type="select" label="Spatial Technology">
                <!-- <option value="codex">CODEX</option> -->
                <option value="cosmx">CosMx</option>
                <!-- <option value="curio">Curio Bioscience</option> -->
                <option value="dbit">DBiT-seq</option>
                <!-- <option value="generic">Generic</option> -->
                <!-- <option value="iss">Sanger ISS</option> -->
                <!-- <option value="macsima">MACSima</option> -->
                <!-- <option value="mcmicro">MCMICRO</option> -->
                <option value="merscope">MERSCOPE</option>
                <!-- <option value="seqfish">seqFISH</option> -->
                <!-- <option value="steinbock">steinbock</option> -->
                <!-- <option value="stereoseq">Stereo-seq</option> -->
                <option value="visium">10x Genomics Visium</option>
                <!-- <option value="visium_hd">10x Genomics Visium HD</option> -->
                <option value="xenium">10x Genomics Xenium</option>
            </param>
            <!-- <when value="codex">
            </when> -->
            <when value="cosmx">
                <param name="CellComposite" type="data" format="jpg" multiple="true" label="Cell Composite images"/>
                <param name="CellLabels" type="data" format="tiff" multiple="true" label="Cell Labels images"/>
                <param name="exprMat_file" type="data" format="csv" label="Expression matrix file"/>
                <param name="fov_positions_file" type="data" format="csv" label="FOV positions file"/>
                <param name="metadata_file" type="data" format="csv" label="Metadata file"/>
                <param name="tx_file" type="data" format="csv" label="Transcripts file"/>
                <param name="dataset_id" type="text" value="Galaxy" label="Dataset identifier" help="It should match your input files name">
                    <sanitizer invalid_char="">
                        <valid initial="string.letters,string.digits">
                            <add value="_" />
                        </valid>
                    </sanitizer>
                    <validator type="regex">[0-9a-zA-Z_]+</validator>
                </param>
                <param name="transcripts_bool" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Load transcripts information?"/>
            </when>
            <!-- <when value="curio">
            </when> -->
            <when value="dbit">
                <param name="barcode_positions" type="data" format="tabular" label="Barcode positions file"/>
                <param name="counts" type="data" format="h5ad" label="Counts file"/>
                <param name="tissue_lowres" type="data" format="png" label="Tissue low resolution image"/>
                <param name="dataset_id" type="text" value="Galaxy" label="Dataset identifier" help="It should match your input files name">
                    <sanitizer invalid_char="">
                        <valid initial="string.letters,string.digits">
                            <add value="_" />
                        </valid>
                    </sanitizer>
                    <validator type="regex">[0-9a-zA-Z_]+</validator>
                </param>
                <param name="border" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Border" help="If True, the square is shrinked toward its center, leaving an empty border." />
                <param name="border_scale" type="float" value="1" label="Border scale factor" help="The factor by which the border is scaled. The default is 1. It corresponds to a border length of (0.125 * length of the squareâ€™s edge)"/>
            </when>
            <!-- <when value="generic">
            </when> -->
            <!-- <when value="iss">
            </when> -->
            <!-- <when value="macsima">
            </when> -->
            <!-- <when value="mcmicro">
            </when> -->
            <when value="merscope">
                <param argument="--z_layers" type="text" value="3" optional="false" label="Indices of the z-layers to consider.">
                    <expand macro="sanitize_digits"/>
                </param>
                <param argument="--mosaic-images" type="data" format="tiff" multiple="true" label="MEROSCOPE tiff images"/>
                <param name="input_micron_to_mosaic" type="data" format="csv" label="Micron to mosaic mapping file"/>
                <param name="cell_by_gene" type="data" format="csv" label="Cell by gene table"/>
                <param name="cell_meta" type="data" format="csv" label="Cell metadata table"/>
                <param name="cells_boundaries" type="data" format="parquet" label="Cell boundaries (micron_space)"/>
                <param name="transcripts" type="data" format="csv" label="Detected transcripts"/>
            </when>
            <!-- <when value="seqfish">
            </when> -->
            <!-- <when value="steinbock">
            </when> -->
            <!-- <when value="stereoseq">
            </when> -->
            <when value="visium">
                <param name="dataset_id" type="text" value="Galaxy" label="Dataset identifier to name the constructed SpatialData elements">
                    <sanitizer invalid_char="">
                        <valid initial="string.letters,string.digits">
                            <add value="_" />
                        </valid>
                    </sanitizer>
                    <validator type="regex">[0-9a-zA-Z_]+</validator>
                </param>
                <param name="filtered_feature_bc_matrix" type="data" format="h5" label="feature BC matrix (Counts file)"/>
                <param name="matrix_bool" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Is the matrix input, raw?" help="If the matrix input is raw, set this to true." />
                <param name="scalefactors_json" type="data" format="json" label="Scale factors file"/>
                <param name="fullres_image_file" type="data" format="tiff" label="Full resolution image"/>
                <param name="tissue_hires_image" type="data" format="png" label="Tissue high resolution image"/>
                <param name="tissue_lowres_image" type="data" format="png" label="Tissue low resolution image"/>
                <param name="tissue_positions_list" type="data" format="csv" label="Tissue positions file"/>
            </when>
            <!-- <when value="visium_hd">
            </when> -->
            <when value="xenium">
                <param name="cell_boundaries" type="data" format="parquet" label="Cell boundaries"/>
                <param name="cell_feature_matrix" type="data" format="h5" label="Cell feature matrix"/>
                <param name="cells" type="data" format="parquet" label="Cells"/>
                <param name="cells_zarr" type="data" format="zarr.zip" label="Cells zarr archive"/>
                <param name="experiment_xenium" type="data" format="json" label="Experiment xenium file"/>
                <param name="morphology_focus" type="data" format="tiff" multiple="true" label="Morphology focus images"/>
                <param name="nucleus_boundaries" type="data" format="parquet" label="Nucleus boundaries"/>
                <param name="transcripts" type="data" format="parquet" label="Transcripts"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="spatialdata_output" format="spatialdata.zip" from_work_dir="spatialdata.spatialdata.zip" label="${tool.name} on ${on_string}: spatialdata"/>
    </outputs>
    <tests>
        <!-- test 1: io COSMX full -->
         <!-- The tool currently fails because of an issue in spatialdata_io package. It will be fixed in the next release. https://github.com/scverse/spatialdata-io/commit/d5fa3f2a68763833d3ee0e25bdcbabf21de20974-->
        <test expect_failure="true">
            <conditional name="method_condi">
                <param name="method" value="cosmx"/>
                <param name="CellComposite" value="cosmx/CellComposite/CellComposite_F001.jpg"/>
                <param name="CellLabels" value="cosmx/CellLabels/CellLabels_F001.tif"/>
                <param name="exprMat_file" value="cosmx/dummy_exprMat_file.csv"/>
                <param name="fov_positions_file" value="cosmx/dummy_fov_positions_file.csv"/>
                <param name="metadata_file" value="cosmx/dummy_metadata_file.csv"/>
                <param name="tx_file" value="cosmx/dummy_tx_file.csv"/>
                <param name="dataset_id" value="dummy"/>
                <param name="transcripts_bool" value="True"/>
            </conditional>
            <assert_stderr>
                <has_text text="got an unexpected keyword argument 'table'"/>
            </assert_stderr>
            <!-- <output name="spatialdata_output">
                <assert_contents>
                    <has_size value="370000" delta="20000"/>
                </assert_contents>
            </output> -->
        </test>
        <!-- test 2: io dbit full-->
        <test>
            <conditional name="method_condi">
                <param name="method" value="dbit"/>
                <param name="barcode_positions" value="dbit/barcode_positions.txt"/>
                <param name="counts" value="dbit/counts.h5ad"/>
                <param name="tissue_lowres" value="dbit/tissue_lowres.png"/>
            </conditional>
            <assert_stdout>
                <has_text text="&apos;Galaxy&apos;: GeoDataFrame shape: (500, 1) (2D shapes)"/>
                <has_text text="&apos;table&apos;: AnnData (500, 1000)"/>
            </assert_stdout>
            <output name="spatialdata_output">
                <assert_contents>
                    <has_archive_member path="spatialdata/zarr.json">
                        <has_text text="&quot;zarr_format&quot;: 3"/>
                        <has_text text="images/Galaxy_image"/>
                    </has_archive_member>
                </assert_contents>
            </output>
        </test>
        <!-- test 3: io MERSCOPE full -->
        <test>
            <conditional name="method_condi">
                <param name="method" value="merscope"/>
                <param name="mosaic_images" value="merscope/mosaic_Cellbound1_z2.tif,merscope/mosaic_Cellbound1_z3.tif,merscope/mosaic_Cellbound2_z2.tif,merscope/mosaic_Cellbound2_z3.tif,merscope/mosaic_Cellbound3_z2.tif,merscope/mosaic_Cellbound3_z3.tif,merscope/mosaic_DAPI_z2.tif,merscope/mosaic_DAPI_z3.tif,merscope/mosaic_PolyT_z2.tif,merscope/mosaic_PolyT_z3.tif"/>
                <param name="z_layers" value="3"/>
                <param name="input_micron_to_mosaic" value="merscope/micron_to_mosaic_pixel_transform.csv"/>
                <param name="cell_by_gene" value="merscope/cell_by_gene.csv"/>
                <param name="cell_meta" value="merscope/cell_metadata.csv"/>
                <param name="cells_boundaries" value="merscope/cellpose2_micron_space.parquet"/>
                <param name="transcripts" value="merscope/detected_transcripts.csv"/>
            </conditional>
            <assert_stdout>
                <has_text text="&apos;slide_name_region_polygons&apos;: GeoDataFrame shape: (928, 9)"/>
                <has_text text="&apos;table&apos;: AnnData (928, 130)"/>
            </assert_stdout>
            <output name="spatialdata_output">
                <assert_contents>
                    <has_archive_member path="spatialdata/zarr.json">
                        <has_text text="&quot;zarr_format&quot;: 3"/>
                        <has_text text="&quot;label&quot;: &quot;DAPI&quot;"/>
                    </has_archive_member>
                </assert_contents>
            </output>
        </test>
        <!-- test 4: io VISIUM full -->
        <test>
            <conditional name="method_condi">
                <param name="method" value="visium"/>
                <param name="dataset_id" value="Test_Visium"/>
                <param name="filtered_feature_bc_matrix" value="visium/CytAssist_FFPE_Protein_Expression_Human_Tonsil_filtered_feature_bc_matrix.h5"/>
                <param name="matrix_bool" value="false"/>
                <param name="scalefactors_json" value="visium/scalefactors_json.json"/>
                <param name="fullres_image_file" value="visium/CytAssist_FFPE_Protein_Expression_Human_Tonsil_image.tif"/>
                <param name="tissue_hires_image" value="visium/spatial/tissue_hires_image.png"/>
                <param name="tissue_lowres_image" value="visium/spatial/tissue_lowres_image.png"/>
                <param name="tissue_positions_list" value="visium/tissue_positions.csv"/>
            </conditional>
            <assert_stdout>
                <has_text text="&apos;Test_Visium&apos;: GeoDataFrame shape: (4194, 2)"/>
                <has_text text="&apos;table&apos;: AnnData (4194, 18085)"/>
            </assert_stdout>
            <output name="spatialdata_output">
                <assert_contents>
                    <has_archive_member path="spatialdata/zarr.json">
                        <has_text text="&quot;zarr_format&quot;: 3"/>
                        <has_text text="images/Test_Visium_full_image"/>
                    </has_archive_member>
                </assert_contents>
            </output>
        </test>
        <!-- test 5: io XENIUM full -->
        <test>
            <conditional name="method_condi">
                <param name="method" value="xenium"/>
                <param name="cell_boundaries" value="xenium/cell_boundaries.parquet"/>
                <param name="cell_feature_matrix" value="xenium/cell_feature_matrix.h5"/>
                <param name="cells" value="xenium/cells.parquet"/>
                <param name="cells_zarr" value="xenium/cells.zarr.zip"/>
                <param name="experiment_xenium" value="xenium/experiment.xenium"/>
                <param name="morphology_focus" value="xenium/morphology_focus/ch0000_dapi.ome.tif,xenium/morphology_focus/ch0006_yellow_background.ome.tif,xenium/morphology_focus/ch0001_atp1a1_cd45_e-cadherin.ome.tif,xenium/morphology_focus/ch0007_red_background.ome.tif,xenium/morphology_focus/ch0002_18s.ome.tif,xenium/morphology_focus/ch0008_pd-1.ome.tif,xenium/morphology_focus/ch0003_alphasma_vimentin.ome.tif,xenium/morphology_focus/ch0009_vista.ome.tif,xenium/morphology_focus/ch0004_blue_background.ome.tif,xenium/morphology_focus/ch0010_pd-l1.ome.tif,xenium/morphology_focus/ch0005_green_background.ome.tif,xenium/morphology_focus/ch0011_lag-3.ome.tif"/>
                <param name="nucleus_boundaries" value="xenium/nucleus_boundaries.parquet"/>
                <param name="transcripts" value="xenium/transcripts.parquet"/>
            </conditional>
            <assert_stdout>
                <has_text text="&apos;cell_boundaries&apos;: GeoDataFrame shape: (358, 1)"/>
                <has_text text="&apos;table&apos;: AnnData (358, 405)"/>
            </assert_stdout>
            <output name="spatialdata_output">
                <assert_contents>
                    <has_archive_member path="spatialdata/zarr.json">
                        <has_text text="&quot;zarr_format&quot;: 3"/>
                        <has_text text="images/morphology_focus"/>
                    </has_archive_member>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[

not empty
    ]]></help>
    <expand macro="citations" />
</tool>