<tool id="spatialdata_io" name="SpatialData" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>load common spatial omics formats into SpatialData</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        ## MERSCOPE
        mkdir -p 'input/region/images' 'input/region/vpt_outputs' 'output' &&
        #if $method_condi.method == 'merscope':
            #if str($method_condi.image_condi.load_image) == "yes":
                #for $image in $method_condi.image_condi.mosaic_images:
                    #if $image.element_identifier.endswith('.tif'):
                        ln -s '$image' 'input/region/images/${image.element_identifier}' &&
                    #else:
                        ln -s '$image' 'input/region/images/${image.element_identifier}.tif' &&
                    #end if
                #end for
                ln -s '$method_condi.image_condi.input_micron_to_mosaic' 'input/region/images/micron_to_mosaic_pixel_transform.csv' &&
            #end if
            #if str($method_condi.cell_table_condi.load_cell_table) == "yes":
                ln -s '$method_condi.cell_table_condi.cell_by_gene' 'input/region/vpt_outputs/cell_by_gene.csv' &&
                ln -s '$method_condi.cell_table_condi.cell_meta' 'input/region/vpt_outputs/cell_metadata.csv' &&
            #end if
            #if str($method_condi.cells_boundaries_condi.load_cells_boundaries) == "yes":
                ## the tool checks the file name, so the name is hardcoded here, but it does not necessarily have to be from cellpose
                ln -s '$method_condi.cells_boundaries_condi.cells_boundaries' 'input/region/vpt_outputs/cellpose_micron_space.parquet' &&
            #end if
            #if str($method_condi.transcripts_condi.load_transcripts) == "yes":
                ln -s '$method_condi.transcripts_condi.transcripts' 'input/region/detected_transcripts.csv' &&
            #end if
            python3 -m spatialdata_io merscope
                --vpt-outputs 'input/region/vpt_outputs'
                --region-name 'region'
                --slide-name "slide_name"
                --backend 'rioxarray'
                #if str($method_condi.image_condi.load_image) == "yes":
                    --z-layers $z_layers
                    --mosaic-images $mosaic_images
                    --mosaic-images True
                #else
                    --mosaic-images False
                #end if
                #if str($method_condi.cell_table_condi.load_cell_table) == "yes":
                    --cells-table True
                #else
                    --cells-table False
                #end if
                #if str($method_condi.cells_boundaries_condi.load_cells_boundaries) == "yes":
                    --cells-boundaries True
                #else
                    --cells-boundaries False
                #end if
                #if str($method_condi.transcripts_condi.load_transcripts) == "yes":
                    --transcripts True
                #else
                    --transcripts False
                #end if
                -o 'output/spatialdata'
                -i 'input/region/' &&
        #end if
        ## Final
        cd output && zip -r ../spatialdata.spatialdata.zip spatialdata/ && cd ..
    ]]></command>
    <inputs>
        <conditional name="method_condi">
            <param name="method" type="select" label="Spatial Technology">
                <!-- <option value="codex">CODEX</option> -->
                <!-- <option value="cosmx">CosMx</option>
                <option value="curio">Curio Bioscience</option>
                <option value="dbit">DBiT-seq</option>
                <option value="generic">Generic</option>
                <option value="iss">Sanger ISS</option>
                <option value="macsima">MACSima</option>
                <option value="mcmicro">MCMICRO</option> -->
                <option value="merscope">MERSCOPE</option>
                <!-- <option value="seqfish">seqFISH</option>
                <option value="steinbock">steinbock</option>
                <option value="stereoseq">Stereo-seq</option>
                <option value="visium">10x Genomics Visium</option>
                <option value="visium_hd">10x Genomics Visium HD</option>
                <option value="xenium">10x Genomics Xenium</option> -->
            </param>
            <!-- <when value="codex">
            </when> -->
            <!-- <when value="cosmx">
            </when>
            <when value="curio">
            </when>
            <when value="dbit">
            </when>
            <when value="generic">
            </when>
            <when value="iss">
            </when>
            <when value="macsima">
            </when>
            <when value="mcmicro">
            </when> -->
            <when value="merscope">
                <conditional name="image_condi">
                    <param name="load_image" type="select" label="Load mosaic image?">
                        <option value="yes">Load images</option>
                        <option value="no">Do not load images</option>
                    </param>
                    <when value="yes">
                        <param argument="--z_layers" type="text" value="3" optional="false" label="Indices of the z-layers to consider.">
                            <expand macro="sanitize_digits"/>
                        </param>
                        <param argument="--mosaic-images" type="data" format="tiff" multiple="true" label="MEROSCOPE tiff images"/>
                        <param name="input_micron_to_mosaic" type="data" format="csv" label="Micron to mosaic mapping file"/>
                    </when>
                    <when value="no"/>
                </conditional>
                <conditional name="cell_table_condi">
                    <param name="load_cell_table" type="select" label="Load cell table?" help="It creates the table element in spatialdata">
                        <option value="yes">Load cell table</option>
                        <option value="no">Do not load cell table</option>
                    </param>
                    <when value="yes">
                        <param name="cell_by_gene" type="data" format="csv" label="Cell by gene table"/>
                        <param name="cell_meta" type="data" format="csv" label="Cell metadata table"/>
                    </when>
                    <when value="no"/>
                </conditional>
                <conditional name="cells_boundaries_condi">
                    <param name="load_cells_boundaries" type="select" label="Load cell boundaries?" help="It creates the shape element in spatialdata">
                        <option value="yes">Load cell boundaries</option>
                        <option value="no">Do not load cell boundaries</option>
                    </param>
                    <when value="yes">
                        <param name="cells_boundaries" type="data" format="parquet" label="Cell boundaries"/>
                    </when>
                    <when value="no"/>
                </conditional>
                <conditional name="transcripts_condi">
                    <param name="load_transcripts" type="select" label="Load transcripts?" help="It creates the points element in spatialdata">
                        <option value="yes">Load transcripts</option>
                        <option value="no">Do not load transcripts</option>
                    </param>
                    <when value="yes">
                        <param name="transcripts" type="data" format="csv" label="Detected transcripts"/>
                    </when>
                    <when value="no"/>
                </conditional>
            </when>
            <!-- <when value="seqfish">
            </when>
            <when value="steinbock">
            </when>
            <when value="stereoseq">
            </when>
            <when value="visium">
            </when>
            <when value="visium_hd">
            </when>
            <when value="xenium">
            </when> -->
        </conditional>
    </inputs>
    <outputs>
        <data name="spatialdata_output" format="spatialdata.zip" from_work_dir="spatialdata.spatialdata.zip" label="${tool.name} on ${on_string}: spatialdata"/>
    </outputs>
    <tests>
        <!-- test 1: io MERSCOPE full -->
        <test>
            <conditional name="method_condi">
                <param name="method" value="merscope"/>
                <conditional name="image_condi">
                    <param name="load_image" value="yes"/>
                    <param name="mosaic_images" location="https://zenodo.org/records/17791377/files/mosaic_Cellbound1_z2.tif,https://zenodo.org/records/17791377/files/mosaic_Cellbound1_z3.tif,https://zenodo.org/records/17791377/files/mosaic_Cellbound2_z2.tif,https://zenodo.org/records/17791377/files/mosaic_Cellbound2_z3.tif,https://zenodo.org/records/17791377/files/mosaic_Cellbound3_z2.tif,https://zenodo.org/records/17791377/files/mosaic_Cellbound3_z3.tif,https://zenodo.org/records/17791377/files/mosaic_DAPI_z2.tif,https://zenodo.org/records/17791377/files/mosaic_DAPI_z3.tif,https://zenodo.org/records/17791377/files/mosaic_PolyT_z2.tif,https://zenodo.org/records/17791377/files/mosaic_PolyT_z3.tif"/>
                    <param name="z_layers" value="3"/>
                    <param name="input_micron_to_mosaic" location="https://zenodo.org/records/17791377/files/micron_to_mosaic_pixel_transform.csv"/>
                </conditional>
                <conditional name="cell_table_condi">
                    <param name="load_cell_table" value="yes"/>
                    <param name="cell_by_gene" location="https://zenodo.org/records/17791377/files/cell_by_gene.csv"/>
                    <param name="cell_meta" location="https://zenodo.org/records/17791377/files/cell_metadata.csv"/>
                </conditional>
                <conditional name="cells_boundaries_condi">
                    <param name="load_cells_boundaries" value="yes"/>
                    <param name="cells_boundaries" location="https://zenodo.org/records/17791377/files/cellpose2_micron_space.parquet"/>
                </conditional>
                <conditional name="transcripts_condi">
                    <param name="load_transcripts" value="yes"/>
                    <param name="transcripts" location="https://zenodo.org/records/17791377/files/detected_transcripts.csv"/>
                </conditional>
            </conditional>
            <output name="spatialdata_output">
                <assert_contents>
                    <has_size value="149720115" delta="100"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[

not empty
    ]]></help>
    <expand macro="citations" />
</tool>