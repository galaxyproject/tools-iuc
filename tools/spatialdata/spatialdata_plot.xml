<tool id="spatialdata_plot" name="SpatialData Plot" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>rich static plotting from SpatialData objects</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        mkdir -p output &&
        unzip -q '$input_spatialdata' -d input &&

        ## run the plotting pipeline
        python3 'spdata_plot.py' &&
        cat 'spdata_plot.py'
    ]]></command>
    <configfiles>
        <configfile name="spdata_plot_config" filename="spdata_plot.py">
import spatialdata as sd
import spatialdata_plot

## Load the SpatialData object
spdata = sd.read_zarr("./input/spatialdata")

print(spdata)

#if str($render_images_condi.render_images) == 'yes':
## Render images
spdata = spdata.pl.render_images(
    #if $render_images_condi.image_element:
    element='$render_images_condi.image_element',
    #else:
    element=None,
    #end if
    #if $render_images_condi.channel:
    channel='$render_images_condi.channel',
    #end if
    #if str($render_images_condi.cmap) != '':
        #set $cmap_list = [str(x.strip()) for x in str($render_images_condi.cmap).split(',')]
    cmap=$cmap_list,
    #end if
    #if str($render_images_condi.normalize_condi.normalize) == 'yes':
    norm=Normalize(
        vmin=$render_images_condi.normalize_condi.vmin if str($render_images_condi.normalize_condi.vmin) != '' else None,
        vmax=$render_images_condi.normalize_condi.vmax if str($render_images_condi.normalize_condi.vmax) != '' else None,
        clip=$render_images_condi.normalize_condi.clip
    ),
    #end if
    #if str($render_images_condi.palette) != '':
        #set $palette_list = [str(x.strip()) for x in str($render_images_condi.palette).split(',')]
    palette=$palette_list,
    #end if
    alpha=$render_images_condi.alpha,
    #if $render_images_condi.scale:
    scale='$render_images_condi.scale',
    #end if
)
#end if

#if str($render_labels_condi.render_labels) == 'yes':
## Render labels
spdata = spdata.pl.render_labels(
    #if $render_labels_condi.labels_element:
    element='$render_labels_condi.labels_element',
    #else:
    element=None,
    #end if
    #if $render_labels_condi.color:
     #set $color_list = [str(x.strip()) for x in str($render_labels_condi.color).split(',')]
    color=$color_list,
    #end if
    #if $render_labels_condi.groups:
        #set $groups_list = [str(x.strip()) for x in str($render_labels_condi.groups).split(',')]
    groups=$groups_list,
    #end if
    #if str($render_labels_condi.palette) != '':
        #set $palette_list = [str(x.strip()) for x in str($render_labels_condi.palette).split(',')]
    palette=$palette_list,
    #end if
    contour_px=$render_labels_condi.contour_px,
    #if str($render_labels_condi.cmap) != '':
        #set $cmap_list = [str(x.strip()) for x in str($render_labels_condi.cmap).split(',')]
    cmap=$cmap_list,
    #end if
    #if str($render_labels_condi.normalize_condi.normalize) == 'yes':
    norm=Normalize(
        vmin=$render_labels_condi.normalize_condi.vmin if str($render_labels_condi.normalize_condi.vmin) != '' else None,
        vmax=$render_labels_condi.normalize_condi.vmax if str($render_labels_condi.normalize_condi.vmax) != '' else None,
        clip=$render_labels_condi.normalize_condi.clip
    ),
    #end if
    outline_alpha=$render_labels_condi.outline_alpha,
    fill_alpha=$render_labels_condi.fill_alpha,
    #if $render_labels_condi.scale:
    scale='$render_labels_condi.scale',
    #else
    scale=None,
    #end if
    #if $render_labels_condi.table_name:
    table_name='$render_labels_condi.table_name',
    #else
    table_name=None,
    #end if
    #if $render_labels_condi.table_layer:
    table_layer='$render_labels_condi.table_layer',
    #else
    table_layer=None,
    #end if
)
#end if

#if str($render_points_condi.render_points) == 'yes':
## Render points
spdata = spdata.pl.render_points(
    #if $render_points_condi.points_element:
    element='$render_points_condi.points_element',
    #else:
    element=None,
    #end if
    #if $render_points_condi.color:
     #set $color_list = [str(x.strip()) for x in str($render_points_condi.color).split(',')]
    color=$color_list,
    #end if
    #if str($render_points_condi.alpha) != '':
    alpha=$render_points_condi.alpha,
    #end if
    #if $render_points_condi.groups:
     #set $groups_list = [str(x.strip()) for x in str($render_points_condi.groups).split(',')]
    groups=$groups_list,
    #end if
    #if str($render_points_condi.palette) != '':
        #set $palette_list = [str(x.strip()) for x in str($render_points_condi.palette).split(',')]
    palette=$palette_list,
    #end if
    #if str($render_points_condi.cmap) != '':
        #set $cmap_list = [str(x.strip()) for x in str($render_points_condi.cmap).split(',')]
    cmap=$cmap_list,
    #end if
    #if str($render_points_condi.normalize_condi.normalize) == 'yes':
    norm=Normalize(
        vmin=$render_points_condi.normalize_condi.vmin if str($render_points_condi.normalize_condi.vmin) != '' else None,
        vmax=$render_points_condi.normalize_condi.vmax if str($render_points_condi.normalize_condi.vmax) != '' else None,
        clip=$render_points_condi.normalize_condi.clip
    ),
    #end if
    size=$render_points_condi.size,
    #if $render_points_condi.method:
    method='$render_points_condi.method',
    #else:
    method=None,
    #end if
    #if $render_points_condi.table_name:
    table_name='$render_points_condi.table_name',
    #else
    table_name=None,
    #end if
    #if $render_points_condi.table_layer:
    table_layer='$render_points_condi.table_layer',
    #else
    table_layer=None,
    #end if

)
#end if

#if str($render_shapes_condi.render_shapes) == 'yes':
## Render shapes
spdata = spdata.pl.render_shapes(
    #if $render_shapes_condi.shapes_element:
    element='$render_shapes_condi.shapes_element',
    #else:
    element=None,
    #end if
    #if $render_shapes_condi.color:
    color='$render_shapes_condi.color',
    #end if
    #if str($render_shapes_condi.fill_alpha) != '':
    fill_alpha=$render_shapes_condi.fill_alpha,
    #end if
    #if str($render_shapes_condi.groups) != '':
        #set $groups_list = [str(x.strip()) for x in str($render_shapes_condi.groups).split(',')]
    groups=$groups_list,
    #end if
    #if str($render_shapes_condi.palette) != '':
        #set $palette_list = [str(x.strip()) for x in str($render_shapes_condi.palette).split(',')]
    palette=$palette_list,
    #end if

    #if str($render_shapes_condi.outline_condi.outline_type) == 'no':
    outline_width=None,
    outline_color=None,
    outline_alpha=None,
    #else if str($render_shapes_condi.outline_condi.outline_type) == 'yes':
    outline_width=$render_shapes_condi.outline_condi.outline_width1,
    outline_color='$render_shapes_condi.outline_condi.outline_color1',
    outline_alpha=$render_shapes_condi.outline_condi.outline_alpha1,
    #else if str($render_shapes_condi.outline_condi.outline_type) == 'yes2':
    outline_width=[$render_shapes_condi.outline_condi.outline_width1, $render_shapes_condi.outline_condi.outline_width2],
    outline_color=['$render_shapes_condi.outline_condi.outline_color1', '$render_shapes_condi.outline_condi.outline_color2'],
    outline_alpha=[$render_shapes_condi.outline_condi.outline_alpha1, $render_shapes_condi.outline_condi.outline_alpha2],
    #end if

    #if str($render_shapes_condi.cmap) != '':
        #set $cmap_list = [str(x.strip()) for x in str($render_shapes_condi.cmap).split(',')]
    cmap=$cmap_list,
    #end if
    #if str($render_shapes_condi.normalize_condi.normalize) == 'yes':
    norm=Normalize(
        vmin=$render_shapes_condi.normalize_condi.vmin if str($render_shapes_condi.normalize_condi.vmin) != '' else None,
        vmax=$render_shapes_condi.normalize_condi.vmax if str($render_shapes_condi.normalize_condi.vmax) != '' else None,
        clip=$render_shapes_condi.normalize_condi.clip
    ),
    #end if
    scale=$render_shapes_condi.scale,
    #if $render_shapes_condi.method and str($render_shapes_condi.method) != 'None':
    method='$render_shapes_condi.method',
    #else:
    method=None,
    #end if
    #if $render_shapes_condi.table_name:
    table_name='$render_shapes_condi.table_name',
    #else
    table_name=None,
    #end if
    #if $render_shapes_condi.table_layer:
    table_layer='$render_shapes_condi.table_layer',
    #else
    table_layer=None,
    #end if
    #if $render_shapes_condi.shape and str($render_shapes_condi.shape) != 'None':
    shape='$render_shapes_condi.shape',
    #else:
    shape=None,
    #end if
)
#end if

## Show the plot
spdata.pl.show(
    #if $show_params.coordinate_systems:
        #set $coordinate_systems_list = [str(x.strip()) for x in str($show_params.coordinate_systems).split(',')]
    coordinate_systems=$coordinate_systems_list,
    #end if
    figsize=($show_params.figsize_width, $show_params.figsize_height),
    dpi=$show_params.dpi,
    ncols=$show_params.ncols,
    #if str($show_params.legend_fontsize) != '':
    legend_fontsize=$show_params.legend_fontsize,
    #end if
    legend_fontweight='$show_params.legend_fontweight',
    legend_loc='$show_params.legend_loc',
    na_in_legend=$show_params.na_in_legend,
    #if $show_params.title:
    title='$show_params.title',
    #end if
    share_extent=$show_params.share_extent,
    save='plot.${show_params.format}'
)

print("Plot saved successfully")
        </configfile>
    </configfiles>
    <inputs>
        <param name="input_spatialdata" type="data" format="spatialdata.zip" label="SpatialData object"/>
        <conditional name="render_images_condi">
            <param name="render_images" type="select" label="Render images?">
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="no"/>
            <when value="yes">
                <param name="image_element" type="text" optional="true" label="Image element name" help="Name of the image element to render. Leave empty to render all images.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="channel" type="text" optional="true" label="Channel(s)" help="Comma-separated list of channel names or indices to plot. Leave empty for all channels.">
                    <expand macro="sanitize_query"/>
                </param>
                <param argument="cmap" type="select" optional="true" multiple="true" label="Matplotlib colormap name">
                    <expand macro="matplotlib_pyplot_colormap"/>
                </param>
                <conditional name="normalize_condi">
                    <param name="normalize" type="select" label="Apply matplotlib colormap normalization for continuous annotations?">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </param>
                    <when value="no"/>
                    <when value="yes">
                        <param name="vmin" type="float" optional="true" label="Min value" help="Values within the range [vmin, vmax] from the input data will be linearly mapped to [0, 1]. If either vmin or vmax is not provided, they default to the minimum and maximum values of the input, respectively." />
                        <param name="vmax" type="float" optional="true" label="Max value" help="Values within the range [vmin, vmax] from the input data will be linearly mapped to [0, 1]. If either vmin or vmax is not provided, they default to the minimum and maximum values of the input, respectively." />
                        <param name="clip" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Clip" help="If clipping is on, values below vmin are mapped to 0 and values above vmax are mapped to 1" />
                    </when>
                </conditional>

                <param name="palette" type="select" optional="true" multiple="true" label="Palette to color images" help="The number of palettes should be equal to the number of channels">
                    <expand macro="matplotlib_color"/>
                </param>
                <param name="alpha" type="float" value="1.0" min="0.0" max="1.0" label="Alpha (opacity)" help="Transparency level (0=transparent, 1=opaque)"/>
                <param name="scale" type="text" optional="true" label="Scale" help="Resolution control: leave empty for auto, 'full' for highest resolution, or specify a scale name. Please note that full resolution, takes more time to render.">
                    <expand macro="sanitize_query"/>
                </param>
            </when>
        </conditional>

        <conditional name="render_labels_condi">
            <param name="render_labels" type="select" label="Render labels?">
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="no"/>
            <when value="yes">
                <param name="labels_element" type="text" optional="true" label="Labels element name" help="Name of the labels element to render. Leave empty to render all labels.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="color" type="text" optional="true" label="Color column" help="Column name from table.obs or table.var to use for coloring. Use comma to separate multiple keys. It can also be a color name.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="groups" type="text" optional="true" label="Groups to show" help=" When using color and the key represents discrete labels, groups can be used to show only a subset of them. Other values are set to NA. The list can contain multiple discrete labels to be visualized.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="palette" type="select" optional="true" multiple="true" label="Palette for discrete annotations" help="Must match the number of groups. The list can contain multiple palettes (one per group) to be visualized. If groups is provided but not palette, palette is set to default lightgray">
                    <expand macro="matplotlib_color"/>
                </param>
                <param name="contour_px" type="integer" value="3" min="0" label="Contour width (pixels)" help="Width of contour to draw for each segment. 0 fills entire segment."/>
                <param argument="cmap" type="select" multiple="true" optional="true" label="Matplotlib colormap name">
                    <expand macro="matplotlib_pyplot_colormap"/>
                </param>
                <conditional name="normalize_condi">
                    <param name="normalize" type="select" label="Apply matplotlib colormap normalization for continuous annotations?">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </param>
                    <when value="no"/>
                    <when value="yes">
                        <param name="vmin" type="float" optional="true" label="Min value" help="Values within the range [vmin, vmax] from the input data will be linearly mapped to [0, 1]. If either vmin or vmax is not provided, they default to the minimum and maximum values of the input, respectively." />
                        <param name="vmax" type="float" optional="true" label="Max value" help="Values within the range [vmin, vmax] from the input data will be linearly mapped to [0, 1]. If either vmin or vmax is not provided, they default to the minimum and maximum values of the input, respectively." />
                        <param name="clip" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Clip" help="If clipping is on, values below vmin are mapped to 0 and values above vmax are mapped to 1" />
                    </when>
                </conditional>
                <param name="outline_alpha" type="float" value="0.0" min="0.0" max="1.0" label="Outline alpha"/>
                <param name="fill_alpha" type="float" value="0.4" min="0.0" max="1.0" label="Fill alpha"/>
                <param name="scale" type="text" optional="true" label="Scale" help="Resolution control: leave empty for auto, 'full' for highest resolution, or specify a scale name. Please note that full resolution, takes more time to render.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="table_name" type="text" optional="true" label="Table name" help="Name of table containing color columns">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="table_layer" type="text" optional="true" label="Layer of the AnnData table to use for coloring if color is in table.var" help="If None, sdata.table.X of the default table is used for coloring.">
                    <expand macro="sanitize_query"/>
                </param>
            </when>
        </conditional>

        <conditional name="render_points_condi">
            <param name="render_points" type="select" label="Render points?">
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="no"/>
            <when value="yes">
                <param name="points_element" type="text" optional="true" label="Points element name" help="Name of the points element to render. Leave empty to render all points.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="color" type="text" optional="true" label="Color column" help="Column name from table.obs or table.var to use for coloring. Use comma to separate multiple keys. It can also be a color name.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="alpha" type="float" optional="true" min="0.0" max="1.0" label="Alpha (opacity)"/>
                <param name="groups" type="text" optional="true" label="Groups to show" help=" When using color and the key represents discrete labels, groups can be used to show only a subset of them. Other values are set to NA. The list can contain multiple discrete labels to be visualized.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="palette" type="select" optional="true" multiple="true" label="Palette for discrete annotations" help="Must match the number of groups. The list can contain multiple palettes (one per group) to be visualized. If groups is provided but not palette, palette is set to default lightgray">
                    <expand macro="matplotlib_color"/>
                </param>
                <param argument="cmap" type="select" multiple="true" optional="true" label="Matplotlib colormap name">
                    <expand macro="matplotlib_pyplot_colormap"/>
                </param>
                <conditional name="normalize_condi">
                    <param name="normalize" type="select" label="Apply matplotlib colormap normalization for continuous annotations?">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </param>
                    <when value="no"/>
                    <when value="yes">
                        <param name="vmin" type="float" optional="true" label="Min value" help="Values within the range [vmin, vmax] from the input data will be linearly mapped to [0, 1]. If either vmin or vmax is not provided, they default to the minimum and maximum values of the input, respectively." />
                        <param name="vmax" type="float" optional="true" label="Max value" help="Values within the range [vmin, vmax] from the input data will be linearly mapped to [0, 1]. If either vmin or vmax is not provided, they default to the minimum and maximum values of the input, respectively." />
                        <param name="clip" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Clip" help="If clipping is on, values below vmin are mapped to 0 and values above vmax are mapped to 1" />
                    </when>
                </conditional>
                <param name="size" type="float" value="1.0" min="0.0" label="Point size"/>
                <param name="method" type="select" optional="true" label="Rendering method" help="When None, the method is chosen based on the size of the data.">
                    <option value="matplotlib">Matplotlib</option>
                    <option value="datashader">Datashader</option>
                </param>
                <param name="table_name" type="text" optional="true" label="Table name" help="Name of table containing color columns">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="table_layer" type="text" optional="true" label="Layer of the AnnData table to use for coloring if color is in table.var" help="If None, sdata.table.X of the default table is used for coloring.">
                    <expand macro="sanitize_query"/>
                </param>
            </when>
        </conditional>
        <conditional name="render_shapes_condi">
            <param name="render_shapes" type="select" label="Render shapes?">
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="no"/>
            <when value="yes">
                <param name="shapes_element" type="text" optional="true" label="Shapes element name" help="Name of the shapes element to render. Leave empty to render all shapes.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="color" type="text" optional="true" label="Color column" help="Column name from table.obs or table.var to use for coloring. Use comma to separate multiple keys. It can also be a color name.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="fill_alpha" type="float" optional="true" min="0.0" max="1.0" label="Fill alpha" help="By default, it is set to 1.0 or, if a color is given that implies an alpha, that value is used for fill_alpha. If an alpha channel is present in a cmap passed by the user, fill_alpha will overwrite the value present in the cmap."/>
                <param name="groups" type="text" optional="true" label="Groups to show" help=" When using color and the key represents discrete labels, groups can be used to show only a subset of them. Other values are set to NA. The list can contain multiple discrete labels to be visualized.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="palette" type="select" optional="true" multiple="true" label="Palette for discrete annotations" help="Must match the number of groups. The list can contain multiple palettes (one per group) to be visualized. If groups is provided but not palette, palette is set to default lightgray">
                    <expand macro="matplotlib_color"/>
                </param>
                <conditional name="outline_condi">
                    <param name="outline_type" type="select" label="Shape outline type">
                        <option value="no">No outline</option>
                        <option value="yes">Yes, one outline</option>
                        <option value="yes2">Yes, two outlines</option>
                    </param>
                    <when value="no"/>
                    <when value="yes">
                        <param name="outline_width1" type="float" optional="false" value="1.5" min="0.0" label="Outline width"/>
                        <param name="outline_color1" type="text" optional="false" value="#000000" label="Outline color" help="Color name or hex code">
                            <expand macro="sanitize_query"/>
                        </param>
                        <param name="outline_alpha1" type="float" optional="false" value="1.0" min="0.0" max="1.0" label="Outline alpha"/>
                    </when>
                    <when value="yes2">
                        <param name="outline_width1" type="float" optional="false" value="1.5" min="0.0" label="First outline width"/>
                        <param name="outline_color1" type="text" optional="false" value="#000000" label="First outline color" help="Color name or hex code">
                            <expand macro="sanitize_query"/>
                        </param>
                        <param name="outline_alpha1" type="float" optional="false" value="1.0" min="0.0" max="1.0" label="First outline alpha"/>
                        <param name="outline_width2" type="float" optional="false" value="0.5" min="0.0" label="Second outline width"/>
                        <param name="outline_color2" type="text" optional="false" value="#ffffff" label="Second outline color" help="Color name or hex code">
                            <expand macro="sanitize_query"/>
                        </param>
                        <param name="outline_alpha2" type="float" optional="false" value="1.0" min="0.0" max="1.0" label="Second outline alpha"/>
                    </when>
                </conditional>
                <param argument="cmap" type="select" multiple="true" optional="true" label="Matplotlib colormap name">
                    <expand macro="matplotlib_pyplot_colormap"/>
                </param>
                <conditional name="normalize_condi">
                    <param name="normalize" type="select" label="Apply matplotlib colormap normalization for continuous annotations?">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </param>
                    <when value="no"/>
                    <when value="yes">
                        <param name="vmin" type="float" optional="true" label="Min value" help="Values within the range [vmin, vmax] from the input data will be linearly mapped to [0, 1]. If either vmin or vmax is not provided, they default to the minimum and maximum values of the input, respectively." />
                        <param name="vmax" type="float" optional="true" label="Max value" help="Values within the range [vmin, vmax] from the input data will be linearly mapped to [0, 1]. If either vmin or vmax is not provided, they default to the minimum and maximum values of the input, respectively." />
                        <param name="clip" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Clip" help="If clipping is on, values below vmin are mapped to 0 and values above vmax are mapped to 1" />
                    </when>
                </conditional>
                <param name="scale" type="float" value="1.0" label="Scale factor" help="Value to scale circles"/>
                <param name="method" type="select" optional="true" label="Rendering method" help="When Auto, the method is chosen based on the size of the data.">
                    <option value="None">Auto</option>
                    <option value="matplotlib">Matplotlib</option>
                    <option value="datashader">Datashader</option>
                </param>
                <param name="table_name" type="text" optional="true" label="Table name">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="table_layer" type="text" optional="true" label="Layer of the AnnData table to use for coloring if color is in table.var" help="If None, sdata.table.X of the default table is used for coloring.">
                    <expand macro="sanitize_query"/>
                </param>
                <param name="shape" type="select" optional="true" label="Convert shapes to" help="If Auto, the shapes are rendered as they are">
                    <option value="None">Keep original shapes</option>
                    <option value="circle">Circle</option>
                    <option value="hex">Hexagon</option>
                    <option value="visium_hex">Visium hexagon (adjacent)</option>
                    <option value="square">Square</option>
                </param>
            </when>
        </conditional>

        <section name="show_params" title="Plot Display Parameters" expanded="true">
            <param name="coordinate_systems" type="text" optional="true" label="Coordinate system(s)" help="Comma-separated list of coordinate systems to plot. Leave empty for all.  If a coordinate system doesn't contain any relevant elements (as specified in the render_* calls), it is automatically not plotted.">
                <expand macro="sanitize_query"/>
            </param>
            <param name="figsize_width" type="float" value="6.4" min="0.1" label="Figure width (inches)"/>
            <param name="figsize_height" type="float" value="4.8" min="0.1" label="Figure height (inches)"/>
            <param name="dpi" type="integer" value="100" min="1" label="DPI (resolution)" help="Dots per inch for the output image"/>
            <param name="ncols" type="integer" value="4" min="1" label="Number of columns"/>
            <param name="legend_fontsize" type="integer" optional="true" min="1" label="Legend font size"/>
            <param name="legend_fontweight" type="select" label="Legend font weight">
                <option value="bold" selected="true">Bold</option>
                <option value="normal">Normal</option>
                <option value="light">Light</option>
            </param>
            <param name="legend_loc" type="select" label="Legend location">
                <option value="right margin" selected="true">Right margin</option>
                <option value="upper right">Upper right</option>
                <option value="upper left">Upper left</option>
                <option value="lower left">Lower left</option>
                <option value="lower right">Lower right</option>
                <option value="center">Center</option>
            </param>
            <param name="na_in_legend" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Show NA values in legend?"/>
            <param name="title" type="text" optional="true" label="Plot title" help="If not provided the plot will have the name of the coordinate system as title..">
                <expand macro="sanitize_query"/>
            </param>
            <param name="share_extent" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Share extent across subplots?"/>
            <param name="format" type="select" label="Image format">
                <option value="eps">EPS</option>
                <option value="jpg" selected="true">JPG</option>
                <option value="pdf">PDF</option>
                <option value="png">PNG</option>
                <option value="svg">SVG</option>
                <option value="tiff">TIFF</option>
            </param>
        </section>
    </inputs>
    <outputs>
        <data name="plot_output" format="jpg" from_work_dir="input/figures/plot.jpg" label="${tool.name} on ${on_string}: plot">
            <change_format>
                <when input="show_params.format" value="eps" format="eps"/>
                <when input="show_params.format" value="jpg" format="jpg"/>
                <when input="show_params.format" value="pdf" format="pdf"/>
                <when input="show_params.format" value="png" format="png"/>
                <when input="show_params.format" value="svg" format="svg"/>
                <when input="show_params.format" value="tiff" format="tiff"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_spatialdata" value="visium_spatialdata.zip"/>
            <conditional name="render_images_condi">
                <param name="render_images" value="yes"/>
            </conditional>
            <output name="plot_output" ftype="jpg">
                <assert_contents>
                    <has_size value="0" delta="500000"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

This tool creates rich static plots from SpatialData objects. It provides comprehensive visualization capabilities for spatial omics data, including images, labels (segmentation masks), point data (e.g., transcripts), and geometric shapes (e.g., cell boundaries).

-----

**Rendering Options**

The tool supports four types of spatial elements:

**1. Images**: Render microscopy images, H&E stains, or fluorescence channels
   - Select specific channels or view all
   - Apply colormaps and adjust transparency
   - Control resolution and rendering quality

**2. Labels**: Visualize segmentation masks (cells, nuclei, tissues)
   - Color by categorical or continuous variables from annotation tables
   - Adjust contour width and fill transparency
   - Show only specific groups/categories

**3. Points**: Display point-based data (e.g., transcript locations)
   - Color by features or metadata
   - Adjust point size and transparency
   - Choose between matplotlib (smaller datasets) or datashader (large datasets) rendering

**4. Shapes**: Render geometric shapes (circles, polygons, boundaries)
   - Color by annotations or use solid colors
   - Control outline and fill properties
   - Convert shapes to standard geometries (circles, hexagons, squares)

-----

**Display Parameters**

- **Coordinate Systems**: Select which spatial coordinate systems to visualize
- **Figure Layout**: Control subplot arrangement, figure size, and resolution
- **Legend**: Customize font, position, and content
- **Title**: Add custom titles to plots

-----

**Usage Tips**

1. **Layer Multiple Elements**: Enable multiple render options (e.g., images + labels + points) to create overlay visualizations
2. **Color by Annotations**: Use the 'color' parameter to visualize gene expression or cell type labels from annotation tables
3. **Performance**: For large datasets, consider using datashader rendering method for points and shapes
4. **Resolution**: Use 'scale' parameter to balance between rendering speed and image quality

-----

**Output**

The tool generates a PNG image containing the rendered visualization(s). Multiple coordinate systems will be displayed as separate subplots arranged in a grid.

-----

**More Information**

- `SpatialData Plot documentation <https://spatialdata.scverse.org/projects/plot/en/stable/>`__
- `SpatialData documentation <https://spatialdata.scverse.org/>`__

    ]]></help>
    <expand macro="citations" />
</tool>