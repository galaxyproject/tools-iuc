<tool id="kmetashot" name="kMetaShot" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>an alignment-free taxonomic classifier based on k-mer/minimizer counting</description>
    <macros>
        <token name="@TOOL_VERSION@">2.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <token name="@PROFILE@">24.1</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">kmetashot</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
            #import re

            mkdir "output" "bins" &&

            #for $file in $bins_dir:
                #set $identifier = re.sub("[^\s\w\-]", "_", str($e.element_identifier))
                ln -s "$file" "bins/${identifier}.$file.ext" &&
            #end for

            kMetaShot_classifier_NV.py 
            -b "bins"
            -o "output"
            -r "$reference.fields.path"
            -p "\${GALAXY_SLOTS:-1}"
            -a ${ass2ref}

        ]]>
    </command>
    <inputs>
        <param argument="--bins_dir" type="data" multiple="true" format="fasta,fasta.gz" label="Bin(s)/MAG(s) fasta file"/>
        <param argument="--reference" type="select" label="Select reference">
            <options from_data_table="kmetashot">
                <filter type="sort_by" column="2"/>
            </options>
            <validator type="no_options" message="No reference data for kMetaShot is installed. Please contact the Galaxy adminstrators to request one be installed."/>
        </param>
        <param argument="--ass2ref" type="float" min="0.0" value="0.0" max="1.0" label="Set ass2ref parameter" help="Set the number of non redundant minimizers found in classified MAG for classified strain"/>
    </inputs>
    <outputs>
        <collection name="result" type="list">
            <discover_datasets pattern="(?P&lt;designation&gt;.*)\.csv" format="tabular" directory="output"/>
        </collection>
    </outputs>
    <tests>
        <!-- Since this tool need his ref data to work there is no way to test this tool really because of this there is only this test to see of the tool is starting or not -->
         <test expect_exit_code="1" expect_failure="true">
            <param name="bins_dir" value="all_contig.fasta.gz" ftype="fasta.gz"/>
            <param name="ass2ref" value="0.2"/>
            <assert_command>
                <has_text text="kMetaShot_classifier_NV.py -b bins"/>
                <has_text text="-o output"/>
                <has_text text="-a 0.2"/>
            </assert_command>
         </test>
         <test expect_exit_code="1" expect_failure="true">
            <param name="bins_dir" value="all_contig.fasta.gz" ftype="fasta.gz"/>
            <param name="ass2ref" value="0.3"/>
            <assert_command>
                <has_text text="kMetaShot_classifier_NV.py -b bins"/>
                <has_text text="-o output"/>
                <has_text text="-a 0.3"/>
            </assert_command>
         </test>
    </tests>
    <help>
        <![CDATA[
        
            To learn more about the inside of the tool you can visit the `kMetaShot GitHub page <https://github.com/gdefazio/kMetaShot>`_!

            **Input**

            Fasta file(s) in fasta format or/and fasta.gz format (.fa, .fasta, .fna, .fa.gz, .fasta.gz, .fna.gz are allowed extensions)

            **Reference**

            The reference data needed for this tool must be provided from the data manager which always installs the latest version of the data

            **Output**

            The Output is a collection with csv file(s) which contained the classification for the inputted bin(s)/MAG(s)

            In the output files(s) each line has the followed structure: num,bin,ass2ref,taxid,species,genus,family,order,class,phylum,superkingdom,organism_name 
            This means each bin will be classified by this tool and all ids (NCBI) will be written in this order if the tool can classified it together with the organism name!

        ]]>
    </help>  
    <citations>
        <citation type="doi">10.1093/bib/bbae680</citation>
    </citations>
</tool>