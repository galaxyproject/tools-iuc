<tool id="samtools_cram_to_bam" name="samtools CRAM to BAM" version="1.2.a">
    <description>convert CRAM alignments to BAM format</description>

    <requirements>
        <requirement type="package" version="1.2">samtools</requirement>
    </requirements>
    
    <stdio>
        <exit_code range="1:" />
        <exit_code range=":-1" />
    </stdio>

    <version_command><![CDATA[ samtools 2>&1 | grep Version ]]></version_command>

    <command>
    <![CDATA[
        samtools view
            -b
            -T ${reference_source.input_reference}
            -o $output_alignment
            $input_alignment
            
            ## -L FILE  only include reads overlapping this BED FILE [null]
            ## -> todo: check if unmapped reads are also selected when bed fil is selected
            ## [region]
    ]]>
    </command>

    <inputs>
        <param name="input_alignment" type="data" format="cram" label="CRAM alignment file"/>
        <conditional name="reference_source">
            <param name="reference_source_selector" type="select" label="Load reference genome from">
                <option value="cached">Local cache</option>
                <option value="history">History</option>
            </param>
            <when value="cached">
                <param name="input_reference" type="select" format="fasta" label="Genome reference FASTA file">
                    <options from_data_table="all_fasta">
                        <filter type="data_meta" ref="input_alignment" key="dbkey" column="1" />
                    </options>
                    <validator type="no_options" message="A built-in reference genome is not available for the build associated with the selected input file"/>
                </param>
            </when>
            <when value="history">
                <param name="input_reference" type="data" format="fasta" label="Genome reference FASTA file"/>
            </when>
        </conditional>
    </inputs>

    <outputs>
        <data format="bam" name="output_alignment" label="$tool.name on ${on_string}"></data>
    </outputs>

    <tests>
        <test>
            <param name="input_alignment" value="test.cram" ftype="cram" />
            <param name="reference_source_selector" value="history" />
            <param name="input_reference" value="test.fa" />

            <output name="output_alignment" file="test.bam"  compare="sim_size" delta="250" />
        </test>
    </tests>

    <help>
**What this tool does**

Converts alignments from the CRAM format to the BAM format.
    </help>

    <citations>
        <citation type="bibtex">
            @misc{Li_SamMath,
            Author={Li, H.},
            title={Mathematical Notes on SAMtools Algorithms},
            url = {http://www.broadinstitute.org/gatk/media/docs/Samtools.pdf},}
        </citation>
        <citation type="bibtex">
            @misc{SamTools_github,
            title={SAMTools GitHub page},
            url = {https://github.com/samtools/samtools},}
        </citation>
    </citations>
</tool>
