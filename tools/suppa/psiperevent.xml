<?xml version="1.0"?>
<tool id="suppa_psiperevent" name="SUPPA PsiPerEvent" version="@TOOL_VERSION@+@WRAPPER_VERSION@">
    <description></description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <stdio></stdio>
    <command detect_errors="exit_code"><![CDATA[
        ## initialize 
 
        ## run
        suppa.py
            #if $type_cond.type_sel == 'i'
                psiPerIsoform
                -g '$type_cond.g'
                -e '$type_cond.e'
            #else if $type_cond.type_sel == 'l'
                psiPerEvent
                -e '$type_cond.e'
                -i '$type_cond.i'
                -f $type_cond.f
            #end if
            -o 'result'

        && ls -lisa
        ]]></command>
    <inputs>
        <conditional name="type_cond" label="Select type">
            <param name="type_sel" type="select" label="Select type" help="">
                <option value="i">Isoform</option>
                <option value="l">Local event</option>
            </param>
            <when value="i">
                <param argument="-g" type="data" format="gtf" multiple="false" label="Select annotation file" help=""/>
                <expand macro="expressionfile"/>
            </when>
            <when value="l">
                <param argument="-i" type="data" format="tabular" multiple="false" label="Select IOE file" help="with the definition of the events and corresponding transcripts"/>
                <expand macro="expressionfile"/>
                <param argument="-f" type="integer" value="0" label="Set minimum total expression" help="Of the transcripts involved in the event (Default is zero). If used, it will filter out the events that do not reach this total expression value for the transcripts defining the event (the denominator of the PSI calculation)."/>
            </when>
        </conditional>
    </inputs>

    <outputs>
        <data name="out_l" format="tabular" from_work_dir="result.psi" label="${tool.name} on ${on_string}: local event">
            <filter>type_cond['type_sel'] == 'l'</filter>
        </data>
        <data name="out_i" format="tabular" from_work_dir="result_isoform.psi" label="${tool.name} on ${on_string}: isoform">
            <filter>type_cond['type_sel'] == 'i'</filter>
        </data>
    </outputs> 

    <tests> 
        <!-- #1 -->
        <test expect_num_outputs="1">
            <conditional name="type_cond">
                <param name="type_sel" value="i"/>
                <param name="g" value="testdata.gtf"/>
                <param name="e" value="expression.txt"/>
            </conditional>
            <output name="out_i">
                <assert_contents>
                    <has_n_lines n="2"/>
                    <has_text_matching expression="SRR1513329&#09;.+"/>
                    <has_text_matching expression="ENSG00000187642.+"/>
                </assert_contents>
            </output>
        </test>
        <!-- #2 -->
        <test expect_num_outputs="1">
            <conditional name="type_cond">
                <param name="type_sel" value="l"/>
                <param name="i" value="events.ioe"/>
                <param name="e" value="expression.txt"/>
                <param name="f" value="1"/>
            </conditional>
            <output name="out_l">
                <assert_contents>
                    <has_n_lines n="112"/>
                    <has_text_matching expression="SRR1513329&#09;.+"/>
                    <has_text_matching expression="ENSG00000239664.+"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

@WID@

SUPPA reads the ioi or ioe file generated in the previous step and a transcript expression file with the transcript abundances (TPM units) to calculate the relative abundance (PSI) value per sample for each transcript or each local event.

**Input**

An ioi/ioe file and a "transcript expression file" are required as input.

The transcript expression file is a tab separated file where each line provides the estimated abundance of each transcript (in TPM units). This file might contain multiple columns with the expression values in different samples. The expression file must have a header with the naming of the different expression fields, i.e., the sample name of each expression value.

An example of a transcript expression file for one single sample:

::

    sample1
    transcript1 <expression>
    transcript1 <expression>
    transcript1 <expression>

A transcript expression file with multiple samples:

::

    sample1 sample2 sample3 sample4
    transcript1 <expression>  <expression>  <expression>  <expression>
    transcript2 <expression>  <expression>  <expression>  <expression>
    transcript3 <expression>  <expression>  <expression>  <expression>

**Output**

These operations generate a psi file per each expression file. This file follows a similar format to the input expression file used in the psiPerEvent operation, where in the first column you find the event ID (transcript event or local AS event ID), and the following columns you find the PSI values in each sample. The PSI values are normalized between 0 and 1 ([0,1]). There are two exceptions for the PSI value:

NA: PSI = if the expression is 0 for all the transcripts involved in the event or if the event does not pass any the transcript expression filter (see PSI calculation, Command and options). Also if one or more transcripts of the event do not appear in the expression file, an NA will be returned

Example of a PSI file for transcript "events":

::

    sample1 sample2 sample3
    ENSG00000000003.10;ENST00000373020.4    0.9891352763622773      0.8702144635757746      0.9758296160419822
    ENSG00000000003.10;ENST00000494424.1    0.012124454316514821    0.01863029006342797     0.014658155865899102
    ENSG00000000003.10;ENST00000496771.1    0.9067534025774345      0.9116862902516033      0.911059790520273

Example of a PSI file for local AS events:

::

    sample1 sample2 sample3
    ENSG00000000003.14;SE:chrX:100630866-100632485:100632568-100633405:-    0.9420871643913276      0.9304369364607596  0.8999960720735679
    ENSG00000000419.12;SE:chr20:50940933-50941105:50941209-50942031:-       0.02302214526941425     0.08920651168486651 0.01093999389147593

.. class:: infomark

**References**

@REFERENCES@
    ]]></help>
    <expand macro="citations"/>
</tool>