<tool id="celltypist" name="CellTypist" version="@TOOL_VERSION@" profile="24.0">
    <description>Automated cell type annotation for scRNA-seq datasets</description>
    <macros>
        <token name="@TOOL_VERSION@">1.7.1</token>
    </macros>
    <xrefs>
        <xref type="bio.tools">celltypist</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">celltypist</requirement>
    </requirements>
    <command><![CDATA[
cat '$script_file' &&
python '$script_file'
    ]]>
    </command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
import scanpy as sc
import celltypist
from celltypist import models
adata = sc.read_h5ad('$adata')
#if $model_source.source == "cached"
model = models.Model.load(model='$model_source.cached_model.fields.path')
#elif $model_source.source == "history"
model = models.Model.load(model='$model_source.history_model')
#end if
predictions = celltypist.annotate(adata,
                model=model,
#if $majority_voting
                majority_voting=True,
#end if
#if $transpose_input
                transpose_input=$transpose_input,
#end if
                mode='$mode',
                p_thres=$p_thres,
                min_prop=$min_prop)

adata = predictions.to_adata()
adata.write_h5ad('$anndata_out', compression='gzip')
]]>
        </configfile>
    </configfiles>
    <inputs>
        <param name="adata" type="data" format="h5ad" label="Input AnnData file" />
        <conditional name="model_source">
            <param type="select" label="Select model from" name="source">
                <option value="cached" selected="true">Cached</option>
                <option value="history">History</option>
            </param>
            <when value="cached">
                <param type="select" name="cached_model" label="Choose CellTypist model">
                    <options from_data_table="celltypist_models">
                    </options>
                </param>
            </when>
            <when value="history">
                <param type="data" format="binary" name="history_model" label="Select compatible models from history." />
            </when>
        </conditional>
        <param name="majority_voting" type="boolean" label="Refine the predicted labels by running the majority voting classifier after over-clustering" value="True" />
        <param name="transpose_input" type="boolean" label="Transpose the input matrix is provided in the gene-by-cell format." value="False" help="Note Celltypist requires the cell-by-gene format"/>
        <param name="mode" type="select" label="Annotation mode">
            <option value="best match">Choose the cell type with the largest score/probability as the final prediction</option>
            <option value="prob match">Enable a multi-label classification utilising a probability threshold</option>
        </param>
        <param name="p_thres" type="float" value="0.5" min="0" max="1" label="Probability threshold for the multi-label classification" help="Ignored if mode is best match." />
        <param name="min_prop" type="float" value="0" min="0" max="1" label="The minimum proportion of cells required to support naming of the subcluster by this cell type" help="Ignored if majority_voting is set to False"/>
    </inputs>
    <outputs>
        <data name="anndata_out" format="h5ad" label="${tool.name} on ${on_string}: AnnData with celltype annotations" />
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="adata" location="https://celltypist.cog.sanger.ac.uk/Notebook_demo_data/demo_500_cells.h5ad"/>
            <conditional name="model_source">
                <param name="source" value="cached" />
                <param name="cached_model" value="Immune_All_High_v1" />
            </conditional>
            <param name="majority_voting" value="True" />
            <param name="mode" value="best match" />
            <param name="p_thres" value="0.5" />
            <param name="min_prop" value="0.05" />
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_h5_keys keys="obs/predicted_labels"/>
                    <has_h5_keys keys="obs/over_clustering"/>
                    <has_h5_keys keys="obs/majority_voting"/>
                    <has_h5_keys keys="obs/conf_score"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="adata" location="https://celltypist.cog.sanger.ac.uk/Notebook_demo_data/demo_500_cells.h5ad"/>
            <conditional name="model_source">
                <param name="source" value="history" />
                <param name="history_model" location="https://celltypist.cog.sanger.ac.uk/models/Pan_Immune_CellTypist/v2/Immune_All_Low.pkl" />
            </conditional>
            <param name="majority_voting" value="False" />
            <param name="mode" value="prob match" />
            <param name="p_thres" value="0.5" />
            <param name="min_prop" value="0.05" />
            <output name="anndata_out" ftype="h5ad">
                <assert_contents>
                    <has_h5_keys keys="obs/predicted_labels"/>
                    <has_h5_keys keys="obs/conf_score"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

CellTypist is an automated cell type annotation tool for scRNA-seq datasets on the basis of logistic regression classifiers optimised by the stochastic gradient descent algorithm. CellTypist allows for cell prediction using either built-in (with a current focus on immune sub-populations) or custom models, in order to assist in the accurate classification of different cell types and subtypes.


.. _CellTypist: https://www.celltypist.org/

------

**Inputs**

An anndata file in h5ad format that usually contains clustering results from single-cell RNA-seq analysis.

------

**Outputs**

An anndata file in h5ad format with predicted cell type annotations added to the .obs attribute.

cell_type	predicted_labels	over_clustering	majority_voting	conf_score
cell1	Plasma cells	Plasma cells	13	Follicular B cells	0.996313
cell2	Plasma cells	Plasma cells	6	Plasma cells	0.999478
cell3	Plasma cells	Plasma cells	12	Plasma cells	0.999957
cell4	Plasma cells	Plasma cells	6	Plasma cells	0.996070
cell5	Plasma cells	Plasma cells	6	Plasma cells	0.998888
...	...	...	...	...	...
cell496	Macro_pDC	pDC	9	Macrophages	0.187152
cell497	Macro_pDC	Macrophages	18	pDC	0.849831
cell498	Macro_pDC	Macrophages	9	Macrophages	0.809677
cell499	Macro_pDC	Macrophages	9	Macrophages	0.937306
cell500	Macro_pDC	pDC	9	Macrophages	0.612069

    ]]>    </help>
    <citations>
        <citation type="doi">10.1126/science.abl5197</citation>
    </citations>
</tool>