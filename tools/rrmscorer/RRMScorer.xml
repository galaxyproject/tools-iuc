<tool id="rrmcorer" name="RRM-Scorer: quick predictions RRM-RNA binding" version="@TOOL_VERSION@" profile="22.05">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
mkdir -p ./json ./tabular ./fasta ./plots &&
#if $input_sequence.fasta_input
rrmscorer --json 'json' --csv 'tabular' --fasta '$input_sequence.fasta_input'
#elif $input_sequence.uniprot_id
rrmscorer --json 'json' --csv 'tabular' --uniprot '$input_sequence.uniprot_id'
#else
echo "Either a UniProt ID or a FASTA file is required for running this tool. Please provide one of them." >&2 &&
exit 1
#end if

$plot_options.top_scoring_rna --window_size $tool_parameters.window_size

#if $tool_parameters.target
--rna '$tool_parameters.target'
#end if

#if $plot_options.generate_plots
--plot 'plots'
#end if
#if $plot_options.generate_fasta
--aligned 'fasta'
#end if
&& ls -R .
]]>
    </command>
    <inputs>
        <section name="input_sequence" title="Input sequence" expanded="true">
            <param name="fasta_input" type="data" format="fasta" optional="true" label="Protein sequence(s) FASTA format" help="Provide a FASTA file containing the protein sequences."/>
            <param name="uniprot_id" type="text" value="P19339" optional="true" label="OR Protein identifier from Uniprot" help="Provide a UniProt ID (e.g. P19339).">
                <validator type="empty_field" message="Missing UniProt ID or sequence in FASTA format."/>
            </param>
        </section>
        <section name="tool_parameters" title="Tool parameters" help="Configure this section to select the predictions to be executed">
            <param name="target" type="text" optional="true" label="Target RNA sequence (min. 5 nucleotides)" help="Provide a valid target RNA sequence or leave blank if not specifying.">
                <validator type="regex" message="The sequence must consist only of RNA nucleotides (A, U, G, C) or be left blank.">^([AUGCaugc]+)?$</validator>
            </param>
            <param name="window_size" type="select" label="The window size to test">
                <option value="5" selected="true">5</option>
                <option value="3">3</option>
            </param>
        </section>
        <section name="plot_options" title="Plot options" help="Configure plot output">
            <param name="generate_plots" type="boolean" label="Generate score plots for all the RNA possible windows" help="Enable to generate score plots."/>
            <param name="top_scoring_rna" type="boolean" truevalue="-t" falsevalue="" label="Find the top-scoring RNA for the specified RRM(s) and plot their sequence logo" help="Enable to find and plot the top-scoring RNA."/>
            <param name="generate_fasta" type="boolean" label="Generate a fasta file with each input sequence aligned to the HMM" help="Enable to generate a fasta file with aligned sequences."/>
        </section>
    </inputs>
    <outputs>
        <collection name="split_csv" type="list" label=" Tabular predictions by sequence">
            <discover_datasets pattern="__designation_and_ext__" directory="tabular" visible="true"/>
        </collection>
        <collection name="split_json" type="list" label=" Json predictions by sequence">
            <discover_datasets pattern="__designation_and_ext__" directory="json" visible="true"/>
        </collection>
        <collection name="split_fasta" type="list" label=" Fasta predictions by sequence">
            <discover_datasets pattern="__designation_and_ext__" directory="fasta" visible="true"/>
        </collection>
        <collection name="split_plots" type="list" label=" Plots predictions by sequence">
            <discover_datasets pattern="__designation_and_ext__" directory="plots" visible="true"/>
        </collection>
    </outputs>
    <tests>
        <test>
        <!-- Test 1 -->
            <section name="input_sequence">
                <param name="uniprot_id" value="P19339"/>
            </section>
            <section name="tool_parameters">
                <param name="target" value="AUGGCU"/>
                <param name="window_size" value="5"/>
            </section>
            <assert_command>
                <has_text text="--uniprot 'P19339'"/>
                <has_text text="--rna 'AUGGCU'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
            </assert_command>
        </test>
        <!-- Test 2 -->
        <test expect_num_outputs="4">
            <section name="input_sequence">
                <param name="uniprot_id" value="P19339"/>
            </section>
            <section name="tool_parameters">
                <param name="target" value="AUGGCU"/>
                <param name="window_size" value="5"/>
            </section>
            <assert_command>
                <has_text text="--uniprot 'P19339'"/>
                <has_text text="--rna 'AUGGCU'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
            </assert_command>
            <output_collection name="split_csv" type="list" count="2"/>
            <output_collection name="split_json" type="list" count="2"/>
        </test>
        <!-- Test 3 -->
        <test expect_num_outputs="4">
            <section name="input_sequence">
                <param name="uniprot_id" value="P19339"/>
            </section>
            <section name="tool_parameters">
                <param name="target" value="AUGGCU"/>
                <param name="window_size" value="5"/>
            </section>
            <assert_command>
                <has_text text="--uniprot 'P19339'"/>
                <has_text text="--rna 'AUGGCU'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
            </assert_command>
            <output_collection name="split_csv" type="list" count="2"/>
            <output_collection name="split_json" type="list" count="2"/>
        </test>
        <!-- Test 4 -->
        <test expect_num_outputs="4">
            <section name="input_sequence">
                <param name="uniprot_id" value="P19339"/>
            </section>
            <section name="tool_parameters">
                <param name="target" value="AUGGCU"/>
                <param name="window_size" value="5"/>
            </section>
            <assert_command>
                <has_text text="--uniprot 'P19339'"/>
                <has_text text="--rna 'AUGGCU'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
            </assert_command>
            <output_collection name="split_csv" type="list" count="2"/>
            <output_collection name="split_json" type="list" count="2"/>
        </test>
        <!-- Test 5 -->
        <test expect_num_outputs="4">
            <section name="input_sequence">
                <param name="uniprot_id" value="P19339"/>
            </section>
            <section name="tool_parameters">
                <param name="target" value="AUGGCU"/>
                <param name="window_size" value="5"/>
            </section>
            <section name="plot_options">
                <param name="generate_fasta" value="true"/>
            </section>
            <assert_command>
                <has_text text="--uniprot 'P19339'"/>
                <has_text text="--rna 'AUGGCU'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
                <has_text text="--aligned 'fasta'"/>
            </assert_command>
            <output_collection name="split_csv" type="list" count="2"/>
            <output_collection name="split_json" type="list" count="2"/>
            <output_collection name="split_fasta" type="list" count="2"/>
        </test>
        <!-- Test 6 -->
        <test expect_num_outputs="4">
            <section name="input_sequence">
                <param name="uniprot_id" value="P19339"/>
            </section>
            <section name="tool_parameters">
                <param name="window_size" value="5"/>
            </section>
            <section name="plot_options">
                <param name="top_scoring_rna" value="true"/>
            </section>
            <assert_command>
                <has_text text="--uniprot 'P19339'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
            </assert_command>
            <output_collection name="split_json" type="list" count="2"/>
        </test>
        <!-- Test 7 -->
        <test expect_num_outputs="4">
            <section name="input_sequence">
                <param name="uniprot_id" value="P19339"/>
            </section>
            <section name="tool_parameters">
                <param name="window_size" value="5"/>
            </section>
            <section name="plot_options">
                <param name="top_scoring_rna" value="true"/>
                <param name="generate_plots" value="true"/>
                <param name="top_scoring_rna" value="true"/>
            </section>
            <assert_command>
                <has_text text="--uniprot 'P19339'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
                <has_text text="--plot 'plots'"/>
            </assert_command>
            <output_collection name="split_json" type="list" count="2"/>
            <output_collection name="split_plots" type="list" count="8"/>
        </test>
        <!-- Test 8 -->
        <test expect_failure="true">
            <section name="input_sequence">
                <param name="uniprot_id" value="P19339"/>
            </section>
            <section name="tool_parameters">
                <param name="window_size" value="5"/>
            </section>
            <section name="plot_options">
                <param name="top_scoring_rna" value="false"/>
                <param name="generate_plots" value="true"/>
            </section>
            <assert_command>
                <has_text text="--uniprot 'P19339'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
                <has_text text="--plot 'plots'"/>
            </assert_command>
        </test>
        <!-- Test 9 -->
        <test expect_failure="true">
            <section name="input_sequence">
                <param name="uniprot_id" value="P19339"/>
            </section>
            <section name="tool_parameters">
                <param name="target" value="AUGGCU"/>
                <param name="window_size" value="5"/>
            </section>
            <section name="plot_options">
                <param name="top_scoring_rna" value="true"/>
                <param name="generate_plots" value="false"/>
                <param name="generate_fasta" value="true"/>
            </section>
            <assert_command>
                <has_text text="--uniprot 'P19339'"/>
                <has_text text="--rna 'AUGGCU'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
                <has_text text="--aligned 'fasta'"/>
            </assert_command>
        </test>
        <!-- Test 10 -->
        <test expect_num_outputs="4">
            <section name="input_sequence">
                <param name="uniprot_id" value="P19339"/>
            </section>
            <section name="tool_parameters">
                <param name="target" value="AUGGCU"/>
                <param name="window_size" value="5"/>
            </section>
            <section name="plot_options">
                <param name="generate_plots" value="false"/>
                <param name="generate_fasta" value="true"/>
            </section>
            <assert_command>
                <has_text text="--uniprot 'P19339'"/>
                <has_text text="--rna 'AUGGCU'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
                <has_text text="--aligned 'fasta'"/>
            </assert_command>
            <output_collection name="split_csv" type="list" count="2"/>
            <output_collection name="split_json" type="list" count="2"/>
            <output_collection name="split_fasta" type="list" count="2"/>
        </test>
        <!-- Test 11 -->
        <test expect_num_outputs="4">
            <section name="input_sequence">
                <param name="uniprot_id" value="P19339"/>
            </section>
            <section name="tool_parameters">
                <param name="window_size" value="5"/>
            </section>
            <section name="plot_options">
                <param name="top_scoring_rna" value="true"/>
                <param name="generate_plots" value="true"/>
                <param name="generate_fasta" value="true"/>
                <param name="top_scoring_rna" value="true"/>
            </section>
            <assert_command>
                <has_text text="--uniprot 'P19339'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
                <has_text text="--plot 'plots'"/>
                <has_text text="--aligned 'fasta'"/>
            </assert_command>
            <output_collection name="split_json" type="list" count="2"/>
            <output_collection name="split_fasta" type="list" count="2"/>
            <output_collection name="split_plots" type="list" count="8"/>
        </test>
        <!-- Test 12 -->
        <test expect_num_outputs="4">
            <section name="input_sequence">
                <param name="fasta_input" value="input.fasta" ftype="fasta"/>
            </section>
            <section name="tool_parameters">
                <param name="target" value="AUGGCU"/>
                <param name="window_size" value="5"/>
            </section>
            <section name="plot_options">
                <param name="generate_fasta" value="true"/>
            </section>
            <assert_command>
                <has_text text="--fasta"/>
                <has_text text="--rna 'AUGGCU'"/>
                <has_text text="--window_size 5"/>
                <has_text text="--json 'json'"/>
                <has_text text="--csv 'tabular'"/>
            </assert_command>
            <output_collection name="split_csv" type="list" count="2"/>
            <output_collection name="split_json" type="list" count="2"/>
        </test>
    </tests>
    <help><![CDATA[
    This tool allows you to predict RNA Recognition Motif (RRM) scores for protein
    sequences provided in *FASTA* format or as *UniProt IDs*.

    **RRMScorer** is designed to predict RNA binding preferences for proteins containing
    RNA recognition motifs (RRMs), the most prevalent RNA binding domain in eukaryotes.

    **Abstract:**

    By carefully analysing a dataset of 187 RRM-RNA structural complexes, we calculated
    residue-level binding scores using a probabilistic model derived from
    amino acid-nucleotide interaction propensities, which are the basis of
    **RRMScorer**.

    With its ability to provide residue-level insights and accurate predictions,
    **RRMScorer** serves as a valuable tool for researchers exploring the functional
    landscape of RRM-RNA interactions.

    **Methodology**:

    The input sequence is scanned against our RRMScorer hidden Markov model (HMM)
    to (i) identify whether the input sequence contains any RRM domain and (ii)
    map to the 20 positions in the RRM protein sequence alignment that we use to compute
    the RNA binding scores.

    If one or more RRM domains are identified in the input sequence, RRMScorer computes
    the score of the user-defined RNA sequence, or if absent, the scores for all the
    1024 RNA possible sequences with a length of 5 nt. By utilizing a specific
    RNA sequence, the user can inspect to which 5-nt windows the RRM is more likely
    to bind.

    **Input fields:**

    * **Protein sequence(s) FASTA format:** Provide a *FASTA* file containing the protein sequences.
    * **Protein identifier from Uniprot:** Provide a *UniProt ID* (e.g. P19339).
    * **Custom RNA target:** Enable or disable the use of a custom RNA target for the predictions.
    * **Target:** Provide a valid target RNA sequence (minimum 5 nucleotides) if Custom RNA target is enabled.
    * **The window size to test:** Select the window size (either 3 or 5 nucleotides).
    * **Plot options:** Configure plot output options.

    **Output:**

    The results are provided in comprehensive bar plots as well as in
    CSV and JSON formats. When a custom RNA is not provided, the results will
    include protein sequence logos for a range of top-scoring RNA sequences, as well
    as the aforementioned CSV and JSON files with the scores.
    ]]>
    </help>
    <citations>
        <citation type="doi">10.1371/journal.pcbi.1010859</citation>
        <citation type="doi">10.1093/nar/gkaf367</citation>
    </citations>
</tool>
