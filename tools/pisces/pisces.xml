<?xml version="1.0"?>
<tool id="pisces_pisces" name="Pisces" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="18.01">
    <description>variant caller for somatic and germline NGS Data</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[ 
## preprocessing
## genome
@GENOMESIZE@
## samples
mkdir data &&
#for $i, $current in enumerate($bam)
    ln -s '${current}' 'data/sample_${i}.bam' && ## TODO name pattern required?
    ln -s '${current.metadata.bam_index}' 'data/sample_${i}.bam.bai' &&
#end for

## run
/home/stephan/Projects/tools/pisces/All_5.3.0.0/Pisces ## TODO
## required parameters
-g 'genome'
-b 'data'

## common
#if $co.i
    -i '$co.i' ## TODO test
#end if
$co.mode_cond.mode_sel
#if $co.mode_cond.mode_sel == '--forcedalleles'
    '$co.mode_cond.forcedalleles' ## TODO test
#end if

#if $co.callmnvs_cond.callmnvs_sel == '--callmnvs true'
    $co.callmnvs_cond.callmnvs_sel
    --maxmnvlength $co.callmnvs_cond.maxmnvlength
    --maxgapbetweenmnv $co.callmnvs_cond.maxgapbetweenmnv
#end if

#if '--outputsbfiles true' in $oo.out
    --outputsbfiles true
#end if
--threadbychr true

#if $co.collapse_cond.collapse_sel == '--collapse true'
    $co.collapse_cond.collapse_sel
    --collapsefreqthreshold $co.collapse_cond.collapsefreqthreshold
    --collapsefreqratiothreshold $co.collapse_cond.collapsefreqratiothreshold    
    #if $co.collapse_cond.priorspath
        --priorspath '$co.collapse_cond.priorspath' ## TODO test
    #end if    
    $co.collapse_cond.trimmnvpriors
#end if

--coveragemethod $co.coveragemethod
--baselogname 'log' ## TODO fetch logs
--debug true ## TODO fetch logs

$co.usestitchedxd
--trackedanchorsize $co.trackedanchorsize
--insidesubprocess true ## TODO required?
--multiprocess true
#if $co.chrfilter != '' ## TODO
    --chrfilter '$co.chrfilter'
#end if
--outfolder 'results'
--maxthreads \${GALAXY_SLOTS:-4}

## bam filtering
--minbasecallquality $bfo.minbasecallquality
--minmapquality $bfo.minmapquality
$bfo.filterduplicates
$bfo.pp




    ]]></command>
    <inputs>
        <!-- CreateGenomeSizeFile.dll -->
        <expand macro="genome" help="; Pisces -g, --genomepaths, --genomefolders"/>
        <expand macro="genome_description"/>
        <!-- GeminiMulti.dll -->
        <expand macro="bam" multiple="true" label="Select sample file(s)"/>

        <section name="co" title="Common options" expanded="true">
            <param name="-i" type="data" format="tabular" optional="true" label="Select interval file" help="(-i, --intervalpaths)"/>
            <conditional name="mode_cond">
                <param name="mode_sel" type="select" label="Select mode">
                    <option value="" selected="true">None</option>
                    <option value="--crushvcf true">Crush VCF to one line per loci (--crushvcf)</option>
                    <option value="--forcedalleles">Select forced alleles (--forcedalleles)</option>
                </param>
                <when value=""/>
                <when value="--crushvcf true"/>
                <when value="--forcedalleles">
                    <param argument="--forcedalleles" type="data" format="vcf" label="Select file with alleles that are forced to report"/>
                </when>
            </conditional>

            <conditional name="callmnvs_cond">
                <param name="callmnvs_sel" type="select" label="Call multiple nucleotide variants?" help="MNVs a.k.a. phased SNPs (--callmnvs)">
                    <option value="--callmnvs false" selected="true">No</option>
                    <option value="--callmnvs true">Yes</option>
                </param>
                <when value="--callmnvs false"/>
                <when value="--callmnvs true">
                    <param argument="--maxmnvlength" type="integer" min="1" max="1000" value="3" label="Set maximum length for MNVs"/>
                    <param name="maxgapbetweenmnv" type="integer" min="0" value="1" label="Set maximum allowed gap between phased SNPs that can be called" help="Maximum length of reference span contained in MNV. (--maxgapbetweenmnv, --maxrefgapinmnv)"/>
                </when>
            </conditional>

            <conditional name="collapse_cond" label="">
                <param name="collapse_sel" type="select" multiple="false" label="Collapse variants together?">
                    <option value="--collapse true">Yes</option>
                    <option value="--collapse false">No</option>
                </param>
                <when value="--collapse false"/>
                <when value="--collapse true">
                    <param argument="--collapsefreqthreshold" type="float" min="0.0" max="1.0" value="0.0" label="Set minimum frequency required for target variants"/>
                    <param argument="--collapsefreqratiothreshold" type="float" min="0.0" max="1.0" value="0.5" label="Set minimum ratio required of target variant frequency to collapsible variant frequency"/>
                    <param argument="--priorspath" type="data" format="vcf" optional="true" label="Select file containing known variants" help="To preferentially reconcile variants."/>
                    <param argument="--trimmnvpriors" type="boolean" truevalue="--trimmnvpriors true" falsevalue="" label="Trim preceeding base from MNVs in priors file?" help="COSMIC convention is to include preceeding base for MNV, which is NOT the Pisces convention. So, if you are using -collapse and -priorsFile and your file defies Pisces MNV convention you need this."/>
                </when>                                
            </conditional>

            <param argument="--coveragemethod" type="select" label="Select coverage method">
                <option value="approximate" selected="true">approximate</option>
                <option value="exact">exact</option>
            </param>
            <param argument="--usestitchedxd" type="boolean" truevalue="--usestitchedxd true" falsevalue="--usestitchedxd false" label="Use stitched XD?" help="Make use of the consensus read-direction information (the XD tag) from stitched reads. This is on by default when using Stitcher output BAM, but must be deliberately set for Gemini output."/>
            <param argument="--trackedanchorsize" type="integer" min="0" value="5.0" label="Set tracked anchor size" help="Maximum size of anchor to granularly track, when collecting reference coverage at insertion sites. If zero, all coverage counts equally. Higher values will yield more precise spanning coverage results but require more memory and compromise speed."/>
            <param argument="--chrfilter " type="text" value="" optional="true" label="Set chromosomes to process" help="Comma-separated list."/>
        </section>

        <section name="bfo" title="BAM filtering options" expanded="true">
            <expand macro="minbasecallquality"/>
            <expand macro="minmapquality"/>
            <param argument="--filterduplicates" type="boolean" truevalue="--filterduplicates true" falsevalue="--filterduplicates false" checked="true" label="Filter reads marked as duplicates?" help="(--filterduplicates, --duplicatereadfilter)"/>
            <param argument="--pp" type="boolean" truevalue="--pp true" falsevalue="--pp false" label="Only use proper pairs?" help="(--pp, --onlyuseproperpairs)"/>
        </section>


        <section name="vco" title="Variant calling options" expanded="true">
            <param name="--minvq" type="integer" min="" max="" value="" label="Set minimum variant Qscore to report variant" help="(--minvq, --minvariantqscore)"/>
            <param name="-c" type="integer" min="" max="" value="" label="Set minimum depth to call a variant" help="(-c, --mindp, --mindepth, --mincoverage)"/>
            <param name="--minvf" type="float" min="0.0" max="1.0" value="" label="Set minimum frequency to call a variant" help="(--minvf, --minimumvariantfrequency, --minimumfrequency)"/>
            <param name="--targetlodfrequency" type="float" min="0.0" max="1.0" value="" label="Set target frequency to call a variant" help="E.g. to target a 5% allele frequency, we must call down to 2.6%, to capture that 5% allele 95% of the time. This parameter is used by the Somatic Genotyping Model. (--targetlodfrequency, --targetvf)"/>
            <param argument="--vqfilter" type="integer" min="" max="" value="" label="Set filtered variant Qscore to report variant as filtered" help="(--vqfilter, --variantqualityfilter)"/>
            <param name="--vffilter" type="float" min="0.0" max="1.0" value="" label="Set filtered variant frequency to report variant as filtered" help="(--vffilter, --minvariantfrequencyfilter)"/>
            <param name="--gqfilter" type="integer" min="" max="" value="" label="Set filtered genotype quality to report variant as filtered" help="(--gqfilter, --genotypequalityfilter)"/>
            <param name="--mindpfilter" type="integer" min="" max="" value="" label="Set filtered low depth to report variant as filtered" help="(--mindpfilter, --mindepthfilter)"/>
            <param name="--ssfilter" type="boolean" truevalue="--ssfilter true" falsevalue="--ssfilter false" checked="true" label="Flag variants as filtered if coverage limited to one strand?" help="(--ssfilter, --enablesinglestrandfilter)"/>
            <param argument="--nl" type="integer" min="" max="" value="" label="Set noise level for Q model" help="Overrides the noise level to used by the quality model with this value. By default, this is driven by the basecall filter. (--nl, --noiselevelforqmodel)"/>
            <param argument="--ploidy" type="select" label="Select ploidy model">
                <option value="somatic" selected="true">Somatic</option>
                <option value="diploid">Diploid</option>
                <option value="DiploidByAdaptiveGT">DiploidByAdaptiveGT</option>
            </param>
            <param argument="--diploidsnvgenotypeparameters" type="text" value="0.2,0.7,0.8" label="Set diploid SNV genotype parameters" help="A,B,C"/>
            <param argument="--diploidindelgenotypeparameters" type="text" value="0.2,0.7,0.8" label="Set diploid indel genotype parameters" help="A,B,C"/>
            <param argument="--adaptivegenotypeparameters_fromfile" type="data" format="" optional="true" label="Select adaptive genotype parameters file"/>
            <param argument="--adaptivegenotypeparameters_snvmodel" type="text" value="0.037,0.439,0.976" label="Set adaptive genotype parameters SNV model" help="A,B,C"/>
            <param argument="--adaptivegenotypeparameters_indelmodel" type="text" value="0.037,0.443,0.905" label="Set adaptive genotype parameters indel model" help="A,B,C"/>
            <param argument="--adaptivegenotypeparameters_snvprior" type="text" value="0.755,0.154,0.0919" label="Set adaptive genotype parameters SNV prior" help="A,B,C"/>
            <param argument="--adaptivegenotypeparameters_indelprior" type="text" value="0.962,0.0266,0.0114" label="Set adaptive genotype parameters indel prior" help="A,B,C"/>
            <param argument="--sbmodel" type="text" value="" label="--sbmodel" help=""/>
            <param argument="--maxvq" type="integer" min="" max="" value="100" label="Set maximum variant QScore to cap output variant Qscores" help="(--maxvq, --maxvariantqscore)"/>
            <param argument="--maxgq" type="integer" min="" max="" value="100" label="Set maximum genotype QScore to cap output genotype Qscores" help="(--maxgq, --maxgenotypeqscore)"/>
            <param argument="--maxgp" type="integer" min="" max="" value="3000" label="Set maximum genotype posterior score to cap output genotype posteriors" help="(--maxgp, --maxgenotypeposteriorscore)"/>
            <param argument="--mingq" type="integer" min="" max="" value="0" label="Set minimum genotype QScore to cap output genotype Qscores" help="(--mingq, --mingenotypeqscore)"/>
            <param argument="--sbfilter" type="float" min="" max="" value="0.5" label="Set strand bias cutoff" help="(--sbfilter, --maxacceptablestrandbiasfilter )"/>
            <param argument="--noisemodel" type="select" multiple="false" label="--noisemodel" help="">
                <option value="Flat" selected="true">Flat</option>
                <option value="Window">Window</option>
            </param>
            <param argument="--gender" type="select" label="Select gender" help="Used in ploidy calculation. Only affects germline-mode results."> <!-- TODO -->
                <option value="" selected="true">None</option>
                <option value="true">Male</option>
                <option value="false">Female</option>
            </param>
            <param argument="--rmxnfilter" type="text" value="R5x9,F=20" label="Set RMXN filter" help="M,N,F. Comma-separated list of integers indicating max length of the repeat section (M), the minimum number of repetitions of that repeat (N), to be applied if the variant frequency is less than (F)."/>
            <param argument="--ncfilter" type="float" value="" label="Set no-call rate filter"/> <!-- TODO min,max,default?! -->
            <param argument="--abfilter" type="float" value="" optional="true" label="Set amplicon bias filter threshold" help="By default, this filter is off. If on, the threshold has the following meaning:  If a variant shows up at Y percent on amplicon A and X percent on amplicon B, the X observation must be at least as probable as the Amplicon bias filter threshold, using the observations of Y as frequency estimate.  To turn on, set to a positive float. '0.01' seems to work well."/>
        </section>


        <section name="vcfp" title="VCF writer options">
            <param argument="--gvcf" type="boolean" truevalue="--gvcf true" falsevalue="--gvcf false" label="Create gVCF outputs?" help="Include reference calls."/>

            <param argument="--reportnocalls" type="boolean" truevalue="--reportnocalls true" falsevalue="--reportnocalls false" label="Report no calls?"/>
            <param argument="--reportrccounts" type="boolean" truevalue="--reportrccounts true" falsevalue="--reportrccounts false" label="Report collapsed read counts?" help="When BAM files contain X1 and X2 tags, output read counts for duplex-stitched, duplex-nonstitched, simplex-stitched, and simplex-nonstitched."/>
            <!-- TODO debug option, maybe skip? check parameter description -->
            <param argument="--reporttscounts" type="boolean" truevalue="--reporttscounts true" falsevalue="" label="Report collapsed read count by different template strands?" help="Conditional on ReportRcCounts, output read counts for duplex-stitched, duplex-nonstitched, simplex-forward-stitched, simplex-forward-nonstitched, simplex-reverse-stitched, simplex-reverse-nonstitched."/>
            <param argument="--reportsuspiciouscoveragefraction" type="boolean" truevalue="--reportsuspiciouscoveragefraction true" falsevalue="" label="Report fraction of total coverage?" help="For spanning variants, this is start + end coverage, so up to double the reported coverage that is 'suspicious' i.e. unanchored and bearing some resemblance to an insertion at that site."/>
        </section>

                 













        <section name="op" title="Output parameters">
            <param argument="--outputsbfiles" type="boolean" truevalue="--outputsbfiles true" falsevalue="" label="Output strand bias files?"/>

<param argument="" type="boolean" truevalue="" falsevalue="" checked="true" label="CreateOutput strand bias files" help=""/>
      --outputsbfiles <BOOL> BOOL Output strand bias files, 'true' or 'false'

            <param argument="log" type="boolean" checked="true" label="Create log file?"/> <!-- TODO remove checked -->
        </section>


















    </inputs>
    <outputs>

    </outputs>
    <tests>
      
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

Pisces is a variant calling application, tuned for amplicons and enrichment panels. By default, it calls low frequency somatic variants, but it also supports germline calling.

**Input**

Pisces requires one or more BAM files as input. These BAM files are assumed to be sorted, i.e. alignment reads should be sorted by mapped reference position. Positions in BAM files are expected to use 0-based coordinate system.

Pisces does not perform denovo variant calling. Therefore, it also requires a reference genome for each BAM file.

Optionally, the user can specify genomic regions of interest for which Pisces should produce allele calls. This is done by providing Picard-style interval files. This format lists intervals defined as a chromosome, and start and end positions, inclusive. Positions in interval files are expected to use 1-based coordinate system. An example of a line in an interval file is as follows, where the entries between brackets describe typical hidden characters.

... list optional input files ... there are a lot of optional PATH variables

::

    chr1    11299989    11300989

**Output**

Any variants found by the algorithms are reported to the output VCF files.

... possible optional output files?

.. class:: infomark

**References**

More information are available on `GitHub <https://github.com/Illumina/Pisces/>`_ and the `user guide <https://github.com/Illumina/Pisces/wiki>`_.
    ]]></help>
    <expand macro="citations"/>
</tool>