<?xml version="1.0"?>
<tool id="pisces_geminimulti" name="Pisces GeminiMulti" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>pair-aware indel realigner and read stitcher</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
## preprocessing
## process genome and create GenomeSize.xml
@GENOMESIZE@
## process samples
mkdir data &&
ln -s '${bam}' 'data/sample.bam' &&
ln -s '${bam.metadata.bam_index}' 'data/sample.bam.bai' &&

## run
/home/stephan/Projects/tools/pisces/All_5.3.0.0/GeminiMulti ## TODO
## required
--bam 'data/sample.bam'
--genome 'genome' ## folder
--samtools 'samtools'
--numprocesses \${GALAXY_SLOTS:-4}
--exepath '/home/stephan/Projects/tools/pisces/All_5.3.0.0/Gemini' ## TODO
--outfolder 'results'
## common
$co.keepbothsidesoftclips
$co.trustsoftclips
$co.keepprobe
$co.remaskmessysoftclips
$mode_cond.mode_sel ## --stitchonly | --realignonly
#if $mode_cond.mode_sel == '' or $mode_cond.mode_sel == '--stitchonly true'
    ## stitching
    --minbasecallquality $mode_cond.so.minbasecallquality
    $mode_cond.so.nifydisagreement
    --maxreadlength $mode_cond.so.maxreadlength
    $mode_cond.so.dontstitchrepeatoverlap
    $mode_cond.so.ignorereadsabovemaxlength
    $mode_cond.so.countnstowarddisagreeingbases
    --maxnumdisagreeingstitchedbases $mode_cond.so.maxnumdisagreeingstitchedbases
    #if $mode_cond.so.stringtagstokeepfromr1 != ''
        --stringtagstokeepfromr1 '$mode_cond.so.stringtagstokeepfromr1'
    #end if
#end if
#if $mode_cond.mode_sel == '' or $mode_cond.mode_sel == '--realignonly true'
    ## realignment
    $mode_cond.ro.maskpartialinsertion
    --minimumunanchoredinsertionlength $mode_cond.ro.minimumunanchoredinsertionlength
    $mode_cond.ro.softclipunknownindels
    $mode_cond.ro.checksoftclipsformismatches
    $mode_cond.ro.trackmismatches
    #if $mode_cond.ro.categoriestorealign != ''
        --categoriestorealign '$mode_cond.ro.categoriestorealign' ## todo
    #end if
    #if $mode_cond.ro.categoriestosnowball != ''
        --categoriestosnowball '$mode_cond.ro.categoriestosnowball' ## todo
    #end if
    $mode_cond.ro.pairawareeverything
    $mode_cond.ro.forcehighlikelihoodrealigners
    ## realignment bins
    --messysitethreshold $mode_cond.rbo.messysitethreshold
    --messysitewidth $mode_cond.rbo.messysitewidth
    $mode_cond.rbo.collectdepth
    --imperfectfreqthreshold $mode_cond.rbo.imperfectfreqthreshold
    --indelregionfreqthreshold $mode_cond.rbo.indelregionfreqthreshold
    --regiondepththreshold $mode_cond.rbo.regiondepththreshold
    $mode_cond.rbo.recalculateusablesitesaftersnowball
#end if
## gemini multi
--multiprocess true
#if $gmo.chromosomes != ''
    --chromosomes '$gmo.chromosomes'
#end if
## read filtering
$rfo.skipandremovedups
--minmapquality $rfo.minmapquality
$rfo.filterforproperpairs
$rfo.treatabnormalorientationasimproper
## indel
--minpreferredsupport $ifo.minpreferredsupport
--minpreferredanchor $ifo.minpreferredanchor
--minrequiredindelsupport $ifo.minrequiredindelsupport
--minrequiredanchor $ifo.minrequiredanchor
--maxmessthreshold $ifo.maxmessthreshold
--binsize $ifo.binsize
$ifo.requirepositiveoutcomeforsnowball
## processing
--readcachesize 1000
--regionsize 10000000
--numconcurrentregions 1
--maxnumthreads \${GALAXY_SLOTS:-4} ## TODO
## read silencing
--directionalmessthreshold $rso.directionalmessthreshold
--messymapq $rso.messymapq
$rso.silencesuspiciousmdreads
$rso.silencedirectionalmessreads
$rso.silencemessymapmessreads
## debug
--logregionsandrealignments false
--lightdebug false
--debug false
--keepunmerged false
## read classification
--numsoftclipstobeconsideredmessy $rco.numsoftclipstobeconsideredmessy
--nummismatchestobeconsideredmessy $rco.nummismatchestobeconsideredmessy

## postprocessing
@LOG@
&& test -d 'results/GeminiMultiLogs' && zip 'results/multilogs.zip' 'results/GeminiMultiLogs/GeminiMultiLogs.txt' 'results/GeminiMultiLogs/GeminiMultiOptions.used.json' -q -j || echo 'No log files.'
&& test -d 'results/GeminiChromosomeLogs' && zip -r -q -j 'results/chromosomelogs.zip' 'results/GeminiChromosomeLogs' || echo 'No log files.'
    ]]></command>
    <inputs>
        <!-- CreateGenomeSizeFile.dll -->
        <expand macro="genome"/>
        <expand macro="genome_description"/>
        <!-- GeminiMulti.dll -->
        <param argument="--bam" type="data" format="bam" label="Select input file"/>
        <section name="co" title="Common options" expanded="true">
            <param argument="--keepbothsidesoftclips" type="boolean" truevalue="--keepbothsidesoftclips true" falsevalue="--keepbothsidesoftclips false" label="Keep both-side softclips?" help="Trust that both-side softclips are probe and should stay softclipped?"/>
            <param argument="--trustsoftclips" type="boolean" truevalue="--trustsoftclips true" falsevalue="--trustsoftclips false" label="Trust softclips?" help="If true, having softclips doesn't automatically trigger indel realignment. Also, won't try to stitch the softclips."/>
            <param argument="--keepprobe" type="boolean" truevalue="--keepprobe true" falsevalue="--keepprobe false" label="Keep probe?" help="Trust that probe-side softclips are probe and should stay softclipped?"/>
            <param argument="--remaskmessysoftclips" type="boolean" truevalue="--remaskmessysoftclips true" falsevalue="--remaskmessysoftclips false" label="Remask messy softclips?" help="If true, read-ends that were originally softclipped and are still highly mismatching to reference after realignment are re-softclipped, even if not configured to keep probe softclips. If false, only N-softclips are remasked when not keeping probe softclips."/>
        </section>
        <conditional name="mode_cond">
            <param name="mode_sel" type="select" label="Select mode">
                <option value="" selected="true">Stich and realign</option>
                <option value="--stitchonly true">Stitch</option>
                <option value="--realignonly true">Realign</option>
            </param>
            <when value="">
                <expand macro="so"/>
                <expand macro="ro"/>
            </when>
            <when value="--stitchonly true">
                <expand macro="so"/>
            </when>
            <when value="--realignonly true">
                <expand macro="ro"/>
            </when>
        </conditional>
        <section name="gmo" title="Gemini multi options" expanded="true">
            <param argument="--chromosomes" type="text" value="" optional="true" label="Set chromosomes to process" help="Comma-separated list."/>
        </section>
        <section name="rfo" title="Read filtering options" expanded="true">
            <param argument="--skipandremovedups" type="boolean" truevalue="--skipandremovedups true" falsevalue="--skipandremovedups false" checked="true" label="Skip and remove duplicates?"/>
            <param argument="--minmapquality" type="integer" value="1" label="Set minimum map quality" help="Read pairs with map quality less than this value should be filtered. If only one mate in a pair has a low map quality, it is treated as split (or derivations thereof). Should not be negative."/>
            <param argument="--filterforproperpairs" type="boolean" truevalue="--filterforproperpairs true" falsevalue="--filterforproperpairs false" label="Filter reads marked as not proper pairs?"/>
            <param argument="--treatabnormalorientationasimproper" type="boolean" truevalue="--treatabnormalorientationasimproper true" falsevalue="--treatabnormalorientationasimproper false" label="Treat non-F1R2/F2R1 read pairs as improper?" help="Even if flagged as properly paired?"/>
        </section>
        <section name="ifo" title="Indel filtering options" expanded="true">
            <param argument="--minpreferredsupport" type="integer" value="3" label="Set minimum preferred support" help="Instances of a found variant before it can be considered to realign around."/>
            <param argument="--minpreferredanchor" type="integer" value="1" label="Set minimum preferred anchor" help="Around indel to count an observation toward good evidence."/>
            <param argument="--minrequiredindelsupport" type="integer" value="0" label="Set minimum required indel support" help="Don't even allow otherwise strong indels that we attempt to rescue in if they have num observations below this."/>
            <param argument="--minrequiredanchor" type="integer" value="0" label="Set minimum required anchor" help="Don't even allow otherwise strong indels that we attempt to rescue in if they have min anchor below this."/>
            <param argument="--maxmessthreshold" type="integer" value="20" label="Set maximum mess threshold" help="Don't allow indels with average mess above this value."/>
            <param argument="--binsize" type="integer" value="0" label="Set bin size" help="Within which to consider indels overlapping and eligible for pruning."/>
            <param argument="--requirepositiveoutcomeforsnowball" type="boolean" truevalue="--requirepositiveoutcomeforsnowball true" falsevalue="--requirepositiveoutcomeforsnowball false" checked="true" label="Require positive outcome for snowball?" help="Whether to filter out indels that did not have any realignment attempts at all during snowballing (stricter than base level of filtering indels that had failed realignment attempts)."/>
        </section>
        <section name="rso" title="Read silencing options" expanded="true">
            <param argument="--directionalmessthreshold" type="float" value="0.2" label="Set directional mess threshold" help="Proportion of directionally messy (ForwardMessy or ReverseMessy, etc) reads in neighborhood above which we should silence the affected mates."/>
            <param argument="--messymapq" type="integer" value="30" label="Set messy map quality" help="Mapping quality of reads below which, when combined with high mismatch/softclips, a read is considered a suspicious/multi-mapping messy read."/>
            <param argument="--silencesuspiciousmdreads" type="boolean" truevalue="--silencesuspiciousmdreads true" falsevalue="--silencesuspiciousmdreads false" checked="true" label="Silence suspicious MD reads?" help="Whether to silence read pairs whose MD tags indicate suspicion."/>
            <param argument="--silencedirectionalmessreads" type="boolean" truevalue="--silencedirectionalmessreads true" falsevalue="--silencedirectionalmessreads false" label="Silence directional mess reads?" help="Whether to silence read mates which are very messy and have clean mates, given that the proportion of such reads in the neighborhood exceeds DirectionalMessThreshold."/>
            <param argument="--silencemessymapmessreads" type="boolean" truevalue="--silencemessymapmessreads true" falsevalue="--silencemessymapmessreads false" label="Silence messy map mess reads?" help="Whether to silence read pairs that are messy and have one or both mates with mapping quality below MessyMapq, given that the proportion of such reads in the neighborhood exceeds DirectionalMessThreshold."/>
        </section>
        <section name="rco" title="Read classification options" expanded="true">
            <param argument="--numsoftclipstobeconsideredmessy" type="integer" value="8" label="Set number of softclips to be considered messy" help="When classifying reads (e.g. imperfect, messy, directional messy), the mininum number of softclips that will trigger one of the messy classifications, given that softclips are not to be trusted."/>
            <param argument="--nummismatchestobeconsideredmessy" type="integer" value="3" label="Set number of mismatches to be considered messy" help="When classifying reads (e.g. imperfect, messy, directional messy), the minimum number of mismatches that will trigger one of the messy classifications."/>
        </section>
        <section name="oo" title="Output options" expanded="true">
            <param name="out" type="select" multiple="true" optional="false" label="Select output file(s)">
                <option value="result">Sorted, stitched, indel realigned BAM</option>
                <option value="chromosomelog" selected="true">Chromosome logs</option>
                <option value="genomesize">GenomeSize</option>
                <option value="log">Logs</option>
                <option value="multilog">Multi logs</option>
            </param>
        </section>
    </inputs>
    <outputs>
        <data name="out_chromosomelogs" format="zip" from_work_dir="results/chromosomelogs.zip" label="${tool.name} on ${on_string}: ChromosomeLogs">
            <filter>'chromosomelog' in oo['out']</filter>
        </data>
        <data name="out_genomesize" format="xml" from_work_dir="genome/GenomeSize.xml" label="${tool.name} on ${on_string}: GenomeSize">
            <filter>'genomesize' in oo['out']</filter>
        </data>
        <expand macro="log"/>
        <data name="out_multilogs" format="zip" from_work_dir="results/multilogs.zip" label="${tool.name} on ${on_string}: MultiLogs">
            <filter>'multilog' in oo['out']</filter>
        </data>
        <data name="out_result" format="bam" from_work_dir="results/sample.PairRealigned.bam" label="${tool.name} on ${on_string}: Sorted, stitched, indel realigned BAM">
            <filter>'result' in oo['out']</filter>
        </data>
    </outputs>
    <tests>
        <!-- no test implemented for stringtagstokeepfromr1 -->

        <!-- #1 default -->
        <test expect_num_outputs="5">
            <param name="genome" value="genome.fasta"/>
            <param name="genome_description" value="Human (hg19) "/>
            <param name="bam" value="control.bam"/>
            <section name="oo">
                <param name="out" value="result,chromosomelog,genomesize,log,multilog"/>
            </section>
            <output name="out_chromosomelogs">
                <assert_contents>
                    <has_size value="5990" delta="100"/>
                </assert_contents>
            </output>
            <output name="out_genomesize">
                <assert_contents>
                    <has_size value="278"/>
                </assert_contents>
            </output>
            <output name="out_log">
                <assert_contents>
                    <has_text_matching expression=".+Done cleaning up.+"/>
                </assert_contents>
            </output>
            <output name="out_multilogs" delta="100">
                <assert_contents>
                    <has_size value="2604"/>
                </assert_contents>
            </output>
            <output name="out_result">
                <assert_contents>
                    <has_size value="209548" delta="1000"/>
                </assert_contents>
            </output>
        </test>
        <!-- #2 stitchonly -->
        <test expect_num_outputs="5">
            <param name="genome" value="genome.fasta"/>
            <param name="genome_description" value="Human (hg19) "/>
            <param name="bam" value="control.bam"/>
            <section name="co">
                <param name="keepbothsidesoftclips" value="true"/>
                <param name="trustsoftclips" value="true"/>
                <param name="keepprobe" value="true"/>
                <param name="remaskmessysoftclips" value="true"/>
            </section>
            <conditional name="mode_cond">
                <param name="mode_sel" value="--stitchonly true"/>
                <section name="so">
                    <param name="minbasecallquality" value="21"/>
                    <param name="nifydisagreement" value="true"/>
                    <param name="maxreadlength" value="1023"/>
                    <param name="dontstitchrepeatoverlap" value="true"/>
                    <param name="ignorereadsabovemaxlength" value="true"/>
                    <param name="countnstowarddisagreeingbases"  value="true"/>
                    <param name="maxnumdisagreeingstitchedbases" value="2147483646"/>
                </section>
            </conditional>
            <section name="gmo">
                <param name="chromosomes" value="chr1,chrM"/>
            </section>
            <section name="rfo">
                <param name="skipandremovedups" value="false"/>
                <param name="minmapquality" value="2"/>
                <param name="filterforproperpairs" value="true"/>
                <param name="treatabnormalorientationasimproper" value="true"/>
            </section>
            <section name="ifo">
                <param name="minpreferredsupport" value="4"/>
                <param name="minpreferredanchor" value="2"/>
                <param name="minrequiredindelsupport" value="1"/>
                <param name="minrequiredanchor" value="1"/>
                <param name="maxmessthreshold" value="21"/>
                <param name="binsize" value="1"/>
                <param name="requirepositiveoutcomeforsnowball" value="false"/>
            </section>
            <section name="rso">
                <param name="directionalmessthreshold" value="0.1"/>
                <param name="messymapq" value="31"/>
                <param name="silencesuspiciousmdreads" value="false"/>
                <param name="silencedirectionalmessreads" value="false"/>
                <param name="silencemessymapmessreads" value="false"/>
            </section>
            <section name="rco">
                <param name="numsoftclipstobeconsideredmessy" value="7"/>
                <param name="nummismatchestobeconsideredmessy" value="2"/>
            </section>
            <section name="oo">
                <param name="out" value="result,chromosomelog,genomesize,log,multilog"/>
            </section>
            <output name="out_chromosomelogs">
                <assert_contents>
                    <has_size value="5171" delta="100"/>
                </assert_contents>
            </output>
            <output name="out_genomesize">
                <assert_contents>
                    <has_size value="278"/>
                </assert_contents>
            </output>
            <output name="out_log">
                <assert_contents>
                    <has_text_matching expression=".+Done cleaning up.+"/>
                </assert_contents>
            </output>
            <output name="out_multilogs">
                <assert_contents>
                    <has_size value="2246" delta="100"/>
                </assert_contents>
            </output>
            <output name="out_result">
                <assert_contents>
                    <has_size value="207112" delta="1000"/>
                </assert_contents>
            </output>
        </test>
        <!-- #3 realignonly -->
        <test expect_num_outputs="5">
            <param name="genome" value="genome.fasta"/>
            <param name="genome_description" value="Human (hg19) "/>
            <param name="bam" value="control.bam"/>
            <section name="co">
                <param name="keepbothsidesoftclips" value="true"/>
                <param name="trustsoftclips" value="true"/>
                <param name="keepprobe" value="true"/>
                <param name="remaskmessysoftclips" value="true"/>
            </section>
            <conditional name="mode_cond">
                <param name="mode_sel" value="--realignonly true "/>
                <section name="ro">
                    <param name="maskpartialinsertion" value="true"/>
                    <param name="minimumunanchoredinsertionlength" value="1"/>
                    <param name="softclipunknownindels" value="true"/>
                    <param name="checksoftclipsformismatches" value="true"/>
                    <param name="trackmismatches" value="true"/>
                    <param name="categoriestorealign" value="ImperfectStitched,FailStitch,UnstitchIndel,Unstitchable,Disagree,MessyStitched,MessySplit,UnstitchImperfect,LongFragment,UnstitchMessy,UnstitchForwardMessy,UnstitchReverseMessy,UnstitchForwardMessyIndel,UnstitchReverseMessyIndel,UnstitchMessySuspiciousRead,UnstitchMessyIndelSuspiciousRead,UnstitchMessySuspiciousMd"/>
                    <param name="--categoriestosnowball" value="ImperfectStitched,FailStitch,UnstitchIndel,Unstitchable,Disagree,MessyStitched,MessySplit,UnstitchImperfect,LongFragment,UnstitchMessy,UnstitchForwardMessy,UnstitchReverseMessy,UnstitchForwardMessyIndel,UnstitchReverseMessyIndel,UnstitchMessySuspiciousRead,UnstitchMessyIndelSuspiciousRead,UnstitchMessySuspiciousMd"/>
                    <param name="pairawareeverything" value="false"/>
                    <param name="forcehighlikelihoodrealigners" value="true"/>
                </section>
                <section name="rbo">
                    <param name="messysitethreshold" value="2"/>
                    <param name="messysitewidth" value="501"/>
                    <param name="collectdepth" value="false"/>
                    <param name="imperfectfreqthreshold" value="0.02"/>
                    <param name="indelregionfreqthreshold" value="0.02"/>
                    <param name="regiondepththreshold" value="4"/>
                    <param name="recalculateusablesitesaftersnowball" value="false"/>
                </section>
            </conditional>
            <section name="oo">
                <param name="out" value="result,chromosomelog,genomesize,log,multilog"/>
            </section>
            <output name="out_chromosomelogs">
                <assert_contents>
                    <has_size value="5930" delta="100"/>
                </assert_contents>
            </output>
            <output name="out_genomesize">
                <assert_contents>
                    <has_size value="278"/>
                </assert_contents>
            </output>
            <output name="out_log">
                <assert_contents>
                    <has_text_matching expression=".+Done cleaning up.+"/>
                </assert_contents>
            </output>
            <output name="out_multilogs">
                <assert_contents>
                    <has_size value="2601" delta="100"/>
                </assert_contents>
            </output>
            <output name="out_result">
                <assert_contents>
                    <has_size value="207853" delta="1000"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

@WID@

GeminiMulti, as part of the Pisces tool suite, takes in a messy BAM, and returns an error-corrected variant-calling-ready BAM, simultaneously doing the jobs of read-stitching and indel realigning. When reads are trivially stitchable (compatible cigar string), it stitches. When reads disagree, it attempts indel realignment with the help of the mate.

**Input**

Gemini requires as input one BAM file and the path to a genome build. The BAM file is assumed to be sorted, i.e. alignment reads should be sorted by mapped reference position. This assumption allows Gemini to process BAMs in one pass without a large memory footprint. Most standard aligners produce sorted BAM files. Positions in BAM files are expected to use 0-based coordinate system.

**Output**

Gemini outputs a new sorted, stitched, indel realigned BAM file and several (compressed) log files.

.. class:: infomark

**References**

@REFERENCES@
    ]]></help>
    <expand macro="citations"/>
</tool>