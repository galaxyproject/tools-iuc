<tool id="malt_run" name="MALT analyzer" version="0.5.3+galaxy0" profile="21.01">
    <description></description>
    <macros>
        <xml name="sub_matrix">
            <param name="sub_matrix" type="select" label="Select the protein substitution matrix to use">
                <option value="BLOSUM62" selected="True">BLOSUM62</option>
                <option value="BLOSUM45">BLOSUM45</option>
                <option value="BLOSUM50">BLOSUM50</option>
                <option value="BLOSUM80">BLOSUM80</option>
                <option value="BLOSUM90">BLOSUM90</option>
            </param>
        </xml>
        <xml name="forward_reverse_only">
            <param name="forward_only" type="boolean" truevalue="--forwardOnly" falsevalue="" checked="false" label="Align query forward strand only?"/>
            <param name="reverse_only" type="boolean" truevalue="--reverseOnly" falsevalue="" checked="false" label="Align query reverse strand only?"/>
        </xml>
    </macros>
    <requirements>
        <requirement type="package" version="0.53">malt</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
#import re

## This will point to a directory.
#set ref = str($reference.fields.path)

#set input_identifier = re.sub('[^\s\w\-]', '_', str($input.element_identifier))
## malt-run uses the file extension to determine the input format.
#if $input.datatype.file_ext in ['fasta', 'fasta.gz']:
    #set input_identifier = $input_identifier + '.fasta'
#else:
    #set input_identifier = $input_identifier + '.fastq'
#end if
#if $input.ext.endswith('.gz'):
    #set input_identifier = $input_identifier + '.gz'
#end if
ln -s '${input}' '${input_identifier}' &&

malt-run 
--mode '$mode_cond.mode'

#if str($mode_cond.mode) == 'BlastN':
    --matchScore '$mode_cond.match_score'
    --mismatchScore '$mode_cond.mismatch_score'
    --setLambda '$mode_cond.set_lambda'
    --setK '$mode_cond.set_k'
    $mode_cond.forward_only
    $mode_cond.reverse_only
#else if str($mode_cond.mode) == 'BlastP':
    --subMatrix '$mode_cond.sub_matrix'
#else if str($mode_cond.mode) == 'BlastX':
    --subMatrix '$mode_cond.sub_matrix'
    $mode_cond.forward_only
    $mode_cond.reverse_only
#end if

--alignmentType '$alignment_type'
--inFile '$input_identifier'
--index '$ref'
## malt-run requires correct output file extensions.
--output './output.rma6'
--numThreads \${GALAXY_SLOTS:-12}

#if str($reset_performance_defaults_cond.reset_performance_defaults) == 'yes':
    --memoryMode '$reset_performance_defaults_cond.memory_mode'
    --maxTables '$reset_performance_defaults_cond.max_tables'
    $reset_performance_defaults_cond.replicate_query_cache
#end if

#if str($reset_filter_defaults_cond.reset_filter_defaults) == 'yes':
    --minBitScore '$reset_filter_defaults_cond.min_bit_score'
    --maxExpected '$reset_filter_defaults_cond.max_expected'
    --minPercentIdentity '$reset_filter_defaults_cond.min_percent_identity'
    --maxAlignmentsPerQuery '$reset_filter_defaults_cond.max_alignments_per_query'
    --maxAlignmentsPerRef '$reset_filter_defaults_cond.max_alignments_per_ref'
#end if

#if str($reset_lca_defaults_cond.reset_lca_defaults) == 'yes':
    --topPercent '$reset_lca_defaults_cond.top_percent'
    --minSupportPercent '$reset_lca_defaults_cond.min_support_percent'
    --minSupport '$reset_lca_defaults_cond.min_support'
    --minPercentIdentityLCA '$reset_lca_defaults_cond.min_percent_identity_lca'
    $reset_lca_defaults_cond.use_min_percent_identity_filter_lca
    $reset_lca_defaults_cond.weighted_lca
    $reset_lca_defaults_cond.magnitudes
#end if

#if str($reset_heuristics_defaults_cond.reset_heuristics_defaults) == 'yes':
    --maxSeedsPerFrame '$reset_heuristics_defaults_cond.max_seeds_per_frame'
    --maxSeedsPerRef '$reset_heuristics_defaults_cond.max_seeds_per_ref'
    --seedShift '$reset_heuristics_defaults_cond.seed_shift'
#end if

#if str($reset_banded_alignment_defaults_cond.reset_banded_alignments_defaults) == 'yes':
    --gapOpen '$reset_banded_alignment_defaults_cond.gap_open'
    --gapExtend '$reset_banded_alignment_defaults_cond.gap_extend'
    --band '$reset_banded_alignment_defaults_cond.band'
#end if

#if str($additional_outputs_cond.additional_outputs) == 'yes':
    $additional_outputs_cond.include_unaligned
    #if $additional_outputs_cond.output_alignments_cond.output_alignments:
        ## malt-run requires correct output file extensions.
        #set alignments_ext = $additional_outputs_cond.output_alignments_cond.format + '.gz'
        ## This param value must be a path, not a file name so we'll use the ./ approach.
        --alignments './alignments_output.${alignments_ext}'
        --format '$additional_outputs_cond.output_alignments_cond.format'
    #end if
    #if $additional_outputs_cond.output_aligned:
        ## malt-run requires correct output file extensions.
        #set aligned_ext = 'fna.gz'
        ## This param value must be a path, not a file name so we'll use the ./ approach.
        --outAligned './aligned_output.${aligned_ext}'
    #end if
    #if $additional_outputs_cond.output_unaligned:
        ## malt-run requires correct output file extensions.
        #set unaligned_ext = 'fna.gz'
        ## This param value must be a path, not a file name so we'll use the ./ approach.
        --outUnaligned './unaligned_output.${unaligned_ext}'
    #end if
#end if

&& mv 'output.rma6' '$rma6_output'

#if str($additional_outputs_cond.additional_outputs) == 'yes':
    #if $additional_outputs_cond.output_alignments_cond.output_alignments:
        ## malt-run always compresses these outputs.
        && gunzip -c 'alignments_output.${alignments_ext}' > '$alignments_output'
    #end if
    #if $additional_outputs_cond.output_aligned:
        ## malt-run always compresses these outputs.
        && gunzip -c 'aligned_output.${aligned_ext}' > '$aligned_output'
    #end if
    #if $additional_outputs_cond.output_unaligned:
        ## malt-run always compresses these outputs.
        && gunzip -c 'unaligned_output.${unaligned_ext}' > '$unaligned_output'
    #end if
#end if
]]></command>
    <inputs>
        <param name="input" type="data" format="fasta,fasta.gz,fastqsanger.gz,fastqsanger" label="Input file"/>
        <param name="reference" type="select" label="Reference genome">
            <options from_data_table="malt_indices">
                <filter type="sort_by" column="2"/>
                <validator type="no_options" message="A cached reference genome is not available"/>
            </options>
        </param>
        <conditional name="mode_cond" label="Select alignment mode">
            <param name="mode" type="select" label="Alignment mode">
                <option value="BlastN" selected="True">BlastN</option>
                <option value="BlastP">BlastP</option>
                <option value="BlastX">Blastx</option>
            </param>
            <when value="BlastN">
                <param name="match_score" type="integer" value="2" label="Alignment match disjointScore"/>
                <param name="mismatch_score" type="integer" value="-3" label="Alignment mis-match disjointScore"/>
                <param name="set_lambda" type="float" value="0.625" label="Parameter Lambda for BLASTN statistics"/>
                <param name="set_k" type="float" value="0.41" label="Parameter K for BLASTN statistics"/>
                <expand macro="forward_reverse_only"/>
            </when>
            <when value="BlastP">
                <expand macro="sub_matrix"/>
            </when>
            <when value="BlastX">
                <expand macro="sub_matrix"/>
                <expand macro="forward_reverse_only"/>
            </when>
        </conditional>
        <param name="alignment_type" type="select" label="Alignment type">
            <option value="Local" selected="True">Local</option>
            <option value="SemiGlobal">SemiGlobal</option>
        </param>
        <conditional name="reset_performance_defaults_cond">
            <param name="reset_performance_defaults" type="select" label="Reset default performance parameter values?">
                <option value="no" selected="true">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="no"/>
            <when value="yes">
                <param name="memory_mode" type="select" display="radio" label="Memory mode">
                    <option value="load" selected="True">Load all indices into memory</option>
                    <option value="page">Load indices page by page when needed</option>
                    <option value="map">Use memory mapping</option>
                </param>
                <param name="max_tables" type="integer" value="0" min="0" label="Maximum number of seed tables to use" help="Zero value uses all tables"/>
                <param name="replicate_query_cache" type="boolean" truevalue="--replicateQueryCache" falsevalue="" checked="false" label="Cache results for replicated queries?"/>
            </when>
        </conditional>
        <conditional name="reset_filter_defaults_cond">
            <param name="reset_filter_defaults" type="select" label="Reset default filter parameter values?">
                <option value="no" selected="true">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="no"/>
            <when value="yes">
                <param name="min_bit_score" type="float" value="50.0" label="Minimum bit disjointScore"/>
                <param name="max_expected" type="float" value="1.0" label="Maximum expected disjointScore"/>
                <param name="min_percent_identity" type="float" value="0.0" label="Minimum percent identity"/>
                <param name="max_alignments_per_query" type="integer" value="25" label="Maximum number of alignments per query"/>
                <param name="max_alignments_per_ref" type="integer" value="1" label="Maximum number of (non-overlapping) alignments per reference" help="MALT reports up to this many best scoring matches for each hit reference sequence"/>
            </when>
        </conditional>
        <conditional name="reset_lca_defaults_cond">
            <param name="reset_lca_defaults" type="select" label="Reset default LCA parameter values?">
                <option value="no" selected="true">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="no"/>
            <when value="yes">
                <param name="top_percent" type="float" value="10.0" label="Top percent value for LCA algorithm" help="For each read, matches are used for taxonomic placement whose bit disjointScore is within this percentage of the best disjointScore"/>
                <param name="min_support_percent" type="float" value="0.001" min="0" label="Minimum support value for LCA algorithm as a percent of assigned reads" help="Zero value ignores this option"/>
                <param name="min_support" type="integer" value="0" min="0" label="Minimum support value for LCA algorithm" help="Overrides the above parameter"/>
                <param name="min_percent_identity_lca" type="float" value="0.0" min="0" label="Minimum percent identity used by the LCA algorithm"/>
                <param name="use_min_percent_identity_filter_lca" type="boolean" truevalue="--useMinPercentIdentityFilterLCA" falsevalue="" checked="false" label="Use percent identity assignment filter?"/>
                <param name="weighted_lca" type="boolean" truevalue="--weightedLCA" falsevalue="" checked="false" label="Use the weighted LCA for taxonomic assignment?"/>
                <param name="magnitudes" type="boolean" truevalue="--magnitudes" falsevalue="" checked="false" label="Reads have magnitudes (to be used in taxonomic or functional analysis)?"/>
            </when>
        </conditional>
        <conditional name="reset_heuristics_defaults_cond">
            <param name="reset_heuristics_defaults" type="select" label="Reset default heuristics parameter values?">
                <option value="no" selected="true">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="no"/>
            <when value="yes">
                <param name="max_seeds_per_frame" type="integer" value="100" label="Maximum number of seed matches per offset per read frame"/>
                <param name="max_seeds_per_ref" type="integer" value="20" label="Maximum number of seed matches per read and reference"/>
                <param name="seed_shift" type="integer" value="1" label="Seed shift"/>
            </when>
        </conditional>
        <conditional name="reset_banded_alignment_defaults_cond">
            <param name="reset_banded_alignments_defaults" type="select" label="Reset default banded alignment parameter values?">
                <option value="no" selected="true">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="no"/>
            <when value="yes">
                <param name="gap_open" type="integer" value="11" label="Gap open penalty"/>
                <param name="gap_extend" type="integer" value="1" label="Gap extension penalty"/>
                <param name="band" type="integer" value="4" label="Band width/2 for banded alignment"/>
            </when>
        </conditional>
        <conditional name="additional_outputs_cond">
            <param name="additional_outputs" type="select" label="Specify additional outputs?">
                <option value="no" selected="True">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="no"/>
            <when value="yes">
                <param name="include_unaligned" type="boolean" truevalue="--includeUnaligned" falsevalue="" checked="false" label="Include unaligned queries in RMA output file?"/>
                <conditional name="output_alignments_cond">
                    <param name="output_alignments" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Output alignments?"/>
                    <when value="false"/>
                    <when value="true">
                        <param name="format" type="select" label="Alignment format">
                            <option value="SAM" selected="True">SAM</option>
                            <option value="Tab">Tab (tabulated BLAST format)</option>
                            <option value="Text">Text (full text BLAST matches)</option>
                        </param>
                    </when>
                </conditional>
                <param name="output_aligned" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Output all reads that have at least one significant alignment to the reference?"/>
                <param name="output_unaligned" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Output all reads that do not have any significant alignment to the reference?"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="rma6_output" format="rma6" label="${tool.name} on ${on_string} (RMA6)"/>
        <data name="alignments_output" format="sam" label="${tool.name} on ${on_string} (alignments)">
            <filter>additional_outputs_cond['additional_outputs'] == 'yes' and additional_outputs_cond['output_alignments_cond']['output_alignments']</filter>
            <change_format>
                <when input="additional_outputs_cond.output_alignments_cond.format" value="Tab" format="tabular"/>
                <when input="additional_outputs_cond.output_alignments_cond.format" value="Text" format="txt"/>
            </change_format>
        </data>
        <data name="aligned_output" format="fasta" label="${tool.name} on ${on_string} (aligned)">
            <filter>additional_outputs_cond['additional_outputs'] == 'yes' and additional_outputs_cond['output_aligned']</filter>
        </data>
        <data name="unaligned_output" format="fasta" label="${tool.name} on ${on_string} (unaligned)">
            <filter>additional_outputs_cond['additional_outputs'] == 'yes' and additional_outputs_cond['output_unaligned']</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="input" value="input.fastq.gz" dbkey="phiX"/>
            <param name="additional_outputs" value="yes"/>
            <param name="include_unaligned" value="--includeUnaligned"/>
            <param name="output_alignments" value="true"/>
            <output name="rma6_output" file="rma6_output1.rma6" ftype="rma6" compare="sim_size">
                <metadata name="dbkey" value="phiX"/>
            </output>
            <output name="alignments_output" file="alignments_output1.sam" ftype="sam" compare="contains"/>
        </test>
        <test expect_num_outputs="3">
            <param name="input" value="viral.1.protein.fasta.gz" dbkey="phiX"/>
            <param name="alignment_type" value="SemiGlobal"/>
            <param name="reset_performance_defaults" value="yes"/>
            <param name="reset_filter_defaults" value="yes"/>
            <param name="reset_lca_defaults" value="yes"/>
            <param name="reset_heuristics_defaults" value="yes"/>
            <param name="reset_banded_alignments_defaults" value="yes"/>
            <param name="additional_outputs" value="yes"/>
            <param name="include_unaligned" value="--includeUnaligned"/>
            <param name="output_alignments" value="true"/>
            <param name="format" value="Text"/>
            <param name="output_unaligned" value="true"/>
            <output name="rma6_output" file="rma6_output2.rma6" ftype="rma6" compare="sim_size">
                <metadata name="dbkey" value="phiX"/>
            </output>
            <output name="alignments_output" file="alignments_output2.txt" ftype="txt" compare="contains"/>
            <output name="unaligned_output" file="unaligned_output2.fasta" ftype="fasta" compare="contains"/>
        </test>
    </tests>
    <help>
**What it does**

Align one or more files of input sequences (DNA or proteins) against an index representing a collection of reference DNA
or protein sequences. Depending on the type of input and reference sequences, the program can be be run in BLASTN, BLASTP
or BLASTX mode.

**Options**

  **Input file** - specify all input files which must be in FastA or FastQ format and may be gzipped.
  **Referencegenome ** - select the index built by the **MALT index builder** tool.
  **Alignment mode** - run the program in BlastN mode, BlastP mode or BlastX mode.  that is, to align DNA and DNA, protein and protein, or DNA reads against protein references, respectively.  BlastN mode can only be used if the employed index contains DNA sequences, whereas the BlastP and BlastX modes are only applicable to an index based on protein reference sequences.
  **Alignmentment type - specify the type of alignments to be performed. By default, this is set to Local and the program performs local alignment just like BLAST programs do.  Alternatively, this can be set to SemiGlobal and the program will perform semi global alignment in which reads are aligned end-to-end. 
  **Include unaligned queries in RMA output file** - ensure that all unaligned queries are placed into the output RMA file. By default, only queries that have an alignment are included.
    </help>
    <citations>
        <citation type="doi">https://doi.org/10.1101/050559</citation>
    </citations>
</tool>

