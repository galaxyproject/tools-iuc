<tool id="varvamp" name="varVAMP" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <description>design primers for highly diverse viruse</description>
    <macros>
        <token name="@TOOL_VERSION@">0.9.2</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <edam_topics>
        <edam_topic></edam_topic>
    </edam_topics>
    <edam_operations>
        <edam_operation></edam_operation>
    </edam_operations>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">varvamp</requirement>
    </requirements>
    <version_command>varvamp --version</version_command>
    <command detect_errors="exit_code"><![CDATA[

    varvamp

    --threshold $threshold
    --n-ambig $n_ambig
    --database '$database'
    TODO_argument $outputs
    #if str( $mode.mode_select ) == "sanger":
        --opt-length $mode.opt_length
        --max-length $mode.max_length
        --report-n $mode.report_n
    #elif str( $mode.mode_select ) == "tiled":
        --opt-length $mode.opt_length
        --max-length $mode.max_length
        --overlap $mode.overlap
    #elif str( $mode.mode_select ) == "qpcr":
        --pn-ambig $mode.pn_ambig
        --test-n $mode.test_n
        --deltaG $mode.deltaG
    #end if
    --n-threads \${GALAXY_SLOTS:-1}

    '$alignment'
    ## output dir
    ./
    
    ]]></command>
    <inputs>
        <param name="alignment" type="data" format="fasta" label="Multiple alignment" />
        <conditional name="mode">
            <param name="mode_select" type="select" label="Choose a specific mode for your primers">
                <option value="sanger">design primers for sanger sequencing</option>
                <option value="tiled">design primers for whole genome sequencing</option>
                <option value="qpcr">design qPCR primers</option>
            </param>
            <when value="sanger">
                <param argument="--opt-length" type="integer" min="0" max="10000" value="1000" label="optimal length of the amplicons"/>
                <param argument="--max-length" type="integer" min="0" max="10000" value="1500" label="max length of the amplicons" />
                <param argument="--report-n" type="integer" min="1" optional="true" label="report the top n best hits" />
            </when>
            <when value="tiled">
                <param argument="--opt-length" type="integer" min="200" max="10000" value="1000" label="Optimal length of the amplicons"/>
                <param argument="--max-length" type="integer" min="200" max="10000" value="1500" label="Maximum length of the amplicons" />
                <param argument="--overlap" type="integer" min="1" max="1000" value="100" label="Minimum overlap of the amplicons" />
            </when>
            <when value="qpcr">
                <param argument="--pn-ambig" type="integer" min="0" max="100" optional="true" label="Max number of ambiguous characters in a probe" />
                <param argument="--test-n" type="integer" min="10" max="1000" value="50" label="Top n qPCR amplicons to test"
                    help="test the top n qPCR amplicons for secondary structures at the minimal primer temperature" />
                <param argument="--deltaG" type="integer" min="-100" max="100" value="-3" label="Minimum free energy (kcal/mol/K) cutoff"
                    help="Minimum free energy (kcal/mol/K) cutoff at the lowest primer melting temperature" />
            </when>
        </conditional>
        <param argument="--threshold" type="float" optional="true" min="0.0" max="1.0" label="threshold for consensus nucleotides" />
        <param argument="--n-ambig" type="integer" optional="true" min="0" max="3" label="max number of ambiguous characters in a primer" />
        <param argument="--database" type="data" format="blastdb" label="BLAST database" help="You can create this DB with the makeblastdb tool." />
        <param name="outputs" type="select" display="checkboxes" multiple="true" label="Select the outputs you would like to optain">
            <option value="ambiguous_consensus" selected="true">The consensus sequence containing ambiguous nucleotides.</option>
            <option value="amplicon_plot" selected="true">A overview for your final amplicon design.</option>
            <option value="amplicons" selected="true">A BED file showing the amplicon location compared to the consensus sequence.</option>
            <option value="per_base_mismatches">Barplot of the percent mismatches at each nucleotide position of the primer.</option>
            <option value="primers" selected="true">A bed file with the primer locations. Includes the primer score. The lower, the better.</option>
            <option value="varvamp_log">log file</option>
            <option value="alignment_cleaned">The preprocessed alignment.</option>
            <option value="majority_consensus">Consensus sequence that does not have ambiguous characters but instead has the most prevalent nucleotide at each position.</option>
            <option value="primer_regions">A bed file showing the location of the potential regions of the consensus sequence that were evaluated for primers.</option>
        </param>
    </inputs>
    <outputs>
        <data name="ambiguous_consensus" format="fasta" from_work_dir="ambiguous_consensus.fasta" label="${tool.name} on ${on_string}">
            <filter>'ambiguous_consensus' in outputs</filter>
        </data>
        <data name="amplicon_plot" format="pdf" from_work_dir="amplicon_plot.pdf" label="${tool.name} on ${on_string}">
            <filter>'amplicon_plot' in outputs</filter>
        </data>
        <data name="amplicons" format="bed" from_work_dir="amplicons.bed" label="${tool.name} on ${on_string}">
            <filter>'amplicons' in outputs</filter>
        </data>
        <data name="per_base_mismatches" format="pdf" from_work_dir="per_base_mismatches.pdf" label="${tool.name} on ${on_string}">
            <filter>'per_base_mismatches' in outputs</filter>
        </data>
        <data name="primers_bed" format="bed" from_work_dir="primers.bed" label="${tool.name} on ${on_string}">
            <filter>'primers' in outputs</filter>
        </data>
        <data name="varvamp_log" format="txt" from_work_dir="varvamp_log.txt" label="${tool.name} on ${on_string}">
            <filter>'varvamp_log' in outputs</filter>
        </data>

        <data name="alignment_cleaned" format="fasta" from_work_dir="data/alignment_cleaned.fasta" label="${tool.name} on ${on_string}">
            <filter>'alignment_cleaned' in outputs</filter>
        </data>
        <data name="majority_consensus" format="fasta" from_work_dir="data/majority_consensus.fasta" label="${tool.name} on ${on_string}">
            <filter>'majority_consensus' in outputs</filter>
        </data>
        <data name="primer_regions" format="bed" from_work_dir="data/primer_regions.bed" label="${tool.name} on ${on_string}">
            <filter>'primer_regions' in outputs</filter>
        </data>

        <data name="primer_to_amplicon_assignments" format="tabular" from_work_dir="primer_to_amplicon_assignments.tabular" label="${tool.name} on ${on_string}">
            <filter>mode['select_mode'] == 'tiled' or mode['select_mode'] == 'sanger'</filter>
        </data>
        <data name="primer_tabular" format="tabular" from_work_dir="primer.tsv" label="${tool.name} on ${on_string}">
            <filter>mode['select_mode'] == 'tiled' or mode['select_mode'] == 'sanger'</filter>
        </data>

        <data name="qpcr_design" format="tabular" from_work_dir="qpcr_design.tsv" label="${tool.name} on ${on_string}">
            <filter>mode['select_mode'] == 'qpcr'</filter>
        </data>
        <data name="qpcr_primers" format="tabular" from_work_dir="qpcr_primers.tsv" label="${tool.name} on ${on_string}">
            <filter>mode['select_mode'] == 'qpcr'</filter>
        </data>

        <data name="unsolvable_primer_dimers" format="tabular" from_work_dir="unsolvable_primer_dimers.tsv" label="${tool.name} on ${on_string}">
            <filter>mode['select_mode'] == 'tiled'</filter>
        </data>

    </outputs>
    <tests>
    <test expect_num_outputs="">
        <!--TODO: auto-generated test case. Please fill in the required values-->
        <param name="alignment" value="hepatitis_e_aln.fasta"/>
        <param name="threshold" value="0.1"/>
        <param name="n_ambig" value="1"/>
        <param name="database" value=""/>
        <param name="outputs" value="ambiguous_consensus"/>
        <conditional name="mode">
            <param name="mode_select" value="sanger"/>
            <param name="opt_length" value="1000"/>
            <param name="max_length" value="1500"/>
            <param name="report_n" value=""/>
        </conditional>
        <output name="ambiguous_consensus">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="amplicon_plot">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="amplicons">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="per_base_mismatches">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primers_bed">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="varvamp_log">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="alignment_cleaned">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="majority_consensus">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primer_regions">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primer_to_amplicon_assignments">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primer_tabular">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="qpcr_design">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="qpcr_primers">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="unsolvable_primer_dimers">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
    </test>
    
    <test expect_num_outputs="">
        <!--TODO: auto-generated test case. Please fill in the required values-->
        <param name="alignment" value=""/>
        <param name="threshold" value=""/>
        <param name="n_ambig" value=""/>
        <param name="database" value=""/>
        <param name="outputs" value="ambiguous_consensus"/>
        <conditional name="mode">
            <param name="mode_select" value="tiled"/>
            <param name="opt_length" value="1000"/>
            <param name="max_length" value="1500"/>
            <param name="overlap" value="100"/>
        </conditional>
        <output name="ambiguous_consensus">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="amplicon_plot">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="amplicons">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="per_base_mismatches">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primers_bed">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="varvamp_log">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="alignment_cleaned">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="majority_consensus">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primer_regions">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primer_to_amplicon_assignments">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primer_tabular">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="qpcr_design">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="qpcr_primers">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="unsolvable_primer_dimers">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
    </test>
    
    <test expect_num_outputs="">
        <!--TODO: auto-generated test case. Please fill in the required values-->
        <param name="alignment" value=""/>
        <param name="threshold" value=""/>
        <param name="n_ambig" value=""/>
        <param name="database" value=""/>
        <param name="outputs" value="ambiguous_consensus"/>
        <conditional name="mode">
            <param name="mode_select" value="qpcr"/>
            <param name="pn_ambig" value="max number of ambiguous characters in a probe"/>
            <param name="test_n" value="50"/>
            <param name="deltaG" value="-3"/>
        </conditional>
        <output name="ambiguous_consensus">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="amplicon_plot">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="amplicons">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="per_base_mismatches">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primers_bed">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="varvamp_log">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="alignment_cleaned">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="majority_consensus">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primer_regions">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primer_to_amplicon_assignments">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="primer_tabular">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="qpcr_design">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="qpcr_primers">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
        <output name="unsolvable_primer_dimers">
            <assert_contents>
                <has_text text=""/>
                <has_line line=""/>
                <has_line_matching expression=""/>
                <has_n_columns n=""/>
                <has_size value="" delta=""/>
            </assert_contents>
        </output>
    </test>
    </tests>
    <help><![CDATA[

.. class:: infomark

**What it does**

variable VirusAMPlicons (varVAMP) is a tool to design primers for highly diverse viruses. The input is an alignment of your viral (full-genome) sequences.

For a lot of virus genera it is difficult to design pan-specific primers. varVAMP solves this by introducing ambiguous characters into primers and minimizes mismatches at the 3' end.
Primers might not work for some sequences of your input alignment but should recognize the large majority.

varVAMP comes in three different flavors:

* SANGER: varVAMP searches for the very best primers and reports back non-overlapping amplicons which can be used for PCR-based screening approaches.
* TILED: varVAMP uses a graph based approach to design overlapping amplicons that tile the entire viral genome. This designs amplicons that are suitable for Oxford Nanopore or Illumina based full-genome sequencing.
* QPCR: varVAMP searches for small amplicons with an optimized internal probe (TaqMan). It minimizes temperature differences between the primers and checks for amplicon secondary structures.


    ]]></help>
    <citations>
        <citation type="doi"> </citation>
    </citations>
</tool>