language: python
python: 2.7

before_install:
  - export GALAXY_REPO=https://github.com/galaxyproject/galaxy
  - export GALAXY_RELEASE=release_16.01
  - export GALAXY_HOME=$HOME/galaxy

install:
  - pip install click==5.1
  - pip install git+https://github.com/galaxyproject/planemo.git
  - planemo conda_init --conda_prefix $HOME/conda
  - export PATH=$HOME/conda/bin:$PATH
  - conda create -y -c bioconda --name iuc_conda bx-python pysam numpy pyyaml
  - source activate iuc_conda
  - planemo --version
  - echo $TRAVIS_COMMIT_RANGE
  - planemo shed_lint --report_level warn --tools --fail_level error --recursive .
  - git diff --name-only $TRAVIS_COMMIT_RANGE | xargs -n1 dirname | ./filter_directories.py | sort -u > changed_repositories.list
  - cat changed_repositories.list
  - sort .tt_blacklist > sorted_blacklist.list
  - test_repos=`grep -v -f sorted_blacklist.list changed_repositories.list` | true
  - echo ${test_repos}

script:
  - for DIR in ${test_repos}; do planemo conda_install $DIR ; done
  - for DIR in ${test_repos}; do planemo test --conda_dependency_resolution --galaxy_branch $GALAXY_RELEASE  --galaxy_source GALAXY_REPO --skip_venv $DIR ; done
